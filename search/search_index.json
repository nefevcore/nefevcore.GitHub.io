{"config":{"indexing":"full","lang":["en"],"min_search_length":3,"prebuild_index":false,"separator":"[\\s\\-]+"},"docs":[{"location":"","text":"ABAP\u5f00\u53d1\u6587\u6863 \u00b6 \u603b\u7ed3\u4e0b\u5f00\u53d1\u7ecf\u9a8c\uff0c\u6574\u7406\u7684\u65b9\u5411\u6709\u4e0b\u9762\u51e0\u70b9 \u5b8c\u6574\u5b9e\u65bd\u6d41\u7a0b \u6587\u6863\u5c06\u6309\u7167ERP\u6807\u51c6\u5b9e\u65bd\u6d41\u7a0b\u6765\u6574\u7406\uff0c\u4ece\u5404\u7c7b\u4e3b\u6570\u636e\u5f55\u5165\uff0c\u5230\u4e1a\u52a1\u5b9e\u65bd\uff0c\u518d\u5230\u8d22\u52a1\u7ed3\u7b97\uff0c\u6700\u7ec8\u5b8c\u6210\u54c1\u4f1a\u662f\u4e00\u4efd\u5f00\u53d1\u5b9e\u65bd\u6307\u5bfc\u3002 TCODE\u592a\u591a\u8bb0\u4e0d\u4f4f\uff1f\u591a\u5229\u7528SAP\u83dc\u5355\uff0c\u4e3b\u8981\u4e1a\u52a1\u90fd\u5728\u5176\u4e0a\u3002 \u793a\u4f8b\u4ee3\u7801\u4e0e\u5f02\u5e38\u60c5\u51b5\u5206\u6790 \u4e0d\u540c\u9879\u76ee\uff0c\u4e0d\u540c\u9700\u6c42\uff0c\u5c11\u6709\u5b8c\u5168\u4e00\u6837\u7684\u4ee3\u7801\u3002\u56e0\u6b64\u8be5\u6587\u6863\u53ea\u80fd\u63d0\u4f9b\u793a\u4f8b\u4ee3\u7801\u4f5c\u4e3a\u53c2\u8003\uff0c\u8f85\u4ee5\u5f02\u5e38\u60c5\u51b5\u5206\u6790\u8bf4\u660e\uff0c\u5f00\u53d1\u4eba\u5458\u5e94\u5f53\u7ed3\u5408\u5b9e\u9645\u60c5\u51b5\u8fdb\u884c\u8c03\u6574\u3002 \u6587\u6863\u6709\u8bef\u6216\u6d41\u7a0b\u4e0d\u5b8c\u5584\uff0c\u6b22\u8fce\u5230 Github \u4e0a\u53cd\u9988","title":"\u6982\u8ff0"},{"location":"#abap","text":"\u603b\u7ed3\u4e0b\u5f00\u53d1\u7ecf\u9a8c\uff0c\u6574\u7406\u7684\u65b9\u5411\u6709\u4e0b\u9762\u51e0\u70b9 \u5b8c\u6574\u5b9e\u65bd\u6d41\u7a0b \u6587\u6863\u5c06\u6309\u7167ERP\u6807\u51c6\u5b9e\u65bd\u6d41\u7a0b\u6765\u6574\u7406\uff0c\u4ece\u5404\u7c7b\u4e3b\u6570\u636e\u5f55\u5165\uff0c\u5230\u4e1a\u52a1\u5b9e\u65bd\uff0c\u518d\u5230\u8d22\u52a1\u7ed3\u7b97\uff0c\u6700\u7ec8\u5b8c\u6210\u54c1\u4f1a\u662f\u4e00\u4efd\u5f00\u53d1\u5b9e\u65bd\u6307\u5bfc\u3002 TCODE\u592a\u591a\u8bb0\u4e0d\u4f4f\uff1f\u591a\u5229\u7528SAP\u83dc\u5355\uff0c\u4e3b\u8981\u4e1a\u52a1\u90fd\u5728\u5176\u4e0a\u3002 \u793a\u4f8b\u4ee3\u7801\u4e0e\u5f02\u5e38\u60c5\u51b5\u5206\u6790 \u4e0d\u540c\u9879\u76ee\uff0c\u4e0d\u540c\u9700\u6c42\uff0c\u5c11\u6709\u5b8c\u5168\u4e00\u6837\u7684\u4ee3\u7801\u3002\u56e0\u6b64\u8be5\u6587\u6863\u53ea\u80fd\u63d0\u4f9b\u793a\u4f8b\u4ee3\u7801\u4f5c\u4e3a\u53c2\u8003\uff0c\u8f85\u4ee5\u5f02\u5e38\u60c5\u51b5\u5206\u6790\u8bf4\u660e\uff0c\u5f00\u53d1\u4eba\u5458\u5e94\u5f53\u7ed3\u5408\u5b9e\u9645\u60c5\u51b5\u8fdb\u884c\u8c03\u6574\u3002 \u6587\u6863\u6709\u8bef\u6216\u6d41\u7a0b\u4e0d\u5b8c\u5584\uff0c\u6b22\u8fce\u5230 Github \u4e0a\u53cd\u9988","title":"ABAP\u5f00\u53d1\u6587\u6863"},{"location":"about/","text":"\u7ed3\u8bed \u00b6 \u8fd8\u6ca1\u7ed3\u675f\u5462\u3002","title":"\u7ed3\u8bed"},{"location":"about/#_1","text":"\u8fd8\u6ca1\u7ed3\u675f\u5462\u3002","title":"\u7ed3\u8bed"},{"location":"log/","text":"\u66f4\u65b0\u65e5\u5fd7 \u00b6 20221102 \u00b6 \u66f4\u65b0 \u8d22\u52a1\u6e05\u8d26 \uff0c\u65b0\u589e\u589e\u5f3a\u5904\u7406 20221028 \u00b6 \u65b0\u589e \u6279\u91cfWBS\u6210\u672c\u6838\u7b97 20221021 \u00b6 \u65b0\u589e \u53d1\u7968\u589e\u5f3a \u66f4\u65b0 \u4f1a\u8ba1\u51ed\u8bc1\u8fc7\u8d26 \uff0c\u65b0\u589e\u8d44\u4ea7\u5bfc\u5165 \u91cd\u547d\u540d[\u5ba2\u5546\u6e05\u8d26]-> \u8d22\u52a1\u6e05\u8d26 \uff0c\u66f4\u65b0\u8d22\u52a1\u6e05\u8d26\uff08F-03\uff09\u529f\u80fd \u66f4\u65b0 \u4e09\u5927\u62a5\u8868 \uff0c\u8c03\u6574\u7279\u6b8a\u5904\u7406\u56de\u8c03\u5904\u7406 \u65b0\u589e \u56fa\u5b9a\u8d44\u4ea7\u660e\u7ec6\u62a5\u8868 20220928 \u00b6 \u65b0\u589e \u65e5\u5fd7\u67e5\u8be2\u62a5\u8868 20220908 \u00b6 \u65b0\u589e \u5ba2\u5546\u6e05\u8d26 20220825 \u00b6 \u65b0\u589e \u4e09\u5927\u62a5\u8868 \u65b0\u589e \u4f1a\u8ba1\u51ed\u8bc1\u8fc7\u8d26","title":"\u66f4\u65b0"},{"location":"log/#_1","text":"","title":"\u66f4\u65b0\u65e5\u5fd7"},{"location":"log/#20221102","text":"\u66f4\u65b0 \u8d22\u52a1\u6e05\u8d26 \uff0c\u65b0\u589e\u589e\u5f3a\u5904\u7406","title":"20221102"},{"location":"log/#20221028","text":"\u65b0\u589e \u6279\u91cfWBS\u6210\u672c\u6838\u7b97","title":"20221028"},{"location":"log/#20221021","text":"\u65b0\u589e \u53d1\u7968\u589e\u5f3a \u66f4\u65b0 \u4f1a\u8ba1\u51ed\u8bc1\u8fc7\u8d26 \uff0c\u65b0\u589e\u8d44\u4ea7\u5bfc\u5165 \u91cd\u547d\u540d[\u5ba2\u5546\u6e05\u8d26]-> \u8d22\u52a1\u6e05\u8d26 \uff0c\u66f4\u65b0\u8d22\u52a1\u6e05\u8d26\uff08F-03\uff09\u529f\u80fd \u66f4\u65b0 \u4e09\u5927\u62a5\u8868 \uff0c\u8c03\u6574\u7279\u6b8a\u5904\u7406\u56de\u8c03\u5904\u7406 \u65b0\u589e \u56fa\u5b9a\u8d44\u4ea7\u660e\u7ec6\u62a5\u8868","title":"20221021"},{"location":"log/#20220928","text":"\u65b0\u589e \u65e5\u5fd7\u67e5\u8be2\u62a5\u8868","title":"20220928"},{"location":"log/#20220908","text":"\u65b0\u589e \u5ba2\u5546\u6e05\u8d26","title":"20220908"},{"location":"log/#20220825","text":"\u65b0\u589e \u4e09\u5927\u62a5\u8868 \u65b0\u589e \u4f1a\u8ba1\u51ed\u8bc1\u8fc7\u8d26","title":"20220825"},{"location":"ex/","text":"\u9644\u5f55 \u00b6 \u4e00\u4e9b\u4e0d\u5728\u5b9e\u65bd\u6d41\u7a0b\u4e2d\u7684\u7b14\u8bb0\uff0c\u6211\u4f1a\u6574\u7406\u5230\u9644\u5f55\u4e2d\u3002","title":"\u9644\u5f55"},{"location":"ex/#_1","text":"\u4e00\u4e9b\u4e0d\u5728\u5b9e\u65bd\u6d41\u7a0b\u4e2d\u7684\u7b14\u8bb0\uff0c\u6211\u4f1a\u6574\u7406\u5230\u9644\u5f55\u4e2d\u3002","title":"\u9644\u5f55"},{"location":"ex/mdnote/","text":"Markdown\u8bed\u6cd5 \u00b6 \u6587\u672c\u6837\u5f0f \u00b6 \u793a\u4f8b \u8f93\u51fa *\u659c\u4f53* \u659c\u4f53 **\u52a0\u7c97** \u52a0\u7c97 ***\u659c\u4f53\u52a0\u7c97*** \u659c\u4f53\u52a0\u7c97 ~~\u5220\u9664~~ \u5220\u9664 \u5f15\u7528 \u00b6 \u524d\u52a0 > \u5f15\u7528 \u5206\u9694\u7b26\u53f7 \u00b6 \u4e09\u4e2a\u4ee5\u4e0a\u6a2a\u6760 --- \u5217\u8868 \u00b6 \u524d\u7f00 - + * \u6d4b\u8bd5 \u6d4b\u8bd5 \u6d4b\u8bd5 \u5e8f\u53f7 \u00b6 1. 2. 3. \u6d41\u6c34 \u6d4b\u8bd5 \u6d4b\u8bd5 \u56fe\u7247 \u00b6 ![\u63cf\u8ff0] \u8def\u5f84 \u8def\u5f84 \u4ee3\u7801 \u00b6 \u533a\u57df\u524d\u540e```\u5305\u88f9 DATA ( VAR ) = 'DEMO' . \u6298\u53e0 \u00b6 \u5185\u5d4cHTML\u5b9e\u73b0 <details> <summary>\u793a\u4f8b\u4ee3\u7801</summary> </details>","title":"MarkDown\u8bed\u6cd5"},{"location":"ex/mdnote/#markdown","text":"","title":"Markdown\u8bed\u6cd5"},{"location":"ex/mdnote/#_1","text":"\u793a\u4f8b \u8f93\u51fa *\u659c\u4f53* \u659c\u4f53 **\u52a0\u7c97** \u52a0\u7c97 ***\u659c\u4f53\u52a0\u7c97*** \u659c\u4f53\u52a0\u7c97 ~~\u5220\u9664~~ \u5220\u9664","title":"\u6587\u672c\u6837\u5f0f"},{"location":"ex/mdnote/#_2","text":"\u524d\u52a0 > \u5f15\u7528","title":"\u5f15\u7528"},{"location":"ex/mdnote/#_3","text":"\u4e09\u4e2a\u4ee5\u4e0a\u6a2a\u6760 ---","title":"\u5206\u9694\u7b26\u53f7"},{"location":"ex/mdnote/#_4","text":"\u524d\u7f00 - + * \u6d4b\u8bd5 \u6d4b\u8bd5 \u6d4b\u8bd5","title":"\u5217\u8868"},{"location":"ex/mdnote/#_5","text":"1. 2. 3. \u6d41\u6c34 \u6d4b\u8bd5 \u6d4b\u8bd5","title":"\u5e8f\u53f7"},{"location":"ex/mdnote/#_6","text":"![\u63cf\u8ff0] \u8def\u5f84 \u8def\u5f84","title":"\u56fe\u7247"},{"location":"ex/mdnote/#_7","text":"\u533a\u57df\u524d\u540e```\u5305\u88f9 DATA ( VAR ) = 'DEMO' .","title":"\u4ee3\u7801"},{"location":"ex/mdnote/#_8","text":"\u5185\u5d4cHTML\u5b9e\u73b0 <details> <summary>\u793a\u4f8b\u4ee3\u7801</summary> </details>","title":"\u6298\u53e0"},{"location":"fico/","text":"FICO\u6a21\u5757\u6982\u8ff0 \u00b6 \u8d22\u52a1\u7684\u5185\u5bb9\u5f88\u591a\uff0c\u5927\u90e8\u5206\u662f\u62a5\u8868\uff0c\u4e00\u65f6\u534a\u4f1a\u60f3\u4e0d\u8d77\u6765\uff0c\u9047\u5230\u518d\u8865\u5145","title":"FICO\u6a21\u5757\u6982\u8ff0"},{"location":"fico/#fico","text":"\u8d22\u52a1\u7684\u5185\u5bb9\u5f88\u591a\uff0c\u5927\u90e8\u5206\u662f\u62a5\u8868\uff0c\u4e00\u65f6\u534a\u4f1a\u60f3\u4e0d\u8d77\u6765\uff0c\u9047\u5230\u518d\u8865\u5145","title":"FICO\u6a21\u5757\u6982\u8ff0"},{"location":"fico/acc_document/","text":"\u8d22\u52a1\u51ed\u8bc1 \u00b6 \u8fc7\u8d26 \u00b6 BAPI_ACC_DOCUMENT_CHECK \uff0c\u6d4b\u8bd5\u521b\u5efa\u8d22\u52a1\u51ed\u8bc1 BAPI_ACC_DOCUMENT_POST \uff0c\u521b\u5efa\u8d22\u52a1\u51ed\u8bc1 \u793a\u4f8b\u4ee3\u7801 *&---------------------------------------------------------------------* *& Form frm_post *&---------------------------------------------------------------------* *& \u521b\u5efa\u8d22\u52a1\u51ed\u8bc1 *&---------------------------------------------------------------------* FORM frm_post USING i_test TYPE xfeld . DATA l_mtype TYPE bapi_mtype . DATA l_msg TYPE bapi_msg . *&---------------------------------------------------------------------* *& \u8bb0\u8d26\u7801\u914d\u7f6e *&---------------------------------------------------------------------* SELECT bschl , shkzg , koart , stbsl , xsonu FROM tbsl INTO TABLE @ DATA ( lt_bschl ). SORT lt_bschl BY bschl . *&---------------------------------------------------------------------* *& BAPI\u6570\u636e\u58f0\u660e *&---------------------------------------------------------------------* DATA : ls_documentheader TYPE bapiache09 , \"Header lt_accountgl TYPE STANDARD TABLE OF bapiacgl09 , ls_accountgl TYPE bapiacgl09 , \"G/L account item lt_accountreceivable TYPE STANDARD TABLE OF bapiacar09 , ls_accountreceivable TYPE bapiacar09 , \"Customer Item lt_accountpayable TYPE STANDARD TABLE OF bapiacap09 , ls_accountpayable TYPE bapiacap09 , \"Vendor Item lt_currencyamount TYPE STANDARD TABLE OF bapiaccr09 , ls_currencyamount TYPE bapiaccr09 , \"Currency Items lt_criteria TYPE STANDARD TABLE OF bapiackec9 , ls_criteria TYPE bapiackec9 , \" CO-PA lt_extension2 TYPE STANDARD TABLE OF bapiparex , ls_extension2 TYPE bapiparex , \"Reference Structure for BAPI Parameters EXTENSIONIN/EXTENSIONOUT lt_return TYPE STANDARD TABLE OF bapiret2 , ls_return TYPE bapiret2 , \"Return parameter l_obj_key TYPE bapiache09 - obj_key . LOOP AT gt_data INTO DATA ( ls_data ) WHERE zsel = 'X' \" \u53d6\u52fe\u9009\u9879\u8fdb\u884c\u5904\u7406 AND mtype <> 'E' \" \u6821\u9a8c\u65e0\u8bef\u7684 AND belnr = '' \" \u8fd8\u6ca1\u521b\u5efa\u7684 GROUP BY ( bldat = ls_data - bldat budat = ls_data - budat blart = ls_data - blart bukrs = ls_data - bukrs monat = ls_data - monat waers = ls_data - waers xblnr = ls_data - xblnr bktxt = ls_data - bktxt ) INTO DATA ( ls_data_grp ). CLEAR : ls_documentheader , lt_accountgl , ls_accountgl , lt_accountreceivable , ls_accountreceivable , lt_accountpayable , ls_accountpayable , lt_currencyamount , ls_currencyamount , lt_criteria , ls_criteria , lt_extension2 , ls_extension2 , lt_return , ls_return , l_obj_key . \" \u4efb\u53d6\u4e00\u884c\u4f5c\u4e3a\u62ac\u5934 LOOP AT GROUP ls_data_grp INTO DATA ( ls_head ). EXIT . ENDLOOP . CLEAR ls_documentheader . ls_documentheader - comp_code = ls_head - bukrs . \" \u516c\u53f8\u4ee3\u7801 ls_documentheader - header_txt = ls_head - bktxt . \" \u51ed\u8bc1\u62ac\u5934\u6587\u672c ls_documentheader - doc_date = ls_head - bldat . \" \u51ed\u8bc1\u65e5\u671f ls_documentheader - pstng_date = ls_head - budat . \" \u8fc7\u8d26\u65e5\u671f ls_documentheader - doc_type = ls_head - blart . \" \u51ed\u8bc1\u7c7b\u578b ls_documentheader - username = sy - uname . \" \u7528\u6237\u540d ls_documentheader - bus_act = 'RFBU' . \" \u4e1a\u52a1\u4e8b\u52a1 ls_documentheader - obj_type = 'BKPFF' . \" \u53c2\u8003\u4ea4\u6613 ls_documentheader - fis_period = ls_head - monat . \" \u4f1a\u8ba1\u671f\u95f4 ls_documentheader - fisc_year = ls_head - budat + 0 ( 4 ). \" \u4f1a\u8ba1\u5e74\u5ea6 ls_documentheader - ref_doc_no = ls_head - xblnr . \" \u53c2\u8003\u51ed\u8bc1 \" \u4efb\u53d6\u4e00\u884c\u4f5c\u4e3a\u62ac\u5934 DATA l_itemno_acc TYPE posnr_acc . DATA l_gl_acount TYPE hkont . CLEAR l_itemno_acc . LOOP AT GROUP ls_data_grp INTO ls_data . l_itemno_acc = l_itemno_acc + 1 . READ TABLE lt_bschl INTO DATA ( ls_bschl ) WITH KEY bschl = ls_data - bschl BINARY SEARCH . CASE ls_bschl - koart . WHEN 'D' . \" \u5ba2\u6237 \" \u603b\u5e10\u79d1\u76ee CLEAR l_gl_acount . IF ls_data - hkont IS NOT INITIAL . l_gl_acount = ls_data - hkont . ELSE . SELECT SINGLE akont FROM knb1 WHERE kunnr = @ ls_data - kunnr AND bukrs = @ ls_data - bukrs INTO @ l_gl_acount . \" \u7279\u522b\u603b\u8d26 IF ls_data - umskz IS NOT INITIAL . SELECT SINGLE skont FROM t074 WHERE ktopl = @ l_ktopl AND koart = @ ls_bschl - koart AND umskz = @ ls_data - umskz AND hkont = @ l_gl_acount INTO @ l_gl_acount . ENDIF . ENDIF . ls_accountreceivable - itemno_acc = l_itemno_acc . \" \u4f1a\u8ba1\u51ed\u8bc1\u884c\u9879\u76ee\u7f16\u53f7 ls_accountreceivable - gl_account = l_gl_acount . \" \u603b\u8d26\u79d1\u76ee ls_accountreceivable - customer = ls_data - kunnr . \" \u5ba2\u6237\u53f7 ls_accountreceivable - sp_gl_ind = ls_data - umskz . \" \u7279\u6b8a\u603b\u8d26\u6807\u8bc6 ls_accountreceivable - tax_code = ls_data - mwskz . \" \u7a0e\u7801 ls_accountreceivable - item_text = ls_data - sgtxt . \" \u9879\u76ee\u6587\u672c ls_accountreceivable - alloc_nmbr = ls_data - zuonr . \" \u5206\u914d ls_accountreceivable - profit_ctr = ls_data - prctr . \" \u5229\u6da6\u4e2d\u5fc3 ls_accountreceivable - pmnttrms = ls_data - zterm . \" \u4ed8\u6b3e\u6761\u4ef6 ls_accountreceivable - bline_date = ls_data - zfbdt . \" \u4ed8\u6b3e\u8d77\u7b97\u65e5\u671f ls_accountreceivable - bus_area = ls_data - gsber . \" \u4e1a\u52a1\u8303\u56f4 INSERT ls_accountreceivable INTO TABLE lt_accountreceivable . WHEN 'K' . \" \u4f9b\u5e94\u5546 \" \u603b\u5e10\u79d1\u76ee CLEAR l_gl_acount . IF ls_data - hkont IS NOT INITIAL . l_gl_acount = ls_data - hkont . ELSE . SELECT SINGLE akont FROM lfb1 WHERE lifnr = @ ls_data - lifnr AND bukrs = @ ls_data - bukrs INTO @ l_gl_acount . \" \u7279\u522b\u603b\u8d26 IF ls_data - umskz IS NOT INITIAL . SELECT SINGLE skont FROM t074 WHERE ktopl = @ l_ktopl AND koart = @ ls_bschl - koart AND umskz = @ ls_data - umskz AND hkont = @ l_gl_acount INTO @ l_gl_acount . ENDIF . ENDIF . ls_accountpayable - itemno_acc = l_itemno_acc . \" \u4f1a\u8ba1\u51ed\u8bc1\u884c\u9879\u76ee\u7f16\u53f7 ls_accountpayable - gl_account = l_gl_acount . \" \u603b\u8d26\u79d1\u76ee ls_accountpayable - item_text = ls_data - sgtxt . \" \u9879\u76ee\u6587\u672c ls_accountpayable - vendor_no = ls_data - lifnr . \" \u4f9b\u5e94\u5546\u7f16\u53f7 ls_accountpayable - sp_gl_ind = ls_data - umskz . \" \u7279\u6b8a\u603b\u8d26\u6807\u8bc6 ls_accountpayable - alloc_nmbr = ls_data - zuonr . \" \u5206\u914d ls_accountpayable - profit_ctr = ls_data - prctr . \" \u5229\u6da6\u4e2d\u5fc3 ls_accountpayable - tax_code = ls_data - mwskz . \" \u7a0e\u7801 ls_accountpayable - pmnttrms = ls_data - zterm . \" \u4ed8\u6b3e\u6761\u4ef6 ls_accountpayable - bline_date = ls_data - zfbdt . \" \u4ed8\u6b3e\u8d77\u7b97\u65e5\u671f ls_accountpayable - bus_area = ls_data - gsber . \" \u4e1a\u52a1\u8303\u56f4 INSERT ls_accountpayable INTO TABLE lt_accountpayable . WHEN 'S' . \" \u603b\u5206\u7c7b\u5e10\u79d1\u76ee l_gl_acount = ls_data - hkont . ls_accountgl - itemno_acc = l_itemno_acc . \" \u4f1a\u8ba1\u51ed\u8bc1\u884c\u9879\u76ee\u7f16\u53f7 ls_accountgl - item_text = ls_data - sgtxt . \" \u9879\u76ee\u6587\u672c ls_accountgl - gl_account = l_gl_acount . \" \u603b\u5206\u7c7b\u5e10\u5e10\u76ee ls_accountgl - costcenter = ls_data - kostl . \" \u6210\u672c\u4e2d\u5fc3 ls_accountgl - alloc_nmbr = ls_data - zuonr . \" \u5206\u914d\u7f16\u53f7 ls_accountgl - orderid = ls_data - aufnr . \" \u5185\u90e8\u8ba2\u5355\u53f7 ls_accountgl - tax_code = ls_data - mwskz . \" \u7a0e\u53f7 ls_accountgl - po_number = ls_data - ebeln . \" \u91c7\u8d2d\u51ed\u8bc1\u53f7 ls_accountgl - po_item = ls_data - ebelp . \" \u91c7\u8d2d\u51ed\u8bc1\u884c\u9879\u76ee\u53f7 ls_accountgl - profit_ctr = ls_data - prctr . \" \u5229\u6da6\u4e2d\u5fc3 ls_accountgl - material_long = ls_data - matnr . \" \u7269\u6599 INSERT ls_accountgl INTO TABLE lt_accountgl . WHEN 'A' . \" \u8d44\u4ea7 \" \u8d44\u4ea7\u7edf\u5fa1\u79d1\u76ee CLEAR l_gl_acount . IF ls_data - hkont IS NOT INITIAL . l_gl_acount = ls_data - hkont . ELSE . SELECT SINGLE ktogr FROM anla WHERE bukrs = @ ls_data - bukrs AND anln1 = @ ls_data - anln1 INTO @ l_gl_acount . IF sy - subrc = 0 . SELECT SINGLE ktansw FROM t095 WHERE ktopl = @ l_ktopl AND ktogr = @ l_gl_acount INTO @ l_gl_acount . ENDIF . ENDIF . ls_accountgl - itemno_acc = l_itemno_acc . \" \u4f1a\u8ba1\u51ed\u8bc1\u884c\u9879\u76ee\u7f16\u53f7 ls_accountgl - item_text = ls_data - sgtxt . \" \u9879\u76ee\u6587\u672c ls_accountgl - gl_account = l_gl_acount . \" \u7edf\u5fa1\u79d1\u76ee ls_accountgl - acct_type = ls_bschl - koart . \" \u4e1a\u52a1\u7c7b\u578b ls_accountgl - asset_no = ls_data - anln1 . \" \u4e3b\u8d44\u4ea7\u53f7 ls_accountgl - sub_number = '0000' . \"\u6b21\u8d44\u4ea7\u53f7 ls_accountgl - costcenter = ls_data - kostl . \" \u6210\u672c\u4e2d\u5fc3 ls_accountgl - alloc_nmbr = ls_data - zuonr . \" \u5206\u914d\u7f16\u53f7 ls_accountgl - orderid = ls_data - aufnr . \" \u5185\u90e8\u8ba2\u5355\u53f7 ls_accountgl - tax_code = ls_data - mwskz . \" \u7a0e\u53f7 ls_accountgl - po_number = ls_data - ebeln . \" \u91c7\u8d2d\u51ed\u8bc1\u53f7 ls_accountgl - po_item = ls_data - ebelp . \" \u91c7\u8d2d\u51ed\u8bc1\u884c\u9879\u76ee\u53f7 ls_accountgl - profit_ctr = ls_data - prctr . \" \u5229\u6da6\u4e2d\u5fc3 ls_accountgl - material_long = ls_data - matnr . \" \u7269\u6599 ls_accountgl - bus_area = ls_data - gsber . \" \u4e1a\u52a1\u8303\u56f4 INSERT ls_accountgl INTO TABLE lt_accountgl . WHEN 'M' . \" \u7269\u6599 WHEN OTHERS . ENDCASE . \" \u8d27\u5e01\u9879\u76ee ls_currencyamount - itemno_acc = l_itemno_acc . \"\u884c\u9879\u76ee\u7f16\u53f7 IF ls_bschl - shkzg = 'S' . ls_currencyamount - amt_doccur = ls_data - wrbtr . \" \u91d1\u989d ls_currencyamount - tax_amt = ls_data - xmwst . \" \u7a0e\u989d ELSE . ls_currencyamount - amt_doccur = ls_data - wrbtr * - 1 . \" \u91d1\u989d ls_currencyamount - tax_amt = ls_data - xmwst * - 1 . \" \u7a0e\u989d ENDIF . ls_currencyamount - currency = ls_head - waers . \"\u8d27\u5e01 INSERT ls_currencyamount INTO TABLE lt_currencyamount . \" \u589e\u5f3a\u5b57\u6bb5 DATA ls_ext TYPE zsfi0001 . ls_ext - posnr = l_itemno_acc . \" \u4f1a\u8ba1\u51ed\u8bc1\u884c\u9879\u76ee\u7f16\u53f7 ls_ext - bschl = ls_data - bschl . \" \u8bb0\u5e10\u4ee3\u7801 ls_ext - rstgr = ls_data - rstgr . \" \u4ed8\u6b3e\u539f\u56e0\u4ee3\u7801 CLEAR ls_extension2 . ls_extension2 - structure = 'ZSFI0001' . MOVE ls_ext TO ls_extension2 + 30 . INSERT ls_extension2 INTO TABLE lt_extension2 . ENDLOOP . IF i_test = 'X' . CALL FUNCTION 'BAPI_ACC_DOCUMENT_CHECK' EXPORTING documentheader = ls_documentheader TABLES accountgl = lt_accountgl accountreceivable = lt_accountreceivable accountpayable = lt_accountpayable currencyamount = lt_currencyamount criteria = lt_criteria return = lt_return extension2 = lt_extension2 . ELSE . CALL FUNCTION 'BAPI_ACC_DOCUMENT_POST' EXPORTING documentheader = ls_documentheader IMPORTING obj_key = l_obj_key TABLES accountgl = lt_accountgl accountreceivable = lt_accountreceivable accountpayable = lt_accountpayable currencyamount = lt_currencyamount criteria = lt_criteria return = lt_return extension2 = lt_extension2 . ENDIF . \" \u6574\u7406BAPI\u6d88\u606f CLEAR l_msg . LOOP AT lt_return INTO ls_return WHERE type CA 'AEX' . MESSAGE ID ls_return - id TYPE ls_return - type NUMBER ls_return - number WITH ls_return - message_v1 ls_return - message_v2 ls_return - message_v3 ls_return - message_v4 INTO ls_return - message . l_mtype = 'E' . l_msg = |{ l_msg }{ ls_return - message } ; |. ENDLOOP . IF sy - subrc <> 0 . l_mtype = 'S' . IF i_test = 'X' . l_msg = | \u6d4b\u8bd5\u8fd0\u884c\u6210\u529f |. ELSE . l_msg = | \u4f1a\u8ba1\u51ed\u8bc1 { l_obj_key ( 10 ) } \u5df2\u5904\u7406 |. ENDIF . ENDIF . \" \u56de\u5199\u62a5\u8868 LOOP AT GROUP ls_data_grp REFERENCE INTO DATA ( lr_data ). lr_data -> mtype = l_mtype . lr_data -> msg = l_msg . lr_data -> belnr = l_obj_key ( 10 ). ENDLOOP . IF i_test = 'X' . \" \u6d4b\u8bd5\u8fd0\u884c\u7ed3\u675f CONTINUE . ELSE . \" \u63d0\u4ea4\u6570\u636e\u5e93 IF l_mtype = 'E' . CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK' . ELSE . CALL FUNCTION 'BAPI_TRANSACTION_COMMIT' EXPORTING wait = 'X' . ENDIF . ENDIF . ENDLOOP . \" LOOP AT gt_data GROUP BY ENDFORM . \u589e\u5f3a \u00b6 BAPI\u7684EXTENSION2\u589e\u5f3a\u4ee3\u7801\u5dee\u5f02\u4e0d\u5927\uff0c\u5bf9\u4e8e\u4e0a\u9762BAPI\u6765\u8bf4\uff0c\u9700\u8981\u5728ACC_DOCUMENT(BADI)\u589e\u5f3a\uff0cIF_EX_ACC_DOCUMENT~CHANGE\u65b9\u6cd5\u4e2d\u52a0\u5165\u4e0b\u9762\u4ee3\u7801\u3002 \u793a\u4f8b\u4ee3\u7801 *********************************************************************** * Example to move fields from BAPI parameter EXTENSION2 to structure * * ACCIT (accounting document line items). * * The dictionary structure (content for EXTENSION2-STRUCTURE) must * * contain field POSNR, (TYPE POSNR_ACC) to indentify the correct line * * item of the internal table ACCIT. * *********************************************************************** DATA : wa_extension TYPE bapiparex , ext_value ( 960 ) TYPE c , wa_accit TYPE accit , l_ref TYPE REF TO data . FIELD-SYMBOLS : <l_struc> TYPE ANY , <l_field> TYPE ANY . SORT c_extension2 BY structure . LOOP AT c_extension2 INTO wa_extension . AT NEW structure . CREATE DATA l_ref TYPE ( wa_extension - structure ). ASSIGN l_ref->* TO <l_struc> . ENDAT . CONCATENATE wa_extension - valuepart1 wa_extension - valuepart2 wa_extension - valuepart3 wa_extension - valuepart4 INTO ext_value . MOVE ext_value TO <l_struc> . ASSIGN COMPONENT 'POSNR' OF STRUCTURE <l_struc> TO <l_field> . READ TABLE c_accit WITH KEY posnr = <l_field> INTO wa_accit . IF sy - subrc IS INITIAL . MOVE-CORRESPONDING <l_struc> TO wa_accit . MODIFY c_accit FROM wa_accit INDEX sy - tabix . ENDIF . ENDLOOP .","title":"\u4f1a\u8ba1\u51ed\u8bc1"},{"location":"fico/acc_document/#_1","text":"","title":"\u8d22\u52a1\u51ed\u8bc1"},{"location":"fico/acc_document/#_2","text":"BAPI_ACC_DOCUMENT_CHECK \uff0c\u6d4b\u8bd5\u521b\u5efa\u8d22\u52a1\u51ed\u8bc1 BAPI_ACC_DOCUMENT_POST \uff0c\u521b\u5efa\u8d22\u52a1\u51ed\u8bc1 \u793a\u4f8b\u4ee3\u7801 *&---------------------------------------------------------------------* *& Form frm_post *&---------------------------------------------------------------------* *& \u521b\u5efa\u8d22\u52a1\u51ed\u8bc1 *&---------------------------------------------------------------------* FORM frm_post USING i_test TYPE xfeld . DATA l_mtype TYPE bapi_mtype . DATA l_msg TYPE bapi_msg . *&---------------------------------------------------------------------* *& \u8bb0\u8d26\u7801\u914d\u7f6e *&---------------------------------------------------------------------* SELECT bschl , shkzg , koart , stbsl , xsonu FROM tbsl INTO TABLE @ DATA ( lt_bschl ). SORT lt_bschl BY bschl . *&---------------------------------------------------------------------* *& BAPI\u6570\u636e\u58f0\u660e *&---------------------------------------------------------------------* DATA : ls_documentheader TYPE bapiache09 , \"Header lt_accountgl TYPE STANDARD TABLE OF bapiacgl09 , ls_accountgl TYPE bapiacgl09 , \"G/L account item lt_accountreceivable TYPE STANDARD TABLE OF bapiacar09 , ls_accountreceivable TYPE bapiacar09 , \"Customer Item lt_accountpayable TYPE STANDARD TABLE OF bapiacap09 , ls_accountpayable TYPE bapiacap09 , \"Vendor Item lt_currencyamount TYPE STANDARD TABLE OF bapiaccr09 , ls_currencyamount TYPE bapiaccr09 , \"Currency Items lt_criteria TYPE STANDARD TABLE OF bapiackec9 , ls_criteria TYPE bapiackec9 , \" CO-PA lt_extension2 TYPE STANDARD TABLE OF bapiparex , ls_extension2 TYPE bapiparex , \"Reference Structure for BAPI Parameters EXTENSIONIN/EXTENSIONOUT lt_return TYPE STANDARD TABLE OF bapiret2 , ls_return TYPE bapiret2 , \"Return parameter l_obj_key TYPE bapiache09 - obj_key . LOOP AT gt_data INTO DATA ( ls_data ) WHERE zsel = 'X' \" \u53d6\u52fe\u9009\u9879\u8fdb\u884c\u5904\u7406 AND mtype <> 'E' \" \u6821\u9a8c\u65e0\u8bef\u7684 AND belnr = '' \" \u8fd8\u6ca1\u521b\u5efa\u7684 GROUP BY ( bldat = ls_data - bldat budat = ls_data - budat blart = ls_data - blart bukrs = ls_data - bukrs monat = ls_data - monat waers = ls_data - waers xblnr = ls_data - xblnr bktxt = ls_data - bktxt ) INTO DATA ( ls_data_grp ). CLEAR : ls_documentheader , lt_accountgl , ls_accountgl , lt_accountreceivable , ls_accountreceivable , lt_accountpayable , ls_accountpayable , lt_currencyamount , ls_currencyamount , lt_criteria , ls_criteria , lt_extension2 , ls_extension2 , lt_return , ls_return , l_obj_key . \" \u4efb\u53d6\u4e00\u884c\u4f5c\u4e3a\u62ac\u5934 LOOP AT GROUP ls_data_grp INTO DATA ( ls_head ). EXIT . ENDLOOP . CLEAR ls_documentheader . ls_documentheader - comp_code = ls_head - bukrs . \" \u516c\u53f8\u4ee3\u7801 ls_documentheader - header_txt = ls_head - bktxt . \" \u51ed\u8bc1\u62ac\u5934\u6587\u672c ls_documentheader - doc_date = ls_head - bldat . \" \u51ed\u8bc1\u65e5\u671f ls_documentheader - pstng_date = ls_head - budat . \" \u8fc7\u8d26\u65e5\u671f ls_documentheader - doc_type = ls_head - blart . \" \u51ed\u8bc1\u7c7b\u578b ls_documentheader - username = sy - uname . \" \u7528\u6237\u540d ls_documentheader - bus_act = 'RFBU' . \" \u4e1a\u52a1\u4e8b\u52a1 ls_documentheader - obj_type = 'BKPFF' . \" \u53c2\u8003\u4ea4\u6613 ls_documentheader - fis_period = ls_head - monat . \" \u4f1a\u8ba1\u671f\u95f4 ls_documentheader - fisc_year = ls_head - budat + 0 ( 4 ). \" \u4f1a\u8ba1\u5e74\u5ea6 ls_documentheader - ref_doc_no = ls_head - xblnr . \" \u53c2\u8003\u51ed\u8bc1 \" \u4efb\u53d6\u4e00\u884c\u4f5c\u4e3a\u62ac\u5934 DATA l_itemno_acc TYPE posnr_acc . DATA l_gl_acount TYPE hkont . CLEAR l_itemno_acc . LOOP AT GROUP ls_data_grp INTO ls_data . l_itemno_acc = l_itemno_acc + 1 . READ TABLE lt_bschl INTO DATA ( ls_bschl ) WITH KEY bschl = ls_data - bschl BINARY SEARCH . CASE ls_bschl - koart . WHEN 'D' . \" \u5ba2\u6237 \" \u603b\u5e10\u79d1\u76ee CLEAR l_gl_acount . IF ls_data - hkont IS NOT INITIAL . l_gl_acount = ls_data - hkont . ELSE . SELECT SINGLE akont FROM knb1 WHERE kunnr = @ ls_data - kunnr AND bukrs = @ ls_data - bukrs INTO @ l_gl_acount . \" \u7279\u522b\u603b\u8d26 IF ls_data - umskz IS NOT INITIAL . SELECT SINGLE skont FROM t074 WHERE ktopl = @ l_ktopl AND koart = @ ls_bschl - koart AND umskz = @ ls_data - umskz AND hkont = @ l_gl_acount INTO @ l_gl_acount . ENDIF . ENDIF . ls_accountreceivable - itemno_acc = l_itemno_acc . \" \u4f1a\u8ba1\u51ed\u8bc1\u884c\u9879\u76ee\u7f16\u53f7 ls_accountreceivable - gl_account = l_gl_acount . \" \u603b\u8d26\u79d1\u76ee ls_accountreceivable - customer = ls_data - kunnr . \" \u5ba2\u6237\u53f7 ls_accountreceivable - sp_gl_ind = ls_data - umskz . \" \u7279\u6b8a\u603b\u8d26\u6807\u8bc6 ls_accountreceivable - tax_code = ls_data - mwskz . \" \u7a0e\u7801 ls_accountreceivable - item_text = ls_data - sgtxt . \" \u9879\u76ee\u6587\u672c ls_accountreceivable - alloc_nmbr = ls_data - zuonr . \" \u5206\u914d ls_accountreceivable - profit_ctr = ls_data - prctr . \" \u5229\u6da6\u4e2d\u5fc3 ls_accountreceivable - pmnttrms = ls_data - zterm . \" \u4ed8\u6b3e\u6761\u4ef6 ls_accountreceivable - bline_date = ls_data - zfbdt . \" \u4ed8\u6b3e\u8d77\u7b97\u65e5\u671f ls_accountreceivable - bus_area = ls_data - gsber . \" \u4e1a\u52a1\u8303\u56f4 INSERT ls_accountreceivable INTO TABLE lt_accountreceivable . WHEN 'K' . \" \u4f9b\u5e94\u5546 \" \u603b\u5e10\u79d1\u76ee CLEAR l_gl_acount . IF ls_data - hkont IS NOT INITIAL . l_gl_acount = ls_data - hkont . ELSE . SELECT SINGLE akont FROM lfb1 WHERE lifnr = @ ls_data - lifnr AND bukrs = @ ls_data - bukrs INTO @ l_gl_acount . \" \u7279\u522b\u603b\u8d26 IF ls_data - umskz IS NOT INITIAL . SELECT SINGLE skont FROM t074 WHERE ktopl = @ l_ktopl AND koart = @ ls_bschl - koart AND umskz = @ ls_data - umskz AND hkont = @ l_gl_acount INTO @ l_gl_acount . ENDIF . ENDIF . ls_accountpayable - itemno_acc = l_itemno_acc . \" \u4f1a\u8ba1\u51ed\u8bc1\u884c\u9879\u76ee\u7f16\u53f7 ls_accountpayable - gl_account = l_gl_acount . \" \u603b\u8d26\u79d1\u76ee ls_accountpayable - item_text = ls_data - sgtxt . \" \u9879\u76ee\u6587\u672c ls_accountpayable - vendor_no = ls_data - lifnr . \" \u4f9b\u5e94\u5546\u7f16\u53f7 ls_accountpayable - sp_gl_ind = ls_data - umskz . \" \u7279\u6b8a\u603b\u8d26\u6807\u8bc6 ls_accountpayable - alloc_nmbr = ls_data - zuonr . \" \u5206\u914d ls_accountpayable - profit_ctr = ls_data - prctr . \" \u5229\u6da6\u4e2d\u5fc3 ls_accountpayable - tax_code = ls_data - mwskz . \" \u7a0e\u7801 ls_accountpayable - pmnttrms = ls_data - zterm . \" \u4ed8\u6b3e\u6761\u4ef6 ls_accountpayable - bline_date = ls_data - zfbdt . \" \u4ed8\u6b3e\u8d77\u7b97\u65e5\u671f ls_accountpayable - bus_area = ls_data - gsber . \" \u4e1a\u52a1\u8303\u56f4 INSERT ls_accountpayable INTO TABLE lt_accountpayable . WHEN 'S' . \" \u603b\u5206\u7c7b\u5e10\u79d1\u76ee l_gl_acount = ls_data - hkont . ls_accountgl - itemno_acc = l_itemno_acc . \" \u4f1a\u8ba1\u51ed\u8bc1\u884c\u9879\u76ee\u7f16\u53f7 ls_accountgl - item_text = ls_data - sgtxt . \" \u9879\u76ee\u6587\u672c ls_accountgl - gl_account = l_gl_acount . \" \u603b\u5206\u7c7b\u5e10\u5e10\u76ee ls_accountgl - costcenter = ls_data - kostl . \" \u6210\u672c\u4e2d\u5fc3 ls_accountgl - alloc_nmbr = ls_data - zuonr . \" \u5206\u914d\u7f16\u53f7 ls_accountgl - orderid = ls_data - aufnr . \" \u5185\u90e8\u8ba2\u5355\u53f7 ls_accountgl - tax_code = ls_data - mwskz . \" \u7a0e\u53f7 ls_accountgl - po_number = ls_data - ebeln . \" \u91c7\u8d2d\u51ed\u8bc1\u53f7 ls_accountgl - po_item = ls_data - ebelp . \" \u91c7\u8d2d\u51ed\u8bc1\u884c\u9879\u76ee\u53f7 ls_accountgl - profit_ctr = ls_data - prctr . \" \u5229\u6da6\u4e2d\u5fc3 ls_accountgl - material_long = ls_data - matnr . \" \u7269\u6599 INSERT ls_accountgl INTO TABLE lt_accountgl . WHEN 'A' . \" \u8d44\u4ea7 \" \u8d44\u4ea7\u7edf\u5fa1\u79d1\u76ee CLEAR l_gl_acount . IF ls_data - hkont IS NOT INITIAL . l_gl_acount = ls_data - hkont . ELSE . SELECT SINGLE ktogr FROM anla WHERE bukrs = @ ls_data - bukrs AND anln1 = @ ls_data - anln1 INTO @ l_gl_acount . IF sy - subrc = 0 . SELECT SINGLE ktansw FROM t095 WHERE ktopl = @ l_ktopl AND ktogr = @ l_gl_acount INTO @ l_gl_acount . ENDIF . ENDIF . ls_accountgl - itemno_acc = l_itemno_acc . \" \u4f1a\u8ba1\u51ed\u8bc1\u884c\u9879\u76ee\u7f16\u53f7 ls_accountgl - item_text = ls_data - sgtxt . \" \u9879\u76ee\u6587\u672c ls_accountgl - gl_account = l_gl_acount . \" \u7edf\u5fa1\u79d1\u76ee ls_accountgl - acct_type = ls_bschl - koart . \" \u4e1a\u52a1\u7c7b\u578b ls_accountgl - asset_no = ls_data - anln1 . \" \u4e3b\u8d44\u4ea7\u53f7 ls_accountgl - sub_number = '0000' . \"\u6b21\u8d44\u4ea7\u53f7 ls_accountgl - costcenter = ls_data - kostl . \" \u6210\u672c\u4e2d\u5fc3 ls_accountgl - alloc_nmbr = ls_data - zuonr . \" \u5206\u914d\u7f16\u53f7 ls_accountgl - orderid = ls_data - aufnr . \" \u5185\u90e8\u8ba2\u5355\u53f7 ls_accountgl - tax_code = ls_data - mwskz . \" \u7a0e\u53f7 ls_accountgl - po_number = ls_data - ebeln . \" \u91c7\u8d2d\u51ed\u8bc1\u53f7 ls_accountgl - po_item = ls_data - ebelp . \" \u91c7\u8d2d\u51ed\u8bc1\u884c\u9879\u76ee\u53f7 ls_accountgl - profit_ctr = ls_data - prctr . \" \u5229\u6da6\u4e2d\u5fc3 ls_accountgl - material_long = ls_data - matnr . \" \u7269\u6599 ls_accountgl - bus_area = ls_data - gsber . \" \u4e1a\u52a1\u8303\u56f4 INSERT ls_accountgl INTO TABLE lt_accountgl . WHEN 'M' . \" \u7269\u6599 WHEN OTHERS . ENDCASE . \" \u8d27\u5e01\u9879\u76ee ls_currencyamount - itemno_acc = l_itemno_acc . \"\u884c\u9879\u76ee\u7f16\u53f7 IF ls_bschl - shkzg = 'S' . ls_currencyamount - amt_doccur = ls_data - wrbtr . \" \u91d1\u989d ls_currencyamount - tax_amt = ls_data - xmwst . \" \u7a0e\u989d ELSE . ls_currencyamount - amt_doccur = ls_data - wrbtr * - 1 . \" \u91d1\u989d ls_currencyamount - tax_amt = ls_data - xmwst * - 1 . \" \u7a0e\u989d ENDIF . ls_currencyamount - currency = ls_head - waers . \"\u8d27\u5e01 INSERT ls_currencyamount INTO TABLE lt_currencyamount . \" \u589e\u5f3a\u5b57\u6bb5 DATA ls_ext TYPE zsfi0001 . ls_ext - posnr = l_itemno_acc . \" \u4f1a\u8ba1\u51ed\u8bc1\u884c\u9879\u76ee\u7f16\u53f7 ls_ext - bschl = ls_data - bschl . \" \u8bb0\u5e10\u4ee3\u7801 ls_ext - rstgr = ls_data - rstgr . \" \u4ed8\u6b3e\u539f\u56e0\u4ee3\u7801 CLEAR ls_extension2 . ls_extension2 - structure = 'ZSFI0001' . MOVE ls_ext TO ls_extension2 + 30 . INSERT ls_extension2 INTO TABLE lt_extension2 . ENDLOOP . IF i_test = 'X' . CALL FUNCTION 'BAPI_ACC_DOCUMENT_CHECK' EXPORTING documentheader = ls_documentheader TABLES accountgl = lt_accountgl accountreceivable = lt_accountreceivable accountpayable = lt_accountpayable currencyamount = lt_currencyamount criteria = lt_criteria return = lt_return extension2 = lt_extension2 . ELSE . CALL FUNCTION 'BAPI_ACC_DOCUMENT_POST' EXPORTING documentheader = ls_documentheader IMPORTING obj_key = l_obj_key TABLES accountgl = lt_accountgl accountreceivable = lt_accountreceivable accountpayable = lt_accountpayable currencyamount = lt_currencyamount criteria = lt_criteria return = lt_return extension2 = lt_extension2 . ENDIF . \" \u6574\u7406BAPI\u6d88\u606f CLEAR l_msg . LOOP AT lt_return INTO ls_return WHERE type CA 'AEX' . MESSAGE ID ls_return - id TYPE ls_return - type NUMBER ls_return - number WITH ls_return - message_v1 ls_return - message_v2 ls_return - message_v3 ls_return - message_v4 INTO ls_return - message . l_mtype = 'E' . l_msg = |{ l_msg }{ ls_return - message } ; |. ENDLOOP . IF sy - subrc <> 0 . l_mtype = 'S' . IF i_test = 'X' . l_msg = | \u6d4b\u8bd5\u8fd0\u884c\u6210\u529f |. ELSE . l_msg = | \u4f1a\u8ba1\u51ed\u8bc1 { l_obj_key ( 10 ) } \u5df2\u5904\u7406 |. ENDIF . ENDIF . \" \u56de\u5199\u62a5\u8868 LOOP AT GROUP ls_data_grp REFERENCE INTO DATA ( lr_data ). lr_data -> mtype = l_mtype . lr_data -> msg = l_msg . lr_data -> belnr = l_obj_key ( 10 ). ENDLOOP . IF i_test = 'X' . \" \u6d4b\u8bd5\u8fd0\u884c\u7ed3\u675f CONTINUE . ELSE . \" \u63d0\u4ea4\u6570\u636e\u5e93 IF l_mtype = 'E' . CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK' . ELSE . CALL FUNCTION 'BAPI_TRANSACTION_COMMIT' EXPORTING wait = 'X' . ENDIF . ENDIF . ENDLOOP . \" LOOP AT gt_data GROUP BY ENDFORM .","title":"\u8fc7\u8d26"},{"location":"fico/acc_document/#_3","text":"BAPI\u7684EXTENSION2\u589e\u5f3a\u4ee3\u7801\u5dee\u5f02\u4e0d\u5927\uff0c\u5bf9\u4e8e\u4e0a\u9762BAPI\u6765\u8bf4\uff0c\u9700\u8981\u5728ACC_DOCUMENT(BADI)\u589e\u5f3a\uff0cIF_EX_ACC_DOCUMENT~CHANGE\u65b9\u6cd5\u4e2d\u52a0\u5165\u4e0b\u9762\u4ee3\u7801\u3002 \u793a\u4f8b\u4ee3\u7801 *********************************************************************** * Example to move fields from BAPI parameter EXTENSION2 to structure * * ACCIT (accounting document line items). * * The dictionary structure (content for EXTENSION2-STRUCTURE) must * * contain field POSNR, (TYPE POSNR_ACC) to indentify the correct line * * item of the internal table ACCIT. * *********************************************************************** DATA : wa_extension TYPE bapiparex , ext_value ( 960 ) TYPE c , wa_accit TYPE accit , l_ref TYPE REF TO data . FIELD-SYMBOLS : <l_struc> TYPE ANY , <l_field> TYPE ANY . SORT c_extension2 BY structure . LOOP AT c_extension2 INTO wa_extension . AT NEW structure . CREATE DATA l_ref TYPE ( wa_extension - structure ). ASSIGN l_ref->* TO <l_struc> . ENDAT . CONCATENATE wa_extension - valuepart1 wa_extension - valuepart2 wa_extension - valuepart3 wa_extension - valuepart4 INTO ext_value . MOVE ext_value TO <l_struc> . ASSIGN COMPONENT 'POSNR' OF STRUCTURE <l_struc> TO <l_field> . READ TABLE c_accit WITH KEY posnr = <l_field> INTO wa_accit . IF sy - subrc IS INITIAL . MOVE-CORRESPONDING <l_struc> TO wa_accit . MODIFY c_accit FROM wa_accit INDEX sy - tabix . ENDIF . ENDLOOP .","title":"\u589e\u5f3a"},{"location":"fico/ckw1/","text":"\u6279\u91cfWBS\u6210\u672c\u6838\u7b97 \u00b6 \u8fd9\u4e2a\u662f\u6211\u5728\u6539\u5176\u4ed6\u4eba\u7684\u4ee3\u7801\u6240\u9047\u5230\u7684\u95ee\u9898\uff0c\u6279\u91cf\u6fc0\u6d3b\u7684\u65f6\u5019\uff0c\u4f1a\u6709\u6fc0\u6d3b\u72b6\u6001\u53cd\u590d\u7684\u60c5\u51b5\u3002 \u7ecf\u5206\u6790\uff0c\u8fd9\u662f\u7531\u4e8eCKW1\u4f1a\u5206\u6790BOM\u7684\u6240\u6709\u7ec4\u4ef6\uff0c\u5982\u679cBOM\u9876\u5c42\u7269\u6599\u51fa\u73b0\u95ee\u9898\uff0c\u4f1a\u5f71\u54cd\u5230\u4e0b\u5c42\u7684\u7ec4\u4ef6\u6fc0\u6d3b\u72b6\u6001\u3002 \u95ee\u9898\u590d\u73b0\u540e\uff0c\u5c31\u597d\u89e3\u51b3\u4e86\uff0c\u53ea\u9700\u8981\u6309\u987a\u5e8f\u5c06BOM\u7ec4\u4ef6\u4ece\u4e0a\u5230\u4e0b\u9010\u4e2a\u6fc0\u6d3b\u5373\u53ef\u3002 \u56e0\u4e3a\u4e0d\u662f\u6211\u5199\u7684\u4ee3\u7801\uff0c\u800c\u4e14\u7a0b\u5e8f\u4e5f\u4e0d\u600e\u4e48\u80fd\u590d\u7528\uff0c\u6240\u4ee5\u5c31\u4e0d\u8d34\u4ee3\u7801\u4e86\u3002\u540e\u9762\u9047\u5230\u8fd9\u4e2a\u9700\u6c42\u518d\u8865\u5145\u3002","title":"\u6279\u91cfWBS\u6210\u672c\u6838\u7b97"},{"location":"fico/ckw1/#wbs","text":"\u8fd9\u4e2a\u662f\u6211\u5728\u6539\u5176\u4ed6\u4eba\u7684\u4ee3\u7801\u6240\u9047\u5230\u7684\u95ee\u9898\uff0c\u6279\u91cf\u6fc0\u6d3b\u7684\u65f6\u5019\uff0c\u4f1a\u6709\u6fc0\u6d3b\u72b6\u6001\u53cd\u590d\u7684\u60c5\u51b5\u3002 \u7ecf\u5206\u6790\uff0c\u8fd9\u662f\u7531\u4e8eCKW1\u4f1a\u5206\u6790BOM\u7684\u6240\u6709\u7ec4\u4ef6\uff0c\u5982\u679cBOM\u9876\u5c42\u7269\u6599\u51fa\u73b0\u95ee\u9898\uff0c\u4f1a\u5f71\u54cd\u5230\u4e0b\u5c42\u7684\u7ec4\u4ef6\u6fc0\u6d3b\u72b6\u6001\u3002 \u95ee\u9898\u590d\u73b0\u540e\uff0c\u5c31\u597d\u89e3\u51b3\u4e86\uff0c\u53ea\u9700\u8981\u6309\u987a\u5e8f\u5c06BOM\u7ec4\u4ef6\u4ece\u4e0a\u5230\u4e0b\u9010\u4e2a\u6fc0\u6d3b\u5373\u53ef\u3002 \u56e0\u4e3a\u4e0d\u662f\u6211\u5199\u7684\u4ee3\u7801\uff0c\u800c\u4e14\u7a0b\u5e8f\u4e5f\u4e0d\u600e\u4e48\u80fd\u590d\u7528\uff0c\u6240\u4ee5\u5c31\u4e0d\u8d34\u4ee3\u7801\u4e86\u3002\u540e\u9762\u9047\u5230\u8fd9\u4e2a\u9700\u6c42\u518d\u8865\u5145\u3002","title":"\u6279\u91cfWBS\u6210\u672c\u6838\u7b97"},{"location":"fico/fi_clearing_account/","text":"\u6e05\u8d26 \u00b6 \u6e05\u8d26\u7684\u81ea\u5f00\u53d1\u4e3b\u8981\u4f7f\u7528\u4ee5\u4e0b\u6807\u51c6\u51fd\u6570\uff08\u5b9e\u9645\u4e5f\u662fBDC\uff09\u6765\u5904\u7406\uff1a POSTING_INTERFACE_START POSTING_INTERFACE_CLEARING POSTING_INTERFACE_END \u5206\u6790\u8bf4\u660e \u00b6 \u6e05\u8d26\u4e3b\u8981\u662f\u4e24\u4e2a\u95ee\u9898\uff1a \u662f\u5426\u5b58\u5728\u5dee\u5f02\u91d1\u989d \u5dee\u5f02\u91d1\u989d\u7684\u5904\u7406 \u5982\u679c\u4e0d\u5b58\u5728\u5dee\u5f02\u91d1\u989d\uff0c\u5219\u53ea\u9700\u8981\u5904\u7406\u672a\u6e05\u9879\u5373\u53ef\u3002\u5982\u679c\u5b58\u5728\u5dee\u5f02\u91d1\u989d\uff0c\u5219\u9700\u8981\u6839\u636e\u4e1a\u52a1\u987e\u95ee\u7684\u64cd\u4f5c\u6d41\u7a0b\uff0c\u8c03\u6574\u5dee\u5f02\u91d1\u989d\u5904\u7406\u4e0e\u672a\u6e05\u9879\u5904\u7406\u7684\u5148\u540e\u987a\u5e8f\u3002 \u6b63\u5e38\u6765\u8bf4\uff0c\u8d22\u52a1\u987e\u95ee\u90fd\u662f\u5148\u6311\u9009\u672a\u6e05\u9879\uff0c\u518d\u7531\u7cfb\u7edf\u81ea\u52a8\u751f\u6210\u5dee\u5f02\u884c\u3002\u4e0a\u9762\u7684\u6807\u51c6BDC\u51fd\u6570\u5374\u662f\u53cd\u8fc7\u6765\uff0c\u8fd9\u4f1a\u5bfc\u81f4\u4e00\u4e9b\u95ee\u9898\uff0c\u6bd4\u5982\u6e05\u8d26\u5b57\u6bb5AUGBL\u4e3a\u7a7a\uff0c\u65e0\u6cd5\u5173\u8054\u672a\u6e05\u9879\u3002 \u7cfb\u7edf\u81ea\u52a8\u751f\u6210\u7684\u5dee\u5f02\u884c\uff0c\u8fd8\u4f1a\u6309\u914d\u7f6e\u81ea\u52a8\u5e26\u51fa\u989d\u5916\u4fe1\u606f\uff0c\u5982\u679c\u4e1a\u52a1\u987e\u95ee\u5bf9\u8fd9\u4e9b\u5b57\u6bb5\u6709\u8981\u6c42\uff0c\u4e5f\u4f1a\u8ba9\u4eba\u5934\u79c3\u3002 \u6539\u5f97\u5410\u8840\uff0c\u6539\u51fa\u4e0b\u9762\u7684\u5de5\u5177\u7c7b\uff0cSAP\u4e0d\u63d0\u4f9b\u6807\u51c6\u51fd\u6570\u6765\u5904\u7406\u771f\u7684\u662f\u592a\u96be\u4e86\u3002 \u6e05\u8d26\u5de5\u5177 \u00b6 \u8be5\u5de5\u5177\u5c06\u8c03\u7528\u6807\u51c6\u51fd\u6570\u7684\u4e00\u4e9b\u901a\u7528\u64cd\u4f5c\u5c01\u88c5\u8d77\u6765\uff0c\u4f7f\u7528\u7684\u65f6\u5019\uff0c\u53ea\u9700\u4f20\u5165\u672a\u6e05\u9879\u5373\u53ef\u3002 ZCL_FI_CLEARING class ZCL_FI_CLEARING definition public create private . public section . types : BEGIN OF ty_clearing_line , bukrs TYPE bseg - bukrs , belnr TYPE bseg - belnr , gjahr TYPE bseg - gjahr , buzei TYPE bseg - buzei , END OF ty_clearing_line . types : tt_clearing_line TYPE STANDARD TABLE OF ty_clearing_line WITH EMPTY KEY . types : BEGIN OF ty_result , mtype TYPE bapi_mtype , msg TYPE bapi_msg , belnr TYPE bseg - belnr , END OF ty_result . class-methods CLASS_CONSTRUCTOR . class-methods POST_CUSTOMER importing ! I_BUKRS type BUKRS ! I_KUNNR type KUNNR ! I_AGUMS type AGUMS default 'A' ! I_BUDAT type BUDAT default SY - DATUM ! I_BKTXT type BKTXT optional ! IT_CLEARING_LINE type TT_CLEARING_LINE ! I_PROC type CHAR01 default 'M' ! IT_FTPOST type FAGL_T_FTPOST optional returning value ( RESULT ) type TY_RESULT . class-methods POST_VENDOR importing ! I_BUKRS type BUKRS ! I_LIFNR type LIFNR optional ! I_AGUMS type AGUMS default 'A' ! I_BUDAT type BUDAT default SY - DATUM ! I_BKTXT type BKTXT optional ! IT_CLEARING_LINE type TT_CLEARING_LINE ! I_PROC type CHAR01 default 'M' ! IT_FTPOST type FAGL_T_FTPOST optional returning value ( RESULT ) type TY_RESULT . class-methods POST_LEDGER importing ! I_BUKRS type BUKRS ! I_HKONT type HKONT ! I_AGUMS type AGUMS optional ! I_BUDAT type BUDAT default SY - DATUM ! I_BKTXT type BKTXT optional ! IT_CLEARING_LINE type TT_CLEARING_LINE ! I_PROC type CHAR01 default 'M' ! IT_FTPOST type FAGL_T_FTPOST optional returning value ( RESULT ) type TY_RESULT . class-methods BEFORE_FCODE_F11 changing ! FT type BDCDATA_TAB . class-methods AFTER_XFTPOST_LOOP changing ! FT type BDCDATA_TAB . protected section . PRIVATE SECTION . CLASS-DATA ms_t041a TYPE t041a . CLASS-DATA : mt_tbsl TYPE STANDARD TABLE OF tbsl . CLASS-DATA : BEGIN OF ms_extra , diff_amount_proc TYPE CHAR01 , program TYPE bdcdata - program , dynpro TYPE bdcdata - dynpro , FTPOST TYPE STANDARD TABLE OF ftpost WITH EMPTY KEY , END OF ms_extra . DATA m_bukrs TYPE bukrs . DATA m_koart TYPE koart . DATA m_agums TYPE agums . DATA m_hkont TYPE hkont . DATA m_budat TYPE budat . DATA m_bktxt TYPE bktxt . DATA : mt_bseg TYPE STANDARD TABLE OF bseg . DATA ms_result TYPE ty_result . CLASS-METHODS determine_posting_key IMPORTING ! i_koart TYPE koart ! i_umsks TYPE umsks ! i_amount_diff TYPE p RETURNING VALUE ( r_bschl ) TYPE bschl . METHODS get_bsid IMPORTING ! it_clearing_line TYPE tt_clearing_line . METHODS get_bsik IMPORTING ! it_clearing_line TYPE tt_clearing_line . METHODS get_bseg IMPORTING ! it_clearing_line TYPE tt_clearing_line . METHODS posting_before . METHODS posting_interface . ENDCLASS . CLASS ZCL_FI_CLEARING IMPLEMENTATION . * <SIGNATURE>---------------------------------------------------------------------------------------+ * | Static Public Method ZCL_FI_CLEARING=>AFTER_XFTPOST_LOOP * +-------------------------------------------------------------------------------------------------+ * | [<-->] FT TYPE BDCDATA_TAB * +--------------------------------------------------------------------------------------</SIGNATURE> METHOD after_xftpost_loop . \" \u9ed8\u8ba4\u5904\u7406\uff0c\u5148\u5904\u7406\u5dee\u5f02\u884c\uff0c\uff08\u518d\u5230\u8be5\u589e\u5f3a\uff09\uff0c\u518d\u5904\u7406\u672a\u6e05\u9879 CHECK ms_extra - diff_amount_proc = 'M' OR ms_extra - diff_amount_proc = '' . DATA ls_bdcdata TYPE bdcdata . DEFINE _bdc_data . CLEAR ls_bdcdata . ls_bdcdata - fnam = &1 . ls_bdcdata - fval = &2 . INSERT ls_bdcdata INTO TABLE ft[] . END-OF-DEFINITION . \" \u6309\u9879\u76ee\u9700\u6c42\uff0c\u586b\u5199\u9700\u8981\u7684\u4fe1\u606f LOOP AT ms_extra - ftpost INTO DATA ( ls_ftpost ). _bdc_data ls_ftpost - fnam ls_ftpost - fval . ENDLOOP . ENDMETHOD . * <SIGNATURE>---------------------------------------------------------------------------------------+ * | Static Public Method ZCL_FI_CLEARING=>BEFORE_FCODE_F11 * +-------------------------------------------------------------------------------------------------+ * | [<-->] FT TYPE BDCDATA_TAB * +--------------------------------------------------------------------------------------</SIGNATURE> METHOD before_fcode_f11 . \" \u5148\u5904\u7406\u672a\u6e05\u9879\uff0c\u518d\u5904\u7406\u5dee\u5f02\u884c CHECK ms_extra - diff_amount_proc = 'A' . DATA ls_bdcdata TYPE bdcdata . DEFINE _bdc_begin . CLEAR ls_bdcdata . ls_bdcdata - program = &1 . ls_bdcdata - dynpro = &2 . ls_bdcdata - dynbegin = 'X' . INSERT ls_bdcdata INTO TABLE ft[] . END-OF-DEFINITION . DEFINE _bdc_data . CLEAR ls_bdcdata . ls_bdcdata - fnam = &1 . ls_bdcdata - fval = &2 . INSERT ls_bdcdata INTO TABLE ft[] . END-OF-DEFINITION . \" _bdc_begin 'SAPMF05A' '0733'. \" \u8be5\u589e\u5f3a\u4f4d\u7f6e\u662f\u5728\u4fdd\u5b58\u524d\uff0c\u539f\u672c\u7684BDC\u4ee3\u7801\u53ea\u7f3a\u5c11\u547d\u4ee4 _bdc_data 'BDC_OKCODE' 'PA' . \" \u5904\u7406\u672a\u6e05\u9879 \" MAIN - \u6807\u51c6 \" PART - \u90e8\u5206\u652f\u4ed8 \" REST - \u5269\u4f59\u9879\u76ee \" WITH - \u9884\u6263\u7a0e _bdc_begin 'SAPDF05X' '3100' . _bdc_data 'BDC_OKCODE' 'REST' . \" \u5269\u4f59\u8fc7\u8d26 _bdc_begin 'SAPDF05X' '3100' . _bdc_data 'BDC_OKCODE' 'PI' . \" PI - \u53cc\u51fb\u884c _bdc_begin 'SAPDF05X' '3100' . _bdc_data 'BDC_OKCODE' 'BS' . \" BS - \u6a21\u62df IF ( ms_extra - program IS INITIAL OR ms_extra - dynpro IS INITIAL ) \" \u6ca1\u6709\u4e0b\u4e00\u6b65\u7684\u5c4f\u5e55 OR ms_extra - ftpost IS INITIAL . \" \u6ca1\u6709\u7279\u6b8a\u5904\u7406 \" \u6ca1\u6709\u9700\u8981\u8865\u5145\u7684\uff0c\u76f4\u63a5\u4fdd\u5b58 _bdc_begin 'SAPMF05A' '0301' . \" \u8865\u5145\u4e00\u4e2a\u5c4f\u5e55 \" _bdc_data 'BDC_OKCODE' '/11'. \" \u540e\u7eed\u7684\u6807\u51c6\u4ee3\u7801\u6700\u540e\u4f1a\u624b\u5de5\u6dfb\u52a0\u4e00\u884c\u547d\u4ee4\u4fdd\u5b58 ELSE . * \" \u6b63\u5e38\u60c5\u51b5\uff0c\u7531\u4e8e\u884c\u9879\u76ee\u5fc5\u586b\uff0c\u4f1a\u8df3\u5230\u4e3b\u754c\u9762\u62a5\u9519 * _bdc_begin 'SAPMF05A' '0700'. * _bdc_data 'BDC_OKCODE' 'NK'. \" NK - \u8865\u5145\uff0c\u8df3\u8f6c\u5230\u9700\u8981\u8865\u5145\u6570\u636e\u7684\u754c\u9762 _bdc_begin 'SAPMF05A' '0700' . _bdc_data 'BDC_OKCODE' 'PI' . \" \u9009\u62e9\u51ed\u8bc1\u884c _bdc_begin 'SAPMF05A' '0610' . _bdc_data '*BSEG-BUZEI' '001' . \" \u9ed8\u8ba4\u9009\u7b2c\u4e00\u884c _bdc_data 'BDC_OKCODE' 'ENTR' . \" \u786e\u8ba4 \" \u6309\u9879\u76ee\u9700\u6c42\uff0c\u586b\u5199\u9700\u8981\u624b\u5de5\u5904\u7406\u7684\u4fe1\u606f _bdc_begin ms_extra - program ms_extra - dynpro . LOOP AT ms_extra - ftpost INTO DATA ( ls_ftpost ). _bdc_data ls_ftpost - fnam ls_ftpost - fval . ENDLOOP . ENDIF . ENDMETHOD . * <SIGNATURE>---------------------------------------------------------------------------------------+ * | Static Public Method ZCL_FI_CLEARING=>CLASS_CONSTRUCTOR * +-------------------------------------------------------------------------------------------------+ * +--------------------------------------------------------------------------------------</SIGNATURE> method CLASS_CONSTRUCTOR . \" AUGLV\u5bf9\u5e94FB05\u8981\u5904\u7406\u7684\u4e1a\u52a1 \" UMBUCHNG, Transfer posting with clearing, \u8f6c\u8d26\u5e76\u6e05\u8d26 SELECT SINGLE * FROM t041a WHERE auglv = 'UMBUCHNG' INTO @ ms_t041a . SELECT * FROM tbsl INTO TABLE @ mt_tbsl . endmethod . * <SIGNATURE>---------------------------------------------------------------------------------------+ * | Static Private Method ZCL_FI_CLEARING=>DETERMINE_POSTING_KEY * +-------------------------------------------------------------------------------------------------+ * | [--->] I_KOART TYPE KOART * | [--->] I_UMSKS TYPE UMSKS * | [--->] I_AMOUNT_DIFF TYPE P * | [<-()] R_BSCHL TYPE BSCHL * +--------------------------------------------------------------------------------------</SIGNATURE> method DETERMINE_POSTING_KEY . \" \u6839\u636e\u79d1\u76ee\u7c7b\u578b\uff0c\u7279\u6b8a\u603b\u8d26\u6807\u8bc6\uff0c\u5dee\u5f02\u91d1\u989d\uff0c\u67e5\u627e\u5bf9\u5e94\u8bb0\u8d26\u7801 CASE i_koart . WHEN 'D' . IF i_amount_diff < 0 . IF i_umsks = space . r_bschl = ms_t041a - rpdha . ELSE . r_bschl = ms_t041a - bsdhs . ENDIF . ELSE . IF i_umsks = space . r_bschl = ms_t041a - rpdso . ELSE . r_bschl = ms_t041a - bsdss . ENDIF . ENDIF . WHEN 'K' . IF i_amount_diff < 0 . IF i_umsks = space . r_bschl = ms_t041a - rpkha . ELSE . r_bschl = ms_t041a - bskhs . ENDIF . ELSE . IF i_umsks = space . r_bschl = ms_t041a - rpkso . ELSE . r_bschl = ms_t041a - bskss . ENDIF . ENDIF . WHEN 'S' . IF i_amount_diff < 0 . r_bschl = ms_t041a - bssha . ELSE . r_bschl = ms_t041a - bssso . ENDIF . ENDCASE . endmethod . * <SIGNATURE>---------------------------------------------------------------------------------------+ * | Instance Private Method ZCL_FI_CLEARING->GET_BSEG * +-------------------------------------------------------------------------------------------------+ * | [--->] IT_CLEARING_LINE TYPE TT_CLEARING_LINE * +--------------------------------------------------------------------------------------</SIGNATURE> method GET_BSEG . CHECK it_clearing_line IS NOT INITIAL . \" \u68c0\u67e5\u5e76\u83b7\u53d6\u53ef\u4ee5\u6e05\u8d26\u7684\u51ed\u8bc1\u6570\u636e SELECT bseg~bukrs , bseg~belnr , bseg~gjahr , bseg~buzei , bseg~umsks , \" \u7279\u6b8a\u603b\u8d26\u4e8b\u52a1 bseg~umskz , \" \u7279\u6b8a\u603b\u8d26\u6807\u8bc6 bseg~zfbdt , \" \u4ed8\u6b3e\u6e05\u7b97\u65e5\u671f bseg~shkzg , bseg~dmbtr , bseg~wrbtr , bkpf~waers FROM bseg JOIN bkpf ON bseg~bukrs = bkpf~bukrs AND bseg~belnr = bkpf~belnr AND bseg~gjahr = bkpf~gjahr FOR ALL ENTRIES IN @ it_clearing_line[] WHERE bseg~bukrs = @ it_clearing_line - bukrs AND bseg~belnr = @ it_clearing_line - belnr AND bseg~gjahr = @ it_clearing_line - gjahr AND bseg~buzei = @ it_clearing_line - buzei INTO CORRESPONDING FIELDS OF TABLE @ mt_bseg . endmethod . * <SIGNATURE>---------------------------------------------------------------------------------------+ * | Instance Private Method ZCL_FI_CLEARING->GET_BSID * +-------------------------------------------------------------------------------------------------+ * | [--->] IT_CLEARING_LINE TYPE TT_CLEARING_LINE * +--------------------------------------------------------------------------------------</SIGNATURE> method GET_BSID . CHECK it_clearing_line IS NOT INITIAL . \" \u68c0\u67e5\u5e76\u83b7\u53d6\u53ef\u4ee5\u6e05\u8d26\u7684\u51ed\u8bc1\u6570\u636e SELECT bukrs , belnr , gjahr , buzei , projk , \" \u5ba2\u6237WBS\u5fc5\u586b umsks , \" \u7279\u6b8a\u603b\u8d26\u4e8b\u52a1 umskz , \" \u7279\u6b8a\u603b\u8d26\u6807\u8bc6 zfbdt , \" \u4ed8\u6b3e\u6e05\u7b97\u65e5\u671f shkzg , dmbtr , wrbtr , waers FROM bsid FOR ALL ENTRIES IN @ it_clearing_line[] WHERE bukrs = @ it_clearing_line - bukrs AND belnr = @ it_clearing_line - belnr AND gjahr = @ it_clearing_line - gjahr AND buzei = @ it_clearing_line - buzei INTO CORRESPONDING FIELDS OF TABLE @ mt_bseg . endmethod . * <SIGNATURE>---------------------------------------------------------------------------------------+ * | Instance Private Method ZCL_FI_CLEARING->GET_BSIK * +-------------------------------------------------------------------------------------------------+ * | [--->] IT_CLEARING_LINE TYPE TT_CLEARING_LINE * +--------------------------------------------------------------------------------------</SIGNATURE> method GET_BSIK . CHECK it_clearing_line IS NOT INITIAL . \" \u68c0\u67e5\u5e76\u83b7\u53d6\u53ef\u4ee5\u6e05\u8d26\u7684\u51ed\u8bc1\u6570\u636e SELECT bukrs , belnr , gjahr , buzei , umsks , \" \u7279\u6b8a\u603b\u8d26\u4e8b\u52a1 umskz , \" \u7279\u6b8a\u603b\u8d26\u6807\u8bc6 zfbdt , \" \u4ed8\u6b3e\u6e05\u7b97\u65e5\u671f shkzg , dmbtr , wrbtr , waers FROM bsik FOR ALL ENTRIES IN @ it_clearing_line[] WHERE bukrs = @ it_clearing_line - bukrs AND belnr = @ it_clearing_line - belnr AND gjahr = @ it_clearing_line - gjahr AND buzei = @ it_clearing_line - buzei INTO CORRESPONDING FIELDS OF TABLE @ mt_bseg . endmethod . * <SIGNATURE>---------------------------------------------------------------------------------------+ * | Instance Private Method ZCL_FI_CLEARING->POSTING_BEFORE * +-------------------------------------------------------------------------------------------------+ * +--------------------------------------------------------------------------------------</SIGNATURE> method POSTING_BEFORE . IF m_bukrs IS INITIAL . ms_result - mtype = 'E' . ms_result - msg = '\u8bf7\u8f93\u5165\u516c\u53f8\u4ee3\u7801' . RETURN . ENDIF . IF m_hkont IS INITIAL . ms_result - mtype = 'E' . ms_result - msg = '\u8bf7\u8f93\u5165\u79d1\u76ee' . RETURN . ENDIF . IF m_koart = 'D' OR m_koart = 'K' OR m_koart = 'S' . ELSE . ms_result - mtype = 'E' . ms_result - msg = '\u76ee\u524d\u4ec5\u652f\u6301\u5ba2\u6237\u6e05\u8d26\u3001\u4f9b\u5e94\u5546\u6e05\u8d26\u3001\u603b\u8d26\u6e05\u8d26' . RETURN . ENDIF . IF mt_bseg IS INITIAL . ms_result - mtype = 'E' . ms_result - msg = '\u6ca1\u6709\u672a\u6e05\u51ed\u8bc1\u6570\u636e' . RETURN . ENDIF . endmethod . * <SIGNATURE>---------------------------------------------------------------------------------------+ * | Instance Private Method ZCL_FI_CLEARING->POSTING_INTERFACE * +-------------------------------------------------------------------------------------------------+ * +--------------------------------------------------------------------------------------</SIGNATURE> METHOD posting_interface . DATA : lt_ftclear TYPE STANDARD TABLE OF ftclear , lt_ftpost TYPE STANDARD TABLE OF ftpost , lt_blntab TYPE STANDARD TABLE OF blntab , lt_fttax TYPE STANDARD TABLE OF fttax . \" \u6e05\u8d26\u9879\u76ee\u9009\u62e9\u6761\u4ef6 \" \u9009\u62e9\u5b57\u6bb5\u586bBELNR\uff0c\u5e76\u4f20\u503c\u662f\u51ed\u8bc1+\u884c\u9879\u76ee\uff0c\u5c31\u80fd\u53d6\u5230\u5bf9\u5e94\u51ed\u8bc1\u884c \" \u56e0\u6b64\u65e0\u9700\u5176\u4ed6\u989d\u5916\u7684\u7b5b\u9009\u6761\u4ef6 \" \u5982\u679c\u4e0d\u80fd\u786e\u5b9a\uff0c\u6216\u8005\u5c31\u9700\u8981\u67d0\u4e00\u7c7b\u7684\u6570\u636e\uff0c\u53ef\u4ee5\u81ea\u5df1\u914c\u60c5\u8c03\u6574 DATA ls_ftclear TYPE ftclear . DEFINE _ftclear . CLEAR ls_ftclear . ls_ftclear - agbuk = m_bukrs . \" \u516c\u53f8 ls_ftclear - agkon = m_hkont . \" \u79d1\u76ee ls_ftclear - agkoa = m_koart . \" \u8d26\u6237\u7c7b\u578b ls_ftclear - xnops = abap_true . \" \u6807\u51c6\u672a\u6e05\u9879 ls_ftclear - agums = m_agums . \" \u7279\u522b\u603b\u8d26\u6807\u8bc6 ls_ftclear - selfd = &2 . ls_ftclear - selvon = &3 . INSERT ls_ftclear INTO TABLE &1 . END-OF-DEFINITION . \" \u624b\u5de5\u6e05\u8d26\u9879\u76ee\uff0c\u5bf9\u4e8e\u5b58\u5728\u5dee\u989d\u7684\u9879\u76ee\uff0c\u9700\u8981\u624b\u5de5\u586b\u5199\u6e05\u8d26\u91d1\u989d \" \u5c31\u662fBDC\u5f55\u5c4f\uff0c\u5982\u679c\u6709\u7f3a\u4ec0\u4e48\u5b57\u6bb5\uff0c\u53ef\u4ee5\u5230\u524d\u53f0F1\u83b7\u53d6\u5c4f\u5e55\u5b57\u6bb5\u540d DATA ls_ftpost TYPE ftpost . DEFINE _ftpost . IF &4 IS NOT INITIAL OR &4 <> '' . CLEAR ls_ftpost . ls_ftpost - stype = &2 . \" K\u62ac\u5934\uff0cP\u884c\u9879\u76ee ls_ftpost - count = &3 . \" \u62ac\u5934\u9ed8\u8ba41\uff0c\u884c\u9879\u76ee\u6d41\u6c34 ls_ftpost - fnam = &4 . \" \u5c4f\u5e55\u5b57\u6bb5 ls_ftpost - fval = &5 . \" \u5b57\u6bb5\u503c INSERT ls_ftpost INTO TABLE &1 . ENDIF . END-OF-DEFINITION . \" \u6570\u636e\u6821\u9a8c CLEAR ms_result . posting_before ( ). CHECK ms_result - mtype <> 'E' . \" \u672a\u6e05\u9879\u76ee LOOP AT mt_bseg REFERENCE INTO DATA ( lr_bseg ). DATA ( l_selfd ) = 'BELNR' . DATA ( l_selval ) = |{ lr_bseg -> belnr }{ lr_bseg -> gjahr }{ lr_bseg -> buzei }|. _ftclear lt_ftclear l_selfd l_selval . ENDLOOP . \" \u6c47\u603b\u91d1\u989d\uff0c\u83b7\u53d6\u6e05\u8d26\u5dee\u5f02\u91d1\u989d DATA l_amount_diff TYPE p LENGTH 16 DECIMALS 2 . \" \u5dee\u989d\uff0cP\u7c7b\u578b\u6700\u5927\u503c LOOP AT mt_bseg REFERENCE INTO lr_bseg . IF lr_bseg -> shkzg = 'S' . l_amount_diff = l_amount_diff + lr_bseg -> dmbtr . ELSE . l_amount_diff = l_amount_diff - lr_bseg -> dmbtr . ENDIF . ENDLOOP . \" \u83b7\u53d6\u5176\u4ed6\u8f85\u52a9\u53c2\u6570 DATA l_umsks TYPE umsks . \" \u7279\u6b8a\u603b\u8d26\u4e8b\u52a1 DATA l_umskz TYPE umskz . \" \u7279\u6b8a\u603b\u8d26\u6807\u8bc6 DATA lr_clearing_ref TYPE REF TO bseg . \" \u4efb\u53d6\u4e00\u884c\u672a\u6e05\u9879\u4f5c\u4e3a\u5dee\u5f02\u91d1\u989d\u7684\u53c2\u8003 LOOP AT mt_bseg REFERENCE INTO lr_bseg . \" \u53ea\u8981\u6709\u4e00\u884c\u662f\u7279\u6b8a\u603b\u8d26\u4e8b\u52a1\uff0c\u6e05\u8d26\u5c31\u4ee5\u7279\u6b8a\u603b\u8d26\u65b9\u5f0f\u8fdb\u884c IF l_umsks IS INITIAL . l_umsks = lr_bseg -> umsks . l_umskz = lr_bseg -> umskz . ENDIF . \" \u627e\u51fa\u91d1\u989d\u7edd\u5bf9\u503c\u6700\u5927\u7684\u884c\u4f5c\u4e3a\u53c2\u8003\u884c \" \uff08\u6211\u8fd9\u9879\u76ee\u8981\u6c42\u5982\u6b64\uff0c\u53ef\u81ea\u884c\u8c03\u6574\uff09 IF lr_clearing_ref IS NOT BOUND . lr_clearing_ref = lr_bseg . ELSEIF abs ( lr_bseg -> dmbtr ) > abs ( lr_clearing_ref -> dmbtr ). lr_clearing_ref = lr_bseg . ENDIF . ENDLOOP . DATA ( l_budat ) = |{ m_budat DATE = USER }|. \" BDC\u5f55\u5c4f\uff0c\u65e5\u671f\u8981\u586b\u5199\u7528\u6237\u683c\u5f0f SELECT SINGLE waers FROM t001 WHERE bukrs = @ m_bukrs INTO @ DATA ( l_waers ). \" \u516c\u53f8\u672c\u5e01 \" K-\u62ac\u5934 _ftpost lt_ftpost 'K' 1 'BKPF-BUKRS' m_bukrs . _ftpost lt_ftpost 'K' 1 'BKPF-BLART' 'AB' . \" \u6e05\u8d26\u53ea\u6709\u8fd9\u4e00\u79cd\u51ed\u8bc1\u7c7b\u578b _ftpost lt_ftpost 'K' 1 'BKPF-BLDAT' l_budat . _ftpost lt_ftpost 'K' 1 'BKPF-BUDAT' l_budat . _ftpost lt_ftpost 'K' 1 'BKPF-MONAT' m_budat + 4 ( 2 ). _ftpost lt_ftpost 'K' 1 'BKPF-WAERS' l_waers . IF m_bktxt IS NOT INITIAL . _ftpost lt_ftpost 'K' 1 'BKPF-BKTXT' m_bktxt . ENDIF . \" \u5224\u65ad\u662f\u5426\u5b58\u5728\u5dee\u5f02\u91d1\u989d IF l_amount_diff = 0 . CLEAR ms_extra . \" \u6ca1\u6709\u5dee\u5f02\u91d1\u989d\uff0c\u65e0\u9700\u4efb\u4f55\u589e\u5f3a\u5904\u7406 ELSE . \" \u5b58\u5728\u5dee\u5f02\u91d1\u989d \" \u6839\u636e\u79d1\u76ee\u3001\u603b\u8d26\u4e8b\u52a1\u3001\u4f59\u989d\uff0c\u67e5\u627e\u8bb0\u8d26\u7801 DATA l_bschl TYPE bschl . l_bschl = determine_posting_key ( i_koart = m_koart i_umsks = l_umsks i_amount_diff = l_amount_diff ). DATA l_sgtxt TYPE bseg - sgtxt . l_sgtxt = | \u6e05\u8d26 { lr_clearing_ref -> belnr }|. \" \u884c\u6587\u672c\uff0c\u8bb0\u5f55\u53c2\u8003\u7684\u51ed\u8bc1 \" \u5bf9\u5dee\u5f02\u91d1\u989d\u7684\u5904\u7406\u65b9\u6848\u9009\u62e9 CASE ms_extra - diff_amount_proc . WHEN 'A' . \" \u81ea\u52a8\u6e05\u8d26\uff0c\u5148\u5904\u7406\u672a\u6e05\u9879\uff0c\u518d\u5904\u7406\u5dee\u5f02\u91d1\u989d \" \u79fb\u9664\u624b\u5de5\u6e05\u8d26\u90e8\u5206 DELETE lt_ftpost WHERE stype = 'P' . \" \u9879\u76ee\u7279\u6b8a\u5904\u7406 IF l_umskz IS NOT INITIAL \" \u7279\u6b8a\u603b\u8d26 OR l_bschl + 1 ( 1 ) = '9' . \" \u51b2\u9500 DELETE ms_extra - ftpost WHERE fnam <> 'BSEG-SGTXT' . \" \u4ec5\u6587\u672c\u53ef\u8f93\u5165 ENDIF . \" \u590d\u5236LFIPIF00\u4e2d\u7684\u5b50\u4f8b\u7a0bdynpro_ermitteln DATA l_winfk TYPE t019w - winfk . CLEAR l_winfk . CASE m_koart . WHEN 'D' . l_winfk = 'ZKOD' . WHEN 'K' . l_winfk = 'ZKOK' . WHEN 'S' . l_winfk = 'ZKOS' . WHEN 'A' . l_winfk = 'ZKOA' . ENDCASE . \" \u67e5\u627e\u5dee\u5f02\u884c\u7684\u5c4f\u5e55\uff08\u4ecePOSTING_INTERFACE_CLEARING\u4e2d\u627e\u5230\u7684\u4ee3\u7801\uff09 CALL FUNCTION 'NEXT_DYNPRO_SEARCH' EXPORTING i_bschl = l_bschl i_bukrs = m_bukrs i_tcode = 'FB05' i_umskz = l_umskz i_winfk = l_winfk IMPORTING e_dynnra = ms_extra - dynpro e_mpool = ms_extra - program EXCEPTIONS OTHERS = 99 . IF sy - subrc <> 0 . CLEAR ms_extra . ENDIF . WHEN OTHERS . \" \u624b\u5de5\u6e05\u8d26\uff0c\u5148\u5904\u7406\u5dee\u5f02\u91d1\u989d DATA ( l_dmbtr ) = |{ abs ( l_amount_diff ) NUMBER = USER }|. \" BDC\u5916\u90e8\u683c\u5f0f\uff0c\u53e6\u5916\u6b63\u8d1f\u6309\u8bb0\u8d26\u7801\u533a\u5206\uff0c\u6240\u4ee5\u90fd\u4f20\u6b63\u503c DATA ( l_zfbdt ) = |{ lr_clearing_ref -> zfbdt DATE = USER }|. \" BDC\u5916\u90e8\u683c\u5f0f \" P-\u884c\u9879\u76ee \" \u6211\u8fd9\u9879\u76ee\u8981\u6c42\u6e05\u8d26\u540e\u751f\u6210\u65e0\u51ed\u8bc1\u884c\u6216\u4e00\u884c\u5dee\u989d\u7684\u6e05\u8d26\u51ed\u8bc1 \" \u6709\u751f\u6210\u591a\u884c\u8981\u6c42\u7684\u81ea\u5df1\u914c\u60c5\u4fee\u6539 _ftpost lt_ftpost 'P' 1 'RF05A-NEWBS' l_bschl . \" \u8fc7\u8d26\u7801 _ftpost lt_ftpost 'P' 1 'RF05A-NEWKO' m_hkont . \" \u79d1\u76ee _ftpost lt_ftpost 'P' 1 'RF05A-NEWUM' l_umskz . \" \u7279\u522b\u603b\u8d26\u6807\u8bc6 _ftpost lt_ftpost 'P' 1 'BSEG-WRBTR' l_dmbtr . \" \u6c47\u603b\u540e\u7684\u5dee\u989d _ftpost lt_ftpost 'P' 1 'BSEG-ZFBDT' l_zfbdt . \" \u4ed8\u6b3e\u6e05\u7b97\u65e5\u671f _ftpost lt_ftpost 'P' 1 'BSEG-SGTXT' l_sgtxt . \" \u884c\u9879\u76ee\u6587\u672c\u5fc5\u586b ENDCASE . ENDIF . \" IF l_amount_diff <> 0. SORT lt_ftpost BY stype count fnam fval . DELETE ADJACENT DUPLICATES FROM lt_ftpost COMPARING stype count fnam . DATA l_mode TYPE char01 VALUE 'N' . \" BDC\u5bfc\u5165\u6a21\u5f0f CALL FUNCTION 'POSTING_INTERFACE_START' EXPORTING i_client = sy - mandt i_function = 'C' i_mode = l_mode i_keep = 'X' i_update = 'S' i_user = sy - uname . IF sy - subrc <> 0 . ms_result - mtype = 'E' . MESSAGE ID sy - msgid TYPE sy - msgty NUMBER sy - msgno WITH sy - msgv1 sy - msgv2 sy - msgv3 sy - msgv4 INTO ms_result - msg . RETURN . ENDIF . CALL FUNCTION 'POSTING_INTERFACE_CLEARING' EXPORTING i_auglv = ms_t041a - auglv \" \u6e05\u8d26\u7a0b\u5e8f\u56fa\u5b9aUMBUCHNG i_tcode = 'FB05' \" \u56fa\u5b9a i_sgfunct = 'C' i_no_auth = 'X' \" \u4e0d\u8003\u8651\u6743\u9650 IMPORTING e_msgid = sy - msgid e_msgno = sy - msgno e_msgty = sy - msgty e_msgv1 = sy - msgv1 e_msgv2 = sy - msgv2 e_msgv3 = sy - msgv3 e_msgv4 = sy - msgv4 TABLES t_blntab = lt_blntab t_ftclear = lt_ftclear t_ftpost = lt_ftpost t_fttax = lt_fttax EXCEPTIONS clearing_procedure_invalid = 1 clearing_procedure_missing = 2 table_t041a_empty = 3 transaction_code_invalid = 4 amount_format_error = 5 too_many_line_items = 6 company_code_invalid = 7 screen_not_found = 8 no_authorization = 9 OTHERS = 10 . IF sy - subrc <> 0 . ms_result - mtype = 'E' . ENDIF . MESSAGE ID sy - msgid TYPE sy - msgty NUMBER sy - msgno WITH sy - msgv1 sy - msgv2 sy - msgv3 sy - msgv4 INTO ms_result - msg . CALL FUNCTION 'POSTING_INTERFACE_END' EXCEPTIONS session_not_processable = 1 OTHERS = 2 . IF sy - subrc <> 0 . ms_result - mtype = 'E' . MESSAGE ID sy - msgid TYPE sy - msgty NUMBER sy - msgno WITH sy - msgv1 sy - msgv2 sy - msgv3 sy - msgv4 INTO ms_result - msg . RETURN . ENDIF . READ TABLE lt_blntab INTO DATA ( ls_blntab ) INDEX 1 . IF sy - subrc = 0 . ms_result - mtype = 'S' . ms_result - msg = '\u6e05\u8d26\u5df2\u5904\u7406' . ms_result - belnr = ls_blntab - belnr . ELSE . ms_result - mtype = 'E' . IF ms_result - msg IS INITIAL . ms_result - msg = '\u6e05\u8d26\u5904\u7406\u5931\u8d25' . ENDIF . ENDIF . ENDMETHOD . * <SIGNATURE>---------------------------------------------------------------------------------------+ * | Static Public Method ZCL_FI_CLEARING=>POST_CUSTOMER * +-------------------------------------------------------------------------------------------------+ * | [--->] I_BUKRS TYPE BUKRS * | [--->] I_KUNNR TYPE KUNNR * | [--->] I_AGUMS TYPE AGUMS (default ='A') * | [--->] I_BUDAT TYPE BUDAT (default =SY-DATUM) * | [--->] I_BKTXT TYPE BKTXT(optional) * | [--->] IT_CLEARING_LINE TYPE TT_CLEARING_LINE * | [--->] I_PROC TYPE CHAR01 (default ='M') * | [--->] IT_FTPOST TYPE FAGL_T_FTPOST(optional) * | [<-()] RESULT TYPE TY_RESULT * +--------------------------------------------------------------------------------------</SIGNATURE> METHOD post_customer . IF it_clearing_line IS INITIAL . result - mtype = 'E' . result - mtype = '\u6ca1\u6709\u672a\u6e05\u9879' . RETURN . ENDIF . CLEAR ms_extra . \" A-\u5148\u5904\u7406\u672a\u6e05\u9879\uff0c\u518d\u7531\u7cfb\u7edf\u5e26\u51fa\u5dee\u5f02\u884c\uff0c\u6700\u540e\u5bf9\u5dee\u5f02\u884c\u8fdb\u884c\u624b\u5de5\u8c03\u6574 \" M-\u5148\u624b\u5de5\u751f\u6210\u5e76\u8c03\u6574\u5dee\u5f02\u884c\uff0c\u518d\u5904\u7406\u672a\u6e05\u9879 ms_extra - diff_amount_proc = i_proc . ms_extra - ftpost = it_ftpost . \" \u9664\u4e86\u6211\u9884\u7559\u7684\u90a3\u4e9b\u5b57\u6bb5\uff0c\u6309\u9879\u76ee\u53ef\u80fd\u4f1a\u6709\u4e0d\u540c\u8bbe\u7f6e\uff0c\u53ef\u4ee5\u901a\u8fc7\u8be5\u9879\u8bbe\u7f6e DATA ( lo_ins ) = NEW zcl_fi_clearing ( ). lo_ins -> m_bukrs = i_bukrs . lo_ins -> m_koart = 'D' . lo_ins -> m_agums = i_agums . lo_ins -> m_hkont = i_kunnr . lo_ins -> m_budat = i_budat . lo_ins -> m_bktxt = i_bktxt . lo_ins -> get_bsid ( it_clearing_line ). lo_ins -> posting_interface ( ). result = lo_ins -> ms_result . ENDMETHOD . * <SIGNATURE>---------------------------------------------------------------------------------------+ * | Static Public Method ZCL_FI_CLEARING=>POST_LEDGER * +-------------------------------------------------------------------------------------------------+ * | [--->] I_BUKRS TYPE BUKRS * | [--->] I_HKONT TYPE HKONT * | [--->] I_AGUMS TYPE AGUMS(optional) * | [--->] I_BUDAT TYPE BUDAT (default =SY-DATUM) * | [--->] I_BKTXT TYPE BKTXT(optional) * | [--->] IT_CLEARING_LINE TYPE TT_CLEARING_LINE * | [--->] I_PROC TYPE CHAR01 (default ='M') * | [--->] IT_FTPOST TYPE FAGL_T_FTPOST(optional) * | [<-()] RESULT TYPE TY_RESULT * +--------------------------------------------------------------------------------------</SIGNATURE> METHOD POST_LEDGER . IF it_clearing_line IS INITIAL . result - mtype = 'E' . result - mtype = '\u6ca1\u6709\u672a\u6e05\u9879' . RETURN . ENDIF . CLEAR ms_extra . \" A-\u5148\u5904\u7406\u672a\u6e05\u9879\uff0c\u518d\u7531\u7cfb\u7edf\u5e26\u51fa\u5dee\u5f02\u884c\uff0c\u6700\u540e\u5bf9\u5dee\u5f02\u884c\u8fdb\u884c\u624b\u5de5\u8c03\u6574 \" M-\u5148\u624b\u5de5\u751f\u6210\u5e76\u8c03\u6574\u5dee\u5f02\u884c\uff0c\u518d\u5904\u7406\u672a\u6e05\u9879 ms_extra - diff_amount_proc = i_proc . ms_extra - ftpost = it_ftpost . \" \u9664\u4e86\u6211\u9884\u7559\u7684\u90a3\u4e9b\u5b57\u6bb5\uff0c\u6309\u9879\u76ee\u53ef\u80fd\u4f1a\u6709\u4e0d\u540c\u8bbe\u7f6e\uff0c\u53ef\u4ee5\u901a\u8fc7\u8be5\u9879\u8bbe\u7f6e DATA ( lo_ins ) = NEW zcl_fi_clearing ( ). lo_ins -> m_bukrs = i_bukrs . lo_ins -> m_koart = 'S' . lo_ins -> m_hkont = i_hkont . lo_ins -> m_budat = i_budat . lo_ins -> m_bktxt = i_bktxt . lo_ins -> get_bseg ( it_clearing_line ). lo_ins -> posting_interface ( ). result = lo_ins -> ms_result . ENDMETHOD . * <SIGNATURE>---------------------------------------------------------------------------------------+ * | Static Public Method ZCL_FI_CLEARING=>POST_VENDOR * +-------------------------------------------------------------------------------------------------+ * | [--->] I_BUKRS TYPE BUKRS * | [--->] I_LIFNR TYPE LIFNR(optional) * | [--->] I_AGUMS TYPE AGUMS (default ='A') * | [--->] I_BUDAT TYPE BUDAT (default =SY-DATUM) * | [--->] I_BKTXT TYPE BKTXT(optional) * | [--->] IT_CLEARING_LINE TYPE TT_CLEARING_LINE * | [--->] I_PROC TYPE CHAR01 (default ='M') * | [--->] IT_FTPOST TYPE FAGL_T_FTPOST(optional) * | [<-()] RESULT TYPE TY_RESULT * +--------------------------------------------------------------------------------------</SIGNATURE> METHOD POST_VENDOR . IF it_clearing_line IS INITIAL . result - mtype = 'E' . result - mtype = '\u6ca1\u6709\u672a\u6e05\u9879' . RETURN . ENDIF . CLEAR ms_extra . \" A-\u5148\u5904\u7406\u672a\u6e05\u9879\uff0c\u518d\u7531\u7cfb\u7edf\u5e26\u51fa\u5dee\u5f02\u884c\uff0c\u6700\u540e\u5bf9\u5dee\u5f02\u884c\u8fdb\u884c\u624b\u5de5\u8c03\u6574 \" M-\u5148\u624b\u5de5\u751f\u6210\u5e76\u8c03\u6574\u5dee\u5f02\u884c\uff0c\u518d\u5904\u7406\u672a\u6e05\u9879 ms_extra - diff_amount_proc = i_proc . ms_extra - ftpost = it_ftpost . \" \u9664\u4e86\u6211\u9884\u7559\u7684\u90a3\u4e9b\u5b57\u6bb5\uff0c\u6309\u9879\u76ee\u53ef\u80fd\u4f1a\u6709\u4e0d\u540c\u8bbe\u7f6e\uff0c\u53ef\u4ee5\u901a\u8fc7\u8be5\u9879\u8bbe\u7f6e DATA ( lo_ins ) = NEW zcl_fi_clearing ( ). lo_ins -> m_bukrs = i_bukrs . lo_ins -> m_koart = 'K' . lo_ins -> m_agums = i_agums . lo_ins -> m_hkont = i_lifnr . lo_ins -> m_budat = i_budat . lo_ins -> m_bktxt = i_bktxt . lo_ins -> get_bsik ( it_clearing_line ). lo_ins -> posting_interface ( ). result = lo_ins -> ms_result . ENDMETHOD . ENDCLASS . \u589e\u5f3a\u5904\u7406 \u00b6 \u901a\u8fc7\u589e\u5f3a\u6765\u8c03\u6574\u5dee\u5f02\u91d1\u989d\u7684\u5904\u7406\u987a\u5e8f\uff0c\u7ecf\u5206\u6790\uff0c\u5728\u51fd\u6570 POSTING_INTERFACE_CLEARING \u4e2d\u9009\u53d6\u4e86\u4e24\u4e2a\u4f4d\u7f6e\u6765\u5904\u7406\uff1a \u4e5f\u53ef\u4ee5\u5c06 POSTING_INTERFACE_CLEARING \u7684\u51fd\u6570\u7ec4\u62f7\u8d1d\u4e00\u4e2a\u51fa\u6765\u4fee\u6539\u3002\u51fd\u6570\u7ec4\u5185\u5bb9\u4e0d\u591a\u3002 \u5b50\u4f8b\u7a0b xftpost_loop \u540e\u52a0\u5165 ... *------- Buchungsdatentabelle (XFTPOST) abarbeiten im Loop ------------- PERFORM xftpost_loop . *{ INSERT S4DKXXXXXX 1 * \" \u7528\u4e8e\u5904\u7406\u5dee\u5f02\u51ed\u8bc1\u884c CALL METHOD zcl_fi_clearing => after_xftpost_loop CHANGING ft = ft[] . *} INSERT ... \u5b50\u4f8b\u7a0b fcode_f11 \u524d\u52a0\u5165 ... *------- Transaktion abschlie\u00dfen --------------------------------------- *{ INSERT S4DKXXXXXX 2 * \" \u7528\u4e8e\u5904\u7406\u5dee\u5f02\u51ed\u8bc1\u884c CALL METHOD zcl_fi_clearing => before_fcode_f11 CHANGING ft = ft[] . DESCRIBE TABLE ft LINES index . \" \u5fc5\u987b\uff0c\u540e\u7eed\u4ee3\u7801\u662f\u6839\u636eindex\u65b0\u589e\u4fdd\u5b58\u547d\u4ee4 *} INSERT PERFORM fcode_f11 . ... \u7528\u4f8b \u00b6 \u5ba2\u6237\u624b\u5de5\u6e05\u8d26 DATA lt_clearing_line TYPE lcl_clearing_account => tt_clearing_line . lt_clearing_line = VALUE # ( ( bukrs = '1000' belnr = '90000001' gjahr = '2022' buzei = '001' ) ( bukrs = '1000' belnr = '90000001' gjahr = '2022' buzei = '003' ) ). \" \u5ba2\u6237\u6e05\u8d26 DATA ( ls_result ) = zcl_fi_clearing => post_customer ( i_bukrs = '1000' i_kunnr = '1001' it_clearing_line = lt_clearing_line ). \u4f9b\u5e94\u5546\u624b\u5de5\u6e05\u8d26 DATA lt_clearing_line TYPE lcl_clearing_account => tt_clearing_line . lt_clearing_line = VALUE # ( ( bukrs = '1000' belnr = '90000002' gjahr = '2022' buzei = '002' ) ( bukrs = '1000' belnr = '90000002' gjahr = '2022' buzei = '004' ) ). \" \u4f9b\u5e94\u5546\u6e05\u8d26 DATA ( ls_result ) = zcl_fi_clearing => post_vendor ( i_bukrs = '1000' i_lifnr = '8000001' it_clearing_line = lt_clearing_line ). \u5148\u9009\u62e9\u672a\u6e05\u9879\uff0c\u518d\u5904\u7406\u5dee\u5f02\u884c DATA lt_clearing_line TYPE lcl_clearing_account => tt_clearing_line . lt_clearing_line = VALUE # ( ( bukrs = '1000' belnr = '90000001' gjahr = '2022' buzei = '001' ) ( bukrs = '1000' belnr = '90000001' gjahr = '2022' buzei = '003' ) ). DATA lt_ftpost TYPE lcl_clearing_account => tt_clearing_line . _ftpost lt_ftpost 'P' 1 'BSEG-ZUONR' '0000001001' . \" \u5206\u914d\u503c _ftpost lt_ftpost 'P' 1 'BSEG-HKONT' '2201000010' . \" \u603b\u8d26\u9ed8\u8ba4\u5ba2\u6237\u603b\u8d26\uff0c\u8c03\u6574\u4e3a\u53e6\u4e00\u4e2a _ftpost lt_ftpost 'P' 1 'BSEG-SGTXT' '\u884c\u6587\u672c' . \" \u5ba2\u6237\u6e05\u8d26 DATA ( ls_result ) = zcl_fi_clearing => post_customer ( i_bukrs = '1000' i_kunnr = '1001' it_clearing_line = lt_clearing_line i_porc = 'A' it_ftpost = lt_ftpost ).","title":"\u6e05\u8d26"},{"location":"fico/fi_clearing_account/#_1","text":"\u6e05\u8d26\u7684\u81ea\u5f00\u53d1\u4e3b\u8981\u4f7f\u7528\u4ee5\u4e0b\u6807\u51c6\u51fd\u6570\uff08\u5b9e\u9645\u4e5f\u662fBDC\uff09\u6765\u5904\u7406\uff1a POSTING_INTERFACE_START POSTING_INTERFACE_CLEARING POSTING_INTERFACE_END","title":"\u6e05\u8d26"},{"location":"fico/fi_clearing_account/#_2","text":"\u6e05\u8d26\u4e3b\u8981\u662f\u4e24\u4e2a\u95ee\u9898\uff1a \u662f\u5426\u5b58\u5728\u5dee\u5f02\u91d1\u989d \u5dee\u5f02\u91d1\u989d\u7684\u5904\u7406 \u5982\u679c\u4e0d\u5b58\u5728\u5dee\u5f02\u91d1\u989d\uff0c\u5219\u53ea\u9700\u8981\u5904\u7406\u672a\u6e05\u9879\u5373\u53ef\u3002\u5982\u679c\u5b58\u5728\u5dee\u5f02\u91d1\u989d\uff0c\u5219\u9700\u8981\u6839\u636e\u4e1a\u52a1\u987e\u95ee\u7684\u64cd\u4f5c\u6d41\u7a0b\uff0c\u8c03\u6574\u5dee\u5f02\u91d1\u989d\u5904\u7406\u4e0e\u672a\u6e05\u9879\u5904\u7406\u7684\u5148\u540e\u987a\u5e8f\u3002 \u6b63\u5e38\u6765\u8bf4\uff0c\u8d22\u52a1\u987e\u95ee\u90fd\u662f\u5148\u6311\u9009\u672a\u6e05\u9879\uff0c\u518d\u7531\u7cfb\u7edf\u81ea\u52a8\u751f\u6210\u5dee\u5f02\u884c\u3002\u4e0a\u9762\u7684\u6807\u51c6BDC\u51fd\u6570\u5374\u662f\u53cd\u8fc7\u6765\uff0c\u8fd9\u4f1a\u5bfc\u81f4\u4e00\u4e9b\u95ee\u9898\uff0c\u6bd4\u5982\u6e05\u8d26\u5b57\u6bb5AUGBL\u4e3a\u7a7a\uff0c\u65e0\u6cd5\u5173\u8054\u672a\u6e05\u9879\u3002 \u7cfb\u7edf\u81ea\u52a8\u751f\u6210\u7684\u5dee\u5f02\u884c\uff0c\u8fd8\u4f1a\u6309\u914d\u7f6e\u81ea\u52a8\u5e26\u51fa\u989d\u5916\u4fe1\u606f\uff0c\u5982\u679c\u4e1a\u52a1\u987e\u95ee\u5bf9\u8fd9\u4e9b\u5b57\u6bb5\u6709\u8981\u6c42\uff0c\u4e5f\u4f1a\u8ba9\u4eba\u5934\u79c3\u3002 \u6539\u5f97\u5410\u8840\uff0c\u6539\u51fa\u4e0b\u9762\u7684\u5de5\u5177\u7c7b\uff0cSAP\u4e0d\u63d0\u4f9b\u6807\u51c6\u51fd\u6570\u6765\u5904\u7406\u771f\u7684\u662f\u592a\u96be\u4e86\u3002","title":"\u5206\u6790\u8bf4\u660e"},{"location":"fico/fi_clearing_account/#_3","text":"\u8be5\u5de5\u5177\u5c06\u8c03\u7528\u6807\u51c6\u51fd\u6570\u7684\u4e00\u4e9b\u901a\u7528\u64cd\u4f5c\u5c01\u88c5\u8d77\u6765\uff0c\u4f7f\u7528\u7684\u65f6\u5019\uff0c\u53ea\u9700\u4f20\u5165\u672a\u6e05\u9879\u5373\u53ef\u3002 ZCL_FI_CLEARING class ZCL_FI_CLEARING definition public create private . public section . types : BEGIN OF ty_clearing_line , bukrs TYPE bseg - bukrs , belnr TYPE bseg - belnr , gjahr TYPE bseg - gjahr , buzei TYPE bseg - buzei , END OF ty_clearing_line . types : tt_clearing_line TYPE STANDARD TABLE OF ty_clearing_line WITH EMPTY KEY . types : BEGIN OF ty_result , mtype TYPE bapi_mtype , msg TYPE bapi_msg , belnr TYPE bseg - belnr , END OF ty_result . class-methods CLASS_CONSTRUCTOR . class-methods POST_CUSTOMER importing ! I_BUKRS type BUKRS ! I_KUNNR type KUNNR ! I_AGUMS type AGUMS default 'A' ! I_BUDAT type BUDAT default SY - DATUM ! I_BKTXT type BKTXT optional ! IT_CLEARING_LINE type TT_CLEARING_LINE ! I_PROC type CHAR01 default 'M' ! IT_FTPOST type FAGL_T_FTPOST optional returning value ( RESULT ) type TY_RESULT . class-methods POST_VENDOR importing ! I_BUKRS type BUKRS ! I_LIFNR type LIFNR optional ! I_AGUMS type AGUMS default 'A' ! I_BUDAT type BUDAT default SY - DATUM ! I_BKTXT type BKTXT optional ! IT_CLEARING_LINE type TT_CLEARING_LINE ! I_PROC type CHAR01 default 'M' ! IT_FTPOST type FAGL_T_FTPOST optional returning value ( RESULT ) type TY_RESULT . class-methods POST_LEDGER importing ! I_BUKRS type BUKRS ! I_HKONT type HKONT ! I_AGUMS type AGUMS optional ! I_BUDAT type BUDAT default SY - DATUM ! I_BKTXT type BKTXT optional ! IT_CLEARING_LINE type TT_CLEARING_LINE ! I_PROC type CHAR01 default 'M' ! IT_FTPOST type FAGL_T_FTPOST optional returning value ( RESULT ) type TY_RESULT . class-methods BEFORE_FCODE_F11 changing ! FT type BDCDATA_TAB . class-methods AFTER_XFTPOST_LOOP changing ! FT type BDCDATA_TAB . protected section . PRIVATE SECTION . CLASS-DATA ms_t041a TYPE t041a . CLASS-DATA : mt_tbsl TYPE STANDARD TABLE OF tbsl . CLASS-DATA : BEGIN OF ms_extra , diff_amount_proc TYPE CHAR01 , program TYPE bdcdata - program , dynpro TYPE bdcdata - dynpro , FTPOST TYPE STANDARD TABLE OF ftpost WITH EMPTY KEY , END OF ms_extra . DATA m_bukrs TYPE bukrs . DATA m_koart TYPE koart . DATA m_agums TYPE agums . DATA m_hkont TYPE hkont . DATA m_budat TYPE budat . DATA m_bktxt TYPE bktxt . DATA : mt_bseg TYPE STANDARD TABLE OF bseg . DATA ms_result TYPE ty_result . CLASS-METHODS determine_posting_key IMPORTING ! i_koart TYPE koart ! i_umsks TYPE umsks ! i_amount_diff TYPE p RETURNING VALUE ( r_bschl ) TYPE bschl . METHODS get_bsid IMPORTING ! it_clearing_line TYPE tt_clearing_line . METHODS get_bsik IMPORTING ! it_clearing_line TYPE tt_clearing_line . METHODS get_bseg IMPORTING ! it_clearing_line TYPE tt_clearing_line . METHODS posting_before . METHODS posting_interface . ENDCLASS . CLASS ZCL_FI_CLEARING IMPLEMENTATION . * <SIGNATURE>---------------------------------------------------------------------------------------+ * | Static Public Method ZCL_FI_CLEARING=>AFTER_XFTPOST_LOOP * +-------------------------------------------------------------------------------------------------+ * | [<-->] FT TYPE BDCDATA_TAB * +--------------------------------------------------------------------------------------</SIGNATURE> METHOD after_xftpost_loop . \" \u9ed8\u8ba4\u5904\u7406\uff0c\u5148\u5904\u7406\u5dee\u5f02\u884c\uff0c\uff08\u518d\u5230\u8be5\u589e\u5f3a\uff09\uff0c\u518d\u5904\u7406\u672a\u6e05\u9879 CHECK ms_extra - diff_amount_proc = 'M' OR ms_extra - diff_amount_proc = '' . DATA ls_bdcdata TYPE bdcdata . DEFINE _bdc_data . CLEAR ls_bdcdata . ls_bdcdata - fnam = &1 . ls_bdcdata - fval = &2 . INSERT ls_bdcdata INTO TABLE ft[] . END-OF-DEFINITION . \" \u6309\u9879\u76ee\u9700\u6c42\uff0c\u586b\u5199\u9700\u8981\u7684\u4fe1\u606f LOOP AT ms_extra - ftpost INTO DATA ( ls_ftpost ). _bdc_data ls_ftpost - fnam ls_ftpost - fval . ENDLOOP . ENDMETHOD . * <SIGNATURE>---------------------------------------------------------------------------------------+ * | Static Public Method ZCL_FI_CLEARING=>BEFORE_FCODE_F11 * +-------------------------------------------------------------------------------------------------+ * | [<-->] FT TYPE BDCDATA_TAB * +--------------------------------------------------------------------------------------</SIGNATURE> METHOD before_fcode_f11 . \" \u5148\u5904\u7406\u672a\u6e05\u9879\uff0c\u518d\u5904\u7406\u5dee\u5f02\u884c CHECK ms_extra - diff_amount_proc = 'A' . DATA ls_bdcdata TYPE bdcdata . DEFINE _bdc_begin . CLEAR ls_bdcdata . ls_bdcdata - program = &1 . ls_bdcdata - dynpro = &2 . ls_bdcdata - dynbegin = 'X' . INSERT ls_bdcdata INTO TABLE ft[] . END-OF-DEFINITION . DEFINE _bdc_data . CLEAR ls_bdcdata . ls_bdcdata - fnam = &1 . ls_bdcdata - fval = &2 . INSERT ls_bdcdata INTO TABLE ft[] . END-OF-DEFINITION . \" _bdc_begin 'SAPMF05A' '0733'. \" \u8be5\u589e\u5f3a\u4f4d\u7f6e\u662f\u5728\u4fdd\u5b58\u524d\uff0c\u539f\u672c\u7684BDC\u4ee3\u7801\u53ea\u7f3a\u5c11\u547d\u4ee4 _bdc_data 'BDC_OKCODE' 'PA' . \" \u5904\u7406\u672a\u6e05\u9879 \" MAIN - \u6807\u51c6 \" PART - \u90e8\u5206\u652f\u4ed8 \" REST - \u5269\u4f59\u9879\u76ee \" WITH - \u9884\u6263\u7a0e _bdc_begin 'SAPDF05X' '3100' . _bdc_data 'BDC_OKCODE' 'REST' . \" \u5269\u4f59\u8fc7\u8d26 _bdc_begin 'SAPDF05X' '3100' . _bdc_data 'BDC_OKCODE' 'PI' . \" PI - \u53cc\u51fb\u884c _bdc_begin 'SAPDF05X' '3100' . _bdc_data 'BDC_OKCODE' 'BS' . \" BS - \u6a21\u62df IF ( ms_extra - program IS INITIAL OR ms_extra - dynpro IS INITIAL ) \" \u6ca1\u6709\u4e0b\u4e00\u6b65\u7684\u5c4f\u5e55 OR ms_extra - ftpost IS INITIAL . \" \u6ca1\u6709\u7279\u6b8a\u5904\u7406 \" \u6ca1\u6709\u9700\u8981\u8865\u5145\u7684\uff0c\u76f4\u63a5\u4fdd\u5b58 _bdc_begin 'SAPMF05A' '0301' . \" \u8865\u5145\u4e00\u4e2a\u5c4f\u5e55 \" _bdc_data 'BDC_OKCODE' '/11'. \" \u540e\u7eed\u7684\u6807\u51c6\u4ee3\u7801\u6700\u540e\u4f1a\u624b\u5de5\u6dfb\u52a0\u4e00\u884c\u547d\u4ee4\u4fdd\u5b58 ELSE . * \" \u6b63\u5e38\u60c5\u51b5\uff0c\u7531\u4e8e\u884c\u9879\u76ee\u5fc5\u586b\uff0c\u4f1a\u8df3\u5230\u4e3b\u754c\u9762\u62a5\u9519 * _bdc_begin 'SAPMF05A' '0700'. * _bdc_data 'BDC_OKCODE' 'NK'. \" NK - \u8865\u5145\uff0c\u8df3\u8f6c\u5230\u9700\u8981\u8865\u5145\u6570\u636e\u7684\u754c\u9762 _bdc_begin 'SAPMF05A' '0700' . _bdc_data 'BDC_OKCODE' 'PI' . \" \u9009\u62e9\u51ed\u8bc1\u884c _bdc_begin 'SAPMF05A' '0610' . _bdc_data '*BSEG-BUZEI' '001' . \" \u9ed8\u8ba4\u9009\u7b2c\u4e00\u884c _bdc_data 'BDC_OKCODE' 'ENTR' . \" \u786e\u8ba4 \" \u6309\u9879\u76ee\u9700\u6c42\uff0c\u586b\u5199\u9700\u8981\u624b\u5de5\u5904\u7406\u7684\u4fe1\u606f _bdc_begin ms_extra - program ms_extra - dynpro . LOOP AT ms_extra - ftpost INTO DATA ( ls_ftpost ). _bdc_data ls_ftpost - fnam ls_ftpost - fval . ENDLOOP . ENDIF . ENDMETHOD . * <SIGNATURE>---------------------------------------------------------------------------------------+ * | Static Public Method ZCL_FI_CLEARING=>CLASS_CONSTRUCTOR * +-------------------------------------------------------------------------------------------------+ * +--------------------------------------------------------------------------------------</SIGNATURE> method CLASS_CONSTRUCTOR . \" AUGLV\u5bf9\u5e94FB05\u8981\u5904\u7406\u7684\u4e1a\u52a1 \" UMBUCHNG, Transfer posting with clearing, \u8f6c\u8d26\u5e76\u6e05\u8d26 SELECT SINGLE * FROM t041a WHERE auglv = 'UMBUCHNG' INTO @ ms_t041a . SELECT * FROM tbsl INTO TABLE @ mt_tbsl . endmethod . * <SIGNATURE>---------------------------------------------------------------------------------------+ * | Static Private Method ZCL_FI_CLEARING=>DETERMINE_POSTING_KEY * +-------------------------------------------------------------------------------------------------+ * | [--->] I_KOART TYPE KOART * | [--->] I_UMSKS TYPE UMSKS * | [--->] I_AMOUNT_DIFF TYPE P * | [<-()] R_BSCHL TYPE BSCHL * +--------------------------------------------------------------------------------------</SIGNATURE> method DETERMINE_POSTING_KEY . \" \u6839\u636e\u79d1\u76ee\u7c7b\u578b\uff0c\u7279\u6b8a\u603b\u8d26\u6807\u8bc6\uff0c\u5dee\u5f02\u91d1\u989d\uff0c\u67e5\u627e\u5bf9\u5e94\u8bb0\u8d26\u7801 CASE i_koart . WHEN 'D' . IF i_amount_diff < 0 . IF i_umsks = space . r_bschl = ms_t041a - rpdha . ELSE . r_bschl = ms_t041a - bsdhs . ENDIF . ELSE . IF i_umsks = space . r_bschl = ms_t041a - rpdso . ELSE . r_bschl = ms_t041a - bsdss . ENDIF . ENDIF . WHEN 'K' . IF i_amount_diff < 0 . IF i_umsks = space . r_bschl = ms_t041a - rpkha . ELSE . r_bschl = ms_t041a - bskhs . ENDIF . ELSE . IF i_umsks = space . r_bschl = ms_t041a - rpkso . ELSE . r_bschl = ms_t041a - bskss . ENDIF . ENDIF . WHEN 'S' . IF i_amount_diff < 0 . r_bschl = ms_t041a - bssha . ELSE . r_bschl = ms_t041a - bssso . ENDIF . ENDCASE . endmethod . * <SIGNATURE>---------------------------------------------------------------------------------------+ * | Instance Private Method ZCL_FI_CLEARING->GET_BSEG * +-------------------------------------------------------------------------------------------------+ * | [--->] IT_CLEARING_LINE TYPE TT_CLEARING_LINE * +--------------------------------------------------------------------------------------</SIGNATURE> method GET_BSEG . CHECK it_clearing_line IS NOT INITIAL . \" \u68c0\u67e5\u5e76\u83b7\u53d6\u53ef\u4ee5\u6e05\u8d26\u7684\u51ed\u8bc1\u6570\u636e SELECT bseg~bukrs , bseg~belnr , bseg~gjahr , bseg~buzei , bseg~umsks , \" \u7279\u6b8a\u603b\u8d26\u4e8b\u52a1 bseg~umskz , \" \u7279\u6b8a\u603b\u8d26\u6807\u8bc6 bseg~zfbdt , \" \u4ed8\u6b3e\u6e05\u7b97\u65e5\u671f bseg~shkzg , bseg~dmbtr , bseg~wrbtr , bkpf~waers FROM bseg JOIN bkpf ON bseg~bukrs = bkpf~bukrs AND bseg~belnr = bkpf~belnr AND bseg~gjahr = bkpf~gjahr FOR ALL ENTRIES IN @ it_clearing_line[] WHERE bseg~bukrs = @ it_clearing_line - bukrs AND bseg~belnr = @ it_clearing_line - belnr AND bseg~gjahr = @ it_clearing_line - gjahr AND bseg~buzei = @ it_clearing_line - buzei INTO CORRESPONDING FIELDS OF TABLE @ mt_bseg . endmethod . * <SIGNATURE>---------------------------------------------------------------------------------------+ * | Instance Private Method ZCL_FI_CLEARING->GET_BSID * +-------------------------------------------------------------------------------------------------+ * | [--->] IT_CLEARING_LINE TYPE TT_CLEARING_LINE * +--------------------------------------------------------------------------------------</SIGNATURE> method GET_BSID . CHECK it_clearing_line IS NOT INITIAL . \" \u68c0\u67e5\u5e76\u83b7\u53d6\u53ef\u4ee5\u6e05\u8d26\u7684\u51ed\u8bc1\u6570\u636e SELECT bukrs , belnr , gjahr , buzei , projk , \" \u5ba2\u6237WBS\u5fc5\u586b umsks , \" \u7279\u6b8a\u603b\u8d26\u4e8b\u52a1 umskz , \" \u7279\u6b8a\u603b\u8d26\u6807\u8bc6 zfbdt , \" \u4ed8\u6b3e\u6e05\u7b97\u65e5\u671f shkzg , dmbtr , wrbtr , waers FROM bsid FOR ALL ENTRIES IN @ it_clearing_line[] WHERE bukrs = @ it_clearing_line - bukrs AND belnr = @ it_clearing_line - belnr AND gjahr = @ it_clearing_line - gjahr AND buzei = @ it_clearing_line - buzei INTO CORRESPONDING FIELDS OF TABLE @ mt_bseg . endmethod . * <SIGNATURE>---------------------------------------------------------------------------------------+ * | Instance Private Method ZCL_FI_CLEARING->GET_BSIK * +-------------------------------------------------------------------------------------------------+ * | [--->] IT_CLEARING_LINE TYPE TT_CLEARING_LINE * +--------------------------------------------------------------------------------------</SIGNATURE> method GET_BSIK . CHECK it_clearing_line IS NOT INITIAL . \" \u68c0\u67e5\u5e76\u83b7\u53d6\u53ef\u4ee5\u6e05\u8d26\u7684\u51ed\u8bc1\u6570\u636e SELECT bukrs , belnr , gjahr , buzei , umsks , \" \u7279\u6b8a\u603b\u8d26\u4e8b\u52a1 umskz , \" \u7279\u6b8a\u603b\u8d26\u6807\u8bc6 zfbdt , \" \u4ed8\u6b3e\u6e05\u7b97\u65e5\u671f shkzg , dmbtr , wrbtr , waers FROM bsik FOR ALL ENTRIES IN @ it_clearing_line[] WHERE bukrs = @ it_clearing_line - bukrs AND belnr = @ it_clearing_line - belnr AND gjahr = @ it_clearing_line - gjahr AND buzei = @ it_clearing_line - buzei INTO CORRESPONDING FIELDS OF TABLE @ mt_bseg . endmethod . * <SIGNATURE>---------------------------------------------------------------------------------------+ * | Instance Private Method ZCL_FI_CLEARING->POSTING_BEFORE * +-------------------------------------------------------------------------------------------------+ * +--------------------------------------------------------------------------------------</SIGNATURE> method POSTING_BEFORE . IF m_bukrs IS INITIAL . ms_result - mtype = 'E' . ms_result - msg = '\u8bf7\u8f93\u5165\u516c\u53f8\u4ee3\u7801' . RETURN . ENDIF . IF m_hkont IS INITIAL . ms_result - mtype = 'E' . ms_result - msg = '\u8bf7\u8f93\u5165\u79d1\u76ee' . RETURN . ENDIF . IF m_koart = 'D' OR m_koart = 'K' OR m_koart = 'S' . ELSE . ms_result - mtype = 'E' . ms_result - msg = '\u76ee\u524d\u4ec5\u652f\u6301\u5ba2\u6237\u6e05\u8d26\u3001\u4f9b\u5e94\u5546\u6e05\u8d26\u3001\u603b\u8d26\u6e05\u8d26' . RETURN . ENDIF . IF mt_bseg IS INITIAL . ms_result - mtype = 'E' . ms_result - msg = '\u6ca1\u6709\u672a\u6e05\u51ed\u8bc1\u6570\u636e' . RETURN . ENDIF . endmethod . * <SIGNATURE>---------------------------------------------------------------------------------------+ * | Instance Private Method ZCL_FI_CLEARING->POSTING_INTERFACE * +-------------------------------------------------------------------------------------------------+ * +--------------------------------------------------------------------------------------</SIGNATURE> METHOD posting_interface . DATA : lt_ftclear TYPE STANDARD TABLE OF ftclear , lt_ftpost TYPE STANDARD TABLE OF ftpost , lt_blntab TYPE STANDARD TABLE OF blntab , lt_fttax TYPE STANDARD TABLE OF fttax . \" \u6e05\u8d26\u9879\u76ee\u9009\u62e9\u6761\u4ef6 \" \u9009\u62e9\u5b57\u6bb5\u586bBELNR\uff0c\u5e76\u4f20\u503c\u662f\u51ed\u8bc1+\u884c\u9879\u76ee\uff0c\u5c31\u80fd\u53d6\u5230\u5bf9\u5e94\u51ed\u8bc1\u884c \" \u56e0\u6b64\u65e0\u9700\u5176\u4ed6\u989d\u5916\u7684\u7b5b\u9009\u6761\u4ef6 \" \u5982\u679c\u4e0d\u80fd\u786e\u5b9a\uff0c\u6216\u8005\u5c31\u9700\u8981\u67d0\u4e00\u7c7b\u7684\u6570\u636e\uff0c\u53ef\u4ee5\u81ea\u5df1\u914c\u60c5\u8c03\u6574 DATA ls_ftclear TYPE ftclear . DEFINE _ftclear . CLEAR ls_ftclear . ls_ftclear - agbuk = m_bukrs . \" \u516c\u53f8 ls_ftclear - agkon = m_hkont . \" \u79d1\u76ee ls_ftclear - agkoa = m_koart . \" \u8d26\u6237\u7c7b\u578b ls_ftclear - xnops = abap_true . \" \u6807\u51c6\u672a\u6e05\u9879 ls_ftclear - agums = m_agums . \" \u7279\u522b\u603b\u8d26\u6807\u8bc6 ls_ftclear - selfd = &2 . ls_ftclear - selvon = &3 . INSERT ls_ftclear INTO TABLE &1 . END-OF-DEFINITION . \" \u624b\u5de5\u6e05\u8d26\u9879\u76ee\uff0c\u5bf9\u4e8e\u5b58\u5728\u5dee\u989d\u7684\u9879\u76ee\uff0c\u9700\u8981\u624b\u5de5\u586b\u5199\u6e05\u8d26\u91d1\u989d \" \u5c31\u662fBDC\u5f55\u5c4f\uff0c\u5982\u679c\u6709\u7f3a\u4ec0\u4e48\u5b57\u6bb5\uff0c\u53ef\u4ee5\u5230\u524d\u53f0F1\u83b7\u53d6\u5c4f\u5e55\u5b57\u6bb5\u540d DATA ls_ftpost TYPE ftpost . DEFINE _ftpost . IF &4 IS NOT INITIAL OR &4 <> '' . CLEAR ls_ftpost . ls_ftpost - stype = &2 . \" K\u62ac\u5934\uff0cP\u884c\u9879\u76ee ls_ftpost - count = &3 . \" \u62ac\u5934\u9ed8\u8ba41\uff0c\u884c\u9879\u76ee\u6d41\u6c34 ls_ftpost - fnam = &4 . \" \u5c4f\u5e55\u5b57\u6bb5 ls_ftpost - fval = &5 . \" \u5b57\u6bb5\u503c INSERT ls_ftpost INTO TABLE &1 . ENDIF . END-OF-DEFINITION . \" \u6570\u636e\u6821\u9a8c CLEAR ms_result . posting_before ( ). CHECK ms_result - mtype <> 'E' . \" \u672a\u6e05\u9879\u76ee LOOP AT mt_bseg REFERENCE INTO DATA ( lr_bseg ). DATA ( l_selfd ) = 'BELNR' . DATA ( l_selval ) = |{ lr_bseg -> belnr }{ lr_bseg -> gjahr }{ lr_bseg -> buzei }|. _ftclear lt_ftclear l_selfd l_selval . ENDLOOP . \" \u6c47\u603b\u91d1\u989d\uff0c\u83b7\u53d6\u6e05\u8d26\u5dee\u5f02\u91d1\u989d DATA l_amount_diff TYPE p LENGTH 16 DECIMALS 2 . \" \u5dee\u989d\uff0cP\u7c7b\u578b\u6700\u5927\u503c LOOP AT mt_bseg REFERENCE INTO lr_bseg . IF lr_bseg -> shkzg = 'S' . l_amount_diff = l_amount_diff + lr_bseg -> dmbtr . ELSE . l_amount_diff = l_amount_diff - lr_bseg -> dmbtr . ENDIF . ENDLOOP . \" \u83b7\u53d6\u5176\u4ed6\u8f85\u52a9\u53c2\u6570 DATA l_umsks TYPE umsks . \" \u7279\u6b8a\u603b\u8d26\u4e8b\u52a1 DATA l_umskz TYPE umskz . \" \u7279\u6b8a\u603b\u8d26\u6807\u8bc6 DATA lr_clearing_ref TYPE REF TO bseg . \" \u4efb\u53d6\u4e00\u884c\u672a\u6e05\u9879\u4f5c\u4e3a\u5dee\u5f02\u91d1\u989d\u7684\u53c2\u8003 LOOP AT mt_bseg REFERENCE INTO lr_bseg . \" \u53ea\u8981\u6709\u4e00\u884c\u662f\u7279\u6b8a\u603b\u8d26\u4e8b\u52a1\uff0c\u6e05\u8d26\u5c31\u4ee5\u7279\u6b8a\u603b\u8d26\u65b9\u5f0f\u8fdb\u884c IF l_umsks IS INITIAL . l_umsks = lr_bseg -> umsks . l_umskz = lr_bseg -> umskz . ENDIF . \" \u627e\u51fa\u91d1\u989d\u7edd\u5bf9\u503c\u6700\u5927\u7684\u884c\u4f5c\u4e3a\u53c2\u8003\u884c \" \uff08\u6211\u8fd9\u9879\u76ee\u8981\u6c42\u5982\u6b64\uff0c\u53ef\u81ea\u884c\u8c03\u6574\uff09 IF lr_clearing_ref IS NOT BOUND . lr_clearing_ref = lr_bseg . ELSEIF abs ( lr_bseg -> dmbtr ) > abs ( lr_clearing_ref -> dmbtr ). lr_clearing_ref = lr_bseg . ENDIF . ENDLOOP . DATA ( l_budat ) = |{ m_budat DATE = USER }|. \" BDC\u5f55\u5c4f\uff0c\u65e5\u671f\u8981\u586b\u5199\u7528\u6237\u683c\u5f0f SELECT SINGLE waers FROM t001 WHERE bukrs = @ m_bukrs INTO @ DATA ( l_waers ). \" \u516c\u53f8\u672c\u5e01 \" K-\u62ac\u5934 _ftpost lt_ftpost 'K' 1 'BKPF-BUKRS' m_bukrs . _ftpost lt_ftpost 'K' 1 'BKPF-BLART' 'AB' . \" \u6e05\u8d26\u53ea\u6709\u8fd9\u4e00\u79cd\u51ed\u8bc1\u7c7b\u578b _ftpost lt_ftpost 'K' 1 'BKPF-BLDAT' l_budat . _ftpost lt_ftpost 'K' 1 'BKPF-BUDAT' l_budat . _ftpost lt_ftpost 'K' 1 'BKPF-MONAT' m_budat + 4 ( 2 ). _ftpost lt_ftpost 'K' 1 'BKPF-WAERS' l_waers . IF m_bktxt IS NOT INITIAL . _ftpost lt_ftpost 'K' 1 'BKPF-BKTXT' m_bktxt . ENDIF . \" \u5224\u65ad\u662f\u5426\u5b58\u5728\u5dee\u5f02\u91d1\u989d IF l_amount_diff = 0 . CLEAR ms_extra . \" \u6ca1\u6709\u5dee\u5f02\u91d1\u989d\uff0c\u65e0\u9700\u4efb\u4f55\u589e\u5f3a\u5904\u7406 ELSE . \" \u5b58\u5728\u5dee\u5f02\u91d1\u989d \" \u6839\u636e\u79d1\u76ee\u3001\u603b\u8d26\u4e8b\u52a1\u3001\u4f59\u989d\uff0c\u67e5\u627e\u8bb0\u8d26\u7801 DATA l_bschl TYPE bschl . l_bschl = determine_posting_key ( i_koart = m_koart i_umsks = l_umsks i_amount_diff = l_amount_diff ). DATA l_sgtxt TYPE bseg - sgtxt . l_sgtxt = | \u6e05\u8d26 { lr_clearing_ref -> belnr }|. \" \u884c\u6587\u672c\uff0c\u8bb0\u5f55\u53c2\u8003\u7684\u51ed\u8bc1 \" \u5bf9\u5dee\u5f02\u91d1\u989d\u7684\u5904\u7406\u65b9\u6848\u9009\u62e9 CASE ms_extra - diff_amount_proc . WHEN 'A' . \" \u81ea\u52a8\u6e05\u8d26\uff0c\u5148\u5904\u7406\u672a\u6e05\u9879\uff0c\u518d\u5904\u7406\u5dee\u5f02\u91d1\u989d \" \u79fb\u9664\u624b\u5de5\u6e05\u8d26\u90e8\u5206 DELETE lt_ftpost WHERE stype = 'P' . \" \u9879\u76ee\u7279\u6b8a\u5904\u7406 IF l_umskz IS NOT INITIAL \" \u7279\u6b8a\u603b\u8d26 OR l_bschl + 1 ( 1 ) = '9' . \" \u51b2\u9500 DELETE ms_extra - ftpost WHERE fnam <> 'BSEG-SGTXT' . \" \u4ec5\u6587\u672c\u53ef\u8f93\u5165 ENDIF . \" \u590d\u5236LFIPIF00\u4e2d\u7684\u5b50\u4f8b\u7a0bdynpro_ermitteln DATA l_winfk TYPE t019w - winfk . CLEAR l_winfk . CASE m_koart . WHEN 'D' . l_winfk = 'ZKOD' . WHEN 'K' . l_winfk = 'ZKOK' . WHEN 'S' . l_winfk = 'ZKOS' . WHEN 'A' . l_winfk = 'ZKOA' . ENDCASE . \" \u67e5\u627e\u5dee\u5f02\u884c\u7684\u5c4f\u5e55\uff08\u4ecePOSTING_INTERFACE_CLEARING\u4e2d\u627e\u5230\u7684\u4ee3\u7801\uff09 CALL FUNCTION 'NEXT_DYNPRO_SEARCH' EXPORTING i_bschl = l_bschl i_bukrs = m_bukrs i_tcode = 'FB05' i_umskz = l_umskz i_winfk = l_winfk IMPORTING e_dynnra = ms_extra - dynpro e_mpool = ms_extra - program EXCEPTIONS OTHERS = 99 . IF sy - subrc <> 0 . CLEAR ms_extra . ENDIF . WHEN OTHERS . \" \u624b\u5de5\u6e05\u8d26\uff0c\u5148\u5904\u7406\u5dee\u5f02\u91d1\u989d DATA ( l_dmbtr ) = |{ abs ( l_amount_diff ) NUMBER = USER }|. \" BDC\u5916\u90e8\u683c\u5f0f\uff0c\u53e6\u5916\u6b63\u8d1f\u6309\u8bb0\u8d26\u7801\u533a\u5206\uff0c\u6240\u4ee5\u90fd\u4f20\u6b63\u503c DATA ( l_zfbdt ) = |{ lr_clearing_ref -> zfbdt DATE = USER }|. \" BDC\u5916\u90e8\u683c\u5f0f \" P-\u884c\u9879\u76ee \" \u6211\u8fd9\u9879\u76ee\u8981\u6c42\u6e05\u8d26\u540e\u751f\u6210\u65e0\u51ed\u8bc1\u884c\u6216\u4e00\u884c\u5dee\u989d\u7684\u6e05\u8d26\u51ed\u8bc1 \" \u6709\u751f\u6210\u591a\u884c\u8981\u6c42\u7684\u81ea\u5df1\u914c\u60c5\u4fee\u6539 _ftpost lt_ftpost 'P' 1 'RF05A-NEWBS' l_bschl . \" \u8fc7\u8d26\u7801 _ftpost lt_ftpost 'P' 1 'RF05A-NEWKO' m_hkont . \" \u79d1\u76ee _ftpost lt_ftpost 'P' 1 'RF05A-NEWUM' l_umskz . \" \u7279\u522b\u603b\u8d26\u6807\u8bc6 _ftpost lt_ftpost 'P' 1 'BSEG-WRBTR' l_dmbtr . \" \u6c47\u603b\u540e\u7684\u5dee\u989d _ftpost lt_ftpost 'P' 1 'BSEG-ZFBDT' l_zfbdt . \" \u4ed8\u6b3e\u6e05\u7b97\u65e5\u671f _ftpost lt_ftpost 'P' 1 'BSEG-SGTXT' l_sgtxt . \" \u884c\u9879\u76ee\u6587\u672c\u5fc5\u586b ENDCASE . ENDIF . \" IF l_amount_diff <> 0. SORT lt_ftpost BY stype count fnam fval . DELETE ADJACENT DUPLICATES FROM lt_ftpost COMPARING stype count fnam . DATA l_mode TYPE char01 VALUE 'N' . \" BDC\u5bfc\u5165\u6a21\u5f0f CALL FUNCTION 'POSTING_INTERFACE_START' EXPORTING i_client = sy - mandt i_function = 'C' i_mode = l_mode i_keep = 'X' i_update = 'S' i_user = sy - uname . IF sy - subrc <> 0 . ms_result - mtype = 'E' . MESSAGE ID sy - msgid TYPE sy - msgty NUMBER sy - msgno WITH sy - msgv1 sy - msgv2 sy - msgv3 sy - msgv4 INTO ms_result - msg . RETURN . ENDIF . CALL FUNCTION 'POSTING_INTERFACE_CLEARING' EXPORTING i_auglv = ms_t041a - auglv \" \u6e05\u8d26\u7a0b\u5e8f\u56fa\u5b9aUMBUCHNG i_tcode = 'FB05' \" \u56fa\u5b9a i_sgfunct = 'C' i_no_auth = 'X' \" \u4e0d\u8003\u8651\u6743\u9650 IMPORTING e_msgid = sy - msgid e_msgno = sy - msgno e_msgty = sy - msgty e_msgv1 = sy - msgv1 e_msgv2 = sy - msgv2 e_msgv3 = sy - msgv3 e_msgv4 = sy - msgv4 TABLES t_blntab = lt_blntab t_ftclear = lt_ftclear t_ftpost = lt_ftpost t_fttax = lt_fttax EXCEPTIONS clearing_procedure_invalid = 1 clearing_procedure_missing = 2 table_t041a_empty = 3 transaction_code_invalid = 4 amount_format_error = 5 too_many_line_items = 6 company_code_invalid = 7 screen_not_found = 8 no_authorization = 9 OTHERS = 10 . IF sy - subrc <> 0 . ms_result - mtype = 'E' . ENDIF . MESSAGE ID sy - msgid TYPE sy - msgty NUMBER sy - msgno WITH sy - msgv1 sy - msgv2 sy - msgv3 sy - msgv4 INTO ms_result - msg . CALL FUNCTION 'POSTING_INTERFACE_END' EXCEPTIONS session_not_processable = 1 OTHERS = 2 . IF sy - subrc <> 0 . ms_result - mtype = 'E' . MESSAGE ID sy - msgid TYPE sy - msgty NUMBER sy - msgno WITH sy - msgv1 sy - msgv2 sy - msgv3 sy - msgv4 INTO ms_result - msg . RETURN . ENDIF . READ TABLE lt_blntab INTO DATA ( ls_blntab ) INDEX 1 . IF sy - subrc = 0 . ms_result - mtype = 'S' . ms_result - msg = '\u6e05\u8d26\u5df2\u5904\u7406' . ms_result - belnr = ls_blntab - belnr . ELSE . ms_result - mtype = 'E' . IF ms_result - msg IS INITIAL . ms_result - msg = '\u6e05\u8d26\u5904\u7406\u5931\u8d25' . ENDIF . ENDIF . ENDMETHOD . * <SIGNATURE>---------------------------------------------------------------------------------------+ * | Static Public Method ZCL_FI_CLEARING=>POST_CUSTOMER * +-------------------------------------------------------------------------------------------------+ * | [--->] I_BUKRS TYPE BUKRS * | [--->] I_KUNNR TYPE KUNNR * | [--->] I_AGUMS TYPE AGUMS (default ='A') * | [--->] I_BUDAT TYPE BUDAT (default =SY-DATUM) * | [--->] I_BKTXT TYPE BKTXT(optional) * | [--->] IT_CLEARING_LINE TYPE TT_CLEARING_LINE * | [--->] I_PROC TYPE CHAR01 (default ='M') * | [--->] IT_FTPOST TYPE FAGL_T_FTPOST(optional) * | [<-()] RESULT TYPE TY_RESULT * +--------------------------------------------------------------------------------------</SIGNATURE> METHOD post_customer . IF it_clearing_line IS INITIAL . result - mtype = 'E' . result - mtype = '\u6ca1\u6709\u672a\u6e05\u9879' . RETURN . ENDIF . CLEAR ms_extra . \" A-\u5148\u5904\u7406\u672a\u6e05\u9879\uff0c\u518d\u7531\u7cfb\u7edf\u5e26\u51fa\u5dee\u5f02\u884c\uff0c\u6700\u540e\u5bf9\u5dee\u5f02\u884c\u8fdb\u884c\u624b\u5de5\u8c03\u6574 \" M-\u5148\u624b\u5de5\u751f\u6210\u5e76\u8c03\u6574\u5dee\u5f02\u884c\uff0c\u518d\u5904\u7406\u672a\u6e05\u9879 ms_extra - diff_amount_proc = i_proc . ms_extra - ftpost = it_ftpost . \" \u9664\u4e86\u6211\u9884\u7559\u7684\u90a3\u4e9b\u5b57\u6bb5\uff0c\u6309\u9879\u76ee\u53ef\u80fd\u4f1a\u6709\u4e0d\u540c\u8bbe\u7f6e\uff0c\u53ef\u4ee5\u901a\u8fc7\u8be5\u9879\u8bbe\u7f6e DATA ( lo_ins ) = NEW zcl_fi_clearing ( ). lo_ins -> m_bukrs = i_bukrs . lo_ins -> m_koart = 'D' . lo_ins -> m_agums = i_agums . lo_ins -> m_hkont = i_kunnr . lo_ins -> m_budat = i_budat . lo_ins -> m_bktxt = i_bktxt . lo_ins -> get_bsid ( it_clearing_line ). lo_ins -> posting_interface ( ). result = lo_ins -> ms_result . ENDMETHOD . * <SIGNATURE>---------------------------------------------------------------------------------------+ * | Static Public Method ZCL_FI_CLEARING=>POST_LEDGER * +-------------------------------------------------------------------------------------------------+ * | [--->] I_BUKRS TYPE BUKRS * | [--->] I_HKONT TYPE HKONT * | [--->] I_AGUMS TYPE AGUMS(optional) * | [--->] I_BUDAT TYPE BUDAT (default =SY-DATUM) * | [--->] I_BKTXT TYPE BKTXT(optional) * | [--->] IT_CLEARING_LINE TYPE TT_CLEARING_LINE * | [--->] I_PROC TYPE CHAR01 (default ='M') * | [--->] IT_FTPOST TYPE FAGL_T_FTPOST(optional) * | [<-()] RESULT TYPE TY_RESULT * +--------------------------------------------------------------------------------------</SIGNATURE> METHOD POST_LEDGER . IF it_clearing_line IS INITIAL . result - mtype = 'E' . result - mtype = '\u6ca1\u6709\u672a\u6e05\u9879' . RETURN . ENDIF . CLEAR ms_extra . \" A-\u5148\u5904\u7406\u672a\u6e05\u9879\uff0c\u518d\u7531\u7cfb\u7edf\u5e26\u51fa\u5dee\u5f02\u884c\uff0c\u6700\u540e\u5bf9\u5dee\u5f02\u884c\u8fdb\u884c\u624b\u5de5\u8c03\u6574 \" M-\u5148\u624b\u5de5\u751f\u6210\u5e76\u8c03\u6574\u5dee\u5f02\u884c\uff0c\u518d\u5904\u7406\u672a\u6e05\u9879 ms_extra - diff_amount_proc = i_proc . ms_extra - ftpost = it_ftpost . \" \u9664\u4e86\u6211\u9884\u7559\u7684\u90a3\u4e9b\u5b57\u6bb5\uff0c\u6309\u9879\u76ee\u53ef\u80fd\u4f1a\u6709\u4e0d\u540c\u8bbe\u7f6e\uff0c\u53ef\u4ee5\u901a\u8fc7\u8be5\u9879\u8bbe\u7f6e DATA ( lo_ins ) = NEW zcl_fi_clearing ( ). lo_ins -> m_bukrs = i_bukrs . lo_ins -> m_koart = 'S' . lo_ins -> m_hkont = i_hkont . lo_ins -> m_budat = i_budat . lo_ins -> m_bktxt = i_bktxt . lo_ins -> get_bseg ( it_clearing_line ). lo_ins -> posting_interface ( ). result = lo_ins -> ms_result . ENDMETHOD . * <SIGNATURE>---------------------------------------------------------------------------------------+ * | Static Public Method ZCL_FI_CLEARING=>POST_VENDOR * +-------------------------------------------------------------------------------------------------+ * | [--->] I_BUKRS TYPE BUKRS * | [--->] I_LIFNR TYPE LIFNR(optional) * | [--->] I_AGUMS TYPE AGUMS (default ='A') * | [--->] I_BUDAT TYPE BUDAT (default =SY-DATUM) * | [--->] I_BKTXT TYPE BKTXT(optional) * | [--->] IT_CLEARING_LINE TYPE TT_CLEARING_LINE * | [--->] I_PROC TYPE CHAR01 (default ='M') * | [--->] IT_FTPOST TYPE FAGL_T_FTPOST(optional) * | [<-()] RESULT TYPE TY_RESULT * +--------------------------------------------------------------------------------------</SIGNATURE> METHOD POST_VENDOR . IF it_clearing_line IS INITIAL . result - mtype = 'E' . result - mtype = '\u6ca1\u6709\u672a\u6e05\u9879' . RETURN . ENDIF . CLEAR ms_extra . \" A-\u5148\u5904\u7406\u672a\u6e05\u9879\uff0c\u518d\u7531\u7cfb\u7edf\u5e26\u51fa\u5dee\u5f02\u884c\uff0c\u6700\u540e\u5bf9\u5dee\u5f02\u884c\u8fdb\u884c\u624b\u5de5\u8c03\u6574 \" M-\u5148\u624b\u5de5\u751f\u6210\u5e76\u8c03\u6574\u5dee\u5f02\u884c\uff0c\u518d\u5904\u7406\u672a\u6e05\u9879 ms_extra - diff_amount_proc = i_proc . ms_extra - ftpost = it_ftpost . \" \u9664\u4e86\u6211\u9884\u7559\u7684\u90a3\u4e9b\u5b57\u6bb5\uff0c\u6309\u9879\u76ee\u53ef\u80fd\u4f1a\u6709\u4e0d\u540c\u8bbe\u7f6e\uff0c\u53ef\u4ee5\u901a\u8fc7\u8be5\u9879\u8bbe\u7f6e DATA ( lo_ins ) = NEW zcl_fi_clearing ( ). lo_ins -> m_bukrs = i_bukrs . lo_ins -> m_koart = 'K' . lo_ins -> m_agums = i_agums . lo_ins -> m_hkont = i_lifnr . lo_ins -> m_budat = i_budat . lo_ins -> m_bktxt = i_bktxt . lo_ins -> get_bsik ( it_clearing_line ). lo_ins -> posting_interface ( ). result = lo_ins -> ms_result . ENDMETHOD . ENDCLASS .","title":"\u6e05\u8d26\u5de5\u5177"},{"location":"fico/fi_clearing_account/#_4","text":"\u901a\u8fc7\u589e\u5f3a\u6765\u8c03\u6574\u5dee\u5f02\u91d1\u989d\u7684\u5904\u7406\u987a\u5e8f\uff0c\u7ecf\u5206\u6790\uff0c\u5728\u51fd\u6570 POSTING_INTERFACE_CLEARING \u4e2d\u9009\u53d6\u4e86\u4e24\u4e2a\u4f4d\u7f6e\u6765\u5904\u7406\uff1a \u4e5f\u53ef\u4ee5\u5c06 POSTING_INTERFACE_CLEARING \u7684\u51fd\u6570\u7ec4\u62f7\u8d1d\u4e00\u4e2a\u51fa\u6765\u4fee\u6539\u3002\u51fd\u6570\u7ec4\u5185\u5bb9\u4e0d\u591a\u3002 \u5b50\u4f8b\u7a0b xftpost_loop \u540e\u52a0\u5165 ... *------- Buchungsdatentabelle (XFTPOST) abarbeiten im Loop ------------- PERFORM xftpost_loop . *{ INSERT S4DKXXXXXX 1 * \" \u7528\u4e8e\u5904\u7406\u5dee\u5f02\u51ed\u8bc1\u884c CALL METHOD zcl_fi_clearing => after_xftpost_loop CHANGING ft = ft[] . *} INSERT ... \u5b50\u4f8b\u7a0b fcode_f11 \u524d\u52a0\u5165 ... *------- Transaktion abschlie\u00dfen --------------------------------------- *{ INSERT S4DKXXXXXX 2 * \" \u7528\u4e8e\u5904\u7406\u5dee\u5f02\u51ed\u8bc1\u884c CALL METHOD zcl_fi_clearing => before_fcode_f11 CHANGING ft = ft[] . DESCRIBE TABLE ft LINES index . \" \u5fc5\u987b\uff0c\u540e\u7eed\u4ee3\u7801\u662f\u6839\u636eindex\u65b0\u589e\u4fdd\u5b58\u547d\u4ee4 *} INSERT PERFORM fcode_f11 . ...","title":"\u589e\u5f3a\u5904\u7406"},{"location":"fico/fi_clearing_account/#_5","text":"\u5ba2\u6237\u624b\u5de5\u6e05\u8d26 DATA lt_clearing_line TYPE lcl_clearing_account => tt_clearing_line . lt_clearing_line = VALUE # ( ( bukrs = '1000' belnr = '90000001' gjahr = '2022' buzei = '001' ) ( bukrs = '1000' belnr = '90000001' gjahr = '2022' buzei = '003' ) ). \" \u5ba2\u6237\u6e05\u8d26 DATA ( ls_result ) = zcl_fi_clearing => post_customer ( i_bukrs = '1000' i_kunnr = '1001' it_clearing_line = lt_clearing_line ). \u4f9b\u5e94\u5546\u624b\u5de5\u6e05\u8d26 DATA lt_clearing_line TYPE lcl_clearing_account => tt_clearing_line . lt_clearing_line = VALUE # ( ( bukrs = '1000' belnr = '90000002' gjahr = '2022' buzei = '002' ) ( bukrs = '1000' belnr = '90000002' gjahr = '2022' buzei = '004' ) ). \" \u4f9b\u5e94\u5546\u6e05\u8d26 DATA ( ls_result ) = zcl_fi_clearing => post_vendor ( i_bukrs = '1000' i_lifnr = '8000001' it_clearing_line = lt_clearing_line ). \u5148\u9009\u62e9\u672a\u6e05\u9879\uff0c\u518d\u5904\u7406\u5dee\u5f02\u884c DATA lt_clearing_line TYPE lcl_clearing_account => tt_clearing_line . lt_clearing_line = VALUE # ( ( bukrs = '1000' belnr = '90000001' gjahr = '2022' buzei = '001' ) ( bukrs = '1000' belnr = '90000001' gjahr = '2022' buzei = '003' ) ). DATA lt_ftpost TYPE lcl_clearing_account => tt_clearing_line . _ftpost lt_ftpost 'P' 1 'BSEG-ZUONR' '0000001001' . \" \u5206\u914d\u503c _ftpost lt_ftpost 'P' 1 'BSEG-HKONT' '2201000010' . \" \u603b\u8d26\u9ed8\u8ba4\u5ba2\u6237\u603b\u8d26\uff0c\u8c03\u6574\u4e3a\u53e6\u4e00\u4e2a _ftpost lt_ftpost 'P' 1 'BSEG-SGTXT' '\u884c\u6587\u672c' . \" \u5ba2\u6237\u6e05\u8d26 DATA ( ls_result ) = zcl_fi_clearing => post_customer ( i_bukrs = '1000' i_kunnr = '1001' it_clearing_line = lt_clearing_line i_porc = 'A' it_ftpost = lt_ftpost ).","title":"\u7528\u4f8b"},{"location":"fico/fi_report/","text":"\u901a\u7528\u53d6\u503c\u6a21\u5757 \u00b6 \u8d22\u52a1\u4e09\u5927\u62a5\u8868\u53d6\u503c\u90e8\u5206\u53ef\u4ee5\u901a\u7528\uff0c\u56e0\u6b64\u4e0b\u9762\u53ea\u5bf9\u53d6\u503c\u90e8\u5206\u8fdb\u884c\u5c01\u88c5\uff0c\u901a\u8fc7\u4f20\u5165\u914d\u7f6e\uff0c\u53ef\u4ee5\u83b7\u53d6\u5404\u9879\u76ee\u7684\u5e74\u521d\u3001\u5e74\u672b\u3001\u5404\u671f\u95f4\u91d1\u989d\u3002 \u5165\u53c2\u7ed3\u6784 \u00b6 \u5b57\u6bb5 \u8bf4\u660e BUKRS \u516c\u53f8\u4ee3\u7801 ZITEM \u9879\u76ee ZITEM_SUB \u5b50\u9879\u76ee ZTEXT \u9879\u76ee\u63cf\u8ff0 REVERSE \u53cd\u5411\u6807\u8bc6\uff0c\u8ba1\u7b97\u6216\u6c47\u603b\u65f6\u4f7f\u7528 T_ACCAT_OPT \u79d1\u76eeRange\u8868 T_FILTER \u9664\u79d1\u76ee\u5916\u7684\u5176\u4ed6Range\u8868\uff0c\u6309\u5b57\u6bb5\u540d\u52a8\u6001\u8fc7\u6ee4 T_COLLECT ZITEM\u9879\u76ee\u5b50\u8868\uff0c\u6c47\u603b\u5176\u4ed6\u9879\u76ee\u7ed3\u679c \u793a\u4f8b\u5165\u53c2 \u00b6 \u5047\u5982\u73b0\u5728\u9700\u8981: \u9879\u76ee[\u8d44\u4ea7\u603b\u503c]\uff0cZITEM=1\uff0c\u6c47\u603b: \u79d1\u76ee1100* \u529f\u80fd\u8303\u56f4100\u3001200 ZITEM=2\u30013 \u79d1\u76ee2*\u4e14\u5229\u6da6\u4e2d\u5fc321* \u9879\u76ee[\u6d41\u52a8\u8d44\u4ea7]\uff0cZITEM=2\uff0c\u6c47\u603b\u79d1\u76ee3*\u30014*\u30015* \u9879\u76ee[\u975e\u6d41\u52a8\u8d44\u4ea7]\uff0cZITEM=3\uff0c\u6c47\u603b\u79d1\u76ee6*\u30017*\u30018* \u53ef\u4ee5\u5f97\u51fa\u5165\u53c2\uff1a BUKRS ZITEM ZITEM_SUB ZTEXT REVERSE T_ACCAT_OPT T_FILTER T_COLLECT 1000 1 1 \u8d44\u4ea7\u603b\u503c 1000 1 2 \u79d1\u76ee\u9879 1100* 1000 1 3 \u8fc7\u6ee4\u9879 \u529f\u80fd\u8303\u56f4=100/200 1000 1 4 \u5176\u4ed6\u9879 ZITEM=\u2154 1000 1 5 \u7ed3\u5408\u4f7f\u7528 2* \u5229\u6da6\u4e2d\u5fc3=21* 1000 2 1 \u6d41\u52a8\u8d44\u4ea7 1000 2 2 3* 1000 2 3 4* 1000 2 4 5* 1000 3 1 \u975e\u6d41\u52a8\u8d44\u4ea7 1000 3 2 6* 1000 3 3 7* 1000 3 4 8* \u51fa\u53c2\u7ed3\u6784 \u00b6 \u51fa\u53c2\u7ed3\u6784\u5305\u62ec\u4e86\u5e74\u521d\u3001\u5e74\u672b\u3001\u672c\u6708\u3001\u622a\u6b62\u672c\u6708\u7d2f\u8ba1\u3001\u5176\u4ed6\u5404\u6708\u6570\u636e\uff0c\u6309\u9700\u4f7f\u7528\u5373\u53ef\uff1a \u5b57\u6bb5 \u8bf4\u660e BUKRS \u516c\u53f8\u4ee3\u7801 YEAR \u5e74\u5ea6 PERIOD \u671f\u95f4 ZITEM \u9879\u76ee ZTEXT \u9879\u76ee\u63cf\u8ff0 YEAR_BEGIN \u5e74\u521d\u4f59\u989d TEAR_END \u5e74\u672b\u4f59\u989d PERIOD_CURRENT \u672c\u6708\u91d1\u989d PERIOD_TOTAL \u622a\u6b62\u672c\u6708\u7d2f\u8ba1\u91d1\u989d PERIOD_01 01\u6708\u4f59\u989d PERIOD_02 02\u6708\u4f59\u989d PERIOD_03 03\u6708\u4f59\u989d PERIOD_04 04\u6708\u4f59\u989d PERIOD_05 05\u6708\u4f59\u989d PERIOD_06 06\u6708\u4f59\u989d PERIOD_07 07\u6708\u4f59\u989d PERIOD_08 08\u6708\u4f59\u989d PERIOD_09 09\u6708\u4f59\u989d PERIOD_10 10\u6708\u4f59\u989d PERIOD_11 11\u6708\u4f59\u989d PERIOD_12 12\u6708\u4f59\u989d PERIOD_13 13\u6708\u4f59\u989d PERIOD_14 14\u6708\u4f59\u989d PERIOD_15 15\u6708\u4f59\u989d PERIOD_16 16\u6708\u4f59\u989d \u6587\u4ef6\u5bfc\u51fa \u00b6 \u4e09\u5927\u62a5\u8868\u683c\u5f0f\u56fa\u5b9a\uff0c\u56e0\u6b64\u53ef\u4ee5\u901a\u8fc7\u6587\u672c\u66ff\u6362\u7684\u65b9\u5f0f\uff0c\u5c06\u6a21\u677f\u4e2d\u7684\u5360\u4f4d\u7b26\u66ff\u6362\u4e3a\u5176\u4ed6\u503c\u3002 XLSX\u683c\u5f0f\u5bfc\u51fa \u00b6 XLSX\u683c\u5f0f\uff0c\u6216\u8005\u8bf4Openxml\u683c\u5f0f\uff0c\u4f1a\u5c06\u6587\u672c\u5168\u90e8\u5b58\u5165\u5230Sharedstrings.xml\u6587\u4ef6\u4e2d\uff0c\u56e0\u6b64\u901a\u8fc7\u66ff\u6362Sharedstrings\u4e2d\u7684\u6587\u672c\u5185\u5bb9\uff0c\u5373\u53ef\u5b9e\u73b0\u6587\u672c\u66ff\u6362\u3002 Openxml\u66ff\u6362Sharedstrings\u5185\u5bb9 *&---------------------------------------------------------------------* *& \u66ff\u6362\u6a21\u677f\u6587\u4ef6\u4e2d\u7684\u6587\u672c\u5185\u5bb9 *&---------------------------------------------------------------------* METHOD replace_texts . \" \u7a0b\u5e8f\u8981\u6c42IT_REPLACE\u81f3\u5c11\u4e24\u5217\uff0c\u4ee3\u7801\u4f1a\u5c06\u5de6\u5217\u5185\u5bb9\u66ff\u6362\u4e3a\u53f3\u5217\u5185\u5bb9 CHECK it_replace IS NOT INITIAL . \" \u6a21\u677f\u6587\u4ef6\u4e0d\u80fd\u4e3a\u7a7a CHECK c_doc IS NOT INITIAL . FIELD-SYMBOLS <fs_replace_t> TYPE ANY TABLE . FIELD-SYMBOLS <fs_replace> TYPE any . FIELD-SYMBOLS <fs_from> TYPE any . FIELD-SYMBOLS <fs_to> TYPE any . TRY . DATA ( lo_doc ) = cl_xlsx_document => load_document ( c_doc ). DATA ( lo_workbook_part ) = lo_doc -> get_workbookpart ( ). DATA ( lo_sharedstrings_part ) = lo_workbook_part -> get_sharedstringspart ( ). DATA ( l_sharedstrings_xml ) = lo_sharedstrings_part -> get_data ( ). DATA ( l_sharedstrings_str ) = cl_openxml_helper => xstring_to_string ( l_sharedstrings_xml ). ASSIGN it_replace TO <fs_replace_t> . LOOP AT <fs_replace_t> ASSIGNING <fs_replace> . ASSIGN COMPONENT 1 OF STRUCTURE <fs_replace> TO <fs_from> . ASSIGN COMPONENT 2 OF STRUCTURE <fs_replace> TO <fs_to> . IF <fs_from> IS ASSIGNED AND <fs_to> IS ASSIGNED . IF <fs_from> IS NOT INITIAL . REPLACE ALL OCCURRENCES OF <fs_from> IN l_sharedstrings_str WITH <fs_to> IN CHARACTER MODE . ENDIF . ENDIF . UNASSIGN <fs_from> . UNASSIGN <fs_to> . ENDLOOP . l_sharedstrings_xml = cl_openxml_helper => string_to_xstring ( l_sharedstrings_str ). lo_sharedstrings_part -> feed_data ( l_sharedstrings_xml ). c_doc = lo_doc -> get_package_data ( ). CATCH cx_openxml_not_found cx_openxml_format cx_openxml_not_allowed INTO DATA ( lx_openxml ). MESSAGE lx_openxml -> get_text ( ) TYPE 'S' DISPLAY LIKE 'E' . CATCH cx_root INTO DATA ( lx_root ). MESSAGE lx_root -> get_text ( ) TYPE 'S' DISPLAY LIKE 'E' . ENDTRY . ENDMETHOD . XLS\u683c\u5f0f\u5bfc\u51fa \u00b6 \u5982\u679c\u6a21\u677f\u662fXLS\u683c\u5f0f\uff0c\u4f7f\u7528OLE\u8fdb\u884c\u66ff\u6362\uff1a OLE\u66ff\u6362\u6587\u672c\u5185\u5bb9 TYPE-POOLS ole2 . DATA : l_app TYPE ole2_object , l_workbooks TYPE ole2_object , l_cells TYPE ole2_object . CREATE OBJECT l_app 'EXCEL.APPLICATION' . SET PROPERTY OF l_app 'DisplayAlerts' = 0 . CALL METHOD OF l_app 'Workbooks' = l_workbooks . CALL METHOD OF l_workbooks 'Open' EXPORTING # 1 = filename . GET PROPERTY OF l_app 'Cells' = l_cells . FIELD-SYMBOLS : <fs_replace> TYPE any , <fs_from> TYPE any , <fs_to> TYPE any . LOOP AT it_replace ASSIGNING <fs_replace> . ASSIGN COMPONENT 1 OF STRUCTURE <fs_replace> TO <fs_from> . ASSIGN COMPONENT 2 OF STRUCTURE <fs_replace> TO <fs_to> . CALL METHOD OF l_cells 'Replace' EXPORTING # 1 = <fs_from> # 2 = <fs_to> . ENDLOOP . SET PROPERTY OF l_app 'Visible' = 1 . Include\u6587\u4ef6 \u00b6 \u793a\u4f8b\u4ee3\u7801 *&---------------------------------------------------------------------* *& Include zfi_report *&---------------------------------------------------------------------* *&---------------------------------------------------------------------* *& \u4e09\u5927\u62a5\u8868\u53d6\u503c\u90e8\u5206\u53ef\u4ee5\u901a\u7528\uff0c\u56e0\u6b64\u62bd\u53d6\u51fa\u6765\u5f62\u6210\u4e00\u4e2a\u6a21\u5757 *&---------------------------------------------------------------------* \" \u8d22\u52a1\u660e\u7ec6\u6570\u636e\u952e\u503c TYPES : BEGIN OF ty_detail_key , rldnr TYPE acdoca - rldnr , rbukrs TYPE acdoca - rbukrs , gjahr TYPE acdoca - gjahr , belnr TYPE acdoca - belnr , docln TYPE acdoca - docln , END OF ty_detail_key . TYPES tt_detail_key TYPE STANDARD TABLE OF ty_detail_key WITH EMPTY KEY . \" \u8d22\u52a1\u660e\u7ec6\u6570\u636e TYPES : BEGIN OF ty_detail , rldnr TYPE acdoca - rldnr , rbukrs TYPE acdoca - rbukrs , gjahr TYPE acdoca - gjahr , belnr TYPE acdoca - belnr , docln TYPE acdoca - docln , ryear TYPE acdoca - ryear , \" \u8d22\u5e74 poper TYPE acdoca - poper , \" \u671f\u95f4 racct TYPE acdoca - racct , \" \u4f1a\u8ba1\u79d1\u76ee rcntr TYPE acdoca - rcntr , \" \u6210\u672c\u4e2d\u5fc3 prctr TYPE acdoca - prctr , \" \u5229\u6da6\u4e2d\u5fc3 rstgr TYPE acdoca - rstgr , \" RSTGR rfarea TYPE acdoca - rfarea , \" \u529f\u80fd\u8303\u56f4 rbusa TYPE acdoca - rbusa , \" \u4e1a\u52a1\u8303\u56f4 budat TYPE acdoca - budat , \" \u8fc7\u8d26\u65e5\u671f shkzg TYPE shkzg , \" \u501f\u8d37 hsl TYPE acdoca - hsl , END OF ty_detail . TYPES tt_detail TYPE STANDARD TABLE OF ty_detail WITH EMPTY KEY . \" \u62a5\u8868\u6570\u636e TYPES ty_amount TYPE p LENGTH 16 DECIMALS 2 . \" \u91d1\u989d TYPES : BEGIN OF ty_fi_data , bukrs TYPE bukrs , \" \u516c\u53f8 year TYPE gjahr , \" \u5e74\u5ea6 period TYPE monat , \" \u671f\u95f4 zitem TYPE string , \" \u9879\u76ee ztext TYPE string , \" \u9879\u76ee\u63cf\u8ff0 year_begin TYPE ty_amount , \" \u5e74\u521d\u4f59\u989d year_end TYPE ty_amount , \" \u5e74\u672b\u4f59\u989d period_current TYPE ty_amount , \" \u672c\u6708\u91d1\u989d period_total TYPE ty_amount , \" \u622a\u6b62\u672c\u6708\u7d2f\u8ba1\u91d1\u989d period_01 TYPE ty_amount , \" 01\u6708\u4f59\u989d period_02 TYPE ty_amount , \" 02\u6708\u4f59\u989d period_03 TYPE ty_amount , \" 03\u6708\u4f59\u989d period_04 TYPE ty_amount , \" 04\u6708\u4f59\u989d period_05 TYPE ty_amount , \" 05\u6708\u4f59\u989d period_06 TYPE ty_amount , \" 06\u6708\u4f59\u989d period_07 TYPE ty_amount , \" 07\u6708\u4f59\u989d period_08 TYPE ty_amount , \" 08\u6708\u4f59\u989d period_09 TYPE ty_amount , \" 09\u6708\u4f59\u989d period_10 TYPE ty_amount , \" 10\u6708\u4f59\u989d period_11 TYPE ty_amount , \" 11\u6708\u4f59\u989d period_12 TYPE ty_amount , \" 12\u6708\u4f59\u989d period_13 TYPE ty_amount , \" 13\u6708\u4f59\u989d period_14 TYPE ty_amount , \" 14\u6708\u4f59\u989d period_15 TYPE ty_amount , \" 15\u6708\u4f59\u989d period_16 TYPE ty_amount , \" 16\u6708\u4f59\u989d t_detail_key TYPE tt_detail_key , \" \u660e\u7ec6\u6570\u636e\u952e\u503c END OF ty_fi_data . TYPES tt_fi_data TYPE STANDARD TABLE OF ty_fi_data WITH EMPTY KEY . \" \u7b5b\u9009\u9879 TYPES : BEGIN OF ty_filter , name TYPE string , t_range_opt TYPE RANGE OF char40 , END OF ty_filter . \" \u5bf9\u4e8e\u7279\u6b8a\u914d\u7f6e\uff0c\u901a\u8fc7\u56de\u8c03\u65b9\u6cd5\u8fdb\u884c\u5904\u7406 TYPES : BEGIN OF ty_callback , cb_program TYPE programm , cb_from TYPE char30 , END OF ty_callback . TYPES tt_callback TYPE STANDARD TABLE OF ty_callback WITH EMPTY KEY . \" \u914d\u7f6e\u6570\u636e TYPES ty_config_key TYPE n LENGTH 3 . TYPES : BEGIN OF ty_config , bukrs TYPE bukrs , \" \u516c\u53f8 zitem TYPE ty_config_key , \" \u9879\u76ee zitem_sub TYPE ty_config_key , \" \u5b50\u9879\u76ee ztext TYPE string , \" \u63cf\u8ff0 reverse TYPE xfeld , \" \u53cd\u5411\u6807\u8bb0\uff0c\u6c47\u603b\u6216\u8ba1\u7b97\u7684\u65f6\u5019\u4f7f\u7528 fi_data TYPE ty_fi_data , t_racct_opt TYPE RANGE OF racct , \" \u79d1\u76ee\u4f5c\u4e3a\u8d22\u52a1\u6570\u636e\u9996\u8981\u7b5b\u9009\u7ef4\u5ea6 t_filter TYPE STANDARD TABLE OF ty_filter WITH EMPTY KEY , \" \u7b5b\u9009\u9879 t_collect TYPE STANDARD TABLE OF ty_config_key WITH EMPTY KEY , \" \u5f15\u7528\u6c47\u603b\u5176\u4ed6\u9879\u76ee\u7ed3\u679c processed TYPE char01 , \" \u5904\u7406\u6807\u8bc6\uff0c\u672a\u5904\u7406[\u7a7a]\uff0c\u5904\u7406\u4e2d[P]\uff0c\u5df2\u5904\u7406[X]\uff0c\u7528\u4e8e\u6b7b\u5faa\u73af\u68c0\u67e5\u548c\u8df3\u8fc7\u5197\u4f59\u8ba1\u7b97 t_callback TYPE tt_callback , END OF ty_config . TYPES tt_config TYPE STANDARD TABLE OF ty_config WITH EMPTY KEY . *&---------------------------------------------------------------------* *& \u8d22\u52a1\u62a5\u8868\u64cd\u4f5c\u5bf9\u8c61 *&---------------------------------------------------------------------* CLASS lcl_fi_report DEFINITION DEFERRED . *&---------------------------------------------------------------------* *& \u8d22\u52a1\u62a5\u8868\u64cd\u4f5c\u5bf9\u8c61 *&---------------------------------------------------------------------* CLASS lcl_fi_report DEFINITION . PUBLIC SECTION . CLASS-METHODS get_smw0_templete IMPORTING i_objid TYPE w3objid RETURNING VALUE ( r_buffer ) TYPE xstring . CLASS-METHODS replace_texts IMPORTING it_replace TYPE ANY TABLE CHANGING c_doc TYPE xstring . CLASS-METHODS create IMPORTING i_year TYPE gjahr i_period TYPE monat it_config TYPE tt_config RETURNING VALUE ( ro_result ) TYPE REF TO lcl_fi_report . CLASS-METHODS add_hsl IMPORTING ir_config TYPE REF TO ty_config i_poper TYPE ty_detail - poper i_hsl TYPE ty_detail - hsl . METHODS execute RETURNING VALUE ( rt_fi_data ) TYPE tt_fi_data . PRIVATE SECTION . METHODS get_detail . METHODS get_fi_data IMPORTING ir_config TYPE REF TO ty_config i_depth TYPE i OPTIONAL . DATA m_year TYPE gjahr . DATA m_period TYPE monat . DATA mt_config TYPE tt_config . DATA mt_detail TYPE tt_detail . ENDCLASS . *&---------------------------------------------------------------------* *& \u8d22\u52a1\u62a5\u8868\u64cd\u4f5c\u5bf9\u8c61 *&---------------------------------------------------------------------* CLASS lcl_fi_report IMPLEMENTATION . *&---------------------------------------------------------------------* *& \u8d22\u52a1\u62a5\u8868\u64cd\u4f5c\u5bf9\u8c61 *&---------------------------------------------------------------------* METHOD create . ro_result = NEW # ( ). ro_result -> mt_config = it_config . ro_result -> m_year = i_year . ro_result -> m_period = i_period . ENDMETHOD . *&---------------------------------------------------------------------* *& \u6839\u636e\u914d\u7f6e\u6267\u884c *&---------------------------------------------------------------------* METHOD execute . SORT mt_config BY bukrs zitem zitem_sub . get_detail ( ). \" \u83b7\u53d6\u62a5\u8868\u660e\u7ec6\u6570\u636e LOOP AT mt_config REFERENCE INTO DATA ( lr_config ). get_fi_data ( lr_config ). \" \u751f\u6210\u62a5\u8868\u884c\u6570\u636e ENDLOOP . LOOP AT mt_config REFERENCE INTO lr_config GROUP BY ( bukrs = lr_config -> bukrs zitem = lr_config -> zitem ) INTO DATA ( ls_config_grp ). DATA ls_fi_data TYPE ty_fi_data . CLEAR ls_fi_data . ls_fi_data - bukrs = ls_config_grp - bukrs . ls_fi_data - year = m_year . ls_fi_data - period = m_period . ls_fi_data - zitem = ls_config_grp - zitem . LOOP AT GROUP ls_config_grp REFERENCE INTO lr_config . \" \u6587\u672c\u4efb\u53d6\u4e00\u884c\u6709\u503c\u7684 IF lr_config -> ztext IS NOT INITIAL . ls_fi_data - ztext = lr_config -> ztext . EXIT . ENDIF . ENDLOOP . LOOP AT GROUP ls_config_grp REFERENCE INTO lr_config . ls_fi_data - year_begin = ls_fi_data - year_begi + lr_config -> fi_data - year_begin . \" \u5e74\u521d\u4f59\u989d ls_fi_data - period_01 = ls_fi_data - period_01 + lr_config -> fi_data - period_01 . \" 01\u6708\u4f59\u989d ls_fi_data - period_02 = ls_fi_data - period_02 + lr_config -> fi_data - period_02 . \" 02\u6708\u4f59\u989d ls_fi_data - period_03 = ls_fi_data - period_03 + lr_config -> fi_data - period_03 . \" 03\u6708\u4f59\u989d ls_fi_data - period_04 = ls_fi_data - period_04 + lr_config -> fi_data - period_04 . \" 04\u6708\u4f59\u989d ls_fi_data - period_05 = ls_fi_data - period_05 + lr_config -> fi_data - period_05 . \" 05\u6708\u4f59\u989d ls_fi_data - period_06 = ls_fi_data - period_06 + lr_config -> fi_data - period_06 . \" 06\u6708\u4f59\u989d ls_fi_data - period_07 = ls_fi_data - period_07 + lr_config -> fi_data - period_07 . \" 07\u6708\u4f59\u989d ls_fi_data - period_08 = ls_fi_data - period_08 + lr_config -> fi_data - period_08 . \" 08\u6708\u4f59\u989d ls_fi_data - period_09 = ls_fi_data - period_09 + lr_config -> fi_data - period_09 . \" 09\u6708\u4f59\u989d ls_fi_data - period_10 = ls_fi_data - period_10 + lr_config -> fi_data - period_10 . \" 10\u6708\u4f59\u989d ls_fi_data - period_11 = ls_fi_data - period_11 + lr_config -> fi_data - period_11 . \" 11\u6708\u4f59\u989d ls_fi_data - period_12 = ls_fi_data - period_12 + lr_config -> fi_data - period_12 . \" 12\u6708\u4f59\u989d ls_fi_data - period_13 = ls_fi_data - period_13 + lr_config -> fi_data - period_13 . \" 13\u6708\u4f59\u989d ls_fi_data - period_14 = ls_fi_data - period_14 + lr_config -> fi_data - period_14 . \" 14\u6708\u4f59\u989d ls_fi_data - period_15 = ls_fi_data - period_15 + lr_config -> fi_data - period_15 . \" 15\u6708\u4f59\u989d ls_fi_data - period_16 = ls_fi_data - period_16 + lr_config -> fi_data - period_16 . \" 16\u6708\u4f59\u989d INSERT LINES OF lr_config -> fi_data - t_detail_key INTO TABLE ls_fi_data - t_detail_key . \" \u660e\u7ec6\u6570\u636e\u952e\u503c ENDLOOP . ls_fi_data - year_end = ls_fi_data - year_begin . DO 16 TIMES . DATA l_period TYPE ty_fi_data - period . l_period = sy - index . ASSIGN COMPONENT | PERIOD_ { sy - index ALIGN = RIGHT WIDTH = 2 PAD = '0' }| OF STRUCTURE ls_fi_data TO FIELD - SYMBOL ( <fs_period> ). IF <fs_period> IS ASSIGNED . ls_fi_data - year_end += <fs_period> . \" \u5e74\u672b\u4f59\u989d IF ls_fi_data - period >= l_period . \" \u622a\u6b62\u672c\u6708\u672b\u7d2f\u8ba1\u91d1\u989d ls_fi_data - period_total += <fs_period> . ENDIF . IF ls_fi_data - period = l_period . \" \u672c\u6708\u91d1\u989d ls_fi_data - period_current = <fs_period> . ENDIF . ENDIF . ENDDO . INSERT ls_fi_data INTO TABLE rt_fi_data . ENDLOOP . ENDMETHOD . *&---------------------------------------------------------------------* *& \u83b7\u53d6\u8d22\u52a1\u660e\u7ec6\u6570\u636e *&---------------------------------------------------------------------* METHOD get_detail . LOOP AT mt_config REFERENCE INTO DATA ( lr_config ) GROUP BY ( bukrs = lr_config -> bukrs ) INTO DATA ( ls_config_grp ). \" \u79d1\u76ee\u8303\u56f4 DATA lt_racct_opt TYPE RANGE OF racct . CLEAR lt_racct_opt . LOOP AT GROUP ls_config_grp REFERENCE INTO lr_config . INSERT LINES OF lr_config -> t_racct_opt INTO TABLE lt_racct_opt . ENDLOOP . CHECK lt_racct_opt IS NOT INITIAL . SORT lt_racct_opt . DELETE ADJACENT DUPLICATES FROM lt_racct_opt COMPARING ALL FIELDS . \" TODO \u8d85\u8fc7\u5927\u7ea6\u4e00\u4e07\u884c\u6570\u636e\u5c31\u5e94\u8be5\u5206\u6279\u5904\u7406\u4e86 \" \u9884\u67e5\u8be2\u51fa\u5168\u90e8\u76f8\u5173\u7684\u8d22\u52a1\u6570\u636e SELECT rldnr , rbukrs , gjahr , belnr , docln , ryear , \" \u8d22\u5e74 poper , \" \u671f\u95f4 racct , \" \u4f1a\u8ba1\u79d1\u76ee rcntr , \" \u6210\u672c\u4e2d\u5fc3 prctr , \" \u5229\u6da6\u4e2d\u5fc3 rstgr , \" \u539f\u56e0\u4ee3\u7801 rfarea , \" \u529f\u80fd\u8303\u56f4 rbusa , \" \u4e1a\u52a1\u8303\u56f4 budat , CASE WHEN hsl > 0 THEN 'S' ELSE 'H' END AS shkzg , \" \u501f\u8d37\u6807\u8bc6 hsl FROM acdoca WHERE rldnr = '0L' \" \u4e3b\u8d26\u76ee\u8868\uff0c\u5e94\u8be5\u4e0d\u4f1a\u53d8\u5427\uff1f AND rbukrs = @ ls_config_grp - bukrs AND ryear = @ m_year AND racct IN @ lt_racct_opt APPENDING TABLE @ mt_detail . ENDLOOP . SORT mt_detail BY rldnr rbukrs gjahr belnr docln . ENDMETHOD . *&---------------------------------------------------------------------* *& \u751f\u6210\u62a5\u8868\u884c\u6570\u636e *&---------------------------------------------------------------------* METHOD get_fi_data . IF i_depth > 10 \" \u8fed\u4ee3\u5c42\u7ea7\uff0c\u9632\u6b62\u6808\u6ea2\u51fa OR ir_config IS NOT BOUND \" \u7a7a\u503c\u68c0\u67e5 OR ir_config -> processed IS NOT INITIAL \" \u5904\u7406\u6807\u8bb0\u68c0\u67e5\uff0c\u9632\u6b62\u6b7b\u5faa\u73af\uff0c\u4ee5\u53ca\u8df3\u8fc7\u5197\u4f59\u8ba1\u7b97 . RETURN . ENDIF . \" \u8fdb\u5ea6\u5c55\u793a DATA l_text TYPE string . l_text = | \u6b63\u5728\u5904\u7406\u9879\u76ee[ { ir_config -> zitem } ]: { ir_config -> ztext }|. CALL FUNCTION 'SAPGUI_PROGRESS_INDICATOR' EXPORTING text = l_text . ir_config -> processed = 'P' . \" \u5904\u7406\u4e2d \" \u83b7\u53d6\u5f53\u524d\u914d\u7f6e\u884c\u7684\u6709\u6548\u6570\u636e DATA lt_detail TYPE tt_detail . IF ir_config -> t_racct_opt IS NOT INITIAL . SELECT * FROM @ mt_detail AS ds WHERE rbukrs = @ ir_config -> bukrs AND racct IN @ ir_config -> t_racct_opt \" \u79d1\u76ee INTO TABLE @ lt_detail . ENDIF . \" \u7279\u6b8a\u5904\u7406 LOOP AT ir_config -> t_callback INTO DATA ( ls_callback ). \" \u53c2\u8003\uff1a \" FORM frm_config TABLES ct_detail TYPE tt_detail USING cr_config TYPE REF TO ty_config. PERFORM ( ls_callback - cb_from ) IN PROGRAM ( ls_callback - cb_program ) IF FOUND TABLES lt_detail USING ir_config . ENDLOOP . \" \u9664\u79d1\u76ee\u5916\uff0c\u5176\u4ed6\u7b5b\u9009\u9879\u52a8\u6001\u5904\u7406 IF ir_config -> t_filter IS NOT INITIAL . LOOP AT ir_config -> t_filter INTO DATA ( ls_filter ) WHERE t_range_opt IS NOT INITIAL . IF lt_detail IS NOT INITIAL . DATA ( l_condition ) = |{ ls_filter - name } IN @LS_FILTER-T_RANGE_OPT |. TRY . SELECT * FROM @ lt_detail AS ds WHERE ( l_condition ) INTO TABLE @ lt_detail . CATCH cx_root . ENDTRY . ENDIF . ENDLOOP . ENDIF . \" \u6c47\u603b\u8d22\u52a1\u6570\u636e LOOP AT lt_detail INTO DATA ( ls_detail ). add_hsl ( ir_config = ir_config i_poper = ls_detail - poper i_hsl = ls_detail - hsl ). \" \u5199\u5165\u5230\u660e\u7ec6\u6e05\u5355\u4e2d READ TABLE mt_detail TRANSPORTING NO FIELDS WITH KEY rldnr = ls_detail - rldnr rbukrs = ls_detail - rbukrs gjahr = ls_detail - gjahr belnr = ls_detail - belnr docln = ls_detail - docln BINARY SEARCH . IF sy - subrc = 0 . INSERT CORRESPONDING # ( ls_detail ) INTO TABLE ir_config -> fi_data - t_detail_key . ENDIF . ENDLOOP . \" \u6c47\u603b\u5176\u4ed6\u9879\u7684\u8d22\u52a1\u6570\u636e LOOP AT ir_config -> t_collect INTO DATA ( l_other_zitem ). READ TABLE mt_config TRANSPORTING NO FIELDS WITH KEY \" \u5d4c\u5957\u5faa\u73af\u4f18\u5316 bukrs = ir_config -> bukrs zitem = l_other_zitem BINARY SEARCH . IF sy - subrc = 0 . LOOP AT mt_config REFERENCE INTO DATA ( lr_config ) FROM sy - tabix . IF lr_config -> bukrs <> ir_config -> bukrs OR lr_config -> zitem <> l_other_zitem . EXIT . ENDIF . get_fi_data ( ir_config = lr_config i_depth = i_depth + 1 ). \" \u9012\u5f52\u53d6\u503c ir_config -> fi_data - year_begin = ir_config -> fi_data - year_begin + lr_config -> fi_data - year_begin . \" \u5e74\u521d\u4f59\u989d ir_config -> fi_data - period_01 = ir_config -> fi_data - period_01 + lr_config -> fi_data - period_01 . \" 01\u6708\u4f59\u989d ir_config -> fi_data - period_02 = ir_config -> fi_data - period_02 + lr_config -> fi_data - period_02 . \" 02\u6708\u4f59\u989d ir_config -> fi_data - period_03 = ir_config -> fi_data - period_03 + lr_config -> fi_data - period_03 . \" 03\u6708\u4f59\u989d ir_config -> fi_data - period_04 = ir_config -> fi_data - period_04 + lr_config -> fi_data - period_04 . \" 04\u6708\u4f59\u989d ir_config -> fi_data - period_05 = ir_config -> fi_data - period_05 + lr_config -> fi_data - period_05 . \" 05\u6708\u4f59\u989d ir_config -> fi_data - period_06 = ir_config -> fi_data - period_06 + lr_config -> fi_data - period_06 . \" 06\u6708\u4f59\u989d ir_config -> fi_data - period_07 = ir_config -> fi_data - period_07 + lr_config -> fi_data - period_07 . \" 07\u6708\u4f59\u989d ir_config -> fi_data - period_08 = ir_config -> fi_data - period_08 + lr_config -> fi_data - period_08 . \" 08\u6708\u4f59\u989d ir_config -> fi_data - period_09 = ir_config -> fi_data - period_09 + lr_config -> fi_data - period_09 . \" 09\u6708\u4f59\u989d ir_config -> fi_data - period_10 = ir_config -> fi_data - period_10 + lr_config -> fi_data - period_10 . \" 10\u6708\u4f59\u989d ir_config -> fi_data - period_11 = ir_config -> fi_data - period_11 + lr_config -> fi_data - period_11 . \" 11\u6708\u4f59\u989d ir_config -> fi_data - period_12 = ir_config -> fi_data - period_12 + lr_config -> fi_data - period_12 . \" 12\u6708\u4f59\u989d ir_config -> fi_data - period_13 = ir_config -> fi_data - period_13 + lr_config -> fi_data - period_13 . \" 13\u6708\u4f59\u989d ir_config -> fi_data - period_14 = ir_config -> fi_data - period_14 + lr_config -> fi_data - period_14 . \" 14\u6708\u4f59\u989d ir_config -> fi_data - period_15 = ir_config -> fi_data - period_15 + lr_config -> fi_data - period_15 . \" 15\u6708\u4f59\u989d ir_config -> fi_data - period_16 = ir_config -> fi_data - period_16 + lr_config -> fi_data - period_16 . \" 16\u6708\u4f59\u989d INSERT LINES OF lr_config -> fi_data - t_detail_key INTO TABLE ir_config -> fi_data - t_detail_key . \" \u660e\u7ec6\u6570\u636e ENDLOOP . ENDIF . ENDLOOP . \" \u53cd\u5411\u6807\u8bb0 IF ir_config -> reverse IS NOT INITIAL . ir_config -> fi_data - year_begin = 0 - ir_config -> fi_data - year_begin . \" \u5e74\u521d\u4f59\u989d ir_config -> fi_data - period_01 = 0 - ir_config -> fi_data - period_01 . \" 01\u6708\u4f59\u989d ir_config -> fi_data - period_02 = 0 - ir_config -> fi_data - period_02 . \" 02\u6708\u4f59\u989d ir_config -> fi_data - period_03 = 0 - ir_config -> fi_data - period_03 . \" 03\u6708\u4f59\u989d ir_config -> fi_data - period_04 = 0 - ir_config -> fi_data - period_04 . \" 04\u6708\u4f59\u989d ir_config -> fi_data - period_05 = 0 - ir_config -> fi_data - period_05 . \" 05\u6708\u4f59\u989d ir_config -> fi_data - period_06 = 0 - ir_config -> fi_data - period_06 . \" 06\u6708\u4f59\u989d ir_config -> fi_data - period_07 = 0 - ir_config -> fi_data - period_07 . \" 07\u6708\u4f59\u989d ir_config -> fi_data - period_08 = 0 - ir_config -> fi_data - period_08 . \" 08\u6708\u4f59\u989d ir_config -> fi_data - period_09 = 0 - ir_config -> fi_data - period_09 . \" 09\u6708\u4f59\u989d ir_config -> fi_data - period_10 = 0 - ir_config -> fi_data - period_10 . \" 10\u6708\u4f59\u989d ir_config -> fi_data - period_11 = 0 - ir_config -> fi_data - period_11 . \" 11\u6708\u4f59\u989d ir_config -> fi_data - period_12 = 0 - ir_config -> fi_data - period_12 . \" 12\u6708\u4f59\u989d ir_config -> fi_data - period_13 = 0 - ir_config -> fi_data - period_13 . \" 13\u6708\u4f59\u989d ir_config -> fi_data - period_14 = 0 - ir_config -> fi_data - period_14 . \" 14\u6708\u4f59\u989d ir_config -> fi_data - period_15 = 0 - ir_config -> fi_data - period_15 . \" 15\u6708\u4f59\u989d ir_config -> fi_data - period_16 = 0 - ir_config -> fi_data - period_16 . \" 16\u6708\u4f59\u989d ENDIF . ir_config -> processed = 'X' . \" \u5904\u7406\u5b8c\u6210 ENDMETHOD . *&---------------------------------------------------------------------* *& \u4eceSMW0\u83b7\u53d6\u6a21\u677f\u6587\u4ef6 *&---------------------------------------------------------------------* METHOD get_smw0_templete . DATA : lt_mime TYPE STANDARD TABLE OF w3mime , ls_id TYPE wwwdataid , ls_key TYPE wwwdatatab . ls_key - relid = 'MI' . ls_key - objid = i_objid . CALL FUNCTION 'WWWDATA_IMPORT' EXPORTING key = ls_key TABLES mime = lt_mime EXCEPTIONS wrong_object_type = 1 import_error = 2 OTHERS = 3 . IF sy - subrc <> 0 . MESSAGE | \u6a21\u677f[ { i_objid } ]\u83b7\u53d6\u5931\u8d25 | TYPE 'S' DISPLAY LIKE 'E' . RETURN . ENDIF . SELECT SINGLE value FROM wwwparams WHERE relid = @ ls_key - relid AND objid = @ ls_key - objid AND name EQ 'filesize' INTO @ DATA ( l_param ). DATA l_length TYPE i . l_length = l_param . CALL FUNCTION 'SCMS_BINARY_TO_XSTRING' EXPORTING input_length = l_length IMPORTING buffer = r_buffer TABLES binary_tab = lt_mime EXCEPTIONS failed = 1 OTHERS = 2 . IF sy - subrc <> 0 . CLEAR r_buffer . ENDIF . ENDMETHOD . *&---------------------------------------------------------------------* *& \u66ff\u6362\u6a21\u677f\u6587\u4ef6\u4e2d\u7684\u6587\u672c\u5185\u5bb9 *&---------------------------------------------------------------------* METHOD replace_texts . \" \u7a0b\u5e8f\u8981\u6c42IT_REPLACE\u81f3\u5c11\u4e24\u5217\uff0c\u4ee3\u7801\u4f1a\u5c06\u5de6\u5217\u5185\u5bb9\u66ff\u6362\u4e3a\u53f3\u5217\u5185\u5bb9 CHECK it_replace IS NOT INITIAL . CHECK c_doc IS NOT INITIAL . FIELD-SYMBOLS <fs_replace_t> TYPE ANY TABLE . FIELD-SYMBOLS <fs_replace> TYPE any . FIELD-SYMBOLS <fs_from> TYPE any . FIELD-SYMBOLS <fs_to> TYPE any . TRY . DATA ( lo_doc ) = cl_xlsx_document => load_document ( c_doc ). DATA ( lo_workbook_part ) = lo_doc -> get_workbookpart ( ). DATA ( lo_sharedstrings_part ) = lo_workbook_part -> get_sharedstringspart ( ). DATA ( l_sharedstrings_xml ) = lo_sharedstrings_part -> get_data ( ). DATA ( l_sharedstrings_str ) = cl_openxml_helper => xstring_to_string ( l_sharedstrings_xml ). ASSIGN it_replace TO <fs_replace_t> . LOOP AT <fs_replace_t> ASSIGNING <fs_replace> . ASSIGN COMPONENT 1 OF STRUCTURE <fs_replace> TO <fs_from> . ASSIGN COMPONENT 2 OF STRUCTURE <fs_replace> TO <fs_to> . IF <fs_from> IS ASSIGNED AND <fs_to> IS ASSIGNED . IF <fs_from> IS NOT INITIAL . REPLACE ALL OCCURRENCES OF <fs_from> IN l_sharedstrings_str WITH <fs_to> IN CHARACTER MODE . ENDIF . ENDIF . UNASSIGN <fs_from> . UNASSIGN <fs_to> . ENDLOOP . l_sharedstrings_xml = cl_openxml_helper => string_to_xstring ( l_sharedstrings_str ). lo_sharedstrings_part -> feed_data ( l_sharedstrings_xml ). c_doc = lo_doc -> get_package_data ( ). CATCH cx_openxml_not_found cx_openxml_format cx_openxml_not_allowed INTO DATA ( lx_openxml ). MESSAGE lx_openxml -> get_text ( ) TYPE 'S' DISPLAY LIKE 'E' . CATCH cx_root INTO DATA ( lx_root ). MESSAGE lx_root -> get_text ( ) TYPE 'S' DISPLAY LIKE 'E' . ENDTRY . ENDMETHOD . *&---------------------------------------------------------------------* *& \u6dfb\u52a0\u91d1\u989d\u5230\u5bf9\u5e94\u671f\u95f4 *&---------------------------------------------------------------------* METHOD add_hsl . CASE i_poper . WHEN 0 . ir_config -> fi_data - year_begin += i_hsl . WHEN 1 . ir_config -> fi_data - period_01 += i_hsl . WHEN 2 . ir_config -> fi_data - period_02 += i_hsl . WHEN 3 . ir_config -> fi_data - period_03 += i_hsl . WHEN 4 . ir_config -> fi_data - period_04 += i_hsl . WHEN 5 . ir_config -> fi_data - period_05 += i_hsl . WHEN 6 . ir_config -> fi_data - period_06 += i_hsl . WHEN 7 . ir_config -> fi_data - period_07 += i_hsl . WHEN 8 . ir_config -> fi_data - period_08 += i_hsl . WHEN 9 . ir_config -> fi_data - period_09 += i_hsl . WHEN 10 . ir_config -> fi_data - period_10 += i_hsl . WHEN 11 . ir_config -> fi_data - period_11 += i_hsl . WHEN 12 . ir_config -> fi_data - period_12 += i_hsl . WHEN 13 . ir_config -> fi_data - period_13 += i_hsl . WHEN 14 . ir_config -> fi_data - period_14 += i_hsl . WHEN 15 . ir_config -> fi_data - period_15 += i_hsl . WHEN 16 . ir_config -> fi_data - period_16 += i_hsl . WHEN OTHERS . ENDCASE . ENDMETHOD . ENDCLASS . *&---------------------------------------------------------------------* *& \u56de\u8c03\u53c2\u8003\u65b9\u6cd5 *&---------------------------------------------------------------------* FORM frm_config_sample TABLES ct_detail TYPE tt_detail USING cr_config TYPE REF TO ty_config . ENDFORM .","title":"\u901a\u7528\u53d6\u503c\u6a21\u5757"},{"location":"fico/fi_report/#_1","text":"\u8d22\u52a1\u4e09\u5927\u62a5\u8868\u53d6\u503c\u90e8\u5206\u53ef\u4ee5\u901a\u7528\uff0c\u56e0\u6b64\u4e0b\u9762\u53ea\u5bf9\u53d6\u503c\u90e8\u5206\u8fdb\u884c\u5c01\u88c5\uff0c\u901a\u8fc7\u4f20\u5165\u914d\u7f6e\uff0c\u53ef\u4ee5\u83b7\u53d6\u5404\u9879\u76ee\u7684\u5e74\u521d\u3001\u5e74\u672b\u3001\u5404\u671f\u95f4\u91d1\u989d\u3002","title":"\u901a\u7528\u53d6\u503c\u6a21\u5757"},{"location":"fico/fi_report/#_2","text":"\u5b57\u6bb5 \u8bf4\u660e BUKRS \u516c\u53f8\u4ee3\u7801 ZITEM \u9879\u76ee ZITEM_SUB \u5b50\u9879\u76ee ZTEXT \u9879\u76ee\u63cf\u8ff0 REVERSE \u53cd\u5411\u6807\u8bc6\uff0c\u8ba1\u7b97\u6216\u6c47\u603b\u65f6\u4f7f\u7528 T_ACCAT_OPT \u79d1\u76eeRange\u8868 T_FILTER \u9664\u79d1\u76ee\u5916\u7684\u5176\u4ed6Range\u8868\uff0c\u6309\u5b57\u6bb5\u540d\u52a8\u6001\u8fc7\u6ee4 T_COLLECT ZITEM\u9879\u76ee\u5b50\u8868\uff0c\u6c47\u603b\u5176\u4ed6\u9879\u76ee\u7ed3\u679c","title":"\u5165\u53c2\u7ed3\u6784"},{"location":"fico/fi_report/#_3","text":"\u5047\u5982\u73b0\u5728\u9700\u8981: \u9879\u76ee[\u8d44\u4ea7\u603b\u503c]\uff0cZITEM=1\uff0c\u6c47\u603b: \u79d1\u76ee1100* \u529f\u80fd\u8303\u56f4100\u3001200 ZITEM=2\u30013 \u79d1\u76ee2*\u4e14\u5229\u6da6\u4e2d\u5fc321* \u9879\u76ee[\u6d41\u52a8\u8d44\u4ea7]\uff0cZITEM=2\uff0c\u6c47\u603b\u79d1\u76ee3*\u30014*\u30015* \u9879\u76ee[\u975e\u6d41\u52a8\u8d44\u4ea7]\uff0cZITEM=3\uff0c\u6c47\u603b\u79d1\u76ee6*\u30017*\u30018* \u53ef\u4ee5\u5f97\u51fa\u5165\u53c2\uff1a BUKRS ZITEM ZITEM_SUB ZTEXT REVERSE T_ACCAT_OPT T_FILTER T_COLLECT 1000 1 1 \u8d44\u4ea7\u603b\u503c 1000 1 2 \u79d1\u76ee\u9879 1100* 1000 1 3 \u8fc7\u6ee4\u9879 \u529f\u80fd\u8303\u56f4=100/200 1000 1 4 \u5176\u4ed6\u9879 ZITEM=\u2154 1000 1 5 \u7ed3\u5408\u4f7f\u7528 2* \u5229\u6da6\u4e2d\u5fc3=21* 1000 2 1 \u6d41\u52a8\u8d44\u4ea7 1000 2 2 3* 1000 2 3 4* 1000 2 4 5* 1000 3 1 \u975e\u6d41\u52a8\u8d44\u4ea7 1000 3 2 6* 1000 3 3 7* 1000 3 4 8*","title":"\u793a\u4f8b\u5165\u53c2"},{"location":"fico/fi_report/#_4","text":"\u51fa\u53c2\u7ed3\u6784\u5305\u62ec\u4e86\u5e74\u521d\u3001\u5e74\u672b\u3001\u672c\u6708\u3001\u622a\u6b62\u672c\u6708\u7d2f\u8ba1\u3001\u5176\u4ed6\u5404\u6708\u6570\u636e\uff0c\u6309\u9700\u4f7f\u7528\u5373\u53ef\uff1a \u5b57\u6bb5 \u8bf4\u660e BUKRS \u516c\u53f8\u4ee3\u7801 YEAR \u5e74\u5ea6 PERIOD \u671f\u95f4 ZITEM \u9879\u76ee ZTEXT \u9879\u76ee\u63cf\u8ff0 YEAR_BEGIN \u5e74\u521d\u4f59\u989d TEAR_END \u5e74\u672b\u4f59\u989d PERIOD_CURRENT \u672c\u6708\u91d1\u989d PERIOD_TOTAL \u622a\u6b62\u672c\u6708\u7d2f\u8ba1\u91d1\u989d PERIOD_01 01\u6708\u4f59\u989d PERIOD_02 02\u6708\u4f59\u989d PERIOD_03 03\u6708\u4f59\u989d PERIOD_04 04\u6708\u4f59\u989d PERIOD_05 05\u6708\u4f59\u989d PERIOD_06 06\u6708\u4f59\u989d PERIOD_07 07\u6708\u4f59\u989d PERIOD_08 08\u6708\u4f59\u989d PERIOD_09 09\u6708\u4f59\u989d PERIOD_10 10\u6708\u4f59\u989d PERIOD_11 11\u6708\u4f59\u989d PERIOD_12 12\u6708\u4f59\u989d PERIOD_13 13\u6708\u4f59\u989d PERIOD_14 14\u6708\u4f59\u989d PERIOD_15 15\u6708\u4f59\u989d PERIOD_16 16\u6708\u4f59\u989d","title":"\u51fa\u53c2\u7ed3\u6784"},{"location":"fico/fi_report/#_5","text":"\u4e09\u5927\u62a5\u8868\u683c\u5f0f\u56fa\u5b9a\uff0c\u56e0\u6b64\u53ef\u4ee5\u901a\u8fc7\u6587\u672c\u66ff\u6362\u7684\u65b9\u5f0f\uff0c\u5c06\u6a21\u677f\u4e2d\u7684\u5360\u4f4d\u7b26\u66ff\u6362\u4e3a\u5176\u4ed6\u503c\u3002","title":"\u6587\u4ef6\u5bfc\u51fa"},{"location":"fico/fi_report/#xlsx","text":"XLSX\u683c\u5f0f\uff0c\u6216\u8005\u8bf4Openxml\u683c\u5f0f\uff0c\u4f1a\u5c06\u6587\u672c\u5168\u90e8\u5b58\u5165\u5230Sharedstrings.xml\u6587\u4ef6\u4e2d\uff0c\u56e0\u6b64\u901a\u8fc7\u66ff\u6362Sharedstrings\u4e2d\u7684\u6587\u672c\u5185\u5bb9\uff0c\u5373\u53ef\u5b9e\u73b0\u6587\u672c\u66ff\u6362\u3002 Openxml\u66ff\u6362Sharedstrings\u5185\u5bb9 *&---------------------------------------------------------------------* *& \u66ff\u6362\u6a21\u677f\u6587\u4ef6\u4e2d\u7684\u6587\u672c\u5185\u5bb9 *&---------------------------------------------------------------------* METHOD replace_texts . \" \u7a0b\u5e8f\u8981\u6c42IT_REPLACE\u81f3\u5c11\u4e24\u5217\uff0c\u4ee3\u7801\u4f1a\u5c06\u5de6\u5217\u5185\u5bb9\u66ff\u6362\u4e3a\u53f3\u5217\u5185\u5bb9 CHECK it_replace IS NOT INITIAL . \" \u6a21\u677f\u6587\u4ef6\u4e0d\u80fd\u4e3a\u7a7a CHECK c_doc IS NOT INITIAL . FIELD-SYMBOLS <fs_replace_t> TYPE ANY TABLE . FIELD-SYMBOLS <fs_replace> TYPE any . FIELD-SYMBOLS <fs_from> TYPE any . FIELD-SYMBOLS <fs_to> TYPE any . TRY . DATA ( lo_doc ) = cl_xlsx_document => load_document ( c_doc ). DATA ( lo_workbook_part ) = lo_doc -> get_workbookpart ( ). DATA ( lo_sharedstrings_part ) = lo_workbook_part -> get_sharedstringspart ( ). DATA ( l_sharedstrings_xml ) = lo_sharedstrings_part -> get_data ( ). DATA ( l_sharedstrings_str ) = cl_openxml_helper => xstring_to_string ( l_sharedstrings_xml ). ASSIGN it_replace TO <fs_replace_t> . LOOP AT <fs_replace_t> ASSIGNING <fs_replace> . ASSIGN COMPONENT 1 OF STRUCTURE <fs_replace> TO <fs_from> . ASSIGN COMPONENT 2 OF STRUCTURE <fs_replace> TO <fs_to> . IF <fs_from> IS ASSIGNED AND <fs_to> IS ASSIGNED . IF <fs_from> IS NOT INITIAL . REPLACE ALL OCCURRENCES OF <fs_from> IN l_sharedstrings_str WITH <fs_to> IN CHARACTER MODE . ENDIF . ENDIF . UNASSIGN <fs_from> . UNASSIGN <fs_to> . ENDLOOP . l_sharedstrings_xml = cl_openxml_helper => string_to_xstring ( l_sharedstrings_str ). lo_sharedstrings_part -> feed_data ( l_sharedstrings_xml ). c_doc = lo_doc -> get_package_data ( ). CATCH cx_openxml_not_found cx_openxml_format cx_openxml_not_allowed INTO DATA ( lx_openxml ). MESSAGE lx_openxml -> get_text ( ) TYPE 'S' DISPLAY LIKE 'E' . CATCH cx_root INTO DATA ( lx_root ). MESSAGE lx_root -> get_text ( ) TYPE 'S' DISPLAY LIKE 'E' . ENDTRY . ENDMETHOD .","title":"XLSX\u683c\u5f0f\u5bfc\u51fa"},{"location":"fico/fi_report/#xls","text":"\u5982\u679c\u6a21\u677f\u662fXLS\u683c\u5f0f\uff0c\u4f7f\u7528OLE\u8fdb\u884c\u66ff\u6362\uff1a OLE\u66ff\u6362\u6587\u672c\u5185\u5bb9 TYPE-POOLS ole2 . DATA : l_app TYPE ole2_object , l_workbooks TYPE ole2_object , l_cells TYPE ole2_object . CREATE OBJECT l_app 'EXCEL.APPLICATION' . SET PROPERTY OF l_app 'DisplayAlerts' = 0 . CALL METHOD OF l_app 'Workbooks' = l_workbooks . CALL METHOD OF l_workbooks 'Open' EXPORTING # 1 = filename . GET PROPERTY OF l_app 'Cells' = l_cells . FIELD-SYMBOLS : <fs_replace> TYPE any , <fs_from> TYPE any , <fs_to> TYPE any . LOOP AT it_replace ASSIGNING <fs_replace> . ASSIGN COMPONENT 1 OF STRUCTURE <fs_replace> TO <fs_from> . ASSIGN COMPONENT 2 OF STRUCTURE <fs_replace> TO <fs_to> . CALL METHOD OF l_cells 'Replace' EXPORTING # 1 = <fs_from> # 2 = <fs_to> . ENDLOOP . SET PROPERTY OF l_app 'Visible' = 1 .","title":"XLS\u683c\u5f0f\u5bfc\u51fa"},{"location":"fico/fi_report/#include","text":"\u793a\u4f8b\u4ee3\u7801 *&---------------------------------------------------------------------* *& Include zfi_report *&---------------------------------------------------------------------* *&---------------------------------------------------------------------* *& \u4e09\u5927\u62a5\u8868\u53d6\u503c\u90e8\u5206\u53ef\u4ee5\u901a\u7528\uff0c\u56e0\u6b64\u62bd\u53d6\u51fa\u6765\u5f62\u6210\u4e00\u4e2a\u6a21\u5757 *&---------------------------------------------------------------------* \" \u8d22\u52a1\u660e\u7ec6\u6570\u636e\u952e\u503c TYPES : BEGIN OF ty_detail_key , rldnr TYPE acdoca - rldnr , rbukrs TYPE acdoca - rbukrs , gjahr TYPE acdoca - gjahr , belnr TYPE acdoca - belnr , docln TYPE acdoca - docln , END OF ty_detail_key . TYPES tt_detail_key TYPE STANDARD TABLE OF ty_detail_key WITH EMPTY KEY . \" \u8d22\u52a1\u660e\u7ec6\u6570\u636e TYPES : BEGIN OF ty_detail , rldnr TYPE acdoca - rldnr , rbukrs TYPE acdoca - rbukrs , gjahr TYPE acdoca - gjahr , belnr TYPE acdoca - belnr , docln TYPE acdoca - docln , ryear TYPE acdoca - ryear , \" \u8d22\u5e74 poper TYPE acdoca - poper , \" \u671f\u95f4 racct TYPE acdoca - racct , \" \u4f1a\u8ba1\u79d1\u76ee rcntr TYPE acdoca - rcntr , \" \u6210\u672c\u4e2d\u5fc3 prctr TYPE acdoca - prctr , \" \u5229\u6da6\u4e2d\u5fc3 rstgr TYPE acdoca - rstgr , \" RSTGR rfarea TYPE acdoca - rfarea , \" \u529f\u80fd\u8303\u56f4 rbusa TYPE acdoca - rbusa , \" \u4e1a\u52a1\u8303\u56f4 budat TYPE acdoca - budat , \" \u8fc7\u8d26\u65e5\u671f shkzg TYPE shkzg , \" \u501f\u8d37 hsl TYPE acdoca - hsl , END OF ty_detail . TYPES tt_detail TYPE STANDARD TABLE OF ty_detail WITH EMPTY KEY . \" \u62a5\u8868\u6570\u636e TYPES ty_amount TYPE p LENGTH 16 DECIMALS 2 . \" \u91d1\u989d TYPES : BEGIN OF ty_fi_data , bukrs TYPE bukrs , \" \u516c\u53f8 year TYPE gjahr , \" \u5e74\u5ea6 period TYPE monat , \" \u671f\u95f4 zitem TYPE string , \" \u9879\u76ee ztext TYPE string , \" \u9879\u76ee\u63cf\u8ff0 year_begin TYPE ty_amount , \" \u5e74\u521d\u4f59\u989d year_end TYPE ty_amount , \" \u5e74\u672b\u4f59\u989d period_current TYPE ty_amount , \" \u672c\u6708\u91d1\u989d period_total TYPE ty_amount , \" \u622a\u6b62\u672c\u6708\u7d2f\u8ba1\u91d1\u989d period_01 TYPE ty_amount , \" 01\u6708\u4f59\u989d period_02 TYPE ty_amount , \" 02\u6708\u4f59\u989d period_03 TYPE ty_amount , \" 03\u6708\u4f59\u989d period_04 TYPE ty_amount , \" 04\u6708\u4f59\u989d period_05 TYPE ty_amount , \" 05\u6708\u4f59\u989d period_06 TYPE ty_amount , \" 06\u6708\u4f59\u989d period_07 TYPE ty_amount , \" 07\u6708\u4f59\u989d period_08 TYPE ty_amount , \" 08\u6708\u4f59\u989d period_09 TYPE ty_amount , \" 09\u6708\u4f59\u989d period_10 TYPE ty_amount , \" 10\u6708\u4f59\u989d period_11 TYPE ty_amount , \" 11\u6708\u4f59\u989d period_12 TYPE ty_amount , \" 12\u6708\u4f59\u989d period_13 TYPE ty_amount , \" 13\u6708\u4f59\u989d period_14 TYPE ty_amount , \" 14\u6708\u4f59\u989d period_15 TYPE ty_amount , \" 15\u6708\u4f59\u989d period_16 TYPE ty_amount , \" 16\u6708\u4f59\u989d t_detail_key TYPE tt_detail_key , \" \u660e\u7ec6\u6570\u636e\u952e\u503c END OF ty_fi_data . TYPES tt_fi_data TYPE STANDARD TABLE OF ty_fi_data WITH EMPTY KEY . \" \u7b5b\u9009\u9879 TYPES : BEGIN OF ty_filter , name TYPE string , t_range_opt TYPE RANGE OF char40 , END OF ty_filter . \" \u5bf9\u4e8e\u7279\u6b8a\u914d\u7f6e\uff0c\u901a\u8fc7\u56de\u8c03\u65b9\u6cd5\u8fdb\u884c\u5904\u7406 TYPES : BEGIN OF ty_callback , cb_program TYPE programm , cb_from TYPE char30 , END OF ty_callback . TYPES tt_callback TYPE STANDARD TABLE OF ty_callback WITH EMPTY KEY . \" \u914d\u7f6e\u6570\u636e TYPES ty_config_key TYPE n LENGTH 3 . TYPES : BEGIN OF ty_config , bukrs TYPE bukrs , \" \u516c\u53f8 zitem TYPE ty_config_key , \" \u9879\u76ee zitem_sub TYPE ty_config_key , \" \u5b50\u9879\u76ee ztext TYPE string , \" \u63cf\u8ff0 reverse TYPE xfeld , \" \u53cd\u5411\u6807\u8bb0\uff0c\u6c47\u603b\u6216\u8ba1\u7b97\u7684\u65f6\u5019\u4f7f\u7528 fi_data TYPE ty_fi_data , t_racct_opt TYPE RANGE OF racct , \" \u79d1\u76ee\u4f5c\u4e3a\u8d22\u52a1\u6570\u636e\u9996\u8981\u7b5b\u9009\u7ef4\u5ea6 t_filter TYPE STANDARD TABLE OF ty_filter WITH EMPTY KEY , \" \u7b5b\u9009\u9879 t_collect TYPE STANDARD TABLE OF ty_config_key WITH EMPTY KEY , \" \u5f15\u7528\u6c47\u603b\u5176\u4ed6\u9879\u76ee\u7ed3\u679c processed TYPE char01 , \" \u5904\u7406\u6807\u8bc6\uff0c\u672a\u5904\u7406[\u7a7a]\uff0c\u5904\u7406\u4e2d[P]\uff0c\u5df2\u5904\u7406[X]\uff0c\u7528\u4e8e\u6b7b\u5faa\u73af\u68c0\u67e5\u548c\u8df3\u8fc7\u5197\u4f59\u8ba1\u7b97 t_callback TYPE tt_callback , END OF ty_config . TYPES tt_config TYPE STANDARD TABLE OF ty_config WITH EMPTY KEY . *&---------------------------------------------------------------------* *& \u8d22\u52a1\u62a5\u8868\u64cd\u4f5c\u5bf9\u8c61 *&---------------------------------------------------------------------* CLASS lcl_fi_report DEFINITION DEFERRED . *&---------------------------------------------------------------------* *& \u8d22\u52a1\u62a5\u8868\u64cd\u4f5c\u5bf9\u8c61 *&---------------------------------------------------------------------* CLASS lcl_fi_report DEFINITION . PUBLIC SECTION . CLASS-METHODS get_smw0_templete IMPORTING i_objid TYPE w3objid RETURNING VALUE ( r_buffer ) TYPE xstring . CLASS-METHODS replace_texts IMPORTING it_replace TYPE ANY TABLE CHANGING c_doc TYPE xstring . CLASS-METHODS create IMPORTING i_year TYPE gjahr i_period TYPE monat it_config TYPE tt_config RETURNING VALUE ( ro_result ) TYPE REF TO lcl_fi_report . CLASS-METHODS add_hsl IMPORTING ir_config TYPE REF TO ty_config i_poper TYPE ty_detail - poper i_hsl TYPE ty_detail - hsl . METHODS execute RETURNING VALUE ( rt_fi_data ) TYPE tt_fi_data . PRIVATE SECTION . METHODS get_detail . METHODS get_fi_data IMPORTING ir_config TYPE REF TO ty_config i_depth TYPE i OPTIONAL . DATA m_year TYPE gjahr . DATA m_period TYPE monat . DATA mt_config TYPE tt_config . DATA mt_detail TYPE tt_detail . ENDCLASS . *&---------------------------------------------------------------------* *& \u8d22\u52a1\u62a5\u8868\u64cd\u4f5c\u5bf9\u8c61 *&---------------------------------------------------------------------* CLASS lcl_fi_report IMPLEMENTATION . *&---------------------------------------------------------------------* *& \u8d22\u52a1\u62a5\u8868\u64cd\u4f5c\u5bf9\u8c61 *&---------------------------------------------------------------------* METHOD create . ro_result = NEW # ( ). ro_result -> mt_config = it_config . ro_result -> m_year = i_year . ro_result -> m_period = i_period . ENDMETHOD . *&---------------------------------------------------------------------* *& \u6839\u636e\u914d\u7f6e\u6267\u884c *&---------------------------------------------------------------------* METHOD execute . SORT mt_config BY bukrs zitem zitem_sub . get_detail ( ). \" \u83b7\u53d6\u62a5\u8868\u660e\u7ec6\u6570\u636e LOOP AT mt_config REFERENCE INTO DATA ( lr_config ). get_fi_data ( lr_config ). \" \u751f\u6210\u62a5\u8868\u884c\u6570\u636e ENDLOOP . LOOP AT mt_config REFERENCE INTO lr_config GROUP BY ( bukrs = lr_config -> bukrs zitem = lr_config -> zitem ) INTO DATA ( ls_config_grp ). DATA ls_fi_data TYPE ty_fi_data . CLEAR ls_fi_data . ls_fi_data - bukrs = ls_config_grp - bukrs . ls_fi_data - year = m_year . ls_fi_data - period = m_period . ls_fi_data - zitem = ls_config_grp - zitem . LOOP AT GROUP ls_config_grp REFERENCE INTO lr_config . \" \u6587\u672c\u4efb\u53d6\u4e00\u884c\u6709\u503c\u7684 IF lr_config -> ztext IS NOT INITIAL . ls_fi_data - ztext = lr_config -> ztext . EXIT . ENDIF . ENDLOOP . LOOP AT GROUP ls_config_grp REFERENCE INTO lr_config . ls_fi_data - year_begin = ls_fi_data - year_begi + lr_config -> fi_data - year_begin . \" \u5e74\u521d\u4f59\u989d ls_fi_data - period_01 = ls_fi_data - period_01 + lr_config -> fi_data - period_01 . \" 01\u6708\u4f59\u989d ls_fi_data - period_02 = ls_fi_data - period_02 + lr_config -> fi_data - period_02 . \" 02\u6708\u4f59\u989d ls_fi_data - period_03 = ls_fi_data - period_03 + lr_config -> fi_data - period_03 . \" 03\u6708\u4f59\u989d ls_fi_data - period_04 = ls_fi_data - period_04 + lr_config -> fi_data - period_04 . \" 04\u6708\u4f59\u989d ls_fi_data - period_05 = ls_fi_data - period_05 + lr_config -> fi_data - period_05 . \" 05\u6708\u4f59\u989d ls_fi_data - period_06 = ls_fi_data - period_06 + lr_config -> fi_data - period_06 . \" 06\u6708\u4f59\u989d ls_fi_data - period_07 = ls_fi_data - period_07 + lr_config -> fi_data - period_07 . \" 07\u6708\u4f59\u989d ls_fi_data - period_08 = ls_fi_data - period_08 + lr_config -> fi_data - period_08 . \" 08\u6708\u4f59\u989d ls_fi_data - period_09 = ls_fi_data - period_09 + lr_config -> fi_data - period_09 . \" 09\u6708\u4f59\u989d ls_fi_data - period_10 = ls_fi_data - period_10 + lr_config -> fi_data - period_10 . \" 10\u6708\u4f59\u989d ls_fi_data - period_11 = ls_fi_data - period_11 + lr_config -> fi_data - period_11 . \" 11\u6708\u4f59\u989d ls_fi_data - period_12 = ls_fi_data - period_12 + lr_config -> fi_data - period_12 . \" 12\u6708\u4f59\u989d ls_fi_data - period_13 = ls_fi_data - period_13 + lr_config -> fi_data - period_13 . \" 13\u6708\u4f59\u989d ls_fi_data - period_14 = ls_fi_data - period_14 + lr_config -> fi_data - period_14 . \" 14\u6708\u4f59\u989d ls_fi_data - period_15 = ls_fi_data - period_15 + lr_config -> fi_data - period_15 . \" 15\u6708\u4f59\u989d ls_fi_data - period_16 = ls_fi_data - period_16 + lr_config -> fi_data - period_16 . \" 16\u6708\u4f59\u989d INSERT LINES OF lr_config -> fi_data - t_detail_key INTO TABLE ls_fi_data - t_detail_key . \" \u660e\u7ec6\u6570\u636e\u952e\u503c ENDLOOP . ls_fi_data - year_end = ls_fi_data - year_begin . DO 16 TIMES . DATA l_period TYPE ty_fi_data - period . l_period = sy - index . ASSIGN COMPONENT | PERIOD_ { sy - index ALIGN = RIGHT WIDTH = 2 PAD = '0' }| OF STRUCTURE ls_fi_data TO FIELD - SYMBOL ( <fs_period> ). IF <fs_period> IS ASSIGNED . ls_fi_data - year_end += <fs_period> . \" \u5e74\u672b\u4f59\u989d IF ls_fi_data - period >= l_period . \" \u622a\u6b62\u672c\u6708\u672b\u7d2f\u8ba1\u91d1\u989d ls_fi_data - period_total += <fs_period> . ENDIF . IF ls_fi_data - period = l_period . \" \u672c\u6708\u91d1\u989d ls_fi_data - period_current = <fs_period> . ENDIF . ENDIF . ENDDO . INSERT ls_fi_data INTO TABLE rt_fi_data . ENDLOOP . ENDMETHOD . *&---------------------------------------------------------------------* *& \u83b7\u53d6\u8d22\u52a1\u660e\u7ec6\u6570\u636e *&---------------------------------------------------------------------* METHOD get_detail . LOOP AT mt_config REFERENCE INTO DATA ( lr_config ) GROUP BY ( bukrs = lr_config -> bukrs ) INTO DATA ( ls_config_grp ). \" \u79d1\u76ee\u8303\u56f4 DATA lt_racct_opt TYPE RANGE OF racct . CLEAR lt_racct_opt . LOOP AT GROUP ls_config_grp REFERENCE INTO lr_config . INSERT LINES OF lr_config -> t_racct_opt INTO TABLE lt_racct_opt . ENDLOOP . CHECK lt_racct_opt IS NOT INITIAL . SORT lt_racct_opt . DELETE ADJACENT DUPLICATES FROM lt_racct_opt COMPARING ALL FIELDS . \" TODO \u8d85\u8fc7\u5927\u7ea6\u4e00\u4e07\u884c\u6570\u636e\u5c31\u5e94\u8be5\u5206\u6279\u5904\u7406\u4e86 \" \u9884\u67e5\u8be2\u51fa\u5168\u90e8\u76f8\u5173\u7684\u8d22\u52a1\u6570\u636e SELECT rldnr , rbukrs , gjahr , belnr , docln , ryear , \" \u8d22\u5e74 poper , \" \u671f\u95f4 racct , \" \u4f1a\u8ba1\u79d1\u76ee rcntr , \" \u6210\u672c\u4e2d\u5fc3 prctr , \" \u5229\u6da6\u4e2d\u5fc3 rstgr , \" \u539f\u56e0\u4ee3\u7801 rfarea , \" \u529f\u80fd\u8303\u56f4 rbusa , \" \u4e1a\u52a1\u8303\u56f4 budat , CASE WHEN hsl > 0 THEN 'S' ELSE 'H' END AS shkzg , \" \u501f\u8d37\u6807\u8bc6 hsl FROM acdoca WHERE rldnr = '0L' \" \u4e3b\u8d26\u76ee\u8868\uff0c\u5e94\u8be5\u4e0d\u4f1a\u53d8\u5427\uff1f AND rbukrs = @ ls_config_grp - bukrs AND ryear = @ m_year AND racct IN @ lt_racct_opt APPENDING TABLE @ mt_detail . ENDLOOP . SORT mt_detail BY rldnr rbukrs gjahr belnr docln . ENDMETHOD . *&---------------------------------------------------------------------* *& \u751f\u6210\u62a5\u8868\u884c\u6570\u636e *&---------------------------------------------------------------------* METHOD get_fi_data . IF i_depth > 10 \" \u8fed\u4ee3\u5c42\u7ea7\uff0c\u9632\u6b62\u6808\u6ea2\u51fa OR ir_config IS NOT BOUND \" \u7a7a\u503c\u68c0\u67e5 OR ir_config -> processed IS NOT INITIAL \" \u5904\u7406\u6807\u8bb0\u68c0\u67e5\uff0c\u9632\u6b62\u6b7b\u5faa\u73af\uff0c\u4ee5\u53ca\u8df3\u8fc7\u5197\u4f59\u8ba1\u7b97 . RETURN . ENDIF . \" \u8fdb\u5ea6\u5c55\u793a DATA l_text TYPE string . l_text = | \u6b63\u5728\u5904\u7406\u9879\u76ee[ { ir_config -> zitem } ]: { ir_config -> ztext }|. CALL FUNCTION 'SAPGUI_PROGRESS_INDICATOR' EXPORTING text = l_text . ir_config -> processed = 'P' . \" \u5904\u7406\u4e2d \" \u83b7\u53d6\u5f53\u524d\u914d\u7f6e\u884c\u7684\u6709\u6548\u6570\u636e DATA lt_detail TYPE tt_detail . IF ir_config -> t_racct_opt IS NOT INITIAL . SELECT * FROM @ mt_detail AS ds WHERE rbukrs = @ ir_config -> bukrs AND racct IN @ ir_config -> t_racct_opt \" \u79d1\u76ee INTO TABLE @ lt_detail . ENDIF . \" \u7279\u6b8a\u5904\u7406 LOOP AT ir_config -> t_callback INTO DATA ( ls_callback ). \" \u53c2\u8003\uff1a \" FORM frm_config TABLES ct_detail TYPE tt_detail USING cr_config TYPE REF TO ty_config. PERFORM ( ls_callback - cb_from ) IN PROGRAM ( ls_callback - cb_program ) IF FOUND TABLES lt_detail USING ir_config . ENDLOOP . \" \u9664\u79d1\u76ee\u5916\uff0c\u5176\u4ed6\u7b5b\u9009\u9879\u52a8\u6001\u5904\u7406 IF ir_config -> t_filter IS NOT INITIAL . LOOP AT ir_config -> t_filter INTO DATA ( ls_filter ) WHERE t_range_opt IS NOT INITIAL . IF lt_detail IS NOT INITIAL . DATA ( l_condition ) = |{ ls_filter - name } IN @LS_FILTER-T_RANGE_OPT |. TRY . SELECT * FROM @ lt_detail AS ds WHERE ( l_condition ) INTO TABLE @ lt_detail . CATCH cx_root . ENDTRY . ENDIF . ENDLOOP . ENDIF . \" \u6c47\u603b\u8d22\u52a1\u6570\u636e LOOP AT lt_detail INTO DATA ( ls_detail ). add_hsl ( ir_config = ir_config i_poper = ls_detail - poper i_hsl = ls_detail - hsl ). \" \u5199\u5165\u5230\u660e\u7ec6\u6e05\u5355\u4e2d READ TABLE mt_detail TRANSPORTING NO FIELDS WITH KEY rldnr = ls_detail - rldnr rbukrs = ls_detail - rbukrs gjahr = ls_detail - gjahr belnr = ls_detail - belnr docln = ls_detail - docln BINARY SEARCH . IF sy - subrc = 0 . INSERT CORRESPONDING # ( ls_detail ) INTO TABLE ir_config -> fi_data - t_detail_key . ENDIF . ENDLOOP . \" \u6c47\u603b\u5176\u4ed6\u9879\u7684\u8d22\u52a1\u6570\u636e LOOP AT ir_config -> t_collect INTO DATA ( l_other_zitem ). READ TABLE mt_config TRANSPORTING NO FIELDS WITH KEY \" \u5d4c\u5957\u5faa\u73af\u4f18\u5316 bukrs = ir_config -> bukrs zitem = l_other_zitem BINARY SEARCH . IF sy - subrc = 0 . LOOP AT mt_config REFERENCE INTO DATA ( lr_config ) FROM sy - tabix . IF lr_config -> bukrs <> ir_config -> bukrs OR lr_config -> zitem <> l_other_zitem . EXIT . ENDIF . get_fi_data ( ir_config = lr_config i_depth = i_depth + 1 ). \" \u9012\u5f52\u53d6\u503c ir_config -> fi_data - year_begin = ir_config -> fi_data - year_begin + lr_config -> fi_data - year_begin . \" \u5e74\u521d\u4f59\u989d ir_config -> fi_data - period_01 = ir_config -> fi_data - period_01 + lr_config -> fi_data - period_01 . \" 01\u6708\u4f59\u989d ir_config -> fi_data - period_02 = ir_config -> fi_data - period_02 + lr_config -> fi_data - period_02 . \" 02\u6708\u4f59\u989d ir_config -> fi_data - period_03 = ir_config -> fi_data - period_03 + lr_config -> fi_data - period_03 . \" 03\u6708\u4f59\u989d ir_config -> fi_data - period_04 = ir_config -> fi_data - period_04 + lr_config -> fi_data - period_04 . \" 04\u6708\u4f59\u989d ir_config -> fi_data - period_05 = ir_config -> fi_data - period_05 + lr_config -> fi_data - period_05 . \" 05\u6708\u4f59\u989d ir_config -> fi_data - period_06 = ir_config -> fi_data - period_06 + lr_config -> fi_data - period_06 . \" 06\u6708\u4f59\u989d ir_config -> fi_data - period_07 = ir_config -> fi_data - period_07 + lr_config -> fi_data - period_07 . \" 07\u6708\u4f59\u989d ir_config -> fi_data - period_08 = ir_config -> fi_data - period_08 + lr_config -> fi_data - period_08 . \" 08\u6708\u4f59\u989d ir_config -> fi_data - period_09 = ir_config -> fi_data - period_09 + lr_config -> fi_data - period_09 . \" 09\u6708\u4f59\u989d ir_config -> fi_data - period_10 = ir_config -> fi_data - period_10 + lr_config -> fi_data - period_10 . \" 10\u6708\u4f59\u989d ir_config -> fi_data - period_11 = ir_config -> fi_data - period_11 + lr_config -> fi_data - period_11 . \" 11\u6708\u4f59\u989d ir_config -> fi_data - period_12 = ir_config -> fi_data - period_12 + lr_config -> fi_data - period_12 . \" 12\u6708\u4f59\u989d ir_config -> fi_data - period_13 = ir_config -> fi_data - period_13 + lr_config -> fi_data - period_13 . \" 13\u6708\u4f59\u989d ir_config -> fi_data - period_14 = ir_config -> fi_data - period_14 + lr_config -> fi_data - period_14 . \" 14\u6708\u4f59\u989d ir_config -> fi_data - period_15 = ir_config -> fi_data - period_15 + lr_config -> fi_data - period_15 . \" 15\u6708\u4f59\u989d ir_config -> fi_data - period_16 = ir_config -> fi_data - period_16 + lr_config -> fi_data - period_16 . \" 16\u6708\u4f59\u989d INSERT LINES OF lr_config -> fi_data - t_detail_key INTO TABLE ir_config -> fi_data - t_detail_key . \" \u660e\u7ec6\u6570\u636e ENDLOOP . ENDIF . ENDLOOP . \" \u53cd\u5411\u6807\u8bb0 IF ir_config -> reverse IS NOT INITIAL . ir_config -> fi_data - year_begin = 0 - ir_config -> fi_data - year_begin . \" \u5e74\u521d\u4f59\u989d ir_config -> fi_data - period_01 = 0 - ir_config -> fi_data - period_01 . \" 01\u6708\u4f59\u989d ir_config -> fi_data - period_02 = 0 - ir_config -> fi_data - period_02 . \" 02\u6708\u4f59\u989d ir_config -> fi_data - period_03 = 0 - ir_config -> fi_data - period_03 . \" 03\u6708\u4f59\u989d ir_config -> fi_data - period_04 = 0 - ir_config -> fi_data - period_04 . \" 04\u6708\u4f59\u989d ir_config -> fi_data - period_05 = 0 - ir_config -> fi_data - period_05 . \" 05\u6708\u4f59\u989d ir_config -> fi_data - period_06 = 0 - ir_config -> fi_data - period_06 . \" 06\u6708\u4f59\u989d ir_config -> fi_data - period_07 = 0 - ir_config -> fi_data - period_07 . \" 07\u6708\u4f59\u989d ir_config -> fi_data - period_08 = 0 - ir_config -> fi_data - period_08 . \" 08\u6708\u4f59\u989d ir_config -> fi_data - period_09 = 0 - ir_config -> fi_data - period_09 . \" 09\u6708\u4f59\u989d ir_config -> fi_data - period_10 = 0 - ir_config -> fi_data - period_10 . \" 10\u6708\u4f59\u989d ir_config -> fi_data - period_11 = 0 - ir_config -> fi_data - period_11 . \" 11\u6708\u4f59\u989d ir_config -> fi_data - period_12 = 0 - ir_config -> fi_data - period_12 . \" 12\u6708\u4f59\u989d ir_config -> fi_data - period_13 = 0 - ir_config -> fi_data - period_13 . \" 13\u6708\u4f59\u989d ir_config -> fi_data - period_14 = 0 - ir_config -> fi_data - period_14 . \" 14\u6708\u4f59\u989d ir_config -> fi_data - period_15 = 0 - ir_config -> fi_data - period_15 . \" 15\u6708\u4f59\u989d ir_config -> fi_data - period_16 = 0 - ir_config -> fi_data - period_16 . \" 16\u6708\u4f59\u989d ENDIF . ir_config -> processed = 'X' . \" \u5904\u7406\u5b8c\u6210 ENDMETHOD . *&---------------------------------------------------------------------* *& \u4eceSMW0\u83b7\u53d6\u6a21\u677f\u6587\u4ef6 *&---------------------------------------------------------------------* METHOD get_smw0_templete . DATA : lt_mime TYPE STANDARD TABLE OF w3mime , ls_id TYPE wwwdataid , ls_key TYPE wwwdatatab . ls_key - relid = 'MI' . ls_key - objid = i_objid . CALL FUNCTION 'WWWDATA_IMPORT' EXPORTING key = ls_key TABLES mime = lt_mime EXCEPTIONS wrong_object_type = 1 import_error = 2 OTHERS = 3 . IF sy - subrc <> 0 . MESSAGE | \u6a21\u677f[ { i_objid } ]\u83b7\u53d6\u5931\u8d25 | TYPE 'S' DISPLAY LIKE 'E' . RETURN . ENDIF . SELECT SINGLE value FROM wwwparams WHERE relid = @ ls_key - relid AND objid = @ ls_key - objid AND name EQ 'filesize' INTO @ DATA ( l_param ). DATA l_length TYPE i . l_length = l_param . CALL FUNCTION 'SCMS_BINARY_TO_XSTRING' EXPORTING input_length = l_length IMPORTING buffer = r_buffer TABLES binary_tab = lt_mime EXCEPTIONS failed = 1 OTHERS = 2 . IF sy - subrc <> 0 . CLEAR r_buffer . ENDIF . ENDMETHOD . *&---------------------------------------------------------------------* *& \u66ff\u6362\u6a21\u677f\u6587\u4ef6\u4e2d\u7684\u6587\u672c\u5185\u5bb9 *&---------------------------------------------------------------------* METHOD replace_texts . \" \u7a0b\u5e8f\u8981\u6c42IT_REPLACE\u81f3\u5c11\u4e24\u5217\uff0c\u4ee3\u7801\u4f1a\u5c06\u5de6\u5217\u5185\u5bb9\u66ff\u6362\u4e3a\u53f3\u5217\u5185\u5bb9 CHECK it_replace IS NOT INITIAL . CHECK c_doc IS NOT INITIAL . FIELD-SYMBOLS <fs_replace_t> TYPE ANY TABLE . FIELD-SYMBOLS <fs_replace> TYPE any . FIELD-SYMBOLS <fs_from> TYPE any . FIELD-SYMBOLS <fs_to> TYPE any . TRY . DATA ( lo_doc ) = cl_xlsx_document => load_document ( c_doc ). DATA ( lo_workbook_part ) = lo_doc -> get_workbookpart ( ). DATA ( lo_sharedstrings_part ) = lo_workbook_part -> get_sharedstringspart ( ). DATA ( l_sharedstrings_xml ) = lo_sharedstrings_part -> get_data ( ). DATA ( l_sharedstrings_str ) = cl_openxml_helper => xstring_to_string ( l_sharedstrings_xml ). ASSIGN it_replace TO <fs_replace_t> . LOOP AT <fs_replace_t> ASSIGNING <fs_replace> . ASSIGN COMPONENT 1 OF STRUCTURE <fs_replace> TO <fs_from> . ASSIGN COMPONENT 2 OF STRUCTURE <fs_replace> TO <fs_to> . IF <fs_from> IS ASSIGNED AND <fs_to> IS ASSIGNED . IF <fs_from> IS NOT INITIAL . REPLACE ALL OCCURRENCES OF <fs_from> IN l_sharedstrings_str WITH <fs_to> IN CHARACTER MODE . ENDIF . ENDIF . UNASSIGN <fs_from> . UNASSIGN <fs_to> . ENDLOOP . l_sharedstrings_xml = cl_openxml_helper => string_to_xstring ( l_sharedstrings_str ). lo_sharedstrings_part -> feed_data ( l_sharedstrings_xml ). c_doc = lo_doc -> get_package_data ( ). CATCH cx_openxml_not_found cx_openxml_format cx_openxml_not_allowed INTO DATA ( lx_openxml ). MESSAGE lx_openxml -> get_text ( ) TYPE 'S' DISPLAY LIKE 'E' . CATCH cx_root INTO DATA ( lx_root ). MESSAGE lx_root -> get_text ( ) TYPE 'S' DISPLAY LIKE 'E' . ENDTRY . ENDMETHOD . *&---------------------------------------------------------------------* *& \u6dfb\u52a0\u91d1\u989d\u5230\u5bf9\u5e94\u671f\u95f4 *&---------------------------------------------------------------------* METHOD add_hsl . CASE i_poper . WHEN 0 . ir_config -> fi_data - year_begin += i_hsl . WHEN 1 . ir_config -> fi_data - period_01 += i_hsl . WHEN 2 . ir_config -> fi_data - period_02 += i_hsl . WHEN 3 . ir_config -> fi_data - period_03 += i_hsl . WHEN 4 . ir_config -> fi_data - period_04 += i_hsl . WHEN 5 . ir_config -> fi_data - period_05 += i_hsl . WHEN 6 . ir_config -> fi_data - period_06 += i_hsl . WHEN 7 . ir_config -> fi_data - period_07 += i_hsl . WHEN 8 . ir_config -> fi_data - period_08 += i_hsl . WHEN 9 . ir_config -> fi_data - period_09 += i_hsl . WHEN 10 . ir_config -> fi_data - period_10 += i_hsl . WHEN 11 . ir_config -> fi_data - period_11 += i_hsl . WHEN 12 . ir_config -> fi_data - period_12 += i_hsl . WHEN 13 . ir_config -> fi_data - period_13 += i_hsl . WHEN 14 . ir_config -> fi_data - period_14 += i_hsl . WHEN 15 . ir_config -> fi_data - period_15 += i_hsl . WHEN 16 . ir_config -> fi_data - period_16 += i_hsl . WHEN OTHERS . ENDCASE . ENDMETHOD . ENDCLASS . *&---------------------------------------------------------------------* *& \u56de\u8c03\u53c2\u8003\u65b9\u6cd5 *&---------------------------------------------------------------------* FORM frm_config_sample TABLES ct_detail TYPE tt_detail USING cr_config TYPE REF TO ty_config . ENDFORM .","title":"Include\u6587\u4ef6"},{"location":"fico/fi_report_bs/","text":"\u8d44\u4ea7\u8d1f\u503a\u8868 \u00b6 \u8d44\u4ea7\u8d1f\u503a\u8868\u662f \u8d22\u52a1\u53d6\u503c\u6a21\u5757 \u7684\u4e00\u4e2a\u5b9e\u4f8b\u3002\u4e0b\u9762\u4ee3\u7801\u4f7f\u7528\u7684\u914d\u7f6e\u8868\u53ef\u53c2\u8003 \u9875\u9762 \u3002 \u793a\u4f8b\u4ee3\u7801 REPORT zfi_balance . *&---------------------------------------------------------------------* *& Include zfi_balance_top *&---------------------------------------------------------------------* TYPES : BEGIN OF ty_data , bukrs TYPE bukrs , gjahr TYPE gjahr , monat TYPE monat , field1 TYPE string , \" \u8d44\u4ea7 field2 TYPE string , \" \u884c\u6b21 field3 TYPE string , \" \u671f\u672b\u4f59\u989d field4 TYPE string , \" \u5e74\u521d\u4f59\u989d field5 TYPE string , \" \u8d1f\u503a\u548c\u6240\u6709\u8005\u6743\u76ca field6 TYPE string , \" \u884c\u6b21 field7 TYPE string , \" \u671f\u672b\u4f59\u989d field8 TYPE string , \" \u5e74\u521d\u4f59\u989d END OF ty_data . TYPES tt_data TYPE STANDARD TABLE OF ty_data . DATA gt_data TYPE tt_data . DATA gt_bukrs TYPE STANDARD TABLE OF bukrs WITH EMPTY KEY . *&---------------------------------------------------------------------* *& Include zfi_balance_sel *&---------------------------------------------------------------------* TABLES t001 . SELECT-OPTIONS s_bukrs FOR t001 - bukrs NO-EXTENSION NO INTERVALS OBLIGATORY . PARAMETERS p_gjahr TYPE gjahr OBLIGATORY DEFAULT sy - datum ( 4 ). PARAMETERS p_monat TYPE monat OBLIGATORY DEFAULT sy - datum + 4 ( 2 ). *&---------------------------------------------------------------------* *& Include zfir001_frm *&---------------------------------------------------------------------* *&---------------------------------------------------------------------* *& Form frm_main *&---------------------------------------------------------------------* *& \u62a5\u8868\u7a0b\u5e8f\u5165\u53e3 *&---------------------------------------------------------------------* FORM frm_main . PERFORM frm_auth_check . IF gt_bukrs IS INITIAL . RETURN . ENDIF . PERFORM frm_gen_balance_sheet . \" \u8d44\u4ea7\u8d1f\u503a\u8868 PERFORM frm_display TABLES gt_data . \" \u5c55\u793a ENDFORM . *&---------------------------------------------------------------------* *& Form frm_auth_check *&---------------------------------------------------------------------* *& \u6743\u9650\u68c0\u67e5 *&---------------------------------------------------------------------* FORM frm_auth_check . DATA lt_bukrs_opt TYPE RANGE OF bukrs . SELECT 'I' AS sign , 'EQ' AS option , bukrs AS low FROM t001 WHERE bukrs IN @ s_bukrs INTO TABLE @ lt_bukrs_opt . IF lt_bukrs_opt IS INITIAL . l_subrc = 1 . l_msg = | \u516c\u53f8\u4e0d\u5b58\u5728 |. ENDIF . SORT lt_bukrs_opt . DELETE ADJACENT DUPLICATES FROM lt_bukrs_opt COMPARING ALL FIELDS . LOOP AT lt_bukrs_opt INTO DATA ( ls_bukrs_opt ). AUTHORITY-CHECK OBJECT 'F_BKPF_BUK' ID 'BUKRS' FIELD ls_bukrs_opt - low ID 'ACTVT' FIELD i_actvt . IF sy - subrc <> 0 . MESSAGE | \u65e0\u516c\u53f8 { ls_bukrs_opt - low } \u6743\u9650 | TYPE 'S' DISPLAY LIKE 'E' . DELETE lt_bukrs_opt . ENDIF . ENDLOOP . s_bukrs[] = lt_bukrs_opt . IF s_bukrs[] IS INITIAL . LEAVE LIST - PROCESSING . ENDIF . SELECT bukrs FROM t001 WHERE bukrs IN @ s_bukrs INTO TABLE @ gt_bukrs . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_get_config *&---------------------------------------------------------------------* *& \u8bfb\u53d6\u5168\u90e8\u516c\u53f8\u914d\u7f6e *&---------------------------------------------------------------------* FORM frm_get_config_all TABLES et_config TYPE tt_config . DATA lt_config TYPE tt_config . LOOP AT gt_bukrs INTO DATA ( l_bukrs ). PERFORM frm_get_config TABLES lt_config USING '1' \" \u8d44\u4ea7\u8d1f\u503a\u8868 l_bukrs . INSERT LINES OF lt_config INTO TABLE et_config . ENDLOOP . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_get_config *&---------------------------------------------------------------------* *& \u8bfb\u53d6\u5355\u4e2a\u516c\u53f8\u914d\u7f6e *&---------------------------------------------------------------------* FORM frm_get_config TABLES et_config TYPE tt_config USING i_fi_report TYPE string i_bukrs TYPE bukrs . \" \u8003\u8651\u9002\u914d\u7b26 DATA lt_bukrs_opt TYPE RANGE OF bukrs . lt_bukrs_opt = VALUE # ( sign = 'I' option = 'EQ' ( low = i_bukrs ) ( low = |{ i_bukrs ( 3 ) } * | ) ( low = |{ i_bukrs ( 2 ) } * | ) ( low = |{ i_bukrs ( 1 ) } * | ) ( low = '*' ) ( low = '' ) ). \" \u53d6\u914d\u7f6e\u6570\u636e SELECT * FROM zfit0001 WHERE zfi_report = @ i_fi_report AND bukrs IN @ lt_bukrs_opt INTO TABLE @ DATA ( lt_zfit0001 ). \" \u89e3\u6790\u914d\u7f6e\u6570\u636e LOOP AT lt_zfit0001 INTO DATA ( ls_zfit0001 ). DATA ls_config TYPE ty_config . CLEAR ls_config . ls_config - bukrs = ls_zfit0001 - bukrs . \" \u516c\u53f8 ls_config - zitem = ls_zfit0001 - zitem . \" \u9879\u76ee ls_config - zitem_sub = ls_zfit0001 - zitem_sub . \" \u5b50\u9879\u76ee CASE ls_zfit0001 - ztype . WHEN '0' . \" \u6587\u672c\u9879 ls_config - ztext = ls_zfit0001 - ztext . \" \u9879\u76ee\u540d\u79f0 WHEN '1' . \" \u7b5b\u9009\u9879 \" \u79d1\u76ee IF ls_zfit0001 - racct_to IS NOT INITIAL . INSERT VALUE # ( sign = 'I' option = 'BT' low = ls_zfit0001 - racct_from high = ls_zfit0001 - racct_to ) INTO TABLE ls_config - t_racct_opt . ELSE . INSERT VALUE # ( sign = 'I' option = 'EQ' low = ls_zfit0001 - racct_from ) INTO TABLE ls_config - t_racct_opt . ENDIF . \" \u539f\u56e0\u4ee3\u7801 INSERT VALUE # ( name = 'RSTGR' \" TY_DATEIL\u5b57\u6bb5\u540d\uff0c\u540e\u7eed\u52a8\u6001\u7b5b\u9009 t_range_opt = VALUE # ( ( sign = 'I' option = 'EQ' low = ls_zfit0001 - rstgr ) ) ) INTO TABLE ls_config - t_filter . \" \u529f\u80fd\u8303\u56f4 INSERT VALUE # ( name = 'RFAREA' \" TY_DATEIL\u5b57\u6bb5\u540d\uff0c\u540e\u7eed\u52a8\u6001\u7b5b\u9009 t_range_opt = VALUE # ( ( sign = 'I' option = 'EQ' low = ls_zfit0001 - rfarea ) ) ) INTO TABLE ls_config - t_filter . WHEN '2' . \" \u6c47\u603b\u9879 IF ls_zfit0001 - zitem_to IS INITIAL OR ls_zfit0001 - zitem_to = '' . ls_zfit0001 - zitem_to = ls_zfit0001 - zitem_from . ENDIF . WHILE ls_zfit0001 - zitem_from <= ls_zfit0001 - zitem_to . INSERT ls_zfit0001 - zitem_from INTO TABLE ls_config - t_collect . ls_zfit0001 - zitem_from = ls_zfit0001 - zitem_from + 1 . ENDWHILE . ls_config - zreverse = ls_zfit0001 - zreverse . \" \u53cd\u5411\u6807\u8bc6 WHEN OTHERS . ENDCASE . \" CASE ls_zfit0001-ztype INSERT ls_config INTO TABLE et_config . ENDLOOP . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_gen_balance_sheet *&---------------------------------------------------------------------* *& \u751f\u6210\u8d44\u4ea7\u8d1f\u503a\u8868 *&---------------------------------------------------------------------* FORM frm_gen_balance_sheet . DATA lt_config TYPE tt_config . PERFORM frm_get_config_all TABLES lt_config . \" \u83b7\u53d6\u914d\u7f6e\u6570\u636e \" \u6839\u636e\u914d\u7f6e\u6570\u636e\u751f\u6210\u8d22\u52a1\u62a5\u8868\u6570\u636e\u9879 DATA ( lt_fi_data ) = lcl_fi_report => create ( i_year = p_gjahr i_period = p_monat it_config = lt_config ) -> execute ( ). SORT lt_fi_data BY bukrs year period zitem . \" \u627e\u5230\u8d44\u4ea7\u603b\u8ba1\u884c\uff0c\u7528\u4e8e\u5212\u5206\u4e24\u5217 DATA l_lines TYPE i . LOOP AT lt_fi_data REFERENCE INTO DATA ( lr_fi_data ). l_lines = sy - tabix . IF lr_fi_data -> ztext CS '\u8d44\u4ea7\u603b\u8ba1' . EXIT . ENDIF . ENDLOOP . DATA lt_data TYPE tt_data . DATA ls_data TYPE ty_data . LOOP AT gt_bukrs INTO DATA ( l_bukrs ). CLEAR lt_data . DO l_lines TIMES . CLEAR ls_data . ls_data - bukrs = l_bukrs . ls_data - gjahr = p_gjahr . ls_data - monat = p_monat . ls_data - field2 = sy - index . \" \u8d44\u4ea7\u5217\u884c\u6b21 READ TABLE lt_fi_data REFERENCE INTO lr_fi_data WITH KEY bukrs = l_bukrs year = p_gjahr period = p_monat zitem = ls_data - field2 BINARY SEARCH . IF sy - subrc = 0 . ls_data - field1 = lr_fi_data -> ztext . ls_data - field3 = |{ lr_fi_data -> period_total NUMBER = USER DECIMALS = 2 }|. ls_data - field4 = |{ lr_fi_data -> year_begin NUMBER = USER DECIMALS = 2 }|. ENDIF . ls_data - field6 = sy - index + l_lines . \" \u8d1f\u503a\u548c\u6240\u6709\u8005\u6743\u76ca\u5217\u884c\u6b21 READ TABLE lt_fi_data REFERENCE INTO lr_fi_data WITH KEY bukrs = l_bukrs year = p_gjahr period = p_monat zitem = ls_data - field6 BINARY SEARCH . IF sy - subrc = 0 . ls_data - field5 = lr_fi_data -> ztext . ls_data - field7 = |{ lr_fi_data -> period_total NUMBER = USER DECIMALS = 2 }|. ls_data - field8 = |{ lr_fi_data -> year_begin NUMBER = USER DECIMALS = 2 }|. ENDIF . INSERT ls_data INTO TABLE gt_data . ENDDO . ENDLOOP . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_export *&---------------------------------------------------------------------* *& \u5bfc\u51fa\u5230\u672c\u5730 *&---------------------------------------------------------------------* FORM frm_export . TYPES : BEGIN OF ty_replace , from TYPE string , to TYPE string , END OF ty_replace . TYPES tt_replace TYPE STANDARD TABLE OF ty_replace WITH EMPTY KEY . DATA lt_replace TYPE tt_replace . DATA ls_replace TYPE ty_replace . \" \u83b7\u53d6\u4e0b\u8f7d\u76ee\u5f55 DATA l_directory TYPE string . cl_gui_frontend_services => directory_browse ( CHANGING selected_folder = l_directory EXCEPTIONS cntl_error = 1 error_no_gui = 2 not_supported_by_gui = 3 ). IF sy - subrc <> 0 . MESSAGE ID sy - msgid TYPE sy - msgty NUMBER sy - msgno WITH sy - msgv1 sy - msgv2 sy - msgv3 sy - msgv4 . ENDIF . DATA ( l_buffer ) = lcl_fi_report => get_smw0_templete ( CONV # ( sy - tcode ) ). \" \u83b7\u53d6SMW0\u6a21\u677f\u6587\u4ef6 CHECK l_buffer IS NOT INITIAL . \" \u9010\u516c\u53f8\u5904\u7406 LOOP AT gt_data INTO DATA ( ls_data ) GROUP BY ( bukrs = ls_data - bukrs gjahr = ls_data - gjahr monat = ls_data - monat ) INTO DATA ( ls_data_grp ). SELECT SINGLE butxt FROM t001 WHETE bukrs = @ ls_data_grp - bukrs INTO @ DATA ( l_butxt ). \" \u7f16\u5236\u5355\u4f4d CLEAR ls_replace . ls_replace - from = | __BUKRS__ |. ls_replace - to = l_butxt . INSERT ls_replace INTO TABLE lt_replace . \" \u6253\u5370\u65e5\u671f CLEAR ls_replace . ls_replace - from = | __ZDATE__ |. ls_replace - to = |{ sy - datum ( 4 ) } \u5e74 { sy - datum + 4 ( 2 ) } \u6708 { sy - datum + 6 ( 2 ) } \u65e5 |. INSERT ls_replace INTO TABLE lt_replace . LOOP AT GROUP ls_data_grp INTO ls_data . \" \u8d44\u4ea7-\u671f\u672b\u4f59\u989d CLEAR ls_replace . ls_replace - from = | __PEROID_END_Z { ls_data - field2 } __ |. ls_replace - to = ls_data - field3 . INSERT ls_replace INTO TABLE lt_replace . \" \u8d44\u4ea7-\u5e74\u521d\u4f59\u989d CLEAR ls_replace . ls_replace - from = | __YEAR_BEGIN_Z { ls_data - field2 } __ |. ls_replace - to = ls_data - field4 . INSERT ls_replace INTO TABLE lt_replace . \" \u635f\u76ca-\u671f\u672b\u4f59\u989d CLEAR ls_replace . ls_replace - from = | __PEROID_END_Z { ls_data - field6 } __ |. ls_replace - to = ls_data - field7 . INSERT ls_replace INTO TABLE lt_replace . \" \u635f\u76ca-\u5e74\u521d\u4f59\u989d CLEAR ls_replace . ls_replace - from = | __YEAR_BEGIN_Z { ls_data - field6 } __ |. ls_replace - to = ls_data - field8 . INSERT ls_replace INTO TABLE lt_replace . ENDLOOP . \" \u66ff\u6362\u6587\u672c\u5185\u5bb9 DATA ( l_doc ) = l_buffer . lcl_fi_report => replace_texts ( EXPORTING it_replace = lt_replace CHANGING c_doc = l_doc ). CHECK l_doc IS NOT INITIAL . \" \u4e0b\u8f7d\u5230\u672c\u5730 TRY . DATA ( l_filename ) = |{ l_directory } \\\\\u8d44\u4ea7\u8d1f\u503a\u8868_ { l_bukrs_name } _ { sy - datum } .xlsx |. cl_openxml_helper => store_local_file ( im_file_name = l_filename im_data = l_doc ). CATCH cx_openxml_not_found cx_openxml_format cx_openxml_not_allowed INTO DATA ( lx_openxml ). MESSAGE lx_openxml -> get_text ( ) TYPE 'S' DISPLAY LIKE 'E' . RETURN . ENDTRY . ENDLOOP . ENDFORM . *&---------------------------------------------------------------------* *& Include zfi_balance_alv *&---------------------------------------------------------------------* *&---------------------------------------------------------------------* *& Form frm_display *&---------------------------------------------------------------------* *& ALV\u5c55\u793a *&---------------------------------------------------------------------* FORM frm_display TABLES ct_data TYPE STANDARD TABLE . DATA ls_layout TYPE lvc_s_layo . DATA lt_fieldcat TYPE STANDARD TABLE OF lvc_s_fcat . PERFORM frm_set_layout CHANGING ls_layout . PERFORM frm_set_fieldcat TABLES lt_fieldcat . CALL FUNCTION 'REUSE_ALV_GRID_DISPLAY_LVC' EXPORTING i_callback_program = sy - repid * i_callback_pf_status_set = 'FRM_PF_STATUS' * i_callback_user_command = 'FRM_USER_COMMAND' is_layout_lvc = ls_layout it_fieldcat_lvc = lt_fieldcat i_default = abap_true i_save = 'A' TABLES t_outtab = ct_data[] EXCEPTIONS program_error = 1 OTHERS = 2 . IF sy - subrc <> 0 . MESSAGE ID sy - msgid TYPE sy - msgty NUMBER sy - msgno WITH sy - msgv1 sy - msgv2 sy - msgv3 sy - msgv4 . ENDIF . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_set_layout *&---------------------------------------------------------------------* *& \u62a5\u8868\u5e03\u5c40\u8bbe\u7f6e *&---------------------------------------------------------------------* FORM frm_set_layout CHANGING cs_layout TYPE lvc_s_layo . CLEAR cs_layout . cs_layout - zebra = abap_true . \" \u6591\u9a6c\u7ebf cs_layout - cwidth_opt = abap_true . \" \u81ea\u52a8\u8c03\u6574ALVL\u5217\u5bbd cs_layout - sel_mode = 'A' . \" \u9009\u62e9\u6a21\u5f0f * cs_layout-ctab_fname = 'COLTAB'. \" \u5355\u5143\u683c\u989c\u8272\u8bbe\u7f6e ENDFORM . *&---------------------------------------------------------------------* *& Form frm_set_fieldcat *&---------------------------------------------------------------------* *& \u5b57\u6bb5\u76ee\u5f55\u8bbe\u7f6e *&---------------------------------------------------------------------* FORM frm_set_fieldcat TABLES ct_fieldcat TYPE lvc_t_fcat . DATA ls_fieldcat TYPE lvc_s_fcat . DEFINE _init_fieldcat . CLEAR ls_fieldcat . ls_fieldcat - fieldname = &1 . ls_fieldcat - tooltip = ls_fieldcat - coltext = ls_fieldcat - seltext = ls_fieldcat - scrtext_l = ls_fieldcat - scrtext_m = ls_fieldcat - scrtext_s = &2 . ls_fieldcat - ref_table = &3 . ls_fieldcat - ref_field = &4 . INSERT ls_fieldcat INTO TABLE ct_fieldcat . END-OF-DEFINITION . _init_fieldcat 'FIELD1' '\u8d44\u4ea7' '' '' . _init_fieldcat 'FIELD2' '\u884c\u6b21' '' '' . _init_fieldcat 'FIELD3' '\u671f\u672b\u4f59\u989d' '' '' . _init_fieldcat 'FIELD4' '\u5e74\u521d\u4f59\u989d' '' '' . _init_fieldcat 'FIELD5' '\u8d1f\u503a\u548c\u6240\u6709\u8005\u6743\u76ca' '' '' . _init_fieldcat 'FIELD6' '\u884c\u6b21' '' '' . _init_fieldcat 'FIELD7' '\u671f\u672b\u4f59\u989d' '' '' . _init_fieldcat 'FIELD8' '\u5e74\u521d\u4f59\u989d' '' '' . \" \u4e2a\u6027\u5316\u81ea\u5df1\u8f93\u51fa\u6570\u636e\u683c\u5f0f LOOP AT ct_fieldcat REFERENCE INTO DATA ( lr_fieldcat ). \" \u5b57\u6bb5\u663e\u793a\u5c5e\u6027\u8bbe\u7f6e CASE lr_fieldcat -> fieldname . WHEN OTHERS . ENDCASE . ENDLOOP . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_pf_status *&---------------------------------------------------------------------* *& \u8bbe\u7f6eGUI\u72b6\u6001 *&---------------------------------------------------------------------* FORM frm_pf_status USING ct_extab TYPE slis_t_extab . SET PF-STATUS 'STATUS' . SET TITLEBAR 'TITLE' . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_user_command *&---------------------------------------------------------------------* *& \u529f\u80fd\u54cd\u5e94 *&---------------------------------------------------------------------* FORM frm_user_command USING cv_ucomm LIKE sy - ucomm cs_selfield TYPE slis_selfield . \" \u5237\u65b0\u5c4f\u5e55\u6570\u636e\u5230\u5185\u8868 DATA : lo_grid TYPE REF TO cl_gui_alv_grid . CALL FUNCTION 'GET_GLOBALS_FROM_SLVC_FULLSCR' IMPORTING e_grid = lo_grid . CALL METHOD lo_grid -> check_changed_data . \" \u6309\u94ae\u529f\u80fd\u5b9e\u73b0 CASE cv_ucomm . WHEN '&IC1' . \" \u53cc\u51fb WHEN 'ZEXPORT' . \" \u5bfc\u51fa PERFORM frm_export . WHEN OTHERS . ENDCASE . \" \u5237\u65b0ALV \u663e\u793a\u503c cs_selfield - refresh = abap_true . cs_selfield - row_stable = abap_true . cs_selfield - col_stable = abap_true . ENDFORM . *&---------------------------------------------------------------------* *& START-OF-SELECTION *&---------------------------------------------------------------------* START-OF-SELECTION . PERFORM frm_main .","title":"\u8d44\u4ea7\u8d1f\u503a\u8868"},{"location":"fico/fi_report_bs/#_1","text":"\u8d44\u4ea7\u8d1f\u503a\u8868\u662f \u8d22\u52a1\u53d6\u503c\u6a21\u5757 \u7684\u4e00\u4e2a\u5b9e\u4f8b\u3002\u4e0b\u9762\u4ee3\u7801\u4f7f\u7528\u7684\u914d\u7f6e\u8868\u53ef\u53c2\u8003 \u9875\u9762 \u3002 \u793a\u4f8b\u4ee3\u7801 REPORT zfi_balance . *&---------------------------------------------------------------------* *& Include zfi_balance_top *&---------------------------------------------------------------------* TYPES : BEGIN OF ty_data , bukrs TYPE bukrs , gjahr TYPE gjahr , monat TYPE monat , field1 TYPE string , \" \u8d44\u4ea7 field2 TYPE string , \" \u884c\u6b21 field3 TYPE string , \" \u671f\u672b\u4f59\u989d field4 TYPE string , \" \u5e74\u521d\u4f59\u989d field5 TYPE string , \" \u8d1f\u503a\u548c\u6240\u6709\u8005\u6743\u76ca field6 TYPE string , \" \u884c\u6b21 field7 TYPE string , \" \u671f\u672b\u4f59\u989d field8 TYPE string , \" \u5e74\u521d\u4f59\u989d END OF ty_data . TYPES tt_data TYPE STANDARD TABLE OF ty_data . DATA gt_data TYPE tt_data . DATA gt_bukrs TYPE STANDARD TABLE OF bukrs WITH EMPTY KEY . *&---------------------------------------------------------------------* *& Include zfi_balance_sel *&---------------------------------------------------------------------* TABLES t001 . SELECT-OPTIONS s_bukrs FOR t001 - bukrs NO-EXTENSION NO INTERVALS OBLIGATORY . PARAMETERS p_gjahr TYPE gjahr OBLIGATORY DEFAULT sy - datum ( 4 ). PARAMETERS p_monat TYPE monat OBLIGATORY DEFAULT sy - datum + 4 ( 2 ). *&---------------------------------------------------------------------* *& Include zfir001_frm *&---------------------------------------------------------------------* *&---------------------------------------------------------------------* *& Form frm_main *&---------------------------------------------------------------------* *& \u62a5\u8868\u7a0b\u5e8f\u5165\u53e3 *&---------------------------------------------------------------------* FORM frm_main . PERFORM frm_auth_check . IF gt_bukrs IS INITIAL . RETURN . ENDIF . PERFORM frm_gen_balance_sheet . \" \u8d44\u4ea7\u8d1f\u503a\u8868 PERFORM frm_display TABLES gt_data . \" \u5c55\u793a ENDFORM . *&---------------------------------------------------------------------* *& Form frm_auth_check *&---------------------------------------------------------------------* *& \u6743\u9650\u68c0\u67e5 *&---------------------------------------------------------------------* FORM frm_auth_check . DATA lt_bukrs_opt TYPE RANGE OF bukrs . SELECT 'I' AS sign , 'EQ' AS option , bukrs AS low FROM t001 WHERE bukrs IN @ s_bukrs INTO TABLE @ lt_bukrs_opt . IF lt_bukrs_opt IS INITIAL . l_subrc = 1 . l_msg = | \u516c\u53f8\u4e0d\u5b58\u5728 |. ENDIF . SORT lt_bukrs_opt . DELETE ADJACENT DUPLICATES FROM lt_bukrs_opt COMPARING ALL FIELDS . LOOP AT lt_bukrs_opt INTO DATA ( ls_bukrs_opt ). AUTHORITY-CHECK OBJECT 'F_BKPF_BUK' ID 'BUKRS' FIELD ls_bukrs_opt - low ID 'ACTVT' FIELD i_actvt . IF sy - subrc <> 0 . MESSAGE | \u65e0\u516c\u53f8 { ls_bukrs_opt - low } \u6743\u9650 | TYPE 'S' DISPLAY LIKE 'E' . DELETE lt_bukrs_opt . ENDIF . ENDLOOP . s_bukrs[] = lt_bukrs_opt . IF s_bukrs[] IS INITIAL . LEAVE LIST - PROCESSING . ENDIF . SELECT bukrs FROM t001 WHERE bukrs IN @ s_bukrs INTO TABLE @ gt_bukrs . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_get_config *&---------------------------------------------------------------------* *& \u8bfb\u53d6\u5168\u90e8\u516c\u53f8\u914d\u7f6e *&---------------------------------------------------------------------* FORM frm_get_config_all TABLES et_config TYPE tt_config . DATA lt_config TYPE tt_config . LOOP AT gt_bukrs INTO DATA ( l_bukrs ). PERFORM frm_get_config TABLES lt_config USING '1' \" \u8d44\u4ea7\u8d1f\u503a\u8868 l_bukrs . INSERT LINES OF lt_config INTO TABLE et_config . ENDLOOP . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_get_config *&---------------------------------------------------------------------* *& \u8bfb\u53d6\u5355\u4e2a\u516c\u53f8\u914d\u7f6e *&---------------------------------------------------------------------* FORM frm_get_config TABLES et_config TYPE tt_config USING i_fi_report TYPE string i_bukrs TYPE bukrs . \" \u8003\u8651\u9002\u914d\u7b26 DATA lt_bukrs_opt TYPE RANGE OF bukrs . lt_bukrs_opt = VALUE # ( sign = 'I' option = 'EQ' ( low = i_bukrs ) ( low = |{ i_bukrs ( 3 ) } * | ) ( low = |{ i_bukrs ( 2 ) } * | ) ( low = |{ i_bukrs ( 1 ) } * | ) ( low = '*' ) ( low = '' ) ). \" \u53d6\u914d\u7f6e\u6570\u636e SELECT * FROM zfit0001 WHERE zfi_report = @ i_fi_report AND bukrs IN @ lt_bukrs_opt INTO TABLE @ DATA ( lt_zfit0001 ). \" \u89e3\u6790\u914d\u7f6e\u6570\u636e LOOP AT lt_zfit0001 INTO DATA ( ls_zfit0001 ). DATA ls_config TYPE ty_config . CLEAR ls_config . ls_config - bukrs = ls_zfit0001 - bukrs . \" \u516c\u53f8 ls_config - zitem = ls_zfit0001 - zitem . \" \u9879\u76ee ls_config - zitem_sub = ls_zfit0001 - zitem_sub . \" \u5b50\u9879\u76ee CASE ls_zfit0001 - ztype . WHEN '0' . \" \u6587\u672c\u9879 ls_config - ztext = ls_zfit0001 - ztext . \" \u9879\u76ee\u540d\u79f0 WHEN '1' . \" \u7b5b\u9009\u9879 \" \u79d1\u76ee IF ls_zfit0001 - racct_to IS NOT INITIAL . INSERT VALUE # ( sign = 'I' option = 'BT' low = ls_zfit0001 - racct_from high = ls_zfit0001 - racct_to ) INTO TABLE ls_config - t_racct_opt . ELSE . INSERT VALUE # ( sign = 'I' option = 'EQ' low = ls_zfit0001 - racct_from ) INTO TABLE ls_config - t_racct_opt . ENDIF . \" \u539f\u56e0\u4ee3\u7801 INSERT VALUE # ( name = 'RSTGR' \" TY_DATEIL\u5b57\u6bb5\u540d\uff0c\u540e\u7eed\u52a8\u6001\u7b5b\u9009 t_range_opt = VALUE # ( ( sign = 'I' option = 'EQ' low = ls_zfit0001 - rstgr ) ) ) INTO TABLE ls_config - t_filter . \" \u529f\u80fd\u8303\u56f4 INSERT VALUE # ( name = 'RFAREA' \" TY_DATEIL\u5b57\u6bb5\u540d\uff0c\u540e\u7eed\u52a8\u6001\u7b5b\u9009 t_range_opt = VALUE # ( ( sign = 'I' option = 'EQ' low = ls_zfit0001 - rfarea ) ) ) INTO TABLE ls_config - t_filter . WHEN '2' . \" \u6c47\u603b\u9879 IF ls_zfit0001 - zitem_to IS INITIAL OR ls_zfit0001 - zitem_to = '' . ls_zfit0001 - zitem_to = ls_zfit0001 - zitem_from . ENDIF . WHILE ls_zfit0001 - zitem_from <= ls_zfit0001 - zitem_to . INSERT ls_zfit0001 - zitem_from INTO TABLE ls_config - t_collect . ls_zfit0001 - zitem_from = ls_zfit0001 - zitem_from + 1 . ENDWHILE . ls_config - zreverse = ls_zfit0001 - zreverse . \" \u53cd\u5411\u6807\u8bc6 WHEN OTHERS . ENDCASE . \" CASE ls_zfit0001-ztype INSERT ls_config INTO TABLE et_config . ENDLOOP . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_gen_balance_sheet *&---------------------------------------------------------------------* *& \u751f\u6210\u8d44\u4ea7\u8d1f\u503a\u8868 *&---------------------------------------------------------------------* FORM frm_gen_balance_sheet . DATA lt_config TYPE tt_config . PERFORM frm_get_config_all TABLES lt_config . \" \u83b7\u53d6\u914d\u7f6e\u6570\u636e \" \u6839\u636e\u914d\u7f6e\u6570\u636e\u751f\u6210\u8d22\u52a1\u62a5\u8868\u6570\u636e\u9879 DATA ( lt_fi_data ) = lcl_fi_report => create ( i_year = p_gjahr i_period = p_monat it_config = lt_config ) -> execute ( ). SORT lt_fi_data BY bukrs year period zitem . \" \u627e\u5230\u8d44\u4ea7\u603b\u8ba1\u884c\uff0c\u7528\u4e8e\u5212\u5206\u4e24\u5217 DATA l_lines TYPE i . LOOP AT lt_fi_data REFERENCE INTO DATA ( lr_fi_data ). l_lines = sy - tabix . IF lr_fi_data -> ztext CS '\u8d44\u4ea7\u603b\u8ba1' . EXIT . ENDIF . ENDLOOP . DATA lt_data TYPE tt_data . DATA ls_data TYPE ty_data . LOOP AT gt_bukrs INTO DATA ( l_bukrs ). CLEAR lt_data . DO l_lines TIMES . CLEAR ls_data . ls_data - bukrs = l_bukrs . ls_data - gjahr = p_gjahr . ls_data - monat = p_monat . ls_data - field2 = sy - index . \" \u8d44\u4ea7\u5217\u884c\u6b21 READ TABLE lt_fi_data REFERENCE INTO lr_fi_data WITH KEY bukrs = l_bukrs year = p_gjahr period = p_monat zitem = ls_data - field2 BINARY SEARCH . IF sy - subrc = 0 . ls_data - field1 = lr_fi_data -> ztext . ls_data - field3 = |{ lr_fi_data -> period_total NUMBER = USER DECIMALS = 2 }|. ls_data - field4 = |{ lr_fi_data -> year_begin NUMBER = USER DECIMALS = 2 }|. ENDIF . ls_data - field6 = sy - index + l_lines . \" \u8d1f\u503a\u548c\u6240\u6709\u8005\u6743\u76ca\u5217\u884c\u6b21 READ TABLE lt_fi_data REFERENCE INTO lr_fi_data WITH KEY bukrs = l_bukrs year = p_gjahr period = p_monat zitem = ls_data - field6 BINARY SEARCH . IF sy - subrc = 0 . ls_data - field5 = lr_fi_data -> ztext . ls_data - field7 = |{ lr_fi_data -> period_total NUMBER = USER DECIMALS = 2 }|. ls_data - field8 = |{ lr_fi_data -> year_begin NUMBER = USER DECIMALS = 2 }|. ENDIF . INSERT ls_data INTO TABLE gt_data . ENDDO . ENDLOOP . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_export *&---------------------------------------------------------------------* *& \u5bfc\u51fa\u5230\u672c\u5730 *&---------------------------------------------------------------------* FORM frm_export . TYPES : BEGIN OF ty_replace , from TYPE string , to TYPE string , END OF ty_replace . TYPES tt_replace TYPE STANDARD TABLE OF ty_replace WITH EMPTY KEY . DATA lt_replace TYPE tt_replace . DATA ls_replace TYPE ty_replace . \" \u83b7\u53d6\u4e0b\u8f7d\u76ee\u5f55 DATA l_directory TYPE string . cl_gui_frontend_services => directory_browse ( CHANGING selected_folder = l_directory EXCEPTIONS cntl_error = 1 error_no_gui = 2 not_supported_by_gui = 3 ). IF sy - subrc <> 0 . MESSAGE ID sy - msgid TYPE sy - msgty NUMBER sy - msgno WITH sy - msgv1 sy - msgv2 sy - msgv3 sy - msgv4 . ENDIF . DATA ( l_buffer ) = lcl_fi_report => get_smw0_templete ( CONV # ( sy - tcode ) ). \" \u83b7\u53d6SMW0\u6a21\u677f\u6587\u4ef6 CHECK l_buffer IS NOT INITIAL . \" \u9010\u516c\u53f8\u5904\u7406 LOOP AT gt_data INTO DATA ( ls_data ) GROUP BY ( bukrs = ls_data - bukrs gjahr = ls_data - gjahr monat = ls_data - monat ) INTO DATA ( ls_data_grp ). SELECT SINGLE butxt FROM t001 WHETE bukrs = @ ls_data_grp - bukrs INTO @ DATA ( l_butxt ). \" \u7f16\u5236\u5355\u4f4d CLEAR ls_replace . ls_replace - from = | __BUKRS__ |. ls_replace - to = l_butxt . INSERT ls_replace INTO TABLE lt_replace . \" \u6253\u5370\u65e5\u671f CLEAR ls_replace . ls_replace - from = | __ZDATE__ |. ls_replace - to = |{ sy - datum ( 4 ) } \u5e74 { sy - datum + 4 ( 2 ) } \u6708 { sy - datum + 6 ( 2 ) } \u65e5 |. INSERT ls_replace INTO TABLE lt_replace . LOOP AT GROUP ls_data_grp INTO ls_data . \" \u8d44\u4ea7-\u671f\u672b\u4f59\u989d CLEAR ls_replace . ls_replace - from = | __PEROID_END_Z { ls_data - field2 } __ |. ls_replace - to = ls_data - field3 . INSERT ls_replace INTO TABLE lt_replace . \" \u8d44\u4ea7-\u5e74\u521d\u4f59\u989d CLEAR ls_replace . ls_replace - from = | __YEAR_BEGIN_Z { ls_data - field2 } __ |. ls_replace - to = ls_data - field4 . INSERT ls_replace INTO TABLE lt_replace . \" \u635f\u76ca-\u671f\u672b\u4f59\u989d CLEAR ls_replace . ls_replace - from = | __PEROID_END_Z { ls_data - field6 } __ |. ls_replace - to = ls_data - field7 . INSERT ls_replace INTO TABLE lt_replace . \" \u635f\u76ca-\u5e74\u521d\u4f59\u989d CLEAR ls_replace . ls_replace - from = | __YEAR_BEGIN_Z { ls_data - field6 } __ |. ls_replace - to = ls_data - field8 . INSERT ls_replace INTO TABLE lt_replace . ENDLOOP . \" \u66ff\u6362\u6587\u672c\u5185\u5bb9 DATA ( l_doc ) = l_buffer . lcl_fi_report => replace_texts ( EXPORTING it_replace = lt_replace CHANGING c_doc = l_doc ). CHECK l_doc IS NOT INITIAL . \" \u4e0b\u8f7d\u5230\u672c\u5730 TRY . DATA ( l_filename ) = |{ l_directory } \\\\\u8d44\u4ea7\u8d1f\u503a\u8868_ { l_bukrs_name } _ { sy - datum } .xlsx |. cl_openxml_helper => store_local_file ( im_file_name = l_filename im_data = l_doc ). CATCH cx_openxml_not_found cx_openxml_format cx_openxml_not_allowed INTO DATA ( lx_openxml ). MESSAGE lx_openxml -> get_text ( ) TYPE 'S' DISPLAY LIKE 'E' . RETURN . ENDTRY . ENDLOOP . ENDFORM . *&---------------------------------------------------------------------* *& Include zfi_balance_alv *&---------------------------------------------------------------------* *&---------------------------------------------------------------------* *& Form frm_display *&---------------------------------------------------------------------* *& ALV\u5c55\u793a *&---------------------------------------------------------------------* FORM frm_display TABLES ct_data TYPE STANDARD TABLE . DATA ls_layout TYPE lvc_s_layo . DATA lt_fieldcat TYPE STANDARD TABLE OF lvc_s_fcat . PERFORM frm_set_layout CHANGING ls_layout . PERFORM frm_set_fieldcat TABLES lt_fieldcat . CALL FUNCTION 'REUSE_ALV_GRID_DISPLAY_LVC' EXPORTING i_callback_program = sy - repid * i_callback_pf_status_set = 'FRM_PF_STATUS' * i_callback_user_command = 'FRM_USER_COMMAND' is_layout_lvc = ls_layout it_fieldcat_lvc = lt_fieldcat i_default = abap_true i_save = 'A' TABLES t_outtab = ct_data[] EXCEPTIONS program_error = 1 OTHERS = 2 . IF sy - subrc <> 0 . MESSAGE ID sy - msgid TYPE sy - msgty NUMBER sy - msgno WITH sy - msgv1 sy - msgv2 sy - msgv3 sy - msgv4 . ENDIF . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_set_layout *&---------------------------------------------------------------------* *& \u62a5\u8868\u5e03\u5c40\u8bbe\u7f6e *&---------------------------------------------------------------------* FORM frm_set_layout CHANGING cs_layout TYPE lvc_s_layo . CLEAR cs_layout . cs_layout - zebra = abap_true . \" \u6591\u9a6c\u7ebf cs_layout - cwidth_opt = abap_true . \" \u81ea\u52a8\u8c03\u6574ALVL\u5217\u5bbd cs_layout - sel_mode = 'A' . \" \u9009\u62e9\u6a21\u5f0f * cs_layout-ctab_fname = 'COLTAB'. \" \u5355\u5143\u683c\u989c\u8272\u8bbe\u7f6e ENDFORM . *&---------------------------------------------------------------------* *& Form frm_set_fieldcat *&---------------------------------------------------------------------* *& \u5b57\u6bb5\u76ee\u5f55\u8bbe\u7f6e *&---------------------------------------------------------------------* FORM frm_set_fieldcat TABLES ct_fieldcat TYPE lvc_t_fcat . DATA ls_fieldcat TYPE lvc_s_fcat . DEFINE _init_fieldcat . CLEAR ls_fieldcat . ls_fieldcat - fieldname = &1 . ls_fieldcat - tooltip = ls_fieldcat - coltext = ls_fieldcat - seltext = ls_fieldcat - scrtext_l = ls_fieldcat - scrtext_m = ls_fieldcat - scrtext_s = &2 . ls_fieldcat - ref_table = &3 . ls_fieldcat - ref_field = &4 . INSERT ls_fieldcat INTO TABLE ct_fieldcat . END-OF-DEFINITION . _init_fieldcat 'FIELD1' '\u8d44\u4ea7' '' '' . _init_fieldcat 'FIELD2' '\u884c\u6b21' '' '' . _init_fieldcat 'FIELD3' '\u671f\u672b\u4f59\u989d' '' '' . _init_fieldcat 'FIELD4' '\u5e74\u521d\u4f59\u989d' '' '' . _init_fieldcat 'FIELD5' '\u8d1f\u503a\u548c\u6240\u6709\u8005\u6743\u76ca' '' '' . _init_fieldcat 'FIELD6' '\u884c\u6b21' '' '' . _init_fieldcat 'FIELD7' '\u671f\u672b\u4f59\u989d' '' '' . _init_fieldcat 'FIELD8' '\u5e74\u521d\u4f59\u989d' '' '' . \" \u4e2a\u6027\u5316\u81ea\u5df1\u8f93\u51fa\u6570\u636e\u683c\u5f0f LOOP AT ct_fieldcat REFERENCE INTO DATA ( lr_fieldcat ). \" \u5b57\u6bb5\u663e\u793a\u5c5e\u6027\u8bbe\u7f6e CASE lr_fieldcat -> fieldname . WHEN OTHERS . ENDCASE . ENDLOOP . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_pf_status *&---------------------------------------------------------------------* *& \u8bbe\u7f6eGUI\u72b6\u6001 *&---------------------------------------------------------------------* FORM frm_pf_status USING ct_extab TYPE slis_t_extab . SET PF-STATUS 'STATUS' . SET TITLEBAR 'TITLE' . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_user_command *&---------------------------------------------------------------------* *& \u529f\u80fd\u54cd\u5e94 *&---------------------------------------------------------------------* FORM frm_user_command USING cv_ucomm LIKE sy - ucomm cs_selfield TYPE slis_selfield . \" \u5237\u65b0\u5c4f\u5e55\u6570\u636e\u5230\u5185\u8868 DATA : lo_grid TYPE REF TO cl_gui_alv_grid . CALL FUNCTION 'GET_GLOBALS_FROM_SLVC_FULLSCR' IMPORTING e_grid = lo_grid . CALL METHOD lo_grid -> check_changed_data . \" \u6309\u94ae\u529f\u80fd\u5b9e\u73b0 CASE cv_ucomm . WHEN '&IC1' . \" \u53cc\u51fb WHEN 'ZEXPORT' . \" \u5bfc\u51fa PERFORM frm_export . WHEN OTHERS . ENDCASE . \" \u5237\u65b0ALV \u663e\u793a\u503c cs_selfield - refresh = abap_true . cs_selfield - row_stable = abap_true . cs_selfield - col_stable = abap_true . ENDFORM . *&---------------------------------------------------------------------* *& START-OF-SELECTION *&---------------------------------------------------------------------* START-OF-SELECTION . PERFORM frm_main .","title":"\u8d44\u4ea7\u8d1f\u503a\u8868"},{"location":"fico/fi_report_cf/","text":"\u73b0\u91d1\u6d41\u91cf\u8868 \u00b6 \u73b0\u91d1\u6d41\u91cf\u8868\u662f \u8d22\u52a1\u53d6\u503c\u6a21\u5757 \u7684\u4e00\u4e2a\u5b9e\u4f8b\u3002\u4e0b\u9762\u4ee3\u7801\u4f7f\u7528\u7684\u914d\u7f6e\u8868\u53ef\u53c2\u8003 \u9875\u9762 \u3002 \u793a\u4f8b\u4ee3\u7801 REPORT zfi_balance . *&---------------------------------------------------------------------* *& Include zfi_balance_top *&---------------------------------------------------------------------* TYPES : BEGIN OF ty_data , bukrs TYPE bukrs , gjahr TYPE gjahr , monat TYPE monat , field1 TYPE string , \" \u9879\u76ee field2 TYPE string , \" \u884c\u6b21 field3 TYPE string , \" \u672c\u6708\u91d1\u989d field4 TYPE string , \" \u7d2f\u8ba1\u91d1\u989d END OF ty_data . TYPES tt_data TYPE STANDARD TABLE OF ty_data . DATA gt_data TYPE tt_data . DATA gt_bukrs TYPE STANDARD TABLE OF bukrs WITH EMPTY KEY . *&---------------------------------------------------------------------* *& Include zfi_balance_sel *&---------------------------------------------------------------------* TABLES t001 . SELECT-OPTIONS s_bukrs FOR t001 - bukrs NO-EXTENSION NO INTERVALS OBLIGATORY . PARAMETERS p_gjahr TYPE gjahr OBLIGATORY DEFAULT sy - datum ( 4 ). PARAMETERS p_monat TYPE monat OBLIGATORY DEFAULT sy - datum + 4 ( 2 ). *&---------------------------------------------------------------------* *& Include zfir001_frm *&---------------------------------------------------------------------* *&---------------------------------------------------------------------* *& Form frm_main *&---------------------------------------------------------------------* *& \u62a5\u8868\u7a0b\u5e8f\u5165\u53e3 *&---------------------------------------------------------------------* FORM frm_main . PERFORM frm_auth_check . IF gt_bukrs IS INITIAL . RETURN . ENDIF . PERFORM frm_gen_cash_flow . \" \u73b0\u91d1\u6d41\u91cf\u8868 PERFORM frm_display TABLES gt_data . \" \u5c55\u793a ENDFORM . *&---------------------------------------------------------------------* *& Form frm_auth_check *&---------------------------------------------------------------------* *& \u6743\u9650\u68c0\u67e5 *&---------------------------------------------------------------------* FORM frm_auth_check . DATA lt_bukrs_opt TYPE RANGE OF bukrs . SELECT 'I' AS sign , 'EQ' AS option , bukrs AS low FROM t001 WHERE bukrs IN @ s_bukrs INTO TABLE @ lt_bukrs_opt . IF lt_bukrs_opt IS INITIAL . l_subrc = 1 . l_msg = | \u516c\u53f8\u4e0d\u5b58\u5728 |. ENDIF . SORT lt_bukrs_opt . DELETE ADJACENT DUPLICATES FROM lt_bukrs_opt COMPARING ALL FIELDS . LOOP AT lt_bukrs_opt INTO DATA ( ls_bukrs_opt ). AUTHORITY-CHECK OBJECT 'F_BKPF_BUK' ID 'BUKRS' FIELD ls_bukrs_opt - low ID 'ACTVT' FIELD i_actvt . IF sy - subrc <> 0 . MESSAGE | \u65e0\u516c\u53f8 { ls_bukrs_opt - low } \u6743\u9650 | TYPE 'S' DISPLAY LIKE 'E' . DELETE lt_bukrs_opt . ENDIF . ENDLOOP . s_bukrs[] = lt_bukrs_opt . IF s_bukrs[] IS INITIAL . LEAVE LIST - PROCESSING . ENDIF . SELECT bukrs FROM t001 WHERE bukrs IN @ s_bukrs INTO TABLE @ gt_bukrs . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_get_config *&---------------------------------------------------------------------* *& \u8bfb\u53d6\u5168\u90e8\u516c\u53f8\u914d\u7f6e *&---------------------------------------------------------------------* FORM frm_get_config_all TABLES et_config TYPE tt_config . DATA lt_config TYPE tt_config . LOOP AT gt_bukrs INTO DATA ( l_bukrs ). PERFORM frm_get_config TABLES lt_config USING '3' \" \u73b0\u91d1\u6d41\u91cf\u8868 l_bukrs . INSERT LINES OF lt_config INTO TABLE et_config . ENDLOOP . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_get_config *&---------------------------------------------------------------------* *& \u8bfb\u53d6\u5355\u4e2a\u516c\u53f8\u914d\u7f6e *&---------------------------------------------------------------------* FORM frm_get_config TABLES et_config TYPE tt_config USING i_fi_report TYPE string i_bukrs TYPE bukrs . \" \u8003\u8651\u9002\u914d\u7b26 DATA lt_bukrs_opt TYPE RANGE OF bukrs . lt_bukrs_opt = VALUE # ( sign = 'I' option = 'EQ' ( low = i_bukrs ) ( low = |{ i_bukrs ( 3 ) } * | ) ( low = |{ i_bukrs ( 2 ) } * | ) ( low = |{ i_bukrs ( 1 ) } * | ) ( low = '*' ) ( low = '' ) ). \" \u53d6\u914d\u7f6e\u6570\u636e SELECT * FROM zfit0001 WHERE zfi_report = @ i_fi_report AND bukrs IN @ lt_bukrs_opt INTO TABLE @ DATA ( lt_zfit0001 ). \" \u89e3\u6790\u914d\u7f6e\u6570\u636e LOOP AT lt_zfit0001 INTO DATA ( ls_zfit0001 ). DATA ls_config TYPE ty_config . CLEAR ls_config . ls_config - bukrs = ls_zfit0001 - bukrs . \" \u516c\u53f8 ls_config - zitem = ls_zfit0001 - zitem . \" \u9879\u76ee ls_config - zitem_sub = ls_zfit0001 - zitem_sub . \" \u5b50\u9879\u76ee CASE ls_zfit0001 - ztype . WHEN '0' . \" \u6587\u672c\u9879 ls_config - ztext = ls_zfit0001 - ztext . \" \u9879\u76ee\u540d\u79f0 WHEN '1' . \" \u7b5b\u9009\u9879 \" \u79d1\u76ee IF ls_zfit0001 - racct_to IS NOT INITIAL . INSERT VALUE # ( sign = 'I' option = 'BT' low = ls_zfit0001 - racct_from high = ls_zfit0001 - racct_to ) INTO TABLE ls_config - t_racct_opt . ELSE . INSERT VALUE # ( sign = 'I' option = 'EQ' low = ls_zfit0001 - racct_from ) INTO TABLE ls_config - t_racct_opt . ENDIF . \" \u539f\u56e0\u4ee3\u7801 INSERT VALUE # ( name = 'RSTGR' \" TY_DATEIL\u5b57\u6bb5\u540d\uff0c\u540e\u7eed\u52a8\u6001\u7b5b\u9009 t_range_opt = VALUE # ( ( sign = 'I' option = 'EQ' low = ls_zfit0001 - rstgr ) ) ) INTO TABLE ls_config - t_filter . \" \u529f\u80fd\u8303\u56f4 INSERT VALUE # ( name = 'RFAREA' \" TY_DATEIL\u5b57\u6bb5\u540d\uff0c\u540e\u7eed\u52a8\u6001\u7b5b\u9009 t_range_opt = VALUE # ( ( sign = 'I' option = 'EQ' low = ls_zfit0001 - rfarea ) ) ) INTO TABLE ls_config - t_filter . WHEN '2' . \" \u6c47\u603b\u9879 IF ls_zfit0001 - zitem_to IS INITIAL OR ls_zfit0001 - zitem_to = '' . ls_zfit0001 - zitem_to = ls_zfit0001 - zitem_from . ENDIF . WHILE ls_zfit0001 - zitem_from <= ls_zfit0001 - zitem_to . INSERT ls_zfit0001 - zitem_from INTO TABLE ls_config - t_collect . ls_zfit0001 - zitem_from = ls_zfit0001 - zitem_from + 1 . ENDWHILE . ls_config - zreverse = ls_zfit0001 - zreverse . \" \u53cd\u5411\u6807\u8bc6 WHEN OTHERS . ENDCASE . \" CASE ls_zfit0001-ztype INSERT ls_config INTO TABLE et_config . ENDLOOP . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_gen_cash_flow *&---------------------------------------------------------------------* *& \u6784\u5efa\u73b0\u91d1\u6d41\u91cf\u8868 *&---------------------------------------------------------------------* FORM frm_gen_cash_flow . DATA lt_config TYPE tt_config . PERFORM frm_get_config_all TABLES lt_config . \" \u83b7\u53d6\u914d\u7f6e\u6570\u636e \" \u6839\u636e\u914d\u7f6e\u6570\u636e\u751f\u6210\u8d22\u52a1\u62a5\u8868\u6570\u636e\u9879 DATA ( lt_fi_data ) = lcl_fi_report => create ( i_year = p_gjahr i_period = p_monat it_config = lt_config ) -> execute ( ). SORT lt_fi_data BY bukrs year period zitem . DATA lt_data TYPE tt_data . DATA ls_data TYPE ty_data . LOOP AT lt_fi_data INTO DATA ( ls_fi_data ) GROUP BY ( bukrs = ls_fi_data - bukrs year = ls_fi_data - year period = ls_fi_data - period ) INTO DATA ( ls_fi_data_grp ). LOOP AT GROUP ls_fi_data_grp INTO ls_fi_data . CLEAR ls_data . ls_data - bukrs = ls_fi_data - bukrs . ls_data - gjahr = ls_fi_data - year . ls_data - monat = ls_fi_data - period . ls_data - field1 = ls_fi_data - ztext . ls_data - field2 = ls_fi_data - zitem . ls_data - field3 = |{ ls_fi_data - period_current NUMBER = USER DECIMALS = 2 }|. ls_data - field4 = |{ ls_fi_data - period_total NUMBER = USER DECIMALS = 2 }|. INSERT ls_data INTO TABLE gt_data . ENDLOOP . ENDLOOP . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_export *&---------------------------------------------------------------------* *& \u5bfc\u51fa\u5230\u672c\u5730 *&---------------------------------------------------------------------* FORM frm_export . TYPES : BEGIN OF ty_replace , from TYPE string , to TYPE string , END OF ty_replace . TYPES tt_replace TYPE STANDARD TABLE OF ty_replace WITH EMPTY KEY . DATA lt_replace TYPE tt_replace . DATA ls_replace TYPE ty_replace . \" \u83b7\u53d6\u4e0b\u8f7d\u76ee\u5f55 DATA l_directory TYPE string . cl_gui_frontend_services => directory_browse ( CHANGING selected_folder = l_directory EXCEPTIONS cntl_error = 1 error_no_gui = 2 not_supported_by_gui = 3 ). IF sy - subrc <> 0 . MESSAGE ID sy - msgid TYPE sy - msgty NUMBER sy - msgno WITH sy - msgv1 sy - msgv2 sy - msgv3 sy - msgv4 . ENDIF . DATA ( l_buffer ) = lcl_fi_report => get_smw0_templete ( CONV # ( sy - tcode ) ). \" \u83b7\u53d6SMW0\u6a21\u677f\u6587\u4ef6 CHECK l_buffer IS NOT INITIAL . \" \u9010\u516c\u53f8\u5904\u7406 LOOP AT gt_data INTO DATA ( ls_data ) GROUP BY ( bukrs = ls_data - bukrs gjahr = ls_data - gjahr monat = ls_data - monat ) INTO DATA ( ls_data_grp ). SELECT SINGLE butxt FROM t001 WHETE bukrs = @ ls_data_grp - bukrs INTO @ DATA ( l_butxt ). \" \u7f16\u5236\u5355\u4f4d CLEAR ls_replace . ls_replace - from = | __BUKRS__ |. ls_replace - to = l_butxt . INSERT ls_replace INTO TABLE lt_replace . \" \u6253\u5370\u65e5\u671f CLEAR ls_replace . ls_replace - from = | __ZDATE__ |. ls_replace - to = |{ sy - datum ( 4 ) } \u5e74 { sy - datum + 4 ( 2 ) } \u6708 { sy - datum + 6 ( 2 ) } \u65e5 |. INSERT ls_replace INTO TABLE lt_replace . LOOP AT GROUP ls_data_grp INTO ls_data . \" \u672c\u6708\u91d1\u989d CLEAR ls_replace . ls_replace - from = | __PEROID_CURRENT_Z { ls_data - field2 } __ |. ls_replace - to = ls_data - field3 . INSERT ls_replace INTO TABLE lt_replace . \" \u7d2f\u8ba1\u91d1\u989d CLEAR ls_replace . ls_replace - from = | __PEROID_TOTAL_Z { ls_data - field2 } __ |. ls_replace - to = ls_data - field4 . INSERT ls_replace INTO TABLE lt_replace . ENDLOOP . \" \u66ff\u6362\u6587\u672c\u5185\u5bb9 DATA ( l_doc ) = l_buffer . lcl_fi_report => replace_texts ( EXPORTING it_replace = lt_replace CHANGING c_doc = l_doc ). CHECK l_doc IS NOT INITIAL . \" \u4e0b\u8f7d\u5230\u672c\u5730 TRY . DATA ( l_filename ) = |{ l_directory } \\\\\u73b0\u91d1\u6d41\u91cf\u8868_ { l_bukrs_name } _ { sy - datum } .xlsx |. cl_openxml_helper => store_local_file ( im_file_name = l_filename im_data = l_doc ). CATCH cx_openxml_not_found cx_openxml_format cx_openxml_not_allowed INTO DATA ( lx_openxml ). MESSAGE lx_openxml -> get_text ( ) TYPE 'S' DISPLAY LIKE 'E' . RETURN . ENDTRY . ENDLOOP . ENDFORM . *&---------------------------------------------------------------------* *& Include zfi_balance_alv *&---------------------------------------------------------------------* *&---------------------------------------------------------------------* *& Form frm_display *&---------------------------------------------------------------------* *& ALV\u5c55\u793a *&---------------------------------------------------------------------* FORM frm_display TABLES ct_data TYPE STANDARD TABLE . DATA ls_layout TYPE lvc_s_layo . DATA lt_fieldcat TYPE STANDARD TABLE OF lvc_s_fcat . PERFORM frm_set_layout CHANGING ls_layout . PERFORM frm_set_fieldcat TABLES lt_fieldcat . CALL FUNCTION 'REUSE_ALV_GRID_DISPLAY_LVC' EXPORTING i_callback_program = sy - repid * i_callback_pf_status_set = 'FRM_PF_STATUS' * i_callback_user_command = 'FRM_USER_COMMAND' is_layout_lvc = ls_layout it_fieldcat_lvc = lt_fieldcat i_default = abap_true i_save = 'A' TABLES t_outtab = ct_data[] EXCEPTIONS program_error = 1 OTHERS = 2 . IF sy - subrc <> 0 . MESSAGE ID sy - msgid TYPE sy - msgty NUMBER sy - msgno WITH sy - msgv1 sy - msgv2 sy - msgv3 sy - msgv4 . ENDIF . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_set_layout *&---------------------------------------------------------------------* *& \u62a5\u8868\u5e03\u5c40\u8bbe\u7f6e *&---------------------------------------------------------------------* FORM frm_set_layout CHANGING cs_layout TYPE lvc_s_layo . CLEAR cs_layout . cs_layout - zebra = abap_true . \" \u6591\u9a6c\u7ebf cs_layout - cwidth_opt = abap_true . \" \u81ea\u52a8\u8c03\u6574ALVL\u5217\u5bbd cs_layout - sel_mode = 'A' . \" \u9009\u62e9\u6a21\u5f0f * cs_layout-ctab_fname = 'COLTAB'. \" \u5355\u5143\u683c\u989c\u8272\u8bbe\u7f6e ENDFORM . *&---------------------------------------------------------------------* *& Form frm_set_fieldcat *&---------------------------------------------------------------------* *& \u5b57\u6bb5\u76ee\u5f55\u8bbe\u7f6e *&---------------------------------------------------------------------* FORM frm_set_fieldcat TABLES ct_fieldcat TYPE lvc_t_fcat . DATA ls_fieldcat TYPE lvc_s_fcat . DEFINE _init_fieldcat . CLEAR ls_fieldcat . ls_fieldcat - fieldname = &1 . ls_fieldcat - tooltip = ls_fieldcat - coltext = ls_fieldcat - seltext = ls_fieldcat - scrtext_l = ls_fieldcat - scrtext_m = ls_fieldcat - scrtext_s = &2 . ls_fieldcat - ref_table = &3 . ls_fieldcat - ref_field = &4 . INSERT ls_fieldcat INTO TABLE ct_fieldcat . END-OF-DEFINITION . _init_fieldcat 'FIELD1' '\u9879\u76ee' '' '' . _init_fieldcat 'FIELD2' '\u884c\u6b21' '' '' . _init_fieldcat 'FIELD3' '\u672c\u6708\u91d1\u989d' '' '' . _init_fieldcat 'FIELD4' '\u7d2f\u8ba1\u91d1\u989d' '' '' . \" \u4e2a\u6027\u5316\u81ea\u5df1\u8f93\u51fa\u6570\u636e\u683c\u5f0f LOOP AT ct_fieldcat REFERENCE INTO DATA ( lr_fieldcat ). \" \u5b57\u6bb5\u663e\u793a\u5c5e\u6027\u8bbe\u7f6e CASE lr_fieldcat -> fieldname . WHEN OTHERS . ENDCASE . ENDLOOP . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_pf_status *&---------------------------------------------------------------------* *& \u8bbe\u7f6eGUI\u72b6\u6001 *&---------------------------------------------------------------------* FORM frm_pf_status USING ct_extab TYPE slis_t_extab . SET PF-STATUS 'STATUS' . SET TITLEBAR 'TITLE' . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_user_command *&---------------------------------------------------------------------* *& \u529f\u80fd\u54cd\u5e94 *&---------------------------------------------------------------------* FORM frm_user_command USING cv_ucomm LIKE sy - ucomm cs_selfield TYPE slis_selfield . \" \u5237\u65b0\u5c4f\u5e55\u6570\u636e\u5230\u5185\u8868 DATA : lo_grid TYPE REF TO cl_gui_alv_grid . CALL FUNCTION 'GET_GLOBALS_FROM_SLVC_FULLSCR' IMPORTING e_grid = lo_grid . CALL METHOD lo_grid -> check_changed_data . \" \u6309\u94ae\u529f\u80fd\u5b9e\u73b0 CASE cv_ucomm . WHEN '&IC1' . \" \u53cc\u51fb WHEN 'ZEXPORT' . \" \u5bfc\u51fa PERFORM frm_export . WHEN OTHERS . ENDCASE . \" \u5237\u65b0ALV \u663e\u793a\u503c cs_selfield - refresh = abap_true . cs_selfield - row_stable = abap_true . cs_selfield - col_stable = abap_true . ENDFORM . *&---------------------------------------------------------------------* *& START-OF-SELECTION *&---------------------------------------------------------------------* START-OF-SELECTION . PERFORM frm_main .","title":"\u73b0\u91d1\u6d41\u91cf\u8868"},{"location":"fico/fi_report_cf/#_1","text":"\u73b0\u91d1\u6d41\u91cf\u8868\u662f \u8d22\u52a1\u53d6\u503c\u6a21\u5757 \u7684\u4e00\u4e2a\u5b9e\u4f8b\u3002\u4e0b\u9762\u4ee3\u7801\u4f7f\u7528\u7684\u914d\u7f6e\u8868\u53ef\u53c2\u8003 \u9875\u9762 \u3002 \u793a\u4f8b\u4ee3\u7801 REPORT zfi_balance . *&---------------------------------------------------------------------* *& Include zfi_balance_top *&---------------------------------------------------------------------* TYPES : BEGIN OF ty_data , bukrs TYPE bukrs , gjahr TYPE gjahr , monat TYPE monat , field1 TYPE string , \" \u9879\u76ee field2 TYPE string , \" \u884c\u6b21 field3 TYPE string , \" \u672c\u6708\u91d1\u989d field4 TYPE string , \" \u7d2f\u8ba1\u91d1\u989d END OF ty_data . TYPES tt_data TYPE STANDARD TABLE OF ty_data . DATA gt_data TYPE tt_data . DATA gt_bukrs TYPE STANDARD TABLE OF bukrs WITH EMPTY KEY . *&---------------------------------------------------------------------* *& Include zfi_balance_sel *&---------------------------------------------------------------------* TABLES t001 . SELECT-OPTIONS s_bukrs FOR t001 - bukrs NO-EXTENSION NO INTERVALS OBLIGATORY . PARAMETERS p_gjahr TYPE gjahr OBLIGATORY DEFAULT sy - datum ( 4 ). PARAMETERS p_monat TYPE monat OBLIGATORY DEFAULT sy - datum + 4 ( 2 ). *&---------------------------------------------------------------------* *& Include zfir001_frm *&---------------------------------------------------------------------* *&---------------------------------------------------------------------* *& Form frm_main *&---------------------------------------------------------------------* *& \u62a5\u8868\u7a0b\u5e8f\u5165\u53e3 *&---------------------------------------------------------------------* FORM frm_main . PERFORM frm_auth_check . IF gt_bukrs IS INITIAL . RETURN . ENDIF . PERFORM frm_gen_cash_flow . \" \u73b0\u91d1\u6d41\u91cf\u8868 PERFORM frm_display TABLES gt_data . \" \u5c55\u793a ENDFORM . *&---------------------------------------------------------------------* *& Form frm_auth_check *&---------------------------------------------------------------------* *& \u6743\u9650\u68c0\u67e5 *&---------------------------------------------------------------------* FORM frm_auth_check . DATA lt_bukrs_opt TYPE RANGE OF bukrs . SELECT 'I' AS sign , 'EQ' AS option , bukrs AS low FROM t001 WHERE bukrs IN @ s_bukrs INTO TABLE @ lt_bukrs_opt . IF lt_bukrs_opt IS INITIAL . l_subrc = 1 . l_msg = | \u516c\u53f8\u4e0d\u5b58\u5728 |. ENDIF . SORT lt_bukrs_opt . DELETE ADJACENT DUPLICATES FROM lt_bukrs_opt COMPARING ALL FIELDS . LOOP AT lt_bukrs_opt INTO DATA ( ls_bukrs_opt ). AUTHORITY-CHECK OBJECT 'F_BKPF_BUK' ID 'BUKRS' FIELD ls_bukrs_opt - low ID 'ACTVT' FIELD i_actvt . IF sy - subrc <> 0 . MESSAGE | \u65e0\u516c\u53f8 { ls_bukrs_opt - low } \u6743\u9650 | TYPE 'S' DISPLAY LIKE 'E' . DELETE lt_bukrs_opt . ENDIF . ENDLOOP . s_bukrs[] = lt_bukrs_opt . IF s_bukrs[] IS INITIAL . LEAVE LIST - PROCESSING . ENDIF . SELECT bukrs FROM t001 WHERE bukrs IN @ s_bukrs INTO TABLE @ gt_bukrs . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_get_config *&---------------------------------------------------------------------* *& \u8bfb\u53d6\u5168\u90e8\u516c\u53f8\u914d\u7f6e *&---------------------------------------------------------------------* FORM frm_get_config_all TABLES et_config TYPE tt_config . DATA lt_config TYPE tt_config . LOOP AT gt_bukrs INTO DATA ( l_bukrs ). PERFORM frm_get_config TABLES lt_config USING '3' \" \u73b0\u91d1\u6d41\u91cf\u8868 l_bukrs . INSERT LINES OF lt_config INTO TABLE et_config . ENDLOOP . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_get_config *&---------------------------------------------------------------------* *& \u8bfb\u53d6\u5355\u4e2a\u516c\u53f8\u914d\u7f6e *&---------------------------------------------------------------------* FORM frm_get_config TABLES et_config TYPE tt_config USING i_fi_report TYPE string i_bukrs TYPE bukrs . \" \u8003\u8651\u9002\u914d\u7b26 DATA lt_bukrs_opt TYPE RANGE OF bukrs . lt_bukrs_opt = VALUE # ( sign = 'I' option = 'EQ' ( low = i_bukrs ) ( low = |{ i_bukrs ( 3 ) } * | ) ( low = |{ i_bukrs ( 2 ) } * | ) ( low = |{ i_bukrs ( 1 ) } * | ) ( low = '*' ) ( low = '' ) ). \" \u53d6\u914d\u7f6e\u6570\u636e SELECT * FROM zfit0001 WHERE zfi_report = @ i_fi_report AND bukrs IN @ lt_bukrs_opt INTO TABLE @ DATA ( lt_zfit0001 ). \" \u89e3\u6790\u914d\u7f6e\u6570\u636e LOOP AT lt_zfit0001 INTO DATA ( ls_zfit0001 ). DATA ls_config TYPE ty_config . CLEAR ls_config . ls_config - bukrs = ls_zfit0001 - bukrs . \" \u516c\u53f8 ls_config - zitem = ls_zfit0001 - zitem . \" \u9879\u76ee ls_config - zitem_sub = ls_zfit0001 - zitem_sub . \" \u5b50\u9879\u76ee CASE ls_zfit0001 - ztype . WHEN '0' . \" \u6587\u672c\u9879 ls_config - ztext = ls_zfit0001 - ztext . \" \u9879\u76ee\u540d\u79f0 WHEN '1' . \" \u7b5b\u9009\u9879 \" \u79d1\u76ee IF ls_zfit0001 - racct_to IS NOT INITIAL . INSERT VALUE # ( sign = 'I' option = 'BT' low = ls_zfit0001 - racct_from high = ls_zfit0001 - racct_to ) INTO TABLE ls_config - t_racct_opt . ELSE . INSERT VALUE # ( sign = 'I' option = 'EQ' low = ls_zfit0001 - racct_from ) INTO TABLE ls_config - t_racct_opt . ENDIF . \" \u539f\u56e0\u4ee3\u7801 INSERT VALUE # ( name = 'RSTGR' \" TY_DATEIL\u5b57\u6bb5\u540d\uff0c\u540e\u7eed\u52a8\u6001\u7b5b\u9009 t_range_opt = VALUE # ( ( sign = 'I' option = 'EQ' low = ls_zfit0001 - rstgr ) ) ) INTO TABLE ls_config - t_filter . \" \u529f\u80fd\u8303\u56f4 INSERT VALUE # ( name = 'RFAREA' \" TY_DATEIL\u5b57\u6bb5\u540d\uff0c\u540e\u7eed\u52a8\u6001\u7b5b\u9009 t_range_opt = VALUE # ( ( sign = 'I' option = 'EQ' low = ls_zfit0001 - rfarea ) ) ) INTO TABLE ls_config - t_filter . WHEN '2' . \" \u6c47\u603b\u9879 IF ls_zfit0001 - zitem_to IS INITIAL OR ls_zfit0001 - zitem_to = '' . ls_zfit0001 - zitem_to = ls_zfit0001 - zitem_from . ENDIF . WHILE ls_zfit0001 - zitem_from <= ls_zfit0001 - zitem_to . INSERT ls_zfit0001 - zitem_from INTO TABLE ls_config - t_collect . ls_zfit0001 - zitem_from = ls_zfit0001 - zitem_from + 1 . ENDWHILE . ls_config - zreverse = ls_zfit0001 - zreverse . \" \u53cd\u5411\u6807\u8bc6 WHEN OTHERS . ENDCASE . \" CASE ls_zfit0001-ztype INSERT ls_config INTO TABLE et_config . ENDLOOP . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_gen_cash_flow *&---------------------------------------------------------------------* *& \u6784\u5efa\u73b0\u91d1\u6d41\u91cf\u8868 *&---------------------------------------------------------------------* FORM frm_gen_cash_flow . DATA lt_config TYPE tt_config . PERFORM frm_get_config_all TABLES lt_config . \" \u83b7\u53d6\u914d\u7f6e\u6570\u636e \" \u6839\u636e\u914d\u7f6e\u6570\u636e\u751f\u6210\u8d22\u52a1\u62a5\u8868\u6570\u636e\u9879 DATA ( lt_fi_data ) = lcl_fi_report => create ( i_year = p_gjahr i_period = p_monat it_config = lt_config ) -> execute ( ). SORT lt_fi_data BY bukrs year period zitem . DATA lt_data TYPE tt_data . DATA ls_data TYPE ty_data . LOOP AT lt_fi_data INTO DATA ( ls_fi_data ) GROUP BY ( bukrs = ls_fi_data - bukrs year = ls_fi_data - year period = ls_fi_data - period ) INTO DATA ( ls_fi_data_grp ). LOOP AT GROUP ls_fi_data_grp INTO ls_fi_data . CLEAR ls_data . ls_data - bukrs = ls_fi_data - bukrs . ls_data - gjahr = ls_fi_data - year . ls_data - monat = ls_fi_data - period . ls_data - field1 = ls_fi_data - ztext . ls_data - field2 = ls_fi_data - zitem . ls_data - field3 = |{ ls_fi_data - period_current NUMBER = USER DECIMALS = 2 }|. ls_data - field4 = |{ ls_fi_data - period_total NUMBER = USER DECIMALS = 2 }|. INSERT ls_data INTO TABLE gt_data . ENDLOOP . ENDLOOP . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_export *&---------------------------------------------------------------------* *& \u5bfc\u51fa\u5230\u672c\u5730 *&---------------------------------------------------------------------* FORM frm_export . TYPES : BEGIN OF ty_replace , from TYPE string , to TYPE string , END OF ty_replace . TYPES tt_replace TYPE STANDARD TABLE OF ty_replace WITH EMPTY KEY . DATA lt_replace TYPE tt_replace . DATA ls_replace TYPE ty_replace . \" \u83b7\u53d6\u4e0b\u8f7d\u76ee\u5f55 DATA l_directory TYPE string . cl_gui_frontend_services => directory_browse ( CHANGING selected_folder = l_directory EXCEPTIONS cntl_error = 1 error_no_gui = 2 not_supported_by_gui = 3 ). IF sy - subrc <> 0 . MESSAGE ID sy - msgid TYPE sy - msgty NUMBER sy - msgno WITH sy - msgv1 sy - msgv2 sy - msgv3 sy - msgv4 . ENDIF . DATA ( l_buffer ) = lcl_fi_report => get_smw0_templete ( CONV # ( sy - tcode ) ). \" \u83b7\u53d6SMW0\u6a21\u677f\u6587\u4ef6 CHECK l_buffer IS NOT INITIAL . \" \u9010\u516c\u53f8\u5904\u7406 LOOP AT gt_data INTO DATA ( ls_data ) GROUP BY ( bukrs = ls_data - bukrs gjahr = ls_data - gjahr monat = ls_data - monat ) INTO DATA ( ls_data_grp ). SELECT SINGLE butxt FROM t001 WHETE bukrs = @ ls_data_grp - bukrs INTO @ DATA ( l_butxt ). \" \u7f16\u5236\u5355\u4f4d CLEAR ls_replace . ls_replace - from = | __BUKRS__ |. ls_replace - to = l_butxt . INSERT ls_replace INTO TABLE lt_replace . \" \u6253\u5370\u65e5\u671f CLEAR ls_replace . ls_replace - from = | __ZDATE__ |. ls_replace - to = |{ sy - datum ( 4 ) } \u5e74 { sy - datum + 4 ( 2 ) } \u6708 { sy - datum + 6 ( 2 ) } \u65e5 |. INSERT ls_replace INTO TABLE lt_replace . LOOP AT GROUP ls_data_grp INTO ls_data . \" \u672c\u6708\u91d1\u989d CLEAR ls_replace . ls_replace - from = | __PEROID_CURRENT_Z { ls_data - field2 } __ |. ls_replace - to = ls_data - field3 . INSERT ls_replace INTO TABLE lt_replace . \" \u7d2f\u8ba1\u91d1\u989d CLEAR ls_replace . ls_replace - from = | __PEROID_TOTAL_Z { ls_data - field2 } __ |. ls_replace - to = ls_data - field4 . INSERT ls_replace INTO TABLE lt_replace . ENDLOOP . \" \u66ff\u6362\u6587\u672c\u5185\u5bb9 DATA ( l_doc ) = l_buffer . lcl_fi_report => replace_texts ( EXPORTING it_replace = lt_replace CHANGING c_doc = l_doc ). CHECK l_doc IS NOT INITIAL . \" \u4e0b\u8f7d\u5230\u672c\u5730 TRY . DATA ( l_filename ) = |{ l_directory } \\\\\u73b0\u91d1\u6d41\u91cf\u8868_ { l_bukrs_name } _ { sy - datum } .xlsx |. cl_openxml_helper => store_local_file ( im_file_name = l_filename im_data = l_doc ). CATCH cx_openxml_not_found cx_openxml_format cx_openxml_not_allowed INTO DATA ( lx_openxml ). MESSAGE lx_openxml -> get_text ( ) TYPE 'S' DISPLAY LIKE 'E' . RETURN . ENDTRY . ENDLOOP . ENDFORM . *&---------------------------------------------------------------------* *& Include zfi_balance_alv *&---------------------------------------------------------------------* *&---------------------------------------------------------------------* *& Form frm_display *&---------------------------------------------------------------------* *& ALV\u5c55\u793a *&---------------------------------------------------------------------* FORM frm_display TABLES ct_data TYPE STANDARD TABLE . DATA ls_layout TYPE lvc_s_layo . DATA lt_fieldcat TYPE STANDARD TABLE OF lvc_s_fcat . PERFORM frm_set_layout CHANGING ls_layout . PERFORM frm_set_fieldcat TABLES lt_fieldcat . CALL FUNCTION 'REUSE_ALV_GRID_DISPLAY_LVC' EXPORTING i_callback_program = sy - repid * i_callback_pf_status_set = 'FRM_PF_STATUS' * i_callback_user_command = 'FRM_USER_COMMAND' is_layout_lvc = ls_layout it_fieldcat_lvc = lt_fieldcat i_default = abap_true i_save = 'A' TABLES t_outtab = ct_data[] EXCEPTIONS program_error = 1 OTHERS = 2 . IF sy - subrc <> 0 . MESSAGE ID sy - msgid TYPE sy - msgty NUMBER sy - msgno WITH sy - msgv1 sy - msgv2 sy - msgv3 sy - msgv4 . ENDIF . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_set_layout *&---------------------------------------------------------------------* *& \u62a5\u8868\u5e03\u5c40\u8bbe\u7f6e *&---------------------------------------------------------------------* FORM frm_set_layout CHANGING cs_layout TYPE lvc_s_layo . CLEAR cs_layout . cs_layout - zebra = abap_true . \" \u6591\u9a6c\u7ebf cs_layout - cwidth_opt = abap_true . \" \u81ea\u52a8\u8c03\u6574ALVL\u5217\u5bbd cs_layout - sel_mode = 'A' . \" \u9009\u62e9\u6a21\u5f0f * cs_layout-ctab_fname = 'COLTAB'. \" \u5355\u5143\u683c\u989c\u8272\u8bbe\u7f6e ENDFORM . *&---------------------------------------------------------------------* *& Form frm_set_fieldcat *&---------------------------------------------------------------------* *& \u5b57\u6bb5\u76ee\u5f55\u8bbe\u7f6e *&---------------------------------------------------------------------* FORM frm_set_fieldcat TABLES ct_fieldcat TYPE lvc_t_fcat . DATA ls_fieldcat TYPE lvc_s_fcat . DEFINE _init_fieldcat . CLEAR ls_fieldcat . ls_fieldcat - fieldname = &1 . ls_fieldcat - tooltip = ls_fieldcat - coltext = ls_fieldcat - seltext = ls_fieldcat - scrtext_l = ls_fieldcat - scrtext_m = ls_fieldcat - scrtext_s = &2 . ls_fieldcat - ref_table = &3 . ls_fieldcat - ref_field = &4 . INSERT ls_fieldcat INTO TABLE ct_fieldcat . END-OF-DEFINITION . _init_fieldcat 'FIELD1' '\u9879\u76ee' '' '' . _init_fieldcat 'FIELD2' '\u884c\u6b21' '' '' . _init_fieldcat 'FIELD3' '\u672c\u6708\u91d1\u989d' '' '' . _init_fieldcat 'FIELD4' '\u7d2f\u8ba1\u91d1\u989d' '' '' . \" \u4e2a\u6027\u5316\u81ea\u5df1\u8f93\u51fa\u6570\u636e\u683c\u5f0f LOOP AT ct_fieldcat REFERENCE INTO DATA ( lr_fieldcat ). \" \u5b57\u6bb5\u663e\u793a\u5c5e\u6027\u8bbe\u7f6e CASE lr_fieldcat -> fieldname . WHEN OTHERS . ENDCASE . ENDLOOP . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_pf_status *&---------------------------------------------------------------------* *& \u8bbe\u7f6eGUI\u72b6\u6001 *&---------------------------------------------------------------------* FORM frm_pf_status USING ct_extab TYPE slis_t_extab . SET PF-STATUS 'STATUS' . SET TITLEBAR 'TITLE' . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_user_command *&---------------------------------------------------------------------* *& \u529f\u80fd\u54cd\u5e94 *&---------------------------------------------------------------------* FORM frm_user_command USING cv_ucomm LIKE sy - ucomm cs_selfield TYPE slis_selfield . \" \u5237\u65b0\u5c4f\u5e55\u6570\u636e\u5230\u5185\u8868 DATA : lo_grid TYPE REF TO cl_gui_alv_grid . CALL FUNCTION 'GET_GLOBALS_FROM_SLVC_FULLSCR' IMPORTING e_grid = lo_grid . CALL METHOD lo_grid -> check_changed_data . \" \u6309\u94ae\u529f\u80fd\u5b9e\u73b0 CASE cv_ucomm . WHEN '&IC1' . \" \u53cc\u51fb WHEN 'ZEXPORT' . \" \u5bfc\u51fa PERFORM frm_export . WHEN OTHERS . ENDCASE . \" \u5237\u65b0ALV \u663e\u793a\u503c cs_selfield - refresh = abap_true . cs_selfield - row_stable = abap_true . cs_selfield - col_stable = abap_true . ENDFORM . *&---------------------------------------------------------------------* *& START-OF-SELECTION *&---------------------------------------------------------------------* START-OF-SELECTION . PERFORM frm_main .","title":"\u73b0\u91d1\u6d41\u91cf\u8868"},{"location":"fico/fi_report_config/","text":"\u4e09\u5927\u62a5\u8868\u914d\u7f6e\u8868\u53c2\u8003 \u00b6 \u5177\u4f53\u914d\u7f6e\u8868\u770b\u81ea\u5df1\u9879\u76ee\u8981\u6c42\uff0c\u53ef\u4ee5\u53c2\u8003\u4e0b\u9762\u914d\u7f6e\u8868\uff08\u65e0\u516c\u5f0f\u914d\u7f6e\uff09\uff1a @ EndUserText . label : '\u4e09\u5927\u62a5\u8868\u914d\u7f6e\u8868' @ AbapCatalog . enhancementCategory : # NOT_CLASSIFIED @ AbapCatalog . tableCategory : # TRANSPARENT @ AbapCatalog . deliveryClass : # A @ AbapCatalog . dataMaintenance : # ALLOWED define table zfit0001 { key mandt : mandt not null ; @ EndUserText . label : '1[\u8d44\u4ea7\u8d1f\u503a\u8868]\uff1b2[\u5229\u6da6\u8868]\uff1b3[\u73b0\u91d1\u6d41\u91cf\u8868]' key zfi_report : abap . char ( 1 ) not null ; @ EndUserText . label : '\u516c\u53f8' key bukrs : bukrs not null ; @ EndUserText . label : '\u9879\u76ee' key zitem : abap . numc ( 3 ) not null ; @ EndUserText . label : '\u5b50\u9879\u76ee' key zitem_sub : abap . numc ( 3 ) not null ; @ EndUserText . label : '\u5b50\u9879\u76ee' ztext : abap . char ( 30 ); @ EndUserText . label : '\u8ba1\u7b97\u7c7b\u578b\uff1b1[\u6587\u672c]\uff0c2[\u79d1\u76ee]\uff0c3[\u4e0b\u7ea7\u6c47\u603b]' ztype : abap . char ( 1 ); @ EndUserText . label : '\u79d1\u76ee\u4ece' racct_from : racct ; @ EndUserText . label : '\u79d1\u76ee\u5230' racct_to : racct ; @ EndUserText . label : '\u9879\u76ee\u4ece' zitem_from : abap . numc ( 3 ); @ EndUserText . label : '\u9879\u76ee\u5230' zitem_to : abap . numc ( 3 ); @ EndUserText . label : '\u53cd\u5411\u6807\u8bc6' zreverse : xfeld ; @ EndUserText . label : '\u539f\u56e0\u4ee3\u7801' rstgr : rstgr ; @ EndUserText . label : '\u529f\u80fd\u8303\u56f4' rfarea : fkber ; upnam : uname ; updat : datum ; uptim : uzeit ; } \u6839\u636ezitem_from\uff0czitem_to\uff0czreverse\u4e09\u4e2a\u5b57\u6bb5\uff0c\u5c31\u53ef\u4ee5\u5b9e\u73b0\u4e0d\u540c\u9879\u76ee\u7684\u52a0\u51cf\u8ba1\u7b97\uff0c\u6bd4\u5982\u9879\u76ee1 = \u9879\u76ee2 - \u9879\u76ee3 + \u9879\u76ee4 - \u9879\u76ee5\uff0c\u6309\u4e0b\u9762\u914d\u7f6e: \u9879\u76ee \u5b50\u9879\u76ee \u9879\u76ee\u6587\u672c \u9879\u76ee\u4ece \u53cd\u5411\u6807\u8bc6 1 1 \u9879\u76ee1 = 1 2 + \u9879\u76ee2 2 1 3 - \u9879\u76ee3 3 X 1 4 + \u9879\u76ee4 4 1 5 - \u9879\u76ee5 4 X","title":"\u914d\u7f6e\u8868\u53c2\u8003"},{"location":"fico/fi_report_config/#_1","text":"\u5177\u4f53\u914d\u7f6e\u8868\u770b\u81ea\u5df1\u9879\u76ee\u8981\u6c42\uff0c\u53ef\u4ee5\u53c2\u8003\u4e0b\u9762\u914d\u7f6e\u8868\uff08\u65e0\u516c\u5f0f\u914d\u7f6e\uff09\uff1a @ EndUserText . label : '\u4e09\u5927\u62a5\u8868\u914d\u7f6e\u8868' @ AbapCatalog . enhancementCategory : # NOT_CLASSIFIED @ AbapCatalog . tableCategory : # TRANSPARENT @ AbapCatalog . deliveryClass : # A @ AbapCatalog . dataMaintenance : # ALLOWED define table zfit0001 { key mandt : mandt not null ; @ EndUserText . label : '1[\u8d44\u4ea7\u8d1f\u503a\u8868]\uff1b2[\u5229\u6da6\u8868]\uff1b3[\u73b0\u91d1\u6d41\u91cf\u8868]' key zfi_report : abap . char ( 1 ) not null ; @ EndUserText . label : '\u516c\u53f8' key bukrs : bukrs not null ; @ EndUserText . label : '\u9879\u76ee' key zitem : abap . numc ( 3 ) not null ; @ EndUserText . label : '\u5b50\u9879\u76ee' key zitem_sub : abap . numc ( 3 ) not null ; @ EndUserText . label : '\u5b50\u9879\u76ee' ztext : abap . char ( 30 ); @ EndUserText . label : '\u8ba1\u7b97\u7c7b\u578b\uff1b1[\u6587\u672c]\uff0c2[\u79d1\u76ee]\uff0c3[\u4e0b\u7ea7\u6c47\u603b]' ztype : abap . char ( 1 ); @ EndUserText . label : '\u79d1\u76ee\u4ece' racct_from : racct ; @ EndUserText . label : '\u79d1\u76ee\u5230' racct_to : racct ; @ EndUserText . label : '\u9879\u76ee\u4ece' zitem_from : abap . numc ( 3 ); @ EndUserText . label : '\u9879\u76ee\u5230' zitem_to : abap . numc ( 3 ); @ EndUserText . label : '\u53cd\u5411\u6807\u8bc6' zreverse : xfeld ; @ EndUserText . label : '\u539f\u56e0\u4ee3\u7801' rstgr : rstgr ; @ EndUserText . label : '\u529f\u80fd\u8303\u56f4' rfarea : fkber ; upnam : uname ; updat : datum ; uptim : uzeit ; } \u6839\u636ezitem_from\uff0czitem_to\uff0czreverse\u4e09\u4e2a\u5b57\u6bb5\uff0c\u5c31\u53ef\u4ee5\u5b9e\u73b0\u4e0d\u540c\u9879\u76ee\u7684\u52a0\u51cf\u8ba1\u7b97\uff0c\u6bd4\u5982\u9879\u76ee1 = \u9879\u76ee2 - \u9879\u76ee3 + \u9879\u76ee4 - \u9879\u76ee5\uff0c\u6309\u4e0b\u9762\u914d\u7f6e: \u9879\u76ee \u5b50\u9879\u76ee \u9879\u76ee\u6587\u672c \u9879\u76ee\u4ece \u53cd\u5411\u6807\u8bc6 1 1 \u9879\u76ee1 = 1 2 + \u9879\u76ee2 2 1 3 - \u9879\u76ee3 3 X 1 4 + \u9879\u76ee4 4 1 5 - \u9879\u76ee5 4 X","title":"\u4e09\u5927\u62a5\u8868\u914d\u7f6e\u8868\u53c2\u8003"},{"location":"fico/fi_report_pl/","text":"\u5229\u6da6\u8868 \u00b6 \u5229\u6da6\u8868\u662f \u8d22\u52a1\u53d6\u503c\u6a21\u5757 \u7684\u4e00\u4e2a\u5b9e\u4f8b\u3002\u4e0b\u9762\u4ee3\u7801\u4f7f\u7528\u7684\u914d\u7f6e\u8868\u53ef\u53c2\u8003 \u9875\u9762 \u3002 \u793a\u4f8b\u4ee3\u7801 REPORT zfi_balance . *&---------------------------------------------------------------------* *& Include zfi_balance_top *&---------------------------------------------------------------------* TYPES : BEGIN OF ty_data , bukrs TYPE bukrs , gjahr TYPE gjahr , monat TYPE monat , field1 TYPE string , \" \u9879\u76ee field2 TYPE string , \" \u884c\u6b21 field3 TYPE string , \" \u672c\u6708\u91d1\u989d field4 TYPE string , \" \u7d2f\u8ba1\u91d1\u989d END OF ty_data . TYPES tt_data TYPE STANDARD TABLE OF ty_data . DATA gt_data TYPE tt_data . DATA gt_bukrs TYPE STANDARD TABLE OF bukrs WITH EMPTY KEY . *&---------------------------------------------------------------------* *& Include zfi_balance_sel *&---------------------------------------------------------------------* TABLES t001 . SELECT-OPTIONS s_bukrs FOR t001 - bukrs NO-EXTENSION NO INTERVALS OBLIGATORY . PARAMETERS p_gjahr TYPE gjahr OBLIGATORY DEFAULT sy - datum ( 4 ). PARAMETERS p_monat TYPE monat OBLIGATORY DEFAULT sy - datum + 4 ( 2 ). *&---------------------------------------------------------------------* *& Include zfir001_frm *&---------------------------------------------------------------------* *&---------------------------------------------------------------------* *& Form frm_main *&---------------------------------------------------------------------* *& \u62a5\u8868\u7a0b\u5e8f\u5165\u53e3 *&---------------------------------------------------------------------* FORM frm_main . PERFORM frm_auth_check . IF gt_bukrs IS INITIAL . RETURN . ENDIF . PERFORM frm_gen_profit_loss . \" \u73b0\u91d1\u6d41\u91cf\u8868 PERFORM frm_display TABLES gt_data . \" \u5c55\u793a ENDFORM . *&---------------------------------------------------------------------* *& Form frm_auth_check *&---------------------------------------------------------------------* *& \u6743\u9650\u68c0\u67e5 *&---------------------------------------------------------------------* FORM frm_auth_check . DATA lt_bukrs_opt TYPE RANGE OF bukrs . SELECT 'I' AS sign , 'EQ' AS option , bukrs AS low FROM t001 WHERE bukrs IN @ s_bukrs INTO TABLE @ lt_bukrs_opt . IF lt_bukrs_opt IS INITIAL . l_subrc = 1 . l_msg = | \u516c\u53f8\u4e0d\u5b58\u5728 |. ENDIF . SORT lt_bukrs_opt . DELETE ADJACENT DUPLICATES FROM lt_bukrs_opt COMPARING ALL FIELDS . LOOP AT lt_bukrs_opt INTO DATA ( ls_bukrs_opt ). AUTHORITY-CHECK OBJECT 'F_BKPF_BUK' ID 'BUKRS' FIELD ls_bukrs_opt - low ID 'ACTVT' FIELD i_actvt . IF sy - subrc <> 0 . MESSAGE | \u65e0\u516c\u53f8 { ls_bukrs_opt - low } \u6743\u9650 | TYPE 'S' DISPLAY LIKE 'E' . DELETE lt_bukrs_opt . ENDIF . ENDLOOP . s_bukrs[] = lt_bukrs_opt . IF s_bukrs[] IS INITIAL . LEAVE LIST - PROCESSING . ENDIF . SELECT bukrs FROM t001 WHERE bukrs IN @ s_bukrs INTO TABLE @ gt_bukrs . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_get_config *&---------------------------------------------------------------------* *& \u8bfb\u53d6\u5168\u90e8\u516c\u53f8\u914d\u7f6e *&---------------------------------------------------------------------* FORM frm_get_config_all TABLES et_config TYPE tt_config . DATA lt_config TYPE tt_config . LOOP AT gt_bukrs INTO DATA ( l_bukrs ). PERFORM frm_get_config TABLES lt_config USING '2' \" \u5229\u6da6\u8868 l_bukrs . INSERT LINES OF lt_config INTO TABLE et_config . ENDLOOP . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_get_config *&---------------------------------------------------------------------* *& \u8bfb\u53d6\u5355\u4e2a\u516c\u53f8\u914d\u7f6e *&---------------------------------------------------------------------* FORM frm_get_config TABLES et_config TYPE tt_config USING i_fi_report TYPE string i_bukrs TYPE bukrs . \" \u8003\u8651\u9002\u914d\u7b26 DATA lt_bukrs_opt TYPE RANGE OF bukrs . lt_bukrs_opt = VALUE # ( sign = 'I' option = 'EQ' ( low = i_bukrs ) ( low = |{ i_bukrs ( 3 ) } * | ) ( low = |{ i_bukrs ( 2 ) } * | ) ( low = |{ i_bukrs ( 1 ) } * | ) ( low = '*' ) ( low = '' ) ). \" \u53d6\u914d\u7f6e\u6570\u636e SELECT * FROM zfit0001 WHERE zfi_report = @ i_fi_report AND bukrs IN @ lt_bukrs_opt INTO TABLE @ DATA ( lt_zfit0001 ). \" \u89e3\u6790\u914d\u7f6e\u6570\u636e LOOP AT lt_zfit0001 INTO DATA ( ls_zfit0001 ). DATA ls_config TYPE ty_config . CLEAR ls_config . ls_config - bukrs = ls_zfit0001 - bukrs . \" \u516c\u53f8 ls_config - zitem = ls_zfit0001 - zitem . \" \u9879\u76ee ls_config - zitem_sub = ls_zfit0001 - zitem_sub . \" \u5b50\u9879\u76ee CASE ls_zfit0001 - ztype . WHEN '0' . \" \u6587\u672c\u9879 ls_config - ztext = ls_zfit0001 - ztext . \" \u9879\u76ee\u540d\u79f0 WHEN '1' . \" \u7b5b\u9009\u9879 \" \u79d1\u76ee IF ls_zfit0001 - racct_to IS NOT INITIAL . INSERT VALUE # ( sign = 'I' option = 'BT' low = ls_zfit0001 - racct_from high = ls_zfit0001 - racct_to ) INTO TABLE ls_config - t_racct_opt . ELSE . INSERT VALUE # ( sign = 'I' option = 'EQ' low = ls_zfit0001 - racct_from ) INTO TABLE ls_config - t_racct_opt . ENDIF . \" \u539f\u56e0\u4ee3\u7801 INSERT VALUE # ( name = 'RSTGR' \" TY_DATEIL\u5b57\u6bb5\u540d\uff0c\u540e\u7eed\u52a8\u6001\u7b5b\u9009 t_range_opt = VALUE # ( ( sign = 'I' option = 'EQ' low = ls_zfit0001 - rstgr ) ) ) INTO TABLE ls_config - t_filter . \" \u529f\u80fd\u8303\u56f4 INSERT VALUE # ( name = 'RFAREA' \" TY_DATEIL\u5b57\u6bb5\u540d\uff0c\u540e\u7eed\u52a8\u6001\u7b5b\u9009 t_range_opt = VALUE # ( ( sign = 'I' option = 'EQ' low = ls_zfit0001 - rfarea ) ) ) INTO TABLE ls_config - t_filter . WHEN '2' . \" \u6c47\u603b\u9879 IF ls_zfit0001 - zitem_to IS INITIAL OR ls_zfit0001 - zitem_to = '' . ls_zfit0001 - zitem_to = ls_zfit0001 - zitem_from . ENDIF . WHILE ls_zfit0001 - zitem_from <= ls_zfit0001 - zitem_to . INSERT ls_zfit0001 - zitem_from INTO TABLE ls_config - t_collect . ls_zfit0001 - zitem_from = ls_zfit0001 - zitem_from + 1 . ENDWHILE . ls_config - zreverse = ls_zfit0001 - zreverse . \" \u53cd\u5411\u6807\u8bc6 WHEN OTHERS . ENDCASE . \" CASE ls_zfit0001-ztype INSERT ls_config INTO TABLE et_config . ENDLOOP . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_gen_profit_loss *&---------------------------------------------------------------------* *& \u6784\u5efa\u5229\u6da6\u8868 *&---------------------------------------------------------------------* FORM frm_gen_profit_loss . DATA lt_config TYPE tt_config . PERFORM frm_get_config_all TABLES lt_config . \" \u83b7\u53d6\u914d\u7f6e\u6570\u636e \" \u6839\u636e\u914d\u7f6e\u6570\u636e\u751f\u6210\u8d22\u52a1\u62a5\u8868\u6570\u636e\u9879 DATA ( lt_fi_data ) = lcl_fi_report => create ( i_year = p_gjahr i_period = p_monat it_config = lt_config ) -> execute ( ). SORT lt_fi_data BY bukrs year period zitem . DATA lt_data TYPE tt_data . DATA ls_data TYPE ty_data . LOOP AT lt_fi_data INTO DATA ( ls_fi_data ) GROUP BY ( bukrs = ls_fi_data - bukrs year = ls_fi_data - year period = ls_fi_data - period ) INTO DATA ( ls_fi_data_grp ). LOOP AT GROUP ls_fi_data_grp INTO ls_fi_data . CLEAR ls_data . ls_data - bukrs = ls_fi_data - bukrs . ls_data - gjahr = ls_fi_data - year . ls_data - monat = ls_fi_data - period . ls_data - field1 = ls_fi_data - ztext . ls_data - field2 = ls_fi_data - zitem . ls_data - field3 = |{ ls_fi_data - period_current NUMBER = USER DECIMALS = 2 }|. ls_data - field4 = |{ ls_fi_data - period_total NUMBER = USER DECIMALS = 2 }|. INSERT ls_data INTO TABLE gt_data . ENDLOOP . ENDLOOP . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_export *&---------------------------------------------------------------------* *& \u5bfc\u51fa\u5230\u672c\u5730 *&---------------------------------------------------------------------* FORM frm_export . TYPES : BEGIN OF ty_replace , from TYPE string , to TYPE string , END OF ty_replace . TYPES tt_replace TYPE STANDARD TABLE OF ty_replace WITH EMPTY KEY . DATA lt_replace TYPE tt_replace . DATA ls_replace TYPE ty_replace . \" \u83b7\u53d6\u4e0b\u8f7d\u76ee\u5f55 DATA l_directory TYPE string . cl_gui_frontend_services => directory_browse ( CHANGING selected_folder = l_directory EXCEPTIONS cntl_error = 1 error_no_gui = 2 not_supported_by_gui = 3 ). IF sy - subrc <> 0 . MESSAGE ID sy - msgid TYPE sy - msgty NUMBER sy - msgno WITH sy - msgv1 sy - msgv2 sy - msgv3 sy - msgv4 . ENDIF . DATA ( l_buffer ) = lcl_fi_report => get_smw0_templete ( CONV # ( sy - tcode ) ). \" \u83b7\u53d6SMW0\u6a21\u677f\u6587\u4ef6 CHECK l_buffer IS NOT INITIAL . \" \u9010\u516c\u53f8\u5904\u7406 LOOP AT gt_data INTO DATA ( ls_data ) GROUP BY ( bukrs = ls_data - bukrs gjahr = ls_data - gjahr monat = ls_data - monat ) INTO DATA ( ls_data_grp ). SELECT SINGLE butxt FROM t001 WHETE bukrs = @ ls_data_grp - bukrs INTO @ DATA ( l_butxt ). \" \u7f16\u5236\u5355\u4f4d CLEAR ls_replace . ls_replace - from = | __BUKRS__ |. ls_replace - to = l_butxt . INSERT ls_replace INTO TABLE lt_replace . \" \u6253\u5370\u65e5\u671f CLEAR ls_replace . ls_replace - from = | __ZDATE__ |. ls_replace - to = |{ sy - datum ( 4 ) } \u5e74 { sy - datum + 4 ( 2 ) } \u6708 { sy - datum + 6 ( 2 ) } \u65e5 |. INSERT ls_replace INTO TABLE lt_replace . LOOP AT GROUP ls_data_grp INTO ls_data . \" \u672c\u6708\u91d1\u989d CLEAR ls_replace . ls_replace - from = | __PEROID_CURRENT_Z { ls_data - field2 } __ |. ls_replace - to = ls_data - field3 . INSERT ls_replace INTO TABLE lt_replace . \" \u7d2f\u8ba1\u91d1\u989d CLEAR ls_replace . ls_replace - from = | __PEROID_TOTAL_Z { ls_data - field2 } __ |. ls_replace - to = ls_data - field4 . INSERT ls_replace INTO TABLE lt_replace . ENDLOOP . \" \u66ff\u6362\u6587\u672c\u5185\u5bb9 DATA ( l_doc ) = l_buffer . lcl_fi_report => replace_texts ( EXPORTING it_replace = lt_replace CHANGING c_doc = l_doc ). CHECK l_doc IS NOT INITIAL . \" \u4e0b\u8f7d\u5230\u672c\u5730 TRY . DATA ( l_filename ) = |{ l_directory } \\\\\u5229\u6da6\u8868_ { l_bukrs_name } _ { sy - datum } .xlsx |. cl_openxml_helper => store_local_file ( im_file_name = l_filename im_data = l_doc ). CATCH cx_openxml_not_found cx_openxml_format cx_openxml_not_allowed INTO DATA ( lx_openxml ). MESSAGE lx_openxml -> get_text ( ) TYPE 'S' DISPLAY LIKE 'E' . RETURN . ENDTRY . ENDLOOP . ENDFORM . *&---------------------------------------------------------------------* *& Include zfi_balance_alv *&---------------------------------------------------------------------* *&---------------------------------------------------------------------* *& Form frm_display *&---------------------------------------------------------------------* *& ALV\u5c55\u793a *&---------------------------------------------------------------------* FORM frm_display TABLES ct_data TYPE STANDARD TABLE . DATA ls_layout TYPE lvc_s_layo . DATA lt_fieldcat TYPE STANDARD TABLE OF lvc_s_fcat . PERFORM frm_set_layout CHANGING ls_layout . PERFORM frm_set_fieldcat TABLES lt_fieldcat . CALL FUNCTION 'REUSE_ALV_GRID_DISPLAY_LVC' EXPORTING i_callback_program = sy - repid * i_callback_pf_status_set = 'FRM_PF_STATUS' * i_callback_user_command = 'FRM_USER_COMMAND' is_layout_lvc = ls_layout it_fieldcat_lvc = lt_fieldcat i_default = abap_true i_save = 'A' TABLES t_outtab = ct_data[] EXCEPTIONS program_error = 1 OTHERS = 2 . IF sy - subrc <> 0 . MESSAGE ID sy - msgid TYPE sy - msgty NUMBER sy - msgno WITH sy - msgv1 sy - msgv2 sy - msgv3 sy - msgv4 . ENDIF . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_set_layout *&---------------------------------------------------------------------* *& \u62a5\u8868\u5e03\u5c40\u8bbe\u7f6e *&---------------------------------------------------------------------* FORM frm_set_layout CHANGING cs_layout TYPE lvc_s_layo . CLEAR cs_layout . cs_layout - zebra = abap_true . \" \u6591\u9a6c\u7ebf cs_layout - cwidth_opt = abap_true . \" \u81ea\u52a8\u8c03\u6574ALVL\u5217\u5bbd cs_layout - sel_mode = 'A' . \" \u9009\u62e9\u6a21\u5f0f * cs_layout-ctab_fname = 'COLTAB'. \" \u5355\u5143\u683c\u989c\u8272\u8bbe\u7f6e ENDFORM . *&---------------------------------------------------------------------* *& Form frm_set_fieldcat *&---------------------------------------------------------------------* *& \u5b57\u6bb5\u76ee\u5f55\u8bbe\u7f6e *&---------------------------------------------------------------------* FORM frm_set_fieldcat TABLES ct_fieldcat TYPE lvc_t_fcat . DATA ls_fieldcat TYPE lvc_s_fcat . DEFINE _init_fieldcat . CLEAR ls_fieldcat . ls_fieldcat - fieldname = &1 . ls_fieldcat - tooltip = ls_fieldcat - coltext = ls_fieldcat - seltext = ls_fieldcat - scrtext_l = ls_fieldcat - scrtext_m = ls_fieldcat - scrtext_s = &2 . ls_fieldcat - ref_table = &3 . ls_fieldcat - ref_field = &4 . INSERT ls_fieldcat INTO TABLE ct_fieldcat . END-OF-DEFINITION . _init_fieldcat 'FIELD1' '\u9879\u76ee' '' '' . _init_fieldcat 'FIELD2' '\u884c\u6b21' '' '' . _init_fieldcat 'FIELD3' '\u672c\u6708\u91d1\u989d' '' '' . _init_fieldcat 'FIELD4' '\u7d2f\u8ba1\u91d1\u989d' '' '' . \" \u4e2a\u6027\u5316\u81ea\u5df1\u8f93\u51fa\u6570\u636e\u683c\u5f0f LOOP AT ct_fieldcat REFERENCE INTO DATA ( lr_fieldcat ). \" \u5b57\u6bb5\u663e\u793a\u5c5e\u6027\u8bbe\u7f6e CASE lr_fieldcat -> fieldname . WHEN OTHERS . ENDCASE . ENDLOOP . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_pf_status *&---------------------------------------------------------------------* *& \u8bbe\u7f6eGUI\u72b6\u6001 *&---------------------------------------------------------------------* FORM frm_pf_status USING ct_extab TYPE slis_t_extab . SET PF-STATUS 'STATUS' . SET TITLEBAR 'TITLE' . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_user_command *&---------------------------------------------------------------------* *& \u529f\u80fd\u54cd\u5e94 *&---------------------------------------------------------------------* FORM frm_user_command USING cv_ucomm LIKE sy - ucomm cs_selfield TYPE slis_selfield . \" \u5237\u65b0\u5c4f\u5e55\u6570\u636e\u5230\u5185\u8868 DATA : lo_grid TYPE REF TO cl_gui_alv_grid . CALL FUNCTION 'GET_GLOBALS_FROM_SLVC_FULLSCR' IMPORTING e_grid = lo_grid . CALL METHOD lo_grid -> check_changed_data . \" \u6309\u94ae\u529f\u80fd\u5b9e\u73b0 CASE cv_ucomm . WHEN '&IC1' . \" \u53cc\u51fb WHEN 'ZEXPORT' . \" \u5bfc\u51fa PERFORM frm_export . WHEN OTHERS . ENDCASE . \" \u5237\u65b0ALV \u663e\u793a\u503c cs_selfield - refresh = abap_true . cs_selfield - row_stable = abap_true . cs_selfield - col_stable = abap_true . ENDFORM . *&---------------------------------------------------------------------* *& START-OF-SELECTION *&---------------------------------------------------------------------* START-OF-SELECTION . PERFORM frm_main .","title":"\u5229\u6da6\u8868"},{"location":"fico/fi_report_pl/#_1","text":"\u5229\u6da6\u8868\u662f \u8d22\u52a1\u53d6\u503c\u6a21\u5757 \u7684\u4e00\u4e2a\u5b9e\u4f8b\u3002\u4e0b\u9762\u4ee3\u7801\u4f7f\u7528\u7684\u914d\u7f6e\u8868\u53ef\u53c2\u8003 \u9875\u9762 \u3002 \u793a\u4f8b\u4ee3\u7801 REPORT zfi_balance . *&---------------------------------------------------------------------* *& Include zfi_balance_top *&---------------------------------------------------------------------* TYPES : BEGIN OF ty_data , bukrs TYPE bukrs , gjahr TYPE gjahr , monat TYPE monat , field1 TYPE string , \" \u9879\u76ee field2 TYPE string , \" \u884c\u6b21 field3 TYPE string , \" \u672c\u6708\u91d1\u989d field4 TYPE string , \" \u7d2f\u8ba1\u91d1\u989d END OF ty_data . TYPES tt_data TYPE STANDARD TABLE OF ty_data . DATA gt_data TYPE tt_data . DATA gt_bukrs TYPE STANDARD TABLE OF bukrs WITH EMPTY KEY . *&---------------------------------------------------------------------* *& Include zfi_balance_sel *&---------------------------------------------------------------------* TABLES t001 . SELECT-OPTIONS s_bukrs FOR t001 - bukrs NO-EXTENSION NO INTERVALS OBLIGATORY . PARAMETERS p_gjahr TYPE gjahr OBLIGATORY DEFAULT sy - datum ( 4 ). PARAMETERS p_monat TYPE monat OBLIGATORY DEFAULT sy - datum + 4 ( 2 ). *&---------------------------------------------------------------------* *& Include zfir001_frm *&---------------------------------------------------------------------* *&---------------------------------------------------------------------* *& Form frm_main *&---------------------------------------------------------------------* *& \u62a5\u8868\u7a0b\u5e8f\u5165\u53e3 *&---------------------------------------------------------------------* FORM frm_main . PERFORM frm_auth_check . IF gt_bukrs IS INITIAL . RETURN . ENDIF . PERFORM frm_gen_profit_loss . \" \u73b0\u91d1\u6d41\u91cf\u8868 PERFORM frm_display TABLES gt_data . \" \u5c55\u793a ENDFORM . *&---------------------------------------------------------------------* *& Form frm_auth_check *&---------------------------------------------------------------------* *& \u6743\u9650\u68c0\u67e5 *&---------------------------------------------------------------------* FORM frm_auth_check . DATA lt_bukrs_opt TYPE RANGE OF bukrs . SELECT 'I' AS sign , 'EQ' AS option , bukrs AS low FROM t001 WHERE bukrs IN @ s_bukrs INTO TABLE @ lt_bukrs_opt . IF lt_bukrs_opt IS INITIAL . l_subrc = 1 . l_msg = | \u516c\u53f8\u4e0d\u5b58\u5728 |. ENDIF . SORT lt_bukrs_opt . DELETE ADJACENT DUPLICATES FROM lt_bukrs_opt COMPARING ALL FIELDS . LOOP AT lt_bukrs_opt INTO DATA ( ls_bukrs_opt ). AUTHORITY-CHECK OBJECT 'F_BKPF_BUK' ID 'BUKRS' FIELD ls_bukrs_opt - low ID 'ACTVT' FIELD i_actvt . IF sy - subrc <> 0 . MESSAGE | \u65e0\u516c\u53f8 { ls_bukrs_opt - low } \u6743\u9650 | TYPE 'S' DISPLAY LIKE 'E' . DELETE lt_bukrs_opt . ENDIF . ENDLOOP . s_bukrs[] = lt_bukrs_opt . IF s_bukrs[] IS INITIAL . LEAVE LIST - PROCESSING . ENDIF . SELECT bukrs FROM t001 WHERE bukrs IN @ s_bukrs INTO TABLE @ gt_bukrs . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_get_config *&---------------------------------------------------------------------* *& \u8bfb\u53d6\u5168\u90e8\u516c\u53f8\u914d\u7f6e *&---------------------------------------------------------------------* FORM frm_get_config_all TABLES et_config TYPE tt_config . DATA lt_config TYPE tt_config . LOOP AT gt_bukrs INTO DATA ( l_bukrs ). PERFORM frm_get_config TABLES lt_config USING '2' \" \u5229\u6da6\u8868 l_bukrs . INSERT LINES OF lt_config INTO TABLE et_config . ENDLOOP . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_get_config *&---------------------------------------------------------------------* *& \u8bfb\u53d6\u5355\u4e2a\u516c\u53f8\u914d\u7f6e *&---------------------------------------------------------------------* FORM frm_get_config TABLES et_config TYPE tt_config USING i_fi_report TYPE string i_bukrs TYPE bukrs . \" \u8003\u8651\u9002\u914d\u7b26 DATA lt_bukrs_opt TYPE RANGE OF bukrs . lt_bukrs_opt = VALUE # ( sign = 'I' option = 'EQ' ( low = i_bukrs ) ( low = |{ i_bukrs ( 3 ) } * | ) ( low = |{ i_bukrs ( 2 ) } * | ) ( low = |{ i_bukrs ( 1 ) } * | ) ( low = '*' ) ( low = '' ) ). \" \u53d6\u914d\u7f6e\u6570\u636e SELECT * FROM zfit0001 WHERE zfi_report = @ i_fi_report AND bukrs IN @ lt_bukrs_opt INTO TABLE @ DATA ( lt_zfit0001 ). \" \u89e3\u6790\u914d\u7f6e\u6570\u636e LOOP AT lt_zfit0001 INTO DATA ( ls_zfit0001 ). DATA ls_config TYPE ty_config . CLEAR ls_config . ls_config - bukrs = ls_zfit0001 - bukrs . \" \u516c\u53f8 ls_config - zitem = ls_zfit0001 - zitem . \" \u9879\u76ee ls_config - zitem_sub = ls_zfit0001 - zitem_sub . \" \u5b50\u9879\u76ee CASE ls_zfit0001 - ztype . WHEN '0' . \" \u6587\u672c\u9879 ls_config - ztext = ls_zfit0001 - ztext . \" \u9879\u76ee\u540d\u79f0 WHEN '1' . \" \u7b5b\u9009\u9879 \" \u79d1\u76ee IF ls_zfit0001 - racct_to IS NOT INITIAL . INSERT VALUE # ( sign = 'I' option = 'BT' low = ls_zfit0001 - racct_from high = ls_zfit0001 - racct_to ) INTO TABLE ls_config - t_racct_opt . ELSE . INSERT VALUE # ( sign = 'I' option = 'EQ' low = ls_zfit0001 - racct_from ) INTO TABLE ls_config - t_racct_opt . ENDIF . \" \u539f\u56e0\u4ee3\u7801 INSERT VALUE # ( name = 'RSTGR' \" TY_DATEIL\u5b57\u6bb5\u540d\uff0c\u540e\u7eed\u52a8\u6001\u7b5b\u9009 t_range_opt = VALUE # ( ( sign = 'I' option = 'EQ' low = ls_zfit0001 - rstgr ) ) ) INTO TABLE ls_config - t_filter . \" \u529f\u80fd\u8303\u56f4 INSERT VALUE # ( name = 'RFAREA' \" TY_DATEIL\u5b57\u6bb5\u540d\uff0c\u540e\u7eed\u52a8\u6001\u7b5b\u9009 t_range_opt = VALUE # ( ( sign = 'I' option = 'EQ' low = ls_zfit0001 - rfarea ) ) ) INTO TABLE ls_config - t_filter . WHEN '2' . \" \u6c47\u603b\u9879 IF ls_zfit0001 - zitem_to IS INITIAL OR ls_zfit0001 - zitem_to = '' . ls_zfit0001 - zitem_to = ls_zfit0001 - zitem_from . ENDIF . WHILE ls_zfit0001 - zitem_from <= ls_zfit0001 - zitem_to . INSERT ls_zfit0001 - zitem_from INTO TABLE ls_config - t_collect . ls_zfit0001 - zitem_from = ls_zfit0001 - zitem_from + 1 . ENDWHILE . ls_config - zreverse = ls_zfit0001 - zreverse . \" \u53cd\u5411\u6807\u8bc6 WHEN OTHERS . ENDCASE . \" CASE ls_zfit0001-ztype INSERT ls_config INTO TABLE et_config . ENDLOOP . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_gen_profit_loss *&---------------------------------------------------------------------* *& \u6784\u5efa\u5229\u6da6\u8868 *&---------------------------------------------------------------------* FORM frm_gen_profit_loss . DATA lt_config TYPE tt_config . PERFORM frm_get_config_all TABLES lt_config . \" \u83b7\u53d6\u914d\u7f6e\u6570\u636e \" \u6839\u636e\u914d\u7f6e\u6570\u636e\u751f\u6210\u8d22\u52a1\u62a5\u8868\u6570\u636e\u9879 DATA ( lt_fi_data ) = lcl_fi_report => create ( i_year = p_gjahr i_period = p_monat it_config = lt_config ) -> execute ( ). SORT lt_fi_data BY bukrs year period zitem . DATA lt_data TYPE tt_data . DATA ls_data TYPE ty_data . LOOP AT lt_fi_data INTO DATA ( ls_fi_data ) GROUP BY ( bukrs = ls_fi_data - bukrs year = ls_fi_data - year period = ls_fi_data - period ) INTO DATA ( ls_fi_data_grp ). LOOP AT GROUP ls_fi_data_grp INTO ls_fi_data . CLEAR ls_data . ls_data - bukrs = ls_fi_data - bukrs . ls_data - gjahr = ls_fi_data - year . ls_data - monat = ls_fi_data - period . ls_data - field1 = ls_fi_data - ztext . ls_data - field2 = ls_fi_data - zitem . ls_data - field3 = |{ ls_fi_data - period_current NUMBER = USER DECIMALS = 2 }|. ls_data - field4 = |{ ls_fi_data - period_total NUMBER = USER DECIMALS = 2 }|. INSERT ls_data INTO TABLE gt_data . ENDLOOP . ENDLOOP . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_export *&---------------------------------------------------------------------* *& \u5bfc\u51fa\u5230\u672c\u5730 *&---------------------------------------------------------------------* FORM frm_export . TYPES : BEGIN OF ty_replace , from TYPE string , to TYPE string , END OF ty_replace . TYPES tt_replace TYPE STANDARD TABLE OF ty_replace WITH EMPTY KEY . DATA lt_replace TYPE tt_replace . DATA ls_replace TYPE ty_replace . \" \u83b7\u53d6\u4e0b\u8f7d\u76ee\u5f55 DATA l_directory TYPE string . cl_gui_frontend_services => directory_browse ( CHANGING selected_folder = l_directory EXCEPTIONS cntl_error = 1 error_no_gui = 2 not_supported_by_gui = 3 ). IF sy - subrc <> 0 . MESSAGE ID sy - msgid TYPE sy - msgty NUMBER sy - msgno WITH sy - msgv1 sy - msgv2 sy - msgv3 sy - msgv4 . ENDIF . DATA ( l_buffer ) = lcl_fi_report => get_smw0_templete ( CONV # ( sy - tcode ) ). \" \u83b7\u53d6SMW0\u6a21\u677f\u6587\u4ef6 CHECK l_buffer IS NOT INITIAL . \" \u9010\u516c\u53f8\u5904\u7406 LOOP AT gt_data INTO DATA ( ls_data ) GROUP BY ( bukrs = ls_data - bukrs gjahr = ls_data - gjahr monat = ls_data - monat ) INTO DATA ( ls_data_grp ). SELECT SINGLE butxt FROM t001 WHETE bukrs = @ ls_data_grp - bukrs INTO @ DATA ( l_butxt ). \" \u7f16\u5236\u5355\u4f4d CLEAR ls_replace . ls_replace - from = | __BUKRS__ |. ls_replace - to = l_butxt . INSERT ls_replace INTO TABLE lt_replace . \" \u6253\u5370\u65e5\u671f CLEAR ls_replace . ls_replace - from = | __ZDATE__ |. ls_replace - to = |{ sy - datum ( 4 ) } \u5e74 { sy - datum + 4 ( 2 ) } \u6708 { sy - datum + 6 ( 2 ) } \u65e5 |. INSERT ls_replace INTO TABLE lt_replace . LOOP AT GROUP ls_data_grp INTO ls_data . \" \u672c\u6708\u91d1\u989d CLEAR ls_replace . ls_replace - from = | __PEROID_CURRENT_Z { ls_data - field2 } __ |. ls_replace - to = ls_data - field3 . INSERT ls_replace INTO TABLE lt_replace . \" \u7d2f\u8ba1\u91d1\u989d CLEAR ls_replace . ls_replace - from = | __PEROID_TOTAL_Z { ls_data - field2 } __ |. ls_replace - to = ls_data - field4 . INSERT ls_replace INTO TABLE lt_replace . ENDLOOP . \" \u66ff\u6362\u6587\u672c\u5185\u5bb9 DATA ( l_doc ) = l_buffer . lcl_fi_report => replace_texts ( EXPORTING it_replace = lt_replace CHANGING c_doc = l_doc ). CHECK l_doc IS NOT INITIAL . \" \u4e0b\u8f7d\u5230\u672c\u5730 TRY . DATA ( l_filename ) = |{ l_directory } \\\\\u5229\u6da6\u8868_ { l_bukrs_name } _ { sy - datum } .xlsx |. cl_openxml_helper => store_local_file ( im_file_name = l_filename im_data = l_doc ). CATCH cx_openxml_not_found cx_openxml_format cx_openxml_not_allowed INTO DATA ( lx_openxml ). MESSAGE lx_openxml -> get_text ( ) TYPE 'S' DISPLAY LIKE 'E' . RETURN . ENDTRY . ENDLOOP . ENDFORM . *&---------------------------------------------------------------------* *& Include zfi_balance_alv *&---------------------------------------------------------------------* *&---------------------------------------------------------------------* *& Form frm_display *&---------------------------------------------------------------------* *& ALV\u5c55\u793a *&---------------------------------------------------------------------* FORM frm_display TABLES ct_data TYPE STANDARD TABLE . DATA ls_layout TYPE lvc_s_layo . DATA lt_fieldcat TYPE STANDARD TABLE OF lvc_s_fcat . PERFORM frm_set_layout CHANGING ls_layout . PERFORM frm_set_fieldcat TABLES lt_fieldcat . CALL FUNCTION 'REUSE_ALV_GRID_DISPLAY_LVC' EXPORTING i_callback_program = sy - repid * i_callback_pf_status_set = 'FRM_PF_STATUS' * i_callback_user_command = 'FRM_USER_COMMAND' is_layout_lvc = ls_layout it_fieldcat_lvc = lt_fieldcat i_default = abap_true i_save = 'A' TABLES t_outtab = ct_data[] EXCEPTIONS program_error = 1 OTHERS = 2 . IF sy - subrc <> 0 . MESSAGE ID sy - msgid TYPE sy - msgty NUMBER sy - msgno WITH sy - msgv1 sy - msgv2 sy - msgv3 sy - msgv4 . ENDIF . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_set_layout *&---------------------------------------------------------------------* *& \u62a5\u8868\u5e03\u5c40\u8bbe\u7f6e *&---------------------------------------------------------------------* FORM frm_set_layout CHANGING cs_layout TYPE lvc_s_layo . CLEAR cs_layout . cs_layout - zebra = abap_true . \" \u6591\u9a6c\u7ebf cs_layout - cwidth_opt = abap_true . \" \u81ea\u52a8\u8c03\u6574ALVL\u5217\u5bbd cs_layout - sel_mode = 'A' . \" \u9009\u62e9\u6a21\u5f0f * cs_layout-ctab_fname = 'COLTAB'. \" \u5355\u5143\u683c\u989c\u8272\u8bbe\u7f6e ENDFORM . *&---------------------------------------------------------------------* *& Form frm_set_fieldcat *&---------------------------------------------------------------------* *& \u5b57\u6bb5\u76ee\u5f55\u8bbe\u7f6e *&---------------------------------------------------------------------* FORM frm_set_fieldcat TABLES ct_fieldcat TYPE lvc_t_fcat . DATA ls_fieldcat TYPE lvc_s_fcat . DEFINE _init_fieldcat . CLEAR ls_fieldcat . ls_fieldcat - fieldname = &1 . ls_fieldcat - tooltip = ls_fieldcat - coltext = ls_fieldcat - seltext = ls_fieldcat - scrtext_l = ls_fieldcat - scrtext_m = ls_fieldcat - scrtext_s = &2 . ls_fieldcat - ref_table = &3 . ls_fieldcat - ref_field = &4 . INSERT ls_fieldcat INTO TABLE ct_fieldcat . END-OF-DEFINITION . _init_fieldcat 'FIELD1' '\u9879\u76ee' '' '' . _init_fieldcat 'FIELD2' '\u884c\u6b21' '' '' . _init_fieldcat 'FIELD3' '\u672c\u6708\u91d1\u989d' '' '' . _init_fieldcat 'FIELD4' '\u7d2f\u8ba1\u91d1\u989d' '' '' . \" \u4e2a\u6027\u5316\u81ea\u5df1\u8f93\u51fa\u6570\u636e\u683c\u5f0f LOOP AT ct_fieldcat REFERENCE INTO DATA ( lr_fieldcat ). \" \u5b57\u6bb5\u663e\u793a\u5c5e\u6027\u8bbe\u7f6e CASE lr_fieldcat -> fieldname . WHEN OTHERS . ENDCASE . ENDLOOP . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_pf_status *&---------------------------------------------------------------------* *& \u8bbe\u7f6eGUI\u72b6\u6001 *&---------------------------------------------------------------------* FORM frm_pf_status USING ct_extab TYPE slis_t_extab . SET PF-STATUS 'STATUS' . SET TITLEBAR 'TITLE' . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_user_command *&---------------------------------------------------------------------* *& \u529f\u80fd\u54cd\u5e94 *&---------------------------------------------------------------------* FORM frm_user_command USING cv_ucomm LIKE sy - ucomm cs_selfield TYPE slis_selfield . \" \u5237\u65b0\u5c4f\u5e55\u6570\u636e\u5230\u5185\u8868 DATA : lo_grid TYPE REF TO cl_gui_alv_grid . CALL FUNCTION 'GET_GLOBALS_FROM_SLVC_FULLSCR' IMPORTING e_grid = lo_grid . CALL METHOD lo_grid -> check_changed_data . \" \u6309\u94ae\u529f\u80fd\u5b9e\u73b0 CASE cv_ucomm . WHEN '&IC1' . \" \u53cc\u51fb WHEN 'ZEXPORT' . \" \u5bfc\u51fa PERFORM frm_export . WHEN OTHERS . ENDCASE . \" \u5237\u65b0ALV \u663e\u793a\u503c cs_selfield - refresh = abap_true . cs_selfield - row_stable = abap_true . cs_selfield - col_stable = abap_true . ENDFORM . *&---------------------------------------------------------------------* *& START-OF-SELECTION *&---------------------------------------------------------------------* START-OF-SELECTION . PERFORM frm_main .","title":"\u5229\u6da6\u8868"},{"location":"fico/fixed_assets_report/","text":"\u56fa\u5b9a\u8d44\u4ea7\u660e\u7ec6\u62a5\u8868 \u00b6 \u4e3b\u7a0b\u5e8f *&---------------------------------------------------------------------* *& \u4f5c\u8005 Nefvcore *& \u521b\u5efa\u65e5\u671f 2022\u5e748\u670823\u65e5 *& \u63cf\u8ff0 \u56fa\u5b9a\u8d44\u4ea7\u660e\u7ec6\u62a5\u8868 *&---------------------------------------------------------------------* REPORT zfixed_assets . INCLUDE zfir017_top . INCLUDE zfir017_sel . INCLUDE zfir017_frm . INCLUDE zfir017_alv . START-OF-SELECTION . PERFORM frm_main . \u5168\u5c40\u53c2\u6570 TYPES : ty_amount TYPE p LENGTH 16 DECIMALS 2 . \" P\u503c\u4e0a\u9650 TYPES : BEGIN OF ty_data , bukrs TYPE anla - bukrs , \" \u516c\u53f8\u4ee3\u7801 butxt TYPE t001 - butxt , \" \u516c\u53f8\u4ee3\u7801\u63cf\u8ff0 anln1 TYPE anla - anln1 , \" \u8d44\u4ea7\u4e3b\u53f7 anln2 TYPE anla - anln2 , \" \u8d44\u4ea7\u5b50\u53f7 txt50 TYPE anla - txt50 , \" \u8d44\u4ea7\u63cf\u8ff0\u4e00 txa50 TYPE anla - txa50 , \" \u8d44\u4ea7\u63cf\u8ff0\u4e8c anlhtxt TYPE anlh - anlhtxt , \" \u8d44\u4ea7\u4e3b\u53f7\u6587\u672c sernr TYPE anla - sernr , \" \u5e8f\u5217\u53f7 invnr TYPE anla - invnr , \" \u5b58\u8d27\u53f7 invzu TYPE anla - invzu , \" \u5e93\u5b58\u6ce8\u8bb0 anlkl TYPE anla - anlkl , \" \u8d44\u4ea7\u5206\u7c7b anlkl_text TYPE ankt - txk20 , \" \u8d44\u4ea7\u5206\u7c7b\u63cf\u8ff0 aktiv TYPE anla - aktiv , \" \u8d44\u672c\u5316\u65e5\u671f deakt TYPE anla - deakt , \" \u4e0d\u6d3b\u52a8\u65e5\u671f kostl TYPE anlz - kostl , \" \u6210\u672c\u4e2d\u5fc3 kostl_text TYPE cskt - ktext , \" \u6210\u672c\u4e2d\u5fc3\u63cf\u8ff0 kostlv TYPE anlz - kostlv , \" \u8d23\u4efb\u6210\u672c\u4e2d\u5fc3 kostlv_text TYPE cskt - ktext , \" \u8d23\u4efb\u6210\u672c\u4e2d\u5fc3\u63cf\u8ff0 werks TYPE anlz - werks , \" \u5de5\u5382 stort TYPE anlz - stort , \" \u4f4d\u7f6e stort_text TYPE t499s - ktext , \" \u4f4d\u7f6e\u63cf\u8ff0 raumn TYPE anlz - raumn , \" \u4f7f\u7528\u4eba ord41 TYPE anla - ord41 , \" \u8d44\u4ea7\u72b6\u6001 ordtx TYPE t087t - ordtx , \" \u8d44\u4ea7\u72b6\u6001\u63cf\u8ff0 equnr TYPE v_equi - equnr , \" \u8bbe\u5907\u53f7 eqktx TYPE v_equi - eqktx , \" \u8bbe\u5907\u63cf\u8ff0 liefe TYPE anla - liefe , \" \u4f9b\u5e94\u5546 herst TYPE anla - herst , \" \u5236\u9020\u5546 afasl TYPE anlb - afasl , \" \u6298\u65e7\u7801 months_valid TYPE i , \" \u4f7f\u7528\u6708\u9650 months_accrued TYPE i , \" \u5df2\u8ba1\u63d0\u6298\u65e7\u6708\u4efd afabg TYPE anlb - afabg , \" \u6298\u65e7\u5f00\u59cb\u65e5\u671f ori_year_begin TYPE ty_amount , \" \u5e74\u521d\u8d44\u4ea7\u539f\u503c ori_year_changed TYPE ty_amount , \" \u672c\u5e74\u8d44\u4ea7\u4ef7\u503c\u53d8\u66f4 ori_year_end TYPE ty_amount , \" \u671f\u672b\u8d44\u4ea7\u539f\u503c dep_year_begin TYPE ty_amount , \" \u5e74\u521d\u8d44\u4ea7\u7d2f\u8ba1\u6298\u65e7 dep_year_accrual TYPE ty_amount , \" \u672c\u5e74\u8d44\u4ea7\u8ba1\u63d0\u6298\u65e7 dep_period_accrual TYPE ty_amount , \" \u672c\u6708\u8d44\u4ea7\u8ba1\u63d0\u6298\u65e7 dep_year_changed TYPE ty_amount , \" \u672c\u5e74\u6298\u65e7\u4ef7\u503c\u53d8\u66f4 dep_year_end TYPE ty_amount , \" \u671f\u672b\u7d2f\u8ba1\u6298\u65e7 amount TYPE ty_amount , \" \u51c0\u503c adatu TYPE anlz - adatu , \" \u8d44\u4ea7\u8d77\u59cb\u65e5\u671f bdatu TYPE anlz - bdatu , \" \u8d44\u4ea7\u7ed3\u675f\u65e5\u671f ndjar TYPE anlb - ndjar , \" \u4f7f\u7528\u5e74\u9650 ndper TYPE anlb - ndper , \" \u671f\u95f4 zsel TYPE xfeld , mtype TYPE bapi_mtype , msg TYPE bapi_msg , t_scol TYPE lvc_t_scol , END OF ty_data . TYPES tt_data TYPE STANDARD TABLE OF ty_data WITH EMPTY KEY . DATA gt_data TYPE tt_data . \u5c4f\u5e55\u5b9a\u4e49 TABLES anla . TABLES anlb . TABLES anlz . SELECT-OPTIONS s_bukrs FOR anla - bukrs OBLIGATORY . SELECT-OPTIONS s_anlkl FOR anla - anlkl DEFAULT '1100' TO '9000' . SELECT-OPTIONS s_anln1 FOR anla - anln1 . SELECT-OPTIONS s_kostl FOR anlz - kostl . SELECT-OPTIONS s_kostlv FOR anlz - kostlv . SELECT-OPTIONS s_ord41 FOR anla - ord41 . PARAMETERS p_adatu TYPE sy - datum OBLIGATORY DEFAULT sy - datum . SELECT-OPTIONS s_afabe FOR anlb - afabe OBLIGATORY NO INTERVALS NO-EXTENSION . \u5b50\u4f8b\u7a0b *&---------------------------------------------------------------------* *& Form frm_main *&---------------------------------------------------------------------* *& text *&---------------------------------------------------------------------* FORM frm_main . PERFORM frm_auth_check . PERFORM frm_get_data . IF gt_data IS INITIAL . MESSAGE '\u65e0\u6570\u636e' TYPE 'S' DISPLAY LIKE 'E' . RETURN . ENDIF . PERFORM frm_get_ord41 . \" \u8d44\u4ea7\u72b6\u6001 PERFORM frm_get_equi . \" \u8bbe\u5907 PERFORM frm_get_amount . \" \u539f\u503c\u548c\u6298\u65e7\u91d1\u989d PERFORM frm_get_text . \" \u6587\u672c\u53d6\u503c PERFORM frm_display TABLES gt_data[] . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_auth_check *&---------------------------------------------------------------------* *& text *&---------------------------------------------------------------------* *& --> p1 text *& <-- p2 text *&---------------------------------------------------------------------* FORM frm_auth_check . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_get_data *&---------------------------------------------------------------------* *& text *&---------------------------------------------------------------------* *& --> p1 text *& <-- p2 text *&---------------------------------------------------------------------* FORM frm_get_data . SELECT anla~bukrs , anla~anln1 , anla~anln2 , anla~txt50 , anla~txa50 , anla~sernr , anla~invnr , anla~invzu , anla~anlkl , anla~ord41 , anla~aktiv , anla~deakt , anla~liefe , anla~herst , anlb~afasl , anlb~ndjar , anlb~ndper , anlb~afabg , anlz~kostl , anlz~kostlv , anlz~werks , anlz~stort , anlz~raumn , anlz~adatu , anlz~bdatu FROM anla LEFT JOIN anlb ON anla~bukrs = anlb~bukrs AND anla~anln1 = anlb~anln1 AND anla~anln2 = anlb~anln2 LEFT JOIN anlz ON anla~bukrs = anlz~bukrs AND anla~anln1 = anlz~anln1 AND anla~anln2 = anlz~anln2 WHERE anla~bukrs IN @ s_bukrs AND anla~anln1 IN @ s_anln1 AND anla~anlkl IN @ s_anlkl AND anla~ord41 IN @ s_ord41 AND anlb~afabe IN @ s_afabe AND anlz~kostl IN @ s_kostl AND anlz~kostlv IN @ s_kostlv INTO CORRESPONDING FIELDS OF TABLE @ gt_data . \" \u67e5\u8be2\u65e5\u671f IF p_adatu IS NOT INITIAL . DELETE gt_data WHERE adatu > p_adatu OR bdatu < p_adatu . ENDIF . LOOP AT gt_data REFERENCE INTO DATA ( lr_data ). lr_data -> months_valid = lr_data -> ndjar * 12 + lr_data -> ndper . \" \u4f7f\u7528\u6708\u9650 \" \u5df2\u8ba1\u63d0\u6298\u65e7\u6708\u4efd DATA l_date_from TYPE datum . DATA l_date_to TYPE datum . DATA l_months TYPE vtbbewe - atage . l_date_to = |{ p_adatu ( 6 ) } 01 |. l_date_from = |{ lr_data -> afabg ( 6 ) } 01 |. IF l_date_from < l_date_to . CALL FUNCTION 'FIMA_DAYS_AND_MONTHS_AND_YEARS' EXPORTING i_date_from = l_date_from i_date_to = l_date_to IMPORTING e_months = l_months . l_months = l_months + 1 . ELSE . l_months = 1 . ENDIF . \" \u53d6\u6700\u5c0f\u503c IF lr_data -> months_valid > l_months . lr_data -> months_accrued = l_months . ELSE . lr_data -> months_accrued = lr_data -> months_valid . ENDIF . ENDLOOP . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_get_ORD41 *&---------------------------------------------------------------------* *& \u4ece\u5386\u53f2\u4fee\u6539\u8bb0\u5f55\u8868\u4e2d\u67e5\u627e\u8d44\u4ea7\u72b6\u6001 *& \u67e5\u627e\u5931\u8d25\u9ed8\u8ba4\u53d6\u4e3b\u6570\u636eORD41\u7684\u503c *&---------------------------------------------------------------------* FORM frm_get_ord41 . CHECK gt_data IS NOT INITIAL . SELECT ds~bukrs , ds~anln1 , ds~anln2 , cdhdr~udate , cdpos~value_new FROM @ gt_data AS ds JOIN cdhdr ON cdhdr~objectid = 'ANLA' AND concat ( concat ( ds~bukrs , ds~anln1 ), ds~anln2 ) = cdhdr~objectid AND cdhdr~udate > @ p_adatu JOIN cdpos ON cdhdr~objectclas = cdpos~objectclas AND cdhdr~objectid = cdpos~objectid AND cdhdr~changenr = cdpos~changenr AND cdpos~fname = 'ORD41' INTO TABLE @ DATA ( lt_record ). \" \u6309\u6700\u8fd1\u4fee\u6539\u65e5\u671f\u6392\u5e8f SORT lt_record BY bukrs anln1 anln2 udate DESCENDING . LOOP AT gt_data REFERENCE INTO DATA ( lr_data ). READ TABLE lt_record INTO DATA ( ls_record ) WITH KEY bukrs = lr_data -> bukrs anln1 = lr_data -> anln1 anln2 = lr_data -> anln2 BINARY SEARCH . IF sy - subrc = 0 . lr_data -> ord41 = ls_record - value_new . ENDIF . ENDLOOP . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_get_equi *&---------------------------------------------------------------------* *& text *&---------------------------------------------------------------------* FORM frm_get_equi . CHECK gt_data IS NOT INITIAL . SELECT bukrs , anlnr , anlun , equnr , eqktx FROM v_equi FOR ALL ENTRIES IN @ gt_data WHERE bukrs = @ gt_data - bukrs AND anlnr = @ gt_data - anln1 AND anlun = @ gt_data - anln2 INTO TABLE @ DATA ( lt_equi ). SORT lt_equi BY bukrs anlnr anlun . LOOP AT gt_data REFERENCE INTO DATA ( lr_data ). READ TABLE lt_equi INTO DATA ( ls_equi ) WITH KEY bukrs = lr_data -> bukrs anlnr = lr_data -> anln1 anlun = lr_data -> anln2 BINARY SEARCH . IF sy - subrc = 0 . lr_data -> equnr = ls_equi - equnr . lr_data -> eqktx = ls_equi - eqktx . ENDIF . ENDLOOP . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_get_amount *&---------------------------------------------------------------------* *& text *&---------------------------------------------------------------------* FORM frm_get_amount . CHECK gt_data IS NOT INITIAL . DATA l_date_from TYPE datum . DATA l_date_to TYPE datum . l_date_from = |{ p_adatu ( 4 ) } 0101 |. l_date_to = p_adatu . \" \u8d44\u4ea7\u503c\u5b57\u6bb5 SELECT bukrs , anln1 , anln2 , gjahr , afabe , zujhr , zucod , kansw , knafa , ksafa , kaafa FROM anlc FOR ALL ENTRIES IN @ gt_data WHERE bukrs = @ gt_data - bukrs AND anln1 = @ gt_data - anln1 AND anln2 = @ gt_data - anln2 AND gjahr = @ p_adatu ( 4 ) AND afabe IN @ s_afabe INTO TABLE @ DATA ( lt_anlc ). SORT lt_anlc BY bukrs anln1 anln2 . \" \u8d44\u4ea7\u671f\u95f4\u4ef7\u503c SELECT bukrs , gjahr , peraf , afbnr , anln1 , anln2 , afaber , zujhr , zucod , nafaz , safaz , aafaz FROM anlp FOR ALL ENTRIES IN @ gt_data WHERE bukrs = @ gt_data - bukrs AND anln1 = @ gt_data - anln1 AND anln2 = @ gt_data - anln2 AND gjahr = @ p_adatu ( 4 ) AND peraf <= @ p_adatu + 4 ( 2 ) AND afaber IN @ s_afabe INTO TABLE @ DATA ( lt_anlp ). SORT lt_anlp BY bukrs anln1 anln2 . \" \u8d44\u4ea7\u539f\u503c\u62ac\u5934\u51ed\u8bc1 IF l_date_from <= l_date_to . SELECT bukrs , anln1 , anln2 , gjahr , lnran FROM anek FOR ALL ENTRIES IN @ gt_data WHERE bukrs = @ gt_data - bukrs AND anln1 = @ gt_data - anln1 AND anln2 = @ gt_data - anln2 AND budat BETWEEN @ l_date_from AND @ l_date_to INTO TABLE @ DATA ( lt_anek_ori ). SORT lt_anek_ori BY bukrs anln1 anln2 . ENDIF . \" \u8d44\u4ea7\u539f\u503c\u51ed\u8bc1\u884c\u9879\u76ee IF lt_anek_ori IS NOT INITIAL . \" \u8d44\u4ea7\u4e1a\u52a1\u7c7b\u578b DATA lt_bwasl_opt TYPE RANGE OF tabw - bwasl . SELECT 'I' AS sign , 'EQ' AS option , bwasl AS low FROM tabw JOIN tabwg ON tabw~bwagrp = tabwg~bwagrp AND tabwg~bwatyp <> '4' AND tabwg~xbnafa <> 'X' INTO TABLE @ lt_bwasl_opt GROUP BY bwasl . \" \u8d44\u4ea7\u884c\u9879\u76ee IF lt_bwasl_opt IS NOT INITIAL . SELECT bukrs , anln1 , anln2 , gjahr , lnran , anbtr FROM anep FOR ALL ENTRIES IN @ lt_anek_ori WHERE bukrs = @ lt_anek_ori - bukrs AND anln1 = @ lt_anek_ori - anln1 AND anln2 = @ lt_anek_ori - anln2 AND gjahr = @ lt_anek_ori - gjahr AND lnran = @ lt_anek_ori - lnran AND bwasl IN @ lt_bwasl_opt AND afabe IN @ s_afabe INTO TABLE @ DATA ( lt_anep_ori ). SORT lt_anep_ori BY bukrs anln1 anln2 gjahr lnran . ENDIF . ENDIF . \" \u8d44\u4ea7\u6298\u65e7\u62ac\u5934\u51ed\u8bc1 IF l_date_from <= l_date_to . SELECT bukrs , anln1 , anln2 , gjahr , lnran FROM anek FOR ALL ENTRIES IN @ gt_data WHERE bukrs = @ gt_data - bukrs AND anln1 = @ gt_data - anln1 AND anln2 = @ gt_data - anln2 AND gjahr = @ p_adatu ( 4 ) AND monat <= @ p_adatu + 4 ( 2 ) INTO TABLE @ DATA ( lt_anek_dep ). SORT lt_anek_dep BY bukrs anln1 anln2 . \" \u8d44\u4ea7\u539f\u503c\u51ed\u8bc1\u884c\u9879\u76ee IF lt_anek_dep IS NOT INITIAL . \" \u8d44\u4ea7\u884c\u9879\u76ee SELECT bukrs , anln1 , anln2 , gjahr , lnran , afabe , zujhr , zucod , nafal , safal , aafal , nafav , safav , aafav , aufnv FROM anea FOR ALL ENTRIES IN @ lt_anek_dep WHERE bukrs = @ lt_anek_dep - bukrs AND anln1 = @ lt_anek_dep - anln1 AND anln2 = @ lt_anek_dep - anln2 AND gjahr = @ lt_anek_dep - gjahr AND lnran = @ lt_anek_dep - lnran AND afabe IN @ s_afabe INTO TABLE @ DATA ( lt_anea_dep ). SORT lt_anea_dep BY bukrs anln1 anln2 gjahr lnran . ENDIF . ENDIF . \" \u9010\u8d44\u4ea7\u5904\u7406 LOOP AT gt_data REFERENCE INTO DATA ( lr_data ). \" \u5e74\u521d\u503c READ TABLE lt_anlc TRANSPORTING NO FIELDS WITH KEY bukrs = lr_data -> bukrs anln1 = lr_data -> anln1 anln2 = lr_data -> anln2 BINARY SEARCH . IF sy - subrc = 0 . LOOP AT lt_anlc INTO DATA ( ls_anlc ) FROM sy - tabix . IF ls_anlc - bukrs <> lr_data -> bukrs OR ls_anlc - anln1 <> lr_data -> anln1 OR ls_anlc - anln2 <> lr_data -> anln2 . EXIT . ENDIF . \" \u5e74\u521d\u8d44\u4ea7\u539f\u503c lr_data -> ori_year_begin += ls_anlc - kansw . \" \u5e74\u521d\u8d44\u4ea7\u7d2f\u8ba1\u6298\u65e7 lr_data -> dep_year_begin += ( ls_anlc - knafa + ls_anlc - ksafa + ls_anlc - kaafa ) * - 1 . ENDLOOP . ENDIF . \" \u671f\u95f4\u503c READ TABLE lt_anlp TRANSPORTING NO FIELDS WITH KEY bukrs = lr_data -> bukrs anln1 = lr_data -> anln1 anln2 = lr_data -> anln2 BINARY SEARCH . IF sy - subrc = 0 . LOOP AT lt_anlp INTO DATA ( ls_anlp ) FROM sy - tabix . IF ls_anlp - bukrs <> lr_data -> bukrs OR ls_anlp - anln1 <> lr_data -> anln1 OR ls_anlp - anln2 <> lr_data -> anln2 . EXIT . ENDIF . \" \u672c\u5e74\u8d44\u4ea7\u8ba1\u63d0\u6298\u65e7 lr_data -> dep_year_accrual += ( ls_anlp - nafaz + ls_anlp - safaz + ls_anlp - aafaz ) * - 1 . \" \u672c\u6708\u8d44\u4ea7\u8ba1\u63d0\u6298\u65e7 IF ls_anlp - peraf = p_adatu + 4 ( 2 ). lr_data -> dep_period_accrual += ( ls_anlp - nafaz + ls_anlp - safaz + ls_anlp - aafaz ) * - 1 . ENDIF . ENDLOOP . ENDIF . \" \u8d44\u4ea7\u884c\u9879\u76ee READ TABLE lt_anep_ori TRANSPORTING NO FIELDS WITH KEY bukrs = lr_data -> bukrs anln1 = lr_data -> anln1 anln2 = lr_data -> anln2 BINARY SEARCH . IF sy - subrc = 0 . LOOP AT lt_anep_ori INTO DATA ( ls_anep_ori ) FROM sy - tabix . IF ls_anep_ori - bukrs <> lr_data -> bukrs OR ls_anep_ori - anln1 <> lr_data -> anln1 OR ls_anep_ori - anln2 <> lr_data -> anln2 . EXIT . ENDIF . \" \u672c\u5e74\u8d44\u4ea7\u4ef7\u503c\u53d8\u66f4 lr_data -> ori_year_changed += ls_anep_ori - anbtr . ENDLOOP . ENDIF . \" \u8d44\u4ea7\u884c\u9879\u76ee READ TABLE lt_anea_dep TRANSPORTING NO FIELDS WITH KEY bukrs = lr_data -> bukrs anln1 = lr_data -> anln1 anln2 = lr_data -> anln2 BINARY SEARCH . IF sy - subrc = 0 . LOOP AT lt_anea_dep INTO DATA ( ls_anea_dep ) FROM sy - tabix . IF ls_anea_dep - bukrs <> lr_data -> bukrs OR ls_anea_dep - anln1 <> lr_data -> anln1 OR ls_anea_dep - anln2 <> lr_data -> anln2 . EXIT . ENDIF . \" \u672c\u5e74\u6298\u65e7\u4ef7\u503c\u53d8\u66f4 lr_data -> dep_year_changed += ( ls_anea_dep - nafal + ls_anea_dep - safal + ls_anea_dep - aafal + ls_anea_dep - nafav + ls_anea_dep - safav + ls_anea_dep - aafav + ls_anea_dep - aufnv ) * - 1 . ENDLOOP . ENDIF . \" \u671f\u672b\u8d44\u4ea7\u539f\u503c lr_data -> ori_year_end = lr_data -> ori_year_begin + lr_data -> ori_year_changed . \" \u671f\u672b\u7d2f\u8ba1\u6298\u65e7 lr_data -> dep_year_end = lr_data -> dep_year_begin + lr_data -> dep_year_accrual + lr_data -> dep_year_changed . \" \u51c0\u503c lr_data -> amount = lr_data -> ori_year_end - lr_data -> dep_year_end . ENDLOOP . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_get_text *&---------------------------------------------------------------------* *& text *&---------------------------------------------------------------------* FORM frm_get_text . CHECK gt_data IS NOT INITIAL . SELECT bukrs , anln1 , luntn , anlhtxt FROM anlh FOR ALL ENTRIES IN @ gt_data WHERE bukrs = @ gt_data - bukrs AND anln1 = @ gt_data - anln1 AND luntn = @ gt_data - anln2 INTO TABLE @ DATA ( lt_anlh ). SORT lt_anlh BY bukrs anln1 luntn . LOOP AT gt_data REFERENCE INTO DATA ( lr_data ). lr_data -> butxt = zcl_text => bukrs -> get ( lr_data -> bukrs ). \" \u516c\u53f8\u4ee3\u7801\u63cf\u8ff0 READ TABLE lt_anlh INTO DATA ( ls_anlh ) WITH KEY \" \u8d44\u4ea7\u4e3b\u53f7\u6587\u672c bukrs = lr_data -> bukrs anln1 = lr_data -> anln1 luntn = lr_data -> anln2 BINARY SEARCH . IF sy - subrc = 0 . lr_data -> anlhtxt = ls_anlh - anlhtxt . ENDIF . \" \u8d44\u4ea7\u5206\u7c7b\u63cf\u8ff0 SELECT SINGLE txk20 FROM ankt WHERE spras = @ sy - langu AND anlkl = @ lr_data -> anlkl INTO @ lr_data -> anlkl_text . \" \u6210\u672c\u4e2d\u5fc3\u63cf\u8ff0 SELECT SINGLE ktext FROM cskt WHERE spras = @ sy - langu AND kokrs = 'NBOC' AND kostl = @ lr_data -> kostl INTO @ lr_data -> kostl_text . \" \u8d23\u4efb\u6210\u672c\u4e2d\u5fc3\u63cf\u8ff0 SELECT SINGLE ktext FROM cskt WHERE spras = @ sy - langu AND kokrs = 'NBOC' AND kostl = @ lr_data -> kostlv INTO @ lr_data -> kostlv_text . \" \u4f4d\u7f6e\u63cf\u8ff0 SELECT SINGLE ktext FROM t499s WHERE werks = @ lr_data -> werks AND stand = @ lr_data -> stort INTO @ lr_data -> stort_text . \" \u8d44\u4ea7\u72b6\u6001\u63cf\u8ff0 SELECT SINGLE ordtx FROM t087t WHERE spras = @ sy - langu AND ordnr = '1' AND ord4x = @ lr_data -> ord41 INTO @ lr_data -> ordtx . ENDLOOP . ENDFORM . ALV\u4ee3\u7801 *&---------------------------------------------------------------------* *& Form frm_display *&---------------------------------------------------------------------* *& text *&---------------------------------------------------------------------* *& --> p1 text *& <-- p2 text *&---------------------------------------------------------------------* FORM frm_display TABLES ct_data TYPE STANDARD TABLE . DATA ls_layout TYPE lvc_s_layo . DATA lt_fieldcat TYPE STANDARD TABLE OF lvc_s_fcat . PERFORM frm_set_layout CHANGING ls_layout . PERFORM frm_set_fieldcat TABLES lt_fieldcat . PERFORM frm_set_color . CALL FUNCTION 'REUSE_ALV_GRID_DISPLAY_LVC' EXPORTING i_callback_program = sy - repid * i_callback_pf_status_set = 'FRM_PF_STATUS' i_callback_user_command = 'FRM_USER_COMMAND' is_layout_lvc = ls_layout it_fieldcat_lvc = lt_fieldcat i_default = abap_true i_save = 'A' TABLES t_outtab = ct_data[] EXCEPTIONS program_error = 1 OTHERS = 2 . IF sy - subrc <> 0 . MESSAGE ID sy - msgid TYPE sy - msgty NUMBER sy - msgno WITH sy - msgv1 sy - msgv2 sy - msgv3 sy - msgv4 . ENDIF . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_set_layout *&---------------------------------------------------------------------* *& \u62a5\u8868\u5e03\u5c40\u8bbe\u7f6e *&---------------------------------------------------------------------* FORM frm_set_layout CHANGING cs_layout TYPE lvc_s_layo . CLEAR cs_layout . cs_layout - zebra = abap_true . \" \u6591\u9a6c\u7ebf cs_layout - cwidth_opt = abap_true . \" \u81ea\u52a8\u8c03\u6574ALVL\u5217\u5bbd cs_layout - sel_mode = 'A' . \" \u9009\u62e9\u6a21\u5f0f cs_layout - ctab_fname = 'T_SCOL' . \" \u5355\u5143\u683c\u989c\u8272\u8bbe\u7f6e ENDFORM . *&---------------------------------------------------------------------* *& Form frm_set_fieldcat *&---------------------------------------------------------------------* *& \u5b57\u6bb5\u76ee\u5f55\u8bbe\u7f6e *&---------------------------------------------------------------------* FORM frm_set_fieldcat TABLES ct_fieldcat TYPE lvc_t_fcat . DATA ls_fieldcat TYPE lvc_s_fcat . DEFINE _init_fieldcat . CLEAR ls_fieldcat . ls_fieldcat - fieldname = &1 . ls_fieldcat - tooltip = ls_fieldcat - coltext = ls_fieldcat - seltext = ls_fieldcat - scrtext_l = ls_fieldcat - scrtext_m = ls_fieldcat - scrtext_s = &2 . ls_fieldcat - ref_table = &3 . ls_fieldcat - ref_field = &4 . INSERT ls_fieldcat INTO TABLE ct_fieldcat . END-OF-DEFINITION . _init_fieldcat 'BUKRS ' '\u516c\u53f8\u4ee3\u7801' 'T001' 'BUKRS' . _init_fieldcat 'BUTXT ' '\u516c\u53f8\u4ee3\u7801\u63cf\u8ff0' 'T001' 'BUTXT' . _init_fieldcat 'ANLN1 ' '\u8d44\u4ea7\u4e3b\u53f7' 'ANLA' 'ANLN1' . _init_fieldcat 'ANLN2 ' '\u8d44\u4ea7\u5b50\u53f7' 'ANLA' 'ANLN2' . _init_fieldcat 'TXT50 ' '\u8d44\u4ea7\u63cf\u8ff0\u4e00 ' 'ANLA' 'TXT50' . _init_fieldcat 'TXA50 ' '\u8d44\u4ea7\u63cf\u8ff0\u4e8c ' 'ANLA' 'TXA50' . _init_fieldcat 'ANLHTXT ' '\u8d44\u4ea7\u4e3b\u53f7\u6587\u672c' 'ANLH' 'ANLHTXT' . _init_fieldcat 'SERNR ' '\u5e8f\u5217\u53f7' 'ANLA' 'SERNR' . _init_fieldcat 'INVNR ' '\u5b58\u8d27\u53f7' 'ANLA' 'INVNR' . _init_fieldcat 'INVZU ' '\u5e93\u5b58\u6ce8\u8bb0' 'ANLA' 'INVZU' . _init_fieldcat 'ANLKL ' '\u8d44\u4ea7\u5206\u7c7b' 'ANLA' 'ANLKL' . _init_fieldcat 'ANLKL_TEXT ' '\u8d44\u4ea7\u5206\u7c7b\u63cf\u8ff0' 'ANKT' 'TXK20' . _init_fieldcat 'AKTIV ' '\u8d44\u672c\u5316\u65e5\u671f' 'ANLA' 'AKTIV' . _init_fieldcat 'DEAKT ' '\u4e0d\u6d3b\u52a8\u65e5\u671f' 'ANLA' 'DEAKT' . _init_fieldcat 'KOSTL ' '\u6210\u672c\u4e2d\u5fc3' 'ANLZ' 'KOSTL' . _init_fieldcat 'KOSTL_TEXT ' '\u6210\u672c\u4e2d\u5fc3\u63cf\u8ff0' 'CSKT' 'KTEXT' . _init_fieldcat 'KOSTLV ' '\u8d23\u4efb\u6210\u672c\u4e2d\u5fc3' 'ANLZ' 'KOSTLV' . _init_fieldcat 'KOSTLV_TEXT ' '\u8d23\u4efb\u6210\u672c\u4e2d\u5fc3\u63cf\u8ff0 ' 'CSKT' 'KTEXT' . _init_fieldcat 'WERKS ' '\u5de5\u5382' 'ANLZ' 'WERKS' . _init_fieldcat 'STORT ' '\u4f4d\u7f6e' 'ANLZ' 'STORT' . _init_fieldcat 'STORT_TEXT ' '\u4f4d\u7f6e\u63cf\u8ff0' 'T499S' 'KTEXT' . _init_fieldcat 'RAUMN ' '\u4f7f\u7528\u4eba' 'ANLZ' 'RAUMN' . _init_fieldcat 'ORD41 ' '\u8d44\u4ea7\u72b6\u6001' 'ANLA' 'ORD41' . _init_fieldcat 'ORDTX ' '\u8d44\u4ea7\u72b6\u6001\u63cf\u8ff0' 'T087T' 'ORDTX' . _init_fieldcat 'EQUNR ' '\u8bbe\u5907\u53f7' 'V_EQUI' 'EQUNR' . _init_fieldcat 'EQKTX ' '\u8bbe\u5907\u63cf\u8ff0' 'V_EQUI' 'EQKTX' . _init_fieldcat 'LIEFE ' '\u4f9b\u5e94\u5546' 'ANLA' 'LIEFE' . _init_fieldcat 'HERST ' '\u5236\u9020\u5546' 'ANLA' 'HERST' . _init_fieldcat 'AFASL ' '\u6298\u65e7\u7801' 'ANLB' 'AFASL' . _init_fieldcat 'MONTHS_VALID ' '\u4f7f\u7528\u6708\u9650' '' '' . _init_fieldcat 'MONTHS_ACCRUED ' '\u5df2\u8ba1\u63d0\u6298\u65e7\u6708\u4efd' '' '' . _init_fieldcat 'AFABG ' '\u6298\u65e7\u5f00\u59cb\u65e5\u671f' 'ANLB' 'AFABG' . _init_fieldcat 'ORI_YEAR_BEGIN ' '\u5e74\u521d\u8d44\u4ea7\u539f\u503c' '' '' . _init_fieldcat 'ORI_YEAR_CHANGED' '\u672c\u5e74\u8d44\u4ea7\u4ef7\u503c\u53d8\u66f4 ' '' '' . _init_fieldcat 'DEP_YEAR_BEGIN ' '\u5e74\u521d\u8d44\u4ea7\u7d2f\u8ba1\u6298\u65e7' '' '' . _init_fieldcat 'DEP_YEAR_ACCRUAL' '\u672c\u5e74\u8d44\u4ea7\u8ba1\u63d0\u6298\u65e7' '' '' . _init_fieldcat 'DEP_PERIOD_ACCRUAL' '\u672c\u6708\u8d44\u4ea7\u8ba1\u63d0\u6298\u65e7' '' '' . _init_fieldcat 'DEP_YEAR_CHANGED' '\u672c\u5e74\u6298\u65e7\u4ef7\u503c\u53d8\u66f4' '' '' . _init_fieldcat 'ORI_YEAR_END ' '\u671f\u672b\u8d44\u4ea7\u539f\u503c' '' '' . _init_fieldcat 'DEP_YEAR_END ' '\u671f\u672b\u7d2f\u8ba1\u6298\u65e7' '' '' . _init_fieldcat 'AMOUNT ' '\u51c0\u503c' '' '' . \" \u4e2a\u6027\u5316\u81ea\u5df1\u8f93\u51fa\u6570\u636e\u683c\u5f0f LOOP AT ct_fieldcat REFERENCE INTO DATA ( lr_fieldcat ). \" \u5b57\u6bb5\u663e\u793a\u5c5e\u6027\u8bbe\u7f6e CASE lr_fieldcat -> fieldname . WHEN OTHERS . ENDCASE . ENDLOOP . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_set_color *&---------------------------------------------------------------------* *& text *&---------------------------------------------------------------------* *& --> p1 text *& <-- p2 text *&---------------------------------------------------------------------* FORM frm_set_color . DATA ls_scol TYPE lvc_s_scol . LOOP AT gt_data REFERENCE INTO DATA ( lr_data ). CLEAR lr_data -> t_scol . CASE lr_data -> mtype . WHEN 'S' . CLEAR ls_scol . ls_scol - fname = 'MTYPE' . ls_scol - color = VALUE # ( col = '5' ). INSERT ls_scol INTO TABLE lr_data -> t_scol . WHEN 'E' . CLEAR ls_scol . ls_scol - fname = 'MTYPE' . ls_scol - color = VALUE # ( col = '6' ). INSERT ls_scol INTO TABLE lr_data -> t_scol . ENDCASE . ENDLOOP . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_pf_status *&---------------------------------------------------------------------* *& \u8bbe\u7f6eGUI\u72b6\u6001 *&---------------------------------------------------------------------* FORM frm_pf_status USING ct_extab TYPE slis_t_extab . SET PF-STATUS 'STATUS' . SET TITLEBAR 'TITLE' . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_user_command *&---------------------------------------------------------------------* *& \u529f\u80fd\u54cd\u5e94 *&---------------------------------------------------------------------* FORM frm_user_command USING cv_ucomm LIKE sy - ucomm cs_selfield TYPE slis_selfield . \" \u5237\u65b0\u5c4f\u5e55\u6570\u636e\u5230\u5185\u8868 DATA : lo_grid TYPE REF TO cl_gui_alv_grid . CALL FUNCTION 'GET_GLOBALS_FROM_SLVC_FULLSCR' IMPORTING e_grid = lo_grid . CALL METHOD lo_grid -> check_changed_data . PERFORM frm_get_data_selection . \" \u6309\u94ae\u529f\u80fd\u5b9e\u73b0 CASE cv_ucomm . WHEN '&IC1' . \" \u53cc\u51fb READ TABLE gt_data INTO DATA ( ls_data ) INDEX cs_selfield - tabindex . IF sy - subrc = 0 . CASE cs_selfield - fieldname . WHEN 'ANLN1' . SET PARAMETER ID 'BUK' FIELD ls_data - bukrs . SET PARAMETER ID 'AN1' FIELD ls_data - anln1 . CALL TRANSACTION 'AW01N' . WHEN OTHERS . ENDCASE . ENDIF . WHEN OTHERS . RETURN . ENDCASE . PERFORM frm_reset_data_selection . PERFORM frm_set_color . \" \u5237\u65b0ALV \u663e\u793a\u503c cs_selfield - refresh = abap_true . cs_selfield - row_stable = abap_true . cs_selfield - col_stable = abap_true . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_get_data_selection *&---------------------------------------------------------------------* *& text *&---------------------------------------------------------------------* *& --> p1 text *& <-- p2 text *&---------------------------------------------------------------------* FORM frm_get_data_selection . \" \u5237\u65b0\u5c4f\u5e55\u6570\u636e\u5230\u5185\u8868 DATA : lo_grid TYPE REF TO cl_gui_alv_grid . CALL FUNCTION 'GET_GLOBALS_FROM_SLVC_FULLSCR' IMPORTING e_grid = lo_grid . \" \u83b7\u53d6ALV\u9009\u53d6\u884c DATA lt_rows TYPE lvc_t_row . CALL METHOD lo_grid -> get_selected_rows IMPORTING et_index_rows = lt_rows . LOOP AT lt_rows INTO DATA ( ls_row ). READ TABLE gt_data REFERENCE INTO DATA ( lr_data ) INDEX ls_row - index . IF sy - subrc = 0 . lr_data -> zsel = abap_true . ENDIF . ENDLOOP . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_reset_data_selection *&---------------------------------------------------------------------* *& text *&---------------------------------------------------------------------* *& --> p1 text *& <-- p2 text *&---------------------------------------------------------------------* FORM frm_reset_data_selection . LOOP AT gt_data REFERENCE INTO DATA ( lr_data ). CLEAR lr_data -> zsel . ENDLOOP . ENDFORM .","title":"\u56fa\u5b9a\u8d44\u4ea7\u660e\u7ec6\u62a5\u8868"},{"location":"fico/fixed_assets_report/#_1","text":"\u4e3b\u7a0b\u5e8f *&---------------------------------------------------------------------* *& \u4f5c\u8005 Nefvcore *& \u521b\u5efa\u65e5\u671f 2022\u5e748\u670823\u65e5 *& \u63cf\u8ff0 \u56fa\u5b9a\u8d44\u4ea7\u660e\u7ec6\u62a5\u8868 *&---------------------------------------------------------------------* REPORT zfixed_assets . INCLUDE zfir017_top . INCLUDE zfir017_sel . INCLUDE zfir017_frm . INCLUDE zfir017_alv . START-OF-SELECTION . PERFORM frm_main . \u5168\u5c40\u53c2\u6570 TYPES : ty_amount TYPE p LENGTH 16 DECIMALS 2 . \" P\u503c\u4e0a\u9650 TYPES : BEGIN OF ty_data , bukrs TYPE anla - bukrs , \" \u516c\u53f8\u4ee3\u7801 butxt TYPE t001 - butxt , \" \u516c\u53f8\u4ee3\u7801\u63cf\u8ff0 anln1 TYPE anla - anln1 , \" \u8d44\u4ea7\u4e3b\u53f7 anln2 TYPE anla - anln2 , \" \u8d44\u4ea7\u5b50\u53f7 txt50 TYPE anla - txt50 , \" \u8d44\u4ea7\u63cf\u8ff0\u4e00 txa50 TYPE anla - txa50 , \" \u8d44\u4ea7\u63cf\u8ff0\u4e8c anlhtxt TYPE anlh - anlhtxt , \" \u8d44\u4ea7\u4e3b\u53f7\u6587\u672c sernr TYPE anla - sernr , \" \u5e8f\u5217\u53f7 invnr TYPE anla - invnr , \" \u5b58\u8d27\u53f7 invzu TYPE anla - invzu , \" \u5e93\u5b58\u6ce8\u8bb0 anlkl TYPE anla - anlkl , \" \u8d44\u4ea7\u5206\u7c7b anlkl_text TYPE ankt - txk20 , \" \u8d44\u4ea7\u5206\u7c7b\u63cf\u8ff0 aktiv TYPE anla - aktiv , \" \u8d44\u672c\u5316\u65e5\u671f deakt TYPE anla - deakt , \" \u4e0d\u6d3b\u52a8\u65e5\u671f kostl TYPE anlz - kostl , \" \u6210\u672c\u4e2d\u5fc3 kostl_text TYPE cskt - ktext , \" \u6210\u672c\u4e2d\u5fc3\u63cf\u8ff0 kostlv TYPE anlz - kostlv , \" \u8d23\u4efb\u6210\u672c\u4e2d\u5fc3 kostlv_text TYPE cskt - ktext , \" \u8d23\u4efb\u6210\u672c\u4e2d\u5fc3\u63cf\u8ff0 werks TYPE anlz - werks , \" \u5de5\u5382 stort TYPE anlz - stort , \" \u4f4d\u7f6e stort_text TYPE t499s - ktext , \" \u4f4d\u7f6e\u63cf\u8ff0 raumn TYPE anlz - raumn , \" \u4f7f\u7528\u4eba ord41 TYPE anla - ord41 , \" \u8d44\u4ea7\u72b6\u6001 ordtx TYPE t087t - ordtx , \" \u8d44\u4ea7\u72b6\u6001\u63cf\u8ff0 equnr TYPE v_equi - equnr , \" \u8bbe\u5907\u53f7 eqktx TYPE v_equi - eqktx , \" \u8bbe\u5907\u63cf\u8ff0 liefe TYPE anla - liefe , \" \u4f9b\u5e94\u5546 herst TYPE anla - herst , \" \u5236\u9020\u5546 afasl TYPE anlb - afasl , \" \u6298\u65e7\u7801 months_valid TYPE i , \" \u4f7f\u7528\u6708\u9650 months_accrued TYPE i , \" \u5df2\u8ba1\u63d0\u6298\u65e7\u6708\u4efd afabg TYPE anlb - afabg , \" \u6298\u65e7\u5f00\u59cb\u65e5\u671f ori_year_begin TYPE ty_amount , \" \u5e74\u521d\u8d44\u4ea7\u539f\u503c ori_year_changed TYPE ty_amount , \" \u672c\u5e74\u8d44\u4ea7\u4ef7\u503c\u53d8\u66f4 ori_year_end TYPE ty_amount , \" \u671f\u672b\u8d44\u4ea7\u539f\u503c dep_year_begin TYPE ty_amount , \" \u5e74\u521d\u8d44\u4ea7\u7d2f\u8ba1\u6298\u65e7 dep_year_accrual TYPE ty_amount , \" \u672c\u5e74\u8d44\u4ea7\u8ba1\u63d0\u6298\u65e7 dep_period_accrual TYPE ty_amount , \" \u672c\u6708\u8d44\u4ea7\u8ba1\u63d0\u6298\u65e7 dep_year_changed TYPE ty_amount , \" \u672c\u5e74\u6298\u65e7\u4ef7\u503c\u53d8\u66f4 dep_year_end TYPE ty_amount , \" \u671f\u672b\u7d2f\u8ba1\u6298\u65e7 amount TYPE ty_amount , \" \u51c0\u503c adatu TYPE anlz - adatu , \" \u8d44\u4ea7\u8d77\u59cb\u65e5\u671f bdatu TYPE anlz - bdatu , \" \u8d44\u4ea7\u7ed3\u675f\u65e5\u671f ndjar TYPE anlb - ndjar , \" \u4f7f\u7528\u5e74\u9650 ndper TYPE anlb - ndper , \" \u671f\u95f4 zsel TYPE xfeld , mtype TYPE bapi_mtype , msg TYPE bapi_msg , t_scol TYPE lvc_t_scol , END OF ty_data . TYPES tt_data TYPE STANDARD TABLE OF ty_data WITH EMPTY KEY . DATA gt_data TYPE tt_data . \u5c4f\u5e55\u5b9a\u4e49 TABLES anla . TABLES anlb . TABLES anlz . SELECT-OPTIONS s_bukrs FOR anla - bukrs OBLIGATORY . SELECT-OPTIONS s_anlkl FOR anla - anlkl DEFAULT '1100' TO '9000' . SELECT-OPTIONS s_anln1 FOR anla - anln1 . SELECT-OPTIONS s_kostl FOR anlz - kostl . SELECT-OPTIONS s_kostlv FOR anlz - kostlv . SELECT-OPTIONS s_ord41 FOR anla - ord41 . PARAMETERS p_adatu TYPE sy - datum OBLIGATORY DEFAULT sy - datum . SELECT-OPTIONS s_afabe FOR anlb - afabe OBLIGATORY NO INTERVALS NO-EXTENSION . \u5b50\u4f8b\u7a0b *&---------------------------------------------------------------------* *& Form frm_main *&---------------------------------------------------------------------* *& text *&---------------------------------------------------------------------* FORM frm_main . PERFORM frm_auth_check . PERFORM frm_get_data . IF gt_data IS INITIAL . MESSAGE '\u65e0\u6570\u636e' TYPE 'S' DISPLAY LIKE 'E' . RETURN . ENDIF . PERFORM frm_get_ord41 . \" \u8d44\u4ea7\u72b6\u6001 PERFORM frm_get_equi . \" \u8bbe\u5907 PERFORM frm_get_amount . \" \u539f\u503c\u548c\u6298\u65e7\u91d1\u989d PERFORM frm_get_text . \" \u6587\u672c\u53d6\u503c PERFORM frm_display TABLES gt_data[] . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_auth_check *&---------------------------------------------------------------------* *& text *&---------------------------------------------------------------------* *& --> p1 text *& <-- p2 text *&---------------------------------------------------------------------* FORM frm_auth_check . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_get_data *&---------------------------------------------------------------------* *& text *&---------------------------------------------------------------------* *& --> p1 text *& <-- p2 text *&---------------------------------------------------------------------* FORM frm_get_data . SELECT anla~bukrs , anla~anln1 , anla~anln2 , anla~txt50 , anla~txa50 , anla~sernr , anla~invnr , anla~invzu , anla~anlkl , anla~ord41 , anla~aktiv , anla~deakt , anla~liefe , anla~herst , anlb~afasl , anlb~ndjar , anlb~ndper , anlb~afabg , anlz~kostl , anlz~kostlv , anlz~werks , anlz~stort , anlz~raumn , anlz~adatu , anlz~bdatu FROM anla LEFT JOIN anlb ON anla~bukrs = anlb~bukrs AND anla~anln1 = anlb~anln1 AND anla~anln2 = anlb~anln2 LEFT JOIN anlz ON anla~bukrs = anlz~bukrs AND anla~anln1 = anlz~anln1 AND anla~anln2 = anlz~anln2 WHERE anla~bukrs IN @ s_bukrs AND anla~anln1 IN @ s_anln1 AND anla~anlkl IN @ s_anlkl AND anla~ord41 IN @ s_ord41 AND anlb~afabe IN @ s_afabe AND anlz~kostl IN @ s_kostl AND anlz~kostlv IN @ s_kostlv INTO CORRESPONDING FIELDS OF TABLE @ gt_data . \" \u67e5\u8be2\u65e5\u671f IF p_adatu IS NOT INITIAL . DELETE gt_data WHERE adatu > p_adatu OR bdatu < p_adatu . ENDIF . LOOP AT gt_data REFERENCE INTO DATA ( lr_data ). lr_data -> months_valid = lr_data -> ndjar * 12 + lr_data -> ndper . \" \u4f7f\u7528\u6708\u9650 \" \u5df2\u8ba1\u63d0\u6298\u65e7\u6708\u4efd DATA l_date_from TYPE datum . DATA l_date_to TYPE datum . DATA l_months TYPE vtbbewe - atage . l_date_to = |{ p_adatu ( 6 ) } 01 |. l_date_from = |{ lr_data -> afabg ( 6 ) } 01 |. IF l_date_from < l_date_to . CALL FUNCTION 'FIMA_DAYS_AND_MONTHS_AND_YEARS' EXPORTING i_date_from = l_date_from i_date_to = l_date_to IMPORTING e_months = l_months . l_months = l_months + 1 . ELSE . l_months = 1 . ENDIF . \" \u53d6\u6700\u5c0f\u503c IF lr_data -> months_valid > l_months . lr_data -> months_accrued = l_months . ELSE . lr_data -> months_accrued = lr_data -> months_valid . ENDIF . ENDLOOP . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_get_ORD41 *&---------------------------------------------------------------------* *& \u4ece\u5386\u53f2\u4fee\u6539\u8bb0\u5f55\u8868\u4e2d\u67e5\u627e\u8d44\u4ea7\u72b6\u6001 *& \u67e5\u627e\u5931\u8d25\u9ed8\u8ba4\u53d6\u4e3b\u6570\u636eORD41\u7684\u503c *&---------------------------------------------------------------------* FORM frm_get_ord41 . CHECK gt_data IS NOT INITIAL . SELECT ds~bukrs , ds~anln1 , ds~anln2 , cdhdr~udate , cdpos~value_new FROM @ gt_data AS ds JOIN cdhdr ON cdhdr~objectid = 'ANLA' AND concat ( concat ( ds~bukrs , ds~anln1 ), ds~anln2 ) = cdhdr~objectid AND cdhdr~udate > @ p_adatu JOIN cdpos ON cdhdr~objectclas = cdpos~objectclas AND cdhdr~objectid = cdpos~objectid AND cdhdr~changenr = cdpos~changenr AND cdpos~fname = 'ORD41' INTO TABLE @ DATA ( lt_record ). \" \u6309\u6700\u8fd1\u4fee\u6539\u65e5\u671f\u6392\u5e8f SORT lt_record BY bukrs anln1 anln2 udate DESCENDING . LOOP AT gt_data REFERENCE INTO DATA ( lr_data ). READ TABLE lt_record INTO DATA ( ls_record ) WITH KEY bukrs = lr_data -> bukrs anln1 = lr_data -> anln1 anln2 = lr_data -> anln2 BINARY SEARCH . IF sy - subrc = 0 . lr_data -> ord41 = ls_record - value_new . ENDIF . ENDLOOP . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_get_equi *&---------------------------------------------------------------------* *& text *&---------------------------------------------------------------------* FORM frm_get_equi . CHECK gt_data IS NOT INITIAL . SELECT bukrs , anlnr , anlun , equnr , eqktx FROM v_equi FOR ALL ENTRIES IN @ gt_data WHERE bukrs = @ gt_data - bukrs AND anlnr = @ gt_data - anln1 AND anlun = @ gt_data - anln2 INTO TABLE @ DATA ( lt_equi ). SORT lt_equi BY bukrs anlnr anlun . LOOP AT gt_data REFERENCE INTO DATA ( lr_data ). READ TABLE lt_equi INTO DATA ( ls_equi ) WITH KEY bukrs = lr_data -> bukrs anlnr = lr_data -> anln1 anlun = lr_data -> anln2 BINARY SEARCH . IF sy - subrc = 0 . lr_data -> equnr = ls_equi - equnr . lr_data -> eqktx = ls_equi - eqktx . ENDIF . ENDLOOP . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_get_amount *&---------------------------------------------------------------------* *& text *&---------------------------------------------------------------------* FORM frm_get_amount . CHECK gt_data IS NOT INITIAL . DATA l_date_from TYPE datum . DATA l_date_to TYPE datum . l_date_from = |{ p_adatu ( 4 ) } 0101 |. l_date_to = p_adatu . \" \u8d44\u4ea7\u503c\u5b57\u6bb5 SELECT bukrs , anln1 , anln2 , gjahr , afabe , zujhr , zucod , kansw , knafa , ksafa , kaafa FROM anlc FOR ALL ENTRIES IN @ gt_data WHERE bukrs = @ gt_data - bukrs AND anln1 = @ gt_data - anln1 AND anln2 = @ gt_data - anln2 AND gjahr = @ p_adatu ( 4 ) AND afabe IN @ s_afabe INTO TABLE @ DATA ( lt_anlc ). SORT lt_anlc BY bukrs anln1 anln2 . \" \u8d44\u4ea7\u671f\u95f4\u4ef7\u503c SELECT bukrs , gjahr , peraf , afbnr , anln1 , anln2 , afaber , zujhr , zucod , nafaz , safaz , aafaz FROM anlp FOR ALL ENTRIES IN @ gt_data WHERE bukrs = @ gt_data - bukrs AND anln1 = @ gt_data - anln1 AND anln2 = @ gt_data - anln2 AND gjahr = @ p_adatu ( 4 ) AND peraf <= @ p_adatu + 4 ( 2 ) AND afaber IN @ s_afabe INTO TABLE @ DATA ( lt_anlp ). SORT lt_anlp BY bukrs anln1 anln2 . \" \u8d44\u4ea7\u539f\u503c\u62ac\u5934\u51ed\u8bc1 IF l_date_from <= l_date_to . SELECT bukrs , anln1 , anln2 , gjahr , lnran FROM anek FOR ALL ENTRIES IN @ gt_data WHERE bukrs = @ gt_data - bukrs AND anln1 = @ gt_data - anln1 AND anln2 = @ gt_data - anln2 AND budat BETWEEN @ l_date_from AND @ l_date_to INTO TABLE @ DATA ( lt_anek_ori ). SORT lt_anek_ori BY bukrs anln1 anln2 . ENDIF . \" \u8d44\u4ea7\u539f\u503c\u51ed\u8bc1\u884c\u9879\u76ee IF lt_anek_ori IS NOT INITIAL . \" \u8d44\u4ea7\u4e1a\u52a1\u7c7b\u578b DATA lt_bwasl_opt TYPE RANGE OF tabw - bwasl . SELECT 'I' AS sign , 'EQ' AS option , bwasl AS low FROM tabw JOIN tabwg ON tabw~bwagrp = tabwg~bwagrp AND tabwg~bwatyp <> '4' AND tabwg~xbnafa <> 'X' INTO TABLE @ lt_bwasl_opt GROUP BY bwasl . \" \u8d44\u4ea7\u884c\u9879\u76ee IF lt_bwasl_opt IS NOT INITIAL . SELECT bukrs , anln1 , anln2 , gjahr , lnran , anbtr FROM anep FOR ALL ENTRIES IN @ lt_anek_ori WHERE bukrs = @ lt_anek_ori - bukrs AND anln1 = @ lt_anek_ori - anln1 AND anln2 = @ lt_anek_ori - anln2 AND gjahr = @ lt_anek_ori - gjahr AND lnran = @ lt_anek_ori - lnran AND bwasl IN @ lt_bwasl_opt AND afabe IN @ s_afabe INTO TABLE @ DATA ( lt_anep_ori ). SORT lt_anep_ori BY bukrs anln1 anln2 gjahr lnran . ENDIF . ENDIF . \" \u8d44\u4ea7\u6298\u65e7\u62ac\u5934\u51ed\u8bc1 IF l_date_from <= l_date_to . SELECT bukrs , anln1 , anln2 , gjahr , lnran FROM anek FOR ALL ENTRIES IN @ gt_data WHERE bukrs = @ gt_data - bukrs AND anln1 = @ gt_data - anln1 AND anln2 = @ gt_data - anln2 AND gjahr = @ p_adatu ( 4 ) AND monat <= @ p_adatu + 4 ( 2 ) INTO TABLE @ DATA ( lt_anek_dep ). SORT lt_anek_dep BY bukrs anln1 anln2 . \" \u8d44\u4ea7\u539f\u503c\u51ed\u8bc1\u884c\u9879\u76ee IF lt_anek_dep IS NOT INITIAL . \" \u8d44\u4ea7\u884c\u9879\u76ee SELECT bukrs , anln1 , anln2 , gjahr , lnran , afabe , zujhr , zucod , nafal , safal , aafal , nafav , safav , aafav , aufnv FROM anea FOR ALL ENTRIES IN @ lt_anek_dep WHERE bukrs = @ lt_anek_dep - bukrs AND anln1 = @ lt_anek_dep - anln1 AND anln2 = @ lt_anek_dep - anln2 AND gjahr = @ lt_anek_dep - gjahr AND lnran = @ lt_anek_dep - lnran AND afabe IN @ s_afabe INTO TABLE @ DATA ( lt_anea_dep ). SORT lt_anea_dep BY bukrs anln1 anln2 gjahr lnran . ENDIF . ENDIF . \" \u9010\u8d44\u4ea7\u5904\u7406 LOOP AT gt_data REFERENCE INTO DATA ( lr_data ). \" \u5e74\u521d\u503c READ TABLE lt_anlc TRANSPORTING NO FIELDS WITH KEY bukrs = lr_data -> bukrs anln1 = lr_data -> anln1 anln2 = lr_data -> anln2 BINARY SEARCH . IF sy - subrc = 0 . LOOP AT lt_anlc INTO DATA ( ls_anlc ) FROM sy - tabix . IF ls_anlc - bukrs <> lr_data -> bukrs OR ls_anlc - anln1 <> lr_data -> anln1 OR ls_anlc - anln2 <> lr_data -> anln2 . EXIT . ENDIF . \" \u5e74\u521d\u8d44\u4ea7\u539f\u503c lr_data -> ori_year_begin += ls_anlc - kansw . \" \u5e74\u521d\u8d44\u4ea7\u7d2f\u8ba1\u6298\u65e7 lr_data -> dep_year_begin += ( ls_anlc - knafa + ls_anlc - ksafa + ls_anlc - kaafa ) * - 1 . ENDLOOP . ENDIF . \" \u671f\u95f4\u503c READ TABLE lt_anlp TRANSPORTING NO FIELDS WITH KEY bukrs = lr_data -> bukrs anln1 = lr_data -> anln1 anln2 = lr_data -> anln2 BINARY SEARCH . IF sy - subrc = 0 . LOOP AT lt_anlp INTO DATA ( ls_anlp ) FROM sy - tabix . IF ls_anlp - bukrs <> lr_data -> bukrs OR ls_anlp - anln1 <> lr_data -> anln1 OR ls_anlp - anln2 <> lr_data -> anln2 . EXIT . ENDIF . \" \u672c\u5e74\u8d44\u4ea7\u8ba1\u63d0\u6298\u65e7 lr_data -> dep_year_accrual += ( ls_anlp - nafaz + ls_anlp - safaz + ls_anlp - aafaz ) * - 1 . \" \u672c\u6708\u8d44\u4ea7\u8ba1\u63d0\u6298\u65e7 IF ls_anlp - peraf = p_adatu + 4 ( 2 ). lr_data -> dep_period_accrual += ( ls_anlp - nafaz + ls_anlp - safaz + ls_anlp - aafaz ) * - 1 . ENDIF . ENDLOOP . ENDIF . \" \u8d44\u4ea7\u884c\u9879\u76ee READ TABLE lt_anep_ori TRANSPORTING NO FIELDS WITH KEY bukrs = lr_data -> bukrs anln1 = lr_data -> anln1 anln2 = lr_data -> anln2 BINARY SEARCH . IF sy - subrc = 0 . LOOP AT lt_anep_ori INTO DATA ( ls_anep_ori ) FROM sy - tabix . IF ls_anep_ori - bukrs <> lr_data -> bukrs OR ls_anep_ori - anln1 <> lr_data -> anln1 OR ls_anep_ori - anln2 <> lr_data -> anln2 . EXIT . ENDIF . \" \u672c\u5e74\u8d44\u4ea7\u4ef7\u503c\u53d8\u66f4 lr_data -> ori_year_changed += ls_anep_ori - anbtr . ENDLOOP . ENDIF . \" \u8d44\u4ea7\u884c\u9879\u76ee READ TABLE lt_anea_dep TRANSPORTING NO FIELDS WITH KEY bukrs = lr_data -> bukrs anln1 = lr_data -> anln1 anln2 = lr_data -> anln2 BINARY SEARCH . IF sy - subrc = 0 . LOOP AT lt_anea_dep INTO DATA ( ls_anea_dep ) FROM sy - tabix . IF ls_anea_dep - bukrs <> lr_data -> bukrs OR ls_anea_dep - anln1 <> lr_data -> anln1 OR ls_anea_dep - anln2 <> lr_data -> anln2 . EXIT . ENDIF . \" \u672c\u5e74\u6298\u65e7\u4ef7\u503c\u53d8\u66f4 lr_data -> dep_year_changed += ( ls_anea_dep - nafal + ls_anea_dep - safal + ls_anea_dep - aafal + ls_anea_dep - nafav + ls_anea_dep - safav + ls_anea_dep - aafav + ls_anea_dep - aufnv ) * - 1 . ENDLOOP . ENDIF . \" \u671f\u672b\u8d44\u4ea7\u539f\u503c lr_data -> ori_year_end = lr_data -> ori_year_begin + lr_data -> ori_year_changed . \" \u671f\u672b\u7d2f\u8ba1\u6298\u65e7 lr_data -> dep_year_end = lr_data -> dep_year_begin + lr_data -> dep_year_accrual + lr_data -> dep_year_changed . \" \u51c0\u503c lr_data -> amount = lr_data -> ori_year_end - lr_data -> dep_year_end . ENDLOOP . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_get_text *&---------------------------------------------------------------------* *& text *&---------------------------------------------------------------------* FORM frm_get_text . CHECK gt_data IS NOT INITIAL . SELECT bukrs , anln1 , luntn , anlhtxt FROM anlh FOR ALL ENTRIES IN @ gt_data WHERE bukrs = @ gt_data - bukrs AND anln1 = @ gt_data - anln1 AND luntn = @ gt_data - anln2 INTO TABLE @ DATA ( lt_anlh ). SORT lt_anlh BY bukrs anln1 luntn . LOOP AT gt_data REFERENCE INTO DATA ( lr_data ). lr_data -> butxt = zcl_text => bukrs -> get ( lr_data -> bukrs ). \" \u516c\u53f8\u4ee3\u7801\u63cf\u8ff0 READ TABLE lt_anlh INTO DATA ( ls_anlh ) WITH KEY \" \u8d44\u4ea7\u4e3b\u53f7\u6587\u672c bukrs = lr_data -> bukrs anln1 = lr_data -> anln1 luntn = lr_data -> anln2 BINARY SEARCH . IF sy - subrc = 0 . lr_data -> anlhtxt = ls_anlh - anlhtxt . ENDIF . \" \u8d44\u4ea7\u5206\u7c7b\u63cf\u8ff0 SELECT SINGLE txk20 FROM ankt WHERE spras = @ sy - langu AND anlkl = @ lr_data -> anlkl INTO @ lr_data -> anlkl_text . \" \u6210\u672c\u4e2d\u5fc3\u63cf\u8ff0 SELECT SINGLE ktext FROM cskt WHERE spras = @ sy - langu AND kokrs = 'NBOC' AND kostl = @ lr_data -> kostl INTO @ lr_data -> kostl_text . \" \u8d23\u4efb\u6210\u672c\u4e2d\u5fc3\u63cf\u8ff0 SELECT SINGLE ktext FROM cskt WHERE spras = @ sy - langu AND kokrs = 'NBOC' AND kostl = @ lr_data -> kostlv INTO @ lr_data -> kostlv_text . \" \u4f4d\u7f6e\u63cf\u8ff0 SELECT SINGLE ktext FROM t499s WHERE werks = @ lr_data -> werks AND stand = @ lr_data -> stort INTO @ lr_data -> stort_text . \" \u8d44\u4ea7\u72b6\u6001\u63cf\u8ff0 SELECT SINGLE ordtx FROM t087t WHERE spras = @ sy - langu AND ordnr = '1' AND ord4x = @ lr_data -> ord41 INTO @ lr_data -> ordtx . ENDLOOP . ENDFORM . ALV\u4ee3\u7801 *&---------------------------------------------------------------------* *& Form frm_display *&---------------------------------------------------------------------* *& text *&---------------------------------------------------------------------* *& --> p1 text *& <-- p2 text *&---------------------------------------------------------------------* FORM frm_display TABLES ct_data TYPE STANDARD TABLE . DATA ls_layout TYPE lvc_s_layo . DATA lt_fieldcat TYPE STANDARD TABLE OF lvc_s_fcat . PERFORM frm_set_layout CHANGING ls_layout . PERFORM frm_set_fieldcat TABLES lt_fieldcat . PERFORM frm_set_color . CALL FUNCTION 'REUSE_ALV_GRID_DISPLAY_LVC' EXPORTING i_callback_program = sy - repid * i_callback_pf_status_set = 'FRM_PF_STATUS' i_callback_user_command = 'FRM_USER_COMMAND' is_layout_lvc = ls_layout it_fieldcat_lvc = lt_fieldcat i_default = abap_true i_save = 'A' TABLES t_outtab = ct_data[] EXCEPTIONS program_error = 1 OTHERS = 2 . IF sy - subrc <> 0 . MESSAGE ID sy - msgid TYPE sy - msgty NUMBER sy - msgno WITH sy - msgv1 sy - msgv2 sy - msgv3 sy - msgv4 . ENDIF . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_set_layout *&---------------------------------------------------------------------* *& \u62a5\u8868\u5e03\u5c40\u8bbe\u7f6e *&---------------------------------------------------------------------* FORM frm_set_layout CHANGING cs_layout TYPE lvc_s_layo . CLEAR cs_layout . cs_layout - zebra = abap_true . \" \u6591\u9a6c\u7ebf cs_layout - cwidth_opt = abap_true . \" \u81ea\u52a8\u8c03\u6574ALVL\u5217\u5bbd cs_layout - sel_mode = 'A' . \" \u9009\u62e9\u6a21\u5f0f cs_layout - ctab_fname = 'T_SCOL' . \" \u5355\u5143\u683c\u989c\u8272\u8bbe\u7f6e ENDFORM . *&---------------------------------------------------------------------* *& Form frm_set_fieldcat *&---------------------------------------------------------------------* *& \u5b57\u6bb5\u76ee\u5f55\u8bbe\u7f6e *&---------------------------------------------------------------------* FORM frm_set_fieldcat TABLES ct_fieldcat TYPE lvc_t_fcat . DATA ls_fieldcat TYPE lvc_s_fcat . DEFINE _init_fieldcat . CLEAR ls_fieldcat . ls_fieldcat - fieldname = &1 . ls_fieldcat - tooltip = ls_fieldcat - coltext = ls_fieldcat - seltext = ls_fieldcat - scrtext_l = ls_fieldcat - scrtext_m = ls_fieldcat - scrtext_s = &2 . ls_fieldcat - ref_table = &3 . ls_fieldcat - ref_field = &4 . INSERT ls_fieldcat INTO TABLE ct_fieldcat . END-OF-DEFINITION . _init_fieldcat 'BUKRS ' '\u516c\u53f8\u4ee3\u7801' 'T001' 'BUKRS' . _init_fieldcat 'BUTXT ' '\u516c\u53f8\u4ee3\u7801\u63cf\u8ff0' 'T001' 'BUTXT' . _init_fieldcat 'ANLN1 ' '\u8d44\u4ea7\u4e3b\u53f7' 'ANLA' 'ANLN1' . _init_fieldcat 'ANLN2 ' '\u8d44\u4ea7\u5b50\u53f7' 'ANLA' 'ANLN2' . _init_fieldcat 'TXT50 ' '\u8d44\u4ea7\u63cf\u8ff0\u4e00 ' 'ANLA' 'TXT50' . _init_fieldcat 'TXA50 ' '\u8d44\u4ea7\u63cf\u8ff0\u4e8c ' 'ANLA' 'TXA50' . _init_fieldcat 'ANLHTXT ' '\u8d44\u4ea7\u4e3b\u53f7\u6587\u672c' 'ANLH' 'ANLHTXT' . _init_fieldcat 'SERNR ' '\u5e8f\u5217\u53f7' 'ANLA' 'SERNR' . _init_fieldcat 'INVNR ' '\u5b58\u8d27\u53f7' 'ANLA' 'INVNR' . _init_fieldcat 'INVZU ' '\u5e93\u5b58\u6ce8\u8bb0' 'ANLA' 'INVZU' . _init_fieldcat 'ANLKL ' '\u8d44\u4ea7\u5206\u7c7b' 'ANLA' 'ANLKL' . _init_fieldcat 'ANLKL_TEXT ' '\u8d44\u4ea7\u5206\u7c7b\u63cf\u8ff0' 'ANKT' 'TXK20' . _init_fieldcat 'AKTIV ' '\u8d44\u672c\u5316\u65e5\u671f' 'ANLA' 'AKTIV' . _init_fieldcat 'DEAKT ' '\u4e0d\u6d3b\u52a8\u65e5\u671f' 'ANLA' 'DEAKT' . _init_fieldcat 'KOSTL ' '\u6210\u672c\u4e2d\u5fc3' 'ANLZ' 'KOSTL' . _init_fieldcat 'KOSTL_TEXT ' '\u6210\u672c\u4e2d\u5fc3\u63cf\u8ff0' 'CSKT' 'KTEXT' . _init_fieldcat 'KOSTLV ' '\u8d23\u4efb\u6210\u672c\u4e2d\u5fc3' 'ANLZ' 'KOSTLV' . _init_fieldcat 'KOSTLV_TEXT ' '\u8d23\u4efb\u6210\u672c\u4e2d\u5fc3\u63cf\u8ff0 ' 'CSKT' 'KTEXT' . _init_fieldcat 'WERKS ' '\u5de5\u5382' 'ANLZ' 'WERKS' . _init_fieldcat 'STORT ' '\u4f4d\u7f6e' 'ANLZ' 'STORT' . _init_fieldcat 'STORT_TEXT ' '\u4f4d\u7f6e\u63cf\u8ff0' 'T499S' 'KTEXT' . _init_fieldcat 'RAUMN ' '\u4f7f\u7528\u4eba' 'ANLZ' 'RAUMN' . _init_fieldcat 'ORD41 ' '\u8d44\u4ea7\u72b6\u6001' 'ANLA' 'ORD41' . _init_fieldcat 'ORDTX ' '\u8d44\u4ea7\u72b6\u6001\u63cf\u8ff0' 'T087T' 'ORDTX' . _init_fieldcat 'EQUNR ' '\u8bbe\u5907\u53f7' 'V_EQUI' 'EQUNR' . _init_fieldcat 'EQKTX ' '\u8bbe\u5907\u63cf\u8ff0' 'V_EQUI' 'EQKTX' . _init_fieldcat 'LIEFE ' '\u4f9b\u5e94\u5546' 'ANLA' 'LIEFE' . _init_fieldcat 'HERST ' '\u5236\u9020\u5546' 'ANLA' 'HERST' . _init_fieldcat 'AFASL ' '\u6298\u65e7\u7801' 'ANLB' 'AFASL' . _init_fieldcat 'MONTHS_VALID ' '\u4f7f\u7528\u6708\u9650' '' '' . _init_fieldcat 'MONTHS_ACCRUED ' '\u5df2\u8ba1\u63d0\u6298\u65e7\u6708\u4efd' '' '' . _init_fieldcat 'AFABG ' '\u6298\u65e7\u5f00\u59cb\u65e5\u671f' 'ANLB' 'AFABG' . _init_fieldcat 'ORI_YEAR_BEGIN ' '\u5e74\u521d\u8d44\u4ea7\u539f\u503c' '' '' . _init_fieldcat 'ORI_YEAR_CHANGED' '\u672c\u5e74\u8d44\u4ea7\u4ef7\u503c\u53d8\u66f4 ' '' '' . _init_fieldcat 'DEP_YEAR_BEGIN ' '\u5e74\u521d\u8d44\u4ea7\u7d2f\u8ba1\u6298\u65e7' '' '' . _init_fieldcat 'DEP_YEAR_ACCRUAL' '\u672c\u5e74\u8d44\u4ea7\u8ba1\u63d0\u6298\u65e7' '' '' . _init_fieldcat 'DEP_PERIOD_ACCRUAL' '\u672c\u6708\u8d44\u4ea7\u8ba1\u63d0\u6298\u65e7' '' '' . _init_fieldcat 'DEP_YEAR_CHANGED' '\u672c\u5e74\u6298\u65e7\u4ef7\u503c\u53d8\u66f4' '' '' . _init_fieldcat 'ORI_YEAR_END ' '\u671f\u672b\u8d44\u4ea7\u539f\u503c' '' '' . _init_fieldcat 'DEP_YEAR_END ' '\u671f\u672b\u7d2f\u8ba1\u6298\u65e7' '' '' . _init_fieldcat 'AMOUNT ' '\u51c0\u503c' '' '' . \" \u4e2a\u6027\u5316\u81ea\u5df1\u8f93\u51fa\u6570\u636e\u683c\u5f0f LOOP AT ct_fieldcat REFERENCE INTO DATA ( lr_fieldcat ). \" \u5b57\u6bb5\u663e\u793a\u5c5e\u6027\u8bbe\u7f6e CASE lr_fieldcat -> fieldname . WHEN OTHERS . ENDCASE . ENDLOOP . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_set_color *&---------------------------------------------------------------------* *& text *&---------------------------------------------------------------------* *& --> p1 text *& <-- p2 text *&---------------------------------------------------------------------* FORM frm_set_color . DATA ls_scol TYPE lvc_s_scol . LOOP AT gt_data REFERENCE INTO DATA ( lr_data ). CLEAR lr_data -> t_scol . CASE lr_data -> mtype . WHEN 'S' . CLEAR ls_scol . ls_scol - fname = 'MTYPE' . ls_scol - color = VALUE # ( col = '5' ). INSERT ls_scol INTO TABLE lr_data -> t_scol . WHEN 'E' . CLEAR ls_scol . ls_scol - fname = 'MTYPE' . ls_scol - color = VALUE # ( col = '6' ). INSERT ls_scol INTO TABLE lr_data -> t_scol . ENDCASE . ENDLOOP . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_pf_status *&---------------------------------------------------------------------* *& \u8bbe\u7f6eGUI\u72b6\u6001 *&---------------------------------------------------------------------* FORM frm_pf_status USING ct_extab TYPE slis_t_extab . SET PF-STATUS 'STATUS' . SET TITLEBAR 'TITLE' . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_user_command *&---------------------------------------------------------------------* *& \u529f\u80fd\u54cd\u5e94 *&---------------------------------------------------------------------* FORM frm_user_command USING cv_ucomm LIKE sy - ucomm cs_selfield TYPE slis_selfield . \" \u5237\u65b0\u5c4f\u5e55\u6570\u636e\u5230\u5185\u8868 DATA : lo_grid TYPE REF TO cl_gui_alv_grid . CALL FUNCTION 'GET_GLOBALS_FROM_SLVC_FULLSCR' IMPORTING e_grid = lo_grid . CALL METHOD lo_grid -> check_changed_data . PERFORM frm_get_data_selection . \" \u6309\u94ae\u529f\u80fd\u5b9e\u73b0 CASE cv_ucomm . WHEN '&IC1' . \" \u53cc\u51fb READ TABLE gt_data INTO DATA ( ls_data ) INDEX cs_selfield - tabindex . IF sy - subrc = 0 . CASE cs_selfield - fieldname . WHEN 'ANLN1' . SET PARAMETER ID 'BUK' FIELD ls_data - bukrs . SET PARAMETER ID 'AN1' FIELD ls_data - anln1 . CALL TRANSACTION 'AW01N' . WHEN OTHERS . ENDCASE . ENDIF . WHEN OTHERS . RETURN . ENDCASE . PERFORM frm_reset_data_selection . PERFORM frm_set_color . \" \u5237\u65b0ALV \u663e\u793a\u503c cs_selfield - refresh = abap_true . cs_selfield - row_stable = abap_true . cs_selfield - col_stable = abap_true . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_get_data_selection *&---------------------------------------------------------------------* *& text *&---------------------------------------------------------------------* *& --> p1 text *& <-- p2 text *&---------------------------------------------------------------------* FORM frm_get_data_selection . \" \u5237\u65b0\u5c4f\u5e55\u6570\u636e\u5230\u5185\u8868 DATA : lo_grid TYPE REF TO cl_gui_alv_grid . CALL FUNCTION 'GET_GLOBALS_FROM_SLVC_FULLSCR' IMPORTING e_grid = lo_grid . \" \u83b7\u53d6ALV\u9009\u53d6\u884c DATA lt_rows TYPE lvc_t_row . CALL METHOD lo_grid -> get_selected_rows IMPORTING et_index_rows = lt_rows . LOOP AT lt_rows INTO DATA ( ls_row ). READ TABLE gt_data REFERENCE INTO DATA ( lr_data ) INDEX ls_row - index . IF sy - subrc = 0 . lr_data -> zsel = abap_true . ENDIF . ENDLOOP . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_reset_data_selection *&---------------------------------------------------------------------* *& text *&---------------------------------------------------------------------* *& --> p1 text *& <-- p2 text *&---------------------------------------------------------------------* FORM frm_reset_data_selection . LOOP AT gt_data REFERENCE INTO DATA ( lr_data ). CLEAR lr_data -> zsel . ENDLOOP . ENDFORM .","title":"\u56fa\u5b9a\u8d44\u4ea7\u660e\u7ec6\u62a5\u8868"},{"location":"fico/invoice_check/","text":"\u53d1\u7968\u6821\u9a8c \u00b6","title":"\u53d1\u7968\u6821\u9a8c"},{"location":"fico/invoice_check/#_1","text":"","title":"\u53d1\u7968\u6821\u9a8c"},{"location":"fico/invoice_park/","text":"\u53d1\u7968\u9884\u5236 \u00b6","title":"\u53d1\u7968\u9884\u5236"},{"location":"fico/invoice_park/#_1","text":"","title":"\u53d1\u7968\u9884\u5236"},{"location":"fico/invoice_post/","text":"\u53d1\u7968\u8fc7\u8d26 \u00b6","title":"\u53d1\u7968\u8fc7\u8d26"},{"location":"fico/invoice_post/#_1","text":"","title":"\u53d1\u7968\u8fc7\u8d26"},{"location":"gtm/","text":"\u8d38\u6613\u7ba1\u7406\u6a21\u5757 \u00b6 \u4ece\u6280\u672f\u89d2\u5ea6\u4e0a\u770bGTM\uff0c\u8d38\u6613\u5408\u540c\u975e\u5fc5\u987b\uff0c\u4f46\u8d38\u6613\u5408\u540c\u5173\u8054\u91c7\u9500\uff0c\u4f7f\u5f97\u4e1a\u52a1\u96c6\u4e2d\uff0c\u5bf9\u5b9e\u65bd\u8fc7\u7a0b\u6709\u63d0\u5347\uff0c\u4e0d\u59a8\u4e86\u89e3\u4e0b\u3002 \u4e0b\u9762\u5c06\u8bb2\u8ff0WTEW\u5de5\u4f5c\u53f0\u914d\u7f6e\u3001\u5408\u540c\u521b\u5efa\u4e0e\u7ef4\u62a4\u3001\u5408\u540c\u5173\u8054\u3001\u5408\u540c\u5ba1\u6279\u7b49\u4e3b\u8981\u529f\u80fd\u3002","title":"GTM\u6a21\u5757\u6982\u8ff0"},{"location":"gtm/#_1","text":"\u4ece\u6280\u672f\u89d2\u5ea6\u4e0a\u770bGTM\uff0c\u8d38\u6613\u5408\u540c\u975e\u5fc5\u987b\uff0c\u4f46\u8d38\u6613\u5408\u540c\u5173\u8054\u91c7\u9500\uff0c\u4f7f\u5f97\u4e1a\u52a1\u96c6\u4e2d\uff0c\u5bf9\u5b9e\u65bd\u8fc7\u7a0b\u6709\u63d0\u5347\uff0c\u4e0d\u59a8\u4e86\u89e3\u4e0b\u3002 \u4e0b\u9762\u5c06\u8bb2\u8ff0WTEW\u5de5\u4f5c\u53f0\u914d\u7f6e\u3001\u5408\u540c\u521b\u5efa\u4e0e\u7ef4\u62a4\u3001\u5408\u540c\u5173\u8054\u3001\u5408\u540c\u5ba1\u6279\u7b49\u4e3b\u8981\u529f\u80fd\u3002","title":"\u8d38\u6613\u7ba1\u7406\u6a21\u5757"},{"location":"gtm/contract/","text":"\u8d38\u6613\u5408\u540c \u00b6 \u6ce8\u610f\uff0c\u5982\u679c\u662f\u5408\u540c\u53c2\u8003\u521b\u5efa\u7684\u8ba2\u5355\uff0c\u901a\u5e38\u4f1a\u8981\u6c42\u901a\u8fc7\u5de5\u4f5c\u53f0\u5904\u7406\uff0c\u8fd9\u65f6\u9700\u8981\u5728\u4e1a\u52a1\u6267\u884c\u524d\u52a0\u5165\u4ee5\u4e0b\u4ee3\u7801\uff1a \u793a\u4f8b\u4ee3\u7801 CALL FUNCTION 'WB2_RESET_EXTERNAL_DATA' . CALL FUNCTION 'WB2_CHECK_TEW_ACTIVE' EXCEPTIONS not_active = 1 OTHERS = 2 . DATA l_tew_type TYPE wb2_tew_type . CALL FUNCTION 'WB2_TRADE_GET_INIT_DATA' IMPORTING e_tew_type = l_tew_type . CALL FUNCTION 'WB2_TEW_ACTION_SET_PARAMETER' EXPORTING i_tew_type = i_tew_type i_step = i_step i_mode = i_mode i_pre_step = i_pre_step i_catt_active = 'X' . WTEW\u914d\u7f6e \u00b6 SPRO\\\u540e\u52e4\\\u5168\u7403\u8d38\u6613\u7ba1\u7406 \u8d38\u6613\u5408\u540c\u521b\u5efa\u4e0e\u4fee\u6539 \u00b6 \u901a\u5e38\uff0c\u6d41\u7a0b\u9996\u5148\u521b\u5efa\u8d2d\u9500\u5408\u540c\uff0c\u7136\u540e\u518d\u53c2\u8003\u8be5\u5408\u540c\uff0c\u521b\u5efa\u540e\u7eed\u7684\u91c7\u8d2d\u5408\u540c\u548c\u9500\u552e\u5408\u540c\u3002\u8fd9\u4e09\u79cd\u5408\u540c\u6309\u5408\u540c\u7c7b\u578b\u52a0\u4ee5\u533a\u5206\uff0c\u53ef\u7531\u4e1a\u52a1\u914d\u7f6e\u3002 BAPI_TRADINGCONTRACT_CREATE \uff1a\u521b\u5efa\u8d38\u6613\u5408\u540c BAPI_TRADINGCONTRACT_CHANGE \uff1a\u4fee\u6539\u8d38\u6613\u5408\u540c WB2_DELETE_TRADING_CONT_ALL \uff1a\u5408\u540c\u6279\u91cf\u5220\u9664 \u793a\u4f8b\u4ee3\u7801 *----------------------------------------------------------------------* ***INCLUDE LZGTM001P01. *----------------------------------------------------------------------* *&---------------------------------------------------------------------* *& Class (Implementation) lcl_wb2_ctr_data *&---------------------------------------------------------------------* *& *&---------------------------------------------------------------------* CLASS lcl_wb2_ctr_data IMPLEMENTATION . METHOD read . IF contract_id IS SUPPLIED AND m_contract <> contract_id . m_contract = contract_id . mo_instance = NEW # ( ). DATA l_tkonn TYPE komwbhk - tkonn . DATA ls_t180 TYPE t180 . l_tkonn = contract_id . ls_t180 = VALUE # ( trtyp = 'A' ). CALL FUNCTION 'WB2_CONTRACT_READ' EXPORTING i_tkonn = l_tkonn i_t180 = ls_t180 IMPORTING e_komwbhk = mo_instance -> ms_komwbhk TABLES t_komwbhk = mo_instance -> mt_komwbhk t_komwbhi = mo_instance -> mt_komwbhi t_komwbhd = mo_instance -> mt_komwbhd t_komwbhe = mo_instance -> mt_komwbhe t_komwbhp = mo_instance -> mt_komwbhp EXCEPTIONS application_data_error = 1 lock_error = 2 customizing_error = 3 OTHERS = 4 . IF sy - subrc <> 0 . * Implement suitable error handling here ENDIF . ENDIF . \" \u81f3\u5c11\u4fdd\u8bc1\u4e0ddump IF mo_instance IS NOT BOUND . mo_instance = NEW # ( ). ENDIF . result = mo_instance . ENDMETHOD . METHOD get_fiori_head . \" \u62ac\u5934 result - tkonn = ms_komwbhk - tkonn . result - tkonn_ex = ms_komwbhk - tkonn_ex . result - tew_type = ms_komwbhk - tew_type . result - zframe_tkonn = ms_komwbhk - zframe_tkonn . result - zzsign_platfrom = ms_komwbhk - vkorg . result - vtweg = ms_komwbhk - vtweg . result - spart = ms_komwbhk - spart . result - zzsndat = ms_komwbhk - zzsndat . result - btbsta = ms_komwbhk - btbsta . result - zprictp = ms_komwbhk - zprictp . result - zzlsch_mm = ms_komwbhk - zzlsch_mm . result - zzlsch_mm_ex = ms_komwbhk - zzlsch_txt_mm_n . result - zzlsch_sd = ms_komwbhk - zzlsch_sd . result - zzlsch_sd_ex = ms_komwbhk - zzlsch_txt_sd_n . result - zzrpdate_end = ms_komwbhk - zzrpdate_end . result - zzamt01_mm = ms_komwbhk - zzamt01_mm . result - zzcur01_mm = ms_komwbhk - zzcur01_mm . result - zzpcode_src = ms_komwbhk - zzpcode_src . result - zzland1_src = ms_komwbhk - zzland1_src . result - zzpname_src = ms_komwbhk - zzpname_src . result - zzpcode_des = ms_komwbhk - zzpcode_des . result - zzland1_des = ms_komwbhk - zzland1_des . result - zzpname_des = ms_komwbhk - zzpname_des . result - zzpcode_tra = ms_komwbhk - zzpcode_tra . result - zzland1_tra = ms_komwbhk - zzland1_tra . result - zzpname_tra = ms_komwbhk - zzpname_tra . result - zzis_preins = ms_komwbhk - zzis_preins . result - zzreceived_data_last = |{ ms_komwbhk - zzzcdh_date DATE = RAW }|. result - zzlaycan_from = ms_komwbhk - zzlaycanq . result - zzlaycan_to = ms_komwbhk - zzlaycanz . result - tctyp = ms_komwbhk - tctyp . result - zzbusst = ms_komwbhk - zzbusst . result - zzsnfile = ms_komwbhk - zzsnfile . result - zzsnflg = ms_komwbhk - zzsnflg . result - zzwd_tcdoc_flg = ms_komwbhk - zzwd_tcdoc_flg . result - zzyqd = ms_komwbhk - zzyqd . result - zzstpga_flg = ms_komwbhk - zzstpga_flg . result - zzgmyw_flg = ms_komwbhk - zzgmyw_flg . result - zzflexible = ms_komwbhk - zzflexible . result - zzwtcgp = ms_komwbhk - zzwtcgp . result - zzwtcgp_rt = ms_komwbhk - zzwtcgp_rt . result - guarantee_f = ms_komwbhk - guarantee_f . result - ciq_lastdt = ms_komwbhk - ciq_lastdt . result - consnno = ms_komwbhk - consnno . result - remark1_p = ms_komwbhk - remark1_p . result - remark2_p = ms_komwbhk - remark2_p . result - remark3_p = ms_komwbhk - remark3_p . result - zzwtc_fvdate = ms_komwbhk - zzwtc_fvdate . result - zzwtc_fvtime = ms_komwbhk - zzwtc_fvtime . result - zzwtc_fvapper = ms_komwbhk - zzwtc_fvapper . result - zzefeupt_date = ms_komwbhk - zzefeupt_date . result - zzpreclo_date = ms_komwbhk - zzpreclo_date . result - zznatclo_date = ms_komwbhk - zznatclo_date . \" \u62ac\u59342 LOOP AT mt_komwbhd REFERENCE INTO DATA ( lr_komwbhd ). result - bstkd = lr_komwbhd -> bstkd . result - waers = lr_komwbhd -> waers_purch . result - tkrate_mm = lr_komwbhd -> tkrate_mm . result - kurst_mm = lr_komwbhd -> kurst_mm . result - ekorg = lr_komwbhd -> ekorg . result - ekgrp = lr_komwbhd -> ekgrp . result - inco1_mm = lr_komwbhd -> inco1_mm . result - inco1_mm_ex = lr_komwbhd -> inco2_l_mm . result - inco1_sd = lr_komwbhd -> inco1_sd . result - inco1_sd_ex = lr_komwbhd -> inco2_l_sd . result - zterm = lr_komwbhd -> zterm . result - zzshipping_data_last = lr_komwbhd -> edatu_vbak . result - zzreceived_data_last = lr_komwbhd -> eindt . EXIT . ENDLOOP . \" \u62ac\u5934\u91d1\u989d\u6c47\u603b LOOP AT mt_komwbhi REFERENCE INTO DATA ( lr_komwbhi ). result - zamount_sum = result - zamount_sum + lr_komwbhi -> netpr_mm * lr_komwbhi -> menge . result - zcurrency_sum = lr_komwbhi -> waers_mm . ENDLOOP . \" \u62ac\u59343 LOOP AT mt_komwbhp REFERENCE INTO DATA ( lr_komwbhp ). CASE lr_komwbhp -> parvw . WHEN 'LF' OR 'VN' . result - lifnr = lr_komwbhp -> lifnr . WHEN 'RS' OR 'PI' . WHEN 'Z4' . result - lifnr2 = lr_komwbhp -> lifnr . WHEN 'Z1' . result - lifnr3 = lr_komwbhp -> lifnr . WHEN 'ER' OR 'ZM' . result - lifnr4 = lr_komwbhp -> lifnr . WHEN 'SP' OR 'AG' . WHEN 'WE' OR 'SH' . WHEN OTHERS . ENDCASE . ENDLOOP . ENDMETHOD . METHOD get_fiori_partner . DATA ls_partner LIKE LINE OF result . LOOP AT mt_komwbhp REFERENCE INTO DATA ( lr_komwbhp ). CLEAR ls_partner . ls_partner - tkonn = lr_komwbhp -> tkonn . ls_partner - tposn = lr_komwbhp -> tposn . ls_partner - tposn_sub = lr_komwbhp -> tposn_sub . ls_partner - parvw = lr_komwbhp -> parvw . ls_partner - lifnr = lr_komwbhp -> lifnr . ls_partner - kunnr = lr_komwbhp -> kunnr . ls_partner - adrnr = lr_komwbhp -> adrnr . ls_partner - land = lr_komwbhp -> land . ls_partner - pstlz = lr_komwbhp -> pstlz . ls_partner - regio = lr_komwbhp -> regio . ls_partner - ort01 = lr_komwbhp -> ort01 . ls_partner - name1 = lr_komwbhp -> name1 . INSERT ls_partner INTO TABLE result . ENDLOOP . ENDMETHOD . METHOD get_fiori_item . DATA ls_item LIKE LINE OF result . LOOP AT mt_komwbhi REFERENCE INTO DATA ( lr_komwbhi ). CLEAR ls_item . ls_item - tkonn = lr_komwbhi -> tkonn . ls_item - tposn = lr_komwbhi -> tposn . ls_item - tposn_sub = lr_komwbhi -> tposn_sub . ls_item - matnr = lr_komwbhi -> matnr . ls_item - arktx = lr_komwbhi -> arktx . ls_item - menge = lr_komwbhi -> menge . ls_item - meins = lr_komwbhi -> meins . ls_item - uebto_mm = lr_komwbhi -> uebto_mm . ls_item - untto_mm = lr_komwbhi -> untto_mm . ls_item - netpr_mm = lr_komwbhi -> netpr_mm . ls_item - peinh_mm = lr_komwbhi -> peinh_mm . ls_item - waers_mm = lr_komwbhi -> waers_mm . ls_item - zzsubtotal = ls_item - netpr_mm * ls_item - menge . * ls_item-zzunit_price = lr_komwbhi->zzunit_price. ls_item - lgort = lr_komwbhi -> lgort . ls_item - zpcmark = lr_komwbhi -> zpcmark . \" \u7279\u6027\u53d6\u503c DATA allocvaluesnum TYPE STANDARD TABLE OF bapi1003_alloc_values_num . DATA allocvalueschar TYPE STANDARD TABLE OF bapi1003_alloc_values_char . DATA allocvaluescurr TYPE STANDARD TABLE OF bapi1003_alloc_values_curr . DATA return TYPE STANDARD TABLE OF bapiret2 . CLEAR allocvaluesnum . CLEAR allocvalueschar . CLEAR allocvaluescurr . CLEAR return . CALL FUNCTION 'BAPI_OBJCL_GETDETAIL' EXPORTING objectkey = CONV bapi1003_key - object ( ls_item - matnr ) objecttable = 'MARA' classnum = 'C_01' classtype = '023' TABLES allocvaluesnum = allocvaluesnum allocvalueschar = allocvalueschar allocvaluescurr = allocvaluescurr return = return . LOOP AT allocvalueschar REFERENCE INTO DATA ( lr_allocvalueschar ). CASE lr_allocvalueschar -> charact . WHEN 'B_0001' . \" \u9884\u7b97\u53f7 WHEN 'B_0002' . \" \u5916\u90e8\u5408\u540c\u53f7 WHEN 'B_0003' . \" \u91c7\u8d2d\u8ba2\u5355\u53f7 WHEN 'B_0004' . \" \u91c7\u8d2d\u8ba2\u5355\u7c7b\u578b WHEN 'B_0005' . \" \u4e1a\u52a1\u5f62\u5f0f WHEN 'B_0006' . \" \u91c7\u8d2d\u7ec4 WHEN 'B_0007' . \" \u4e1a\u52a1\u5458 WHEN 'B_0008' . \" \u5165\u5e93\u65f6\u95f4 WHEN 'B_0009' . \" \u89c4\u683c\u5c5e\u60271 WHEN 'B_0010' . \" \u89c4\u683c\u5c5e\u60272 WHEN 'B_0011' . \" \u4ea7\u54c1\u79cd\u7c7b/\u6750\u8d28 ls_item - zprdcat = lr_allocvalueschar -> value_char . WHEN 'B_0012' . \" \u5546\u54c1\u7b49\u7ea7 ls_item - zoland = lr_allocvalueschar -> value_char . WHEN 'B_0013' . \" \u5382\u5bb6/\u54c1\u724c ls_item - zfactory = lr_allocvalueschar -> value_char . WHEN 'B_0014' . \" \u5de5\u827a/\u6280\u672f\u6807\u51c6 ls_item - ztechstd = lr_allocvalueschar -> value_char . WHEN 'B_0015' . \" \u578b\u53f7/\u7b49\u7ea7 ls_item - zprdcat = lr_allocvalueschar -> value_char . WHEN 'B_0016' . \" \u5907\u6ce8 WHEN 'B_0018' . \" \u5c3a\u5bf8/\u5305\u88c5 ls_item - zccbz = lr_allocvalueschar -> value_char . WHEN 'B_0019' . \" \u8fd0\u8f93\u8f7d\u5177\u53f7 ls_item - zyszjh = lr_allocvalueschar -> value_char . WHEN 'B_0020' . \" \u8fd0\u8f93\u65b9\u5f0f WHEN 'B_0021' . \" \u91c7\u8d2d\u8ba2\u5355\u884c\u9879\u76ee WHEN 'B_0030' . \" \u7b2c\u4e8c\u8ba1\u91cf\u5355\u4f4d WHEN 'B_0031' . \" \u7b2c\u4e8c\u5355\u4f4d\u8f6c\u6362\u7cfb\u6570 WHEN 'B_0032' . \" \u7b2c\u4e8c\u5355\u4f4d\u53ef\u53d8\u53c2\u6570 WHEN 'B_0017' . \" \u539f\u4ea7\u5730 WHEN 'B_0022' . \" \u6027\u80fd/\u7528\u9014 WHEN 'B_0023' . \" \u8fd0\u8f93\u5355\u636e\u53f7 ls_item - zysdjh = lr_allocvalueschar -> value_char . WHEN 'B_0024' . \" \u62a5\u5173\u5355\u53f7 ls_item - zbgdh = lr_allocvalueschar -> value_char . WHEN 'B_0025' . \" \u5e93\u4f4d\uff08\u533a\uff09\u53f7 ls_item - zkwh = lr_allocvalueschar -> value_char . WHEN 'B_0026' . \" \u751f\u4ea7\u65e5\u671f ls_item - zscrq = lr_allocvalueschar -> value_char . WHEN 'B_0027' . \" \u81ea\u5b9a\u4e49\u5c5e\u60271 ls_item - zzdysx1 = lr_allocvalueschar -> value_char . WHEN 'B_0028' . \" \u81ea\u5b9a\u4e49\u5c5e\u60272 ls_item - zzdysx2 = lr_allocvalueschar -> value_char . WHEN 'B_0029' . \" \u81ea\u5b9a\u4e49\u5c5e\u60273 ls_item - zzdysx3 = lr_allocvalueschar -> value_char . WHEN OTHERS . ENDCASE . ENDLOOP . INSERT ls_item INTO TABLE result . ENDLOOP . ENDMETHOD . METHOD get_fiori_condition . DATA ls_condition LIKE LINE OF result . \" \u5b9a\u4ef7 DATA ( lt_komwbhd ) = mt_komwbhd . IF ms_komwbhk - knumv_sd IS NOT INITIAL . INSERT VALUE # ( knumv_mm = ms_komwbhk - knumv_sd ) INTO TABLE lt_komwbhd . ENDIF . LOOP AT lt_komwbhd REFERENCE INTO DATA ( lr_komwbhd ). SELECT SINGLE knumv , kposn , stunr , zaehk , kschl , kbetr , waers , kpein , kmein , kwert FROM prcd_elements WHERE knumv = @ lr_komwbhd -> knumv_mm INTO @ DATA ( ls_prcd_elements ). IF sy - subrc <> 0 . CONTINUE . ENDIF . CLEAR ls_condition . ls_condition - tkonn = lr_komwbhd -> tkonn . ls_condition - tposn = lr_komwbhd -> tposn . ls_condition - tposn_sub = lr_komwbhd -> tposn_sub . ls_condition - knumv = ls_prcd_elements - knumv . ls_condition - kposn = ls_prcd_elements - kposn . ls_condition - stunr = ls_prcd_elements - stunr . ls_condition - zaehk = ls_prcd_elements - zaehk . ls_condition - kschl = ls_prcd_elements - kschl . * LS_CONDITION-kschl_text = ls_prcd_elements-kschl_text . * LS_CONDITION-zzto_cost = ls_prcd_elements-zzto_cost . ls_condition - kbetr = ls_prcd_elements - kbetr . ls_condition - waers = ls_prcd_elements - waers . ls_condition - kpein = ls_prcd_elements - kpein . ls_condition - kmein = ls_prcd_elements - kmein . * LS_CONDITION-zzconvertion = ls_prcd_elements-zzconvertion. ls_condition - kwert = ls_prcd_elements - kwert . INSERT ls_condition INTO TABLE result . ENDLOOP . ENDMETHOD . METHOD get_fiori_related . ENDMETHOD . METHOD get_fiori_text . ENDMETHOD . ENDCLASS . *&---------------------------------------------------------------------* *& Class (Implementation) lcl_fiori_ctr_data *&---------------------------------------------------------------------* *& *&---------------------------------------------------------------------* CLASS lcl_fiori_ctr_data IMPLEMENTATION . METHOD read . IF contract_id IS SUPPLIED AND m_contract <> contract_id . m_contract = contract_id . mo_instance = NEW # ( ). DATA ( lo_wb2_ctr_data ) = lcl_wb2_ctr_data => read ( m_contract ). mo_instance -> ms_head = lo_wb2_ctr_data -> get_fiori_head ( ). mo_instance -> mt_partner = lo_wb2_ctr_data -> get_fiori_partner ( ). mo_instance -> mt_item = lo_wb2_ctr_data -> get_fiori_item ( ). mo_instance -> mt_condition = lo_wb2_ctr_data -> get_fiori_condition ( ). mo_instance -> mt_related = lo_wb2_ctr_data -> get_fiori_related ( ). mo_instance -> mt_text = lo_wb2_ctr_data -> get_fiori_text ( ). mo_instance -> mt_payment = mo_instance -> read_payment ( ). ENDIF . \" \u81f3\u5c11\u4fdd\u8bc1\u4e0ddump IF mo_instance IS NOT BOUND . mo_instance = NEW # ( ). ENDIF . result = mo_instance . ENDMETHOD . METHOD save_payment . DATA lt_zttcpt TYPE STANDARD TABLE OF zttcpt WITH EMPTY KEY . DATA ls_zttcpt TYPE zttcpt . LOOP AT mt_payment REFERENCE INTO DATA ( lr_payment ). CLEAR ls_zttcpt . ls_zttcpt - tkonn = m_contract . ls_zttcpt - zzxh = sy - tabix . ls_zttcpt - zzfktj = lr_payment -> zzterm . ls_zttcpt - zzsfkrq = lr_payment -> zzdate_last . ls_zttcpt - zzysfkje = lr_payment -> zzamount . ls_zttcpt - zwaers_purch = lr_payment -> zzcurrency . ls_zttcpt - zzsfk_remark = lr_payment -> zzpay_ex . INSERT ls_zttcpt INTO TABLE lt_zttcpt . ENDLOOP . DELETE FROM zttcpt WHERE tkonn = ms_head - tkonn . MODIFY zttcpt FROM TABLE lt_zttcpt . COMMIT WORK AND WAIT . ENDMETHOD . METHOD read_payment . DATA ( l_tkonn ) = contract_id . IF contract_id IS NOT SUPPLIED . l_tkonn = ms_head - tkonn . ENDIF . SELECT tkonn , zzxh , zzfktj AS zzterm , CAST ( zzsfkrq AS CHAR ( 10 ) ) AS zzdate_last , zzysfkje AS zzamount , zwaers_purch AS zzcurrency , zzsfk_remark AS zzpay_ex FROM zttcpt WHERE tkonn = @ l_tkonn INTO CORRESPONDING FIELDS OF TABLE @ mt_payment . result = mt_payment . ENDMETHOD . ENDCLASS . *&---------------------------------------------------------------------* *& Class (Implementation) lcl_bapi_ctr_create *&---------------------------------------------------------------------* *& *&---------------------------------------------------------------------* CLASS lcl_bapi_ctr_create IMPLEMENTATION . METHOD lif_bapi~execute . result = me . \" \u589e\u5f3a\u5b57\u6bb5\u957f\u5ea6\u5927\u4e8e960\uff0c\u65e0\u6cd5\u4f7f\u7528extensionin\u5b57\u6bb5 \" \u56e0\u6b64\u901a\u8fc7BAPI\u589e\u5f3a\u7684\u65b9\u5f0f\uff0c\u5c06\u503c\u4f20\u5165 \" \u7531\u4e8e\u662f\u9759\u6001\u53c2\u6570\uff0c\u7b49\u4ef7\u4e8e\u5185\u5b58\u4f20\u503c\uff0c\u800c\u4e14\u66f4\u597d\u7684\u6eaf\u6e90 zcl_im__wb2_bapi_enhance_ex => set_extension ( EXPORTING bapi_te_wbhk = ms_bapi_te_wbhk t_bapi_te_wbhi = mt_bapi_te_wbhi t_bapi_te_wbhd = mt_bapi_te_wbhd t_bapi_te_wbhe = mt_bapi_te_wbhe t_bapi_te_wbhp = mt_bapi_te_wbhp bapi_te_wbhkx = ms_bapi_te_wbhkx t_bapi_te_wbhix = mt_bapi_te_wbhix t_bapi_te_wbhdx = mt_bapi_te_wbhdx t_bapi_te_wbhex = mt_bapi_te_wbhex t_bapi_te_wbhpx = mt_bapi_te_wbhpx ). headdatain - testrun = testrun . SET PARAMETER ID 'BAPIHT' FIELD 'X' . \" BAPI\u521b\u5efa\u5408\u540c\uff0c\u7528\u4e8e\u8df3\u8fc7\u90e8\u5206\u6821\u9a8c CALL FUNCTION 'BAPI_TRADINGCONTRACT_CREATE' EXPORTING headdatain = headdatain IMPORTING headdataout = headdataout tradingcontractno = tradingcontractno TABLES itemdatain = itemdatain scheduledatain = scheduledatain businessdatain = businessdatain buspartyin = buspartyin extensionin = extensionin headtextin = headtextin itemtextin = itemtextin itemdataout = itemdataout scheduledataout = scheduledataout businessdataout = businessdataout buspartyout = buspartyout headtextout = headtextout itemtextout = itemtextout extensionout = extensionout return = return partneraddresses = partneraddresses vendorcondin = vendorcondin customercondin = customercondin conditionkeydatain = conditionkeydatain conditionkeydatainx = conditionkeydatainx conditionitemdatain = conditionitemdatain conditionitemdatainx = conditionitemdatainx conditionkeydataout = conditionkeydataout conditionitemdataout = conditionitemdataout scaledatain = scaledatain scaledataout = scaledataout vendorcondout = vendorcondout customercondout = customercondout . SET PARAMETER ID 'BAPIHT' FIELD '' . lif_bapi~document = tradingcontractno . lif_bapi~mt_bapiret2 = CORRESPONDING # ( return ). CALL FUNCTION 'Z_MESSAGE_TABLE_TO_FIELD' EXPORTING t_bapiret2 = lif_bapi~mt_bapiret2 IMPORTING status = lif_bapi~status message = lif_bapi~message . \" \u53d1\u751f\u9519\u8bef\u6216\u6d4b\u8bd5\u6267\u884c\u7684\u60c5\u51b5\uff0c\u4e0d\u63d0\u4ea4 IF lif_bapi~status = 'E' OR testrun = abap_true . CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK' . CLEAR lif_bapi~document . RETURN . ENDIF . \" \u6b63\u5f0f\u63d0\u4ea4 CALL FUNCTION 'BAPI_TRANSACTION_COMMIT' EXPORTING wait = abap_true . ENDMETHOD . METHOD set_head . DATA ( ls_head ) = input -> ms_head . \" \u62ac\u5934\u6570\u636e headdatain - tkonn_ex = ls_head - tkonn_ex . headdatain - trcont_type = ls_head - tctyp . headdatain - tew_type = ls_head - tew_type . headdatain - trcont_stat = ls_head - btbsta . headdatain - trcont_currency = ls_head - waers . headdatain - currency = ls_head - waers . headdatain - purch_no = ls_head - bstkd . headdatain - comp_code = ls_head - zzsign_platfrom . headdatain - sales_grp = ls_head - ekgrp . headdatain - sales_off = ls_head - ekorg . headdatain - sales_org = ls_head - zzsign_platfrom . headdatain - distr_chan = ls_head - vtweg . headdatain - division = ls_head - spart . IF headdatain - tew_type IS INITIAL . headdatain - tew_type = 'Z001' . ENDIF . IF headdatain - distr_chan IS INITIAL . headdatain - distr_chan = '10' . ENDIF . IF headdatain - division IS INITIAL . headdatain - division = '11' . ENDIF . \" \u62ac\u5934\u6570\u636e\u6269\u5c55\u5b57\u6bb5 ms_bapi_te_wbhk - vkgrp = ls_head - ekgrp . ms_bapi_te_wbhk - vkbur = ls_head - ekorg . ms_bapi_te_wbhk - tkonn_ex = ls_head - tkonn_ex . ms_bapi_te_wbhk - guarantee_f = ls_head - guarantee_f . ms_bapi_te_wbhk - ciq_lastdt = ls_head - ciq_lastdt . ms_bapi_te_wbhk - consnno = ls_head - consnno . ms_bapi_te_wbhk - zframe_tkonn = ls_head - zframe_tkonn . ms_bapi_te_wbhk - zzsndat = ls_head - zzsndat . ms_bapi_te_wbhk - zprictp = ls_head - zprictp . ms_bapi_te_wbhk - zzlsch_mm = ls_head - zzlsch_mm . ms_bapi_te_wbhk - zzlsch_txt_mm_n = ls_head - zzlsch_mm_ex . ms_bapi_te_wbhk - zzlsch_sd = ls_head - zzlsch_sd . ms_bapi_te_wbhk - zzlsch_txt_sd_n = ls_head - zzlsch_sd_ex . ms_bapi_te_wbhk - zzrpdate_end = ls_head - zzrpdate_end . * ms_bapi_te_wbhk-zzrpdate_end_ex = ls_head-zzrpdate_end_ex . ms_bapi_te_wbhk - zzamt01_mm = ls_head - zzamt01_mm . ms_bapi_te_wbhk - zzcur01_mm = ls_head - zzcur01_mm . * ms_bapi_te_wbhk-zzamt01_mm_ex = ls_head-zzamt01_mm_ex . ms_bapi_te_wbhk - zzpcode_src = ls_head - zzpcode_src . ms_bapi_te_wbhk - zzland1_src = ls_head - zzland1_src . ms_bapi_te_wbhk - zzpname_src = ls_head - zzpname_src . ms_bapi_te_wbhk - zzpcode_des = ls_head - zzpcode_des . ms_bapi_te_wbhk - zzland1_des = ls_head - zzland1_des . ms_bapi_te_wbhk - zzpname_des = ls_head - zzpname_des . ms_bapi_te_wbhk - zzpcode_tra = ls_head - zzpcode_tra . ms_bapi_te_wbhk - zzland1_tra = ls_head - zzland1_tra . ms_bapi_te_wbhk - zzpname_tra = ls_head - zzpname_tra . ms_bapi_te_wbhk - zzis_preins = ls_head - zzis_preins . ms_bapi_te_wbhk - zzzcdh_date = ls_head - zzreceived_data_last . ms_bapi_te_wbhk - zzlaycanq = ls_head - zzlaycan_from . ms_bapi_te_wbhk - zzlaycanz = ls_head - zzlaycan_to . * ms_bapi_te_wbhk-zzlogistics_ex = ls_head-zzlogistics_ex . ms_bapi_te_wbhk - zzbusst = ls_head - zzbusst . ms_bapi_te_wbhk - zzsnfile = ls_head - zzsnfile . ms_bapi_te_wbhk - zzsnflg = ls_head - zzsnflg . ms_bapi_te_wbhk - zzwd_tcdoc_flg = ls_head - zzwd_tcdoc_flg . ms_bapi_te_wbhk - zzyqd = ls_head - zzyqd . ms_bapi_te_wbhk - zzstpga_flg = ls_head - zzstpga_flg . ms_bapi_te_wbhk - zzgmyw_flg = ls_head - zzgmyw_flg . ms_bapi_te_wbhk - zzflexible = ls_head - zzflexible . ms_bapi_te_wbhk - zzwtcgp = ls_head - zzwtcgp . ms_bapi_te_wbhk - zzwtcgp_rt = ls_head - zzwtcgp_rt . * ms_bapi_te_wbhk-zzwtcgp_rt_ex = ls_head-zzwtcgp_rt_ex . * ms_bapi_te_wbhk-zztext1 = ls_head-zztext1 . * ms_bapi_te_wbhk-zztext2 = ls_head-zztext2 . ms_bapi_te_wbhk - zzwtc_fvdate = ls_head - zzwtc_fvdate . ms_bapi_te_wbhk - zzwtc_fvtime = ls_head - zzwtc_fvtime . ms_bapi_te_wbhk - zzwtc_fvapper = ls_head - zzwtc_fvapper . ms_bapi_te_wbhk - zzefeupt_date = ls_head - zzefeupt_date . ms_bapi_te_wbhk - zzefeupt_time = ls_head - zzefeupt_time . ms_bapi_te_wbhk - zzefeupt_name = ls_head - zzefeupt_apper . ms_bapi_te_wbhk - zzpreclo_date = ls_head - zzpreclo_date . ms_bapi_te_wbhk - zzpreclo_time = ls_head - zzpreclo_time . ms_bapi_te_wbhk - zzpreclo_name = ls_head - zzpreclo_apper . ms_bapi_te_wbhk - zznatclo_date = ls_head - zznatclo_date . ms_bapi_te_wbhk - zznatclo_time = ls_head - zznatclo_time . ms_bapi_te_wbhk - zznatclo_name = ls_head - zznatclo_apper . ms_bapi_te_wbhk - zzfdclo_date = ls_head - zzcancel_date . ms_bapi_te_wbhk - zzfdclo_time = ls_head - zzcancel_time . ms_bapi_te_wbhk - zzfdclo_name = ls_head - zzcancel_apper . * ms_bapi_te_wbhk-zzfield1 = ls_head-zzfield1 . * ms_bapi_te_wbhk-zzfield2 = ls_head-zzfield2 . * ms_bapi_te_wbhk-zzfield3 = ls_head-zzfield3 . * ms_bapi_te_wbhk-zzfield4 = ls_head-zzfield4 . * ms_bapi_te_wbhk-zzfield5 = ls_head-zzfield5 . * ms_bapi_te_wbhk-zzfield6 = ls_head-zzfield6 . * ms_bapi_te_wbhk-zzfield7 = ls_head-zzfield7 . * ms_bapi_te_wbhk-zzfield8 = ls_head-zzfield8 . * ms_bapi_te_wbhk-zzfield9 = ls_head-zzfield9 . ENDMETHOD . METHOD set_bussiness . DATA ( ls_head ) = input -> ms_head . \" \u4e1a\u52a1\u6570\u636e\u9996\u884c\u662f\u62ac\u5934\u7528\u7684 DATA ls_businessdatain TYPE bapitcbus . CLEAR ls_businessdatain . ls_businessdatain - vendor = ls_head - lifnr . ls_businessdatain - pmnttrms = ls_head - zterm . ls_businessdatain - currency = ls_head - waers . ls_businessdatain - exch_rate_p = ls_head - tkrate_mm . ls_businessdatain - exchg_rate = ls_head - kurst_mm . ls_businessdatain - exch_rate_v = ls_head - tkrate_sd . * ls_businessdatain-kurst_sd = ls_head-kurst_sd . ls_businessdatain - incoterms1 = ls_head - inco1_mm . ls_businessdatain - incoterms2 = ls_head - inco1_mm_ex . ls_businessdatain - incoterms1_sd = ls_head - inco1_sd . ls_businessdatain - incoterms2_sd = ls_head - inco1_sd_ex . ls_businessdatain - purch_org = ls_head - ekorg . ls_businessdatain - pur_group = ls_head - ekgrp . INSERT ls_businessdatain INTO TABLE businessdatain . \" \u65e5\u671f\u5904\u7406 DEFINE _clean_date . REPLACE ALL OCCURRENCES OF '[^0-9]' IN &1 WITH '' . IF &1 IS INITIAL . &1 = '00000000' . ENDIF . END-OF-DEFINITION . _clean_date ls_head - zzshipping_data_last . _clean_date ls_head - zzreceived_data_last . \" \u884c\u9879\u76ee\u589e\u5f3a\u7ed3\u6784 DATA ls_bapi_te_wbhd TYPE bapi_te_wbhd . CLEAR ls_bapi_te_wbhd . ls_bapi_te_wbhd - bstdk = ls_head - bstkd . ls_bapi_te_wbhd - edatu_vbak = ls_head - zzshipping_data_last . ls_bapi_te_wbhd - eindt = ls_head - zzreceived_data_last . INSERT ls_bapi_te_wbhd INTO TABLE mt_bapi_te_wbhd . ENDMETHOD . METHOD set_item . DATA ( ls_head ) = input -> ms_head . DATA ( lt_item ) = input -> mt_item . DATA ls_itemdatain TYPE bapitcitem . DATA ls_bapi_te_wbhi TYPE bapi_te_wbhi . \" \u884c\u9879\u76ee LOOP AT lt_item INTO DATA ( ls_item ). IF ls_item - tposn IS INITIAL . ls_item - tposn = sy - tabix * 10 . ENDIF . CLEAR ls_itemdatain . ls_itemdatain - trcont_item = ls_item - tposn . ls_itemdatain - trcont_subitem = ls_item - tposn_sub . ls_itemdatain - plant = ls_head - zzsign_platfrom . ls_itemdatain - material = ls_item - matnr . ls_itemdatain - material_long = ls_item - matnr . ls_itemdatain - short_text = ls_item - arktx . ls_itemdatain - req_qty = ls_item - menge . ls_itemdatain - ordered = ls_item - menge . ls_itemdatain - po_unit = ls_item - meins . ls_itemdatain - sales_price = ls_item - netpr_mm . ls_itemdatain - sales_unit = ls_item - meins . ls_itemdatain - currency = ls_item - waers_mm . ls_itemdatain - pur_price = ls_item - netpr_mm . ls_itemdatain - pur_currency = ls_item - waers_mm . ls_itemdatain - price_unit = ls_item - peinh_mm . ls_itemdatain - stge_loc = ls_item - lgort . INSERT ls_itemdatain INTO TABLE itemdatain . \" \u884c\u9879\u76ee\u589e\u5f3a\u7ed3\u6784 CLEAR ls_bapi_te_wbhi . ls_bapi_te_wbhi - trcont_item = ls_item - tposn . ls_bapi_te_wbhi - trcont_subitem = ls_item - tposn_sub . ls_bapi_te_wbhi - uebto_mm = ls_item - uebto_mm . ls_bapi_te_wbhi - untto_mm = ls_item - untto_mm . ls_bapi_te_wbhi - zprdcat = ls_item - zprdcat . ls_bapi_te_wbhi - zgrade = ls_item - zgrade . ls_bapi_te_wbhi - zzoland = ls_item - zoland . ls_bapi_te_wbhi - zfactory = ls_item - zfactory . ls_bapi_te_wbhi - ztechstd = ls_item - ztechstd . ls_bapi_te_wbhi - zccbz = ls_item - zccbz . ls_bapi_te_wbhi - zxnyy = ls_item - zxnyy . ls_bapi_te_wbhi - zyszjh = ls_item - zyszjh . ls_bapi_te_wbhi - zysdjh = ls_item - zysdjh . ls_bapi_te_wbhi - zbgdh = ls_item - zbgdh . ls_bapi_te_wbhi - zkwh = ls_item - zkwh . ls_bapi_te_wbhi - zscrq = ls_item - zscrq . ls_bapi_te_wbhi - zzdysx1 = ls_item - zzdysx1 . ls_bapi_te_wbhi - zzdysx2 = ls_item - zzdysx2 . ls_bapi_te_wbhi - zzdysx3 = ls_item - zzdysx3 . ls_bapi_te_wbhi - zpcmark = ls_item - zpcmark . INSERT ls_bapi_te_wbhi INTO TABLE mt_bapi_te_wbhi . ENDLOOP . ENDMETHOD . METHOD set_partner . DATA ( ls_head ) = input -> ms_head . DATA ( lt_partner ) = input -> mt_partner . DATA ls_buspartyin TYPE bapitcparty . DATA lr_buspartyin TYPE REF TO bapitcparty . DATA ls_bapi_te_wbhp TYPE bapi_te_wbhp . \" \u5408\u4f5c\u4f19\u4f34\u6570\u636e LOOP AT lt_partner INTO DATA ( ls_partner ). CLEAR ls_buspartyin . ls_buspartyin - trcont_item = ls_partner - tposn . ls_buspartyin - trcont_subitem = ls_partner - tposn_sub . ls_buspartyin - partn_role = ls_partner - parvw . ls_buspartyin - partcount = ls_partner - pstlz . ls_buspartyin - vendor_no = ls_partner - lifnr . ls_buspartyin - cust_no = ls_partner - kunnr . ls_buspartyin - address = ls_partner - adrnr . INSERT ls_buspartyin INTO TABLE buspartyin . ENDLOOP . \" \u91cd\u590d\u4ee3\u7801 \" &1: \u5408\u4f5c\u4f19\u4f34\u89d2\u8272 \" &2: \u4f9b\u5e94\u5546\u7f16\u7801 DEFINE _add_partner . IF &3 IS NOT INITIAL . READ TABLE buspartyin REFERENCE INTO lr_buspartyin WITH KEY partn_role = &2 . IF sy - subrc <> 0 . INSERT VALUE # ( partn_role = &2 ) INTO TABLE buspartyin REFERENCE INTO lr_buspartyin . ENDIF . lr_buspartyin -> &1 = &3 . ENDIF . END-OF-DEFINITION . DEFINE _add_partner_vendor . _add_partner vendor_no &1 &2 . END-OF-DEFINITION . \" \u5982\u679c\u5408\u540c\u4f19\u4f34\u4e2d\u6ca1\u8fd9\u4e9b\u5bf9\u8c61\uff0c\u5219\u6839\u636e\u62ac\u5934\u53d6\u503c _add_partner_vendor 'LF' ls_head - lifnr . _add_partner_vendor 'Z4' ls_head - lifnr2 . _add_partner_vendor 'Z1' ls_head - lifnr3 . _add_partner_vendor 'ZM' ls_head - lifnr4 . ENDMETHOD . METHOD set_condition . DATA ( ls_head ) = input -> ms_head . DATA ( lt_condition ) = input -> mt_condition . \" \u67e5\u8be2\u91c7\u8d2d\u5b9a\u4ef7\u8fc7\u7a0b SELECT SINGLE kalsk FROM lfm1 WHERE lifnr = @ ls_head - lifnr AND ekorg = @ ls_head - ekorg INTO @ DATA ( l_kalsk ). SELECT SINGLE kalsm FROM tmks WHERE kalse = '1000' AND kalsk = @ l_kalsk INTO @ DATA ( l_kalsm ). SELECT * FROM t683s WHERE kalsm = @ l_kalsm INTO TABLE @ DATA ( lt_pricing_process ). SORT lt_pricing_process BY kschl . \" \u91c7\u8d2d\uff08\u4f9b\u5e94\u5546\uff09\u5b9a\u4ef7 DATA ls_vendorcondin TYPE bapitccond . LOOP AT lt_condition INTO DATA ( ls_condition ). \" \u8865\u5168\u7f16\u7801 IF ls_condition - tposn IS INITIAL . ls_condition - tposn = sy - tabix * 10 . ENDIF . IF ls_condition - zaehk IS INITIAL . ls_condition - zaehk = '001' . ENDIF . \" \u83b7\u53d6\u6761\u4ef6\u7c7b\u578b\u5bf9\u5e94\u6761\u4ef6\u8fc7\u7a0b\u4e2d\u7684\u987a\u5e8f READ TABLE lt_pricing_process INTO DATA ( ls_pricing_process ) WITH KEY kschl = ls_condition - kschl BINARY SEARCH . IF sy - subrc <> 0 . CLEAR ls_pricing_process . ENDIF . CLEAR ls_vendorcondin . ls_vendorcondin - trcont_item = ls_condition - tposn . ls_vendorcondin - trcont_subitem = ls_condition - tposn_sub . ls_vendorcondin - cond_st_no = ls_pricing_process - stunr . ls_vendorcondin - cond_count = '001' . ls_vendorcondin - applicatio = ls_pricing_process - kappl . ls_vendorcondin - cond_type = ls_condition - kschl . ls_vendorcondin - cond_base = ls_condition - kbetr . ls_vendorcondin - currency = ls_condition - waers . ls_vendorcondin - cond_p_unt = ls_condition - kpein . ls_vendorcondin - cond_unit = ls_condition - kmein . INSERT ls_vendorcondin INTO TABLE vendorcondin . ENDLOOP . * \" \u8d39\u7528\u5b9a\u4ef7 * DATA ls_conditionkeydatain TYPE bapitcconditionkey. * DATA ls_conditionitemdatain TYPE bapitcconditionitem. * LOOP AT mt_condition INTO DATA(ls_condition). * DATA(l_order_key) = sy-tabix * 10. * * CLEAR ls_conditionkeydatain. * ls_conditionkeydatain-order_key = l_order_key. * ls_conditionkeydatain-application = 'M'. ** ls_conditionkeydatain-cond_group_no = 'G002'. * ls_conditionkeydatain-cond_type = ls_condition-kschl. * ls_conditionkeydatain-purch_org = ms_head-ekorg. * ls_conditionkeydatain-vendor = ms_head-lifnr. * INSERT ls_conditionkeydatain INTO TABLE conditionkeydatain. * * CLEAR ls_conditionitemdatain. * ls_conditionitemdatain-order_key = l_order_key. * ls_conditionitemdatain-cond_count = ls_condition-kposn. * ls_conditionitemdatain-amount = ls_condition-kbetr. * ls_conditionitemdatain-condcurr = ls_condition-waers. * ls_conditionitemdatain-cond_p_unt = ls_condition-kpein. * ls_conditionitemdatain-cond_unit = ls_condition-kmein. * INSERT ls_conditionitemdatain INTO TABLE conditionitemdatain. * ENDLOOP. ENDMETHOD . METHOD set_text . ENDMETHOD . ENDCLASS . *&---------------------------------------------------------------------* *& Class (Implementation) lcl_bapi_ctr_change *&---------------------------------------------------------------------* *& *&---------------------------------------------------------------------* CLASS lcl_bapi_ctr_change IMPLEMENTATION . METHOD lif_bapi~execute . result = me . \" \u589e\u5f3a\u5b57\u6bb5\u957f\u5ea6\u5927\u4e8e960\uff0c\u65e0\u6cd5\u4f7f\u7528extensionin\u5b57\u6bb5 \" \u56e0\u6b64\u901a\u8fc7BAPI\u589e\u5f3a\u7684\u65b9\u5f0f\uff0c\u5c06\u503c\u4f20\u5165 \" \u7531\u4e8e\u662f\u9759\u6001\u53c2\u6570\uff0c\u7b49\u4ef7\u4e8e\u5185\u5b58\u4f20\u503c\uff0c\u800c\u4e14\u66f4\u597d\u7684\u6eaf\u6e90 zcl_im__wb2_bapi_enhance_ex => set_extension ( EXPORTING bapi_te_wbhk = ms_bapi_te_wbhk t_bapi_te_wbhi = mt_bapi_te_wbhi t_bapi_te_wbhd = mt_bapi_te_wbhd t_bapi_te_wbhe = mt_bapi_te_wbhe t_bapi_te_wbhp = mt_bapi_te_wbhp bapi_te_wbhkx = ms_bapi_te_wbhkx t_bapi_te_wbhix = mt_bapi_te_wbhix t_bapi_te_wbhdx = mt_bapi_te_wbhdx t_bapi_te_wbhex = mt_bapi_te_wbhex t_bapi_te_wbhpx = mt_bapi_te_wbhpx ). headdatain - testrun = testrun . SET PARAMETER ID 'BAPIHT' FIELD 'X' . \" BAPI\u521b\u5efa\u5408\u540c\uff0c\u7528\u4e8e\u8df3\u8fc7\u90e8\u5206\u6821\u9a8c CALL FUNCTION 'BAPI_TRADINGCONTRACT_CHANGE' EXPORTING tradingcontractno = tradingcontractno headdatain = headdatain headdatainx = headdatainx IMPORTING headdataout = headdataout TABLES itemdatain = itemdatain itemdatainx = itemdatainx scheduledatain = scheduledatain scheduledatainx = scheduledatainx businessdatain = businessdatain businessdatainx = businessdatainx buspartyin = buspartyin buspartyinx = buspartyinx extensionin = extensionin headtextin = headtextin itemtextin = itemtextin itemdataout = itemdataout scheduledataout = scheduledataout businessdataout = businessdataout buspartyout = buspartyout headtextout = headtextout itemtextout = itemtextout extensionout = extensionout return = return partneraddresses = partneraddresses partnerchanges = partnerchanges vendorcondin = vendorcondin vendorcondinx = vendorcondinx customercondin = customercondin customercondinx = customercondinx conditionkeydatain = conditionkeydatain conditionkeydatainx = conditionkeydatainx conditionitemdatain = conditionitemdatain conditionitemdatainx = conditionitemdatainx conditionkeydataout = conditionkeydataout conditionitemdataout = conditionitemdataout scaledatain = scaledatain scaledataout = scaledataout vendorcondout = vendorcondout customercondout = customercondout . SET PARAMETER ID 'BAPIHT' FIELD '' . lif_bapi~document = tradingcontractno . lif_bapi~mt_bapiret2 = CORRESPONDING # ( return ). CALL FUNCTION 'Z_MESSAGE_TABLE_TO_FIELD' EXPORTING t_bapiret2 = lif_bapi~mt_bapiret2 IMPORTING status = lif_bapi~status message = lif_bapi~message . \" \u53d1\u751f\u9519\u8bef\u6216\u6d4b\u8bd5\u6267\u884c\u7684\u60c5\u51b5\uff0c\u4e0d\u63d0\u4ea4 IF lif_bapi~status = 'E' OR testrun = abap_true . CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK' . CLEAR lif_bapi~document . RETURN . ENDIF . \" \u6b63\u5f0f\u63d0\u4ea4 CALL FUNCTION 'BAPI_TRANSACTION_COMMIT' EXPORTING wait = abap_true . ENDMETHOD . METHOD set_head . \" \u83b7\u53d6\u65e7\u6570\u636e DATA ( lo_old ) = lcl_fiori_ctr_data => read ( input -> ms_head - tkonn ). DATA ( lo_new ) = input . \" \u6bd4\u8f83\u5dee\u5f02 DATA lt_compare TYPE STANDARD TABLE OF zscompare_result . CALL FUNCTION 'Z_COMPARE_STRUCTURE' EXPORTING old = lo_old -> ms_head new = lo_new -> ms_head TABLES result = lt_compare . LOOP AT lt_compare REFERENCE INTO DATA ( lr_compare ) WHERE valid = abap_true AND changed = abap_true . CASE lr_compare -> name . WHEN 'BTBSTA ' . MOVE lr_compare -> value_new TO headdatain - trcont_stat . WHEN 'WAERS ' . MOVE lr_compare -> value_new TO headdatain - trcont_currency . MOVE lr_compare -> value_new TO headdatain - currency . WHEN 'BSTKD ' . MOVE lr_compare -> value_new TO headdatain - purch_no . * WHEN 'ZZSIGN_PLATFROM'. * MOVE lr_compare->value_new TO headdatain-comp_code . * MOVE lr_compare->value_new TO headdatain-sales_org . * WHEN 'EKGRP '. * MOVE lr_compare->value_new TO headdatain-sales_grp . * WHEN 'EKORG '. * MOVE lr_compare->value_new TO headdatain-sales_off . * WHEN 'VTWEG '. * MOVE lr_compare->value_new TO headdatain-distr_chan . * WHEN 'SPART '. * MOVE lr_compare->value_new TO headdatain-division . WHEN OTHERS . ENDCASE . ENDLOOP . \" BAPIX\u7ed3\u6784\u81ea\u52a8\u6253X CALL FUNCTION 'Z_SAME_FIELD_MARK' CHANGING data = headdatain datax = headdatainx . ENDMETHOD . METHOD set_bussiness . \" \u83b7\u53d6\u65e7\u6570\u636e DATA ( lo_old ) = lcl_fiori_ctr_data => read ( input -> ms_head - tkonn ). DATA ( lo_new ) = input . \" \u6bd4\u8f83\u5dee\u5f02 DATA lt_compare TYPE STANDARD TABLE OF zscompare_result . CALL FUNCTION 'Z_COMPARE_STRUCTURE' EXPORTING old = lo_old -> ms_head new = lo_new -> ms_head TABLES result = lt_compare . DATA ls_businessdatain LIKE LINE OF businessdatain . DATA ls_businessdatainx LIKE LINE OF businessdatainx . LOOP AT lt_compare REFERENCE INTO DATA ( lr_compare ) WHERE valid = abap_true AND changed = abap_true . CASE lr_compare -> name . WHEN 'LIFNR ' . MOVE lr_compare -> value_new TO ls_businessdatain - vendor . WHEN 'ZTERM ' . MOVE lr_compare -> value_new TO ls_businessdatain - pmnttrms . WHEN 'WAERS ' . MOVE lr_compare -> value_new TO ls_businessdatain - currency . WHEN 'TKRATE_MM ' . MOVE lr_compare -> value_new TO ls_businessdatain - exch_rate_p . WHEN 'KURST_MM ' . MOVE lr_compare -> value_new TO ls_businessdatain - exchg_rate . WHEN 'TKRATE_SD ' . MOVE lr_compare -> value_new TO ls_businessdatain - exch_rate_v . WHEN 'INCO1_MM ' . MOVE lr_compare -> value_new TO ls_businessdatain - incoterms1 . WHEN 'INCO1_MM_EX' . MOVE lr_compare -> value_new TO ls_businessdatain - incoterms2 . WHEN 'INCO1_SD ' . MOVE lr_compare -> value_new TO ls_businessdatain - incoterms1_sd . WHEN 'INCO1_SD_EX' . MOVE lr_compare -> value_new TO ls_businessdatain - incoterms2_sd . * WHEN 'EKORG '. * MOVE lr_compare->value_new TO ls_businessdatain-purch_org . * WHEN 'EKGRP '. * MOVE lr_compare->value_new TO ls_businessdatain-pur_group . WHEN OTHERS . ENDCASE . ENDLOOP . \" BAPIX\u7ed3\u6784\u81ea\u52a8\u6253X CALL FUNCTION 'Z_SAME_FIELD_MARK' CHANGING data = ls_businessdatain datax = ls_businessdatainx . INSERT ls_businessdatain INTO TABLE businessdatain . INSERT ls_businessdatainx INTO TABLE businessdatainx . ENDMETHOD . METHOD set_item . \" \u83b7\u53d6\u65e7\u6570\u636e DATA ( lo_old ) = lcl_fiori_ctr_data => read ( input -> ms_head - tkonn ). DATA ( lo_new ) = input . DATA lt_compare TYPE STANDARD TABLE OF zscompare_result . DATA ls_itemdatain LIKE LINE OF itemdatain . DATA ls_itemdatainx LIKE LINE OF itemdatainx . LOOP AT lo_new -> mt_item INTO DATA ( ls_item_new ). READ TABLE lo_old -> mt_item INTO DATA ( ls_item_old ) WITH KEY tposn = ls_item_new - tposn tposn_sub = ls_item_new - tposn_sub . \" \u65b0\u589e\u884c IF sy - subrc <> 0 . ls_item_new - updateflag = 'I' . CLEAR ls_item_old . ENDIF . * \" \u65e7\u884c\u5df2\u5220\u9664\uff0c\u65b0\u589e\u4e00\u884c * IF ls_item_old-updateflag = 'D'. * ls_item_new-updateflag = 'I'. * CLEAR ls_item_old. * ENDIF. \" \u6bd4\u8f83\u5dee\u5f02 CLEAR lt_compare . CALL FUNCTION 'Z_COMPARE_STRUCTURE' EXPORTING old = ls_item_old new = ls_item_new TABLES result = lt_compare . ls_itemdatain - trcont_item = ls_item_new - tposn . ls_itemdatain - trcont_subitem = ls_item_new - tposn_sub . IF lo_old -> ms_head - zzsign_platfrom <> lo_new -> ms_head - zzsign_platfrom . ls_itemdatain - plant = lo_new -> ms_head - zzsign_platfrom . ENDIF . LOOP AT lt_compare REFERENCE INTO DATA ( lr_compare ) WHERE valid = abap_true AND changed = abap_true . CASE lr_compare -> name . WHEN 'MATNR ' . MOVE lr_compare -> value_new TO ls_itemdatain - material . WHEN 'ARKTX ' . MOVE lr_compare -> value_new TO ls_itemdatain - short_text . WHEN 'MENGE ' . MOVE lr_compare -> value_new TO ls_itemdatain - req_qty . WHEN 'MENGE ' . MOVE lr_compare -> value_new TO ls_itemdatain - ordered . WHEN 'MEINS ' . MOVE lr_compare -> value_new TO ls_itemdatain - po_unit . WHEN 'NETPR_MM' . MOVE lr_compare -> value_new TO ls_itemdatain - sales_price . WHEN 'MEINS ' . MOVE lr_compare -> value_new TO ls_itemdatain - sales_unit . WHEN 'WAERS_MM' . MOVE lr_compare -> value_new TO ls_itemdatain - currency . WHEN 'NETPR_MM' . MOVE lr_compare -> value_new TO ls_itemdatain - pur_price . WHEN 'WAERS_MM' . MOVE lr_compare -> value_new TO ls_itemdatain - pur_currency . WHEN 'PEINH_MM' . MOVE lr_compare -> value_new TO ls_itemdatain - price_unit . WHEN 'LGORT ' . MOVE lr_compare -> value_new TO ls_itemdatain - stge_loc . WHEN OTHERS . ENDCASE . ENDLOOP . \" \u81ea\u52a8\u6253X CALL FUNCTION 'Z_SAME_FIELD_MARK' CHANGING data = ls_itemdatain datax = ls_itemdatainx . ls_itemdatainx - updateflag = ls_item_new - updateflag . INSERT ls_itemdatain INTO TABLE itemdatain . INSERT ls_itemdatainx INTO TABLE itemdatainx . ENDLOOP . ENDMETHOD . METHOD set_condition . \" \u83b7\u53d6\u65e7\u6570\u636e DATA ( lo_old ) = lcl_fiori_ctr_data => read ( input -> ms_head - tkonn ). DATA ( lo_new ) = input . DATA lt_compare TYPE STANDARD TABLE OF zscompare_result . DATA ls_vendorcondin LIKE LINE OF vendorcondin . DATA ls_vendorcondinx LIKE LINE OF vendorcondinx . \" \u67e5\u8be2\u91c7\u8d2d\u5b9a\u4ef7\u8fc7\u7a0b SELECT SINGLE kalsk FROM lfm1 WHERE lifnr = @ lo_old -> ms_head - lifnr AND ekorg = @ lo_old -> ms_head - ekorg INTO @ DATA ( l_kalsk ). SELECT SINGLE kalsm FROM tmks WHERE kalse = '1000' AND kalsk = @ l_kalsk INTO @ DATA ( l_kalsm ). SELECT * FROM t683s WHERE kalsm = @ l_kalsm INTO TABLE @ DATA ( lt_pricing_process ). SORT lt_pricing_process BY kschl . \" \u91c7\u8d2d\uff08\u4f9b\u5e94\u5546\uff09\u5b9a\u4ef7 LOOP AT lo_new -> mt_condition INTO DATA ( ls_condition_new ). READ TABLE lo_old -> mt_condition INTO DATA ( ls_condition_old ) WITH KEY tposn = ls_condition_new - tposn tposn_sub = ls_condition_new - tposn_sub knumv = ls_condition_new - knumv kposn = ls_condition_new - kposn stunr = ls_condition_new - stunr zaehk = ls_condition_new - zaehk . \" \u65b0\u589e\u884c IF sy - subrc <> 0 . ls_condition_new - updateflag = 'I' . CLEAR ls_condition_new . ENDIF . ls_vendorcondin - trcont_item = ls_condition_new - tposn . ls_vendorcondin - trcont_subitem = ls_condition_new - tposn_sub . ls_vendorcondin - cond_st_no = ls_condition_new - stunr . ls_vendorcondin - cond_count = ls_condition_new - zaehk . LOOP AT lt_compare REFERENCE INTO DATA ( lr_compare ) WHERE valid = abap_true AND changed = abap_true . CASE lr_compare -> name . WHEN 'KBETR' . MOVE lr_compare -> value_new TO ls_vendorcondin - cond_base . WHEN 'WAERS' . MOVE lr_compare -> value_new TO ls_vendorcondin - currency . WHEN 'KPEIN' . MOVE lr_compare -> value_new TO ls_vendorcondin - cond_p_unt . WHEN 'KMEIN' . MOVE lr_compare -> value_new TO ls_vendorcondin - cond_unit . WHEN OTHERS . ENDCASE . ENDLOOP . CALL FUNCTION 'Z_SAME_FIELD_MARK' CHANGING data = ls_vendorcondin datax = ls_vendorcondinx . ls_vendorcondinx - updateflag = ls_condition_new - updateflag . INSERT ls_vendorcondin INTO TABLE vendorcondin . INSERT ls_vendorcondinx INTO TABLE vendorcondinx . ENDLOOP . ENDMETHOD . METHOD set_partner . \" \u83b7\u53d6\u65e7\u6570\u636e DATA ( lo_old ) = lcl_fiori_ctr_data => read ( input -> ms_head - tkonn ). DATA ( lo_new ) = input . DATA lt_compare TYPE STANDARD TABLE OF zscompare_result . DATA ls_partner_old LIKE LINE OF lo_old -> mt_partner . DATA ls_partner_new LIKE LINE OF lo_new -> mt_partner . DATA ls_buspartyin LIKE LINE OF buspartyin . DATA ls_buspartyinx LIKE LINE OF buspartyinx . \" \u5408\u4f5c\u4f19\u4f34\u6570\u636e DEFINE _to_partner . READ TABLE lo_new -> mt_partner INTO ls_partner_new WITH KEY parvw = &1 . IF sy - subrc <> 0 . ls_partner_new = VALUE # ( parvw = &1 updateflag = 'I' lifnr = lo_new -> ms_head - &2 ). ENDIF . READ TABLE lo_old -> mt_partner INTO ls_partner_old WITH KEY parvw = &1 . IF sy - subrc = 0 . ls_partner_new - updateflag = 'U' . ENDIF . END-OF-DEFINITION . \" \u5982\u679c\u5408\u540c\u4f19\u4f34\u4e2d\u6ca1\u8fd9\u4e9b\u5bf9\u8c61\uff0c\u5219\u6839\u636e\u62ac\u5934\u53d6\u503c _to_partner 'LF' lifnr . _to_partner 'Z4' lifnr2 . _to_partner 'Z1' lifnr3 . _to_partner 'ZM' lifnr4 . LOOP AT lo_new -> mt_partner INTO ls_partner_new . READ TABLE lo_old -> mt_partner INTO ls_partner_old WITH KEY tposn = ls_partner_new - tposn tposn_sub = ls_partner_new - tposn_sub parvw = ls_partner_new - parvw . \" \u65b0\u589e\u884c IF sy - subrc <> 0 . ls_partner_new - updateflag = 'I' . CLEAR ls_partner_old . ENDIF . \" \u6bd4\u8f83\u5dee\u5f02 CLEAR lt_compare . CALL FUNCTION 'Z_COMPARE_STRUCTURE' EXPORTING old = ls_partner_old new = ls_partner_new TABLES result = lt_compare . ls_buspartyin - trcont_item = ls_partner_new - tposn . ls_buspartyin - trcont_subitem = ls_partner_new - tposn_sub . ls_buspartyin - partn_role = ls_partner_new - parvw . ls_buspartyin - partcount = ls_partner_new - pstlz . LOOP AT lt_compare REFERENCE INTO DATA ( lr_compare ) WHERE valid = abap_true AND changed = abap_true . CASE lr_compare -> name . WHEN 'LIFNR ' . MOVE lr_compare -> value_new TO ls_buspartyin - vendor_no . WHEN 'KUNNR ' . MOVE lr_compare -> value_new TO ls_buspartyin - cust_no . WHEN OTHERS . ENDCASE . ENDLOOP . CALL FUNCTION 'Z_SAME_FIELD_MARK' CHANGING data = ls_buspartyin datax = ls_buspartyinx . ls_buspartyinx - updateflag = ls_partner_new - updateflag . INSERT ls_buspartyin INTO TABLE buspartyin . INSERT ls_buspartyinx INTO TABLE buspartyinx . ENDLOOP . ENDMETHOD . METHOD set_text . ENDMETHOD . ENDCLASS . *&---------------------------------------------------------------------* *& Class (Implementation) lcl_contract_service *&---------------------------------------------------------------------* *& *&---------------------------------------------------------------------* CLASS lcl_contract_service IMPLEMENTATION . METHOD create . DATA ( lo_fiori_ctr_data ) = data . DATA ( lo_bapi_ctr_create ) = NEW lcl_bapi_ctr_create ( ). lo_bapi_ctr_create -> set_head ( lo_fiori_ctr_data ). lo_bapi_ctr_create -> set_item ( lo_fiori_ctr_data ). lo_bapi_ctr_create -> set_bussiness ( lo_fiori_ctr_data ). lo_bapi_ctr_create -> set_partner ( lo_fiori_ctr_data ). lo_bapi_ctr_create -> set_condition ( lo_fiori_ctr_data ). lo_bapi_ctr_create -> set_text ( lo_fiori_ctr_data ). \" \u6267\u884c\u521b\u5efabapi DATA ( lo_bapi ) = lo_bapi_ctr_create -> lif_bapi~execute ( testrun = abap_true ). IF lo_bapi -> status <> 'E' . lo_bapi = lo_bapi -> execute ( ). ENDIF . \" \u66f4\u65b0\u4ed8\u6b3e\u4fe1\u606f IF lo_bapi -> status = 'S' . lo_fiori_ctr_data -> save_payment ( ). ENDIF . contract = lo_bapi -> document . status = lo_bapi -> status . message = lo_bapi -> message . ENDMETHOD . METHOD change . DATA ( lo_fiori_ctr_data ) = data . DATA ( lo_bapi_ctr_change ) = NEW lcl_bapi_ctr_change ( ). lo_bapi_ctr_change -> set_head ( lo_fiori_ctr_data ). lo_bapi_ctr_change -> set_item ( lo_fiori_ctr_data ). lo_bapi_ctr_change -> set_bussiness ( lo_fiori_ctr_data ). lo_bapi_ctr_change -> set_partner ( lo_fiori_ctr_data ). lo_bapi_ctr_change -> set_condition ( lo_fiori_ctr_data ). lo_bapi_ctr_change -> set_text ( lo_fiori_ctr_data ). \" \u6267\u884c\u521b\u5efabapi DATA ( lo_bapi ) = lo_bapi_ctr_change -> lif_bapi~execute ( testrun = abap_true ). IF lo_bapi -> status <> 'E' . lo_bapi = lo_bapi -> execute ( ). ENDIF . \" \u66f4\u65b0\u4ed8\u6b3e\u4fe1\u606f IF lo_bapi -> status = 'S' . lo_fiori_ctr_data -> save_payment ( ). ENDIF . contract = lo_bapi -> document . status = lo_bapi -> status . message = lo_bapi -> message . ENDMETHOD . ENDCLASS . WB2_BAPI_ENHANCE_EX \uff1a\u5408\u540c\u589e\u5f3a WB2_TC_INCOMP_LOG \uff0c\u5408\u540c\u4e0d\u5b8c\u6574\u65e5\u5fd7\u589e\u5f3a \u5408\u540c\u5173\u95ed \u00b6","title":"\u5408\u540c"},{"location":"gtm/contract/#_1","text":"\u6ce8\u610f\uff0c\u5982\u679c\u662f\u5408\u540c\u53c2\u8003\u521b\u5efa\u7684\u8ba2\u5355\uff0c\u901a\u5e38\u4f1a\u8981\u6c42\u901a\u8fc7\u5de5\u4f5c\u53f0\u5904\u7406\uff0c\u8fd9\u65f6\u9700\u8981\u5728\u4e1a\u52a1\u6267\u884c\u524d\u52a0\u5165\u4ee5\u4e0b\u4ee3\u7801\uff1a \u793a\u4f8b\u4ee3\u7801 CALL FUNCTION 'WB2_RESET_EXTERNAL_DATA' . CALL FUNCTION 'WB2_CHECK_TEW_ACTIVE' EXCEPTIONS not_active = 1 OTHERS = 2 . DATA l_tew_type TYPE wb2_tew_type . CALL FUNCTION 'WB2_TRADE_GET_INIT_DATA' IMPORTING e_tew_type = l_tew_type . CALL FUNCTION 'WB2_TEW_ACTION_SET_PARAMETER' EXPORTING i_tew_type = i_tew_type i_step = i_step i_mode = i_mode i_pre_step = i_pre_step i_catt_active = 'X' .","title":"\u8d38\u6613\u5408\u540c"},{"location":"gtm/contract/#wtew","text":"SPRO\\\u540e\u52e4\\\u5168\u7403\u8d38\u6613\u7ba1\u7406","title":"WTEW\u914d\u7f6e"},{"location":"gtm/contract/#_2","text":"\u901a\u5e38\uff0c\u6d41\u7a0b\u9996\u5148\u521b\u5efa\u8d2d\u9500\u5408\u540c\uff0c\u7136\u540e\u518d\u53c2\u8003\u8be5\u5408\u540c\uff0c\u521b\u5efa\u540e\u7eed\u7684\u91c7\u8d2d\u5408\u540c\u548c\u9500\u552e\u5408\u540c\u3002\u8fd9\u4e09\u79cd\u5408\u540c\u6309\u5408\u540c\u7c7b\u578b\u52a0\u4ee5\u533a\u5206\uff0c\u53ef\u7531\u4e1a\u52a1\u914d\u7f6e\u3002 BAPI_TRADINGCONTRACT_CREATE \uff1a\u521b\u5efa\u8d38\u6613\u5408\u540c BAPI_TRADINGCONTRACT_CHANGE \uff1a\u4fee\u6539\u8d38\u6613\u5408\u540c WB2_DELETE_TRADING_CONT_ALL \uff1a\u5408\u540c\u6279\u91cf\u5220\u9664 \u793a\u4f8b\u4ee3\u7801 *----------------------------------------------------------------------* ***INCLUDE LZGTM001P01. *----------------------------------------------------------------------* *&---------------------------------------------------------------------* *& Class (Implementation) lcl_wb2_ctr_data *&---------------------------------------------------------------------* *& *&---------------------------------------------------------------------* CLASS lcl_wb2_ctr_data IMPLEMENTATION . METHOD read . IF contract_id IS SUPPLIED AND m_contract <> contract_id . m_contract = contract_id . mo_instance = NEW # ( ). DATA l_tkonn TYPE komwbhk - tkonn . DATA ls_t180 TYPE t180 . l_tkonn = contract_id . ls_t180 = VALUE # ( trtyp = 'A' ). CALL FUNCTION 'WB2_CONTRACT_READ' EXPORTING i_tkonn = l_tkonn i_t180 = ls_t180 IMPORTING e_komwbhk = mo_instance -> ms_komwbhk TABLES t_komwbhk = mo_instance -> mt_komwbhk t_komwbhi = mo_instance -> mt_komwbhi t_komwbhd = mo_instance -> mt_komwbhd t_komwbhe = mo_instance -> mt_komwbhe t_komwbhp = mo_instance -> mt_komwbhp EXCEPTIONS application_data_error = 1 lock_error = 2 customizing_error = 3 OTHERS = 4 . IF sy - subrc <> 0 . * Implement suitable error handling here ENDIF . ENDIF . \" \u81f3\u5c11\u4fdd\u8bc1\u4e0ddump IF mo_instance IS NOT BOUND . mo_instance = NEW # ( ). ENDIF . result = mo_instance . ENDMETHOD . METHOD get_fiori_head . \" \u62ac\u5934 result - tkonn = ms_komwbhk - tkonn . result - tkonn_ex = ms_komwbhk - tkonn_ex . result - tew_type = ms_komwbhk - tew_type . result - zframe_tkonn = ms_komwbhk - zframe_tkonn . result - zzsign_platfrom = ms_komwbhk - vkorg . result - vtweg = ms_komwbhk - vtweg . result - spart = ms_komwbhk - spart . result - zzsndat = ms_komwbhk - zzsndat . result - btbsta = ms_komwbhk - btbsta . result - zprictp = ms_komwbhk - zprictp . result - zzlsch_mm = ms_komwbhk - zzlsch_mm . result - zzlsch_mm_ex = ms_komwbhk - zzlsch_txt_mm_n . result - zzlsch_sd = ms_komwbhk - zzlsch_sd . result - zzlsch_sd_ex = ms_komwbhk - zzlsch_txt_sd_n . result - zzrpdate_end = ms_komwbhk - zzrpdate_end . result - zzamt01_mm = ms_komwbhk - zzamt01_mm . result - zzcur01_mm = ms_komwbhk - zzcur01_mm . result - zzpcode_src = ms_komwbhk - zzpcode_src . result - zzland1_src = ms_komwbhk - zzland1_src . result - zzpname_src = ms_komwbhk - zzpname_src . result - zzpcode_des = ms_komwbhk - zzpcode_des . result - zzland1_des = ms_komwbhk - zzland1_des . result - zzpname_des = ms_komwbhk - zzpname_des . result - zzpcode_tra = ms_komwbhk - zzpcode_tra . result - zzland1_tra = ms_komwbhk - zzland1_tra . result - zzpname_tra = ms_komwbhk - zzpname_tra . result - zzis_preins = ms_komwbhk - zzis_preins . result - zzreceived_data_last = |{ ms_komwbhk - zzzcdh_date DATE = RAW }|. result - zzlaycan_from = ms_komwbhk - zzlaycanq . result - zzlaycan_to = ms_komwbhk - zzlaycanz . result - tctyp = ms_komwbhk - tctyp . result - zzbusst = ms_komwbhk - zzbusst . result - zzsnfile = ms_komwbhk - zzsnfile . result - zzsnflg = ms_komwbhk - zzsnflg . result - zzwd_tcdoc_flg = ms_komwbhk - zzwd_tcdoc_flg . result - zzyqd = ms_komwbhk - zzyqd . result - zzstpga_flg = ms_komwbhk - zzstpga_flg . result - zzgmyw_flg = ms_komwbhk - zzgmyw_flg . result - zzflexible = ms_komwbhk - zzflexible . result - zzwtcgp = ms_komwbhk - zzwtcgp . result - zzwtcgp_rt = ms_komwbhk - zzwtcgp_rt . result - guarantee_f = ms_komwbhk - guarantee_f . result - ciq_lastdt = ms_komwbhk - ciq_lastdt . result - consnno = ms_komwbhk - consnno . result - remark1_p = ms_komwbhk - remark1_p . result - remark2_p = ms_komwbhk - remark2_p . result - remark3_p = ms_komwbhk - remark3_p . result - zzwtc_fvdate = ms_komwbhk - zzwtc_fvdate . result - zzwtc_fvtime = ms_komwbhk - zzwtc_fvtime . result - zzwtc_fvapper = ms_komwbhk - zzwtc_fvapper . result - zzefeupt_date = ms_komwbhk - zzefeupt_date . result - zzpreclo_date = ms_komwbhk - zzpreclo_date . result - zznatclo_date = ms_komwbhk - zznatclo_date . \" \u62ac\u59342 LOOP AT mt_komwbhd REFERENCE INTO DATA ( lr_komwbhd ). result - bstkd = lr_komwbhd -> bstkd . result - waers = lr_komwbhd -> waers_purch . result - tkrate_mm = lr_komwbhd -> tkrate_mm . result - kurst_mm = lr_komwbhd -> kurst_mm . result - ekorg = lr_komwbhd -> ekorg . result - ekgrp = lr_komwbhd -> ekgrp . result - inco1_mm = lr_komwbhd -> inco1_mm . result - inco1_mm_ex = lr_komwbhd -> inco2_l_mm . result - inco1_sd = lr_komwbhd -> inco1_sd . result - inco1_sd_ex = lr_komwbhd -> inco2_l_sd . result - zterm = lr_komwbhd -> zterm . result - zzshipping_data_last = lr_komwbhd -> edatu_vbak . result - zzreceived_data_last = lr_komwbhd -> eindt . EXIT . ENDLOOP . \" \u62ac\u5934\u91d1\u989d\u6c47\u603b LOOP AT mt_komwbhi REFERENCE INTO DATA ( lr_komwbhi ). result - zamount_sum = result - zamount_sum + lr_komwbhi -> netpr_mm * lr_komwbhi -> menge . result - zcurrency_sum = lr_komwbhi -> waers_mm . ENDLOOP . \" \u62ac\u59343 LOOP AT mt_komwbhp REFERENCE INTO DATA ( lr_komwbhp ). CASE lr_komwbhp -> parvw . WHEN 'LF' OR 'VN' . result - lifnr = lr_komwbhp -> lifnr . WHEN 'RS' OR 'PI' . WHEN 'Z4' . result - lifnr2 = lr_komwbhp -> lifnr . WHEN 'Z1' . result - lifnr3 = lr_komwbhp -> lifnr . WHEN 'ER' OR 'ZM' . result - lifnr4 = lr_komwbhp -> lifnr . WHEN 'SP' OR 'AG' . WHEN 'WE' OR 'SH' . WHEN OTHERS . ENDCASE . ENDLOOP . ENDMETHOD . METHOD get_fiori_partner . DATA ls_partner LIKE LINE OF result . LOOP AT mt_komwbhp REFERENCE INTO DATA ( lr_komwbhp ). CLEAR ls_partner . ls_partner - tkonn = lr_komwbhp -> tkonn . ls_partner - tposn = lr_komwbhp -> tposn . ls_partner - tposn_sub = lr_komwbhp -> tposn_sub . ls_partner - parvw = lr_komwbhp -> parvw . ls_partner - lifnr = lr_komwbhp -> lifnr . ls_partner - kunnr = lr_komwbhp -> kunnr . ls_partner - adrnr = lr_komwbhp -> adrnr . ls_partner - land = lr_komwbhp -> land . ls_partner - pstlz = lr_komwbhp -> pstlz . ls_partner - regio = lr_komwbhp -> regio . ls_partner - ort01 = lr_komwbhp -> ort01 . ls_partner - name1 = lr_komwbhp -> name1 . INSERT ls_partner INTO TABLE result . ENDLOOP . ENDMETHOD . METHOD get_fiori_item . DATA ls_item LIKE LINE OF result . LOOP AT mt_komwbhi REFERENCE INTO DATA ( lr_komwbhi ). CLEAR ls_item . ls_item - tkonn = lr_komwbhi -> tkonn . ls_item - tposn = lr_komwbhi -> tposn . ls_item - tposn_sub = lr_komwbhi -> tposn_sub . ls_item - matnr = lr_komwbhi -> matnr . ls_item - arktx = lr_komwbhi -> arktx . ls_item - menge = lr_komwbhi -> menge . ls_item - meins = lr_komwbhi -> meins . ls_item - uebto_mm = lr_komwbhi -> uebto_mm . ls_item - untto_mm = lr_komwbhi -> untto_mm . ls_item - netpr_mm = lr_komwbhi -> netpr_mm . ls_item - peinh_mm = lr_komwbhi -> peinh_mm . ls_item - waers_mm = lr_komwbhi -> waers_mm . ls_item - zzsubtotal = ls_item - netpr_mm * ls_item - menge . * ls_item-zzunit_price = lr_komwbhi->zzunit_price. ls_item - lgort = lr_komwbhi -> lgort . ls_item - zpcmark = lr_komwbhi -> zpcmark . \" \u7279\u6027\u53d6\u503c DATA allocvaluesnum TYPE STANDARD TABLE OF bapi1003_alloc_values_num . DATA allocvalueschar TYPE STANDARD TABLE OF bapi1003_alloc_values_char . DATA allocvaluescurr TYPE STANDARD TABLE OF bapi1003_alloc_values_curr . DATA return TYPE STANDARD TABLE OF bapiret2 . CLEAR allocvaluesnum . CLEAR allocvalueschar . CLEAR allocvaluescurr . CLEAR return . CALL FUNCTION 'BAPI_OBJCL_GETDETAIL' EXPORTING objectkey = CONV bapi1003_key - object ( ls_item - matnr ) objecttable = 'MARA' classnum = 'C_01' classtype = '023' TABLES allocvaluesnum = allocvaluesnum allocvalueschar = allocvalueschar allocvaluescurr = allocvaluescurr return = return . LOOP AT allocvalueschar REFERENCE INTO DATA ( lr_allocvalueschar ). CASE lr_allocvalueschar -> charact . WHEN 'B_0001' . \" \u9884\u7b97\u53f7 WHEN 'B_0002' . \" \u5916\u90e8\u5408\u540c\u53f7 WHEN 'B_0003' . \" \u91c7\u8d2d\u8ba2\u5355\u53f7 WHEN 'B_0004' . \" \u91c7\u8d2d\u8ba2\u5355\u7c7b\u578b WHEN 'B_0005' . \" \u4e1a\u52a1\u5f62\u5f0f WHEN 'B_0006' . \" \u91c7\u8d2d\u7ec4 WHEN 'B_0007' . \" \u4e1a\u52a1\u5458 WHEN 'B_0008' . \" \u5165\u5e93\u65f6\u95f4 WHEN 'B_0009' . \" \u89c4\u683c\u5c5e\u60271 WHEN 'B_0010' . \" \u89c4\u683c\u5c5e\u60272 WHEN 'B_0011' . \" \u4ea7\u54c1\u79cd\u7c7b/\u6750\u8d28 ls_item - zprdcat = lr_allocvalueschar -> value_char . WHEN 'B_0012' . \" \u5546\u54c1\u7b49\u7ea7 ls_item - zoland = lr_allocvalueschar -> value_char . WHEN 'B_0013' . \" \u5382\u5bb6/\u54c1\u724c ls_item - zfactory = lr_allocvalueschar -> value_char . WHEN 'B_0014' . \" \u5de5\u827a/\u6280\u672f\u6807\u51c6 ls_item - ztechstd = lr_allocvalueschar -> value_char . WHEN 'B_0015' . \" \u578b\u53f7/\u7b49\u7ea7 ls_item - zprdcat = lr_allocvalueschar -> value_char . WHEN 'B_0016' . \" \u5907\u6ce8 WHEN 'B_0018' . \" \u5c3a\u5bf8/\u5305\u88c5 ls_item - zccbz = lr_allocvalueschar -> value_char . WHEN 'B_0019' . \" \u8fd0\u8f93\u8f7d\u5177\u53f7 ls_item - zyszjh = lr_allocvalueschar -> value_char . WHEN 'B_0020' . \" \u8fd0\u8f93\u65b9\u5f0f WHEN 'B_0021' . \" \u91c7\u8d2d\u8ba2\u5355\u884c\u9879\u76ee WHEN 'B_0030' . \" \u7b2c\u4e8c\u8ba1\u91cf\u5355\u4f4d WHEN 'B_0031' . \" \u7b2c\u4e8c\u5355\u4f4d\u8f6c\u6362\u7cfb\u6570 WHEN 'B_0032' . \" \u7b2c\u4e8c\u5355\u4f4d\u53ef\u53d8\u53c2\u6570 WHEN 'B_0017' . \" \u539f\u4ea7\u5730 WHEN 'B_0022' . \" \u6027\u80fd/\u7528\u9014 WHEN 'B_0023' . \" \u8fd0\u8f93\u5355\u636e\u53f7 ls_item - zysdjh = lr_allocvalueschar -> value_char . WHEN 'B_0024' . \" \u62a5\u5173\u5355\u53f7 ls_item - zbgdh = lr_allocvalueschar -> value_char . WHEN 'B_0025' . \" \u5e93\u4f4d\uff08\u533a\uff09\u53f7 ls_item - zkwh = lr_allocvalueschar -> value_char . WHEN 'B_0026' . \" \u751f\u4ea7\u65e5\u671f ls_item - zscrq = lr_allocvalueschar -> value_char . WHEN 'B_0027' . \" \u81ea\u5b9a\u4e49\u5c5e\u60271 ls_item - zzdysx1 = lr_allocvalueschar -> value_char . WHEN 'B_0028' . \" \u81ea\u5b9a\u4e49\u5c5e\u60272 ls_item - zzdysx2 = lr_allocvalueschar -> value_char . WHEN 'B_0029' . \" \u81ea\u5b9a\u4e49\u5c5e\u60273 ls_item - zzdysx3 = lr_allocvalueschar -> value_char . WHEN OTHERS . ENDCASE . ENDLOOP . INSERT ls_item INTO TABLE result . ENDLOOP . ENDMETHOD . METHOD get_fiori_condition . DATA ls_condition LIKE LINE OF result . \" \u5b9a\u4ef7 DATA ( lt_komwbhd ) = mt_komwbhd . IF ms_komwbhk - knumv_sd IS NOT INITIAL . INSERT VALUE # ( knumv_mm = ms_komwbhk - knumv_sd ) INTO TABLE lt_komwbhd . ENDIF . LOOP AT lt_komwbhd REFERENCE INTO DATA ( lr_komwbhd ). SELECT SINGLE knumv , kposn , stunr , zaehk , kschl , kbetr , waers , kpein , kmein , kwert FROM prcd_elements WHERE knumv = @ lr_komwbhd -> knumv_mm INTO @ DATA ( ls_prcd_elements ). IF sy - subrc <> 0 . CONTINUE . ENDIF . CLEAR ls_condition . ls_condition - tkonn = lr_komwbhd -> tkonn . ls_condition - tposn = lr_komwbhd -> tposn . ls_condition - tposn_sub = lr_komwbhd -> tposn_sub . ls_condition - knumv = ls_prcd_elements - knumv . ls_condition - kposn = ls_prcd_elements - kposn . ls_condition - stunr = ls_prcd_elements - stunr . ls_condition - zaehk = ls_prcd_elements - zaehk . ls_condition - kschl = ls_prcd_elements - kschl . * LS_CONDITION-kschl_text = ls_prcd_elements-kschl_text . * LS_CONDITION-zzto_cost = ls_prcd_elements-zzto_cost . ls_condition - kbetr = ls_prcd_elements - kbetr . ls_condition - waers = ls_prcd_elements - waers . ls_condition - kpein = ls_prcd_elements - kpein . ls_condition - kmein = ls_prcd_elements - kmein . * LS_CONDITION-zzconvertion = ls_prcd_elements-zzconvertion. ls_condition - kwert = ls_prcd_elements - kwert . INSERT ls_condition INTO TABLE result . ENDLOOP . ENDMETHOD . METHOD get_fiori_related . ENDMETHOD . METHOD get_fiori_text . ENDMETHOD . ENDCLASS . *&---------------------------------------------------------------------* *& Class (Implementation) lcl_fiori_ctr_data *&---------------------------------------------------------------------* *& *&---------------------------------------------------------------------* CLASS lcl_fiori_ctr_data IMPLEMENTATION . METHOD read . IF contract_id IS SUPPLIED AND m_contract <> contract_id . m_contract = contract_id . mo_instance = NEW # ( ). DATA ( lo_wb2_ctr_data ) = lcl_wb2_ctr_data => read ( m_contract ). mo_instance -> ms_head = lo_wb2_ctr_data -> get_fiori_head ( ). mo_instance -> mt_partner = lo_wb2_ctr_data -> get_fiori_partner ( ). mo_instance -> mt_item = lo_wb2_ctr_data -> get_fiori_item ( ). mo_instance -> mt_condition = lo_wb2_ctr_data -> get_fiori_condition ( ). mo_instance -> mt_related = lo_wb2_ctr_data -> get_fiori_related ( ). mo_instance -> mt_text = lo_wb2_ctr_data -> get_fiori_text ( ). mo_instance -> mt_payment = mo_instance -> read_payment ( ). ENDIF . \" \u81f3\u5c11\u4fdd\u8bc1\u4e0ddump IF mo_instance IS NOT BOUND . mo_instance = NEW # ( ). ENDIF . result = mo_instance . ENDMETHOD . METHOD save_payment . DATA lt_zttcpt TYPE STANDARD TABLE OF zttcpt WITH EMPTY KEY . DATA ls_zttcpt TYPE zttcpt . LOOP AT mt_payment REFERENCE INTO DATA ( lr_payment ). CLEAR ls_zttcpt . ls_zttcpt - tkonn = m_contract . ls_zttcpt - zzxh = sy - tabix . ls_zttcpt - zzfktj = lr_payment -> zzterm . ls_zttcpt - zzsfkrq = lr_payment -> zzdate_last . ls_zttcpt - zzysfkje = lr_payment -> zzamount . ls_zttcpt - zwaers_purch = lr_payment -> zzcurrency . ls_zttcpt - zzsfk_remark = lr_payment -> zzpay_ex . INSERT ls_zttcpt INTO TABLE lt_zttcpt . ENDLOOP . DELETE FROM zttcpt WHERE tkonn = ms_head - tkonn . MODIFY zttcpt FROM TABLE lt_zttcpt . COMMIT WORK AND WAIT . ENDMETHOD . METHOD read_payment . DATA ( l_tkonn ) = contract_id . IF contract_id IS NOT SUPPLIED . l_tkonn = ms_head - tkonn . ENDIF . SELECT tkonn , zzxh , zzfktj AS zzterm , CAST ( zzsfkrq AS CHAR ( 10 ) ) AS zzdate_last , zzysfkje AS zzamount , zwaers_purch AS zzcurrency , zzsfk_remark AS zzpay_ex FROM zttcpt WHERE tkonn = @ l_tkonn INTO CORRESPONDING FIELDS OF TABLE @ mt_payment . result = mt_payment . ENDMETHOD . ENDCLASS . *&---------------------------------------------------------------------* *& Class (Implementation) lcl_bapi_ctr_create *&---------------------------------------------------------------------* *& *&---------------------------------------------------------------------* CLASS lcl_bapi_ctr_create IMPLEMENTATION . METHOD lif_bapi~execute . result = me . \" \u589e\u5f3a\u5b57\u6bb5\u957f\u5ea6\u5927\u4e8e960\uff0c\u65e0\u6cd5\u4f7f\u7528extensionin\u5b57\u6bb5 \" \u56e0\u6b64\u901a\u8fc7BAPI\u589e\u5f3a\u7684\u65b9\u5f0f\uff0c\u5c06\u503c\u4f20\u5165 \" \u7531\u4e8e\u662f\u9759\u6001\u53c2\u6570\uff0c\u7b49\u4ef7\u4e8e\u5185\u5b58\u4f20\u503c\uff0c\u800c\u4e14\u66f4\u597d\u7684\u6eaf\u6e90 zcl_im__wb2_bapi_enhance_ex => set_extension ( EXPORTING bapi_te_wbhk = ms_bapi_te_wbhk t_bapi_te_wbhi = mt_bapi_te_wbhi t_bapi_te_wbhd = mt_bapi_te_wbhd t_bapi_te_wbhe = mt_bapi_te_wbhe t_bapi_te_wbhp = mt_bapi_te_wbhp bapi_te_wbhkx = ms_bapi_te_wbhkx t_bapi_te_wbhix = mt_bapi_te_wbhix t_bapi_te_wbhdx = mt_bapi_te_wbhdx t_bapi_te_wbhex = mt_bapi_te_wbhex t_bapi_te_wbhpx = mt_bapi_te_wbhpx ). headdatain - testrun = testrun . SET PARAMETER ID 'BAPIHT' FIELD 'X' . \" BAPI\u521b\u5efa\u5408\u540c\uff0c\u7528\u4e8e\u8df3\u8fc7\u90e8\u5206\u6821\u9a8c CALL FUNCTION 'BAPI_TRADINGCONTRACT_CREATE' EXPORTING headdatain = headdatain IMPORTING headdataout = headdataout tradingcontractno = tradingcontractno TABLES itemdatain = itemdatain scheduledatain = scheduledatain businessdatain = businessdatain buspartyin = buspartyin extensionin = extensionin headtextin = headtextin itemtextin = itemtextin itemdataout = itemdataout scheduledataout = scheduledataout businessdataout = businessdataout buspartyout = buspartyout headtextout = headtextout itemtextout = itemtextout extensionout = extensionout return = return partneraddresses = partneraddresses vendorcondin = vendorcondin customercondin = customercondin conditionkeydatain = conditionkeydatain conditionkeydatainx = conditionkeydatainx conditionitemdatain = conditionitemdatain conditionitemdatainx = conditionitemdatainx conditionkeydataout = conditionkeydataout conditionitemdataout = conditionitemdataout scaledatain = scaledatain scaledataout = scaledataout vendorcondout = vendorcondout customercondout = customercondout . SET PARAMETER ID 'BAPIHT' FIELD '' . lif_bapi~document = tradingcontractno . lif_bapi~mt_bapiret2 = CORRESPONDING # ( return ). CALL FUNCTION 'Z_MESSAGE_TABLE_TO_FIELD' EXPORTING t_bapiret2 = lif_bapi~mt_bapiret2 IMPORTING status = lif_bapi~status message = lif_bapi~message . \" \u53d1\u751f\u9519\u8bef\u6216\u6d4b\u8bd5\u6267\u884c\u7684\u60c5\u51b5\uff0c\u4e0d\u63d0\u4ea4 IF lif_bapi~status = 'E' OR testrun = abap_true . CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK' . CLEAR lif_bapi~document . RETURN . ENDIF . \" \u6b63\u5f0f\u63d0\u4ea4 CALL FUNCTION 'BAPI_TRANSACTION_COMMIT' EXPORTING wait = abap_true . ENDMETHOD . METHOD set_head . DATA ( ls_head ) = input -> ms_head . \" \u62ac\u5934\u6570\u636e headdatain - tkonn_ex = ls_head - tkonn_ex . headdatain - trcont_type = ls_head - tctyp . headdatain - tew_type = ls_head - tew_type . headdatain - trcont_stat = ls_head - btbsta . headdatain - trcont_currency = ls_head - waers . headdatain - currency = ls_head - waers . headdatain - purch_no = ls_head - bstkd . headdatain - comp_code = ls_head - zzsign_platfrom . headdatain - sales_grp = ls_head - ekgrp . headdatain - sales_off = ls_head - ekorg . headdatain - sales_org = ls_head - zzsign_platfrom . headdatain - distr_chan = ls_head - vtweg . headdatain - division = ls_head - spart . IF headdatain - tew_type IS INITIAL . headdatain - tew_type = 'Z001' . ENDIF . IF headdatain - distr_chan IS INITIAL . headdatain - distr_chan = '10' . ENDIF . IF headdatain - division IS INITIAL . headdatain - division = '11' . ENDIF . \" \u62ac\u5934\u6570\u636e\u6269\u5c55\u5b57\u6bb5 ms_bapi_te_wbhk - vkgrp = ls_head - ekgrp . ms_bapi_te_wbhk - vkbur = ls_head - ekorg . ms_bapi_te_wbhk - tkonn_ex = ls_head - tkonn_ex . ms_bapi_te_wbhk - guarantee_f = ls_head - guarantee_f . ms_bapi_te_wbhk - ciq_lastdt = ls_head - ciq_lastdt . ms_bapi_te_wbhk - consnno = ls_head - consnno . ms_bapi_te_wbhk - zframe_tkonn = ls_head - zframe_tkonn . ms_bapi_te_wbhk - zzsndat = ls_head - zzsndat . ms_bapi_te_wbhk - zprictp = ls_head - zprictp . ms_bapi_te_wbhk - zzlsch_mm = ls_head - zzlsch_mm . ms_bapi_te_wbhk - zzlsch_txt_mm_n = ls_head - zzlsch_mm_ex . ms_bapi_te_wbhk - zzlsch_sd = ls_head - zzlsch_sd . ms_bapi_te_wbhk - zzlsch_txt_sd_n = ls_head - zzlsch_sd_ex . ms_bapi_te_wbhk - zzrpdate_end = ls_head - zzrpdate_end . * ms_bapi_te_wbhk-zzrpdate_end_ex = ls_head-zzrpdate_end_ex . ms_bapi_te_wbhk - zzamt01_mm = ls_head - zzamt01_mm . ms_bapi_te_wbhk - zzcur01_mm = ls_head - zzcur01_mm . * ms_bapi_te_wbhk-zzamt01_mm_ex = ls_head-zzamt01_mm_ex . ms_bapi_te_wbhk - zzpcode_src = ls_head - zzpcode_src . ms_bapi_te_wbhk - zzland1_src = ls_head - zzland1_src . ms_bapi_te_wbhk - zzpname_src = ls_head - zzpname_src . ms_bapi_te_wbhk - zzpcode_des = ls_head - zzpcode_des . ms_bapi_te_wbhk - zzland1_des = ls_head - zzland1_des . ms_bapi_te_wbhk - zzpname_des = ls_head - zzpname_des . ms_bapi_te_wbhk - zzpcode_tra = ls_head - zzpcode_tra . ms_bapi_te_wbhk - zzland1_tra = ls_head - zzland1_tra . ms_bapi_te_wbhk - zzpname_tra = ls_head - zzpname_tra . ms_bapi_te_wbhk - zzis_preins = ls_head - zzis_preins . ms_bapi_te_wbhk - zzzcdh_date = ls_head - zzreceived_data_last . ms_bapi_te_wbhk - zzlaycanq = ls_head - zzlaycan_from . ms_bapi_te_wbhk - zzlaycanz = ls_head - zzlaycan_to . * ms_bapi_te_wbhk-zzlogistics_ex = ls_head-zzlogistics_ex . ms_bapi_te_wbhk - zzbusst = ls_head - zzbusst . ms_bapi_te_wbhk - zzsnfile = ls_head - zzsnfile . ms_bapi_te_wbhk - zzsnflg = ls_head - zzsnflg . ms_bapi_te_wbhk - zzwd_tcdoc_flg = ls_head - zzwd_tcdoc_flg . ms_bapi_te_wbhk - zzyqd = ls_head - zzyqd . ms_bapi_te_wbhk - zzstpga_flg = ls_head - zzstpga_flg . ms_bapi_te_wbhk - zzgmyw_flg = ls_head - zzgmyw_flg . ms_bapi_te_wbhk - zzflexible = ls_head - zzflexible . ms_bapi_te_wbhk - zzwtcgp = ls_head - zzwtcgp . ms_bapi_te_wbhk - zzwtcgp_rt = ls_head - zzwtcgp_rt . * ms_bapi_te_wbhk-zzwtcgp_rt_ex = ls_head-zzwtcgp_rt_ex . * ms_bapi_te_wbhk-zztext1 = ls_head-zztext1 . * ms_bapi_te_wbhk-zztext2 = ls_head-zztext2 . ms_bapi_te_wbhk - zzwtc_fvdate = ls_head - zzwtc_fvdate . ms_bapi_te_wbhk - zzwtc_fvtime = ls_head - zzwtc_fvtime . ms_bapi_te_wbhk - zzwtc_fvapper = ls_head - zzwtc_fvapper . ms_bapi_te_wbhk - zzefeupt_date = ls_head - zzefeupt_date . ms_bapi_te_wbhk - zzefeupt_time = ls_head - zzefeupt_time . ms_bapi_te_wbhk - zzefeupt_name = ls_head - zzefeupt_apper . ms_bapi_te_wbhk - zzpreclo_date = ls_head - zzpreclo_date . ms_bapi_te_wbhk - zzpreclo_time = ls_head - zzpreclo_time . ms_bapi_te_wbhk - zzpreclo_name = ls_head - zzpreclo_apper . ms_bapi_te_wbhk - zznatclo_date = ls_head - zznatclo_date . ms_bapi_te_wbhk - zznatclo_time = ls_head - zznatclo_time . ms_bapi_te_wbhk - zznatclo_name = ls_head - zznatclo_apper . ms_bapi_te_wbhk - zzfdclo_date = ls_head - zzcancel_date . ms_bapi_te_wbhk - zzfdclo_time = ls_head - zzcancel_time . ms_bapi_te_wbhk - zzfdclo_name = ls_head - zzcancel_apper . * ms_bapi_te_wbhk-zzfield1 = ls_head-zzfield1 . * ms_bapi_te_wbhk-zzfield2 = ls_head-zzfield2 . * ms_bapi_te_wbhk-zzfield3 = ls_head-zzfield3 . * ms_bapi_te_wbhk-zzfield4 = ls_head-zzfield4 . * ms_bapi_te_wbhk-zzfield5 = ls_head-zzfield5 . * ms_bapi_te_wbhk-zzfield6 = ls_head-zzfield6 . * ms_bapi_te_wbhk-zzfield7 = ls_head-zzfield7 . * ms_bapi_te_wbhk-zzfield8 = ls_head-zzfield8 . * ms_bapi_te_wbhk-zzfield9 = ls_head-zzfield9 . ENDMETHOD . METHOD set_bussiness . DATA ( ls_head ) = input -> ms_head . \" \u4e1a\u52a1\u6570\u636e\u9996\u884c\u662f\u62ac\u5934\u7528\u7684 DATA ls_businessdatain TYPE bapitcbus . CLEAR ls_businessdatain . ls_businessdatain - vendor = ls_head - lifnr . ls_businessdatain - pmnttrms = ls_head - zterm . ls_businessdatain - currency = ls_head - waers . ls_businessdatain - exch_rate_p = ls_head - tkrate_mm . ls_businessdatain - exchg_rate = ls_head - kurst_mm . ls_businessdatain - exch_rate_v = ls_head - tkrate_sd . * ls_businessdatain-kurst_sd = ls_head-kurst_sd . ls_businessdatain - incoterms1 = ls_head - inco1_mm . ls_businessdatain - incoterms2 = ls_head - inco1_mm_ex . ls_businessdatain - incoterms1_sd = ls_head - inco1_sd . ls_businessdatain - incoterms2_sd = ls_head - inco1_sd_ex . ls_businessdatain - purch_org = ls_head - ekorg . ls_businessdatain - pur_group = ls_head - ekgrp . INSERT ls_businessdatain INTO TABLE businessdatain . \" \u65e5\u671f\u5904\u7406 DEFINE _clean_date . REPLACE ALL OCCURRENCES OF '[^0-9]' IN &1 WITH '' . IF &1 IS INITIAL . &1 = '00000000' . ENDIF . END-OF-DEFINITION . _clean_date ls_head - zzshipping_data_last . _clean_date ls_head - zzreceived_data_last . \" \u884c\u9879\u76ee\u589e\u5f3a\u7ed3\u6784 DATA ls_bapi_te_wbhd TYPE bapi_te_wbhd . CLEAR ls_bapi_te_wbhd . ls_bapi_te_wbhd - bstdk = ls_head - bstkd . ls_bapi_te_wbhd - edatu_vbak = ls_head - zzshipping_data_last . ls_bapi_te_wbhd - eindt = ls_head - zzreceived_data_last . INSERT ls_bapi_te_wbhd INTO TABLE mt_bapi_te_wbhd . ENDMETHOD . METHOD set_item . DATA ( ls_head ) = input -> ms_head . DATA ( lt_item ) = input -> mt_item . DATA ls_itemdatain TYPE bapitcitem . DATA ls_bapi_te_wbhi TYPE bapi_te_wbhi . \" \u884c\u9879\u76ee LOOP AT lt_item INTO DATA ( ls_item ). IF ls_item - tposn IS INITIAL . ls_item - tposn = sy - tabix * 10 . ENDIF . CLEAR ls_itemdatain . ls_itemdatain - trcont_item = ls_item - tposn . ls_itemdatain - trcont_subitem = ls_item - tposn_sub . ls_itemdatain - plant = ls_head - zzsign_platfrom . ls_itemdatain - material = ls_item - matnr . ls_itemdatain - material_long = ls_item - matnr . ls_itemdatain - short_text = ls_item - arktx . ls_itemdatain - req_qty = ls_item - menge . ls_itemdatain - ordered = ls_item - menge . ls_itemdatain - po_unit = ls_item - meins . ls_itemdatain - sales_price = ls_item - netpr_mm . ls_itemdatain - sales_unit = ls_item - meins . ls_itemdatain - currency = ls_item - waers_mm . ls_itemdatain - pur_price = ls_item - netpr_mm . ls_itemdatain - pur_currency = ls_item - waers_mm . ls_itemdatain - price_unit = ls_item - peinh_mm . ls_itemdatain - stge_loc = ls_item - lgort . INSERT ls_itemdatain INTO TABLE itemdatain . \" \u884c\u9879\u76ee\u589e\u5f3a\u7ed3\u6784 CLEAR ls_bapi_te_wbhi . ls_bapi_te_wbhi - trcont_item = ls_item - tposn . ls_bapi_te_wbhi - trcont_subitem = ls_item - tposn_sub . ls_bapi_te_wbhi - uebto_mm = ls_item - uebto_mm . ls_bapi_te_wbhi - untto_mm = ls_item - untto_mm . ls_bapi_te_wbhi - zprdcat = ls_item - zprdcat . ls_bapi_te_wbhi - zgrade = ls_item - zgrade . ls_bapi_te_wbhi - zzoland = ls_item - zoland . ls_bapi_te_wbhi - zfactory = ls_item - zfactory . ls_bapi_te_wbhi - ztechstd = ls_item - ztechstd . ls_bapi_te_wbhi - zccbz = ls_item - zccbz . ls_bapi_te_wbhi - zxnyy = ls_item - zxnyy . ls_bapi_te_wbhi - zyszjh = ls_item - zyszjh . ls_bapi_te_wbhi - zysdjh = ls_item - zysdjh . ls_bapi_te_wbhi - zbgdh = ls_item - zbgdh . ls_bapi_te_wbhi - zkwh = ls_item - zkwh . ls_bapi_te_wbhi - zscrq = ls_item - zscrq . ls_bapi_te_wbhi - zzdysx1 = ls_item - zzdysx1 . ls_bapi_te_wbhi - zzdysx2 = ls_item - zzdysx2 . ls_bapi_te_wbhi - zzdysx3 = ls_item - zzdysx3 . ls_bapi_te_wbhi - zpcmark = ls_item - zpcmark . INSERT ls_bapi_te_wbhi INTO TABLE mt_bapi_te_wbhi . ENDLOOP . ENDMETHOD . METHOD set_partner . DATA ( ls_head ) = input -> ms_head . DATA ( lt_partner ) = input -> mt_partner . DATA ls_buspartyin TYPE bapitcparty . DATA lr_buspartyin TYPE REF TO bapitcparty . DATA ls_bapi_te_wbhp TYPE bapi_te_wbhp . \" \u5408\u4f5c\u4f19\u4f34\u6570\u636e LOOP AT lt_partner INTO DATA ( ls_partner ). CLEAR ls_buspartyin . ls_buspartyin - trcont_item = ls_partner - tposn . ls_buspartyin - trcont_subitem = ls_partner - tposn_sub . ls_buspartyin - partn_role = ls_partner - parvw . ls_buspartyin - partcount = ls_partner - pstlz . ls_buspartyin - vendor_no = ls_partner - lifnr . ls_buspartyin - cust_no = ls_partner - kunnr . ls_buspartyin - address = ls_partner - adrnr . INSERT ls_buspartyin INTO TABLE buspartyin . ENDLOOP . \" \u91cd\u590d\u4ee3\u7801 \" &1: \u5408\u4f5c\u4f19\u4f34\u89d2\u8272 \" &2: \u4f9b\u5e94\u5546\u7f16\u7801 DEFINE _add_partner . IF &3 IS NOT INITIAL . READ TABLE buspartyin REFERENCE INTO lr_buspartyin WITH KEY partn_role = &2 . IF sy - subrc <> 0 . INSERT VALUE # ( partn_role = &2 ) INTO TABLE buspartyin REFERENCE INTO lr_buspartyin . ENDIF . lr_buspartyin -> &1 = &3 . ENDIF . END-OF-DEFINITION . DEFINE _add_partner_vendor . _add_partner vendor_no &1 &2 . END-OF-DEFINITION . \" \u5982\u679c\u5408\u540c\u4f19\u4f34\u4e2d\u6ca1\u8fd9\u4e9b\u5bf9\u8c61\uff0c\u5219\u6839\u636e\u62ac\u5934\u53d6\u503c _add_partner_vendor 'LF' ls_head - lifnr . _add_partner_vendor 'Z4' ls_head - lifnr2 . _add_partner_vendor 'Z1' ls_head - lifnr3 . _add_partner_vendor 'ZM' ls_head - lifnr4 . ENDMETHOD . METHOD set_condition . DATA ( ls_head ) = input -> ms_head . DATA ( lt_condition ) = input -> mt_condition . \" \u67e5\u8be2\u91c7\u8d2d\u5b9a\u4ef7\u8fc7\u7a0b SELECT SINGLE kalsk FROM lfm1 WHERE lifnr = @ ls_head - lifnr AND ekorg = @ ls_head - ekorg INTO @ DATA ( l_kalsk ). SELECT SINGLE kalsm FROM tmks WHERE kalse = '1000' AND kalsk = @ l_kalsk INTO @ DATA ( l_kalsm ). SELECT * FROM t683s WHERE kalsm = @ l_kalsm INTO TABLE @ DATA ( lt_pricing_process ). SORT lt_pricing_process BY kschl . \" \u91c7\u8d2d\uff08\u4f9b\u5e94\u5546\uff09\u5b9a\u4ef7 DATA ls_vendorcondin TYPE bapitccond . LOOP AT lt_condition INTO DATA ( ls_condition ). \" \u8865\u5168\u7f16\u7801 IF ls_condition - tposn IS INITIAL . ls_condition - tposn = sy - tabix * 10 . ENDIF . IF ls_condition - zaehk IS INITIAL . ls_condition - zaehk = '001' . ENDIF . \" \u83b7\u53d6\u6761\u4ef6\u7c7b\u578b\u5bf9\u5e94\u6761\u4ef6\u8fc7\u7a0b\u4e2d\u7684\u987a\u5e8f READ TABLE lt_pricing_process INTO DATA ( ls_pricing_process ) WITH KEY kschl = ls_condition - kschl BINARY SEARCH . IF sy - subrc <> 0 . CLEAR ls_pricing_process . ENDIF . CLEAR ls_vendorcondin . ls_vendorcondin - trcont_item = ls_condition - tposn . ls_vendorcondin - trcont_subitem = ls_condition - tposn_sub . ls_vendorcondin - cond_st_no = ls_pricing_process - stunr . ls_vendorcondin - cond_count = '001' . ls_vendorcondin - applicatio = ls_pricing_process - kappl . ls_vendorcondin - cond_type = ls_condition - kschl . ls_vendorcondin - cond_base = ls_condition - kbetr . ls_vendorcondin - currency = ls_condition - waers . ls_vendorcondin - cond_p_unt = ls_condition - kpein . ls_vendorcondin - cond_unit = ls_condition - kmein . INSERT ls_vendorcondin INTO TABLE vendorcondin . ENDLOOP . * \" \u8d39\u7528\u5b9a\u4ef7 * DATA ls_conditionkeydatain TYPE bapitcconditionkey. * DATA ls_conditionitemdatain TYPE bapitcconditionitem. * LOOP AT mt_condition INTO DATA(ls_condition). * DATA(l_order_key) = sy-tabix * 10. * * CLEAR ls_conditionkeydatain. * ls_conditionkeydatain-order_key = l_order_key. * ls_conditionkeydatain-application = 'M'. ** ls_conditionkeydatain-cond_group_no = 'G002'. * ls_conditionkeydatain-cond_type = ls_condition-kschl. * ls_conditionkeydatain-purch_org = ms_head-ekorg. * ls_conditionkeydatain-vendor = ms_head-lifnr. * INSERT ls_conditionkeydatain INTO TABLE conditionkeydatain. * * CLEAR ls_conditionitemdatain. * ls_conditionitemdatain-order_key = l_order_key. * ls_conditionitemdatain-cond_count = ls_condition-kposn. * ls_conditionitemdatain-amount = ls_condition-kbetr. * ls_conditionitemdatain-condcurr = ls_condition-waers. * ls_conditionitemdatain-cond_p_unt = ls_condition-kpein. * ls_conditionitemdatain-cond_unit = ls_condition-kmein. * INSERT ls_conditionitemdatain INTO TABLE conditionitemdatain. * ENDLOOP. ENDMETHOD . METHOD set_text . ENDMETHOD . ENDCLASS . *&---------------------------------------------------------------------* *& Class (Implementation) lcl_bapi_ctr_change *&---------------------------------------------------------------------* *& *&---------------------------------------------------------------------* CLASS lcl_bapi_ctr_change IMPLEMENTATION . METHOD lif_bapi~execute . result = me . \" \u589e\u5f3a\u5b57\u6bb5\u957f\u5ea6\u5927\u4e8e960\uff0c\u65e0\u6cd5\u4f7f\u7528extensionin\u5b57\u6bb5 \" \u56e0\u6b64\u901a\u8fc7BAPI\u589e\u5f3a\u7684\u65b9\u5f0f\uff0c\u5c06\u503c\u4f20\u5165 \" \u7531\u4e8e\u662f\u9759\u6001\u53c2\u6570\uff0c\u7b49\u4ef7\u4e8e\u5185\u5b58\u4f20\u503c\uff0c\u800c\u4e14\u66f4\u597d\u7684\u6eaf\u6e90 zcl_im__wb2_bapi_enhance_ex => set_extension ( EXPORTING bapi_te_wbhk = ms_bapi_te_wbhk t_bapi_te_wbhi = mt_bapi_te_wbhi t_bapi_te_wbhd = mt_bapi_te_wbhd t_bapi_te_wbhe = mt_bapi_te_wbhe t_bapi_te_wbhp = mt_bapi_te_wbhp bapi_te_wbhkx = ms_bapi_te_wbhkx t_bapi_te_wbhix = mt_bapi_te_wbhix t_bapi_te_wbhdx = mt_bapi_te_wbhdx t_bapi_te_wbhex = mt_bapi_te_wbhex t_bapi_te_wbhpx = mt_bapi_te_wbhpx ). headdatain - testrun = testrun . SET PARAMETER ID 'BAPIHT' FIELD 'X' . \" BAPI\u521b\u5efa\u5408\u540c\uff0c\u7528\u4e8e\u8df3\u8fc7\u90e8\u5206\u6821\u9a8c CALL FUNCTION 'BAPI_TRADINGCONTRACT_CHANGE' EXPORTING tradingcontractno = tradingcontractno headdatain = headdatain headdatainx = headdatainx IMPORTING headdataout = headdataout TABLES itemdatain = itemdatain itemdatainx = itemdatainx scheduledatain = scheduledatain scheduledatainx = scheduledatainx businessdatain = businessdatain businessdatainx = businessdatainx buspartyin = buspartyin buspartyinx = buspartyinx extensionin = extensionin headtextin = headtextin itemtextin = itemtextin itemdataout = itemdataout scheduledataout = scheduledataout businessdataout = businessdataout buspartyout = buspartyout headtextout = headtextout itemtextout = itemtextout extensionout = extensionout return = return partneraddresses = partneraddresses partnerchanges = partnerchanges vendorcondin = vendorcondin vendorcondinx = vendorcondinx customercondin = customercondin customercondinx = customercondinx conditionkeydatain = conditionkeydatain conditionkeydatainx = conditionkeydatainx conditionitemdatain = conditionitemdatain conditionitemdatainx = conditionitemdatainx conditionkeydataout = conditionkeydataout conditionitemdataout = conditionitemdataout scaledatain = scaledatain scaledataout = scaledataout vendorcondout = vendorcondout customercondout = customercondout . SET PARAMETER ID 'BAPIHT' FIELD '' . lif_bapi~document = tradingcontractno . lif_bapi~mt_bapiret2 = CORRESPONDING # ( return ). CALL FUNCTION 'Z_MESSAGE_TABLE_TO_FIELD' EXPORTING t_bapiret2 = lif_bapi~mt_bapiret2 IMPORTING status = lif_bapi~status message = lif_bapi~message . \" \u53d1\u751f\u9519\u8bef\u6216\u6d4b\u8bd5\u6267\u884c\u7684\u60c5\u51b5\uff0c\u4e0d\u63d0\u4ea4 IF lif_bapi~status = 'E' OR testrun = abap_true . CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK' . CLEAR lif_bapi~document . RETURN . ENDIF . \" \u6b63\u5f0f\u63d0\u4ea4 CALL FUNCTION 'BAPI_TRANSACTION_COMMIT' EXPORTING wait = abap_true . ENDMETHOD . METHOD set_head . \" \u83b7\u53d6\u65e7\u6570\u636e DATA ( lo_old ) = lcl_fiori_ctr_data => read ( input -> ms_head - tkonn ). DATA ( lo_new ) = input . \" \u6bd4\u8f83\u5dee\u5f02 DATA lt_compare TYPE STANDARD TABLE OF zscompare_result . CALL FUNCTION 'Z_COMPARE_STRUCTURE' EXPORTING old = lo_old -> ms_head new = lo_new -> ms_head TABLES result = lt_compare . LOOP AT lt_compare REFERENCE INTO DATA ( lr_compare ) WHERE valid = abap_true AND changed = abap_true . CASE lr_compare -> name . WHEN 'BTBSTA ' . MOVE lr_compare -> value_new TO headdatain - trcont_stat . WHEN 'WAERS ' . MOVE lr_compare -> value_new TO headdatain - trcont_currency . MOVE lr_compare -> value_new TO headdatain - currency . WHEN 'BSTKD ' . MOVE lr_compare -> value_new TO headdatain - purch_no . * WHEN 'ZZSIGN_PLATFROM'. * MOVE lr_compare->value_new TO headdatain-comp_code . * MOVE lr_compare->value_new TO headdatain-sales_org . * WHEN 'EKGRP '. * MOVE lr_compare->value_new TO headdatain-sales_grp . * WHEN 'EKORG '. * MOVE lr_compare->value_new TO headdatain-sales_off . * WHEN 'VTWEG '. * MOVE lr_compare->value_new TO headdatain-distr_chan . * WHEN 'SPART '. * MOVE lr_compare->value_new TO headdatain-division . WHEN OTHERS . ENDCASE . ENDLOOP . \" BAPIX\u7ed3\u6784\u81ea\u52a8\u6253X CALL FUNCTION 'Z_SAME_FIELD_MARK' CHANGING data = headdatain datax = headdatainx . ENDMETHOD . METHOD set_bussiness . \" \u83b7\u53d6\u65e7\u6570\u636e DATA ( lo_old ) = lcl_fiori_ctr_data => read ( input -> ms_head - tkonn ). DATA ( lo_new ) = input . \" \u6bd4\u8f83\u5dee\u5f02 DATA lt_compare TYPE STANDARD TABLE OF zscompare_result . CALL FUNCTION 'Z_COMPARE_STRUCTURE' EXPORTING old = lo_old -> ms_head new = lo_new -> ms_head TABLES result = lt_compare . DATA ls_businessdatain LIKE LINE OF businessdatain . DATA ls_businessdatainx LIKE LINE OF businessdatainx . LOOP AT lt_compare REFERENCE INTO DATA ( lr_compare ) WHERE valid = abap_true AND changed = abap_true . CASE lr_compare -> name . WHEN 'LIFNR ' . MOVE lr_compare -> value_new TO ls_businessdatain - vendor . WHEN 'ZTERM ' . MOVE lr_compare -> value_new TO ls_businessdatain - pmnttrms . WHEN 'WAERS ' . MOVE lr_compare -> value_new TO ls_businessdatain - currency . WHEN 'TKRATE_MM ' . MOVE lr_compare -> value_new TO ls_businessdatain - exch_rate_p . WHEN 'KURST_MM ' . MOVE lr_compare -> value_new TO ls_businessdatain - exchg_rate . WHEN 'TKRATE_SD ' . MOVE lr_compare -> value_new TO ls_businessdatain - exch_rate_v . WHEN 'INCO1_MM ' . MOVE lr_compare -> value_new TO ls_businessdatain - incoterms1 . WHEN 'INCO1_MM_EX' . MOVE lr_compare -> value_new TO ls_businessdatain - incoterms2 . WHEN 'INCO1_SD ' . MOVE lr_compare -> value_new TO ls_businessdatain - incoterms1_sd . WHEN 'INCO1_SD_EX' . MOVE lr_compare -> value_new TO ls_businessdatain - incoterms2_sd . * WHEN 'EKORG '. * MOVE lr_compare->value_new TO ls_businessdatain-purch_org . * WHEN 'EKGRP '. * MOVE lr_compare->value_new TO ls_businessdatain-pur_group . WHEN OTHERS . ENDCASE . ENDLOOP . \" BAPIX\u7ed3\u6784\u81ea\u52a8\u6253X CALL FUNCTION 'Z_SAME_FIELD_MARK' CHANGING data = ls_businessdatain datax = ls_businessdatainx . INSERT ls_businessdatain INTO TABLE businessdatain . INSERT ls_businessdatainx INTO TABLE businessdatainx . ENDMETHOD . METHOD set_item . \" \u83b7\u53d6\u65e7\u6570\u636e DATA ( lo_old ) = lcl_fiori_ctr_data => read ( input -> ms_head - tkonn ). DATA ( lo_new ) = input . DATA lt_compare TYPE STANDARD TABLE OF zscompare_result . DATA ls_itemdatain LIKE LINE OF itemdatain . DATA ls_itemdatainx LIKE LINE OF itemdatainx . LOOP AT lo_new -> mt_item INTO DATA ( ls_item_new ). READ TABLE lo_old -> mt_item INTO DATA ( ls_item_old ) WITH KEY tposn = ls_item_new - tposn tposn_sub = ls_item_new - tposn_sub . \" \u65b0\u589e\u884c IF sy - subrc <> 0 . ls_item_new - updateflag = 'I' . CLEAR ls_item_old . ENDIF . * \" \u65e7\u884c\u5df2\u5220\u9664\uff0c\u65b0\u589e\u4e00\u884c * IF ls_item_old-updateflag = 'D'. * ls_item_new-updateflag = 'I'. * CLEAR ls_item_old. * ENDIF. \" \u6bd4\u8f83\u5dee\u5f02 CLEAR lt_compare . CALL FUNCTION 'Z_COMPARE_STRUCTURE' EXPORTING old = ls_item_old new = ls_item_new TABLES result = lt_compare . ls_itemdatain - trcont_item = ls_item_new - tposn . ls_itemdatain - trcont_subitem = ls_item_new - tposn_sub . IF lo_old -> ms_head - zzsign_platfrom <> lo_new -> ms_head - zzsign_platfrom . ls_itemdatain - plant = lo_new -> ms_head - zzsign_platfrom . ENDIF . LOOP AT lt_compare REFERENCE INTO DATA ( lr_compare ) WHERE valid = abap_true AND changed = abap_true . CASE lr_compare -> name . WHEN 'MATNR ' . MOVE lr_compare -> value_new TO ls_itemdatain - material . WHEN 'ARKTX ' . MOVE lr_compare -> value_new TO ls_itemdatain - short_text . WHEN 'MENGE ' . MOVE lr_compare -> value_new TO ls_itemdatain - req_qty . WHEN 'MENGE ' . MOVE lr_compare -> value_new TO ls_itemdatain - ordered . WHEN 'MEINS ' . MOVE lr_compare -> value_new TO ls_itemdatain - po_unit . WHEN 'NETPR_MM' . MOVE lr_compare -> value_new TO ls_itemdatain - sales_price . WHEN 'MEINS ' . MOVE lr_compare -> value_new TO ls_itemdatain - sales_unit . WHEN 'WAERS_MM' . MOVE lr_compare -> value_new TO ls_itemdatain - currency . WHEN 'NETPR_MM' . MOVE lr_compare -> value_new TO ls_itemdatain - pur_price . WHEN 'WAERS_MM' . MOVE lr_compare -> value_new TO ls_itemdatain - pur_currency . WHEN 'PEINH_MM' . MOVE lr_compare -> value_new TO ls_itemdatain - price_unit . WHEN 'LGORT ' . MOVE lr_compare -> value_new TO ls_itemdatain - stge_loc . WHEN OTHERS . ENDCASE . ENDLOOP . \" \u81ea\u52a8\u6253X CALL FUNCTION 'Z_SAME_FIELD_MARK' CHANGING data = ls_itemdatain datax = ls_itemdatainx . ls_itemdatainx - updateflag = ls_item_new - updateflag . INSERT ls_itemdatain INTO TABLE itemdatain . INSERT ls_itemdatainx INTO TABLE itemdatainx . ENDLOOP . ENDMETHOD . METHOD set_condition . \" \u83b7\u53d6\u65e7\u6570\u636e DATA ( lo_old ) = lcl_fiori_ctr_data => read ( input -> ms_head - tkonn ). DATA ( lo_new ) = input . DATA lt_compare TYPE STANDARD TABLE OF zscompare_result . DATA ls_vendorcondin LIKE LINE OF vendorcondin . DATA ls_vendorcondinx LIKE LINE OF vendorcondinx . \" \u67e5\u8be2\u91c7\u8d2d\u5b9a\u4ef7\u8fc7\u7a0b SELECT SINGLE kalsk FROM lfm1 WHERE lifnr = @ lo_old -> ms_head - lifnr AND ekorg = @ lo_old -> ms_head - ekorg INTO @ DATA ( l_kalsk ). SELECT SINGLE kalsm FROM tmks WHERE kalse = '1000' AND kalsk = @ l_kalsk INTO @ DATA ( l_kalsm ). SELECT * FROM t683s WHERE kalsm = @ l_kalsm INTO TABLE @ DATA ( lt_pricing_process ). SORT lt_pricing_process BY kschl . \" \u91c7\u8d2d\uff08\u4f9b\u5e94\u5546\uff09\u5b9a\u4ef7 LOOP AT lo_new -> mt_condition INTO DATA ( ls_condition_new ). READ TABLE lo_old -> mt_condition INTO DATA ( ls_condition_old ) WITH KEY tposn = ls_condition_new - tposn tposn_sub = ls_condition_new - tposn_sub knumv = ls_condition_new - knumv kposn = ls_condition_new - kposn stunr = ls_condition_new - stunr zaehk = ls_condition_new - zaehk . \" \u65b0\u589e\u884c IF sy - subrc <> 0 . ls_condition_new - updateflag = 'I' . CLEAR ls_condition_new . ENDIF . ls_vendorcondin - trcont_item = ls_condition_new - tposn . ls_vendorcondin - trcont_subitem = ls_condition_new - tposn_sub . ls_vendorcondin - cond_st_no = ls_condition_new - stunr . ls_vendorcondin - cond_count = ls_condition_new - zaehk . LOOP AT lt_compare REFERENCE INTO DATA ( lr_compare ) WHERE valid = abap_true AND changed = abap_true . CASE lr_compare -> name . WHEN 'KBETR' . MOVE lr_compare -> value_new TO ls_vendorcondin - cond_base . WHEN 'WAERS' . MOVE lr_compare -> value_new TO ls_vendorcondin - currency . WHEN 'KPEIN' . MOVE lr_compare -> value_new TO ls_vendorcondin - cond_p_unt . WHEN 'KMEIN' . MOVE lr_compare -> value_new TO ls_vendorcondin - cond_unit . WHEN OTHERS . ENDCASE . ENDLOOP . CALL FUNCTION 'Z_SAME_FIELD_MARK' CHANGING data = ls_vendorcondin datax = ls_vendorcondinx . ls_vendorcondinx - updateflag = ls_condition_new - updateflag . INSERT ls_vendorcondin INTO TABLE vendorcondin . INSERT ls_vendorcondinx INTO TABLE vendorcondinx . ENDLOOP . ENDMETHOD . METHOD set_partner . \" \u83b7\u53d6\u65e7\u6570\u636e DATA ( lo_old ) = lcl_fiori_ctr_data => read ( input -> ms_head - tkonn ). DATA ( lo_new ) = input . DATA lt_compare TYPE STANDARD TABLE OF zscompare_result . DATA ls_partner_old LIKE LINE OF lo_old -> mt_partner . DATA ls_partner_new LIKE LINE OF lo_new -> mt_partner . DATA ls_buspartyin LIKE LINE OF buspartyin . DATA ls_buspartyinx LIKE LINE OF buspartyinx . \" \u5408\u4f5c\u4f19\u4f34\u6570\u636e DEFINE _to_partner . READ TABLE lo_new -> mt_partner INTO ls_partner_new WITH KEY parvw = &1 . IF sy - subrc <> 0 . ls_partner_new = VALUE # ( parvw = &1 updateflag = 'I' lifnr = lo_new -> ms_head - &2 ). ENDIF . READ TABLE lo_old -> mt_partner INTO ls_partner_old WITH KEY parvw = &1 . IF sy - subrc = 0 . ls_partner_new - updateflag = 'U' . ENDIF . END-OF-DEFINITION . \" \u5982\u679c\u5408\u540c\u4f19\u4f34\u4e2d\u6ca1\u8fd9\u4e9b\u5bf9\u8c61\uff0c\u5219\u6839\u636e\u62ac\u5934\u53d6\u503c _to_partner 'LF' lifnr . _to_partner 'Z4' lifnr2 . _to_partner 'Z1' lifnr3 . _to_partner 'ZM' lifnr4 . LOOP AT lo_new -> mt_partner INTO ls_partner_new . READ TABLE lo_old -> mt_partner INTO ls_partner_old WITH KEY tposn = ls_partner_new - tposn tposn_sub = ls_partner_new - tposn_sub parvw = ls_partner_new - parvw . \" \u65b0\u589e\u884c IF sy - subrc <> 0 . ls_partner_new - updateflag = 'I' . CLEAR ls_partner_old . ENDIF . \" \u6bd4\u8f83\u5dee\u5f02 CLEAR lt_compare . CALL FUNCTION 'Z_COMPARE_STRUCTURE' EXPORTING old = ls_partner_old new = ls_partner_new TABLES result = lt_compare . ls_buspartyin - trcont_item = ls_partner_new - tposn . ls_buspartyin - trcont_subitem = ls_partner_new - tposn_sub . ls_buspartyin - partn_role = ls_partner_new - parvw . ls_buspartyin - partcount = ls_partner_new - pstlz . LOOP AT lt_compare REFERENCE INTO DATA ( lr_compare ) WHERE valid = abap_true AND changed = abap_true . CASE lr_compare -> name . WHEN 'LIFNR ' . MOVE lr_compare -> value_new TO ls_buspartyin - vendor_no . WHEN 'KUNNR ' . MOVE lr_compare -> value_new TO ls_buspartyin - cust_no . WHEN OTHERS . ENDCASE . ENDLOOP . CALL FUNCTION 'Z_SAME_FIELD_MARK' CHANGING data = ls_buspartyin datax = ls_buspartyinx . ls_buspartyinx - updateflag = ls_partner_new - updateflag . INSERT ls_buspartyin INTO TABLE buspartyin . INSERT ls_buspartyinx INTO TABLE buspartyinx . ENDLOOP . ENDMETHOD . METHOD set_text . ENDMETHOD . ENDCLASS . *&---------------------------------------------------------------------* *& Class (Implementation) lcl_contract_service *&---------------------------------------------------------------------* *& *&---------------------------------------------------------------------* CLASS lcl_contract_service IMPLEMENTATION . METHOD create . DATA ( lo_fiori_ctr_data ) = data . DATA ( lo_bapi_ctr_create ) = NEW lcl_bapi_ctr_create ( ). lo_bapi_ctr_create -> set_head ( lo_fiori_ctr_data ). lo_bapi_ctr_create -> set_item ( lo_fiori_ctr_data ). lo_bapi_ctr_create -> set_bussiness ( lo_fiori_ctr_data ). lo_bapi_ctr_create -> set_partner ( lo_fiori_ctr_data ). lo_bapi_ctr_create -> set_condition ( lo_fiori_ctr_data ). lo_bapi_ctr_create -> set_text ( lo_fiori_ctr_data ). \" \u6267\u884c\u521b\u5efabapi DATA ( lo_bapi ) = lo_bapi_ctr_create -> lif_bapi~execute ( testrun = abap_true ). IF lo_bapi -> status <> 'E' . lo_bapi = lo_bapi -> execute ( ). ENDIF . \" \u66f4\u65b0\u4ed8\u6b3e\u4fe1\u606f IF lo_bapi -> status = 'S' . lo_fiori_ctr_data -> save_payment ( ). ENDIF . contract = lo_bapi -> document . status = lo_bapi -> status . message = lo_bapi -> message . ENDMETHOD . METHOD change . DATA ( lo_fiori_ctr_data ) = data . DATA ( lo_bapi_ctr_change ) = NEW lcl_bapi_ctr_change ( ). lo_bapi_ctr_change -> set_head ( lo_fiori_ctr_data ). lo_bapi_ctr_change -> set_item ( lo_fiori_ctr_data ). lo_bapi_ctr_change -> set_bussiness ( lo_fiori_ctr_data ). lo_bapi_ctr_change -> set_partner ( lo_fiori_ctr_data ). lo_bapi_ctr_change -> set_condition ( lo_fiori_ctr_data ). lo_bapi_ctr_change -> set_text ( lo_fiori_ctr_data ). \" \u6267\u884c\u521b\u5efabapi DATA ( lo_bapi ) = lo_bapi_ctr_change -> lif_bapi~execute ( testrun = abap_true ). IF lo_bapi -> status <> 'E' . lo_bapi = lo_bapi -> execute ( ). ENDIF . \" \u66f4\u65b0\u4ed8\u6b3e\u4fe1\u606f IF lo_bapi -> status = 'S' . lo_fiori_ctr_data -> save_payment ( ). ENDIF . contract = lo_bapi -> document . status = lo_bapi -> status . message = lo_bapi -> message . ENDMETHOD . ENDCLASS . WB2_BAPI_ENHANCE_EX \uff1a\u5408\u540c\u589e\u5f3a WB2_TC_INCOMP_LOG \uff0c\u5408\u540c\u4e0d\u5b8c\u6574\u65e5\u5fd7\u589e\u5f3a","title":"\u8d38\u6613\u5408\u540c\u521b\u5efa\u4e0e\u4fee\u6539"},{"location":"gtm/contract/#_3","text":"","title":"\u5408\u540c\u5173\u95ed"},{"location":"gtm/contract_approval/","text":"\u5408\u540c\u5ba1\u6279 \u00b6 \u5408\u540c\u5ba1\u6279 \u00b6 WB2_CONTRACT_RELEASE \uff1a\u5408\u540c\u5ba1\u6279\uff0c\u5408\u540c\u5ba1\u6279\u540e\u4f1a\u81ea\u52a8\u521b\u5efa\u540e\u7eed\u8ba2\u5355\uff08\u91c7\u8d2d\u8ba2\u5355\u548c\u9500\u552e\u8ba2\u5355\uff09","title":"\u5408\u540c\u5ba1\u6279"},{"location":"gtm/contract_approval/#_1","text":"","title":"\u5408\u540c\u5ba1\u6279"},{"location":"gtm/contract_approval/#_2","text":"WB2_CONTRACT_RELEASE \uff1a\u5408\u540c\u5ba1\u6279\uff0c\u5408\u540c\u5ba1\u6279\u540e\u4f1a\u81ea\u52a8\u521b\u5efa\u540e\u7eed\u8ba2\u5355\uff08\u91c7\u8d2d\u8ba2\u5355\u548c\u9500\u552e\u8ba2\u5355\uff09","title":"\u5408\u540c\u5ba1\u6279"},{"location":"gtm/contract_assoc/","text":"\u5408\u540c\u5173\u8054 \u00b6 \u5728\u5408\u540c\u521b\u5efa\u6216\u4fee\u6539\u540e\uff0c\u7acb\u5373\u8fdb\u884c\u5408\u540c\u5173\u8054\uff0c\u6709\u65f6\u4f1a\u62a5\u9519\uff0c\u4f46\u4e0d\u80fd\u7a33\u5b9a\u590d\u73b0\uff0c\u81f3\u4eca\u6ca1\u6ca1\u627e\u5230\u539f\u56e0\u3002","title":"\u5408\u540c\u5173\u8054"},{"location":"gtm/contract_assoc/#_1","text":"\u5728\u5408\u540c\u521b\u5efa\u6216\u4fee\u6539\u540e\uff0c\u7acb\u5373\u8fdb\u884c\u5408\u540c\u5173\u8054\uff0c\u6709\u65f6\u4f1a\u62a5\u9519\uff0c\u4f46\u4e0d\u80fd\u7a33\u5b9a\u590d\u73b0\uff0c\u81f3\u4eca\u6ca1\u6ca1\u627e\u5230\u539f\u56e0\u3002","title":"\u5408\u540c\u5173\u8054"},{"location":"gtm/wtew/","text":"WTEW\u5de5\u4f5c\u53f0 \u00b6","title":"WTEW"},{"location":"gtm/wtew/#wtew","text":"","title":"WTEW\u5de5\u4f5c\u53f0"},{"location":"master_data/","text":"\u4e3b\u6570\u636e\u6982\u8ff0 \u00b6 \u8bb2\u8ff0\u5404\u7c7b\u4e3b\u6570\u636e\u7684\u7ef4\u62a4\u3002 \u5148\u8868\u660e\uff0c\u9664\u901a\u5e38\u5bfc\u5165\u65b9\u6848\u5916\uff0c\u6211\u8fd8\u5c06\u8bbe\u8ba1\u4e00\u79cd\u53e6\u4e00\u79cd\u5bfc\u5165\u65b9\u6848\uff0c\u611f\u5174\u8da3\u53ef\u4ee5\u7ee7\u7eed\u9605\u8bfb\u672c\u9875\u3002 \u6709\u4ec0\u4e48\u7279\u6b8a\uff1f \u00b6 \u505a\u4e2a\u601d\u7ef4\u5b9e\u9a8c\uff0c\u73b0\u6709\u4e00\u7ec4\u6570\u636e\uff0c\u8981\u5bfc\u5165\u5bf9\u5e94\u6570\u636e\u5e93\u8868\u3002 \u7528\u6237\u63d0\u51fa\u7b2c\u4e00\u4e2a\u9700\u6c42\uff1a\u201c \u4ec5\u9700 \u8fd9\u4e9b\u5b57\u6bb5\u201d\uff0c\u4e0d\u96be\uff0c\u4e0d\u5199\u6216\u6ce8\u91ca\u5176\u4ed6\u5b57\u6bb5\u5373\u53ef\u3002 \u7528\u6237\u63d0\u51fa\u7b2c\u4e8c\u4e2a\u9700\u6c42\uff1a\u201c \u67d0\u79cd\u60c5\u51b5\u4e0b \u624d\u5bfc\u5165\u8fd9\u4e9b\u5b57\u6bb5\u201d\uff0c\u4e5f\u4e0d\u96be\uff0c\u591a\u52a0\u51e0\u4e2a\u5224\u65ad\u5373\u53ef\u3002 \u53ef\u4ee5\u53d1\u73b0\uff0c\u4e3b\u6570\u636e\u5bfc\u5165\u7684\u9ebb\u70e6\u4e0d\u5728\u4e8e\u5bfc\u5165\uff0c\u800c\u662f\u63a7\u5236\u5b57\u6bb5\u662f\u5426\u5bfc\u5165\u3002\u56e0\u6b64\u8bbe\u8ba1\u7684\u65f6\u5019\uff0c\u4e5f\u5e94\u8be5\u4ee5 \u63a7\u5236\u5b57\u6bb5\u662f\u5426\u5bfc\u5165 \u4e3a\u6838\u5fc3\u3002 \u4e3b\u6570\u636e\u5bfc\u5165\uff0c\u591a\u6570\u90fd\u4f1a\u8981\u6c42\u65e5\u5fd7\u4fe1\u606f\uff0c\u8fd9\u4e2a\u4e0d\u662f\u6587\u6863\u8981\u6574\u7406\u7684\uff0c\u770b\u81ea\u5df1\u8bbe\u8ba1\u3002","title":"\u4e3b\u6570\u636e\u6982\u8ff0"},{"location":"master_data/#_1","text":"\u8bb2\u8ff0\u5404\u7c7b\u4e3b\u6570\u636e\u7684\u7ef4\u62a4\u3002 \u5148\u8868\u660e\uff0c\u9664\u901a\u5e38\u5bfc\u5165\u65b9\u6848\u5916\uff0c\u6211\u8fd8\u5c06\u8bbe\u8ba1\u4e00\u79cd\u53e6\u4e00\u79cd\u5bfc\u5165\u65b9\u6848\uff0c\u611f\u5174\u8da3\u53ef\u4ee5\u7ee7\u7eed\u9605\u8bfb\u672c\u9875\u3002","title":"\u4e3b\u6570\u636e\u6982\u8ff0"},{"location":"master_data/#_2","text":"\u505a\u4e2a\u601d\u7ef4\u5b9e\u9a8c\uff0c\u73b0\u6709\u4e00\u7ec4\u6570\u636e\uff0c\u8981\u5bfc\u5165\u5bf9\u5e94\u6570\u636e\u5e93\u8868\u3002 \u7528\u6237\u63d0\u51fa\u7b2c\u4e00\u4e2a\u9700\u6c42\uff1a\u201c \u4ec5\u9700 \u8fd9\u4e9b\u5b57\u6bb5\u201d\uff0c\u4e0d\u96be\uff0c\u4e0d\u5199\u6216\u6ce8\u91ca\u5176\u4ed6\u5b57\u6bb5\u5373\u53ef\u3002 \u7528\u6237\u63d0\u51fa\u7b2c\u4e8c\u4e2a\u9700\u6c42\uff1a\u201c \u67d0\u79cd\u60c5\u51b5\u4e0b \u624d\u5bfc\u5165\u8fd9\u4e9b\u5b57\u6bb5\u201d\uff0c\u4e5f\u4e0d\u96be\uff0c\u591a\u52a0\u51e0\u4e2a\u5224\u65ad\u5373\u53ef\u3002 \u53ef\u4ee5\u53d1\u73b0\uff0c\u4e3b\u6570\u636e\u5bfc\u5165\u7684\u9ebb\u70e6\u4e0d\u5728\u4e8e\u5bfc\u5165\uff0c\u800c\u662f\u63a7\u5236\u5b57\u6bb5\u662f\u5426\u5bfc\u5165\u3002\u56e0\u6b64\u8bbe\u8ba1\u7684\u65f6\u5019\uff0c\u4e5f\u5e94\u8be5\u4ee5 \u63a7\u5236\u5b57\u6bb5\u662f\u5426\u5bfc\u5165 \u4e3a\u6838\u5fc3\u3002 \u4e3b\u6570\u636e\u5bfc\u5165\uff0c\u591a\u6570\u90fd\u4f1a\u8981\u6c42\u65e5\u5fd7\u4fe1\u606f\uff0c\u8fd9\u4e2a\u4e0d\u662f\u6587\u6863\u8981\u6574\u7406\u7684\uff0c\u770b\u81ea\u5df1\u8bbe\u8ba1\u3002","title":"\u6709\u4ec0\u4e48\u7279\u6b8a\uff1f"},{"location":"master_data/bom/","text":"BOM \u00b6 \\SAP\u83dc\u5355\\\u540e\u52e4\\\u751f\u4ea7\\\u4e3b\u6570\u636e\\\u7269\u6599\u6e05\u5355\\BOM BOM\u79cd\u7c7b\u4e0d\u5c11\uff0c\u8be6\u89c1\u7269\u6599\u6e05\u5355\u7c7b\u522b\u503c\u57df\uff1a STLTY \u8bf4\u660e1 \u8bf4\u660e2 M Material BOM \u7269\u6599 BOM E Equipment BOM \u8bbe\u5907 BOM P Work Breakdown Structure BOM WBS BOM S Standard BOM \u6807\u51c6\u7269\u6599\u6e05\u5355 K Order BOM \u8ba2\u5355\u7269\u6599\u6e05\u5355 D Document Structure \u51ed\u8bc1\u7ed3\u6784 T Functional Location BOM \u529f\u80fd\u4f4d\u7f6e BOM BOM\u7ef4\u62a4 \u00b6 \u521b\u5efa\u53d8\u66f4\u53f7 \u00b6 CCAP_ECN_CREATE \uff1a\u521b\u5efa\u53d8\u66f4\u53f7 \u793a\u4f8b\u4ee3\u7801 FUNCTION zfm_ecn_check IMPORTING i_datuv TYPE datuv i_verid TYPE verid EXPORTING e_change_no TYPE aennr e_mtype TYPE bapi_mtype e_msg TYPE bapi_msg . IF i_datuv IS INITIAL OR i_datuv = '' . e_mtype = 'E' . e_msg = | [\u7248\u672c\u542f\u7528\u65f6\u95f4]\u4e3a\u7a7a |. RETURN . ENDIF . IF i_verid IS INITIAL . e_mtype = 'E' . e_msg = | [\u751f\u4ea7\u7248\u672c]\u4e3a\u7a7a |. RETURN . ENDIF . \" \u66f4\u6539\u53f7\u53ef\u4ee5\u968f\u610f\u7f16\u5199\uff0c\u4e00\u822c\u7528\u65e5\u671f+\u7248\u672c\u751f\u6210 DATA l_change_no TYPE aenr_api01 - change_no . l_change_no = |{ i_datuv }{ i_verid }|. CALL FUNCTION 'CONVERSION_EXIT_AENNR_INPUT' EXPORTING input = l_change_no IMPORTING output = l_change_no EXCEPTIONS length_error = 1 . \" \u68c0\u67e5\u66f4\u6539\u53f7\u662f\u5426\u5b58\u5728 SELECT SINGLE COUNT ( * ) FROM aenr WHERE aennr = @ l_change_no . IF sy - subrc = 0 . e_change_no = l_change_no . e_mtype = 'S' . RETURN . ENDIF . \" \u4e0d\u5b58\u5728\u5219\u521b\u5efa DATA : ls_header TYPE aenr_api01 , ls_object_bom TYPE aenv_api01 , ls_object_bom_mat TYPE aenv_api01 , ls_object_bom_psp TYPE aenv_api01 , ls_object_tlist_n TYPE aenv_api01 , ls_object_tlist_q TYPE aenv_api01 , ls_object_char TYPE aenv_api01 , ls_object_cls TYPE aenv_api01 , lv_number TYPE aenrb - aennr . ls_header - change_no = l_change_no . ls_header - status = '01' . ls_header - valid_from = |{ i_datuv DATE = USER }|. \" \u4e0b\u9762FM\u9700\u8981\u5916\u90e8\u683c\u5f0f ls_header - descript = | BOM/\u5de5\u827a\u6570\u636e\u7ef4\u62a4 |. ls_object_bom - active = 'X' . ls_object_bom_mat - active = 'X' . ls_object_bom_mat - obj_requ = 'X' . ls_object_bom_mat - mgtrec_gen = 'X' . ls_object_bom_psp - active = 'X' . ls_object_bom_psp - obj_requ = 'X' . ls_object_bom_psp - mgtrec_gen = 'X' . ls_object_tlist_n - active = 'X' . ls_object_tlist_n - obj_requ = 'X' . ls_object_tlist_n - mgtrec_gen = 'X' . ls_object_tlist_q - active = 'X' . ls_object_tlist_q - obj_requ = 'X' . ls_object_tlist_q - mgtrec_gen = 'X' . ls_object_char - active = 'X' . ls_object_cls - active = 'X' . SET UPDATE TASK LOCAL . \" \u521b\u5efaECN CLEAR l_change_no . CALL FUNCTION 'CCAP_ECN_CREATE' EXPORTING change_header = ls_header object_bom = ls_object_bom object_bom_mat = ls_object_bom_mat object_bom_psp = ls_object_bom_psp object_tlist_n = ls_object_tlist_n object_tlist_q = ls_object_tlist_q object_char = ls_object_char object_cls = ls_object_cls fl_commit_and_wait = 'X' IMPORTING change_no = l_change_no EXCEPTIONS change_no_already_exists = 1 error = 2 OTHERS = 3 . IF sy - subrc <> 0 . e_mtype = 'E' . MESSAGE ID sy - msgid TYPE sy - msgty NUMBER sy - msgno WITH sy - msgv1 sy - msgv2 sy - msgv3 sy - msgv4 INTO e_msg . RETURN . ENDIF . CALL FUNCTION 'BAPI_TRANSACTION_COMMIT' EXPORTING wait = 'X' . e_change_no = l_change_no . e_mtype = 'S' . ENDFUNCTION . (M) \u7269\u6599BOM \u00b6 CSAP_MAT_BOM_CREATE \uff1a\u521b\u5efa\u7269\u6599BOM CSAP_MAT_BOM_MAINTAIN \uff1a\u7ef4\u62a4\u7269\u6599BOM CSAP_MAT_BOM_READ \uff1a\u8bfb\u53d6\u7269\u6599BOM \u521b\u5efa\u548c\u7ef4\u62a4\u7684\u51fd\u6570\u4e0d\u652f\u6301\u6269\u5c55\u5907\u9009\u6e05\u5355(STLAL)\uff0c\u5982\u9700\u6269\u5c55\uff0c\u4f7f\u7528 BAPI_MATERIAL_BOM_GROUP_CREATE \u3002 \u793a\u4f8b\u4ee3\u7801 FUNCTION zfm_mat_bom_maintain IMPORTING i_mast TYPE mast i_stko TYPE stko EXPORTING e_mtype TYPE bapi_mtype e_msg TYPE bapi_msg et_bapiret2 TYPE bapiret2_t TABLES it_stpo LIKE stpo . \" \u9700\u8981\u6ce8\u610f\uff0cCSAP_MAT_BOM_MAINTAIN\u8981\u6c42\u53c2\u6570\u90fd\u662f\u5916\u90e8\u683c\u5f0f DATA l_mtype TYPE bapi_mtype . DATA l_msg TYPE bapi_msg . DATA : ls_csap_mbom TYPE csap_mbom , ls_stko_api01 TYPE stko_api01 , ls_stko_api02 TYPE stko_api02 , lt_stpo_api01 TYPE STANDARD TABLE OF stpo_api01 , ls_stpo_api01 TYPE stpo_api01 . CLEAR ls_csap_mbom . ls_csap_mbom - matnr = i_mast - matnr . ls_csap_mbom - werks = i_mast - werks . ls_csap_mbom - stlan = i_mast - stlan . ls_csap_mbom - stlal = i_mast - stlal . ls_csap_mbom - datuv = |{ i_stko - datuv DATE = USER }|. \" \u5916\u90e8\u65e5\u671f\u683c\u5f0f ls_csap_mbom - aennr = i_stko - aennr . CLEAR ls_stko_api01 . IF i_stko - bmeng IS NOT INITIAL . ls_stko_api01 - base_quan = |{ i_stko - bmeng NUMBER = USER }|. ELSE . ls_stko_api01 - base_quan = 1 . ENDIF . ls_stko_api01 - alt_text = i_stko - stktx . ls_stko_api01 - bom_status = i_stko - stlst . LOOP AT it_stpo INTO DATA ( ls_stpo ). CLEAR ls_stpo_api01 . ls_stpo_api01 - item_no = ls_stpo - posnr . \" \u884c\u53f7 ls_stpo_api01 - item_categ = 'L' . ls_stpo_api01 - component = ls_stpo - idnrk . \" \u7ec4\u4ef6\u7269\u6599 ls_stpo_api01 - comp_qty = ls_stpo - menge . \" \u7ec4\u4ef6\u6570\u91cf * ls_stpo_api03-comp_unit = ls_stpo-meins. \" \u7ec4\u4ef6\u8ba1\u91cf\u5355\u4f4d CALL FUNCTION 'CONVERSION_EXIT_CUNIT_OUTPUT' EXPORTING input = ls_stpo - meins IMPORTING output = ls_stpo_api01 - comp_unit EXCEPTIONS unit_not_found = 1 . ls_stpo_api01 - valid_from = ls_stpo - datuv . \" \u6709\u6548\u671f\u4ece ls_stpo_api01 - change_no = ls_stpo - aennr . \" \u53d8\u66f4\u53f7 ls_stpo_api01 - sortstring = ls_stpo - sortf . \" \u5de5\u5e8f\uff08\u6392\u5e8f\u5b57\u6bb5\uff09 ls_stpo_api01 - rel_prod = 'X' . ls_stpo_api01 - rel_cost = 'X' . \" \u589e\u5f3a\u5b57\u6bb5 ls_stpo_api01 - zspec1 = ls_stpo - zspec1 . ls_stpo_api01 - zspec3 = ls_stpo - zspec2 . ls_stpo_api01 - zspec2 = ls_stpo - zspec3 . INSERT ls_stpo_api01 INTO TABLE lt_stpo_api01 . ENDLOOP . * \" CSAP_MAT_BOM_MAINTAIN\u9650\u5236\uff0c\u65e0\u6cd5\u6269\u5c55\u5907\u9009BOM * \" \u8df3\u8f6c\u5230\u53e6\u4e00\u4e2a\u65b9\u6cd5\uff0c\u901a\u8fc7BAPI_MATERIAL_BOM_GROUP_CREATE\u521b\u5efa * IF ls_csap_mbom-stlal <> '01'. * CALL FUNCTION 'ZFM_MAT_BGR_CREATE' * EXPORTING * i_mast = i_mast * i_stko = i_stko * IMPORTING * e_mtype = e_mtype * e_msg = e_msg * TABLES * it_stpo = it_stpo[]. * IF e_mtype = 'E'. * RETURN. * ENDIF. * ENDIF. \" \u68c0\u67e5\u662f\u5426\u5df2\u5b58\u5728 DATA : lt_stko_api02_old TYPE STANDARD TABLE OF stko_api02 , lt_stpo_api02_old TYPE STANDARD TABLE OF stpo_api02 . CALL FUNCTION 'CSAP_MAT_BOM_READ' EXPORTING material = ls_csap_mbom - matnr plant = ls_csap_mbom - werks bom_usage = ls_csap_mbom - stlan alternative = ls_csap_mbom - stlal valid_from = ls_csap_mbom - datuv change_no = ls_csap_mbom - aennr TABLES t_stpo = lt_stpo_api02_old t_stko = lt_stko_api02_old EXCEPTIONS error = 1 OTHERS = 2 . IF sy - subrc = 0 . READ TABLE lt_stko_api02_old INTO DATA ( ls_stko_api02_upd ) INDEX 1 . \" \u89c1LCSDIFEH\u4e2d\u7684rc29k_stko_compare\u5b50\u4f8b\u7a0b\uff0c\u62ac\u5934\u53ea\u6709\u90e8\u5206\u5b57\u6bb5\u53ef\u4fee\u6539 \" \u6570\u91cf\u3001\u5355\u4f4d\u3001\u62ac\u5934\u6587\u672c\u90fd\u4e0d\u5728\u4fee\u6539\u8303\u56f4\u5185 * ls_stko_api02_upd-alt_text = ls_stko_api01-alt_text. ls_stko_api01 = CORRESPONDING # ( ls_stko_api02_upd ). DATA lt_stpo_api03 TYPE STANDARD TABLE OF stpo_api03 . SORT lt_stpo_api01 BY item_no . SORT lt_stpo_api02_old BY item_no . \" \u4fee\u6539 LOOP AT lt_stpo_api01 INTO ls_stpo_api01 . READ TABLE lt_stpo_api02_old INTO DATA ( ls_stpo_api02_upd ) WITH KEY item_no = ls_stpo_api01 - item_no BINARY SEARCH . IF sy - subrc = 0 . DELETE lt_stpo_api02_old INDEX sy - tabix . ls_stpo_api02_upd - item_no = ls_stpo_api01 - item_no . ls_stpo_api02_upd - item_categ = ls_stpo_api01 - item_categ . ls_stpo_api02_upd - component = ls_stpo_api01 - component . ls_stpo_api02_upd - comp_qty = ls_stpo_api01 - comp_qty . ls_stpo_api02_upd - comp_unit = ls_stpo_api01 - comp_unit . ls_stpo_api02_upd - valid_from = ls_stpo_api01 - valid_from . ls_stpo_api02_upd - change_no = ls_stpo_api01 - change_no . ls_stpo_api02_upd - rel_prod = ls_stpo_api01 - rel_prod . ls_stpo_api02_upd - rel_cost = ls_stpo_api01 - rel_cost . ls_stpo_api02_upd - zspec1 = ls_stpo_api01 - zspec1 . ls_stpo_api02_upd - zspec2 = ls_stpo_api01 - zspec2 . ls_stpo_api02_upd - zspec3 = ls_stpo_api01 - zspec3 . INSERT CORRESPONDING # ( ls_stpo_api02_upd ) INTO TABLE lt_stpo_api03 . ELSE . INSERT CORRESPONDING # ( ls_stpo_api01 ) INTO TABLE lt_stpo_api03 . ENDIF . ENDLOOP . \" \u5220\u9664\u591a\u4f59\u7684\u65e7\u9879\u76ee LOOP AT lt_stpo_api02_old INTO DATA ( ls_stpo_api02_del ). ls_stpo_api02_del - fldelete = abap_true . INSERT CORRESPONDING # ( ls_stpo_api02_del ) INTO TABLE lt_stpo_api03 . ENDLOOP . SORT lt_stpo_api03 BY item_no . SET UPDATE TASK LOCAL . CALL FUNCTION 'CSAP_MAT_BOM_MAINTAIN' EXPORTING material = ls_csap_mbom - matnr plant = ls_csap_mbom - werks bom_usage = ls_csap_mbom - stlan alternative = ls_csap_mbom - stlal valid_from = ls_csap_mbom - datuv change_no = ls_csap_mbom - aennr i_stko = ls_stko_api01 fl_bom_create = 'X' fl_new_item = 'X' IMPORTING o_stko = ls_stko_api02 TABLES t_stpo = lt_stpo_api03 EXCEPTIONS error = 1 OTHERS = 2 . ELSE . SET UPDATE TASK LOCAL . CALL FUNCTION 'CSAP_MAT_BOM_CREATE' EXPORTING material = ls_csap_mbom - matnr plant = ls_csap_mbom - werks bom_usage = ls_csap_mbom - stlan alternative = ls_csap_mbom - stlal valid_from = ls_csap_mbom - datuv change_no = ls_csap_mbom - aennr i_stko = ls_stko_api01 IMPORTING bom_no = ls_stko_api02 - bom_no TABLES t_stpo = lt_stpo_api01 EXCEPTIONS error = 1 OTHERS = 2 . ENDIF . IF sy - subrc <> 0 . e_mtype = 'E' . MESSAGE ID sy - msgid TYPE sy - msgty NUMBER sy - msgno WITH sy - msgv1 sy - msgv2 sy - msgv3 sy - msgv4 INTO e_msg . MESSAGE e_msg TYPE 'S' DISPLAY LIKE 'E' . CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK' . ELSE . e_mtype = 'S' . e_msg = | \u5df2\u5904\u7406 |. MESSAGE e_msg TYPE 'S' . CALL FUNCTION 'BAPI_TRANSACTION_COMMIT' EXPORTING wait = 'X' . ENDIF . ENDFUNCTION . (M) \u7269\u6599BOM\u7ec4 \u00b6 \u901a\u8fc7 BAPI_MATERIAL_BOM_GROUP_CREATE \u5b9e\u73b0\u591a\u4e2a\u5907\u9009BOM\u7684\u521b\u5efa\u3002 \u793a\u4f8b\u4ee3\u7801 FUNCTION zfm_mat_bgr_create IMPORTING i_mast TYPE mast i_stko TYPE stko EXPORTING e_mtype TYPE bapi_mtype e_msg TYPE bapi_msg et_bapiret2 TYPE bapiret2_t TABLES it_stpo LIKE stpo . DATA l_mtype TYPE bapi_mtype . DATA l_msg TYPE bapi_msg . DATA : testrun TYPE bapiflag , lt_bomgroup TYPE STANDARD TABLE OF bapi1080_bgr_c , ls_bomgroup TYPE bapi1080_bgr_c , lt_variants TYPE STANDARD TABLE OF bapi1080_bom_c , ls_variants TYPE bapi1080_bom_c , lt_materialrelations TYPE STANDARD TABLE OF bapi1080_mbm_c , ls_materialrelations TYPE bapi1080_mbm_c , lt_items TYPE STANDARD TABLE OF bapi1080_itm_c , ls_items TYPE bapi1080_itm_c , lt_itemassignments TYPE STANDARD TABLE OF bapi1080_rel_itm_bom_c , ls_itemassignments TYPE bapi1080_rel_itm_bom_c , lt_bomsubitems TYPE STANDARD TABLE OF bapi1080_sui_c , lt_bomsubitemas TYPE STANDARD TABLE OF bapi1080_rel_sui_itm_c , lt_texts TYPE STANDARD TABLE OF bapi1080_txt_c . \" \u6807\u8bc6 DATA l_uuid TYPE sysuuid_c32 . TRY . l_uuid = cl_system_uuid => create_uuid_c32_static ( ). CATCH cx_uuid_error . l_uuid = sy - datum && sy - uzeit && sy - uname . ENDTRY . \" \u65b0\u589e/\u7ef4\u62a4 DATA l_funciton TYPE cs_function . SELECT SINGLE COUNT ( * ) FROM mast WHERE matnr = @ i_mast - matnr AND werks = @ i_mast - werks AND stlan = @ i_mast - stlan AND stlal = @ i_mast - stlal . IF sy - subrc = 0 . \" \u4fee\u6539\u7528CSAP_MAT_BOM_MAINTAIN\uff0c\u8fd9\u4e2a\u65b9\u6cd5\u662f\u4e3a\u4e86\u6269\u5c55\u5907\u9009BOM e_mtype = 'S' . e_msg = '\u5df2\u5904\u7406' . RETURN . ELSE . l_funciton = 'NEW' . ENDIF . \" OBJECT_TYPE\u7684\u57df\u503c\uff0c\u4e5f\u5907\u6ce8\u4e0b\uff0c\u514d\u5f97\u770b\u4e0d\u61c2 \" BGR - Bill of material group \" BOM - Material BOM assembly variant/alternative \" ITM - BOM item \" SUI - BOM Sub-Item \" OBJECT ID DATA l_head_object_id TYPE cs_object_id . l_head_object_id = 'HEAD' . CLEAR ls_bomgroup . ls_bomgroup - bom_group_identification = l_uuid . ls_bomgroup - object_type = 'BGR' . ls_bomgroup - object_id = l_head_object_id . ls_bomgroup - bom_usage = i_mast - stlan . \" BOM\u7528\u9014 ls_bomgroup - created_in_plant = i_mast - werks . \" \u5de5\u5382 INSERT ls_bomgroup INTO TABLE lt_bomgroup . \" \uff1f\uff1f\uff1f\u4e3a\u4ec0\u4e48\u6ca1\u6709STLTY\u53c2\u6570 CLEAR ls_variants . ls_variants - bom_group_identification = l_uuid . ls_variants - object_type = 'BOM' . ls_variants - object_id = l_head_object_id . ls_variants - alternative_bom = i_mast - stlal . \" \u5907\u9009\u7269\u6599\u6e05\u5355 ls_variants - alt_text = i_stko - stktx . \" \u6587\u672c ls_variants - bom_status = i_stko - stlst . \" BOM\u72b6\u6001 ls_variants - change_no = i_stko - aennr . \" \u53d8\u66f4\u53f7 ls_variants - valid_from_date = i_stko - datuv . ls_variants - function = l_funciton . INSERT ls_variants INTO TABLE lt_variants . CLEAR ls_materialrelations . ls_materialrelations - bom_group_identification = l_uuid . ls_materialrelations - material = ls_materialrelations - material_guid = ls_materialrelations - material_external = ls_materialrelations - material_long = i_mast - matnr . \" \u7269\u6599\u7f16\u7801 ls_materialrelations - plant = i_mast - werks . \" \u5de5\u5382 ls_materialrelations - bom_usage = i_mast - stlan . \" BOM\u7528\u9014 ls_materialrelations - alternative_bom = i_mast - stlal . \" \u5907\u9009\u7269\u6599\u6e05\u5355 INSERT ls_materialrelations INTO TABLE lt_materialrelations . LOOP AT it_stpo INTO DATA ( ls_stpo ). DATA ( l_tabix ) = sy - tabix * 10 . \" OBJECT ID DATA l_item_object_id TYPE cs_object_id . l_item_object_id = | ITEM { l_tabix }|. CLEAR ls_items . ls_items - bom_group_identification = l_uuid . ls_items - object_type = 'ITM' . ls_items - object_id = l_item_object_id . ls_items - item_no = |{ ls_stpo - posnr ALPHA = IN }|. \" \u884c\u53f7 ls_items - component = ls_stpo - idnrk . \" \u7ec4\u4ef6\u7269\u6599 ls_items - comp_qty = ls_stpo - menge . \" \u7ec4\u4ef6\u6570\u91cf ls_items - comp_unit = ls_stpo - meins . \" \u7ec4\u4ef6\u8ba1\u91cf\u5355\u4f4d ls_items - ltxt_lang = '1' . ls_items - valid_from_date = ls_stpo - datuv . \" \u6709\u6548\u8d77\u59cb\u65e5\u671f ls_items - change_no = ls_stpo - aennr . \" \u53d8\u66f4\u53f7 INSERT ls_items INTO TABLE lt_items . CLEAR ls_itemassignments . ls_itemassignments - bom_group_identification = l_uuid . ls_itemassignments - sub_object_type = 'ITM' . ls_itemassignments - sub_object_id = l_item_object_id . ls_itemassignments - super_object_type = 'BOM' . ls_itemassignments - super_object_id = l_head_object_id . ls_itemassignments - valid_from_date = sy - datum . ls_itemassignments - function = l_funciton . INSERT ls_itemassignments INTO TABLE lt_itemassignments . ENDLOOP . CALL FUNCTION 'BAPI_MATERIAL_BOM_GROUP_CREATE' EXPORTING all_error = 'X' TABLES bomgroup = lt_bomgroup variants = lt_variants items = lt_items materialrelations = lt_materialrelations itemassignments = lt_itemassignments return = et_bapiret2[] . CLEAR l_mtype . CLEAR l_msg . LOOP AT et_bapiret2 INTO DATA ( ls_return ) WHERE type CA 'AXE' . MESSAGE ID ls_return - id TYPE ls_return - type NUMBER ls_return - number WITH ls_return - message_v1 ls_return - message_v2 ls_return - message_v3 ls_return - message_v4 INTO l_msg . e_msg = |{ e_msg }{ l_msg } ; |. ENDLOOP . IF sy - subrc = 0 . e_mtype = 'E' . MESSAGE ID sy - msgid TYPE sy - msgty NUMBER sy - msgno WITH sy - msgv1 sy - msgv2 sy - msgv3 sy - msgv4 INTO e_msg . MESSAGE e_msg TYPE 'S' DISPLAY LIKE 'E' . CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK' . ELSE . e_mtype = 'S' . e_msg = | \u5df2\u5904\u7406 |. MESSAGE e_msg TYPE 'S' . CALL FUNCTION 'BAPI_TRANSACTION_COMMIT' EXPORTING wait = 'X' . ENDIF . ENDFUNCTION . (P) WBS BOM \u00b6 CSAP_BOM_CREATE \u521b\u5efa CSAP_BOM_MAINTAIN \u7ef4\u62a4 CSAP_BOM_READ \u8bfb\u53d6 \u793a\u4f8b\u4ee3\u7801 FUNCTION zfm_wbs_bom_maintain IMPORTING i_prps TYPE prps i_prst TYPE prst i_stko TYPE stko EXPORTING e_mtype TYPE bapi_mtype e_msg TYPE bapi_msg et_bapiret2 TYPE bapiret2_t TABLES it_stpo LIKE stpo . DATA : ls_ecsin TYPE csin , ls_stzub TYPE stzub , lt_stkob TYPE STANDARD TABLE OF stkob , ls_stkob TYPE stkob , lt_stpob TYPE STANDARD TABLE OF stpob , ls_stpob TYPE stpob . CLEAR ls_ecsin . ls_ecsin - matnr = i_prst - matnr . ls_ecsin - werks = i_prst - werks . ls_ecsin - pspnr = i_prps - pspnr . \" WBS\u7f16\u53f7 ls_ecsin - stlty = i_stko - stlty . \" BOM\u7c7b\u578b ls_ecsin - stlan = i_prst - stlan . \" BOM\u7528\u9014 \" \u6570\u91cf IF i_stko - bmeng IS NOT INITIAL . ls_ecsin - emeng = i_stko - bmeng . ELSE . ls_ecsin - emeng = 1 . ENDIF . ls_ecsin - aennr = i_prps - aennr . \" \u53d8\u66f4\u53f7 CLEAR ls_stkob . ls_stkob - stlty = i_stko - stlty . \" BOM\u7c7b\u578b ls_stkob - bmeng = i_stko - bmeng . ls_stkob - stktx = i_stko - stktx . CLEAR lt_stpob . LOOP AT it_stpo INTO DATA ( ls_stpo ). CLEAR ls_stpob . ls_stpob - posnr = ls_stpo - posnr . ls_stpob - datuv = ls_stpo - datuv . ls_stpob - stlty = ls_stpo - stlty . ls_stpob - postp = 'L' . ls_stpob - idnrk = ls_stpo - idnrk . ls_stpob - menge = ls_stpo - menge . ls_stpob - meins = ls_stpo - meins . ls_stpob - aennr = ls_stpo - aennr . ls_stpob - sortf = ls_stpo - sortf . \" \u5de5\u5e8f ls_stpob - zspec1 = ls_stpo - zspec1 . ls_stpob - zspec2 = ls_stpo - zspec2 . ls_stpob - zspec3 = ls_stpo - zspec3 . \" \u4f9b\u5e94\u5546/\u724c\u53f7/\u4ea7\u5730\u4e0d\u4e3a\u7a7a\u7684\u65f6\u5019 IF ls_stpo - zspec1 IS NOT INITIAL OR ls_stpo - zspec2 IS NOT INITIAL OR ls_stpo - zspec3 IS NOT INITIAL . ls_stpob - dspst = '1' . ENDIF . INSERT ls_stpob INTO TABLE lt_stpob . ENDLOOP . \" \u68c0\u67e5\u662f\u5426\u5df2\u5b58\u5728 DATA : lt_stkob_old TYPE STANDARD TABLE OF stkob , lt_stpob_old TYPE STANDARD TABLE OF stpob . CALL FUNCTION 'CSAI_BOM_READ' EXPORTING ecsin = ls_ecsin TABLES t_stkob = lt_stkob_old t_stpob = lt_stpob_old EXCEPTIONS error = 1 OTHERS = 2 . IF sy - subrc = 0 . \" \u62ac\u5934\u53ea\u6709\u63cf\u8ff0\u5141\u8bb8\u88ab\u4fee\u6539 READ TABLE lt_stkob_old INTO DATA ( ls_stkob_old ) INDEX 1 . ls_stkob_old - stktx = ls_stkob - stktx . ls_stkob = ls_stkob_old . SORT lt_stpob BY posnr . SORT lt_stpob_old BY posnr . \" \u4fee\u6539 LOOP AT lt_stpob REFERENCE INTO DATA ( lr_stpob ). lr_stpob -> vbkz = lr_stpob -> mvbkz = 'I' . \" \u65b0\u589e READ TABLE lt_stpob_old INTO DATA ( ls_stpob_upd ) WITH KEY posnr = lr_stpob -> posnr BINARY SEARCH . IF sy - subrc = 0 . DELETE lt_stpob_old INDEX sy - tabix . ls_stpob_upd - vbkz = ls_stpob_upd - mvbkz = 'U' . \" \u4fee\u6539 ls_stpob_upd - posnr = lr_stpob -> posnr . ls_stpob_upd - stlty = lr_stpob -> stlty . ls_stpob_upd - datuv = lr_stpob -> datuv . ls_stpob_upd - postp = lr_stpob -> postp . ls_stpob_upd - idnrk = lr_stpob -> idnrk . ls_stpob_upd - menge = lr_stpob -> menge . ls_stpob_upd - meins = lr_stpob -> meins . ls_stpob_upd - aennr = lr_stpob -> aennr . ls_stpob_upd - sortf = lr_stpob -> sortf . ls_stpob_upd - zspec1 = lr_stpob -> zspec1 . ls_stpob_upd - zspec2 = lr_stpob -> zspec2 . ls_stpob_upd - zspec3 = lr_stpob -> zspec3 . ls_stpob_upd - dspst = lr_stpob -> dspst . lr_stpob->* = ls_stpob_upd . * \" \u7528\u5b50\u9879\u76ee\uff0c\u800c\u4e0d\u662f\u76f4\u63a5\u4fee\u6539 * ls_stpob_upd-vgknt = ls_stpob_upd-stlkn. * ls_stpob_upd-vgpzl = ls_stpob_upd-stpoz. * CLEAR ls_stpob_upd-stlkn. * CLEAR ls_stpob_upd-stpoz. ENDIF . ENDLOOP . \" \u5220\u9664\u591a\u4f59\u7684\u65e7\u9879\u76ee LOOP AT lt_stpob_old INTO DATA ( ls_stpob_del ). ls_stpob_del - lkenz = abap_true . ls_stpob_del - vbkz = ls_stpob_upd - mvbkz = 'D' . \" \u5220\u9664\u6807\u8bc6 INSERT ls_stpob_del INTO TABLE lt_stpob . ENDLOOP . SORT lt_stpob BY posnr . \" \u7ef4\u62a4BOM CALL FUNCTION 'CSAI_BOM_MAINTAIN' EXPORTING ecsin = ls_ecsin estkob = ls_stkob estzub = ls_stzub IMPORTING astzub = ls_stzub TABLES t_stpob = lt_stpob EXCEPTIONS error = 1 OTHERS = 2 . ELSE . \" \u65b0\u589eBOM CALL FUNCTION 'CSAI_BOM_CREATE' EXPORTING ecsin = ls_ecsin estkob = ls_stkob estzub = ls_stzub IMPORTING astlnr = ls_stzub - stlnr TABLES t_stpob = lt_stpob EXCEPTIONS error = 1 OTHERS = 2 . ENDIF . IF sy - subrc <> 0 OR sy - msgty = 'E' . e_mtype = 'E' . MESSAGE ID sy - msgid TYPE sy - msgty NUMBER sy - msgno INTO e_msg WITH sy - msgv1 sy - msgv2 sy - msgv3 sy - msgv4 . CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK' . ELSE . e_mtype = 'S' . e_msg = | \u5df2\u5904\u7406 |. MESSAGE e_msg TYPE 'S' . CALL FUNCTION 'BAPI_TRANSACTION_COMMIT' EXPORTING wait = 'X' . ENDIF . ENDFUNCTION . BOM\u5c55\u5f00 \u00b6 \u7f51\u4e0a\u67e5\u5230BOM\u5c55\u793a\u6709\u591a\u79cd\u65b9\u6cd5\uff0c\u5927\u90e8\u5206\u6211\u90fd\u6ca1\u7528\u8fc7\uff0c\u53ea\u80fd\u6162\u6162\u8865\u5145\u4e86 \u51fd\u6570 \u8bf4\u660e CS_BOM_EXPLOSION \u901a\u7528BOM\u5c55\u5f00 CS_BOM_EXPL_MAT_V2 \u7269\u6599BOM\u5c55\u5f00 CS_BOM_EXPL_PSP_V1 WBS BOM\u5c55\u5f00 CS_BOM_EXPL_EQU_V2 \u8bbe\u5907BOM\u5c55\u5f00 CS_BOM_EXPL_KND_V1 \u8ba2\u5355BOM\u5c55\u5f00 \u901a\u7528BOM\u5c55\u5f00 \u00b6 \u7269\u6599BOM\u5c55\u5f00 \u00b6 WBS BOM\u5c55\u5f00 \u00b6 \u8bbe\u5907BOM\u5c55\u5f00 \u00b6 \u8ba2\u5355BOM\u5c55\u5f00 \u00b6 \u6027\u80fd\u4f18\u5316 \u00b6 BOM\u5c55\u793a\u6700\u5927\u7684\u95ee\u9898\u5e94\u8be5\u662f\u6027\u80fd\u4e86\uff0c\u4e00\u822c\u7528\u5e76\u53d1\u7684\u65b9\u6cd5\u6765\u52a0\u901f\u3002","title":"BOM"},{"location":"master_data/bom/#bom","text":"\\SAP\u83dc\u5355\\\u540e\u52e4\\\u751f\u4ea7\\\u4e3b\u6570\u636e\\\u7269\u6599\u6e05\u5355\\BOM BOM\u79cd\u7c7b\u4e0d\u5c11\uff0c\u8be6\u89c1\u7269\u6599\u6e05\u5355\u7c7b\u522b\u503c\u57df\uff1a STLTY \u8bf4\u660e1 \u8bf4\u660e2 M Material BOM \u7269\u6599 BOM E Equipment BOM \u8bbe\u5907 BOM P Work Breakdown Structure BOM WBS BOM S Standard BOM \u6807\u51c6\u7269\u6599\u6e05\u5355 K Order BOM \u8ba2\u5355\u7269\u6599\u6e05\u5355 D Document Structure \u51ed\u8bc1\u7ed3\u6784 T Functional Location BOM \u529f\u80fd\u4f4d\u7f6e BOM","title":"BOM"},{"location":"master_data/bom/#bom_1","text":"","title":"BOM\u7ef4\u62a4"},{"location":"master_data/bom/#_1","text":"CCAP_ECN_CREATE \uff1a\u521b\u5efa\u53d8\u66f4\u53f7 \u793a\u4f8b\u4ee3\u7801 FUNCTION zfm_ecn_check IMPORTING i_datuv TYPE datuv i_verid TYPE verid EXPORTING e_change_no TYPE aennr e_mtype TYPE bapi_mtype e_msg TYPE bapi_msg . IF i_datuv IS INITIAL OR i_datuv = '' . e_mtype = 'E' . e_msg = | [\u7248\u672c\u542f\u7528\u65f6\u95f4]\u4e3a\u7a7a |. RETURN . ENDIF . IF i_verid IS INITIAL . e_mtype = 'E' . e_msg = | [\u751f\u4ea7\u7248\u672c]\u4e3a\u7a7a |. RETURN . ENDIF . \" \u66f4\u6539\u53f7\u53ef\u4ee5\u968f\u610f\u7f16\u5199\uff0c\u4e00\u822c\u7528\u65e5\u671f+\u7248\u672c\u751f\u6210 DATA l_change_no TYPE aenr_api01 - change_no . l_change_no = |{ i_datuv }{ i_verid }|. CALL FUNCTION 'CONVERSION_EXIT_AENNR_INPUT' EXPORTING input = l_change_no IMPORTING output = l_change_no EXCEPTIONS length_error = 1 . \" \u68c0\u67e5\u66f4\u6539\u53f7\u662f\u5426\u5b58\u5728 SELECT SINGLE COUNT ( * ) FROM aenr WHERE aennr = @ l_change_no . IF sy - subrc = 0 . e_change_no = l_change_no . e_mtype = 'S' . RETURN . ENDIF . \" \u4e0d\u5b58\u5728\u5219\u521b\u5efa DATA : ls_header TYPE aenr_api01 , ls_object_bom TYPE aenv_api01 , ls_object_bom_mat TYPE aenv_api01 , ls_object_bom_psp TYPE aenv_api01 , ls_object_tlist_n TYPE aenv_api01 , ls_object_tlist_q TYPE aenv_api01 , ls_object_char TYPE aenv_api01 , ls_object_cls TYPE aenv_api01 , lv_number TYPE aenrb - aennr . ls_header - change_no = l_change_no . ls_header - status = '01' . ls_header - valid_from = |{ i_datuv DATE = USER }|. \" \u4e0b\u9762FM\u9700\u8981\u5916\u90e8\u683c\u5f0f ls_header - descript = | BOM/\u5de5\u827a\u6570\u636e\u7ef4\u62a4 |. ls_object_bom - active = 'X' . ls_object_bom_mat - active = 'X' . ls_object_bom_mat - obj_requ = 'X' . ls_object_bom_mat - mgtrec_gen = 'X' . ls_object_bom_psp - active = 'X' . ls_object_bom_psp - obj_requ = 'X' . ls_object_bom_psp - mgtrec_gen = 'X' . ls_object_tlist_n - active = 'X' . ls_object_tlist_n - obj_requ = 'X' . ls_object_tlist_n - mgtrec_gen = 'X' . ls_object_tlist_q - active = 'X' . ls_object_tlist_q - obj_requ = 'X' . ls_object_tlist_q - mgtrec_gen = 'X' . ls_object_char - active = 'X' . ls_object_cls - active = 'X' . SET UPDATE TASK LOCAL . \" \u521b\u5efaECN CLEAR l_change_no . CALL FUNCTION 'CCAP_ECN_CREATE' EXPORTING change_header = ls_header object_bom = ls_object_bom object_bom_mat = ls_object_bom_mat object_bom_psp = ls_object_bom_psp object_tlist_n = ls_object_tlist_n object_tlist_q = ls_object_tlist_q object_char = ls_object_char object_cls = ls_object_cls fl_commit_and_wait = 'X' IMPORTING change_no = l_change_no EXCEPTIONS change_no_already_exists = 1 error = 2 OTHERS = 3 . IF sy - subrc <> 0 . e_mtype = 'E' . MESSAGE ID sy - msgid TYPE sy - msgty NUMBER sy - msgno WITH sy - msgv1 sy - msgv2 sy - msgv3 sy - msgv4 INTO e_msg . RETURN . ENDIF . CALL FUNCTION 'BAPI_TRANSACTION_COMMIT' EXPORTING wait = 'X' . e_change_no = l_change_no . e_mtype = 'S' . ENDFUNCTION .","title":"\u521b\u5efa\u53d8\u66f4\u53f7"},{"location":"master_data/bom/#m-bom","text":"CSAP_MAT_BOM_CREATE \uff1a\u521b\u5efa\u7269\u6599BOM CSAP_MAT_BOM_MAINTAIN \uff1a\u7ef4\u62a4\u7269\u6599BOM CSAP_MAT_BOM_READ \uff1a\u8bfb\u53d6\u7269\u6599BOM \u521b\u5efa\u548c\u7ef4\u62a4\u7684\u51fd\u6570\u4e0d\u652f\u6301\u6269\u5c55\u5907\u9009\u6e05\u5355(STLAL)\uff0c\u5982\u9700\u6269\u5c55\uff0c\u4f7f\u7528 BAPI_MATERIAL_BOM_GROUP_CREATE \u3002 \u793a\u4f8b\u4ee3\u7801 FUNCTION zfm_mat_bom_maintain IMPORTING i_mast TYPE mast i_stko TYPE stko EXPORTING e_mtype TYPE bapi_mtype e_msg TYPE bapi_msg et_bapiret2 TYPE bapiret2_t TABLES it_stpo LIKE stpo . \" \u9700\u8981\u6ce8\u610f\uff0cCSAP_MAT_BOM_MAINTAIN\u8981\u6c42\u53c2\u6570\u90fd\u662f\u5916\u90e8\u683c\u5f0f DATA l_mtype TYPE bapi_mtype . DATA l_msg TYPE bapi_msg . DATA : ls_csap_mbom TYPE csap_mbom , ls_stko_api01 TYPE stko_api01 , ls_stko_api02 TYPE stko_api02 , lt_stpo_api01 TYPE STANDARD TABLE OF stpo_api01 , ls_stpo_api01 TYPE stpo_api01 . CLEAR ls_csap_mbom . ls_csap_mbom - matnr = i_mast - matnr . ls_csap_mbom - werks = i_mast - werks . ls_csap_mbom - stlan = i_mast - stlan . ls_csap_mbom - stlal = i_mast - stlal . ls_csap_mbom - datuv = |{ i_stko - datuv DATE = USER }|. \" \u5916\u90e8\u65e5\u671f\u683c\u5f0f ls_csap_mbom - aennr = i_stko - aennr . CLEAR ls_stko_api01 . IF i_stko - bmeng IS NOT INITIAL . ls_stko_api01 - base_quan = |{ i_stko - bmeng NUMBER = USER }|. ELSE . ls_stko_api01 - base_quan = 1 . ENDIF . ls_stko_api01 - alt_text = i_stko - stktx . ls_stko_api01 - bom_status = i_stko - stlst . LOOP AT it_stpo INTO DATA ( ls_stpo ). CLEAR ls_stpo_api01 . ls_stpo_api01 - item_no = ls_stpo - posnr . \" \u884c\u53f7 ls_stpo_api01 - item_categ = 'L' . ls_stpo_api01 - component = ls_stpo - idnrk . \" \u7ec4\u4ef6\u7269\u6599 ls_stpo_api01 - comp_qty = ls_stpo - menge . \" \u7ec4\u4ef6\u6570\u91cf * ls_stpo_api03-comp_unit = ls_stpo-meins. \" \u7ec4\u4ef6\u8ba1\u91cf\u5355\u4f4d CALL FUNCTION 'CONVERSION_EXIT_CUNIT_OUTPUT' EXPORTING input = ls_stpo - meins IMPORTING output = ls_stpo_api01 - comp_unit EXCEPTIONS unit_not_found = 1 . ls_stpo_api01 - valid_from = ls_stpo - datuv . \" \u6709\u6548\u671f\u4ece ls_stpo_api01 - change_no = ls_stpo - aennr . \" \u53d8\u66f4\u53f7 ls_stpo_api01 - sortstring = ls_stpo - sortf . \" \u5de5\u5e8f\uff08\u6392\u5e8f\u5b57\u6bb5\uff09 ls_stpo_api01 - rel_prod = 'X' . ls_stpo_api01 - rel_cost = 'X' . \" \u589e\u5f3a\u5b57\u6bb5 ls_stpo_api01 - zspec1 = ls_stpo - zspec1 . ls_stpo_api01 - zspec3 = ls_stpo - zspec2 . ls_stpo_api01 - zspec2 = ls_stpo - zspec3 . INSERT ls_stpo_api01 INTO TABLE lt_stpo_api01 . ENDLOOP . * \" CSAP_MAT_BOM_MAINTAIN\u9650\u5236\uff0c\u65e0\u6cd5\u6269\u5c55\u5907\u9009BOM * \" \u8df3\u8f6c\u5230\u53e6\u4e00\u4e2a\u65b9\u6cd5\uff0c\u901a\u8fc7BAPI_MATERIAL_BOM_GROUP_CREATE\u521b\u5efa * IF ls_csap_mbom-stlal <> '01'. * CALL FUNCTION 'ZFM_MAT_BGR_CREATE' * EXPORTING * i_mast = i_mast * i_stko = i_stko * IMPORTING * e_mtype = e_mtype * e_msg = e_msg * TABLES * it_stpo = it_stpo[]. * IF e_mtype = 'E'. * RETURN. * ENDIF. * ENDIF. \" \u68c0\u67e5\u662f\u5426\u5df2\u5b58\u5728 DATA : lt_stko_api02_old TYPE STANDARD TABLE OF stko_api02 , lt_stpo_api02_old TYPE STANDARD TABLE OF stpo_api02 . CALL FUNCTION 'CSAP_MAT_BOM_READ' EXPORTING material = ls_csap_mbom - matnr plant = ls_csap_mbom - werks bom_usage = ls_csap_mbom - stlan alternative = ls_csap_mbom - stlal valid_from = ls_csap_mbom - datuv change_no = ls_csap_mbom - aennr TABLES t_stpo = lt_stpo_api02_old t_stko = lt_stko_api02_old EXCEPTIONS error = 1 OTHERS = 2 . IF sy - subrc = 0 . READ TABLE lt_stko_api02_old INTO DATA ( ls_stko_api02_upd ) INDEX 1 . \" \u89c1LCSDIFEH\u4e2d\u7684rc29k_stko_compare\u5b50\u4f8b\u7a0b\uff0c\u62ac\u5934\u53ea\u6709\u90e8\u5206\u5b57\u6bb5\u53ef\u4fee\u6539 \" \u6570\u91cf\u3001\u5355\u4f4d\u3001\u62ac\u5934\u6587\u672c\u90fd\u4e0d\u5728\u4fee\u6539\u8303\u56f4\u5185 * ls_stko_api02_upd-alt_text = ls_stko_api01-alt_text. ls_stko_api01 = CORRESPONDING # ( ls_stko_api02_upd ). DATA lt_stpo_api03 TYPE STANDARD TABLE OF stpo_api03 . SORT lt_stpo_api01 BY item_no . SORT lt_stpo_api02_old BY item_no . \" \u4fee\u6539 LOOP AT lt_stpo_api01 INTO ls_stpo_api01 . READ TABLE lt_stpo_api02_old INTO DATA ( ls_stpo_api02_upd ) WITH KEY item_no = ls_stpo_api01 - item_no BINARY SEARCH . IF sy - subrc = 0 . DELETE lt_stpo_api02_old INDEX sy - tabix . ls_stpo_api02_upd - item_no = ls_stpo_api01 - item_no . ls_stpo_api02_upd - item_categ = ls_stpo_api01 - item_categ . ls_stpo_api02_upd - component = ls_stpo_api01 - component . ls_stpo_api02_upd - comp_qty = ls_stpo_api01 - comp_qty . ls_stpo_api02_upd - comp_unit = ls_stpo_api01 - comp_unit . ls_stpo_api02_upd - valid_from = ls_stpo_api01 - valid_from . ls_stpo_api02_upd - change_no = ls_stpo_api01 - change_no . ls_stpo_api02_upd - rel_prod = ls_stpo_api01 - rel_prod . ls_stpo_api02_upd - rel_cost = ls_stpo_api01 - rel_cost . ls_stpo_api02_upd - zspec1 = ls_stpo_api01 - zspec1 . ls_stpo_api02_upd - zspec2 = ls_stpo_api01 - zspec2 . ls_stpo_api02_upd - zspec3 = ls_stpo_api01 - zspec3 . INSERT CORRESPONDING # ( ls_stpo_api02_upd ) INTO TABLE lt_stpo_api03 . ELSE . INSERT CORRESPONDING # ( ls_stpo_api01 ) INTO TABLE lt_stpo_api03 . ENDIF . ENDLOOP . \" \u5220\u9664\u591a\u4f59\u7684\u65e7\u9879\u76ee LOOP AT lt_stpo_api02_old INTO DATA ( ls_stpo_api02_del ). ls_stpo_api02_del - fldelete = abap_true . INSERT CORRESPONDING # ( ls_stpo_api02_del ) INTO TABLE lt_stpo_api03 . ENDLOOP . SORT lt_stpo_api03 BY item_no . SET UPDATE TASK LOCAL . CALL FUNCTION 'CSAP_MAT_BOM_MAINTAIN' EXPORTING material = ls_csap_mbom - matnr plant = ls_csap_mbom - werks bom_usage = ls_csap_mbom - stlan alternative = ls_csap_mbom - stlal valid_from = ls_csap_mbom - datuv change_no = ls_csap_mbom - aennr i_stko = ls_stko_api01 fl_bom_create = 'X' fl_new_item = 'X' IMPORTING o_stko = ls_stko_api02 TABLES t_stpo = lt_stpo_api03 EXCEPTIONS error = 1 OTHERS = 2 . ELSE . SET UPDATE TASK LOCAL . CALL FUNCTION 'CSAP_MAT_BOM_CREATE' EXPORTING material = ls_csap_mbom - matnr plant = ls_csap_mbom - werks bom_usage = ls_csap_mbom - stlan alternative = ls_csap_mbom - stlal valid_from = ls_csap_mbom - datuv change_no = ls_csap_mbom - aennr i_stko = ls_stko_api01 IMPORTING bom_no = ls_stko_api02 - bom_no TABLES t_stpo = lt_stpo_api01 EXCEPTIONS error = 1 OTHERS = 2 . ENDIF . IF sy - subrc <> 0 . e_mtype = 'E' . MESSAGE ID sy - msgid TYPE sy - msgty NUMBER sy - msgno WITH sy - msgv1 sy - msgv2 sy - msgv3 sy - msgv4 INTO e_msg . MESSAGE e_msg TYPE 'S' DISPLAY LIKE 'E' . CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK' . ELSE . e_mtype = 'S' . e_msg = | \u5df2\u5904\u7406 |. MESSAGE e_msg TYPE 'S' . CALL FUNCTION 'BAPI_TRANSACTION_COMMIT' EXPORTING wait = 'X' . ENDIF . ENDFUNCTION .","title":"(M) \u7269\u6599BOM"},{"location":"master_data/bom/#m-bom_1","text":"\u901a\u8fc7 BAPI_MATERIAL_BOM_GROUP_CREATE \u5b9e\u73b0\u591a\u4e2a\u5907\u9009BOM\u7684\u521b\u5efa\u3002 \u793a\u4f8b\u4ee3\u7801 FUNCTION zfm_mat_bgr_create IMPORTING i_mast TYPE mast i_stko TYPE stko EXPORTING e_mtype TYPE bapi_mtype e_msg TYPE bapi_msg et_bapiret2 TYPE bapiret2_t TABLES it_stpo LIKE stpo . DATA l_mtype TYPE bapi_mtype . DATA l_msg TYPE bapi_msg . DATA : testrun TYPE bapiflag , lt_bomgroup TYPE STANDARD TABLE OF bapi1080_bgr_c , ls_bomgroup TYPE bapi1080_bgr_c , lt_variants TYPE STANDARD TABLE OF bapi1080_bom_c , ls_variants TYPE bapi1080_bom_c , lt_materialrelations TYPE STANDARD TABLE OF bapi1080_mbm_c , ls_materialrelations TYPE bapi1080_mbm_c , lt_items TYPE STANDARD TABLE OF bapi1080_itm_c , ls_items TYPE bapi1080_itm_c , lt_itemassignments TYPE STANDARD TABLE OF bapi1080_rel_itm_bom_c , ls_itemassignments TYPE bapi1080_rel_itm_bom_c , lt_bomsubitems TYPE STANDARD TABLE OF bapi1080_sui_c , lt_bomsubitemas TYPE STANDARD TABLE OF bapi1080_rel_sui_itm_c , lt_texts TYPE STANDARD TABLE OF bapi1080_txt_c . \" \u6807\u8bc6 DATA l_uuid TYPE sysuuid_c32 . TRY . l_uuid = cl_system_uuid => create_uuid_c32_static ( ). CATCH cx_uuid_error . l_uuid = sy - datum && sy - uzeit && sy - uname . ENDTRY . \" \u65b0\u589e/\u7ef4\u62a4 DATA l_funciton TYPE cs_function . SELECT SINGLE COUNT ( * ) FROM mast WHERE matnr = @ i_mast - matnr AND werks = @ i_mast - werks AND stlan = @ i_mast - stlan AND stlal = @ i_mast - stlal . IF sy - subrc = 0 . \" \u4fee\u6539\u7528CSAP_MAT_BOM_MAINTAIN\uff0c\u8fd9\u4e2a\u65b9\u6cd5\u662f\u4e3a\u4e86\u6269\u5c55\u5907\u9009BOM e_mtype = 'S' . e_msg = '\u5df2\u5904\u7406' . RETURN . ELSE . l_funciton = 'NEW' . ENDIF . \" OBJECT_TYPE\u7684\u57df\u503c\uff0c\u4e5f\u5907\u6ce8\u4e0b\uff0c\u514d\u5f97\u770b\u4e0d\u61c2 \" BGR - Bill of material group \" BOM - Material BOM assembly variant/alternative \" ITM - BOM item \" SUI - BOM Sub-Item \" OBJECT ID DATA l_head_object_id TYPE cs_object_id . l_head_object_id = 'HEAD' . CLEAR ls_bomgroup . ls_bomgroup - bom_group_identification = l_uuid . ls_bomgroup - object_type = 'BGR' . ls_bomgroup - object_id = l_head_object_id . ls_bomgroup - bom_usage = i_mast - stlan . \" BOM\u7528\u9014 ls_bomgroup - created_in_plant = i_mast - werks . \" \u5de5\u5382 INSERT ls_bomgroup INTO TABLE lt_bomgroup . \" \uff1f\uff1f\uff1f\u4e3a\u4ec0\u4e48\u6ca1\u6709STLTY\u53c2\u6570 CLEAR ls_variants . ls_variants - bom_group_identification = l_uuid . ls_variants - object_type = 'BOM' . ls_variants - object_id = l_head_object_id . ls_variants - alternative_bom = i_mast - stlal . \" \u5907\u9009\u7269\u6599\u6e05\u5355 ls_variants - alt_text = i_stko - stktx . \" \u6587\u672c ls_variants - bom_status = i_stko - stlst . \" BOM\u72b6\u6001 ls_variants - change_no = i_stko - aennr . \" \u53d8\u66f4\u53f7 ls_variants - valid_from_date = i_stko - datuv . ls_variants - function = l_funciton . INSERT ls_variants INTO TABLE lt_variants . CLEAR ls_materialrelations . ls_materialrelations - bom_group_identification = l_uuid . ls_materialrelations - material = ls_materialrelations - material_guid = ls_materialrelations - material_external = ls_materialrelations - material_long = i_mast - matnr . \" \u7269\u6599\u7f16\u7801 ls_materialrelations - plant = i_mast - werks . \" \u5de5\u5382 ls_materialrelations - bom_usage = i_mast - stlan . \" BOM\u7528\u9014 ls_materialrelations - alternative_bom = i_mast - stlal . \" \u5907\u9009\u7269\u6599\u6e05\u5355 INSERT ls_materialrelations INTO TABLE lt_materialrelations . LOOP AT it_stpo INTO DATA ( ls_stpo ). DATA ( l_tabix ) = sy - tabix * 10 . \" OBJECT ID DATA l_item_object_id TYPE cs_object_id . l_item_object_id = | ITEM { l_tabix }|. CLEAR ls_items . ls_items - bom_group_identification = l_uuid . ls_items - object_type = 'ITM' . ls_items - object_id = l_item_object_id . ls_items - item_no = |{ ls_stpo - posnr ALPHA = IN }|. \" \u884c\u53f7 ls_items - component = ls_stpo - idnrk . \" \u7ec4\u4ef6\u7269\u6599 ls_items - comp_qty = ls_stpo - menge . \" \u7ec4\u4ef6\u6570\u91cf ls_items - comp_unit = ls_stpo - meins . \" \u7ec4\u4ef6\u8ba1\u91cf\u5355\u4f4d ls_items - ltxt_lang = '1' . ls_items - valid_from_date = ls_stpo - datuv . \" \u6709\u6548\u8d77\u59cb\u65e5\u671f ls_items - change_no = ls_stpo - aennr . \" \u53d8\u66f4\u53f7 INSERT ls_items INTO TABLE lt_items . CLEAR ls_itemassignments . ls_itemassignments - bom_group_identification = l_uuid . ls_itemassignments - sub_object_type = 'ITM' . ls_itemassignments - sub_object_id = l_item_object_id . ls_itemassignments - super_object_type = 'BOM' . ls_itemassignments - super_object_id = l_head_object_id . ls_itemassignments - valid_from_date = sy - datum . ls_itemassignments - function = l_funciton . INSERT ls_itemassignments INTO TABLE lt_itemassignments . ENDLOOP . CALL FUNCTION 'BAPI_MATERIAL_BOM_GROUP_CREATE' EXPORTING all_error = 'X' TABLES bomgroup = lt_bomgroup variants = lt_variants items = lt_items materialrelations = lt_materialrelations itemassignments = lt_itemassignments return = et_bapiret2[] . CLEAR l_mtype . CLEAR l_msg . LOOP AT et_bapiret2 INTO DATA ( ls_return ) WHERE type CA 'AXE' . MESSAGE ID ls_return - id TYPE ls_return - type NUMBER ls_return - number WITH ls_return - message_v1 ls_return - message_v2 ls_return - message_v3 ls_return - message_v4 INTO l_msg . e_msg = |{ e_msg }{ l_msg } ; |. ENDLOOP . IF sy - subrc = 0 . e_mtype = 'E' . MESSAGE ID sy - msgid TYPE sy - msgty NUMBER sy - msgno WITH sy - msgv1 sy - msgv2 sy - msgv3 sy - msgv4 INTO e_msg . MESSAGE e_msg TYPE 'S' DISPLAY LIKE 'E' . CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK' . ELSE . e_mtype = 'S' . e_msg = | \u5df2\u5904\u7406 |. MESSAGE e_msg TYPE 'S' . CALL FUNCTION 'BAPI_TRANSACTION_COMMIT' EXPORTING wait = 'X' . ENDIF . ENDFUNCTION .","title":"(M) \u7269\u6599BOM\u7ec4"},{"location":"master_data/bom/#p-wbs-bom","text":"CSAP_BOM_CREATE \u521b\u5efa CSAP_BOM_MAINTAIN \u7ef4\u62a4 CSAP_BOM_READ \u8bfb\u53d6 \u793a\u4f8b\u4ee3\u7801 FUNCTION zfm_wbs_bom_maintain IMPORTING i_prps TYPE prps i_prst TYPE prst i_stko TYPE stko EXPORTING e_mtype TYPE bapi_mtype e_msg TYPE bapi_msg et_bapiret2 TYPE bapiret2_t TABLES it_stpo LIKE stpo . DATA : ls_ecsin TYPE csin , ls_stzub TYPE stzub , lt_stkob TYPE STANDARD TABLE OF stkob , ls_stkob TYPE stkob , lt_stpob TYPE STANDARD TABLE OF stpob , ls_stpob TYPE stpob . CLEAR ls_ecsin . ls_ecsin - matnr = i_prst - matnr . ls_ecsin - werks = i_prst - werks . ls_ecsin - pspnr = i_prps - pspnr . \" WBS\u7f16\u53f7 ls_ecsin - stlty = i_stko - stlty . \" BOM\u7c7b\u578b ls_ecsin - stlan = i_prst - stlan . \" BOM\u7528\u9014 \" \u6570\u91cf IF i_stko - bmeng IS NOT INITIAL . ls_ecsin - emeng = i_stko - bmeng . ELSE . ls_ecsin - emeng = 1 . ENDIF . ls_ecsin - aennr = i_prps - aennr . \" \u53d8\u66f4\u53f7 CLEAR ls_stkob . ls_stkob - stlty = i_stko - stlty . \" BOM\u7c7b\u578b ls_stkob - bmeng = i_stko - bmeng . ls_stkob - stktx = i_stko - stktx . CLEAR lt_stpob . LOOP AT it_stpo INTO DATA ( ls_stpo ). CLEAR ls_stpob . ls_stpob - posnr = ls_stpo - posnr . ls_stpob - datuv = ls_stpo - datuv . ls_stpob - stlty = ls_stpo - stlty . ls_stpob - postp = 'L' . ls_stpob - idnrk = ls_stpo - idnrk . ls_stpob - menge = ls_stpo - menge . ls_stpob - meins = ls_stpo - meins . ls_stpob - aennr = ls_stpo - aennr . ls_stpob - sortf = ls_stpo - sortf . \" \u5de5\u5e8f ls_stpob - zspec1 = ls_stpo - zspec1 . ls_stpob - zspec2 = ls_stpo - zspec2 . ls_stpob - zspec3 = ls_stpo - zspec3 . \" \u4f9b\u5e94\u5546/\u724c\u53f7/\u4ea7\u5730\u4e0d\u4e3a\u7a7a\u7684\u65f6\u5019 IF ls_stpo - zspec1 IS NOT INITIAL OR ls_stpo - zspec2 IS NOT INITIAL OR ls_stpo - zspec3 IS NOT INITIAL . ls_stpob - dspst = '1' . ENDIF . INSERT ls_stpob INTO TABLE lt_stpob . ENDLOOP . \" \u68c0\u67e5\u662f\u5426\u5df2\u5b58\u5728 DATA : lt_stkob_old TYPE STANDARD TABLE OF stkob , lt_stpob_old TYPE STANDARD TABLE OF stpob . CALL FUNCTION 'CSAI_BOM_READ' EXPORTING ecsin = ls_ecsin TABLES t_stkob = lt_stkob_old t_stpob = lt_stpob_old EXCEPTIONS error = 1 OTHERS = 2 . IF sy - subrc = 0 . \" \u62ac\u5934\u53ea\u6709\u63cf\u8ff0\u5141\u8bb8\u88ab\u4fee\u6539 READ TABLE lt_stkob_old INTO DATA ( ls_stkob_old ) INDEX 1 . ls_stkob_old - stktx = ls_stkob - stktx . ls_stkob = ls_stkob_old . SORT lt_stpob BY posnr . SORT lt_stpob_old BY posnr . \" \u4fee\u6539 LOOP AT lt_stpob REFERENCE INTO DATA ( lr_stpob ). lr_stpob -> vbkz = lr_stpob -> mvbkz = 'I' . \" \u65b0\u589e READ TABLE lt_stpob_old INTO DATA ( ls_stpob_upd ) WITH KEY posnr = lr_stpob -> posnr BINARY SEARCH . IF sy - subrc = 0 . DELETE lt_stpob_old INDEX sy - tabix . ls_stpob_upd - vbkz = ls_stpob_upd - mvbkz = 'U' . \" \u4fee\u6539 ls_stpob_upd - posnr = lr_stpob -> posnr . ls_stpob_upd - stlty = lr_stpob -> stlty . ls_stpob_upd - datuv = lr_stpob -> datuv . ls_stpob_upd - postp = lr_stpob -> postp . ls_stpob_upd - idnrk = lr_stpob -> idnrk . ls_stpob_upd - menge = lr_stpob -> menge . ls_stpob_upd - meins = lr_stpob -> meins . ls_stpob_upd - aennr = lr_stpob -> aennr . ls_stpob_upd - sortf = lr_stpob -> sortf . ls_stpob_upd - zspec1 = lr_stpob -> zspec1 . ls_stpob_upd - zspec2 = lr_stpob -> zspec2 . ls_stpob_upd - zspec3 = lr_stpob -> zspec3 . ls_stpob_upd - dspst = lr_stpob -> dspst . lr_stpob->* = ls_stpob_upd . * \" \u7528\u5b50\u9879\u76ee\uff0c\u800c\u4e0d\u662f\u76f4\u63a5\u4fee\u6539 * ls_stpob_upd-vgknt = ls_stpob_upd-stlkn. * ls_stpob_upd-vgpzl = ls_stpob_upd-stpoz. * CLEAR ls_stpob_upd-stlkn. * CLEAR ls_stpob_upd-stpoz. ENDIF . ENDLOOP . \" \u5220\u9664\u591a\u4f59\u7684\u65e7\u9879\u76ee LOOP AT lt_stpob_old INTO DATA ( ls_stpob_del ). ls_stpob_del - lkenz = abap_true . ls_stpob_del - vbkz = ls_stpob_upd - mvbkz = 'D' . \" \u5220\u9664\u6807\u8bc6 INSERT ls_stpob_del INTO TABLE lt_stpob . ENDLOOP . SORT lt_stpob BY posnr . \" \u7ef4\u62a4BOM CALL FUNCTION 'CSAI_BOM_MAINTAIN' EXPORTING ecsin = ls_ecsin estkob = ls_stkob estzub = ls_stzub IMPORTING astzub = ls_stzub TABLES t_stpob = lt_stpob EXCEPTIONS error = 1 OTHERS = 2 . ELSE . \" \u65b0\u589eBOM CALL FUNCTION 'CSAI_BOM_CREATE' EXPORTING ecsin = ls_ecsin estkob = ls_stkob estzub = ls_stzub IMPORTING astlnr = ls_stzub - stlnr TABLES t_stpob = lt_stpob EXCEPTIONS error = 1 OTHERS = 2 . ENDIF . IF sy - subrc <> 0 OR sy - msgty = 'E' . e_mtype = 'E' . MESSAGE ID sy - msgid TYPE sy - msgty NUMBER sy - msgno INTO e_msg WITH sy - msgv1 sy - msgv2 sy - msgv3 sy - msgv4 . CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK' . ELSE . e_mtype = 'S' . e_msg = | \u5df2\u5904\u7406 |. MESSAGE e_msg TYPE 'S' . CALL FUNCTION 'BAPI_TRANSACTION_COMMIT' EXPORTING wait = 'X' . ENDIF . ENDFUNCTION .","title":"(P) WBS BOM"},{"location":"master_data/bom/#bom_2","text":"\u7f51\u4e0a\u67e5\u5230BOM\u5c55\u793a\u6709\u591a\u79cd\u65b9\u6cd5\uff0c\u5927\u90e8\u5206\u6211\u90fd\u6ca1\u7528\u8fc7\uff0c\u53ea\u80fd\u6162\u6162\u8865\u5145\u4e86 \u51fd\u6570 \u8bf4\u660e CS_BOM_EXPLOSION \u901a\u7528BOM\u5c55\u5f00 CS_BOM_EXPL_MAT_V2 \u7269\u6599BOM\u5c55\u5f00 CS_BOM_EXPL_PSP_V1 WBS BOM\u5c55\u5f00 CS_BOM_EXPL_EQU_V2 \u8bbe\u5907BOM\u5c55\u5f00 CS_BOM_EXPL_KND_V1 \u8ba2\u5355BOM\u5c55\u5f00","title":"BOM\u5c55\u5f00"},{"location":"master_data/bom/#bom_3","text":"","title":"\u901a\u7528BOM\u5c55\u5f00"},{"location":"master_data/bom/#bom_4","text":"","title":"\u7269\u6599BOM\u5c55\u5f00"},{"location":"master_data/bom/#wbs-bom","text":"","title":"WBS BOM\u5c55\u5f00"},{"location":"master_data/bom/#bom_5","text":"","title":"\u8bbe\u5907BOM\u5c55\u5f00"},{"location":"master_data/bom/#bom_6","text":"","title":"\u8ba2\u5355BOM\u5c55\u5f00"},{"location":"master_data/bom/#_2","text":"BOM\u5c55\u793a\u6700\u5927\u7684\u95ee\u9898\u5e94\u8be5\u662f\u6027\u80fd\u4e86\uff0c\u4e00\u822c\u7528\u5e76\u53d1\u7684\u65b9\u6cd5\u6765\u52a0\u901f\u3002","title":"\u6027\u80fd\u4f18\u5316"},{"location":"master_data/bp/","text":"BP \u00b6 \u4e1a\u52a1\u4f19\u4f34\u7531\u591a\u4e2a\u90e8\u5206\u7ec4\u6210\uff0c\u53ef\u4ee5\u5206\u6b65\u6267\u884c\uff0c\u66f4\u53ef\u63a7\u3002 \u57fa\u7840\u4fe1\u606f \u00b6 BAPI_BUPA_CREATE_FROM_DATA \uff0c\u521b\u5efa\u4e1a\u52a1\u4f19\u4f34\u3002 BAPI_BUPA_CENTRAL_CHANGE \uff0c\u66f4\u6539\u4e1a\u52a1\u4f19\u4f34\u3002 \u89d2\u8272 \u00b6 BAPI_BUPA_ROLE_ADD_2 \uff0c\u65b0\u589e\u4e1a\u52a1\u4f19\u4f34\u89d2\u8272\u3002 \u5730\u5740 \u00b6 BAPI_BUPA_ADDRESS_ADD \uff0c\u65b0\u589e\u4e1a\u52a1\u4f19\u4f34\u5730\u5740\u3002 \u94f6\u884c \u00b6 BAPI_BUPA_BANKDETAIL_ADD \uff0c\u65b0\u589e\u4e1a\u52a1\u4f19\u4f34\u94f6\u884c\u660e\u7ec6\u3002 \u5982\u679c\u94f6\u884c\u4e0d\u5b58\u5728\uff0c\u53ef\u4ee5\u5148\u4f7f\u7528 BAPI_BANK_CREATE \u521b\u5efa\u94f6\u884c\u3002 \u4f9b\u5e94\u5546 \u00b6 VMD_EI_API \uff0c\u65b0\u589e\u5ba2\u6237\uff0c\u5e76\u5173\u8054\u4e1a\u52a1\u4f19\u4f34\u3002 \u5ba2\u6237 \u00b6 CMD_EI_API \uff0c\u65b0\u589e\u4f9b\u5e94\u5546\uff0c\u5e76\u5173\u8054\u4e1a\u52a1\u4f19\u4f34\u3002 \u5ba2\u5546 \u00b6 \u793a\u4f8b\u4ee3\u7801 TYPES : BEGIN OF ty_input , partner TYPE but000 - partner , bu_group TYPE string , partner_kind TYPE string , name_org1 TYPE string , name_org2 TYPE string , name_org3 TYPE string , name_org4 TYPE string , street TYPE string , \" \u6ce8\u518c\u5730\u5740 country TYPE string , tel_number TYPE string , langu TYPE string , idnumber TYPE string , banks TYPE string , \" \u94f6\u884c\u6240\u5728\u56fd\u5bb6 bankl TYPE string , \" \u94f6\u884c\u4ee3\u7801 bankn TYPE string , \" \u94f6\u884c\u8d26\u6237 koinh TYPE string , \" \u94f6\u884c\u6301\u6709\u4eba bukrs TYPE string , \" \u516c\u53f8 akont TYPE string , \" \u7edf\u9a6d\u79d1\u76ee waers TYPE string , \" \u8d27\u5e01 END OF ty_input . TYPES tt_input TYPE STANDARD TABLE OF ty_input WITH EMPTY KEY . DATA lt_input TYPE tt_input . DATA lt_bapi_data TYPE cvis_ei_extern_t . DATA ls_bapi_data TYPE cvis_ei_extern . DATA l_task TYPE cmd_ei_object_task VALUE 'M' . SELECT ds~partner , but000~partner_guid FROM @ lt_input AS ds LEFT JOIN but000 ON ds~partner = but000~partner INTO TABLE @ DATA ( lt_but000 ). SORT lt_but000 BY partner . DELETE ADJACENT DUPLICATES FROM lt_but000 COMPARING partner . \" \u8003\u8651\u4e00\u4e2a\u5ba2\u5546\u53ef\u80fd\u4f1a\u6709\u591a\u884c\uff0c\u5148\u96c6\u4e2d\u5206\u914dGUID DATA l_partner_guid TYPE abap_bool . LOOP AT lt_but000 REFERENCE INTO DATA ( lr_but000 ) WHERE partner_guid IS INITIAL . TRY . l_partner_guid = cl_system_uuid => if_system_uuid_static~create_uuid_x16 ( ). CATCH cx_root . CONTINUE . ENDTRY . ENDLOOP . \" BAPI\u5b57\u6bb5\u5199\u5165 LOOP AT lt_input INTO DATA ( ls_input ). CLEAR ls_bapi_data . \" \u6807\u8bc6\u9700\u8981\u66f4\u65b0\u7684\u533a\u57df DATA l_customer TYPE abap_bool . DATA l_vender TYPE abap_bool . CLEAR l_customer . CLEAR l_vender . CASE ls_input - partner_kind . WHEN '1' . l_customer = abap_true . WHEN '2' . l_vender = abap_true . WHEN '3' . l_customer = abap_true . l_vender = abap_true . WHEN OTHERS . CONTINUE . ENDCASE . ls_input - partner = |{ ls_input - partner ALPHA = IN }|. \" \u83b7\u53d6\u5206\u914d\u7684GUID\u5b57\u6bb5 READ TABLE lt_but000 INTO DATA ( ls_but000 ) WITH KEY partner = ls_input - partner BINARY SEARCH . IF sy - subrc <> 0 . CONTINUE . ENDIF . IF ls_but000 - partner_guid IS INITIAL . CONTINUE . ENDIF . \" \u9ed8\u8ba4\u503c ls_input - langu = '1' . \" 1\uff0cZH \" \u62ac\u5934\u6570\u636e ls_bapi_data - partner - header - object_task = l_task . ls_bapi_data - partner - header - object_instance - bpartner = ls_but000 - partner . ls_bapi_data - partner - header - object_instance - bpartnerguid = ls_but000 - partner_guid . \" \u5206\u7ec4 ls_bapi_data - partner - central_data - common - data - bp_control - category = '2' . \" \u9ed8\u8ba4\u7ec4\u7ec7 ls_bapi_data - partner - central_data - common - data - bp_control - grouping = ls_input - bu_group . \" \u89d2\u8272 DATA ls_role TYPE bus_ei_bupa_roles . CLEAR ls_role . ls_role - task = l_task . ls_role - data - valid_from = sy - datum . ls_role - datax - valid_from = 'X' . ls_role - data - valid_to = '99991231' . ls_role - datax - valid_to = 'X' . IF l_customer = abap_true . ls_role - data_key = 'FLCU00' . ls_role - data - rolecategory = ls_role - data_key . INSERT ls_role INTO TABLE ls_bapi_data - partner - central_data - role - roles . ls_role - data_key = 'FLCU01' . ls_role - data - rolecategory = ls_role - data_key . INSERT ls_role INTO TABLE ls_bapi_data - partner - central_data - role - roles . ENDIF . IF l_vender = abap_true . ls_role - data_key = 'FLVN00' . ls_role - data - rolecategory = ls_role - data_key . INSERT ls_role INTO TABLE ls_bapi_data - partner - central_data - role - roles . ls_role - data_key = 'FLVN01' . ls_role - data - rolecategory = ls_role - data_key . INSERT ls_role INTO TABLE ls_bapi_data - partner - central_data - role - roles . ENDIF . \" \u540d\u79f0 ls_bapi_data - partner - central_data - common - data - bp_organization - name1 = ls_input - name_org1 . ls_bapi_data - partner - central_data - common - data - bp_organization - name2 = ls_input - name_org2 . ls_bapi_data - partner - central_data - common - data - bp_organization - name3 = ls_input - name_org3 . ls_bapi_data - partner - central_data - common - data - bp_organization - name4 = ls_input - name_org4 . ls_bapi_data - partner - central_data - common - datax - bp_organization - name1 = abap_true . ls_bapi_data - partner - central_data - common - datax - bp_organization - name2 = abap_true . ls_bapi_data - partner - central_data - common - datax - bp_organization - name3 = abap_true . ls_bapi_data - partner - central_data - common - datax - bp_organization - name4 = abap_true . \" \u8054\u7cfb\u65b9\u6cd5 DATA ls_address TYPE bus_ei_bupa_address . DATA ls_phone TYPE bus_ei_bupa_telephone . CLEAR ls_address . CLEAR ls_phone . ls_address - task = l_task . ls_address - data_key - operation = 'XXDFLT' . \" \u6807\u51c6 ls_address - data - postal - data - street = ls_input - street . ls_address - data - postal - data - country = ls_input - country . ls_address - data - postal - data - langu = ls_input - langu . IF ls_input - tel_number IS NOT INITIAL . ls_phone - contact - task = l_task . ls_phone - contact - data - country = ls_input - country . ls_phone - contact - data - telephone = ls_input - tel_number . ls_phone - contact - datax - country = abap_true . ls_phone - contact - datax - telephone = abap_true . INSERT ls_phone INTO TABLE ls_address - data - communication - phone - phone . ENDIF . INSERT ls_address INTO TABLE ls_bapi_data - partner - central_data - address - addresses . \" \u6807\u8bc6 DATA ls_identification TYPE bus_ei_bupa_identification . CLEAR ls_identification . ls_identification - task = l_task . ls_identification - data_key - identificationcategory = 'Z00001' . ls_identification - data_key - identificationnumber = ls_input - idnumber . INSERT ls_identification INTO TABLE ls_bapi_data - partner - central_data - ident_number - ident_numbers . \" \u94f6\u884c DATA ls_bank TYPE bus_ei_bupa_bankdetail . CLEAR ls_bank . ls_bank - task = l_task . ls_bank - data_key = '0001' . \" \u56fa\u5b9a\uff0c\u4e0d\u4f1a\u4f20\u4e24\u4e2a\u94f6\u884c\u6570\u636e\u5427\uff1f ls_bank - data - bank_ctry = ls_input - banks . ls_bank - datax - bank_ctry = abap_true . ls_bank - data - bank_key = ls_input - bankl . ls_bank - datax - bank_key = abap_true . ls_bank - data - bank_acct = ls_input - bankn . ls_bank - datax - bank_acct = abap_true . ls_bank - data - accountholder = ls_input - koinh . ls_bank - datax - accountholder = abap_true . INSERT ls_bank INTO TABLE ls_bapi_data - partner - central_data - bankdetail - bankdetails . \" \u4f9b\u5e94\u5546\u91c7\u8d2d\u7ec4\u7ec7\u6570\u636e IF l_customer = abap_true . ls_bapi_data - customer - header - object_task = l_task . ls_bapi_data - customer - header - object_instance - kunnr = ls_but000 - partner . DATA ls_company_custoner TYPE cmds_ei_company . DATA ls_sale TYPE cmds_ei_sales . \" \u5ba2\u6237\u516c\u53f8\u6570\u636e CLEAR ls_company_custoner . ls_company_custoner - task = l_task . ls_company_custoner - data_key - bukrs = ls_input - bukrs . ls_company_custoner - data - zterm = 'Z001' . ls_company_custoner - datax - zterm = abap_true . ls_company_custoner - data - zuawa = '0009' . ls_company_custoner - datax - zuawa = abap_true . ls_company_custoner - data - akont = ls_input - akont . ls_company_custoner - datax - akont = abap_true . INSERT ls_company_custoner INTO TABLE ls_bapi_data - customer - company_data - company . \" \u5ba2\u6237\u9500\u552e\u6570\u636e CLEAR ls_sale . ls_sale - task = l_task . ls_sale - data_key - vkorg = ls_input - bukrs . ls_sale - data_key - spart = '10' . ls_sale - data_key - vtweg = '10' . ls_sale - data - kalks = 'B' . ls_sale - datax - kalks = abap_true . ls_sale - data - versg = '1' . ls_sale - datax - versg = abap_true . ls_sale - data - vsbed = '1' . ls_sale - datax - vsbed = abap_true . ls_sale - data - waers = ls_input - waers . ls_sale - datax - waers = abap_true . INSERT ls_sale INTO TABLE ls_bapi_data - customer - sales_data - sales . ENDIF . IF l_vender = abap_true . ls_bapi_data - vendor - header - object_task = l_task . ls_bapi_data - vendor - header - object_instance - lifnr = ls_but000 - partner . DATA ls_company_vendor TYPE vmds_ei_company . DATA ls_purchasing TYPE vmds_ei_purchasing . \" \u4f9b\u5e94\u5546\u516c\u53f8\u6570\u636e CLEAR ls_company_vendor . ls_company_vendor - task = l_task . ls_company_vendor - data_key - bukrs = ls_input - bukrs . ls_company_vendor - data - zterm = 'Z001' . ls_company_vendor - datax - zterm = abap_true . ls_company_vendor - data - zuawa = '0009' . ls_company_vendor - datax - zuawa = abap_true . ls_company_vendor - data - akont = ls_input - akont . ls_company_vendor - datax - akont = abap_true . INSERT ls_company_vendor INTO TABLE ls_bapi_data - vendor - company_data - company . \" \u4f9b\u5e94\u5546\u91c7\u8d2d\u6570\u636e CLEAR ls_purchasing . ls_purchasing - task = l_task . ls_purchasing - data_key - ekorg = ls_input - bukrs . ls_purchasing - data - zterm = 'Z001' . ls_purchasing - data - kalsk = 'Z8' . ls_purchasing - datax - kalsk = abap_true . ls_purchasing - data - webre = 'X' . ls_purchasing - datax - webre = abap_true . * ls_purchasing-data-zterm = 'X'. * ls_purchasing-datax-zterm = abap_true. ls_purchasing - data - waers = ls_input - waers . ls_purchasing - datax - waers = abap_true . INSERT ls_purchasing INTO TABLE ls_bapi_data - vendor - purchasing_data - purchasing . ENDIF . INSERT ls_bapi_data INTO TABLE lt_bapi_data . ENDLOOP . DATA lt_bapiretm TYPE bapiretm . CALL METHOD cl_md_bp_maintain => maintain EXPORTING i_data = lt_bapi_data IMPORTING e_return = lt_bapiretm . IF sy - subrc = 0 . CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK' . ELSE . CALL FUNCTION 'BAPI_TRANSACTION_COMMIT' EXPORTING wait = 'X' . ENDIF .","title":"\u4e1a\u52a1\u4f19\u4f34"},{"location":"master_data/bp/#bp","text":"\u4e1a\u52a1\u4f19\u4f34\u7531\u591a\u4e2a\u90e8\u5206\u7ec4\u6210\uff0c\u53ef\u4ee5\u5206\u6b65\u6267\u884c\uff0c\u66f4\u53ef\u63a7\u3002","title":"BP"},{"location":"master_data/bp/#_1","text":"BAPI_BUPA_CREATE_FROM_DATA \uff0c\u521b\u5efa\u4e1a\u52a1\u4f19\u4f34\u3002 BAPI_BUPA_CENTRAL_CHANGE \uff0c\u66f4\u6539\u4e1a\u52a1\u4f19\u4f34\u3002","title":"\u57fa\u7840\u4fe1\u606f"},{"location":"master_data/bp/#_2","text":"BAPI_BUPA_ROLE_ADD_2 \uff0c\u65b0\u589e\u4e1a\u52a1\u4f19\u4f34\u89d2\u8272\u3002","title":"\u89d2\u8272"},{"location":"master_data/bp/#_3","text":"BAPI_BUPA_ADDRESS_ADD \uff0c\u65b0\u589e\u4e1a\u52a1\u4f19\u4f34\u5730\u5740\u3002","title":"\u5730\u5740"},{"location":"master_data/bp/#_4","text":"BAPI_BUPA_BANKDETAIL_ADD \uff0c\u65b0\u589e\u4e1a\u52a1\u4f19\u4f34\u94f6\u884c\u660e\u7ec6\u3002 \u5982\u679c\u94f6\u884c\u4e0d\u5b58\u5728\uff0c\u53ef\u4ee5\u5148\u4f7f\u7528 BAPI_BANK_CREATE \u521b\u5efa\u94f6\u884c\u3002","title":"\u94f6\u884c"},{"location":"master_data/bp/#_5","text":"VMD_EI_API \uff0c\u65b0\u589e\u5ba2\u6237\uff0c\u5e76\u5173\u8054\u4e1a\u52a1\u4f19\u4f34\u3002","title":"\u4f9b\u5e94\u5546"},{"location":"master_data/bp/#_6","text":"CMD_EI_API \uff0c\u65b0\u589e\u4f9b\u5e94\u5546\uff0c\u5e76\u5173\u8054\u4e1a\u52a1\u4f19\u4f34\u3002","title":"\u5ba2\u6237"},{"location":"master_data/bp/#_7","text":"\u793a\u4f8b\u4ee3\u7801 TYPES : BEGIN OF ty_input , partner TYPE but000 - partner , bu_group TYPE string , partner_kind TYPE string , name_org1 TYPE string , name_org2 TYPE string , name_org3 TYPE string , name_org4 TYPE string , street TYPE string , \" \u6ce8\u518c\u5730\u5740 country TYPE string , tel_number TYPE string , langu TYPE string , idnumber TYPE string , banks TYPE string , \" \u94f6\u884c\u6240\u5728\u56fd\u5bb6 bankl TYPE string , \" \u94f6\u884c\u4ee3\u7801 bankn TYPE string , \" \u94f6\u884c\u8d26\u6237 koinh TYPE string , \" \u94f6\u884c\u6301\u6709\u4eba bukrs TYPE string , \" \u516c\u53f8 akont TYPE string , \" \u7edf\u9a6d\u79d1\u76ee waers TYPE string , \" \u8d27\u5e01 END OF ty_input . TYPES tt_input TYPE STANDARD TABLE OF ty_input WITH EMPTY KEY . DATA lt_input TYPE tt_input . DATA lt_bapi_data TYPE cvis_ei_extern_t . DATA ls_bapi_data TYPE cvis_ei_extern . DATA l_task TYPE cmd_ei_object_task VALUE 'M' . SELECT ds~partner , but000~partner_guid FROM @ lt_input AS ds LEFT JOIN but000 ON ds~partner = but000~partner INTO TABLE @ DATA ( lt_but000 ). SORT lt_but000 BY partner . DELETE ADJACENT DUPLICATES FROM lt_but000 COMPARING partner . \" \u8003\u8651\u4e00\u4e2a\u5ba2\u5546\u53ef\u80fd\u4f1a\u6709\u591a\u884c\uff0c\u5148\u96c6\u4e2d\u5206\u914dGUID DATA l_partner_guid TYPE abap_bool . LOOP AT lt_but000 REFERENCE INTO DATA ( lr_but000 ) WHERE partner_guid IS INITIAL . TRY . l_partner_guid = cl_system_uuid => if_system_uuid_static~create_uuid_x16 ( ). CATCH cx_root . CONTINUE . ENDTRY . ENDLOOP . \" BAPI\u5b57\u6bb5\u5199\u5165 LOOP AT lt_input INTO DATA ( ls_input ). CLEAR ls_bapi_data . \" \u6807\u8bc6\u9700\u8981\u66f4\u65b0\u7684\u533a\u57df DATA l_customer TYPE abap_bool . DATA l_vender TYPE abap_bool . CLEAR l_customer . CLEAR l_vender . CASE ls_input - partner_kind . WHEN '1' . l_customer = abap_true . WHEN '2' . l_vender = abap_true . WHEN '3' . l_customer = abap_true . l_vender = abap_true . WHEN OTHERS . CONTINUE . ENDCASE . ls_input - partner = |{ ls_input - partner ALPHA = IN }|. \" \u83b7\u53d6\u5206\u914d\u7684GUID\u5b57\u6bb5 READ TABLE lt_but000 INTO DATA ( ls_but000 ) WITH KEY partner = ls_input - partner BINARY SEARCH . IF sy - subrc <> 0 . CONTINUE . ENDIF . IF ls_but000 - partner_guid IS INITIAL . CONTINUE . ENDIF . \" \u9ed8\u8ba4\u503c ls_input - langu = '1' . \" 1\uff0cZH \" \u62ac\u5934\u6570\u636e ls_bapi_data - partner - header - object_task = l_task . ls_bapi_data - partner - header - object_instance - bpartner = ls_but000 - partner . ls_bapi_data - partner - header - object_instance - bpartnerguid = ls_but000 - partner_guid . \" \u5206\u7ec4 ls_bapi_data - partner - central_data - common - data - bp_control - category = '2' . \" \u9ed8\u8ba4\u7ec4\u7ec7 ls_bapi_data - partner - central_data - common - data - bp_control - grouping = ls_input - bu_group . \" \u89d2\u8272 DATA ls_role TYPE bus_ei_bupa_roles . CLEAR ls_role . ls_role - task = l_task . ls_role - data - valid_from = sy - datum . ls_role - datax - valid_from = 'X' . ls_role - data - valid_to = '99991231' . ls_role - datax - valid_to = 'X' . IF l_customer = abap_true . ls_role - data_key = 'FLCU00' . ls_role - data - rolecategory = ls_role - data_key . INSERT ls_role INTO TABLE ls_bapi_data - partner - central_data - role - roles . ls_role - data_key = 'FLCU01' . ls_role - data - rolecategory = ls_role - data_key . INSERT ls_role INTO TABLE ls_bapi_data - partner - central_data - role - roles . ENDIF . IF l_vender = abap_true . ls_role - data_key = 'FLVN00' . ls_role - data - rolecategory = ls_role - data_key . INSERT ls_role INTO TABLE ls_bapi_data - partner - central_data - role - roles . ls_role - data_key = 'FLVN01' . ls_role - data - rolecategory = ls_role - data_key . INSERT ls_role INTO TABLE ls_bapi_data - partner - central_data - role - roles . ENDIF . \" \u540d\u79f0 ls_bapi_data - partner - central_data - common - data - bp_organization - name1 = ls_input - name_org1 . ls_bapi_data - partner - central_data - common - data - bp_organization - name2 = ls_input - name_org2 . ls_bapi_data - partner - central_data - common - data - bp_organization - name3 = ls_input - name_org3 . ls_bapi_data - partner - central_data - common - data - bp_organization - name4 = ls_input - name_org4 . ls_bapi_data - partner - central_data - common - datax - bp_organization - name1 = abap_true . ls_bapi_data - partner - central_data - common - datax - bp_organization - name2 = abap_true . ls_bapi_data - partner - central_data - common - datax - bp_organization - name3 = abap_true . ls_bapi_data - partner - central_data - common - datax - bp_organization - name4 = abap_true . \" \u8054\u7cfb\u65b9\u6cd5 DATA ls_address TYPE bus_ei_bupa_address . DATA ls_phone TYPE bus_ei_bupa_telephone . CLEAR ls_address . CLEAR ls_phone . ls_address - task = l_task . ls_address - data_key - operation = 'XXDFLT' . \" \u6807\u51c6 ls_address - data - postal - data - street = ls_input - street . ls_address - data - postal - data - country = ls_input - country . ls_address - data - postal - data - langu = ls_input - langu . IF ls_input - tel_number IS NOT INITIAL . ls_phone - contact - task = l_task . ls_phone - contact - data - country = ls_input - country . ls_phone - contact - data - telephone = ls_input - tel_number . ls_phone - contact - datax - country = abap_true . ls_phone - contact - datax - telephone = abap_true . INSERT ls_phone INTO TABLE ls_address - data - communication - phone - phone . ENDIF . INSERT ls_address INTO TABLE ls_bapi_data - partner - central_data - address - addresses . \" \u6807\u8bc6 DATA ls_identification TYPE bus_ei_bupa_identification . CLEAR ls_identification . ls_identification - task = l_task . ls_identification - data_key - identificationcategory = 'Z00001' . ls_identification - data_key - identificationnumber = ls_input - idnumber . INSERT ls_identification INTO TABLE ls_bapi_data - partner - central_data - ident_number - ident_numbers . \" \u94f6\u884c DATA ls_bank TYPE bus_ei_bupa_bankdetail . CLEAR ls_bank . ls_bank - task = l_task . ls_bank - data_key = '0001' . \" \u56fa\u5b9a\uff0c\u4e0d\u4f1a\u4f20\u4e24\u4e2a\u94f6\u884c\u6570\u636e\u5427\uff1f ls_bank - data - bank_ctry = ls_input - banks . ls_bank - datax - bank_ctry = abap_true . ls_bank - data - bank_key = ls_input - bankl . ls_bank - datax - bank_key = abap_true . ls_bank - data - bank_acct = ls_input - bankn . ls_bank - datax - bank_acct = abap_true . ls_bank - data - accountholder = ls_input - koinh . ls_bank - datax - accountholder = abap_true . INSERT ls_bank INTO TABLE ls_bapi_data - partner - central_data - bankdetail - bankdetails . \" \u4f9b\u5e94\u5546\u91c7\u8d2d\u7ec4\u7ec7\u6570\u636e IF l_customer = abap_true . ls_bapi_data - customer - header - object_task = l_task . ls_bapi_data - customer - header - object_instance - kunnr = ls_but000 - partner . DATA ls_company_custoner TYPE cmds_ei_company . DATA ls_sale TYPE cmds_ei_sales . \" \u5ba2\u6237\u516c\u53f8\u6570\u636e CLEAR ls_company_custoner . ls_company_custoner - task = l_task . ls_company_custoner - data_key - bukrs = ls_input - bukrs . ls_company_custoner - data - zterm = 'Z001' . ls_company_custoner - datax - zterm = abap_true . ls_company_custoner - data - zuawa = '0009' . ls_company_custoner - datax - zuawa = abap_true . ls_company_custoner - data - akont = ls_input - akont . ls_company_custoner - datax - akont = abap_true . INSERT ls_company_custoner INTO TABLE ls_bapi_data - customer - company_data - company . \" \u5ba2\u6237\u9500\u552e\u6570\u636e CLEAR ls_sale . ls_sale - task = l_task . ls_sale - data_key - vkorg = ls_input - bukrs . ls_sale - data_key - spart = '10' . ls_sale - data_key - vtweg = '10' . ls_sale - data - kalks = 'B' . ls_sale - datax - kalks = abap_true . ls_sale - data - versg = '1' . ls_sale - datax - versg = abap_true . ls_sale - data - vsbed = '1' . ls_sale - datax - vsbed = abap_true . ls_sale - data - waers = ls_input - waers . ls_sale - datax - waers = abap_true . INSERT ls_sale INTO TABLE ls_bapi_data - customer - sales_data - sales . ENDIF . IF l_vender = abap_true . ls_bapi_data - vendor - header - object_task = l_task . ls_bapi_data - vendor - header - object_instance - lifnr = ls_but000 - partner . DATA ls_company_vendor TYPE vmds_ei_company . DATA ls_purchasing TYPE vmds_ei_purchasing . \" \u4f9b\u5e94\u5546\u516c\u53f8\u6570\u636e CLEAR ls_company_vendor . ls_company_vendor - task = l_task . ls_company_vendor - data_key - bukrs = ls_input - bukrs . ls_company_vendor - data - zterm = 'Z001' . ls_company_vendor - datax - zterm = abap_true . ls_company_vendor - data - zuawa = '0009' . ls_company_vendor - datax - zuawa = abap_true . ls_company_vendor - data - akont = ls_input - akont . ls_company_vendor - datax - akont = abap_true . INSERT ls_company_vendor INTO TABLE ls_bapi_data - vendor - company_data - company . \" \u4f9b\u5e94\u5546\u91c7\u8d2d\u6570\u636e CLEAR ls_purchasing . ls_purchasing - task = l_task . ls_purchasing - data_key - ekorg = ls_input - bukrs . ls_purchasing - data - zterm = 'Z001' . ls_purchasing - data - kalsk = 'Z8' . ls_purchasing - datax - kalsk = abap_true . ls_purchasing - data - webre = 'X' . ls_purchasing - datax - webre = abap_true . * ls_purchasing-data-zterm = 'X'. * ls_purchasing-datax-zterm = abap_true. ls_purchasing - data - waers = ls_input - waers . ls_purchasing - datax - waers = abap_true . INSERT ls_purchasing INTO TABLE ls_bapi_data - vendor - purchasing_data - purchasing . ENDIF . INSERT ls_bapi_data INTO TABLE lt_bapi_data . ENDLOOP . DATA lt_bapiretm TYPE bapiretm . CALL METHOD cl_md_bp_maintain => maintain EXPORTING i_data = lt_bapi_data IMPORTING e_return = lt_bapiretm . IF sy - subrc = 0 . CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK' . ELSE . CALL FUNCTION 'BAPI_TRANSACTION_COMMIT' EXPORTING wait = 'X' . ENDIF .","title":"\u5ba2\u5546"},{"location":"master_data/material/","text":"\u7269\u6599 \u00b6 \u7269\u6599\u7ef4\u62a4 \u00b6 BAPI_MATERIAL_SAVEDATA \uff0c\u6bcf\u6b21\u53ea\u80fd\u6269\u5c55\u4e00\u4e2a\u5de5\u5382\u3002 BAPI_MATERIAL_SAVEREPLICA \uff0c\u5141\u8bb8\u6269\u5c55\u591a\u4e2a\u5de5\u5382\uff0c\u4e0b\u9762\u4f7f\u7528\u8be5\u51fd\u6570\u7ef4\u62a4\u7269\u6599\u3002 \u793a\u4f8b\u4ee3\u7801 FUNCTION zfm_demo_material_save_2 \" You can use the template 'functionModuleParameter' to add here the signature! . *&---------------------------------------------------------------------* *& \u6279\u5bfc\u6570\u636e *&---------------------------------------------------------------------* \" \u6f14\u793a\u7528\uff0c\u5047\u8bbe\u8fd9\u662f\u7a0b\u5e8f\u7684\u5165\u53c2\u548c\u51fa\u53c2 TYPES : BEGIN OF ty_data , matnr TYPE mara - matnr , mbrsh TYPE mara - mbrsh , mtart TYPE mara - mtart , maktx TYPE makt - maktx , werks TYPE werks_d , vkorg TYPE vkorg , mtype TYPE bapi_mtype , msg TYPE bapi_msg , END OF ty_data . TYPES tt_data TYPE STANDARD TABLE OF ty_data . DATA lt_data TYPE tt_data . DATA l_matnr TYPE matnr . DATA l_mtype TYPE bapi_mtype . DATA l_msg TYPE bapi_msg . *&---------------------------------------------------------------------* *& BAPI\u6570\u636e\u58f0\u660e *&---------------------------------------------------------------------* DATA l_global_data TYPE bapie1global_data . DATA : lt_headdata TYPE STANDARD TABLE OF bapie1matheader , lt_clientdata TYPE STANDARD TABLE OF bapie1mara , lt_clientdatax TYPE STANDARD TABLE OF bapie1marax , lt_plantdata TYPE STANDARD TABLE OF bapie1marc , lt_plantdatax TYPE STANDARD TABLE OF bapie1marcx , lt_forecastparameters TYPE STANDARD TABLE OF bapie1mpop , lt_forecastparametersx TYPE STANDARD TABLE OF bapie1mpopx , lt_planningdata TYPE STANDARD TABLE OF bapie1mpgd , lt_planningdatax TYPE STANDARD TABLE OF bapie1mpgdx , lt_storagelocationdata TYPE STANDARD TABLE OF bapie1mard , lt_storagelocationdatax TYPE STANDARD TABLE OF bapie1mardx , lt_valuationdata TYPE STANDARD TABLE OF bapie1mbew , lt_valuationdatax TYPE STANDARD TABLE OF bapie1mbewx , lt_warehousenumberdata TYPE STANDARD TABLE OF bapie1mlgn , lt_warehousenumberdatax TYPE STANDARD TABLE OF bapie1mlgnx , lt_salesdata TYPE STANDARD TABLE OF bapie1mvke , lt_salesdatax TYPE STANDARD TABLE OF bapie1mvkex , lt_storagetypedata TYPE STANDARD TABLE OF bapie1mlgt , lt_storagetypedatax TYPE STANDARD TABLE OF bapie1mlgtx , lt_materialdescription TYPE STANDARD TABLE OF bapie1makt , lt_unitsofmeasure TYPE STANDARD TABLE OF bapie1marm , lt_unitsofmeasurex TYPE STANDARD TABLE OF bapie1marmx , lt_internationalartnos TYPE STANDARD TABLE OF bapie1mean , lt_materiallongtext TYPE STANDARD TABLE OF bapie1mltx , lt_taxclassifications TYPE STANDARD TABLE OF bapie1mlan , lt_prtdata TYPE STANDARD TABLE OF bapie1mfhm , lt_prtdatax TYPE STANDARD TABLE OF bapie1mfhmx , lt_extensionin TYPE STANDARD TABLE OF bapie1parex , lt_extensioninx TYPE STANDARD TABLE OF bapie1parexx , lt_forecastvalues TYPE STANDARD TABLE OF bapie1mprw , lt_unplndconsumption TYPE STANDARD TABLE OF bapie1mveu , lt_totalconsumption TYPE STANDARD TABLE OF bapie1mveg . DATA : ls_headdata TYPE bapie1matheader , ls_clientdata TYPE bapie1mara , ls_clientdatax TYPE bapie1marax , ls_plantdata TYPE bapie1marc , ls_plantdatax TYPE bapie1marcx , ls_forecastparameters TYPE bapie1mpop , ls_forecastparametersx TYPE bapie1mpopx , ls_planningdata TYPE bapie1mpgd , ls_planningdatax TYPE bapie1mpgdx , ls_storagelocationdata TYPE bapie1mard , ls_storagelocationdatax TYPE bapie1mardx , ls_valuationdata TYPE bapie1mbew , ls_valuationdatax TYPE bapie1mbewx , ls_warehousenumberdata TYPE bapie1mlgn , ls_warehousenumberdatax TYPE bapie1mlgnx , ls_salesdata TYPE bapie1mvke , ls_salesdatax TYPE bapie1mvkex , ls_storagetypedata TYPE bapie1mlgt , ls_storagetypedatax TYPE bapie1mlgtx , ls_materialdescription TYPE bapie1makt , ls_unitsofmeasure TYPE bapie1marm , ls_unitsofmeasurex TYPE bapie1marmx , ls_internationalartnos TYPE bapie1mean , ls_materiallongtext TYPE bapie1mltx , ls_taxclassifications TYPE bapie1mlan , ls_prtdata TYPE bapie1mfhm , ls_prtdatax TYPE bapie1mfhmx , ls_extensionin TYPE bapie1parex , ls_extensioninx TYPE bapie1parexx , ls_forecastvalues TYPE bapie1mprw , ls_unplndconsumption TYPE bapie1mveu , ls_totalconsumption TYPE bapie1mveg . DATA : lt_return TYPE STANDARD TABLE OF bapie1ret2 , ls_return TYPE bapiret2 . *&---------------------------------------------------------------------* *& \u5206\u6279\u5904\u7406 *&---------------------------------------------------------------------* LOOP AT lt_data INTO DATA ( ls_data ) GROUP BY ( matnr = ls_data - matnr ) INTO DATA ( ls_data_grp ). \" \u4efb\u53d6\u4e00\u884c\u4f5c\u4e3a\u62ac\u5934 LOOP AT GROUP ls_data_grp INTO DATA ( ls_data_head ). EXIT . ENDLOOP . *&---------------------------------------------------------------------* *& \u7269\u6599\u53f7 *&---------------------------------------------------------------------* \" \u5927\u591a\u90fd\u662f\u5916\u90e8\u6307\u5b9a\u7269\u6599\u53f7\uff0c\u5982\u9700\u6d41\u6c34\u53ef\u81ea\u884c\u8c03\u6574 CLEAR l_matnr . CALL FUNCTION 'CONVERSION_EXIT_MATN1_INPUT' EXPORTING input = ls_data_head - matnr IMPORTING output = l_matnr EXCEPTIONS length_error = 1 OTHERS = 2 . *&---------------------------------------------------------------------* *& \u8bbe\u7f6e\u9700\u8981\u5bfc\u5165\u7684\u7269\u6599\u548c\u89c6\u56fe *&---------------------------------------------------------------------* CLEAR ls_headdata . ls_headdata - material_long = l_matnr . \" \u7269\u6599 ls_headdata - ind_sector = ls_data_head - mbrsh . \" \u884c\u4e1a\u9886\u57df ls_headdata - matl_type = ls_data_head - mtart . \" \u7269\u6599\u7c7b\u578b ls_headdata - basic_view = abap_true . ls_headdata - sales_view = abap_true . ls_headdata - purchase_view = abap_true . ls_headdata - mrp_view = abap_true . ls_headdata - forecast_view = abap_true . ls_headdata - work_sched_view = abap_true . ls_headdata - prt_view = abap_true . ls_headdata - storage_view = abap_true . ls_headdata - warehouse_view = abap_true . ls_headdata - quality_view = abap_true . ls_headdata - account_view = abap_true . ls_headdata - cost_view = abap_true . INSERT ls_headdata INTO TABLE lt_headdata . *&---------------------------------------------------------------------* *& \u57fa\u7840\u89c6\u56fe *&---------------------------------------------------------------------* DATA ls_mara_ga TYPE mara . DATA ls_bapi_mara_ga TYPE bapi_mara_ga . CLEAR ls_mara_ga . CLEAR ls_bapi_mara_ga . ls_mara_ga = CORRESPONDING # ( ls_data_head ). CALL FUNCTION 'MAP2E_MARA_TO_BAPI_MARA_GA' EXPORTING mara = ls_mara_ga CHANGING bapi_mara_ga = ls_bapi_mara_ga . CLEAR ls_clientdata . ls_clientdata = CORRESPONDING # ( ls_bapi_mara_ga ). ls_clientdata - material_long = l_matnr . CLEAR ls_clientdatax . PERFORM map_data_to_datax USING 'BAPIE1MARAX' ls_clientdata CHANGING ls_clientdatax . INSERT ls_clientdata INTO TABLE lt_clientdata . INSERT ls_clientdatax INTO TABLE lt_clientdatax . *&---------------------------------------------------------------------* *& \u5de5\u5382\u89c6\u56fe *&---------------------------------------------------------------------* DATA ls_marc_ga TYPE marc . DATA ls_bapi_marc_ga TYPE bapi_marc_ga . LOOP AT GROUP ls_data_grp INTO ls_data . CLEAR ls_marc_ga . CLEAR ls_bapi_marc_ga . ls_marc_ga = CORRESPONDING # ( ls_data ). CALL FUNCTION 'MAP2E_MARC_TO_BAPI_MARC_GA' EXPORTING marc = ls_marc_ga h_waers = 'CNY' CHANGING bapi_marc_ga = ls_bapi_marc_ga EXCEPTIONS error_converting_curr_amount = 1 . IF sy - subrc = 0 . CONTINUE . ENDIF . CLEAR ls_plantdata . ls_plantdata = CORRESPONDING # ( ls_bapi_marc_ga ). ls_plantdata - material_long = l_matnr . CLEAR ls_plantdatax . PERFORM map_data_to_datax USING 'BAPIE1MARCX' ls_plantdata CHANGING ls_plantdatax . INSERT ls_plantdata INTO TABLE lt_plantdata . INSERT ls_plantdatax INTO TABLE lt_plantdatax . ENDLOOP . SORT lt_plantdata BY plant . SORT lt_plantdatax BY plant . DELETE ADJACENT DUPLICATES FROM lt_plantdata COMPARING plant . DELETE ADJACENT DUPLICATES FROM lt_plantdatax COMPARING plant . **&---------------------------------------------------------------------* **& MPOP **&---------------------------------------------------------------------* * DATA ls_mpop_ga TYPE mpop. * DATA ls_bapi_mpop_ga TYPE bapi_mpop_ga. * * LOOP AT GROUP ls_data_grp INTO ls_data. * CLEAR ls_mpop_ga. * CLEAR ls_bapi_mpop_ga. * ls_mpop_ga = CORRESPONDING #( ls_data ). * CALL FUNCTION 'MAP2E_MPOP_TO_BAPI_MPOP_GA' * EXPORTING * mpop = ls_mpop_ga * CHANGING * bapi_mpop_ga = ls_bapi_mpop_ga. * * CLEAR ls_forecastparameters. * ls_forecastparameters = CORRESPONDING #( ls_bapi_mpop_ga ). * ls_forecastparameters-material_long = l_matnr. * * CLEAR ls_forecastparametersx. * PERFORM map_data_to_datax USING 'BAPIE1MPOPX' ls_forecastparameters CHANGING ls_forecastparametersx. * * INSERT ls_forecastparameters INTO TABLE lt_forecastparameters. * INSERT ls_forecastparametersx INTO TABLE lt_forecastparametersx. * ENDLOOP. * * SORT lt_forecastparameters BY plant. * SORT lt_forecastparametersx BY plant. * DELETE ADJACENT DUPLICATES FROM lt_forecastparameters COMPARING plant. * DELETE ADJACENT DUPLICATES FROM lt_forecastparametersx COMPARING plant. **&---------------------------------------------------------------------* **& MPGD **&---------------------------------------------------------------------* * DATA ls_mpgd_ga TYPE mpgd. * DATA ls_bapi_mpgd_ga TYPE bapi_mpgd_ga. * * LOOP AT GROUP ls_data_grp INTO ls_data. * CLEAR ls_mpgd_ga. * CLEAR ls_bapi_mpgd_ga. * ls_mpgd_ga = CORRESPONDING #( ls_data ). * CALL FUNCTION 'MAP2E_MPGD_TO_BAPI_MPGD_GA' * EXPORTING * mpgd = ls_mpgd_ga * CHANGING * bapi_mpgd_ga = ls_bapi_mpgd_ga. * * CLEAR ls_planningdata. * ls_planningdata = CORRESPONDING #( ls_bapi_mpgd_ga ). * ls_planningdata-material_long = l_matnr. * * CLEAR ls_planningdatax. * PERFORM map_data_to_datax USING 'BAPIE1MPGDX' ls_planningdata CHANGING ls_planningdatax. * * INSERT ls_planningdata INTO TABLE lt_planningdata. * INSERT ls_planningdatax INTO TABLE lt_planningdatax. * ENDLOOP. * * SORT lt_planningdata BY plant. * SORT lt_planningdatax BY plant. * DELETE ADJACENT DUPLICATES FROM lt_planningdata COMPARING plant. * DELETE ADJACENT DUPLICATES FROM lt_planningdatax COMPARING plant. *&---------------------------------------------------------------------* *& \u5e93\u4f4d\u89c6\u56fe *&---------------------------------------------------------------------* DATA ls_mard_ga TYPE mard . DATA ls_bapi_mard_ga TYPE bapi_mard_ga . LOOP AT GROUP ls_data_grp INTO ls_data . CLEAR ls_mard_ga . CLEAR ls_bapi_mard_ga . ls_mard_ga = CORRESPONDING # ( ls_data ). CALL FUNCTION 'MAP2E_MARD_TO_BAPI_MARD_GA' EXPORTING mard = ls_mard_ga CHANGING bapi_mard_ga = ls_bapi_mard_ga . CLEAR ls_storagelocationdata . ls_storagelocationdata = CORRESPONDING # ( ls_bapi_mard_ga ). ls_storagelocationdata - material_long = l_matnr . CLEAR ls_storagelocationdatax . PERFORM map_data_to_datax USING 'BAPIE1MARDX' ls_storagelocationdata CHANGING ls_storagelocationdatax . INSERT ls_storagelocationdata INTO TABLE lt_storagelocationdata . INSERT ls_storagelocationdatax INTO TABLE lt_storagelocationdatax . ENDLOOP . SORT lt_storagelocationdata BY plant stge_loc . SORT lt_storagelocationdatax BY plant stge_loc . DELETE ADJACENT DUPLICATES FROM lt_storagelocationdata COMPARING plant stge_loc . DELETE ADJACENT DUPLICATES FROM lt_storagelocationdatax COMPARING plant stge_loc . *&---------------------------------------------------------------------* *& \u8bc4\u4f30\u89c6\u56fe *&---------------------------------------------------------------------* DATA ls_mbew_ga TYPE mbew . DATA ls_bapi_mbew_ga TYPE bapi_mbew_ga . LOOP AT GROUP ls_data_grp INTO ls_data . CLEAR ls_mbew_ga . CLEAR ls_bapi_mbew_ga . ls_mbew_ga = CORRESPONDING # ( ls_data ). CALL FUNCTION 'MAP2E_MBEW_TO_BAPI_MBEW_GA' EXPORTING mbew = ls_mbew_ga h_waers = 'CNY' CHANGING bapi_mbew_ga = ls_bapi_mbew_ga EXCEPTIONS error_converting_curr_amount = 1 . IF sy - subrc <> 0 . CONTINUE . ENDIF . CLEAR ls_valuationdata . ls_valuationdata = CORRESPONDING # ( ls_bapi_mbew_ga ). ls_valuationdata - material_long = l_matnr . CLEAR ls_valuationdatax . PERFORM map_data_to_datax USING 'BAPIE1MBEWX' ls_valuationdata CHANGING ls_valuationdatax . INSERT ls_valuationdata INTO TABLE lt_valuationdata . INSERT ls_valuationdatax INTO TABLE lt_valuationdatax . ENDLOOP . SORT lt_valuationdata BY val_area val_type . SORT lt_valuationdatax BY val_area val_type . DELETE ADJACENT DUPLICATES FROM lt_valuationdata COMPARING val_area val_type . DELETE ADJACENT DUPLICATES FROM lt_valuationdatax COMPARING val_area val_type . *&---------------------------------------------------------------------* *& MLGN *&---------------------------------------------------------------------* DATA ls_mlgn_ga TYPE mlgn . DATA ls_bapi_mlgn_ga TYPE bapi_mlgn_ga . LOOP AT GROUP ls_data_grp INTO ls_data . CLEAR ls_mlgn_ga . CLEAR ls_bapi_mlgn_ga . ls_mlgn_ga = CORRESPONDING # ( ls_data ). CALL FUNCTION 'MAP2E_MLGN_TO_BAPI_MLGN_GA' EXPORTING mlgn = ls_mlgn_ga CHANGING bapi_mlgn_ga = ls_bapi_mlgn_ga . CLEAR ls_plantdata . ls_plantdata = CORRESPONDING # ( ls_bapi_mlgn_ga ). ls_plantdata - material_long = l_matnr . CLEAR ls_plantdatax . PERFORM map_data_to_datax USING 'BAPIE1MLGNX' ls_plantdata CHANGING ls_plantdatax . INSERT ls_plantdata INTO TABLE lt_plantdata . INSERT ls_plantdatax INTO TABLE lt_plantdatax . ENDLOOP . SORT lt_plantdata BY plant . SORT lt_plantdatax BY plant . DELETE ADJACENT DUPLICATES FROM lt_plantdata COMPARING plant . DELETE ADJACENT DUPLICATES FROM lt_plantdatax COMPARING plant . *&---------------------------------------------------------------------* *& \u9500\u552e\u89c6\u56fe *&---------------------------------------------------------------------* DATA ls_mvke_ga TYPE mvke . DATA ls_bapi_mvke_ga TYPE bapi_mvke_ga . LOOP AT GROUP ls_data_grp INTO ls_data . CLEAR ls_mvke_ga . CLEAR ls_bapi_mvke_ga . ls_mvke_ga = CORRESPONDING # ( ls_data ). CALL FUNCTION 'MAP2E_MVKE_TO_BAPI_MVKE_GA' EXPORTING mvke = ls_mvke_ga CHANGING bapi_mvke_ga = ls_bapi_mvke_ga . CLEAR ls_salesdata . ls_salesdata = CORRESPONDING # ( ls_bapi_mvke_ga ). ls_salesdata - material_long = l_matnr . CLEAR ls_salesdatax . PERFORM map_data_to_datax USING 'BAPIE1MVKEX' ls_salesdata CHANGING ls_salesdatax . INSERT ls_salesdata INTO TABLE lt_salesdata . INSERT ls_salesdatax INTO TABLE lt_salesdatax . ENDLOOP . SORT lt_salesdata BY sales_org distr_chan . SORT lt_salesdatax BY sales_org distr_chan . DELETE ADJACENT DUPLICATES FROM lt_salesdata COMPARING sales_org distr_chan . DELETE ADJACENT DUPLICATES FROM lt_salesdatax COMPARING sales_org distr_chan . *&---------------------------------------------------------------------* *& MLGT *&---------------------------------------------------------------------* DATA ls_mlgt_ga TYPE mlgt . DATA ls_bapi_mlgt_ga TYPE bapi_mlgt_ga . LOOP AT GROUP ls_data_grp INTO ls_data . CLEAR ls_mlgt_ga . CLEAR ls_bapi_mlgt_ga . ls_mlgt_ga = CORRESPONDING # ( ls_data ). CALL FUNCTION 'MAP2E_MLGT_TO_BAPI_MLGT_GA' EXPORTING mlgt = ls_mlgt_ga CHANGING bapi_mlgt_ga = ls_bapi_mlgt_ga . CLEAR ls_storagetypedata . ls_storagetypedata = CORRESPONDING # ( ls_bapi_mlgt_ga ). ls_storagetypedata - material_long = l_matnr . CLEAR ls_storagetypedatax . PERFORM map_data_to_datax USING 'BAPIE1MLGTX' ls_storagetypedata CHANGING ls_storagetypedatax . INSERT ls_storagetypedata INTO TABLE lt_storagetypedata . INSERT ls_storagetypedatax INTO TABLE lt_storagetypedatax . ENDLOOP . SORT lt_storagetypedata BY whse_no stge_type . SORT lt_storagetypedatax BY whse_no stge_type . DELETE ADJACENT DUPLICATES FROM lt_storagetypedata COMPARING whse_no stge_type . DELETE ADJACENT DUPLICATES FROM lt_storagetypedatax COMPARING whse_no stge_type . *&---------------------------------------------------------------------* *& \u7269\u6599\u63cf\u8ff0 *&---------------------------------------------------------------------* CLEAR ls_materialdescription . ls_materialdescription - material_long = l_matnr . ls_materialdescription - langu = '1' . ls_materialdescription - matl_desc = ls_data_head - maktx . INSERT ls_materialdescription INTO TABLE lt_materialdescription . SORT lt_materialdescription BY langu . DELETE ADJACENT DUPLICATES FROM lt_materialdescription COMPARING langu . **&---------------------------------------------------------------------* **& \u7a0e **&---------------------------------------------------------------------* * CLEAR ls_taxclassifications. * ls_taxclassifications-material_long = l_matnr. * ls_taxclassifications-depcountry = ls_data_head-aland. * ls_taxclassifications-tax_ind = ls_data_head-taxim. * * IF ls_data_head-taxm1 IS NOT INITIAL. * ls_taxclassifications-tax_type_1 = ls_data_head-taxm1. * ls_taxclassifications-taxclass_1 = ls_data_head-taxim. * ENDIF. * * IF ls_data_head-taxm2 IS NOT INITIAL. * ls_taxclassifications-tax_type_2 = ls_data_head-taxm2. * ls_taxclassifications-taxclass_2 = ls_data_head-taxim. * ENDIF. * * IF ls_data_head-taxm3 IS NOT INITIAL. * ls_taxclassifications-tax_type_3 = ls_data_head-taxm3. * ls_taxclassifications-taxclass_3 = ls_data_head-taxim. * ENDIF. * * IF ls_data_head-taxm4 IS NOT INITIAL. * ls_taxclassifications-tax_type_4 = ls_data_head-taxm4. * ls_taxclassifications-taxclass_4 = ls_data_head-taxim. * ENDIF. * * IF ls_data_head-taxm5 IS NOT INITIAL. * ls_taxclassifications-tax_type_5 = ls_data_head-taxm5. * ls_taxclassifications-taxclass_5 = ls_data_head-taxim. * ENDIF. * * IF ls_data_head-taxm6 IS NOT INITIAL. * ls_taxclassifications-tax_type_6 = ls_data_head-taxm6. * ls_taxclassifications-taxclass_6 = ls_data_head-taxim. * ENDIF. * * IF ls_data_head-taxm7 IS NOT INITIAL. * ls_taxclassifications-tax_type_7 = ls_data_head-taxm7. * ls_taxclassifications-taxclass_7 = ls_data_head-taxim. * ENDIF. * * IF ls_data_head-taxm8 IS NOT INITIAL. * ls_taxclassifications-tax_type_8 = ls_data_head-taxm8. * ls_taxclassifications-taxclass_8 = ls_data_head-taxim. * ENDIF. * * IF ls_data_head-taxm9 IS NOT INITIAL. * ls_taxclassifications-tax_type_9 = ls_data_head-taxm9. * ls_taxclassifications-taxclass_9 = ls_data_head-taxim. * ENDIF. * * INSERT ls_taxclassifications INTO TABLE lt_taxclassifications. **&---------------------------------------------------------------------* **& MARM **&---------------------------------------------------------------------* * DATA ls_marm_ga TYPE marm. * DATA ls_bapi_marm_ga TYPE bapi_marm_ga. * * LOOP AT GROUP ls_data_grp INTO ls_data. * CLEAR ls_marm_ga. * CLEAR ls_unitsofmeasure. * ls_marm_ga = CORRESPONDING #( ls_data ). * CALL FUNCTION 'MAP2E_MARM_TO_BAPIE1MARM' * EXPORTING * marm = ls_marm_ga * CHANGING * bapie1marm = ls_unitsofmeasure. * ls_unitsofmeasure-material_long = l_matnr. * * CLEAR ls_unitsofmeasurex. * PERFORM map_data_to_datax USING 'BAPIE1MARMX' ls_unitsofmeasure CHANGING ls_unitsofmeasurex. * * INSERT ls_unitsofmeasure INTO TABLE lt_unitsofmeasure. * INSERT ls_unitsofmeasurex INTO TABLE lt_unitsofmeasurex. * ENDLOOP. * * SORT lt_unitsofmeasure BY alt_unit alt_unit_iso. * SORT lt_unitsofmeasurex BY alt_unit alt_unit_iso. * DELETE ADJACENT DUPLICATES FROM lt_unitsofmeasure COMPARING alt_unit alt_unit_iso. * DELETE ADJACENT DUPLICATES FROM lt_unitsofmeasurex COMPARING alt_unit alt_unit_iso. *&---------------------------------------------------------------------* *& \u5bfc\u5165\u7269\u6599 *&---------------------------------------------------------------------* CLEAR lt_return . CALL FUNCTION 'BAPI_MATERIAL_SAVEREPLICA' EXPORTING noappllog = l_global_data - no_appl_log nochangedoc = l_global_data - no_change_doc testrun = l_global_data - testrun inpfldcheck = l_global_data - inp_fld_check TABLES headdata = lt_headdata clientdata = lt_clientdata clientdatax = lt_clientdatax plantdata = lt_plantdata plantdatax = lt_plantdatax forecastparameters = lt_forecastparameters forecastparametersx = lt_forecastparametersx planningdata = lt_planningdata planningdatax = lt_planningdatax storagelocationdata = lt_storagelocationdata storagelocationdatax = lt_storagelocationdatax valuationdata = lt_valuationdata valuationdatax = lt_valuationdatax warehousenumberdata = lt_warehousenumberdata warehousenumberdatax = lt_warehousenumberdatax salesdata = lt_salesdata salesdatax = lt_salesdatax storagetypedata = lt_storagetypedata storagetypedatax = lt_storagetypedatax materialdescription = lt_materialdescription unitsofmeasure = lt_unitsofmeasure unitsofmeasurex = lt_unitsofmeasurex * internationalartnos = lt_internationalartnos * materiallongtext = lt_materiallongtext taxclassifications = lt_taxclassifications * prtdata = lt_prtdata * prtdatax = lt_prtdatax extensionin = lt_extensionin extensioninx = lt_extensioninx * forecastvalues = lt_forecastvalues * unplndconsumption = lt_unplndconsumption * totalconsumption = lt_totalconsumption returnmessages = lt_return . CLEAR l_mtype . CLEAR l_msg . LOOP AT lt_return INTO ls_return WHERE type CA 'AXE' . MESSAGE ID ls_return - id TYPE ls_return - type NUMBER ls_return - number WITH ls_return - message_v1 ls_return - message_v2 ls_return - message_v3 ls_return - message_v4 INTO ls_return - message . l_msg = |{ l_msg }{ ls_return - message }|. ENDLOOP . IF sy - subrc = 0 . l_mtype = 'E' . CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK' . ELSE . l_matnr = lt_headdata [ 1 ] - material_long . l_mtype = 'S' . l_msg = '\u5df2\u5904\u7406' . CALL FUNCTION 'BAPI_TRANSACTION_COMMIT' EXPORTING wait = abap_true . ENDIF . \" \u56de\u5199\u6d88\u606f LOOP AT GROUP ls_data_grp REFERENCE INTO DATA ( lr_data ). lr_data -> mtype = l_mtype . lr_data -> msg = l_msg . ENDLOOP . ENDLOOP . ENDFUNCTION . *&---------------------------------------------------------------------* *& \u540c\u540dBAPIUPDATE\u5b57\u6bb5\u8d4b\u503c *&---------------------------------------------------------------------* FORM map_data_to_datax USING i_name TYPE tabname i_data TYPE data CHANGING c_datax TYPE data . FIELD-SYMBOLS <wa> TYPE any . FIELD-SYMBOLS <wax> TYPE any . SELECT fieldname , rollname FROM dd03l WHERE tabname = @ i_name INTO TABLE @ DATA ( lt_field ). LOOP AT lt_field INTO DATA ( ls_field ). ASSIGN COMPONENT ls_field - fieldname OF STRUCTURE i_data TO <wa> . ASSIGN COMPONENT ls_field - fieldname OF STRUCTURE c_datax TO <wax> . IF <wa> IS ASSIGNED AND <wax> IS ASSIGNED . IF ls_field - rollname = 'BAPIUPDATE' . IF <wa> IS NOT INITIAL AND <wa> <> '' . <wax> = abap_true . ENDIF . ELSE . <wax> = <wa> . ENDIF . ENDIF . ENDLOOP . ENDFORM . \u7269\u6599\u5206\u7c7b\u89c6\u56fe \u00b6 BAPI_OBJCL_EXISTENCECHECK \uff0c\u68c0\u67e5\u7269\u6599\u662f\u5426\u5b58\u5728\u5206\u7c7b\u89c6\u56fe BAPI_OBJCL_CREATE \uff0c\u521b\u5efa\u7269\u6599\u5206\u7c7b\u89c6\u56fe BAPI_OBJCL_CHANGE \uff0c\u4fee\u6539\u7269\u6599\u5206\u7c7b\u89c6\u56fe BAPI_OBJCL_GETDETAIL \uff0c\u83b7\u53d6\u7269\u6599\u5206\u7c7b\u7279\u5f81\u503c \u793a\u4f8b\u4ee3\u7801 IDOC\u7269\u6599\u540c\u6b65 \u00b6 SAP\u7cfb\u7edf\u95f4\u8fc1\u79fb\u6216\u540c\u6b65\u7269\u6599\uff0c\u63a8\u8350\u4f7f\u7528IDOC\u5b9e\u73b0\uff0c\u4e0b\u9762\u8bb2\u8ff0\u5b9e\u73b0\u8fc7\u7a0b\u3002 \u793a\u4f8b\u4ee3\u7801","title":"\u7269\u6599"},{"location":"master_data/material/#_1","text":"","title":"\u7269\u6599"},{"location":"master_data/material/#_2","text":"BAPI_MATERIAL_SAVEDATA \uff0c\u6bcf\u6b21\u53ea\u80fd\u6269\u5c55\u4e00\u4e2a\u5de5\u5382\u3002 BAPI_MATERIAL_SAVEREPLICA \uff0c\u5141\u8bb8\u6269\u5c55\u591a\u4e2a\u5de5\u5382\uff0c\u4e0b\u9762\u4f7f\u7528\u8be5\u51fd\u6570\u7ef4\u62a4\u7269\u6599\u3002 \u793a\u4f8b\u4ee3\u7801 FUNCTION zfm_demo_material_save_2 \" You can use the template 'functionModuleParameter' to add here the signature! . *&---------------------------------------------------------------------* *& \u6279\u5bfc\u6570\u636e *&---------------------------------------------------------------------* \" \u6f14\u793a\u7528\uff0c\u5047\u8bbe\u8fd9\u662f\u7a0b\u5e8f\u7684\u5165\u53c2\u548c\u51fa\u53c2 TYPES : BEGIN OF ty_data , matnr TYPE mara - matnr , mbrsh TYPE mara - mbrsh , mtart TYPE mara - mtart , maktx TYPE makt - maktx , werks TYPE werks_d , vkorg TYPE vkorg , mtype TYPE bapi_mtype , msg TYPE bapi_msg , END OF ty_data . TYPES tt_data TYPE STANDARD TABLE OF ty_data . DATA lt_data TYPE tt_data . DATA l_matnr TYPE matnr . DATA l_mtype TYPE bapi_mtype . DATA l_msg TYPE bapi_msg . *&---------------------------------------------------------------------* *& BAPI\u6570\u636e\u58f0\u660e *&---------------------------------------------------------------------* DATA l_global_data TYPE bapie1global_data . DATA : lt_headdata TYPE STANDARD TABLE OF bapie1matheader , lt_clientdata TYPE STANDARD TABLE OF bapie1mara , lt_clientdatax TYPE STANDARD TABLE OF bapie1marax , lt_plantdata TYPE STANDARD TABLE OF bapie1marc , lt_plantdatax TYPE STANDARD TABLE OF bapie1marcx , lt_forecastparameters TYPE STANDARD TABLE OF bapie1mpop , lt_forecastparametersx TYPE STANDARD TABLE OF bapie1mpopx , lt_planningdata TYPE STANDARD TABLE OF bapie1mpgd , lt_planningdatax TYPE STANDARD TABLE OF bapie1mpgdx , lt_storagelocationdata TYPE STANDARD TABLE OF bapie1mard , lt_storagelocationdatax TYPE STANDARD TABLE OF bapie1mardx , lt_valuationdata TYPE STANDARD TABLE OF bapie1mbew , lt_valuationdatax TYPE STANDARD TABLE OF bapie1mbewx , lt_warehousenumberdata TYPE STANDARD TABLE OF bapie1mlgn , lt_warehousenumberdatax TYPE STANDARD TABLE OF bapie1mlgnx , lt_salesdata TYPE STANDARD TABLE OF bapie1mvke , lt_salesdatax TYPE STANDARD TABLE OF bapie1mvkex , lt_storagetypedata TYPE STANDARD TABLE OF bapie1mlgt , lt_storagetypedatax TYPE STANDARD TABLE OF bapie1mlgtx , lt_materialdescription TYPE STANDARD TABLE OF bapie1makt , lt_unitsofmeasure TYPE STANDARD TABLE OF bapie1marm , lt_unitsofmeasurex TYPE STANDARD TABLE OF bapie1marmx , lt_internationalartnos TYPE STANDARD TABLE OF bapie1mean , lt_materiallongtext TYPE STANDARD TABLE OF bapie1mltx , lt_taxclassifications TYPE STANDARD TABLE OF bapie1mlan , lt_prtdata TYPE STANDARD TABLE OF bapie1mfhm , lt_prtdatax TYPE STANDARD TABLE OF bapie1mfhmx , lt_extensionin TYPE STANDARD TABLE OF bapie1parex , lt_extensioninx TYPE STANDARD TABLE OF bapie1parexx , lt_forecastvalues TYPE STANDARD TABLE OF bapie1mprw , lt_unplndconsumption TYPE STANDARD TABLE OF bapie1mveu , lt_totalconsumption TYPE STANDARD TABLE OF bapie1mveg . DATA : ls_headdata TYPE bapie1matheader , ls_clientdata TYPE bapie1mara , ls_clientdatax TYPE bapie1marax , ls_plantdata TYPE bapie1marc , ls_plantdatax TYPE bapie1marcx , ls_forecastparameters TYPE bapie1mpop , ls_forecastparametersx TYPE bapie1mpopx , ls_planningdata TYPE bapie1mpgd , ls_planningdatax TYPE bapie1mpgdx , ls_storagelocationdata TYPE bapie1mard , ls_storagelocationdatax TYPE bapie1mardx , ls_valuationdata TYPE bapie1mbew , ls_valuationdatax TYPE bapie1mbewx , ls_warehousenumberdata TYPE bapie1mlgn , ls_warehousenumberdatax TYPE bapie1mlgnx , ls_salesdata TYPE bapie1mvke , ls_salesdatax TYPE bapie1mvkex , ls_storagetypedata TYPE bapie1mlgt , ls_storagetypedatax TYPE bapie1mlgtx , ls_materialdescription TYPE bapie1makt , ls_unitsofmeasure TYPE bapie1marm , ls_unitsofmeasurex TYPE bapie1marmx , ls_internationalartnos TYPE bapie1mean , ls_materiallongtext TYPE bapie1mltx , ls_taxclassifications TYPE bapie1mlan , ls_prtdata TYPE bapie1mfhm , ls_prtdatax TYPE bapie1mfhmx , ls_extensionin TYPE bapie1parex , ls_extensioninx TYPE bapie1parexx , ls_forecastvalues TYPE bapie1mprw , ls_unplndconsumption TYPE bapie1mveu , ls_totalconsumption TYPE bapie1mveg . DATA : lt_return TYPE STANDARD TABLE OF bapie1ret2 , ls_return TYPE bapiret2 . *&---------------------------------------------------------------------* *& \u5206\u6279\u5904\u7406 *&---------------------------------------------------------------------* LOOP AT lt_data INTO DATA ( ls_data ) GROUP BY ( matnr = ls_data - matnr ) INTO DATA ( ls_data_grp ). \" \u4efb\u53d6\u4e00\u884c\u4f5c\u4e3a\u62ac\u5934 LOOP AT GROUP ls_data_grp INTO DATA ( ls_data_head ). EXIT . ENDLOOP . *&---------------------------------------------------------------------* *& \u7269\u6599\u53f7 *&---------------------------------------------------------------------* \" \u5927\u591a\u90fd\u662f\u5916\u90e8\u6307\u5b9a\u7269\u6599\u53f7\uff0c\u5982\u9700\u6d41\u6c34\u53ef\u81ea\u884c\u8c03\u6574 CLEAR l_matnr . CALL FUNCTION 'CONVERSION_EXIT_MATN1_INPUT' EXPORTING input = ls_data_head - matnr IMPORTING output = l_matnr EXCEPTIONS length_error = 1 OTHERS = 2 . *&---------------------------------------------------------------------* *& \u8bbe\u7f6e\u9700\u8981\u5bfc\u5165\u7684\u7269\u6599\u548c\u89c6\u56fe *&---------------------------------------------------------------------* CLEAR ls_headdata . ls_headdata - material_long = l_matnr . \" \u7269\u6599 ls_headdata - ind_sector = ls_data_head - mbrsh . \" \u884c\u4e1a\u9886\u57df ls_headdata - matl_type = ls_data_head - mtart . \" \u7269\u6599\u7c7b\u578b ls_headdata - basic_view = abap_true . ls_headdata - sales_view = abap_true . ls_headdata - purchase_view = abap_true . ls_headdata - mrp_view = abap_true . ls_headdata - forecast_view = abap_true . ls_headdata - work_sched_view = abap_true . ls_headdata - prt_view = abap_true . ls_headdata - storage_view = abap_true . ls_headdata - warehouse_view = abap_true . ls_headdata - quality_view = abap_true . ls_headdata - account_view = abap_true . ls_headdata - cost_view = abap_true . INSERT ls_headdata INTO TABLE lt_headdata . *&---------------------------------------------------------------------* *& \u57fa\u7840\u89c6\u56fe *&---------------------------------------------------------------------* DATA ls_mara_ga TYPE mara . DATA ls_bapi_mara_ga TYPE bapi_mara_ga . CLEAR ls_mara_ga . CLEAR ls_bapi_mara_ga . ls_mara_ga = CORRESPONDING # ( ls_data_head ). CALL FUNCTION 'MAP2E_MARA_TO_BAPI_MARA_GA' EXPORTING mara = ls_mara_ga CHANGING bapi_mara_ga = ls_bapi_mara_ga . CLEAR ls_clientdata . ls_clientdata = CORRESPONDING # ( ls_bapi_mara_ga ). ls_clientdata - material_long = l_matnr . CLEAR ls_clientdatax . PERFORM map_data_to_datax USING 'BAPIE1MARAX' ls_clientdata CHANGING ls_clientdatax . INSERT ls_clientdata INTO TABLE lt_clientdata . INSERT ls_clientdatax INTO TABLE lt_clientdatax . *&---------------------------------------------------------------------* *& \u5de5\u5382\u89c6\u56fe *&---------------------------------------------------------------------* DATA ls_marc_ga TYPE marc . DATA ls_bapi_marc_ga TYPE bapi_marc_ga . LOOP AT GROUP ls_data_grp INTO ls_data . CLEAR ls_marc_ga . CLEAR ls_bapi_marc_ga . ls_marc_ga = CORRESPONDING # ( ls_data ). CALL FUNCTION 'MAP2E_MARC_TO_BAPI_MARC_GA' EXPORTING marc = ls_marc_ga h_waers = 'CNY' CHANGING bapi_marc_ga = ls_bapi_marc_ga EXCEPTIONS error_converting_curr_amount = 1 . IF sy - subrc = 0 . CONTINUE . ENDIF . CLEAR ls_plantdata . ls_plantdata = CORRESPONDING # ( ls_bapi_marc_ga ). ls_plantdata - material_long = l_matnr . CLEAR ls_plantdatax . PERFORM map_data_to_datax USING 'BAPIE1MARCX' ls_plantdata CHANGING ls_plantdatax . INSERT ls_plantdata INTO TABLE lt_plantdata . INSERT ls_plantdatax INTO TABLE lt_plantdatax . ENDLOOP . SORT lt_plantdata BY plant . SORT lt_plantdatax BY plant . DELETE ADJACENT DUPLICATES FROM lt_plantdata COMPARING plant . DELETE ADJACENT DUPLICATES FROM lt_plantdatax COMPARING plant . **&---------------------------------------------------------------------* **& MPOP **&---------------------------------------------------------------------* * DATA ls_mpop_ga TYPE mpop. * DATA ls_bapi_mpop_ga TYPE bapi_mpop_ga. * * LOOP AT GROUP ls_data_grp INTO ls_data. * CLEAR ls_mpop_ga. * CLEAR ls_bapi_mpop_ga. * ls_mpop_ga = CORRESPONDING #( ls_data ). * CALL FUNCTION 'MAP2E_MPOP_TO_BAPI_MPOP_GA' * EXPORTING * mpop = ls_mpop_ga * CHANGING * bapi_mpop_ga = ls_bapi_mpop_ga. * * CLEAR ls_forecastparameters. * ls_forecastparameters = CORRESPONDING #( ls_bapi_mpop_ga ). * ls_forecastparameters-material_long = l_matnr. * * CLEAR ls_forecastparametersx. * PERFORM map_data_to_datax USING 'BAPIE1MPOPX' ls_forecastparameters CHANGING ls_forecastparametersx. * * INSERT ls_forecastparameters INTO TABLE lt_forecastparameters. * INSERT ls_forecastparametersx INTO TABLE lt_forecastparametersx. * ENDLOOP. * * SORT lt_forecastparameters BY plant. * SORT lt_forecastparametersx BY plant. * DELETE ADJACENT DUPLICATES FROM lt_forecastparameters COMPARING plant. * DELETE ADJACENT DUPLICATES FROM lt_forecastparametersx COMPARING plant. **&---------------------------------------------------------------------* **& MPGD **&---------------------------------------------------------------------* * DATA ls_mpgd_ga TYPE mpgd. * DATA ls_bapi_mpgd_ga TYPE bapi_mpgd_ga. * * LOOP AT GROUP ls_data_grp INTO ls_data. * CLEAR ls_mpgd_ga. * CLEAR ls_bapi_mpgd_ga. * ls_mpgd_ga = CORRESPONDING #( ls_data ). * CALL FUNCTION 'MAP2E_MPGD_TO_BAPI_MPGD_GA' * EXPORTING * mpgd = ls_mpgd_ga * CHANGING * bapi_mpgd_ga = ls_bapi_mpgd_ga. * * CLEAR ls_planningdata. * ls_planningdata = CORRESPONDING #( ls_bapi_mpgd_ga ). * ls_planningdata-material_long = l_matnr. * * CLEAR ls_planningdatax. * PERFORM map_data_to_datax USING 'BAPIE1MPGDX' ls_planningdata CHANGING ls_planningdatax. * * INSERT ls_planningdata INTO TABLE lt_planningdata. * INSERT ls_planningdatax INTO TABLE lt_planningdatax. * ENDLOOP. * * SORT lt_planningdata BY plant. * SORT lt_planningdatax BY plant. * DELETE ADJACENT DUPLICATES FROM lt_planningdata COMPARING plant. * DELETE ADJACENT DUPLICATES FROM lt_planningdatax COMPARING plant. *&---------------------------------------------------------------------* *& \u5e93\u4f4d\u89c6\u56fe *&---------------------------------------------------------------------* DATA ls_mard_ga TYPE mard . DATA ls_bapi_mard_ga TYPE bapi_mard_ga . LOOP AT GROUP ls_data_grp INTO ls_data . CLEAR ls_mard_ga . CLEAR ls_bapi_mard_ga . ls_mard_ga = CORRESPONDING # ( ls_data ). CALL FUNCTION 'MAP2E_MARD_TO_BAPI_MARD_GA' EXPORTING mard = ls_mard_ga CHANGING bapi_mard_ga = ls_bapi_mard_ga . CLEAR ls_storagelocationdata . ls_storagelocationdata = CORRESPONDING # ( ls_bapi_mard_ga ). ls_storagelocationdata - material_long = l_matnr . CLEAR ls_storagelocationdatax . PERFORM map_data_to_datax USING 'BAPIE1MARDX' ls_storagelocationdata CHANGING ls_storagelocationdatax . INSERT ls_storagelocationdata INTO TABLE lt_storagelocationdata . INSERT ls_storagelocationdatax INTO TABLE lt_storagelocationdatax . ENDLOOP . SORT lt_storagelocationdata BY plant stge_loc . SORT lt_storagelocationdatax BY plant stge_loc . DELETE ADJACENT DUPLICATES FROM lt_storagelocationdata COMPARING plant stge_loc . DELETE ADJACENT DUPLICATES FROM lt_storagelocationdatax COMPARING plant stge_loc . *&---------------------------------------------------------------------* *& \u8bc4\u4f30\u89c6\u56fe *&---------------------------------------------------------------------* DATA ls_mbew_ga TYPE mbew . DATA ls_bapi_mbew_ga TYPE bapi_mbew_ga . LOOP AT GROUP ls_data_grp INTO ls_data . CLEAR ls_mbew_ga . CLEAR ls_bapi_mbew_ga . ls_mbew_ga = CORRESPONDING # ( ls_data ). CALL FUNCTION 'MAP2E_MBEW_TO_BAPI_MBEW_GA' EXPORTING mbew = ls_mbew_ga h_waers = 'CNY' CHANGING bapi_mbew_ga = ls_bapi_mbew_ga EXCEPTIONS error_converting_curr_amount = 1 . IF sy - subrc <> 0 . CONTINUE . ENDIF . CLEAR ls_valuationdata . ls_valuationdata = CORRESPONDING # ( ls_bapi_mbew_ga ). ls_valuationdata - material_long = l_matnr . CLEAR ls_valuationdatax . PERFORM map_data_to_datax USING 'BAPIE1MBEWX' ls_valuationdata CHANGING ls_valuationdatax . INSERT ls_valuationdata INTO TABLE lt_valuationdata . INSERT ls_valuationdatax INTO TABLE lt_valuationdatax . ENDLOOP . SORT lt_valuationdata BY val_area val_type . SORT lt_valuationdatax BY val_area val_type . DELETE ADJACENT DUPLICATES FROM lt_valuationdata COMPARING val_area val_type . DELETE ADJACENT DUPLICATES FROM lt_valuationdatax COMPARING val_area val_type . *&---------------------------------------------------------------------* *& MLGN *&---------------------------------------------------------------------* DATA ls_mlgn_ga TYPE mlgn . DATA ls_bapi_mlgn_ga TYPE bapi_mlgn_ga . LOOP AT GROUP ls_data_grp INTO ls_data . CLEAR ls_mlgn_ga . CLEAR ls_bapi_mlgn_ga . ls_mlgn_ga = CORRESPONDING # ( ls_data ). CALL FUNCTION 'MAP2E_MLGN_TO_BAPI_MLGN_GA' EXPORTING mlgn = ls_mlgn_ga CHANGING bapi_mlgn_ga = ls_bapi_mlgn_ga . CLEAR ls_plantdata . ls_plantdata = CORRESPONDING # ( ls_bapi_mlgn_ga ). ls_plantdata - material_long = l_matnr . CLEAR ls_plantdatax . PERFORM map_data_to_datax USING 'BAPIE1MLGNX' ls_plantdata CHANGING ls_plantdatax . INSERT ls_plantdata INTO TABLE lt_plantdata . INSERT ls_plantdatax INTO TABLE lt_plantdatax . ENDLOOP . SORT lt_plantdata BY plant . SORT lt_plantdatax BY plant . DELETE ADJACENT DUPLICATES FROM lt_plantdata COMPARING plant . DELETE ADJACENT DUPLICATES FROM lt_plantdatax COMPARING plant . *&---------------------------------------------------------------------* *& \u9500\u552e\u89c6\u56fe *&---------------------------------------------------------------------* DATA ls_mvke_ga TYPE mvke . DATA ls_bapi_mvke_ga TYPE bapi_mvke_ga . LOOP AT GROUP ls_data_grp INTO ls_data . CLEAR ls_mvke_ga . CLEAR ls_bapi_mvke_ga . ls_mvke_ga = CORRESPONDING # ( ls_data ). CALL FUNCTION 'MAP2E_MVKE_TO_BAPI_MVKE_GA' EXPORTING mvke = ls_mvke_ga CHANGING bapi_mvke_ga = ls_bapi_mvke_ga . CLEAR ls_salesdata . ls_salesdata = CORRESPONDING # ( ls_bapi_mvke_ga ). ls_salesdata - material_long = l_matnr . CLEAR ls_salesdatax . PERFORM map_data_to_datax USING 'BAPIE1MVKEX' ls_salesdata CHANGING ls_salesdatax . INSERT ls_salesdata INTO TABLE lt_salesdata . INSERT ls_salesdatax INTO TABLE lt_salesdatax . ENDLOOP . SORT lt_salesdata BY sales_org distr_chan . SORT lt_salesdatax BY sales_org distr_chan . DELETE ADJACENT DUPLICATES FROM lt_salesdata COMPARING sales_org distr_chan . DELETE ADJACENT DUPLICATES FROM lt_salesdatax COMPARING sales_org distr_chan . *&---------------------------------------------------------------------* *& MLGT *&---------------------------------------------------------------------* DATA ls_mlgt_ga TYPE mlgt . DATA ls_bapi_mlgt_ga TYPE bapi_mlgt_ga . LOOP AT GROUP ls_data_grp INTO ls_data . CLEAR ls_mlgt_ga . CLEAR ls_bapi_mlgt_ga . ls_mlgt_ga = CORRESPONDING # ( ls_data ). CALL FUNCTION 'MAP2E_MLGT_TO_BAPI_MLGT_GA' EXPORTING mlgt = ls_mlgt_ga CHANGING bapi_mlgt_ga = ls_bapi_mlgt_ga . CLEAR ls_storagetypedata . ls_storagetypedata = CORRESPONDING # ( ls_bapi_mlgt_ga ). ls_storagetypedata - material_long = l_matnr . CLEAR ls_storagetypedatax . PERFORM map_data_to_datax USING 'BAPIE1MLGTX' ls_storagetypedata CHANGING ls_storagetypedatax . INSERT ls_storagetypedata INTO TABLE lt_storagetypedata . INSERT ls_storagetypedatax INTO TABLE lt_storagetypedatax . ENDLOOP . SORT lt_storagetypedata BY whse_no stge_type . SORT lt_storagetypedatax BY whse_no stge_type . DELETE ADJACENT DUPLICATES FROM lt_storagetypedata COMPARING whse_no stge_type . DELETE ADJACENT DUPLICATES FROM lt_storagetypedatax COMPARING whse_no stge_type . *&---------------------------------------------------------------------* *& \u7269\u6599\u63cf\u8ff0 *&---------------------------------------------------------------------* CLEAR ls_materialdescription . ls_materialdescription - material_long = l_matnr . ls_materialdescription - langu = '1' . ls_materialdescription - matl_desc = ls_data_head - maktx . INSERT ls_materialdescription INTO TABLE lt_materialdescription . SORT lt_materialdescription BY langu . DELETE ADJACENT DUPLICATES FROM lt_materialdescription COMPARING langu . **&---------------------------------------------------------------------* **& \u7a0e **&---------------------------------------------------------------------* * CLEAR ls_taxclassifications. * ls_taxclassifications-material_long = l_matnr. * ls_taxclassifications-depcountry = ls_data_head-aland. * ls_taxclassifications-tax_ind = ls_data_head-taxim. * * IF ls_data_head-taxm1 IS NOT INITIAL. * ls_taxclassifications-tax_type_1 = ls_data_head-taxm1. * ls_taxclassifications-taxclass_1 = ls_data_head-taxim. * ENDIF. * * IF ls_data_head-taxm2 IS NOT INITIAL. * ls_taxclassifications-tax_type_2 = ls_data_head-taxm2. * ls_taxclassifications-taxclass_2 = ls_data_head-taxim. * ENDIF. * * IF ls_data_head-taxm3 IS NOT INITIAL. * ls_taxclassifications-tax_type_3 = ls_data_head-taxm3. * ls_taxclassifications-taxclass_3 = ls_data_head-taxim. * ENDIF. * * IF ls_data_head-taxm4 IS NOT INITIAL. * ls_taxclassifications-tax_type_4 = ls_data_head-taxm4. * ls_taxclassifications-taxclass_4 = ls_data_head-taxim. * ENDIF. * * IF ls_data_head-taxm5 IS NOT INITIAL. * ls_taxclassifications-tax_type_5 = ls_data_head-taxm5. * ls_taxclassifications-taxclass_5 = ls_data_head-taxim. * ENDIF. * * IF ls_data_head-taxm6 IS NOT INITIAL. * ls_taxclassifications-tax_type_6 = ls_data_head-taxm6. * ls_taxclassifications-taxclass_6 = ls_data_head-taxim. * ENDIF. * * IF ls_data_head-taxm7 IS NOT INITIAL. * ls_taxclassifications-tax_type_7 = ls_data_head-taxm7. * ls_taxclassifications-taxclass_7 = ls_data_head-taxim. * ENDIF. * * IF ls_data_head-taxm8 IS NOT INITIAL. * ls_taxclassifications-tax_type_8 = ls_data_head-taxm8. * ls_taxclassifications-taxclass_8 = ls_data_head-taxim. * ENDIF. * * IF ls_data_head-taxm9 IS NOT INITIAL. * ls_taxclassifications-tax_type_9 = ls_data_head-taxm9. * ls_taxclassifications-taxclass_9 = ls_data_head-taxim. * ENDIF. * * INSERT ls_taxclassifications INTO TABLE lt_taxclassifications. **&---------------------------------------------------------------------* **& MARM **&---------------------------------------------------------------------* * DATA ls_marm_ga TYPE marm. * DATA ls_bapi_marm_ga TYPE bapi_marm_ga. * * LOOP AT GROUP ls_data_grp INTO ls_data. * CLEAR ls_marm_ga. * CLEAR ls_unitsofmeasure. * ls_marm_ga = CORRESPONDING #( ls_data ). * CALL FUNCTION 'MAP2E_MARM_TO_BAPIE1MARM' * EXPORTING * marm = ls_marm_ga * CHANGING * bapie1marm = ls_unitsofmeasure. * ls_unitsofmeasure-material_long = l_matnr. * * CLEAR ls_unitsofmeasurex. * PERFORM map_data_to_datax USING 'BAPIE1MARMX' ls_unitsofmeasure CHANGING ls_unitsofmeasurex. * * INSERT ls_unitsofmeasure INTO TABLE lt_unitsofmeasure. * INSERT ls_unitsofmeasurex INTO TABLE lt_unitsofmeasurex. * ENDLOOP. * * SORT lt_unitsofmeasure BY alt_unit alt_unit_iso. * SORT lt_unitsofmeasurex BY alt_unit alt_unit_iso. * DELETE ADJACENT DUPLICATES FROM lt_unitsofmeasure COMPARING alt_unit alt_unit_iso. * DELETE ADJACENT DUPLICATES FROM lt_unitsofmeasurex COMPARING alt_unit alt_unit_iso. *&---------------------------------------------------------------------* *& \u5bfc\u5165\u7269\u6599 *&---------------------------------------------------------------------* CLEAR lt_return . CALL FUNCTION 'BAPI_MATERIAL_SAVEREPLICA' EXPORTING noappllog = l_global_data - no_appl_log nochangedoc = l_global_data - no_change_doc testrun = l_global_data - testrun inpfldcheck = l_global_data - inp_fld_check TABLES headdata = lt_headdata clientdata = lt_clientdata clientdatax = lt_clientdatax plantdata = lt_plantdata plantdatax = lt_plantdatax forecastparameters = lt_forecastparameters forecastparametersx = lt_forecastparametersx planningdata = lt_planningdata planningdatax = lt_planningdatax storagelocationdata = lt_storagelocationdata storagelocationdatax = lt_storagelocationdatax valuationdata = lt_valuationdata valuationdatax = lt_valuationdatax warehousenumberdata = lt_warehousenumberdata warehousenumberdatax = lt_warehousenumberdatax salesdata = lt_salesdata salesdatax = lt_salesdatax storagetypedata = lt_storagetypedata storagetypedatax = lt_storagetypedatax materialdescription = lt_materialdescription unitsofmeasure = lt_unitsofmeasure unitsofmeasurex = lt_unitsofmeasurex * internationalartnos = lt_internationalartnos * materiallongtext = lt_materiallongtext taxclassifications = lt_taxclassifications * prtdata = lt_prtdata * prtdatax = lt_prtdatax extensionin = lt_extensionin extensioninx = lt_extensioninx * forecastvalues = lt_forecastvalues * unplndconsumption = lt_unplndconsumption * totalconsumption = lt_totalconsumption returnmessages = lt_return . CLEAR l_mtype . CLEAR l_msg . LOOP AT lt_return INTO ls_return WHERE type CA 'AXE' . MESSAGE ID ls_return - id TYPE ls_return - type NUMBER ls_return - number WITH ls_return - message_v1 ls_return - message_v2 ls_return - message_v3 ls_return - message_v4 INTO ls_return - message . l_msg = |{ l_msg }{ ls_return - message }|. ENDLOOP . IF sy - subrc = 0 . l_mtype = 'E' . CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK' . ELSE . l_matnr = lt_headdata [ 1 ] - material_long . l_mtype = 'S' . l_msg = '\u5df2\u5904\u7406' . CALL FUNCTION 'BAPI_TRANSACTION_COMMIT' EXPORTING wait = abap_true . ENDIF . \" \u56de\u5199\u6d88\u606f LOOP AT GROUP ls_data_grp REFERENCE INTO DATA ( lr_data ). lr_data -> mtype = l_mtype . lr_data -> msg = l_msg . ENDLOOP . ENDLOOP . ENDFUNCTION . *&---------------------------------------------------------------------* *& \u540c\u540dBAPIUPDATE\u5b57\u6bb5\u8d4b\u503c *&---------------------------------------------------------------------* FORM map_data_to_datax USING i_name TYPE tabname i_data TYPE data CHANGING c_datax TYPE data . FIELD-SYMBOLS <wa> TYPE any . FIELD-SYMBOLS <wax> TYPE any . SELECT fieldname , rollname FROM dd03l WHERE tabname = @ i_name INTO TABLE @ DATA ( lt_field ). LOOP AT lt_field INTO DATA ( ls_field ). ASSIGN COMPONENT ls_field - fieldname OF STRUCTURE i_data TO <wa> . ASSIGN COMPONENT ls_field - fieldname OF STRUCTURE c_datax TO <wax> . IF <wa> IS ASSIGNED AND <wax> IS ASSIGNED . IF ls_field - rollname = 'BAPIUPDATE' . IF <wa> IS NOT INITIAL AND <wa> <> '' . <wax> = abap_true . ENDIF . ELSE . <wax> = <wa> . ENDIF . ENDIF . ENDLOOP . ENDFORM .","title":"\u7269\u6599\u7ef4\u62a4"},{"location":"master_data/material/#_3","text":"BAPI_OBJCL_EXISTENCECHECK \uff0c\u68c0\u67e5\u7269\u6599\u662f\u5426\u5b58\u5728\u5206\u7c7b\u89c6\u56fe BAPI_OBJCL_CREATE \uff0c\u521b\u5efa\u7269\u6599\u5206\u7c7b\u89c6\u56fe BAPI_OBJCL_CHANGE \uff0c\u4fee\u6539\u7269\u6599\u5206\u7c7b\u89c6\u56fe BAPI_OBJCL_GETDETAIL \uff0c\u83b7\u53d6\u7269\u6599\u5206\u7c7b\u7279\u5f81\u503c \u793a\u4f8b\u4ee3\u7801","title":"\u7269\u6599\u5206\u7c7b\u89c6\u56fe"},{"location":"master_data/material/#idoc","text":"SAP\u7cfb\u7edf\u95f4\u8fc1\u79fb\u6216\u540c\u6b65\u7269\u6599\uff0c\u63a8\u8350\u4f7f\u7528IDOC\u5b9e\u73b0\uff0c\u4e0b\u9762\u8bb2\u8ff0\u5b9e\u73b0\u8fc7\u7a0b\u3002 \u793a\u4f8b\u4ee3\u7801","title":"IDOC\u7269\u6599\u540c\u6b65"},{"location":"master_data/work_center/","text":"\u5de5\u4f5c\u4e2d\u5fc3 \u00b6 \u4f7f\u7528 CL_PP_WORK_CENTER_BO \u5bfc\u5165\u5de5\u4f5c\u4e2d\u5fc3 \u4e0a\u9762\u7c7b\u901a\u8fc7\u5c01\u88c5 CRAP_WORKCENTER_CREATE \u5b9e\u73b0\uff0c\u5e76\u591a\u4e86\u8fd4\u56de\u4fe1\u606f \u793a\u4f8b\u4ee3\u7801 TYPES : BEGIN OF ty_data , \" \u521b\u5efa\u5de5\u4f5c\u4e2d\u5fc3\u5fc5\u586b\u5b57\u6bb5 arbpl TYPE crhd - arbpl , \" \u5de5\u4f5c\u4e2d\u5fc3 werks TYPE crhd - werks , \" \u5de5\u5382 kostl TYPE crco - kostl , \" \u6210\u672c\u4e2d\u5fc3 \" \u5904\u7406\u8fd4\u56de mtype TYPE bapi_mtype , msg TYPE bapi_msg , END OF ty_data . DATA lt_data TYPE STANDARD TABLE OF ty_data . DATA ls_crhd_api01 TYPE crhd_api01 . DATA ls_crhd_api02 TYPE crhd_api02 . DATA ls_crhd_api03 TYPE crhd_api03 . DATA ls_crhd_api05 TYPE crhd_api05 . DATA lt_kapa_api01 TYPE STANDARD TABLE OF kapa_api01 . DATA lt_kapa_api02 TYPE STANDARD TABLE OF kapa_api02 . DATA lt_crhd_api04 TYPE STANDARD TABLE OF crhd_api04 . DATA lt_crco_api01 TYPE STANDARD TABLE OF crco_api01 . DATA ls_kapa_api01 TYPE kapa_api01 . DATA ls_kapa_api02 TYPE kapa_api02 . DATA ls_crhd_api04 TYPE crhd_api04 . DATA ls_crco_api01 TYPE crco_api01 . DATA lt_return TYPE bapiret2_tab . DATA l_mtype TYPE bapi_mtype . DATA l_msg TYPE bapi_msg . \" \u67e5\u627e\u5de5\u5382\u5bf9\u5e94\u65e5\u5386 IF lt_data[] IS NOT INITIAL . SELECT werks , fabkl FROM t001w FOR ALL ENTRIES IN @ lt_data[] WHERE werks = @ lt_data - werks INTO TABLE @ DATA ( lt_t001w ). SORT lt_t001w BY werks . DELETE ADJACENT DUPLICATES FROM lt_t001w COMPARING werks . ENDIF . \" \u5206\u7ec4\u5904\u7406 LOOP AT lt_data INTO DATA ( ls_data ) WHERE mtype <> 'E' GROUP BY ( arbpl = ls_data - arbpl werks = ls_data - werks group_size = GROUP SIZE ) INTO DATA ( ls_data_grp ). \" \u91cd\u590d\u4ee3\u7801\uff0c\u9000\u51fa\u65f6\u5199\u5165\u5904\u7406\u7ed3\u679c DATA lr_data LIKE REF TO ls_data . DEFINE _contiune . CLEAR l_mtype . CLEAR l_msg . l_mtype = &1 . l_msg = &2 . LOOP AT GROUP ls_data_grp REFERENCE INTO lr_data . lr_data -> mtype = l_mtype . lr_data -> msg = l_msg . ENDLOOP . CONTINUE . END-OF-DEFINITION . \" \u53d6\u5de5\u5382\u76f8\u5173\u6570\u636e READ TABLE lt_t001w INTO DATA ( ls_t001w ) WITH KEY werks = ls_data_grp - werks BINARY SEARCH . IF sy - subrc <> 0 . l_msg = | \u5de5\u5382 { ls_data_grp - werks } \u4e0d\u5b58\u5728 |. _contiune 'E' l_msg . ENDIF . CLEAR ls_crhd_api01 . ls_crhd_api01 - arbpl = ls_data_grp - arbpl . ls_crhd_api01 - werks = ls_data_grp - werks . ls_crhd_api01 - verwe = '0001' . ls_crhd_api01 - ktext = |{ ls_data_grp - arbpl } - { ls_data_grp - werks }|. \" \u5de5\u4f5c\u4e2d\u5fc3\u6587\u672c CLEAR ls_crhd_api02 . ls_crhd_api02 - planv = '009' . ls_crhd_api02 - veran = 'ZZ' . ls_crhd_api02 - vgwts = 'ZZZZ' . CLEAR ls_crhd_api03 . ls_crhd_api03 - steus = 'ZZ01' . ls_crhd_api03 - vge01 = 'STD' . \" h - \u5185\u7801 ls_crhd_api03 - vge02 = 'STD' . \" h - \u5185\u7801 ls_crhd_api03 - vge03 = 'STD' . \" h - \u5185\u7801 ls_crhd_api03 - vge04 = 'KG' . \" kg - \u5185\u7801 ls_crhd_api03 - vge05 = 'STD' . \" h - \u5185\u7801 ls_crhd_api03 - vge06 = 'KG' . \" kg - \u5185\u7801 CLEAR ls_crhd_api05 . ls_crhd_api05 - kapart = '001' . ls_crhd_api05 - fort2 = 'ZZ_PP' . CLEAR lt_kapa_api01 . CLEAR ls_kapa_api01 . ls_kapa_api01 - canum = '1' . ls_kapa_api01 - kapart = '001' . \" \u8fd9\u4e2a\u4e0d\u586b\uff0c\u4e0b\u9762FM\u624d\u4f1a\u4f1a\u81ea\u52a8\u521b\u5efa\u80fd\u529b \" \u6216\u8005\u624b\u5de5\u8c03\u7528CRAP_CAPACITY_CREATE\u521b\u5efa\u80fd\u529b \" ls_kapa_api01-kapname = '\u673a\u5668'. ls_kapa_api01 - werks = ls_data_grp - werks . ls_kapa_api01 - ktext = '\u673a\u5668' . ls_kapa_api01 - kapid = ls_t001w - fabkl . \" \u4f7f\u7528\u5de5\u5382\u65e5\u5386 INSERT ls_kapa_api01 INTO TABLE lt_kapa_api01 . CLEAR lt_kapa_api02 . CLEAR ls_kapa_api02 . ls_kapa_api02 - canum = '1' . ls_kapa_api02 - planr = 'ZZ' . ls_kapa_api02 - kalid = ls_t001w - fabkl . ls_kapa_api02 - meins = 'STD' . \" h - \u5185\u7801 ls_kapa_api02 - begzt = '000000' . ls_kapa_api02 - endzt = '240000' . ls_kapa_api02 - ngrad = '100' . ls_kapa_api02 - aznor = ls_data_grp - group_size . \" \u6709\u591a\u5c11\u884c\u9879\u76ee INSERT ls_kapa_api02 INTO TABLE lt_kapa_api02 . CLEAR lt_crhd_api04 . CLEAR ls_crhd_api04 . ls_crhd_api04 - canum = '1' . ls_crhd_api04 - fork2 = 'ZZ_PP' . INSERT ls_crhd_api04 INTO TABLE lt_crhd_api04 . CLEAR lt_crco_api01 . LOOP AT GROUP ls_data_grp INTO ls_data . CLEAR ls_crco_api01 . ls_crco_api01 - kostl = ls_data - kostl . ls_crco_api01 - begda = sy - datum . ls_crco_api01 - endda = '99991231' . ls_crco_api01 - lstar1 = '1000' . ls_crco_api01 - lstar_ref1 = 'X' . ls_crco_api01 - leinh1 = 'STD' . \" h - \u5185\u7801 ls_crco_api01 - forml1 = 'ZZ_CO1' . ls_crco_api01 - lstar2 = '2000' . ls_crco_api01 - lstar_ref2 = 'X' . ls_crco_api01 - leinh2 = 'STD' . \" h - \u5185\u7801 ls_crco_api01 - forml2 = 'ZZ_CO2' . ls_crco_api01 - lstar3 = '3000' . ls_crco_api01 - lstar_ref3 = 'X' . ls_crco_api01 - leinh3 = 'STD' . \" h - \u5185\u7801 ls_crco_api01 - forml3 = 'ZZ_CO3' . ls_crco_api01 - lstar4 = '4000' . ls_crco_api01 - lstar_ref4 = 'X' . ls_crco_api01 - leinh4 = 'KG' . \" kg - \u5185\u7801 ls_crco_api01 - forml4 = 'ZZ_CO4' . ls_crco_api01 - lstar5 = '5000' . ls_crco_api01 - lstar_ref5 = 'X' . ls_crco_api01 - leinh5 = 'STD' . \" h - \u5185\u7801 ls_crco_api01 - forml5 = 'ZZ_CO5' . ls_crco_api01 - lstar6 = '6000' . ls_crco_api01 - lstar_ref6 = 'X' . ls_crco_api01 - leinh6 = 'KG' . \" kg - \u5185\u7801 ls_crco_api01 - forml6 = 'ZZ_CO6' . INSERT ls_crco_api01 INTO TABLE lt_crco_api01 . ENDLOOP . \" \u53ef\u80fd\u4e0d\u540c\u884c\u53ea\u662f\u8bbe\u5907\u7801\u4e0d\u4e00\u6837\uff0c\u800c\u6210\u672c\u4e2d\u5fc3\u662f\u4e00\u81f4\u7684 SORT lt_crco_api01 BY kostl . DELETE ADJACENT DUPLICATES FROM lt_crco_api01 COMPARING kostl . * CALL FUNCTION 'CRAP_WORKCENTER_CREATE' * EXPORTING * in_crhd_api01 = ls_crhd_api01 * in_crhd_api02 = ls_crhd_api02 * in_crhd_api03 = ls_crhd_api03 * in_crhd_api05 = ls_crhd_api05 * test = i_test * TABLES * in_kapa_api01 = lt_kapa_api01 * in_kapa_api02 = lt_kapa_api02 * in_crhd_api04 = lt_crhd_api04 * in_crco_api01 = lt_crco_api01. \" \u6362\u4e2a\u6807\u51c6\u5e26\u8fd4\u56de\u7684\uff0c\u65b9\u4fbf\u5c55\u793a\u6d88\u606f DATA ( lo_work_center ) = cl_pp_work_center_bo => get_instance ( ). CLEAR lt_return . lo_work_center -> create_work_center ( EXPORTING is_crhd_api01 = ls_crhd_api01 is_crhd_api02 = ls_crhd_api02 is_crhd_api03 = ls_crhd_api03 it_crhd_api04 = lt_crhd_api04 is_crhd_api05 = ls_crhd_api05 it_kapa_api01 = lt_kapa_api01 it_kapa_api02 = lt_kapa_api02 it_crco_api01 = lt_crco_api01 IMPORTING et_return = lt_return ). CLEAR l_mtype . CLEAR l_msg . LOOP AT lt_return INTO DATA ( ls_return ) WHERE type CA 'EA' . l_msg = |{ l_msg }{ ls_return - message } ; |. ENDLOOP . IF sy - subrc = 0 . _contiune 'E' l_msg . ELSE . _contiune 'S' '\u5de5\u4f5c\u4e2d\u5fc3\u5bfc\u5165\u6210\u529f' . ENDIF . ENDLOOP .","title":"\u5de5\u4f5c\u4e2d\u5fc3"},{"location":"master_data/work_center/#_1","text":"\u4f7f\u7528 CL_PP_WORK_CENTER_BO \u5bfc\u5165\u5de5\u4f5c\u4e2d\u5fc3 \u4e0a\u9762\u7c7b\u901a\u8fc7\u5c01\u88c5 CRAP_WORKCENTER_CREATE \u5b9e\u73b0\uff0c\u5e76\u591a\u4e86\u8fd4\u56de\u4fe1\u606f \u793a\u4f8b\u4ee3\u7801 TYPES : BEGIN OF ty_data , \" \u521b\u5efa\u5de5\u4f5c\u4e2d\u5fc3\u5fc5\u586b\u5b57\u6bb5 arbpl TYPE crhd - arbpl , \" \u5de5\u4f5c\u4e2d\u5fc3 werks TYPE crhd - werks , \" \u5de5\u5382 kostl TYPE crco - kostl , \" \u6210\u672c\u4e2d\u5fc3 \" \u5904\u7406\u8fd4\u56de mtype TYPE bapi_mtype , msg TYPE bapi_msg , END OF ty_data . DATA lt_data TYPE STANDARD TABLE OF ty_data . DATA ls_crhd_api01 TYPE crhd_api01 . DATA ls_crhd_api02 TYPE crhd_api02 . DATA ls_crhd_api03 TYPE crhd_api03 . DATA ls_crhd_api05 TYPE crhd_api05 . DATA lt_kapa_api01 TYPE STANDARD TABLE OF kapa_api01 . DATA lt_kapa_api02 TYPE STANDARD TABLE OF kapa_api02 . DATA lt_crhd_api04 TYPE STANDARD TABLE OF crhd_api04 . DATA lt_crco_api01 TYPE STANDARD TABLE OF crco_api01 . DATA ls_kapa_api01 TYPE kapa_api01 . DATA ls_kapa_api02 TYPE kapa_api02 . DATA ls_crhd_api04 TYPE crhd_api04 . DATA ls_crco_api01 TYPE crco_api01 . DATA lt_return TYPE bapiret2_tab . DATA l_mtype TYPE bapi_mtype . DATA l_msg TYPE bapi_msg . \" \u67e5\u627e\u5de5\u5382\u5bf9\u5e94\u65e5\u5386 IF lt_data[] IS NOT INITIAL . SELECT werks , fabkl FROM t001w FOR ALL ENTRIES IN @ lt_data[] WHERE werks = @ lt_data - werks INTO TABLE @ DATA ( lt_t001w ). SORT lt_t001w BY werks . DELETE ADJACENT DUPLICATES FROM lt_t001w COMPARING werks . ENDIF . \" \u5206\u7ec4\u5904\u7406 LOOP AT lt_data INTO DATA ( ls_data ) WHERE mtype <> 'E' GROUP BY ( arbpl = ls_data - arbpl werks = ls_data - werks group_size = GROUP SIZE ) INTO DATA ( ls_data_grp ). \" \u91cd\u590d\u4ee3\u7801\uff0c\u9000\u51fa\u65f6\u5199\u5165\u5904\u7406\u7ed3\u679c DATA lr_data LIKE REF TO ls_data . DEFINE _contiune . CLEAR l_mtype . CLEAR l_msg . l_mtype = &1 . l_msg = &2 . LOOP AT GROUP ls_data_grp REFERENCE INTO lr_data . lr_data -> mtype = l_mtype . lr_data -> msg = l_msg . ENDLOOP . CONTINUE . END-OF-DEFINITION . \" \u53d6\u5de5\u5382\u76f8\u5173\u6570\u636e READ TABLE lt_t001w INTO DATA ( ls_t001w ) WITH KEY werks = ls_data_grp - werks BINARY SEARCH . IF sy - subrc <> 0 . l_msg = | \u5de5\u5382 { ls_data_grp - werks } \u4e0d\u5b58\u5728 |. _contiune 'E' l_msg . ENDIF . CLEAR ls_crhd_api01 . ls_crhd_api01 - arbpl = ls_data_grp - arbpl . ls_crhd_api01 - werks = ls_data_grp - werks . ls_crhd_api01 - verwe = '0001' . ls_crhd_api01 - ktext = |{ ls_data_grp - arbpl } - { ls_data_grp - werks }|. \" \u5de5\u4f5c\u4e2d\u5fc3\u6587\u672c CLEAR ls_crhd_api02 . ls_crhd_api02 - planv = '009' . ls_crhd_api02 - veran = 'ZZ' . ls_crhd_api02 - vgwts = 'ZZZZ' . CLEAR ls_crhd_api03 . ls_crhd_api03 - steus = 'ZZ01' . ls_crhd_api03 - vge01 = 'STD' . \" h - \u5185\u7801 ls_crhd_api03 - vge02 = 'STD' . \" h - \u5185\u7801 ls_crhd_api03 - vge03 = 'STD' . \" h - \u5185\u7801 ls_crhd_api03 - vge04 = 'KG' . \" kg - \u5185\u7801 ls_crhd_api03 - vge05 = 'STD' . \" h - \u5185\u7801 ls_crhd_api03 - vge06 = 'KG' . \" kg - \u5185\u7801 CLEAR ls_crhd_api05 . ls_crhd_api05 - kapart = '001' . ls_crhd_api05 - fort2 = 'ZZ_PP' . CLEAR lt_kapa_api01 . CLEAR ls_kapa_api01 . ls_kapa_api01 - canum = '1' . ls_kapa_api01 - kapart = '001' . \" \u8fd9\u4e2a\u4e0d\u586b\uff0c\u4e0b\u9762FM\u624d\u4f1a\u4f1a\u81ea\u52a8\u521b\u5efa\u80fd\u529b \" \u6216\u8005\u624b\u5de5\u8c03\u7528CRAP_CAPACITY_CREATE\u521b\u5efa\u80fd\u529b \" ls_kapa_api01-kapname = '\u673a\u5668'. ls_kapa_api01 - werks = ls_data_grp - werks . ls_kapa_api01 - ktext = '\u673a\u5668' . ls_kapa_api01 - kapid = ls_t001w - fabkl . \" \u4f7f\u7528\u5de5\u5382\u65e5\u5386 INSERT ls_kapa_api01 INTO TABLE lt_kapa_api01 . CLEAR lt_kapa_api02 . CLEAR ls_kapa_api02 . ls_kapa_api02 - canum = '1' . ls_kapa_api02 - planr = 'ZZ' . ls_kapa_api02 - kalid = ls_t001w - fabkl . ls_kapa_api02 - meins = 'STD' . \" h - \u5185\u7801 ls_kapa_api02 - begzt = '000000' . ls_kapa_api02 - endzt = '240000' . ls_kapa_api02 - ngrad = '100' . ls_kapa_api02 - aznor = ls_data_grp - group_size . \" \u6709\u591a\u5c11\u884c\u9879\u76ee INSERT ls_kapa_api02 INTO TABLE lt_kapa_api02 . CLEAR lt_crhd_api04 . CLEAR ls_crhd_api04 . ls_crhd_api04 - canum = '1' . ls_crhd_api04 - fork2 = 'ZZ_PP' . INSERT ls_crhd_api04 INTO TABLE lt_crhd_api04 . CLEAR lt_crco_api01 . LOOP AT GROUP ls_data_grp INTO ls_data . CLEAR ls_crco_api01 . ls_crco_api01 - kostl = ls_data - kostl . ls_crco_api01 - begda = sy - datum . ls_crco_api01 - endda = '99991231' . ls_crco_api01 - lstar1 = '1000' . ls_crco_api01 - lstar_ref1 = 'X' . ls_crco_api01 - leinh1 = 'STD' . \" h - \u5185\u7801 ls_crco_api01 - forml1 = 'ZZ_CO1' . ls_crco_api01 - lstar2 = '2000' . ls_crco_api01 - lstar_ref2 = 'X' . ls_crco_api01 - leinh2 = 'STD' . \" h - \u5185\u7801 ls_crco_api01 - forml2 = 'ZZ_CO2' . ls_crco_api01 - lstar3 = '3000' . ls_crco_api01 - lstar_ref3 = 'X' . ls_crco_api01 - leinh3 = 'STD' . \" h - \u5185\u7801 ls_crco_api01 - forml3 = 'ZZ_CO3' . ls_crco_api01 - lstar4 = '4000' . ls_crco_api01 - lstar_ref4 = 'X' . ls_crco_api01 - leinh4 = 'KG' . \" kg - \u5185\u7801 ls_crco_api01 - forml4 = 'ZZ_CO4' . ls_crco_api01 - lstar5 = '5000' . ls_crco_api01 - lstar_ref5 = 'X' . ls_crco_api01 - leinh5 = 'STD' . \" h - \u5185\u7801 ls_crco_api01 - forml5 = 'ZZ_CO5' . ls_crco_api01 - lstar6 = '6000' . ls_crco_api01 - lstar_ref6 = 'X' . ls_crco_api01 - leinh6 = 'KG' . \" kg - \u5185\u7801 ls_crco_api01 - forml6 = 'ZZ_CO6' . INSERT ls_crco_api01 INTO TABLE lt_crco_api01 . ENDLOOP . \" \u53ef\u80fd\u4e0d\u540c\u884c\u53ea\u662f\u8bbe\u5907\u7801\u4e0d\u4e00\u6837\uff0c\u800c\u6210\u672c\u4e2d\u5fc3\u662f\u4e00\u81f4\u7684 SORT lt_crco_api01 BY kostl . DELETE ADJACENT DUPLICATES FROM lt_crco_api01 COMPARING kostl . * CALL FUNCTION 'CRAP_WORKCENTER_CREATE' * EXPORTING * in_crhd_api01 = ls_crhd_api01 * in_crhd_api02 = ls_crhd_api02 * in_crhd_api03 = ls_crhd_api03 * in_crhd_api05 = ls_crhd_api05 * test = i_test * TABLES * in_kapa_api01 = lt_kapa_api01 * in_kapa_api02 = lt_kapa_api02 * in_crhd_api04 = lt_crhd_api04 * in_crco_api01 = lt_crco_api01. \" \u6362\u4e2a\u6807\u51c6\u5e26\u8fd4\u56de\u7684\uff0c\u65b9\u4fbf\u5c55\u793a\u6d88\u606f DATA ( lo_work_center ) = cl_pp_work_center_bo => get_instance ( ). CLEAR lt_return . lo_work_center -> create_work_center ( EXPORTING is_crhd_api01 = ls_crhd_api01 is_crhd_api02 = ls_crhd_api02 is_crhd_api03 = ls_crhd_api03 it_crhd_api04 = lt_crhd_api04 is_crhd_api05 = ls_crhd_api05 it_kapa_api01 = lt_kapa_api01 it_kapa_api02 = lt_kapa_api02 it_crco_api01 = lt_crco_api01 IMPORTING et_return = lt_return ). CLEAR l_mtype . CLEAR l_msg . LOOP AT lt_return INTO DATA ( ls_return ) WHERE type CA 'EA' . l_msg = |{ l_msg }{ ls_return - message } ; |. ENDLOOP . IF sy - subrc = 0 . _contiune 'E' l_msg . ELSE . _contiune 'S' '\u5de5\u4f5c\u4e2d\u5fc3\u5bfc\u5165\u6210\u529f' . ENDIF . ENDLOOP .","title":"\u5de5\u4f5c\u4e2d\u5fc3"},{"location":"mm/","text":"MM\u6a21\u5757\u6982\u8ff0 \u00b6 \u6211\u7406\u89e3\u7684MM\uff08Material Management\uff09\uff0c\u7269\u6599\u7ba1\u7406\u6a21\u5757\uff0c\u5305\u62ec\u4e86\u7269\u6599\u4e3b\u6570\u636e\uff0c\u91c7\u8d2d\u7ba1\u7406\uff0c\u5e93\u5b58\u7ba1\u7406\uff0c\u5171\u4e09\u4e2a\u90e8\u5206\u3002","title":"MM\u6a21\u5757\u6982\u8ff0"},{"location":"mm/#mm","text":"\u6211\u7406\u89e3\u7684MM\uff08Material Management\uff09\uff0c\u7269\u6599\u7ba1\u7406\u6a21\u5757\uff0c\u5305\u62ec\u4e86\u7269\u6599\u4e3b\u6570\u636e\uff0c\u91c7\u8d2d\u7ba1\u7406\uff0c\u5e93\u5b58\u7ba1\u7406\uff0c\u5171\u4e09\u4e2a\u90e8\u5206\u3002","title":"MM\u6a21\u5757\u6982\u8ff0"},{"location":"mm/inbound_delivery/","text":"\u5185\u5411\u4ea4\u8d27\u5355 \u00b6","title":"\u5185\u5411\u4ea4\u8d27\u5355"},{"location":"mm/inbound_delivery/#_1","text":"","title":"\u5185\u5411\u4ea4\u8d27\u5355"},{"location":"mm/inbound_delivery_post/","text":"\u91c7\u8d2d\u6536\u8d27\u8fc7\u8d26 \u00b6","title":"\u6536\u8d27\u8fc7\u8d26"},{"location":"mm/inbound_delivery_post/#_1","text":"","title":"\u91c7\u8d2d\u6536\u8d27\u8fc7\u8d26"},{"location":"mm/purchase/","text":"\u91c7\u8d2d\u8ba2\u5355 \u00b6","title":"\u91c7\u8d2d\u8ba2\u5355"},{"location":"mm/purchase/#_1","text":"","title":"\u91c7\u8d2d\u8ba2\u5355"},{"location":"others/","text":"\u5176\u4ed6\u6982\u8ff0 \u00b6 \u4e0d\u5728\u5b9e\u65bd\u6d41\u7a0b\u4e2d\uff0c\u6216\u591a\u4e2a\u6a21\u5757\u7686\u6709\u5f15\u7528\u7684\u529f\u80fd\uff0c\u90fd\u4f1a\u6574\u7406\u5728\u5176\u4ed6\u6a21\u5757\u4e2d\u3002","title":"\u5176\u4ed6\u6982\u8ff0"},{"location":"others/#_1","text":"\u4e0d\u5728\u5b9e\u65bd\u6d41\u7a0b\u4e2d\uff0c\u6216\u591a\u4e2a\u6a21\u5757\u7686\u6709\u5f15\u7528\u7684\u529f\u80fd\uff0c\u90fd\u4f1a\u6574\u7406\u5728\u5176\u4ed6\u6a21\u5757\u4e2d\u3002","title":"\u5176\u4ed6\u6982\u8ff0"},{"location":"others/alv/","text":"ALV \u00b6 \u6574\u7406\u4e0bALV\u7528\u5230\u7684\u51e0\u79cd\u65b9\u6cd5\u3002 LVC \u00b6 LVC\u597d\u5728\u4e0d\u7528\u753b\u5c4f\u5e55\uff0c\u76f4\u63a5\u8c03\u7528\u5373\u53ef\u3002 INCLUDE_LVC *&---------------------------------------------------------------------* *& Form frm_display *&---------------------------------------------------------------------* *& text *&---------------------------------------------------------------------* *& --> p1 text *& <-- p2 text *&---------------------------------------------------------------------* FORM frm_display TABLES ct_data TYPE STANDARD TABLE . DATA ls_layout TYPE lvc_s_layo . DATA lt_fieldcat TYPE STANDARD TABLE OF lvc_s_fcat . PERFORM frm_set_layout CHANGING ls_layout . PERFORM frm_set_fieldcat TABLES lt_fieldcat . CALL FUNCTION 'REUSE_ALV_GRID_DISPLAY_LVC' EXPORTING i_callback_program = sy - repid i_callback_pf_status_set = 'FRM_PF_STATUS' i_callback_user_command = 'FRM_USER_COMMAND' is_layout_lvc = ls_layout it_fieldcat_lvc = lt_fieldcat i_default = abap_true i_save = 'A' TABLES t_outtab = ct_data[] EXCEPTIONS program_error = 1 OTHERS = 2 . IF sy - subrc <> 0 . MESSAGE ID sy - msgid TYPE sy - msgty NUMBER sy - msgno WITH sy - msgv1 sy - msgv2 sy - msgv3 sy - msgv4 . ENDIF . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_set_layout *&---------------------------------------------------------------------* *& \u62a5\u8868\u5e03\u5c40\u8bbe\u7f6e *&---------------------------------------------------------------------* FORM frm_set_layout CHANGING cs_layout TYPE lvc_s_layo . CLEAR cs_layout . cs_layout - zebra = abap_true . \" \u6591\u9a6c\u7ebf cs_layout - cwidth_opt = abap_true . \" \u81ea\u52a8\u8c03\u6574ALVL\u5217\u5bbd cs_layout - sel_mode = 'A' . \" \u9009\u62e9\u6a21\u5f0f * CS_LAYOUT - box_fname = 'CHECKBOX' . \" \u9009\u62e9\u6846 * CS_LAYOUT - ctab_fname = 'COLTAB' . \" \u5355\u5143\u683c\u989c\u8272\u8bbe\u7f6e ENDFORM . *&---------------------------------------------------------------------* *& Form frm_set_fieldcat *&---------------------------------------------------------------------* *& \u5b57\u6bb5\u76ee\u5f55\u8bbe\u7f6e *&---------------------------------------------------------------------* FORM frm_set_fieldcat TABLES ct_fieldcat TYPE lvc_t_fcat . DATA ls_fieldcat TYPE lvc_s_fcat . DEFINE _init_fieldcat . CLEAR ls_fieldcat . ls_fieldcat - fieldname = &1 . ls_fieldcat - tooltip = ls_fieldcat - coltext = ls_fieldcat - seltext = ls_fieldcat - scrtext_l = ls_fieldcat - scrtext_m = ls_fieldcat - scrtext_s = &2 . ls_fieldcat - ref_table = &3 . ls_fieldcat - ref_field = &4 . INSERT ls_fieldcat INTO TABLE ct_fieldcat . END-OF-DEFINITION . _init_fieldcat 'ZSEL' '\u9009\u62e9\u9879' '' '' . _init_fieldcat 'MTYPE ' '\u5904\u7406\u72b6\u6001' '' '' . _init_fieldcat 'MSG ' '\u5904\u7406\u6d88\u606f' '' '' . \" \u4e2a\u6027\u5316\u81ea\u5df1\u8f93\u51fa\u6570\u636e\u683c\u5f0f LOOP AT ct_fieldcat REFERENCE INTO DATA ( lr_fieldcat ). \" \u5b57\u6bb5\u663e\u793a\u5c5e\u6027\u8bbe\u7f6e CASE lr_fieldcat -> fieldname . WHEN 'ZSEL' . lr_fieldcat -> checkbox = abap_true . lr_fieldcat -> edit = abap_true . lr_fieldcat -> hotspot = abap_true . WHEN 'MENGE' . lr_fieldcat -> qfieldname = 'MEINS' . WHEN OTHERS . ENDCASE . ENDLOOP . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_pf_status *&---------------------------------------------------------------------* *& \u8bbe\u7f6eGUI\u72b6\u6001 *&---------------------------------------------------------------------* FORM frm_pf_status USING ct_extab TYPE slis_t_extab . SET PF-STATUS 'STATUS' . SET TITLEBAR 'TITLE' . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_user_command *&---------------------------------------------------------------------* *& \u529f\u80fd\u54cd\u5e94 *&---------------------------------------------------------------------* FORM frm_user_command USING cv_ucomm LIKE sy - ucomm cs_selfield TYPE slis_selfield . \" \u5237\u65b0\u5c4f\u5e55\u6570\u636e\u5230\u5185\u8868 DATA : lo_grid TYPE REF TO cl_gui_alv_grid . CALL FUNCTION 'GET_GLOBALS_FROM_SLVC_FULLSCR' IMPORTING e_grid = lo_grid . CALL METHOD lo_grid -> check_changed_data . PERFORM frm_get_data_selection . \" \u6309\u94ae\u529f\u80fd\u5b9e\u73b0 CASE cv_ucomm . WHEN '&IC1' . \" \u53cc\u51fb WHEN OTHERS . ENDCASE . \" \u5237\u65b0ALV \u663e\u793a\u503c cs_selfield - refresh = abap_true . cs_selfield - row_stable = abap_true . cs_selfield - col_stable = abap_true . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_get_data_selection *&---------------------------------------------------------------------* *& text *&---------------------------------------------------------------------* *& --> p1 text *& <-- p2 text *&---------------------------------------------------------------------* FORM frm_get_data_selection . \" \u5237\u65b0\u5c4f\u5e55\u6570\u636e\u5230\u5185\u8868 DATA : lo_grid TYPE REF TO cl_gui_alv_grid . CALL FUNCTION 'GET_GLOBALS_FROM_SLVC_FULLSCR' IMPORTING e_grid = lo_grid . \" \u83b7\u53d6ALV\u9009\u53d6\u884c DATA lt_rows TYPE lvc_t_row . CALL METHOD lo_grid -> get_selected_rows IMPORTING et_index_rows = lt_rows . LOOP AT lt_rows INTO DATA ( ls_row ). READ TABLE gt_data REFERENCE INTO DATA ( lr_data ) INDEX ls_row - index . IF sy - subrc = 0 . lr_data -> zsel = abap_true . ENDIF . ENDLOOP . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_reset_data_selection *&---------------------------------------------------------------------* *& text *&---------------------------------------------------------------------* *& --> p1 text *& <-- p2 text *&---------------------------------------------------------------------* FORM frm_reset_data_selection . LOOP AT gt_data REFERENCE INTO DATA ( lr_data ). CLEAR lr_data -> zsel . ENDLOOP . ENDFORM . ALV GRID \u00b6 OOALV\u53ef\u5b9a\u5236\u7684\u529f\u80fd\u66f4\u5b8c\u5584\uff0c\u9002\u5408\u590d\u6742\u7684\u62a5\u8868\u5f00\u53d1\u3002 INCLUDE_ALV_GRID CLASS lcl_event_handler DEFINITION DEFERRED . DATA go_container TYPE REF TO cl_gui_container . DATA go_alv_grid TYPE REF TO cl_gui_alv_grid . DATA go_handler TYPE REF TO lcl_event_handler . *&---------------------------------------------------------------------* *& Form lcl_event_handler *&---------------------------------------------------------------------* CLASS lcl_event_handler DEFINITION . PUBLIC SECTION . \" \u6570\u636e\u53d8\u66f4\u4e8b\u4ef6 METHODS on_data_changed_finished FOR EVENT data_changed_finished OF cl_gui_alv_grid IMPORTING e_modified et_good_cells . \" \u5de5\u5177\u680f\u8c03\u6574 METHODS on_toolbar FOR EVENT toolbar OF cl_gui_alv_grid IMPORTING e_object e_interactive . \" \u54cd\u5e94\u5de5\u5177\u680f\u4e8b\u4ef6 \" \u70b9\u51fb\u6309\u94ae\u4e4b\u7c7b\u7684\u4e8b\u4ef6 METHODS on_user_command FOR EVENT user_command OF cl_gui_alv_grid IMPORTING e_ucomm . ENDCLASS . *&---------------------------------------------------------------------* *& Form lcl_event_handler *&---------------------------------------------------------------------* CLASS lcl_event_handler IMPLEMENTATION . *&---------------------------------------------------------------------* *& on_data_changed_finished *&---------------------------------------------------------------------* METHOD on_data_changed_finished . CHECK e_modified = abap_true . LOOP AT et_good_cells INTO DATA ( ls_cell ). READ TABLE gt_data REFERENCE INTO DATA ( lr_data ) INDEX ls_cell - row_id . IF sy - subrc = 0 . ENDIF . ENDLOOP . PERFORM frm_refresh_display . ENDMETHOD . *&---------------------------------------------------------------------* *& on_toolbar *&---------------------------------------------------------------------* METHOD on_toolbar . \" \u79fb\u9664\u7f16\u8f91\u76f8\u5173\u7684\u6309\u94ae DELETE e_object -> mt_toolbar WHERE function CS '&LOCAL&' . \" \u65b0\u589e\u6309\u94ae DATA ls_button LIKE LINE OF e_object -> mt_toolbar . CLEAR ls_button . ls_button - function = 'Z10' . ls_button - icon = icon_system_copy . ls_button - quickinfo = ls_button - text = '' . INSERT ls_button INTO TABLE e_object -> mt_toolbar . ENDMETHOD . *&---------------------------------------------------------------------* *& on_user_command *&---------------------------------------------------------------------* METHOD on_user_command . \" \u83b7\u53d6ALV\u9009\u53d6\u884c DATA lt_rows TYPE lvc_t_row . DATA ls_row TYPE lvc_s_row . CALL METHOD go_alv_grid -> get_selected_rows IMPORTING et_index_rows = lt_rows . CASE e_ucomm . WHEN 'Z10' . WHEN OTHERS . ENDCASE . PERFORM frm_refresh_display . ENDMETHOD . ENDCLASS . *&---------------------------------------------------------------------* *& Form frm_display *&---------------------------------------------------------------------* *& text *&---------------------------------------------------------------------* *& --> p1 text *& <-- p2 text *&---------------------------------------------------------------------* FORM frm_display TABLES ct_data TYPE STANDARD TABLE . IF go_container IS NOT BOUND . go_container = NEW cl_gui_custom_container ( 'CON_9000' ). ENDIF . IF go_alv_grid IS BOUND . PERFORM frm_refresh_display . RETURN . ENDIF . \" \u65b0\u5efa\u5bf9\u8c61 go_alv_grid = NEW cl_gui_alv_grid ( go_container ). DATA ls_layout TYPE lvc_s_layo . DATA lt_fieldcat TYPE STANDARD TABLE OF lvc_s_fcat . PERFORM frm_set_layout CHANGING ls_layout . PERFORM frm_set_fieldcat TABLES lt_fieldcat . PERFORM frm_set_event . PERFORM frm_set_style . PERFORM frm_set_color . \" \u5c55\u793a CALL METHOD go_alv_grid -> set_table_for_first_display EXPORTING is_layout = ls_layout i_default = 'X' i_save = 'A' CHANGING it_outtab = ct_data[] it_fieldcatalog = lt_fieldcat EXCEPTIONS invalid_parameter_combination = 1 program_error = 2 too_many_lines = 3 OTHERS = 4 . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_display *&---------------------------------------------------------------------* *& text *&---------------------------------------------------------------------* *& --> p1 text *& <-- p2 text *&---------------------------------------------------------------------* FORM frm_refresh_display . PERFORM frm_set_style . PERFORM frm_set_color . go_alv_grid -> refresh_table_display ( is_stable = CONV # ( 'XX' ) ). ENDFORM . *&---------------------------------------------------------------------* *& Form frm_set_layout *&---------------------------------------------------------------------* *& \u62a5\u8868\u5e03\u5c40\u8bbe\u7f6e *&---------------------------------------------------------------------* FORM frm_set_layout CHANGING cs_layout TYPE lvc_s_layo . CLEAR cs_layout . cs_layout - zebra = abap_true . \" \u6591\u9a6c\u7ebf cs_layout - cwidth_opt = abap_true . \" \u81ea\u52a8\u8c03\u6574ALVL\u5217\u5bbd cs_layout - sel_mode = 'A' . \" \u9009\u62e9\u6a21\u5f0f cs_layout - ctab_fname = 'T_SCOL' . \" \u5355\u5143\u683c\u989c\u8272\u8bbe\u7f6e cs_layout - stylefname = 'T_STYL' . \" \u5355\u5143\u683c\u63a7\u5236 ENDFORM . *&---------------------------------------------------------------------* *& Form frm_set_fieldcat *&---------------------------------------------------------------------* *& \u5b57\u6bb5\u76ee\u5f55\u8bbe\u7f6e *&---------------------------------------------------------------------* FORM frm_set_fieldcat TABLES ct_fieldcat TYPE lvc_t_fcat . DATA ls_fieldcat TYPE lvc_s_fcat . DEFINE _init_fieldcat . CLEAR ls_fieldcat . ls_fieldcat - fieldname = &1 . ls_fieldcat - tooltip = ls_fieldcat - coltext = ls_fieldcat - seltext = ls_fieldcat - scrtext_l = ls_fieldcat - scrtext_m = ls_fieldcat - scrtext_s = &2 . ls_fieldcat - ref_table = &3 . ls_fieldcat - ref_field = &4 . INSERT ls_fieldcat INTO TABLE ct_fieldcat . END-OF-DEFINITION . _init_fieldcat 'MTYPE' '\u68c0\u67e5\u72b6\u6001' '' '' . _init_fieldcat 'MSG ' '\u68c0\u67e5\u6d88\u606f' '' '' . \" \u4e2a\u6027\u5316\u81ea\u5df1\u8f93\u51fa\u6570\u636e\u683c\u5f0f LOOP AT ct_fieldcat REFERENCE INTO DATA ( lr_fieldcat ). \" \u7f16\u8f91\u72b6\u6001\uff0c\u9ed8\u8ba4\u53ef\u7f16\u8f91 lr_fieldcat -> edit = abap_true . CASE lr_fieldcat -> fieldname . WHEN 'MTYPE' OR 'MSG' . lr_fieldcat -> edit = abap_false . WHEN OTHERS . ENDCASE . ENDLOOP . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_set_event *&---------------------------------------------------------------------* *& \u7ed1\u5b9aALV\u4e8b\u4ef6 *&---------------------------------------------------------------------* FORM frm_set_event . IF go_handler IS BOUND . RETURN . ENDIF . go_handler = NEW lcl_event_handler ( ). \" \u6570\u636e\u53d8\u66f4 go_alv_grid -> register_edit_event ( i_event_id = cl_gui_alv_grid => mc_evt_modified ). SET HANDLER go_handler -> on_data_changed_finished FOR go_alv_grid . \" \u5de5\u5177\u680f\u76f8\u5173 SET HANDLER go_handler -> on_toolbar FOR go_alv_grid . SET HANDLER go_handler -> on_user_command FOR go_alv_grid . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_set_style *&---------------------------------------------------------------------* *& text *&---------------------------------------------------------------------* *& --> p1 text *& <-- p2 text *&---------------------------------------------------------------------* FORM frm_set_style . DATA ls_styl TYPE lvc_s_styl . LOOP AT gt_data REFERENCE INTO DATA ( lr_data ). CLEAR lr_data -> t_styl . \" \u8bbe\u7f6eALV\u5b57\u6bb5\u6216\u884c\u7684\u72b6\u6001 \" \u5e38\u7528\u6709\u7981\u6b62\u7f16\u8f91CL_GUI_ALV_GRID=>MC_STYLE_DISABLED \" \u7981\u6b62\u5220\u9664\u884cCL_GUI_ALV_GRID=>MC_STYLE_NO_DELETE_ROW ENDLOOP . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_set_color *&---------------------------------------------------------------------* *& text *&---------------------------------------------------------------------* *& --> p1 text *& <-- p2 text *&---------------------------------------------------------------------* FORM frm_set_color . DATA ls_scol TYPE lvc_s_scol . LOOP AT gt_data REFERENCE INTO DATA ( lr_data ). CLEAR lr_data -> t_scol . IF lr_data -> mtype = 'E' . CLEAR ls_scol . ls_scol - fname = 'MTYPE' . ls_scol - color = VALUE # ( col = '6' ). INSERT ls_scol INTO TABLE lr_data -> t_scol . CLEAR ls_scol . ls_scol - fname = 'MSG' . ls_scol - color = VALUE # ( col = '6' ). INSERT ls_scol INTO TABLE lr_data -> t_scol . ENDIF . ENDLOOP . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_get_data_selection *&---------------------------------------------------------------------* *& text *&---------------------------------------------------------------------* *& --> p1 text *& <-- p2 text *&---------------------------------------------------------------------* FORM frm_get_data_selection . CHECK go_alv_grid IS BOUND . \" \u83b7\u53d6ALV\u9009\u53d6\u884c DATA lt_rows TYPE lvc_t_row . CALL METHOD go_alv_grid -> get_selected_rows IMPORTING et_index_rows = lt_rows . LOOP AT lt_rows INTO DATA ( ls_row ). READ TABLE gt_data REFERENCE INTO DATA ( lr_data ) INDEX ls_row - index . IF sy - subrc = 0 . lr_data -> zsel = abap_true . ENDIF . ENDLOOP . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_reset_data_selection *&---------------------------------------------------------------------* *& text *&---------------------------------------------------------------------* *& --> p1 text *& <-- p2 text *&---------------------------------------------------------------------* FORM frm_reset_data_selection . LOOP AT gt_data REFERENCE INTO DATA ( lr_data ). CLEAR lr_data -> zsel . ENDLOOP . ENDFORM . *&---------------------------------------------------------------------* *& Module STATUS_9000 OUTPUT *&---------------------------------------------------------------------* *& *&---------------------------------------------------------------------* MODULE status_9000 OUTPUT . PERFORM frm_display TABLES gt_data . SET PF-STATUS 'STATUS' . SET TITLEBAR 'TITLE' . ENDMODULE . *&---------------------------------------------------------------------* *& Module USER_COMMAND_9000 INPUT *&---------------------------------------------------------------------* * text *----------------------------------------------------------------------* MODULE user_command_9000 INPUT . PERFORM frm_get_data_selection . CASE sy - ucomm . WHEN '&F03' OR '&F15' OR '&F12' . LEAVE TO SCREEN 0 . WHEN OTHERS . ENDCASE . CLEAR sy - ucomm . ENDMODULE . SALV \u00b6 SALV\u6700\u5927\u95ee\u9898\u5728\u4e8e\u4e0d\u53ef\u7f16\u8f91\u3002\u5c3d\u7ba1\u53ef\u4ee5\u89e3\u51b3\uff0c\u4f46\u76f8\u5f53\u9ebb\u70e6\uff0c\u4e0d\u5efa\u8bae\u5728\u590d\u6742\u7684\u5f00\u53d1\u573a\u666f\u4e2d\u4f7f\u7528SALV\u3002 SALV\u5b9e\u9645\u4e0a\u4e5f\u662fALV GRID\uff0c\u6240\u4ee5\u53ea\u8981\u83b7\u53d6\u5230\u6838\u5fc3\u7684GRID\u5bf9\u8c61\uff0c\u5373\u53ef\u89e3\u51b3\u4e0a\u8ff0\u95ee\u9898\u3002\u4f46\u2026\u2026\u90fd\u8fd9\u6837\u4e86\uff0c\u4e3a\u4ec0\u4e48\u4e0d\u76f4\u63a5\u7528ALV GRID\u5f00\u53d1\uff1f \u793a\u4f8b\u4ee3\u7801 TYPES : BEGIN OF ty_detail , field1 TYPE string , field2 TYPE string , END OF ty_detail . DATA gt_detail TYPE STANDARD TABLE OF ty_detail . DATA go_salv TYPE REF TO cl_salv_table . IF go_salv IS BOUND . go_salv -> refresh ( ). RETURN . ENDIF . TRY . cl_salv_table => factory ( IMPORTING r_salv_table = go_salv CHANGING t_table = gt_detail ). CATCH cx_salv_msg . RETURN . ENDTRY . DATA ( lo_setting ) = go_salv -> get_display_settings ( ). lo_setting -> set_list_header ( '\u6807\u9898' ). DATA ( lo_columns ) = go_salv -> get_columns ( ). lo_columns -> set_optimize ( abap_true ). TRY . DATA lo_column TYPE REF TO cl_salv_column_table . DEFINE _set_savl_column . lo_column ?= lo_columns -> get_column ( &1 ). lo_column -> set_long_text ( &2 ). lo_column -> set_medium_text ( &2 ). lo_column -> set_short_text ( &2 ). END-OF-DEFINITION . _set_savl_column 'ZFIELD1' '\u5b57\u6bb51' . _set_savl_column 'ZFIELD2' '\u5b57\u6bb52' . CATCH cx_salv_not_found . ENDTRY . \" \u8bbe\u7f6e\u5de5\u5177\u680f\u6309\u94ae DATA ( lo_functions ) = go_salv -> get_functions ( ). lo_functions -> set_all ( abap_true ). \" \u5f39\u7a97\u6a21\u5f0f\uff0c\u4e0d\u5f39\u7a97\u7684\u8bdd\uff0c\u6ce8\u91ca\u5373\u53ef go_salv -> set_screen_popup ( start_column = 30 end_column = 150 start_line = 2 end_line = 15 ). \" \u5c55\u793aSALV\u62a5\u8868 go_salv -> display ( ).","title":"ALV\u76f8\u5173"},{"location":"others/alv/#alv","text":"\u6574\u7406\u4e0bALV\u7528\u5230\u7684\u51e0\u79cd\u65b9\u6cd5\u3002","title":"ALV"},{"location":"others/alv/#lvc","text":"LVC\u597d\u5728\u4e0d\u7528\u753b\u5c4f\u5e55\uff0c\u76f4\u63a5\u8c03\u7528\u5373\u53ef\u3002 INCLUDE_LVC *&---------------------------------------------------------------------* *& Form frm_display *&---------------------------------------------------------------------* *& text *&---------------------------------------------------------------------* *& --> p1 text *& <-- p2 text *&---------------------------------------------------------------------* FORM frm_display TABLES ct_data TYPE STANDARD TABLE . DATA ls_layout TYPE lvc_s_layo . DATA lt_fieldcat TYPE STANDARD TABLE OF lvc_s_fcat . PERFORM frm_set_layout CHANGING ls_layout . PERFORM frm_set_fieldcat TABLES lt_fieldcat . CALL FUNCTION 'REUSE_ALV_GRID_DISPLAY_LVC' EXPORTING i_callback_program = sy - repid i_callback_pf_status_set = 'FRM_PF_STATUS' i_callback_user_command = 'FRM_USER_COMMAND' is_layout_lvc = ls_layout it_fieldcat_lvc = lt_fieldcat i_default = abap_true i_save = 'A' TABLES t_outtab = ct_data[] EXCEPTIONS program_error = 1 OTHERS = 2 . IF sy - subrc <> 0 . MESSAGE ID sy - msgid TYPE sy - msgty NUMBER sy - msgno WITH sy - msgv1 sy - msgv2 sy - msgv3 sy - msgv4 . ENDIF . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_set_layout *&---------------------------------------------------------------------* *& \u62a5\u8868\u5e03\u5c40\u8bbe\u7f6e *&---------------------------------------------------------------------* FORM frm_set_layout CHANGING cs_layout TYPE lvc_s_layo . CLEAR cs_layout . cs_layout - zebra = abap_true . \" \u6591\u9a6c\u7ebf cs_layout - cwidth_opt = abap_true . \" \u81ea\u52a8\u8c03\u6574ALVL\u5217\u5bbd cs_layout - sel_mode = 'A' . \" \u9009\u62e9\u6a21\u5f0f * CS_LAYOUT - box_fname = 'CHECKBOX' . \" \u9009\u62e9\u6846 * CS_LAYOUT - ctab_fname = 'COLTAB' . \" \u5355\u5143\u683c\u989c\u8272\u8bbe\u7f6e ENDFORM . *&---------------------------------------------------------------------* *& Form frm_set_fieldcat *&---------------------------------------------------------------------* *& \u5b57\u6bb5\u76ee\u5f55\u8bbe\u7f6e *&---------------------------------------------------------------------* FORM frm_set_fieldcat TABLES ct_fieldcat TYPE lvc_t_fcat . DATA ls_fieldcat TYPE lvc_s_fcat . DEFINE _init_fieldcat . CLEAR ls_fieldcat . ls_fieldcat - fieldname = &1 . ls_fieldcat - tooltip = ls_fieldcat - coltext = ls_fieldcat - seltext = ls_fieldcat - scrtext_l = ls_fieldcat - scrtext_m = ls_fieldcat - scrtext_s = &2 . ls_fieldcat - ref_table = &3 . ls_fieldcat - ref_field = &4 . INSERT ls_fieldcat INTO TABLE ct_fieldcat . END-OF-DEFINITION . _init_fieldcat 'ZSEL' '\u9009\u62e9\u9879' '' '' . _init_fieldcat 'MTYPE ' '\u5904\u7406\u72b6\u6001' '' '' . _init_fieldcat 'MSG ' '\u5904\u7406\u6d88\u606f' '' '' . \" \u4e2a\u6027\u5316\u81ea\u5df1\u8f93\u51fa\u6570\u636e\u683c\u5f0f LOOP AT ct_fieldcat REFERENCE INTO DATA ( lr_fieldcat ). \" \u5b57\u6bb5\u663e\u793a\u5c5e\u6027\u8bbe\u7f6e CASE lr_fieldcat -> fieldname . WHEN 'ZSEL' . lr_fieldcat -> checkbox = abap_true . lr_fieldcat -> edit = abap_true . lr_fieldcat -> hotspot = abap_true . WHEN 'MENGE' . lr_fieldcat -> qfieldname = 'MEINS' . WHEN OTHERS . ENDCASE . ENDLOOP . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_pf_status *&---------------------------------------------------------------------* *& \u8bbe\u7f6eGUI\u72b6\u6001 *&---------------------------------------------------------------------* FORM frm_pf_status USING ct_extab TYPE slis_t_extab . SET PF-STATUS 'STATUS' . SET TITLEBAR 'TITLE' . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_user_command *&---------------------------------------------------------------------* *& \u529f\u80fd\u54cd\u5e94 *&---------------------------------------------------------------------* FORM frm_user_command USING cv_ucomm LIKE sy - ucomm cs_selfield TYPE slis_selfield . \" \u5237\u65b0\u5c4f\u5e55\u6570\u636e\u5230\u5185\u8868 DATA : lo_grid TYPE REF TO cl_gui_alv_grid . CALL FUNCTION 'GET_GLOBALS_FROM_SLVC_FULLSCR' IMPORTING e_grid = lo_grid . CALL METHOD lo_grid -> check_changed_data . PERFORM frm_get_data_selection . \" \u6309\u94ae\u529f\u80fd\u5b9e\u73b0 CASE cv_ucomm . WHEN '&IC1' . \" \u53cc\u51fb WHEN OTHERS . ENDCASE . \" \u5237\u65b0ALV \u663e\u793a\u503c cs_selfield - refresh = abap_true . cs_selfield - row_stable = abap_true . cs_selfield - col_stable = abap_true . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_get_data_selection *&---------------------------------------------------------------------* *& text *&---------------------------------------------------------------------* *& --> p1 text *& <-- p2 text *&---------------------------------------------------------------------* FORM frm_get_data_selection . \" \u5237\u65b0\u5c4f\u5e55\u6570\u636e\u5230\u5185\u8868 DATA : lo_grid TYPE REF TO cl_gui_alv_grid . CALL FUNCTION 'GET_GLOBALS_FROM_SLVC_FULLSCR' IMPORTING e_grid = lo_grid . \" \u83b7\u53d6ALV\u9009\u53d6\u884c DATA lt_rows TYPE lvc_t_row . CALL METHOD lo_grid -> get_selected_rows IMPORTING et_index_rows = lt_rows . LOOP AT lt_rows INTO DATA ( ls_row ). READ TABLE gt_data REFERENCE INTO DATA ( lr_data ) INDEX ls_row - index . IF sy - subrc = 0 . lr_data -> zsel = abap_true . ENDIF . ENDLOOP . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_reset_data_selection *&---------------------------------------------------------------------* *& text *&---------------------------------------------------------------------* *& --> p1 text *& <-- p2 text *&---------------------------------------------------------------------* FORM frm_reset_data_selection . LOOP AT gt_data REFERENCE INTO DATA ( lr_data ). CLEAR lr_data -> zsel . ENDLOOP . ENDFORM .","title":"LVC"},{"location":"others/alv/#alv-grid","text":"OOALV\u53ef\u5b9a\u5236\u7684\u529f\u80fd\u66f4\u5b8c\u5584\uff0c\u9002\u5408\u590d\u6742\u7684\u62a5\u8868\u5f00\u53d1\u3002 INCLUDE_ALV_GRID CLASS lcl_event_handler DEFINITION DEFERRED . DATA go_container TYPE REF TO cl_gui_container . DATA go_alv_grid TYPE REF TO cl_gui_alv_grid . DATA go_handler TYPE REF TO lcl_event_handler . *&---------------------------------------------------------------------* *& Form lcl_event_handler *&---------------------------------------------------------------------* CLASS lcl_event_handler DEFINITION . PUBLIC SECTION . \" \u6570\u636e\u53d8\u66f4\u4e8b\u4ef6 METHODS on_data_changed_finished FOR EVENT data_changed_finished OF cl_gui_alv_grid IMPORTING e_modified et_good_cells . \" \u5de5\u5177\u680f\u8c03\u6574 METHODS on_toolbar FOR EVENT toolbar OF cl_gui_alv_grid IMPORTING e_object e_interactive . \" \u54cd\u5e94\u5de5\u5177\u680f\u4e8b\u4ef6 \" \u70b9\u51fb\u6309\u94ae\u4e4b\u7c7b\u7684\u4e8b\u4ef6 METHODS on_user_command FOR EVENT user_command OF cl_gui_alv_grid IMPORTING e_ucomm . ENDCLASS . *&---------------------------------------------------------------------* *& Form lcl_event_handler *&---------------------------------------------------------------------* CLASS lcl_event_handler IMPLEMENTATION . *&---------------------------------------------------------------------* *& on_data_changed_finished *&---------------------------------------------------------------------* METHOD on_data_changed_finished . CHECK e_modified = abap_true . LOOP AT et_good_cells INTO DATA ( ls_cell ). READ TABLE gt_data REFERENCE INTO DATA ( lr_data ) INDEX ls_cell - row_id . IF sy - subrc = 0 . ENDIF . ENDLOOP . PERFORM frm_refresh_display . ENDMETHOD . *&---------------------------------------------------------------------* *& on_toolbar *&---------------------------------------------------------------------* METHOD on_toolbar . \" \u79fb\u9664\u7f16\u8f91\u76f8\u5173\u7684\u6309\u94ae DELETE e_object -> mt_toolbar WHERE function CS '&LOCAL&' . \" \u65b0\u589e\u6309\u94ae DATA ls_button LIKE LINE OF e_object -> mt_toolbar . CLEAR ls_button . ls_button - function = 'Z10' . ls_button - icon = icon_system_copy . ls_button - quickinfo = ls_button - text = '' . INSERT ls_button INTO TABLE e_object -> mt_toolbar . ENDMETHOD . *&---------------------------------------------------------------------* *& on_user_command *&---------------------------------------------------------------------* METHOD on_user_command . \" \u83b7\u53d6ALV\u9009\u53d6\u884c DATA lt_rows TYPE lvc_t_row . DATA ls_row TYPE lvc_s_row . CALL METHOD go_alv_grid -> get_selected_rows IMPORTING et_index_rows = lt_rows . CASE e_ucomm . WHEN 'Z10' . WHEN OTHERS . ENDCASE . PERFORM frm_refresh_display . ENDMETHOD . ENDCLASS . *&---------------------------------------------------------------------* *& Form frm_display *&---------------------------------------------------------------------* *& text *&---------------------------------------------------------------------* *& --> p1 text *& <-- p2 text *&---------------------------------------------------------------------* FORM frm_display TABLES ct_data TYPE STANDARD TABLE . IF go_container IS NOT BOUND . go_container = NEW cl_gui_custom_container ( 'CON_9000' ). ENDIF . IF go_alv_grid IS BOUND . PERFORM frm_refresh_display . RETURN . ENDIF . \" \u65b0\u5efa\u5bf9\u8c61 go_alv_grid = NEW cl_gui_alv_grid ( go_container ). DATA ls_layout TYPE lvc_s_layo . DATA lt_fieldcat TYPE STANDARD TABLE OF lvc_s_fcat . PERFORM frm_set_layout CHANGING ls_layout . PERFORM frm_set_fieldcat TABLES lt_fieldcat . PERFORM frm_set_event . PERFORM frm_set_style . PERFORM frm_set_color . \" \u5c55\u793a CALL METHOD go_alv_grid -> set_table_for_first_display EXPORTING is_layout = ls_layout i_default = 'X' i_save = 'A' CHANGING it_outtab = ct_data[] it_fieldcatalog = lt_fieldcat EXCEPTIONS invalid_parameter_combination = 1 program_error = 2 too_many_lines = 3 OTHERS = 4 . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_display *&---------------------------------------------------------------------* *& text *&---------------------------------------------------------------------* *& --> p1 text *& <-- p2 text *&---------------------------------------------------------------------* FORM frm_refresh_display . PERFORM frm_set_style . PERFORM frm_set_color . go_alv_grid -> refresh_table_display ( is_stable = CONV # ( 'XX' ) ). ENDFORM . *&---------------------------------------------------------------------* *& Form frm_set_layout *&---------------------------------------------------------------------* *& \u62a5\u8868\u5e03\u5c40\u8bbe\u7f6e *&---------------------------------------------------------------------* FORM frm_set_layout CHANGING cs_layout TYPE lvc_s_layo . CLEAR cs_layout . cs_layout - zebra = abap_true . \" \u6591\u9a6c\u7ebf cs_layout - cwidth_opt = abap_true . \" \u81ea\u52a8\u8c03\u6574ALVL\u5217\u5bbd cs_layout - sel_mode = 'A' . \" \u9009\u62e9\u6a21\u5f0f cs_layout - ctab_fname = 'T_SCOL' . \" \u5355\u5143\u683c\u989c\u8272\u8bbe\u7f6e cs_layout - stylefname = 'T_STYL' . \" \u5355\u5143\u683c\u63a7\u5236 ENDFORM . *&---------------------------------------------------------------------* *& Form frm_set_fieldcat *&---------------------------------------------------------------------* *& \u5b57\u6bb5\u76ee\u5f55\u8bbe\u7f6e *&---------------------------------------------------------------------* FORM frm_set_fieldcat TABLES ct_fieldcat TYPE lvc_t_fcat . DATA ls_fieldcat TYPE lvc_s_fcat . DEFINE _init_fieldcat . CLEAR ls_fieldcat . ls_fieldcat - fieldname = &1 . ls_fieldcat - tooltip = ls_fieldcat - coltext = ls_fieldcat - seltext = ls_fieldcat - scrtext_l = ls_fieldcat - scrtext_m = ls_fieldcat - scrtext_s = &2 . ls_fieldcat - ref_table = &3 . ls_fieldcat - ref_field = &4 . INSERT ls_fieldcat INTO TABLE ct_fieldcat . END-OF-DEFINITION . _init_fieldcat 'MTYPE' '\u68c0\u67e5\u72b6\u6001' '' '' . _init_fieldcat 'MSG ' '\u68c0\u67e5\u6d88\u606f' '' '' . \" \u4e2a\u6027\u5316\u81ea\u5df1\u8f93\u51fa\u6570\u636e\u683c\u5f0f LOOP AT ct_fieldcat REFERENCE INTO DATA ( lr_fieldcat ). \" \u7f16\u8f91\u72b6\u6001\uff0c\u9ed8\u8ba4\u53ef\u7f16\u8f91 lr_fieldcat -> edit = abap_true . CASE lr_fieldcat -> fieldname . WHEN 'MTYPE' OR 'MSG' . lr_fieldcat -> edit = abap_false . WHEN OTHERS . ENDCASE . ENDLOOP . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_set_event *&---------------------------------------------------------------------* *& \u7ed1\u5b9aALV\u4e8b\u4ef6 *&---------------------------------------------------------------------* FORM frm_set_event . IF go_handler IS BOUND . RETURN . ENDIF . go_handler = NEW lcl_event_handler ( ). \" \u6570\u636e\u53d8\u66f4 go_alv_grid -> register_edit_event ( i_event_id = cl_gui_alv_grid => mc_evt_modified ). SET HANDLER go_handler -> on_data_changed_finished FOR go_alv_grid . \" \u5de5\u5177\u680f\u76f8\u5173 SET HANDLER go_handler -> on_toolbar FOR go_alv_grid . SET HANDLER go_handler -> on_user_command FOR go_alv_grid . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_set_style *&---------------------------------------------------------------------* *& text *&---------------------------------------------------------------------* *& --> p1 text *& <-- p2 text *&---------------------------------------------------------------------* FORM frm_set_style . DATA ls_styl TYPE lvc_s_styl . LOOP AT gt_data REFERENCE INTO DATA ( lr_data ). CLEAR lr_data -> t_styl . \" \u8bbe\u7f6eALV\u5b57\u6bb5\u6216\u884c\u7684\u72b6\u6001 \" \u5e38\u7528\u6709\u7981\u6b62\u7f16\u8f91CL_GUI_ALV_GRID=>MC_STYLE_DISABLED \" \u7981\u6b62\u5220\u9664\u884cCL_GUI_ALV_GRID=>MC_STYLE_NO_DELETE_ROW ENDLOOP . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_set_color *&---------------------------------------------------------------------* *& text *&---------------------------------------------------------------------* *& --> p1 text *& <-- p2 text *&---------------------------------------------------------------------* FORM frm_set_color . DATA ls_scol TYPE lvc_s_scol . LOOP AT gt_data REFERENCE INTO DATA ( lr_data ). CLEAR lr_data -> t_scol . IF lr_data -> mtype = 'E' . CLEAR ls_scol . ls_scol - fname = 'MTYPE' . ls_scol - color = VALUE # ( col = '6' ). INSERT ls_scol INTO TABLE lr_data -> t_scol . CLEAR ls_scol . ls_scol - fname = 'MSG' . ls_scol - color = VALUE # ( col = '6' ). INSERT ls_scol INTO TABLE lr_data -> t_scol . ENDIF . ENDLOOP . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_get_data_selection *&---------------------------------------------------------------------* *& text *&---------------------------------------------------------------------* *& --> p1 text *& <-- p2 text *&---------------------------------------------------------------------* FORM frm_get_data_selection . CHECK go_alv_grid IS BOUND . \" \u83b7\u53d6ALV\u9009\u53d6\u884c DATA lt_rows TYPE lvc_t_row . CALL METHOD go_alv_grid -> get_selected_rows IMPORTING et_index_rows = lt_rows . LOOP AT lt_rows INTO DATA ( ls_row ). READ TABLE gt_data REFERENCE INTO DATA ( lr_data ) INDEX ls_row - index . IF sy - subrc = 0 . lr_data -> zsel = abap_true . ENDIF . ENDLOOP . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_reset_data_selection *&---------------------------------------------------------------------* *& text *&---------------------------------------------------------------------* *& --> p1 text *& <-- p2 text *&---------------------------------------------------------------------* FORM frm_reset_data_selection . LOOP AT gt_data REFERENCE INTO DATA ( lr_data ). CLEAR lr_data -> zsel . ENDLOOP . ENDFORM . *&---------------------------------------------------------------------* *& Module STATUS_9000 OUTPUT *&---------------------------------------------------------------------* *& *&---------------------------------------------------------------------* MODULE status_9000 OUTPUT . PERFORM frm_display TABLES gt_data . SET PF-STATUS 'STATUS' . SET TITLEBAR 'TITLE' . ENDMODULE . *&---------------------------------------------------------------------* *& Module USER_COMMAND_9000 INPUT *&---------------------------------------------------------------------* * text *----------------------------------------------------------------------* MODULE user_command_9000 INPUT . PERFORM frm_get_data_selection . CASE sy - ucomm . WHEN '&F03' OR '&F15' OR '&F12' . LEAVE TO SCREEN 0 . WHEN OTHERS . ENDCASE . CLEAR sy - ucomm . ENDMODULE .","title":"ALV GRID"},{"location":"others/alv/#salv","text":"SALV\u6700\u5927\u95ee\u9898\u5728\u4e8e\u4e0d\u53ef\u7f16\u8f91\u3002\u5c3d\u7ba1\u53ef\u4ee5\u89e3\u51b3\uff0c\u4f46\u76f8\u5f53\u9ebb\u70e6\uff0c\u4e0d\u5efa\u8bae\u5728\u590d\u6742\u7684\u5f00\u53d1\u573a\u666f\u4e2d\u4f7f\u7528SALV\u3002 SALV\u5b9e\u9645\u4e0a\u4e5f\u662fALV GRID\uff0c\u6240\u4ee5\u53ea\u8981\u83b7\u53d6\u5230\u6838\u5fc3\u7684GRID\u5bf9\u8c61\uff0c\u5373\u53ef\u89e3\u51b3\u4e0a\u8ff0\u95ee\u9898\u3002\u4f46\u2026\u2026\u90fd\u8fd9\u6837\u4e86\uff0c\u4e3a\u4ec0\u4e48\u4e0d\u76f4\u63a5\u7528ALV GRID\u5f00\u53d1\uff1f \u793a\u4f8b\u4ee3\u7801 TYPES : BEGIN OF ty_detail , field1 TYPE string , field2 TYPE string , END OF ty_detail . DATA gt_detail TYPE STANDARD TABLE OF ty_detail . DATA go_salv TYPE REF TO cl_salv_table . IF go_salv IS BOUND . go_salv -> refresh ( ). RETURN . ENDIF . TRY . cl_salv_table => factory ( IMPORTING r_salv_table = go_salv CHANGING t_table = gt_detail ). CATCH cx_salv_msg . RETURN . ENDTRY . DATA ( lo_setting ) = go_salv -> get_display_settings ( ). lo_setting -> set_list_header ( '\u6807\u9898' ). DATA ( lo_columns ) = go_salv -> get_columns ( ). lo_columns -> set_optimize ( abap_true ). TRY . DATA lo_column TYPE REF TO cl_salv_column_table . DEFINE _set_savl_column . lo_column ?= lo_columns -> get_column ( &1 ). lo_column -> set_long_text ( &2 ). lo_column -> set_medium_text ( &2 ). lo_column -> set_short_text ( &2 ). END-OF-DEFINITION . _set_savl_column 'ZFIELD1' '\u5b57\u6bb51' . _set_savl_column 'ZFIELD2' '\u5b57\u6bb52' . CATCH cx_salv_not_found . ENDTRY . \" \u8bbe\u7f6e\u5de5\u5177\u680f\u6309\u94ae DATA ( lo_functions ) = go_salv -> get_functions ( ). lo_functions -> set_all ( abap_true ). \" \u5f39\u7a97\u6a21\u5f0f\uff0c\u4e0d\u5f39\u7a97\u7684\u8bdd\uff0c\u6ce8\u91ca\u5373\u53ef go_salv -> set_screen_popup ( start_column = 30 end_column = 150 start_line = 2 end_line = 15 ). \" \u5c55\u793aSALV\u62a5\u8868 go_salv -> display ( ).","title":"SALV"},{"location":"others/billing_enhancement/","text":"\u53d1\u7968\u589e\u5f3a \u00b6 USEREXIT_SAVE_DOCUMENT_PREPARE \u00b6 \u9664\u4e86\u5e38\u89c4\u7f51\u4e0a\u80fd\u627e\u5230\u7684\u589e\u5f3a\u70b9\uff0cSAP\u5728\u4ee3\u7801\u4e2d\u8fd8\u7559\u6709\u4fdd\u5b58\u524d\u7684\u51fa\u53e3\uff08\u53ef\u80fd\u662fBUG\uff0c\u4f46\u4e0d\u59a8\u788d\u76ee\u524d\u62ff\u6765\u4f7f\u7528\uff09 \u627e\u5230\u51fd\u6570\u7ec4V60A\uff0c\u968f\u610f\u627e\u4e2aINCLUDE\u6587\u4ef6\uff0c\u8fd9\u91cc\u5efa\u8baeRV60AFZC\uff08\u540c\u6587\u4ef6\u8fd8\u6709USEREXIT_FILL_VBRK_VBRP\uff09\uff0c\u7136\u540e\u5728\u4ee3\u7801\u6700\u540e\u52a0\u5165\u4e0b\u9762\u5b50\u4f8b\u7a0b *&---------------------------------------------------------------------* *& FORM USEREXIT_SAVE_DOCUMENT_PREPARE *&---------------------------------------------------------------------* *& \u6807\u51c6\u6ca1\u6709\u8fd9\u4e2a\u5b50\u4f8b\u7a0b\uff0c\u4f46\u662f\uff0c\u6807\u51c6\u6709\u8fd9\u4e2a\u5b50\u4f8b\u7a0b\u7684\u8c03\u7528 *& \uff08\u8c03\u7528\u4f4d\u7f6e\u5728\u51fd\u6570RV_INVOICE_DOCUMENT_ADD\uff09 *& \u6240\u4ee5\u5728SAPLV60A\u7a0b\u5e8f\u5185\u52a0\u5165\u8be5\u5b50\u4f8b\u7a0b\uff0c\u5373\u53ef\u5f00\u653e\u8be5\u51fa\u53e3 *& \u4ece\u800c\u5728\u53d1\u7968\u4fdd\u5b58\u524d\u8fdb\u884c\u5ba2\u5236\u5316\u7684\u64cd\u4f5c *& \u53ef\u4ee5\u901a\u8fc7T180-TRTYP\u8fdb\u884c\u5224\u65ad\uff0c\u5e76\u5bf9XVBRK\u3001XVBRP\u8fdb\u884c\u4fee\u6539 *& \uff08\u6211\u5e76\u6ca1\u627e\u5230SAP\u5173\u4e8e\u8be5\u51fa\u53e3\u7684\u8bf4\u660e\uff0c\u614e\u7528\uff09 *&---------------------------------------------------------------------* FORM USEREXIT_SAVE_DOCUMENT_PREPARE . ENDFORM .","title":"\u53d1\u7968\u589e\u5f3a"},{"location":"others/billing_enhancement/#_1","text":"","title":"\u53d1\u7968\u589e\u5f3a"},{"location":"others/billing_enhancement/#userexit_save_document_prepare","text":"\u9664\u4e86\u5e38\u89c4\u7f51\u4e0a\u80fd\u627e\u5230\u7684\u589e\u5f3a\u70b9\uff0cSAP\u5728\u4ee3\u7801\u4e2d\u8fd8\u7559\u6709\u4fdd\u5b58\u524d\u7684\u51fa\u53e3\uff08\u53ef\u80fd\u662fBUG\uff0c\u4f46\u4e0d\u59a8\u788d\u76ee\u524d\u62ff\u6765\u4f7f\u7528\uff09 \u627e\u5230\u51fd\u6570\u7ec4V60A\uff0c\u968f\u610f\u627e\u4e2aINCLUDE\u6587\u4ef6\uff0c\u8fd9\u91cc\u5efa\u8baeRV60AFZC\uff08\u540c\u6587\u4ef6\u8fd8\u6709USEREXIT_FILL_VBRK_VBRP\uff09\uff0c\u7136\u540e\u5728\u4ee3\u7801\u6700\u540e\u52a0\u5165\u4e0b\u9762\u5b50\u4f8b\u7a0b *&---------------------------------------------------------------------* *& FORM USEREXIT_SAVE_DOCUMENT_PREPARE *&---------------------------------------------------------------------* *& \u6807\u51c6\u6ca1\u6709\u8fd9\u4e2a\u5b50\u4f8b\u7a0b\uff0c\u4f46\u662f\uff0c\u6807\u51c6\u6709\u8fd9\u4e2a\u5b50\u4f8b\u7a0b\u7684\u8c03\u7528 *& \uff08\u8c03\u7528\u4f4d\u7f6e\u5728\u51fd\u6570RV_INVOICE_DOCUMENT_ADD\uff09 *& \u6240\u4ee5\u5728SAPLV60A\u7a0b\u5e8f\u5185\u52a0\u5165\u8be5\u5b50\u4f8b\u7a0b\uff0c\u5373\u53ef\u5f00\u653e\u8be5\u51fa\u53e3 *& \u4ece\u800c\u5728\u53d1\u7968\u4fdd\u5b58\u524d\u8fdb\u884c\u5ba2\u5236\u5316\u7684\u64cd\u4f5c *& \u53ef\u4ee5\u901a\u8fc7T180-TRTYP\u8fdb\u884c\u5224\u65ad\uff0c\u5e76\u5bf9XVBRK\u3001XVBRP\u8fdb\u884c\u4fee\u6539 *& \uff08\u6211\u5e76\u6ca1\u627e\u5230SAP\u5173\u4e8e\u8be5\u51fa\u53e3\u7684\u8bf4\u660e\uff0c\u614e\u7528\uff09 *&---------------------------------------------------------------------* FORM USEREXIT_SAVE_DOCUMENT_PREPARE . ENDFORM .","title":"USEREXIT_SAVE_DOCUMENT_PREPARE"},{"location":"others/cmod/","text":"CMOD\u589e\u5f3a \u00b6 \u67e5\u627eCMOD\u589e\u5f3a \u00b6 \u5728\u7a0b\u5e8f\u4e2d\u641c\u7d22 CUSTOMER-FUNCTION \u627e\u5230\u540e\u9762\u76843\u4f4d\u6570\u5b57\u7f16\u53f7\uff0c\u51fa\u53e3\u51fd\u6570\u540d\u7684\u89c4\u5219\u4e3aEXIT_< \u7a0b\u5e8f\u540d >_<3\u4f4d\u6570\u5b57>\uff0c\u7136\u540e\u901a\u8fc7\u627e\u5230\u7684\u51fa\u53e3\u51fd\u6570\u540d\u5230 MODSAP \u8868\u91cc\u67e5\u627e\u6240\u5bf9\u5e94\u7684\u51fa\u53e3\u5bf9\u8c61 \uff08\u5373\u589e\u5f3a\u70b9\uff09 \u901a\u8fc7\u8c03\u8bd5\u7cfb\u7edf\u76f8\u5173\u51fd\u6570\uff1aMODX_FUNCTION_ACTIVE_CHECK \u4ee3\u7801\u627e\u589e\u5f3a E\u7c7b\uff1a MODX_FUNCTION_ACTIVE_CHECK \uff08\u68c0\u67e5\u529f\u80fd\u51fa\u53e3\u7c7b\u7528\u6237\u51fa\u53e3\u662f\u5426\u88ab\u6fc0\u6d3b\uff09 C\u7c7b\uff1a MODX_MENUENTRY_ACTIVE_CHECK \uff08\u68c0\u67e5\u83dc\u5355\u5173\u952e\u5b57\u7c7b\u589e\u5f3a\u6fc0\u6d3b\u72b6\u51b5\uff09 S\u7c7b\uff1a MODX_SUBSCREEN_ACTIVE_CHECK \uff08\u68c0\u67e5\u5c4f\u5e55\u7c7b\u589e\u5f3a\u6fc0\u6d3b\u72b6\u51b5\uff09 SAP\u7684\u4efb\u4f55\u4e00\u4e2a\u4e8b\u52a1\u7801 \u5bf9\u5e94\u7684\u6807\u6ce8\u7a0b\u5e8f\u90fd\u7559\u4e0b\u4e86\u5927\u91cf\u7684\u7528\u6237\u51fa\u53e3\uff0c\u6b63\u662fSAP\u7075\u6d3b\u7684\u914d\u7f6e\u548c\u5f3a\u5927\u7684\u7528\u6237\u51fa\u53e3\uff0c\u624d\u4f7f\u5176\u4ea7\u54c1\u8f7b\u677e\u5e94\u5bf9\u5404\u79cd\u590d\u6742\u9700\u6c42\u6210\u4e3a\u53ef\u80fd\uff0c\u7cfb\u7edf\u8fd8\u4e3a\u80fd\u5feb\u901f\u627e\u5230\u548c\u6fc0\u6d3b\u8fd9\u4e9b\u589e\u5f3a\u8fdb\u884c\u4e86\u6709\u6548\u7ec4\u7ec7\uff0c\u5404\u7c7b\u589e\u5f3a\u88ab\u8bb0\u5f55\u5728table\u4e2d\u5e76\u4e14\u63d0\u4f9b\u4e86\u76f8\u5173\u68c0\u67e5\u51fd\u6570\uff0c\u4ece\u800c\u66f4\u65b9\u4fbf\u7cfb\u7edf\u5b9e\u65bd\u8fc7\u7a0b \u3002","title":"CMOD\u589e\u5f3a"},{"location":"others/cmod/#cmod","text":"","title":"CMOD\u589e\u5f3a"},{"location":"others/cmod/#cmod_1","text":"\u5728\u7a0b\u5e8f\u4e2d\u641c\u7d22 CUSTOMER-FUNCTION \u627e\u5230\u540e\u9762\u76843\u4f4d\u6570\u5b57\u7f16\u53f7\uff0c\u51fa\u53e3\u51fd\u6570\u540d\u7684\u89c4\u5219\u4e3aEXIT_< \u7a0b\u5e8f\u540d >_<3\u4f4d\u6570\u5b57>\uff0c\u7136\u540e\u901a\u8fc7\u627e\u5230\u7684\u51fa\u53e3\u51fd\u6570\u540d\u5230 MODSAP \u8868\u91cc\u67e5\u627e\u6240\u5bf9\u5e94\u7684\u51fa\u53e3\u5bf9\u8c61 \uff08\u5373\u589e\u5f3a\u70b9\uff09 \u901a\u8fc7\u8c03\u8bd5\u7cfb\u7edf\u76f8\u5173\u51fd\u6570\uff1aMODX_FUNCTION_ACTIVE_CHECK \u4ee3\u7801\u627e\u589e\u5f3a E\u7c7b\uff1a MODX_FUNCTION_ACTIVE_CHECK \uff08\u68c0\u67e5\u529f\u80fd\u51fa\u53e3\u7c7b\u7528\u6237\u51fa\u53e3\u662f\u5426\u88ab\u6fc0\u6d3b\uff09 C\u7c7b\uff1a MODX_MENUENTRY_ACTIVE_CHECK \uff08\u68c0\u67e5\u83dc\u5355\u5173\u952e\u5b57\u7c7b\u589e\u5f3a\u6fc0\u6d3b\u72b6\u51b5\uff09 S\u7c7b\uff1a MODX_SUBSCREEN_ACTIVE_CHECK \uff08\u68c0\u67e5\u5c4f\u5e55\u7c7b\u589e\u5f3a\u6fc0\u6d3b\u72b6\u51b5\uff09 SAP\u7684\u4efb\u4f55\u4e00\u4e2a\u4e8b\u52a1\u7801 \u5bf9\u5e94\u7684\u6807\u6ce8\u7a0b\u5e8f\u90fd\u7559\u4e0b\u4e86\u5927\u91cf\u7684\u7528\u6237\u51fa\u53e3\uff0c\u6b63\u662fSAP\u7075\u6d3b\u7684\u914d\u7f6e\u548c\u5f3a\u5927\u7684\u7528\u6237\u51fa\u53e3\uff0c\u624d\u4f7f\u5176\u4ea7\u54c1\u8f7b\u677e\u5e94\u5bf9\u5404\u79cd\u590d\u6742\u9700\u6c42\u6210\u4e3a\u53ef\u80fd\uff0c\u7cfb\u7edf\u8fd8\u4e3a\u80fd\u5feb\u901f\u627e\u5230\u548c\u6fc0\u6d3b\u8fd9\u4e9b\u589e\u5f3a\u8fdb\u884c\u4e86\u6709\u6548\u7ec4\u7ec7\uff0c\u5404\u7c7b\u589e\u5f3a\u88ab\u8bb0\u5f55\u5728table\u4e2d\u5e76\u4e14\u63d0\u4f9b\u4e86\u76f8\u5173\u68c0\u67e5\u51fd\u6570\uff0c\u4ece\u800c\u66f4\u65b9\u4fbf\u7cfb\u7edf\u5b9e\u65bd\u8fc7\u7a0b \u3002","title":"\u67e5\u627eCMOD\u589e\u5f3a"},{"location":"others/migo/","text":"MIGO \u00b6 MIGO\u529f\u80fd\u5f3a\u5927\uff0c\u5728\u524d\u53f0\u6839\u636e\u64cd\u4f5c\u7c7b\u578b\u3001\u51ed\u8bc1\u7c7b\u578b\u3001\u79fb\u52a8\u7c7b\u578b\uff0c\u53ef\u5b9e\u73b0\u4e0d\u540c\u6548\u679c\u7684\u5e93\u5b58\u7ba1\u7406\u3002\u5176\u5bf9\u5e94BAPI\uff0c BAPI_GOODSMVT_CREATE \uff0c\u4e5f\u6709\u7740\u5f3a\u5927\u7684\u4f5c\u7528\uff0c\u6211\u5c3d\u53ef\u80fd\u628a\u5404\u79cd\u573a\u666f\u7684\u4ee3\u7801\u90fd\u5217\u793a\u3002 \u53c2\u6570\u8bf4\u660e \u00b6 GM_CODE \u00b6 \u5173\u4e8eGM_CODE\u4f20\u503c\u4f5c\u7528\uff1a GM_CODE \u4e8b\u52a1\u4ee3\u7801 \u8bf4\u660e1 \u8bf4\u660e2 01 MB01 Goods receipt for purchase order \u91c7\u8d2d\u8ba2\u5355\u6536\u8d27 02 MB31 Goods receipt for production order \u751f\u4ea7\u8ba2\u5355\u6536\u8d27 03 MB1A Goods issue \u53d1\u8d27 04 MB1B Transfer posting \u8f6c\u50a8 05 MB1C Other goods receipt \u5176\u4ed6\u6536\u8d27 06 MB11 Goods movement \u8d27\u7269\u79fb\u52a8 07 MB04 Subsequent adjustment to a subcontract order \u5206\u5305\u540e\u7eed\u8c03\u6574\uff0c\u4e0d\u61c2 \u8868 T158G \uff0cGM_CODE\u5bf9\u5e94\u7684\u4e8b\u52a1\u4ee3\u7801 \u8868 T158B \uff0c\u4e8b\u52a1\u4ee3\u7801\u5bf9\u5e94\u79fb\u52a8\u7c7b\u578b \u5982\u679c\u4e0d\u786e\u5b9a\u8981\u4f20\u4ec0\u4e48\u503c\uff0c\u53ef\u4ee5\u5148\u5230T158B\uff0c\u6839\u636e\u79fb\u52a8\u7c7b\u578b\u67e5\u627e\u4e8b\u52a1\u4ee3\u7801\uff0c\u518d\u5230T158G\u67e5\u627e\u5bf9\u5e94GM_CODE \u5b9e\u5728\u4e0d\u884c\uff0c\u5c31\u4e00\u4e2a\u4e00\u4e2a\u8bd5\u9519\u5427\uff0c\u53cd\u6b63\u4e5f\u4e0d\u591a MVT_IND \u00b6 \u79fb\u52a8\u6807\u8bc6\uff0c\u5927\u6982\u662f\u9488\u5bf9\u8d27\u7269\u79fb\u52a8\uff08GM_CODE=06\uff09\u6765\u8bbe\u7f6e\u7684\uff0c\u53c2\u8003\uff08\u57df\u503c\uff09\u8bf4\u660e\uff1a MVT_IND \u8bf4\u660e1 \u8bf4\u660e2 \u7a7a Goods movement w/o reference \u65e0\u53c2\u8003\u7684\u8d27\u7269\u79fb\u52a8 B Goods movement for purchase order \u6309\u91c7\u8d2d\u8ba2\u5355\u7684\u8d27\u7269\u79fb\u52a8 F Goods movement for production order \u6709\u5173\u751f\u4ea7\u5355\u7684\u8d27\u7269\u79fb\u52a8 L Goods movement for delivery note \u6709\u5173\u4ea4\u8d27\u901a\u77e5\u7684\u8d27\u7269\u79fb\u52a8 K Goods movement for kanban requirement (WM - internal only) \u770b\u677f\u9700\u6c42\u7684\u8d27\u7269\u79fb\u52a8\uff08WM\uff0d\u4ec5\u9650\u5185\u90e8\uff09 O Subsequent adjustment of \"material-provided\" consumption \"\u63d0\u4f9b\u7269\u6599\"\u6d88\u8017\u7684\u540e\u7eed\u8c03\u6574 W Subsequent adjustment of proportion/product unit material \u6bd4\u4f8b\u7684\u540e\u7eed\u8c03\u6574/\u4ea7\u54c1\u5355\u4f4d\u7269\u6599 MOVE_TYPE \u00b6 \u5177\u4f53\u53ef\u67e5\u8868\uff08T156\uff0cT156HT\uff09\uff0c\u4e0b\u9762\u5217\u793a\u5e38\u89c1\u7684\u51e0\u79cd\u79fb\u52a8\u7c7b\u578b\uff1a MOVE_TYPE \u8bf4\u660e 101 \u6536\u8d27\u5165\u5e93 102 \u51b2\u9500101 261 \u5de5\u5355\u9886\u6599 262 \u5de5\u5355\u9000\u6599\uff08\u6216\u51b2\u9500261\uff09 311 \u8f6c\u50a8 561 \u521b\u5efa\u671f\u521d\u5e93\u5b58 562 \u51b2\u9500561 \u573a\u666f \u00b6 \u6f14\u793a \u00b6 \u793a\u4f8b\u4ee3\u7801 DATA l_mtype TYPE bapi_mtype . DATA l_msg TYPE bapi_msg . DATA : ls_goodsmvt_header TYPE bapi2017_gm_head_01 , ls_goodsmvt_code TYPE bapi2017_gm_code , lt_goodsmvt_item TYPE STANDARD TABLE OF bapi2017_gm_item_create , ls_goodsmvt_item TYPE bapi2017_gm_item_create , ls_goodsmvt_headret TYPE bapi2017_gm_head_ret , lt_return TYPE STANDARD TABLE OF bapiret2 , ls_return TYPE bapiret2 . CLEAR ls_goodsmvt_header . ls_goodsmvt_header - pstng_date = ls_input - budat . ls_goodsmvt_header - doc_date = ls_input - budat . CLEAR ls_goodsmvt_code . ls_goodsmvt_code - gm_code = ls_input - gm_code . CLEAR lt_goodsmvt_item . CLEAR ls_goodsmvt_item . ls_goodsmvt_item - move_type = ls_input - bwart . ls_goodsmvt_item - material = ls_input - matnr . ls_goodsmvt_item - plant = ls_input - werks . ls_goodsmvt_item - stge_loc = ls_input - lgort . ls_goodsmvt_item - batch = ls_input - charg . ls_goodsmvt_item - spec_stock = ls_input - sobkz . ls_goodsmvt_item - entry_qnt = ls_input - menge . INSERT ls_goodsmvt_item INTO TABLE lt_goodsmvt_item . CLEAR ls_goodsmvt_headret . CLEAR lt_return . CLEAR ls_return . CALL FUNCTION 'BAPI_GOODSMVT_CREATE' EXPORTING goodsmvt_header = ls_goodsmvt_header goodsmvt_code = ls_goodsmvt_code IMPORTING goodsmvt_headret = ls_goodsmvt_headret TABLES goodsmvt_item = lt_goodsmvt_item return = lt_return . IF ls_goodsmvt_headret - mat_doc IS INITIAL . l_mtype = 'E' . LOOP AT lt_return INTO ls_return WHERE type CA 'AEX' . MESSAGE ID ls_return - id TYPE ls_return - type NUMBER ls_return - number WITH ls_return - message_v1 ls_return - message_v2 ls_return - message_v3 ls_return - message_v4 INTO ls_return - message . l_msg = |{ l_msg }{ ls_return - message } ; |. ENDLOOP . CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK' . ELSE . l_mtype = 'S' . l_msg = | \u7269\u6599\u51ed\u8bc1 { ls_goodsmvt_headret - mat_doc } \u5df2\u5904\u7406 |. CALL FUNCTION 'BAPI_TRANSACTION_COMMIT' EXPORTING wait = 'X' . ENDIF . \u91c7\u8d2d\u8ba2\u5355\u6536\u8d27 \u00b6 \u793a\u4f8b\u4ee3\u7801 \u751f\u4ea7\u8ba2\u5355\u6536\u8d27 \u00b6 \u793a\u4f8b\u4ee3\u7801 \u53d1\u8d27 \u00b6 \u793a\u4f8b\u4ee3\u7801 DATA : ls_goodsmvt_header TYPE bapi2017_gm_head_01 , ls_goodsmvt_code TYPE bapi2017_gm_code , ls_goodsmvt_headret TYPE bapi2017_gm_head_ret , lt_goodsmvt_item TYPE STANDARD TABLE OF bapi2017_gm_item_create , ls_goodsmvt_item TYPE bapi2017_gm_item_create , lt_return TYPE STANDARD TABLE OF bapiret2 , ls_return TYPE bapiret2 . CLEAR ls_goodsmvt_header . ls_goodsmvt_header - pstng_date = ls_input - budat . ls_goodsmvt_header - doc_date = ls_input - budat . CLEAR ls_goodsmvt_code . ls_goodsmvt_code - gm_code = '03' . \" \u53d1\u8d27 CLEAR lt_goodsmvt_item . CLEAR ls_goodsmvt_item . ls_goodsmvt_item - material = ls_input - matnr . ls_goodsmvt_item - plant = ls_input - werks . ls_goodsmvt_item - stge_loc = ls_input - lgort . ls_goodsmvt_item - batch = ls_input - charg . ls_goodsmvt_item - spec_stock = ls_input - sobkz . \" \u7279\u6b8a\u5e93\u5b58\u6807\u8bc6 ls_goodsmvt_item - entry_qnt = ls_input - menge . \" \u6570\u91cf ls_goodsmvt_item - move_type = '261' . ls_goodsmvt_item - xstob = ls_input - zcancel . \" 262\u7684\u8bdd\uff0c\u586b\u64a4\u9500\u6807\u8bb0\u5373\u53ef\uff0c\u4e0d\u7528\u6539\u79fb\u52a8\u7c7b\u578b \" WBS\u5143\u7d20 IF ls_input - pspnr IS NOT INITIAL . ls_goodsmvt_item - wbs_elem = ls_input - pspnr . ENDIF . \" \u751f\u4ea7\u8ba2\u5355 ls_goodsmvt_item - orderid = ls_input - aufnr . INSERT ls_goodsmvt_item INTO TABLE lt_goodsmvt_item . \" \u9884\u7559\u5355 ls_goodsmvt_item - reserv_no = ls_input - rsnum . ls_goodsmvt_item - res_item = ls_input - rspos . \" \u53d1\u8d27\u8fc7\u8d26 CLEAR ls_goodsmvt_headret . CLEAR lt_return . CLEAR ls_return . CALL FUNCTION 'BAPI_GOODSMVT_CREATE' EXPORTING goodsmvt_header = ls_goodsmvt_header goodsmvt_code = ls_goodsmvt_code IMPORTING goodsmvt_headret = ls_goodsmvt_headret TABLES goodsmvt_item = lt_goodsmvt_item return = lt_return . IF ls_goodsmvt_headret - mat_doc IS INITIAL . l_mtype = 'E' . LOOP AT lt_return INTO ls_return WHERE type CA 'AEX' . MESSAGE ID ls_return - id TYPE ls_return - type NUMBER ls_return - number WITH ls_return - message_v1 ls_return - message_v2 ls_return - message_v3 ls_return - message_v4 INTO ls_return - message . l_msg = |{ l_msg }{ ls_return - message } ; |. ENDLOOP . CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK' . ELSE . l_mtype = 'S' . l_msg = | \u7269\u6599\u51ed\u8bc1 { ls_goodsmvt_headret - mat_doc } \u5df2\u5904\u7406 |. CALL FUNCTION 'BAPI_TRANSACTION_COMMIT' EXPORTING wait = 'X' . ENDIF . \u8f6c\u50a8 \u00b6 \u5bf9\u4e8e\u9879\u76ee\u5e93\u5b58(WBS)\u8f6c\u50a8\uff0c\u5982\u679c\u51fa\u73b0\u9879\u76ee\u65e0\u6cd5\u4fee\u6539\u7684\u60c5\u51b5\uff0c\u53ef\u4ee5\u5728\u6267\u884c\u524d\u52a0\u5165\u4e0b\u9762\u4ee3\u7801\uff1a \u8bbe\u7f6eXMIGO\u6807\u8bb0 \" \u5728INCLUDE\u6587\u4ef6MM07MFU0_UMLAGERUNG_PRUEFEN \" \u884c179\uff0cIF xmigo <> X. \" \u884c243\uff0cIF dm07m-fausw+62(1) = minus. \" \u8be5\u6761\u4ef6\u4e2d\uff0cWBS_ELEM(PS_PSP_PNR)\u5b57\u6bb5\u88ab\u6e05\u7a7a \" \u5e76\u5728\u540e\u7eed\u5904\u7406\u8fc7\u7a0b\uff0c\uff08\u7a7a\u503c\uff09\u9ed8\u8ba4\u8d4b\u503c\u4e3aVAL_WBS_ELEM(MAT_PSPNR) \" \u56e0\u6b64\uff0c\u53ea\u8981\u5e72\u9884\u8fd9\u4e24\u4e2a\u5224\u65ad\u5373\u53ef\u89e3\u51b3\u5b57\u6bb5\u88ab\u6e05\u7a7a\u7684\u95ee\u9898 \" \u5229\u7528\u4e0b\u9762\u65b9\u6cd5\uff0c\u53ef\u4ee5\u5bf9XMIGO\u5b57\u6bb5\u8fdb\u884c\u8d4b\u503c CALL FUNCTION 'MB_SET_BAPI_FLAG' EXPORTING action = 3 . \u793a\u4f8b\u4ee3\u7801 DATA : ls_goodsmvt_header TYPE bapi2017_gm_head_01 , ls_goodsmvt_code TYPE bapi2017_gm_code , ls_goodsmvt_headret TYPE bapi2017_gm_head_ret , lt_goodsmvt_item TYPE STANDARD TABLE OF bapi2017_gm_item_create , ls_goodsmvt_item TYPE bapi2017_gm_item_create , lt_return TYPE STANDARD TABLE OF bapiret2 , ls_return TYPE bapiret2 . CLEAR ls_goodsmvt_header . ls_goodsmvt_header - pstng_date = ls_input - budat . ls_goodsmvt_header - doc_date = ls_input - budat . CLEAR ls_goodsmvt_code . ls_goodsmvt_code - gm_code = '04' . \" \u8f6c\u50a8 CLEAR lt_goodsmvt_item . CLEAR ls_goodsmvt_item . ls_goodsmvt_item - material = ls_input - matnr_from . ls_goodsmvt_item - move_mat = ls_input - matnr_to . ls_goodsmvt_item - plant = ls_input - werks_from . ls_goodsmvt_item - move_plant = ls_input - werks_to . ls_goodsmvt_item - stge_loc = ls_input - lgort_from . ls_goodsmvt_item - move_stloc = ls_input - lgort_to . ls_goodsmvt_item - batch = ls_input - charg_from . ls_goodsmvt_item - move_batch = ls_input - charg_to . \" ls_goodsmvt_item-val_wbs_elem = ls_input-pspnr_from. \" ls_goodsmvt_item-wbs_elem = ls_input-pspnr_to. CALL FUNCTION 'CONVERSION_EXIT_ABPSP_OUTPUT' EXPORTING input = ls_input - pspnr_from IMPORTING output = ls_goodsmvt_item - val_wbs_elem . CALL FUNCTION 'CONVERSION_EXIT_ABPSP_OUTPUT' EXPORTING input = ls_input - pspnr_to IMPORTING output = ls_goodsmvt_item - wbs_elem . ls_goodsmvt_item - move_type = '311' . ls_goodsmvt_item - spec_stock = 'Q' . \" \u7279\u6b8a\u5e93\u5b58\u6807\u8bc6 ls_goodsmvt_item - entry_qnt = ls_input - menge . \" \u6570\u91cf \" \u8bbe\u7f6eXMIGO\u6807\u8bb0 CALL FUNCTION 'MB_SET_BAPI_FLAG' EXPORTING action = 3 . \" \u8f6c\u50a8\u8fc7\u8d26 CLEAR ls_goodsmvt_headret . CLEAR lt_return . CLEAR ls_return . CALL FUNCTION 'BAPI_GOODSMVT_CREATE' EXPORTING goodsmvt_header = ls_goodsmvt_header goodsmvt_code = ls_goodsmvt_code IMPORTING goodsmvt_headret = ls_goodsmvt_headret TABLES goodsmvt_item = lt_goodsmvt_item return = lt_return . IF ls_goodsmvt_headret - mat_doc IS INITIAL . l_mtype = 'E' . LOOP AT lt_return INTO ls_return WHERE type CA 'AEX' . MESSAGE ID ls_return - id TYPE ls_return - type NUMBER ls_return - number WITH ls_return - message_v1 ls_return - message_v2 ls_return - message_v3 ls_return - message_v4 INTO ls_return - message . l_msg = |{ l_msg }{ ls_return - message } ; |. ENDLOOP . CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK' . ELSE . l_mtype = 'S' . l_msg = | \u7269\u6599\u51ed\u8bc1 { ls_goodsmvt_headret - mat_doc } \u5df2\u5904\u7406 |. CALL FUNCTION 'BAPI_TRANSACTION_COMMIT' EXPORTING wait = 'X' . ENDIF . \u5176\u4ed6\u6536\u8d27 \u00b6 \u793a\u4f8b\u4ee3\u7801 \u8d27\u7269\u79fb\u52a8 \u00b6 \u793a\u4f8b\u4ee3\u7801 \u9500\u552e\u8ba2\u5355\u51fa\u5e93 \u00b6 \u793a\u4f8b\u4ee3\u7801 \u51b2\u9500 \u00b6 BAPI_DELIVERYPROCESSING_EXEC","title":"MIGO"},{"location":"others/migo/#migo","text":"MIGO\u529f\u80fd\u5f3a\u5927\uff0c\u5728\u524d\u53f0\u6839\u636e\u64cd\u4f5c\u7c7b\u578b\u3001\u51ed\u8bc1\u7c7b\u578b\u3001\u79fb\u52a8\u7c7b\u578b\uff0c\u53ef\u5b9e\u73b0\u4e0d\u540c\u6548\u679c\u7684\u5e93\u5b58\u7ba1\u7406\u3002\u5176\u5bf9\u5e94BAPI\uff0c BAPI_GOODSMVT_CREATE \uff0c\u4e5f\u6709\u7740\u5f3a\u5927\u7684\u4f5c\u7528\uff0c\u6211\u5c3d\u53ef\u80fd\u628a\u5404\u79cd\u573a\u666f\u7684\u4ee3\u7801\u90fd\u5217\u793a\u3002","title":"MIGO"},{"location":"others/migo/#_1","text":"","title":"\u53c2\u6570\u8bf4\u660e"},{"location":"others/migo/#gm_code","text":"\u5173\u4e8eGM_CODE\u4f20\u503c\u4f5c\u7528\uff1a GM_CODE \u4e8b\u52a1\u4ee3\u7801 \u8bf4\u660e1 \u8bf4\u660e2 01 MB01 Goods receipt for purchase order \u91c7\u8d2d\u8ba2\u5355\u6536\u8d27 02 MB31 Goods receipt for production order \u751f\u4ea7\u8ba2\u5355\u6536\u8d27 03 MB1A Goods issue \u53d1\u8d27 04 MB1B Transfer posting \u8f6c\u50a8 05 MB1C Other goods receipt \u5176\u4ed6\u6536\u8d27 06 MB11 Goods movement \u8d27\u7269\u79fb\u52a8 07 MB04 Subsequent adjustment to a subcontract order \u5206\u5305\u540e\u7eed\u8c03\u6574\uff0c\u4e0d\u61c2 \u8868 T158G \uff0cGM_CODE\u5bf9\u5e94\u7684\u4e8b\u52a1\u4ee3\u7801 \u8868 T158B \uff0c\u4e8b\u52a1\u4ee3\u7801\u5bf9\u5e94\u79fb\u52a8\u7c7b\u578b \u5982\u679c\u4e0d\u786e\u5b9a\u8981\u4f20\u4ec0\u4e48\u503c\uff0c\u53ef\u4ee5\u5148\u5230T158B\uff0c\u6839\u636e\u79fb\u52a8\u7c7b\u578b\u67e5\u627e\u4e8b\u52a1\u4ee3\u7801\uff0c\u518d\u5230T158G\u67e5\u627e\u5bf9\u5e94GM_CODE \u5b9e\u5728\u4e0d\u884c\uff0c\u5c31\u4e00\u4e2a\u4e00\u4e2a\u8bd5\u9519\u5427\uff0c\u53cd\u6b63\u4e5f\u4e0d\u591a","title":"GM_CODE"},{"location":"others/migo/#mvt_ind","text":"\u79fb\u52a8\u6807\u8bc6\uff0c\u5927\u6982\u662f\u9488\u5bf9\u8d27\u7269\u79fb\u52a8\uff08GM_CODE=06\uff09\u6765\u8bbe\u7f6e\u7684\uff0c\u53c2\u8003\uff08\u57df\u503c\uff09\u8bf4\u660e\uff1a MVT_IND \u8bf4\u660e1 \u8bf4\u660e2 \u7a7a Goods movement w/o reference \u65e0\u53c2\u8003\u7684\u8d27\u7269\u79fb\u52a8 B Goods movement for purchase order \u6309\u91c7\u8d2d\u8ba2\u5355\u7684\u8d27\u7269\u79fb\u52a8 F Goods movement for production order \u6709\u5173\u751f\u4ea7\u5355\u7684\u8d27\u7269\u79fb\u52a8 L Goods movement for delivery note \u6709\u5173\u4ea4\u8d27\u901a\u77e5\u7684\u8d27\u7269\u79fb\u52a8 K Goods movement for kanban requirement (WM - internal only) \u770b\u677f\u9700\u6c42\u7684\u8d27\u7269\u79fb\u52a8\uff08WM\uff0d\u4ec5\u9650\u5185\u90e8\uff09 O Subsequent adjustment of \"material-provided\" consumption \"\u63d0\u4f9b\u7269\u6599\"\u6d88\u8017\u7684\u540e\u7eed\u8c03\u6574 W Subsequent adjustment of proportion/product unit material \u6bd4\u4f8b\u7684\u540e\u7eed\u8c03\u6574/\u4ea7\u54c1\u5355\u4f4d\u7269\u6599","title":"MVT_IND"},{"location":"others/migo/#move_type","text":"\u5177\u4f53\u53ef\u67e5\u8868\uff08T156\uff0cT156HT\uff09\uff0c\u4e0b\u9762\u5217\u793a\u5e38\u89c1\u7684\u51e0\u79cd\u79fb\u52a8\u7c7b\u578b\uff1a MOVE_TYPE \u8bf4\u660e 101 \u6536\u8d27\u5165\u5e93 102 \u51b2\u9500101 261 \u5de5\u5355\u9886\u6599 262 \u5de5\u5355\u9000\u6599\uff08\u6216\u51b2\u9500261\uff09 311 \u8f6c\u50a8 561 \u521b\u5efa\u671f\u521d\u5e93\u5b58 562 \u51b2\u9500561","title":"MOVE_TYPE"},{"location":"others/migo/#_2","text":"","title":"\u573a\u666f"},{"location":"others/migo/#_3","text":"\u793a\u4f8b\u4ee3\u7801 DATA l_mtype TYPE bapi_mtype . DATA l_msg TYPE bapi_msg . DATA : ls_goodsmvt_header TYPE bapi2017_gm_head_01 , ls_goodsmvt_code TYPE bapi2017_gm_code , lt_goodsmvt_item TYPE STANDARD TABLE OF bapi2017_gm_item_create , ls_goodsmvt_item TYPE bapi2017_gm_item_create , ls_goodsmvt_headret TYPE bapi2017_gm_head_ret , lt_return TYPE STANDARD TABLE OF bapiret2 , ls_return TYPE bapiret2 . CLEAR ls_goodsmvt_header . ls_goodsmvt_header - pstng_date = ls_input - budat . ls_goodsmvt_header - doc_date = ls_input - budat . CLEAR ls_goodsmvt_code . ls_goodsmvt_code - gm_code = ls_input - gm_code . CLEAR lt_goodsmvt_item . CLEAR ls_goodsmvt_item . ls_goodsmvt_item - move_type = ls_input - bwart . ls_goodsmvt_item - material = ls_input - matnr . ls_goodsmvt_item - plant = ls_input - werks . ls_goodsmvt_item - stge_loc = ls_input - lgort . ls_goodsmvt_item - batch = ls_input - charg . ls_goodsmvt_item - spec_stock = ls_input - sobkz . ls_goodsmvt_item - entry_qnt = ls_input - menge . INSERT ls_goodsmvt_item INTO TABLE lt_goodsmvt_item . CLEAR ls_goodsmvt_headret . CLEAR lt_return . CLEAR ls_return . CALL FUNCTION 'BAPI_GOODSMVT_CREATE' EXPORTING goodsmvt_header = ls_goodsmvt_header goodsmvt_code = ls_goodsmvt_code IMPORTING goodsmvt_headret = ls_goodsmvt_headret TABLES goodsmvt_item = lt_goodsmvt_item return = lt_return . IF ls_goodsmvt_headret - mat_doc IS INITIAL . l_mtype = 'E' . LOOP AT lt_return INTO ls_return WHERE type CA 'AEX' . MESSAGE ID ls_return - id TYPE ls_return - type NUMBER ls_return - number WITH ls_return - message_v1 ls_return - message_v2 ls_return - message_v3 ls_return - message_v4 INTO ls_return - message . l_msg = |{ l_msg }{ ls_return - message } ; |. ENDLOOP . CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK' . ELSE . l_mtype = 'S' . l_msg = | \u7269\u6599\u51ed\u8bc1 { ls_goodsmvt_headret - mat_doc } \u5df2\u5904\u7406 |. CALL FUNCTION 'BAPI_TRANSACTION_COMMIT' EXPORTING wait = 'X' . ENDIF .","title":"\u6f14\u793a"},{"location":"others/migo/#_4","text":"\u793a\u4f8b\u4ee3\u7801","title":"\u91c7\u8d2d\u8ba2\u5355\u6536\u8d27"},{"location":"others/migo/#_5","text":"\u793a\u4f8b\u4ee3\u7801","title":"\u751f\u4ea7\u8ba2\u5355\u6536\u8d27"},{"location":"others/migo/#_6","text":"\u793a\u4f8b\u4ee3\u7801 DATA : ls_goodsmvt_header TYPE bapi2017_gm_head_01 , ls_goodsmvt_code TYPE bapi2017_gm_code , ls_goodsmvt_headret TYPE bapi2017_gm_head_ret , lt_goodsmvt_item TYPE STANDARD TABLE OF bapi2017_gm_item_create , ls_goodsmvt_item TYPE bapi2017_gm_item_create , lt_return TYPE STANDARD TABLE OF bapiret2 , ls_return TYPE bapiret2 . CLEAR ls_goodsmvt_header . ls_goodsmvt_header - pstng_date = ls_input - budat . ls_goodsmvt_header - doc_date = ls_input - budat . CLEAR ls_goodsmvt_code . ls_goodsmvt_code - gm_code = '03' . \" \u53d1\u8d27 CLEAR lt_goodsmvt_item . CLEAR ls_goodsmvt_item . ls_goodsmvt_item - material = ls_input - matnr . ls_goodsmvt_item - plant = ls_input - werks . ls_goodsmvt_item - stge_loc = ls_input - lgort . ls_goodsmvt_item - batch = ls_input - charg . ls_goodsmvt_item - spec_stock = ls_input - sobkz . \" \u7279\u6b8a\u5e93\u5b58\u6807\u8bc6 ls_goodsmvt_item - entry_qnt = ls_input - menge . \" \u6570\u91cf ls_goodsmvt_item - move_type = '261' . ls_goodsmvt_item - xstob = ls_input - zcancel . \" 262\u7684\u8bdd\uff0c\u586b\u64a4\u9500\u6807\u8bb0\u5373\u53ef\uff0c\u4e0d\u7528\u6539\u79fb\u52a8\u7c7b\u578b \" WBS\u5143\u7d20 IF ls_input - pspnr IS NOT INITIAL . ls_goodsmvt_item - wbs_elem = ls_input - pspnr . ENDIF . \" \u751f\u4ea7\u8ba2\u5355 ls_goodsmvt_item - orderid = ls_input - aufnr . INSERT ls_goodsmvt_item INTO TABLE lt_goodsmvt_item . \" \u9884\u7559\u5355 ls_goodsmvt_item - reserv_no = ls_input - rsnum . ls_goodsmvt_item - res_item = ls_input - rspos . \" \u53d1\u8d27\u8fc7\u8d26 CLEAR ls_goodsmvt_headret . CLEAR lt_return . CLEAR ls_return . CALL FUNCTION 'BAPI_GOODSMVT_CREATE' EXPORTING goodsmvt_header = ls_goodsmvt_header goodsmvt_code = ls_goodsmvt_code IMPORTING goodsmvt_headret = ls_goodsmvt_headret TABLES goodsmvt_item = lt_goodsmvt_item return = lt_return . IF ls_goodsmvt_headret - mat_doc IS INITIAL . l_mtype = 'E' . LOOP AT lt_return INTO ls_return WHERE type CA 'AEX' . MESSAGE ID ls_return - id TYPE ls_return - type NUMBER ls_return - number WITH ls_return - message_v1 ls_return - message_v2 ls_return - message_v3 ls_return - message_v4 INTO ls_return - message . l_msg = |{ l_msg }{ ls_return - message } ; |. ENDLOOP . CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK' . ELSE . l_mtype = 'S' . l_msg = | \u7269\u6599\u51ed\u8bc1 { ls_goodsmvt_headret - mat_doc } \u5df2\u5904\u7406 |. CALL FUNCTION 'BAPI_TRANSACTION_COMMIT' EXPORTING wait = 'X' . ENDIF .","title":"\u53d1\u8d27"},{"location":"others/migo/#_7","text":"\u5bf9\u4e8e\u9879\u76ee\u5e93\u5b58(WBS)\u8f6c\u50a8\uff0c\u5982\u679c\u51fa\u73b0\u9879\u76ee\u65e0\u6cd5\u4fee\u6539\u7684\u60c5\u51b5\uff0c\u53ef\u4ee5\u5728\u6267\u884c\u524d\u52a0\u5165\u4e0b\u9762\u4ee3\u7801\uff1a \u8bbe\u7f6eXMIGO\u6807\u8bb0 \" \u5728INCLUDE\u6587\u4ef6MM07MFU0_UMLAGERUNG_PRUEFEN \" \u884c179\uff0cIF xmigo <> X. \" \u884c243\uff0cIF dm07m-fausw+62(1) = minus. \" \u8be5\u6761\u4ef6\u4e2d\uff0cWBS_ELEM(PS_PSP_PNR)\u5b57\u6bb5\u88ab\u6e05\u7a7a \" \u5e76\u5728\u540e\u7eed\u5904\u7406\u8fc7\u7a0b\uff0c\uff08\u7a7a\u503c\uff09\u9ed8\u8ba4\u8d4b\u503c\u4e3aVAL_WBS_ELEM(MAT_PSPNR) \" \u56e0\u6b64\uff0c\u53ea\u8981\u5e72\u9884\u8fd9\u4e24\u4e2a\u5224\u65ad\u5373\u53ef\u89e3\u51b3\u5b57\u6bb5\u88ab\u6e05\u7a7a\u7684\u95ee\u9898 \" \u5229\u7528\u4e0b\u9762\u65b9\u6cd5\uff0c\u53ef\u4ee5\u5bf9XMIGO\u5b57\u6bb5\u8fdb\u884c\u8d4b\u503c CALL FUNCTION 'MB_SET_BAPI_FLAG' EXPORTING action = 3 . \u793a\u4f8b\u4ee3\u7801 DATA : ls_goodsmvt_header TYPE bapi2017_gm_head_01 , ls_goodsmvt_code TYPE bapi2017_gm_code , ls_goodsmvt_headret TYPE bapi2017_gm_head_ret , lt_goodsmvt_item TYPE STANDARD TABLE OF bapi2017_gm_item_create , ls_goodsmvt_item TYPE bapi2017_gm_item_create , lt_return TYPE STANDARD TABLE OF bapiret2 , ls_return TYPE bapiret2 . CLEAR ls_goodsmvt_header . ls_goodsmvt_header - pstng_date = ls_input - budat . ls_goodsmvt_header - doc_date = ls_input - budat . CLEAR ls_goodsmvt_code . ls_goodsmvt_code - gm_code = '04' . \" \u8f6c\u50a8 CLEAR lt_goodsmvt_item . CLEAR ls_goodsmvt_item . ls_goodsmvt_item - material = ls_input - matnr_from . ls_goodsmvt_item - move_mat = ls_input - matnr_to . ls_goodsmvt_item - plant = ls_input - werks_from . ls_goodsmvt_item - move_plant = ls_input - werks_to . ls_goodsmvt_item - stge_loc = ls_input - lgort_from . ls_goodsmvt_item - move_stloc = ls_input - lgort_to . ls_goodsmvt_item - batch = ls_input - charg_from . ls_goodsmvt_item - move_batch = ls_input - charg_to . \" ls_goodsmvt_item-val_wbs_elem = ls_input-pspnr_from. \" ls_goodsmvt_item-wbs_elem = ls_input-pspnr_to. CALL FUNCTION 'CONVERSION_EXIT_ABPSP_OUTPUT' EXPORTING input = ls_input - pspnr_from IMPORTING output = ls_goodsmvt_item - val_wbs_elem . CALL FUNCTION 'CONVERSION_EXIT_ABPSP_OUTPUT' EXPORTING input = ls_input - pspnr_to IMPORTING output = ls_goodsmvt_item - wbs_elem . ls_goodsmvt_item - move_type = '311' . ls_goodsmvt_item - spec_stock = 'Q' . \" \u7279\u6b8a\u5e93\u5b58\u6807\u8bc6 ls_goodsmvt_item - entry_qnt = ls_input - menge . \" \u6570\u91cf \" \u8bbe\u7f6eXMIGO\u6807\u8bb0 CALL FUNCTION 'MB_SET_BAPI_FLAG' EXPORTING action = 3 . \" \u8f6c\u50a8\u8fc7\u8d26 CLEAR ls_goodsmvt_headret . CLEAR lt_return . CLEAR ls_return . CALL FUNCTION 'BAPI_GOODSMVT_CREATE' EXPORTING goodsmvt_header = ls_goodsmvt_header goodsmvt_code = ls_goodsmvt_code IMPORTING goodsmvt_headret = ls_goodsmvt_headret TABLES goodsmvt_item = lt_goodsmvt_item return = lt_return . IF ls_goodsmvt_headret - mat_doc IS INITIAL . l_mtype = 'E' . LOOP AT lt_return INTO ls_return WHERE type CA 'AEX' . MESSAGE ID ls_return - id TYPE ls_return - type NUMBER ls_return - number WITH ls_return - message_v1 ls_return - message_v2 ls_return - message_v3 ls_return - message_v4 INTO ls_return - message . l_msg = |{ l_msg }{ ls_return - message } ; |. ENDLOOP . CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK' . ELSE . l_mtype = 'S' . l_msg = | \u7269\u6599\u51ed\u8bc1 { ls_goodsmvt_headret - mat_doc } \u5df2\u5904\u7406 |. CALL FUNCTION 'BAPI_TRANSACTION_COMMIT' EXPORTING wait = 'X' . ENDIF .","title":"\u8f6c\u50a8"},{"location":"others/migo/#_8","text":"\u793a\u4f8b\u4ee3\u7801","title":"\u5176\u4ed6\u6536\u8d27"},{"location":"others/migo/#_9","text":"\u793a\u4f8b\u4ee3\u7801","title":"\u8d27\u7269\u79fb\u52a8"},{"location":"others/migo/#_10","text":"\u793a\u4f8b\u4ee3\u7801","title":"\u9500\u552e\u8ba2\u5355\u51fa\u5e93"},{"location":"others/migo/#_11","text":"BAPI_DELIVERYPROCESSING_EXEC","title":"\u51b2\u9500"},{"location":"others/nest_loop/","text":"\u5d4c\u5957\u5faa\u73af\u4f18\u5316 \u00b6 \u7f51\u4e0a\u5206\u6790\u633a\u591a\uff0c\u6211\u5c31\u4e0d\u91cd\u590d\u4e86\uff0c\u76f4\u63a5\u4e0a\u4e2a\u6709\u6548\u7684\u4f18\u5316\u65b9\u6848\u3002 \u4e8c\u5206\u67e5\u627e \u00b6 \u793a\u4f8b\u4ee3\u7801 TYPES : BEGIN OF ty_data , field1 TYPE string , field2 TYPE string , END OF ty_data . DATA : lt_head TYPE STANDARD TABLE OF ty_data , ls_head TYPE ty_data , lt_item TYPE STANDARD TABLE OF ty_data , ls_item TYPE ty_data . SORT lt_item BY field1 field2 . LOOP AT lt_head INTO ls_head . \" ABAP\u4e2d\u7684\u4e8c\u5206\u67e5\u627e\uff0c\u4f1a\u627e\u5230\u91cd\u590d\u9879\u7684\u9996\u9879 READ TABLE lt_item TRANSPORTING NO FIELDS WITH KEY field1 = ls_head - field1 BINARY SEARCH . IF sy - subrc = 0 . LOOP AT lt_item INTO ls_item FROM sy - tabix . IF ls_item - field1 <> ls_head - field1 . EXIT . ENDIF . \" write something... ENDLOOP . ENDIF . ENDLOOP .","title":"\u5d4c\u5957\u5faa\u73af"},{"location":"others/nest_loop/#_1","text":"\u7f51\u4e0a\u5206\u6790\u633a\u591a\uff0c\u6211\u5c31\u4e0d\u91cd\u590d\u4e86\uff0c\u76f4\u63a5\u4e0a\u4e2a\u6709\u6548\u7684\u4f18\u5316\u65b9\u6848\u3002","title":"\u5d4c\u5957\u5faa\u73af\u4f18\u5316"},{"location":"others/nest_loop/#_2","text":"\u793a\u4f8b\u4ee3\u7801 TYPES : BEGIN OF ty_data , field1 TYPE string , field2 TYPE string , END OF ty_data . DATA : lt_head TYPE STANDARD TABLE OF ty_data , ls_head TYPE ty_data , lt_item TYPE STANDARD TABLE OF ty_data , ls_item TYPE ty_data . SORT lt_item BY field1 field2 . LOOP AT lt_head INTO ls_head . \" ABAP\u4e2d\u7684\u4e8c\u5206\u67e5\u627e\uff0c\u4f1a\u627e\u5230\u91cd\u590d\u9879\u7684\u9996\u9879 READ TABLE lt_item TRANSPORTING NO FIELDS WITH KEY field1 = ls_head - field1 BINARY SEARCH . IF sy - subrc = 0 . LOOP AT lt_item INTO ls_item FROM sy - tabix . IF ls_item - field1 <> ls_head - field1 . EXIT . ENDIF . \" write something... ENDLOOP . ENDIF . ENDLOOP .","title":"\u4e8c\u5206\u67e5\u627e"},{"location":"others/number_to_chinese/","text":"\u6570\u5b57\u8f6c\u4e2d\u6587 \u00b6 \u7f51\u4e0a\u4e0d\u5c11\u4ee3\u7801\u51fa\u4e8e\u6027\u80fd\u8003\u8651\uff0c\u4f1a\u4ece\u6570\u5b57\u5206\u6790\uff0c\u6240\u4ee5\u6211\u8bd5\u4e86\u4e0b\u76f4\u63a5\u8f6c\u5230\u6587\u672c\u8fdb\u884c\u5206\u6790\u3002 \u793a\u4f8b\u4ee3\u7801 FUNCTION zfm_fi_number_to_chinese . *\"---------------------------------------------------------------------- *\"*\"\u672c\u5730\u63a5\u53e3\uff1a *\" IMPORTING *\" REFERENCE(INPUT) *\" EXPORTING *\" REFERENCE(OUTPUT) TYPE STRING *\"---------------------------------------------------------------------- \" \u8f6c\u6362\u4e3a\u6570\u5b57\u683c\u5f0f DATA l_num TYPE p LENGTH 16 DECIMALS 2 . \" P(16,2)\u662f\u53ef\u8bbe\u7f6e\u7684\u6700\u5927\u8303\u56f4 TRY . l_num = input . CATCH cx_root . RETURN . ENDTRY . \" \u96f6\u503c\u6821\u9a8c IF l_num = 0 . output = '\u96f6\u5143\u6574' . RETURN . ENDIF . \" \u6570\u5b57\u6587\u672c DATA ( l_str ) = |{ l_num NUMBER = RAW }|. REPLACE '.' IN l_str WITH space . \" \u6570\u5b57\u5927\u5199\u5bf9\u7167 TYPES : BEGIN OF ty_num_map , num TYPE c LENGTH 1 , num_cn TYPE c LENGTH 1 , END OF ty_num_map . DATA lt_num_map TYPE HASHED TABLE OF ty_num_map WITH UNIQUE KEY num . lt_num_map = VALUE # ( ( num = '0' num_cn = '\u96f6' ) ( num = '1' num_cn = '\u58f9' ) ( num = '2' num_cn = '\u8d30' ) ( num = '3' num_cn = '\u53c1' ) ( num = '4' num_cn = '\u8086' ) ( num = '5' num_cn = '\u4f0d' ) ( num = '6' num_cn = '\u9646' ) ( num = '7' num_cn = '\u67d2' ) ( num = '8' num_cn = '\u634c' ) ( num = '9' num_cn = '\u7396' ) ). \" \u9884\u8bbe\u8868\uff0c\u89e3\u6790\u6587\u672c\u540e\uff0c\u6570\u5b57\u9006\u5e8f\u586b\u5165 TYPES : BEGIN OF ty_nums , unit_cn TYPE char01 , num_cn TYPE char01 , END OF ty_nums . DATA lt_nums TYPE STANDARD TABLE OF ty_nums WITH EMPTY KEY . lt_nums = VALUE # ( ( unit_cn = '\u5206' ) ( unit_cn = '\u89d2' ) ( unit_cn = '\u5143' ) ( unit_cn = '\u62fe' ) ( unit_cn = '\u4f70' ) ( unit_cn = '\u4edf' ) ( unit_cn = '\u4e07' ) ( unit_cn = '\u62fe' ) ( unit_cn = '\u4f70' ) ( unit_cn = '\u4edf' ) ( unit_cn = '\u4ebf' ) ( unit_cn = '\u62fe' ) ( unit_cn = '\u4f70' ) ( unit_cn = '\u4edf' ) ( unit_cn = '\u4e07' ) ). \" \u4ece\u53f3\u5230\u5de6\uff0c\u4ece\u5206\u5230\u4ebf\uff0c\u9010\u6570\u5b57\u586b\u8868 DATA ( l_length ) = strlen ( l_str ). DO l_length TIMES . DATA ( l_offset ) = l_length - sy - index . lt_nums [ sy - index ] - num_cn = lt_num_map [ num = l_str + l_offset ( 1 ) ] - num_cn . ENDDO . DELETE lt_nums WHERE num_cn IS INITIAL . \" \u5220\u9664\u6ca1\u586b\u5145\u7684\u9879 \" \u6ca1\u6709\u5c0f\u6570\u4f4d\uff0c\u8981\u663e\u793aX\u5143\u6574 IF lt_nums [ 1 ] - num_cn = '\u96f6' AND lt_nums [ 2 ] - num_cn = '\u96f6' . DELETE lt_nums FROM 1 TO 2 . INSERT VALUE # ( unit_cn = '\u6574' ) INTO lt_nums INDEX 1 . ENDIF . \" \u96f6\u503c\u5904\u7406 LOOP AT lt_nums REFERENCE INTO DATA ( lr_nums ) WHERE num_cn = '\u96f6' . CASE lr_nums -> unit_cn . WHEN '\u5206' . CLEAR lr_nums->* . WHEN '\u89d2' . CLEAR lr_nums->* . WHEN '\u5143' . CLEAR lr_nums -> num_cn . WHEN '\u4e07' . CLEAR lr_nums -> num_cn . WHEN '\u4ebf' . CLEAR lr_nums -> num_cn . WHEN OTHERS . CLEAR lr_nums -> unit_cn . ENDCASE . ENDLOOP . DELETE ADJACENT DUPLICATES FROM lt_nums COMPARING ALL FIELDS . \" \u9010\u9879\u62fc\u63a5 LOOP AT lt_nums REFERENCE INTO lr_nums . output = |{ lr_nums -> num_cn }{ lr_nums -> unit_cn }{ output }|. ENDLOOP . \" \u96f6\u503c\u5904\u74062 REPLACE '\u96f6\u5143' IN output WITH '\u5143' . REPLACE ALL OCCURRENCES OF '\u96f6\u4e07' IN output WITH '\u4e07' . REPLACE ALL OCCURRENCES OF '\u96f6\u4ebf' IN output WITH '\u4ebf' . ENDFUNCTION .","title":"\u4e2d\u6587\u5927\u5199"},{"location":"others/number_to_chinese/#_1","text":"\u7f51\u4e0a\u4e0d\u5c11\u4ee3\u7801\u51fa\u4e8e\u6027\u80fd\u8003\u8651\uff0c\u4f1a\u4ece\u6570\u5b57\u5206\u6790\uff0c\u6240\u4ee5\u6211\u8bd5\u4e86\u4e0b\u76f4\u63a5\u8f6c\u5230\u6587\u672c\u8fdb\u884c\u5206\u6790\u3002 \u793a\u4f8b\u4ee3\u7801 FUNCTION zfm_fi_number_to_chinese . *\"---------------------------------------------------------------------- *\"*\"\u672c\u5730\u63a5\u53e3\uff1a *\" IMPORTING *\" REFERENCE(INPUT) *\" EXPORTING *\" REFERENCE(OUTPUT) TYPE STRING *\"---------------------------------------------------------------------- \" \u8f6c\u6362\u4e3a\u6570\u5b57\u683c\u5f0f DATA l_num TYPE p LENGTH 16 DECIMALS 2 . \" P(16,2)\u662f\u53ef\u8bbe\u7f6e\u7684\u6700\u5927\u8303\u56f4 TRY . l_num = input . CATCH cx_root . RETURN . ENDTRY . \" \u96f6\u503c\u6821\u9a8c IF l_num = 0 . output = '\u96f6\u5143\u6574' . RETURN . ENDIF . \" \u6570\u5b57\u6587\u672c DATA ( l_str ) = |{ l_num NUMBER = RAW }|. REPLACE '.' IN l_str WITH space . \" \u6570\u5b57\u5927\u5199\u5bf9\u7167 TYPES : BEGIN OF ty_num_map , num TYPE c LENGTH 1 , num_cn TYPE c LENGTH 1 , END OF ty_num_map . DATA lt_num_map TYPE HASHED TABLE OF ty_num_map WITH UNIQUE KEY num . lt_num_map = VALUE # ( ( num = '0' num_cn = '\u96f6' ) ( num = '1' num_cn = '\u58f9' ) ( num = '2' num_cn = '\u8d30' ) ( num = '3' num_cn = '\u53c1' ) ( num = '4' num_cn = '\u8086' ) ( num = '5' num_cn = '\u4f0d' ) ( num = '6' num_cn = '\u9646' ) ( num = '7' num_cn = '\u67d2' ) ( num = '8' num_cn = '\u634c' ) ( num = '9' num_cn = '\u7396' ) ). \" \u9884\u8bbe\u8868\uff0c\u89e3\u6790\u6587\u672c\u540e\uff0c\u6570\u5b57\u9006\u5e8f\u586b\u5165 TYPES : BEGIN OF ty_nums , unit_cn TYPE char01 , num_cn TYPE char01 , END OF ty_nums . DATA lt_nums TYPE STANDARD TABLE OF ty_nums WITH EMPTY KEY . lt_nums = VALUE # ( ( unit_cn = '\u5206' ) ( unit_cn = '\u89d2' ) ( unit_cn = '\u5143' ) ( unit_cn = '\u62fe' ) ( unit_cn = '\u4f70' ) ( unit_cn = '\u4edf' ) ( unit_cn = '\u4e07' ) ( unit_cn = '\u62fe' ) ( unit_cn = '\u4f70' ) ( unit_cn = '\u4edf' ) ( unit_cn = '\u4ebf' ) ( unit_cn = '\u62fe' ) ( unit_cn = '\u4f70' ) ( unit_cn = '\u4edf' ) ( unit_cn = '\u4e07' ) ). \" \u4ece\u53f3\u5230\u5de6\uff0c\u4ece\u5206\u5230\u4ebf\uff0c\u9010\u6570\u5b57\u586b\u8868 DATA ( l_length ) = strlen ( l_str ). DO l_length TIMES . DATA ( l_offset ) = l_length - sy - index . lt_nums [ sy - index ] - num_cn = lt_num_map [ num = l_str + l_offset ( 1 ) ] - num_cn . ENDDO . DELETE lt_nums WHERE num_cn IS INITIAL . \" \u5220\u9664\u6ca1\u586b\u5145\u7684\u9879 \" \u6ca1\u6709\u5c0f\u6570\u4f4d\uff0c\u8981\u663e\u793aX\u5143\u6574 IF lt_nums [ 1 ] - num_cn = '\u96f6' AND lt_nums [ 2 ] - num_cn = '\u96f6' . DELETE lt_nums FROM 1 TO 2 . INSERT VALUE # ( unit_cn = '\u6574' ) INTO lt_nums INDEX 1 . ENDIF . \" \u96f6\u503c\u5904\u7406 LOOP AT lt_nums REFERENCE INTO DATA ( lr_nums ) WHERE num_cn = '\u96f6' . CASE lr_nums -> unit_cn . WHEN '\u5206' . CLEAR lr_nums->* . WHEN '\u89d2' . CLEAR lr_nums->* . WHEN '\u5143' . CLEAR lr_nums -> num_cn . WHEN '\u4e07' . CLEAR lr_nums -> num_cn . WHEN '\u4ebf' . CLEAR lr_nums -> num_cn . WHEN OTHERS . CLEAR lr_nums -> unit_cn . ENDCASE . ENDLOOP . DELETE ADJACENT DUPLICATES FROM lt_nums COMPARING ALL FIELDS . \" \u9010\u9879\u62fc\u63a5 LOOP AT lt_nums REFERENCE INTO lr_nums . output = |{ lr_nums -> num_cn }{ lr_nums -> unit_cn }{ output }|. ENDLOOP . \" \u96f6\u503c\u5904\u74062 REPLACE '\u96f6\u5143' IN output WITH '\u5143' . REPLACE ALL OCCURRENCES OF '\u96f6\u4e07' IN output WITH '\u4e07' . REPLACE ALL OCCURRENCES OF '\u96f6\u4ebf' IN output WITH '\u4ebf' . ENDFUNCTION .","title":"\u6570\u5b57\u8f6c\u4e2d\u6587"},{"location":"others/pricing/","text":"\u5b9a\u4ef7 \u00b6 \u5b9a\u4ef7\u4e5f\u662f\u9879\u76ee\u5b9e\u65bd\u5fc5\u4e0d\u53ef\u5c11\u7684\u6d41\u7a0b\u4e86\uff0c\u6211\u60f3\u60f3\u8981\u600e\u4e48\u5199 \u5b9a\u4ef7\u8fc7\u7a0b \u00b6 \u5b9a\u4ef7\u4f8b\u7a0b \u00b6 \u6267\u884c\u5b9a\u4ef7 \u00b6","title":"\u5b9a\u4ef7"},{"location":"others/pricing/#_1","text":"\u5b9a\u4ef7\u4e5f\u662f\u9879\u76ee\u5b9e\u65bd\u5fc5\u4e0d\u53ef\u5c11\u7684\u6d41\u7a0b\u4e86\uff0c\u6211\u60f3\u60f3\u8981\u600e\u4e48\u5199","title":"\u5b9a\u4ef7"},{"location":"others/pricing/#_2","text":"","title":"\u5b9a\u4ef7\u8fc7\u7a0b"},{"location":"others/pricing/#_3","text":"","title":"\u5b9a\u4ef7\u4f8b\u7a0b"},{"location":"others/pricing/#_4","text":"","title":"\u6267\u884c\u5b9a\u4ef7"},{"location":"others/send_mail/","text":"\u90ae\u4ef6\u53d1\u9001 \u00b6 SBWP\uff0c\u53d1\u9001\u6d4b\u8bd5 SOST\uff0c\u90ae\u7bb1\u7ba1\u7406 SCOT\uff0c\u8282\u70b9\u914d\u7f6e \u90ae\u4ef6\u53d1\u9001\u4ee3\u7801 DATA : send_request TYPE REF TO cl_bcs , document TYPE REF TO cl_document_bcs , fail TYPE REF TO cx_bcs , recipient TYPE REF TO if_recipient_bcs . DATA : ls TYPE string , mailto TYPE ad_smtpadr , main_text TYPE bcsy_text , title TYPE so_obj_des . ls = '\u8be5\u90ae\u4ef6\u7528\u4e8e\u6d4b\u8bd5\u6f14\u793a\u7a0b\u5e8f' . APPEND ls TO main_text . title = '\u90ae\u4ef6\u53d1\u9001\u6d4b\u8bd5' . mailto = 'xxx@xxx.xx' . TRY . \" \u521b\u5efa\u53d1\u9001\u8bf7\u6c42 send_request = cl_bcs => create_persistent ( ). \" \u521b\u5efa\u6574\u7406\u53d1\u9001\u5185\u5bb9 document = cl_document_bcs => create_document ( i_type = 'RAW' i_text = main_text i_subject = title ). \" \u6dfb\u52a0\u90ae\u4ef6\u5185\u5bb9\u5230\u53d1\u9001\u8bf7\u6c42 send_request -> set_document ( document ). \" \u90ae\u4ef6\u5730\u5740\u8f6c\u6362 recipient = cl_cam_address_bcs => create_internet_address ( mailto ). \" \u6dfb\u52a0\u90ae\u4ef6\u5730\u5740\u5230\u53d1\u9001\u8bf7\u6c42 send_request -> add_recipient ( recipient ). \" \u6b63\u5f0f\u53d1\u9001\u5e76\u63d0\u4ea4\u4f5c\u4e1a send_request -> send ( i_with_error_screen = 'X' ). COMMIT WORK AND WAIT . CATCH cx_bcs INTO fail . ENDTRY .","title":"\u90ae\u4ef6\u53d1\u9001"},{"location":"others/send_mail/#_1","text":"SBWP\uff0c\u53d1\u9001\u6d4b\u8bd5 SOST\uff0c\u90ae\u7bb1\u7ba1\u7406 SCOT\uff0c\u8282\u70b9\u914d\u7f6e \u90ae\u4ef6\u53d1\u9001\u4ee3\u7801 DATA : send_request TYPE REF TO cl_bcs , document TYPE REF TO cl_document_bcs , fail TYPE REF TO cx_bcs , recipient TYPE REF TO if_recipient_bcs . DATA : ls TYPE string , mailto TYPE ad_smtpadr , main_text TYPE bcsy_text , title TYPE so_obj_des . ls = '\u8be5\u90ae\u4ef6\u7528\u4e8e\u6d4b\u8bd5\u6f14\u793a\u7a0b\u5e8f' . APPEND ls TO main_text . title = '\u90ae\u4ef6\u53d1\u9001\u6d4b\u8bd5' . mailto = 'xxx@xxx.xx' . TRY . \" \u521b\u5efa\u53d1\u9001\u8bf7\u6c42 send_request = cl_bcs => create_persistent ( ). \" \u521b\u5efa\u6574\u7406\u53d1\u9001\u5185\u5bb9 document = cl_document_bcs => create_document ( i_type = 'RAW' i_text = main_text i_subject = title ). \" \u6dfb\u52a0\u90ae\u4ef6\u5185\u5bb9\u5230\u53d1\u9001\u8bf7\u6c42 send_request -> set_document ( document ). \" \u90ae\u4ef6\u5730\u5740\u8f6c\u6362 recipient = cl_cam_address_bcs => create_internet_address ( mailto ). \" \u6dfb\u52a0\u90ae\u4ef6\u5730\u5740\u5230\u53d1\u9001\u8bf7\u6c42 send_request -> add_recipient ( recipient ). \" \u6b63\u5f0f\u53d1\u9001\u5e76\u63d0\u4ea4\u4f5c\u4e1a send_request -> send ( i_with_error_screen = 'X' ). COMMIT WORK AND WAIT . CATCH cx_bcs INTO fail . ENDTRY .","title":"\u90ae\u4ef6\u53d1\u9001"},{"location":"others/smartforms/","text":"SMARTFORMS\u76f8\u5173 \u00b6 \u793a\u4f8b\u4ee3\u7801 \u53d6\u6d88\u6fc0\u6d3bWORD\u7f16\u8f91\u5668 \u00b6 WORD\u7f16\u8f91\u5668\u6ca1\u529e\u6cd5\u62d6\u62fd\u5b57\u6bb5\uff0c\u9700\u8981\u6362\u56de\u6587\u672c\u7f16\u8f91\u5668\u3002 SE38\u8fd0\u884c\u7a0b\u5e8fRSCPSETEDITOR\uff0c\u53d6\u6d88\u52fe\u9009\u5e76\u6fc0\u6d3b\u3002 CL_COS_UTILITIES=>IS_S4H\u589e\u5f3a\u52a0\u5165\u4e0b\u9762\u4ee3\u7801 IF sy - tcode = 'SMARTFORMS' . rv_is_s4h = abap_false . ENDIF . \u6253\u5370PDF \u00b6 \u548c\u666e\u901a\u6253\u5370\u6ca1\u592a\u5927\u533a\u522b\uff0c\u591a\u8bbe\u7f6e\u51e0\u4e2a\u53c2\u6570\u5373\u53ef \u793a\u4f8b\u4ee3\u7801 \" ... \" \u83b7\u53d6OTF\u5185\u5bb9 ls_control_parameters - getotf = abap_true . \" \u8bbe\u7f6e\u6253\u5370\u673a ls_output_options - tddest = 'LP01' . \" ... \" \u8c03\u7528\u6253\u5370\u7684\u51fd\u6570\uff0c\u901a\u8fc7JOB_OUTPUT_INFO\u83b7\u53d6OTF\u5185\u5bb9 DATA ls_job_output_info TYPE ssfcrescl . CALL FUNCTION l_fm_name EXPORTING control_parameters = ls_control_parameters output_options = ls_output_options IMPORTING job_output_options = ls_job_options job_output_info = ls_job_output_info EXCEPTIONS formatting_error = 1 internal_error = 2 send_error = 3 user_canceled = 4 OTHERS = 5 . \" PDF\u7684\u5f62\u5f0f\u4fdd\u5b58\u6253\u5370\u5355 DATA l_len TYPE i . DATA l_xstr TYPE xstring . DATA lt_lines TYPE STANDARD TABLE OF tline . CALL FUNCTION 'CONVERT_OTF' EXPORTING format = 'PDF' IMPORTING bin_filesize = l_len bin_file = l_xstr TABLES otf = ls_job_output_info - otfdata[] lines = lt_lines EXCEPTIONS err_max_linewidth = 1 err_format = 2 err_conv_not_possible = 3 err_bad_otf = 4 OTHERS = 5 . IF sy - subrc <> 0 . MESSAGE ID sy - msgid TYPE 'S' NUMBER sy - msgno DISPLAY LIKE 'E' WITH sy - msgv1 sy - msgv2 sy - msgv3 sy - msgv4 . RETURN . ENDIF . cl_openxml_helper => store_local_file ( im_file_name = 'C:\\Export.pdf' im_data = l_xstr ). \" ...","title":"SMARTFORMS\u76f8\u5173"},{"location":"others/smartforms/#smartforms","text":"\u793a\u4f8b\u4ee3\u7801","title":"SMARTFORMS\u76f8\u5173"},{"location":"others/smartforms/#word","text":"WORD\u7f16\u8f91\u5668\u6ca1\u529e\u6cd5\u62d6\u62fd\u5b57\u6bb5\uff0c\u9700\u8981\u6362\u56de\u6587\u672c\u7f16\u8f91\u5668\u3002 SE38\u8fd0\u884c\u7a0b\u5e8fRSCPSETEDITOR\uff0c\u53d6\u6d88\u52fe\u9009\u5e76\u6fc0\u6d3b\u3002 CL_COS_UTILITIES=>IS_S4H\u589e\u5f3a\u52a0\u5165\u4e0b\u9762\u4ee3\u7801 IF sy - tcode = 'SMARTFORMS' . rv_is_s4h = abap_false . ENDIF .","title":"\u53d6\u6d88\u6fc0\u6d3bWORD\u7f16\u8f91\u5668"},{"location":"others/smartforms/#pdf","text":"\u548c\u666e\u901a\u6253\u5370\u6ca1\u592a\u5927\u533a\u522b\uff0c\u591a\u8bbe\u7f6e\u51e0\u4e2a\u53c2\u6570\u5373\u53ef \u793a\u4f8b\u4ee3\u7801 \" ... \" \u83b7\u53d6OTF\u5185\u5bb9 ls_control_parameters - getotf = abap_true . \" \u8bbe\u7f6e\u6253\u5370\u673a ls_output_options - tddest = 'LP01' . \" ... \" \u8c03\u7528\u6253\u5370\u7684\u51fd\u6570\uff0c\u901a\u8fc7JOB_OUTPUT_INFO\u83b7\u53d6OTF\u5185\u5bb9 DATA ls_job_output_info TYPE ssfcrescl . CALL FUNCTION l_fm_name EXPORTING control_parameters = ls_control_parameters output_options = ls_output_options IMPORTING job_output_options = ls_job_options job_output_info = ls_job_output_info EXCEPTIONS formatting_error = 1 internal_error = 2 send_error = 3 user_canceled = 4 OTHERS = 5 . \" PDF\u7684\u5f62\u5f0f\u4fdd\u5b58\u6253\u5370\u5355 DATA l_len TYPE i . DATA l_xstr TYPE xstring . DATA lt_lines TYPE STANDARD TABLE OF tline . CALL FUNCTION 'CONVERT_OTF' EXPORTING format = 'PDF' IMPORTING bin_filesize = l_len bin_file = l_xstr TABLES otf = ls_job_output_info - otfdata[] lines = lt_lines EXCEPTIONS err_max_linewidth = 1 err_format = 2 err_conv_not_possible = 3 err_bad_otf = 4 OTHERS = 5 . IF sy - subrc <> 0 . MESSAGE ID sy - msgid TYPE 'S' NUMBER sy - msgno DISPLAY LIKE 'E' WITH sy - msgv1 sy - msgv2 sy - msgv3 sy - msgv4 . RETURN . ENDIF . cl_openxml_helper => store_local_file ( im_file_name = 'C:\\Export.pdf' im_data = l_xstr ). \" ...","title":"\u6253\u5370PDF"},{"location":"others/xlsx_io/","text":"EXCEL\u4e0a\u4f20\u4e0b\u8f7d \u00b6 \u6574\u7406\u4e0b\u5e38\u7528\u7684\u65b9\u6cd5\u3002 CL_EHFND_XLSX \u00b6 SAP\u7684\u5185\u7f6e\u65b9\u6cd5\uff0c\u901a\u8fc7\u89e3\u6790XLSX\u4e2d\u7684XML\u6587\u4ef6\uff0c\u5b9e\u73b0\u9ad8\u901f\u8bfb\u53d6\u6570\u636e\uff0c\u9996\u63a8\u3002 \u793a\u4f8b\u4ee3\u7801 TYPES : BEGIN OF ty_data , field1 TYPE string , field2 TYPE string , END OF ty_data . DATA : lt_data TYPE STANDARD TABLE OF ty_data , ls_data TYPE ty_data . \" \u83b7\u53d6\u4e0a\u4f20\u6587\u4ef6\u8def\u5f84 DATA ( l_file ) = cl_openxml_helper => browse_local_file_open ( iv_title = 'Choose' iv_filename = 'Import.xlsx' iv_extpattern = '*.xlsx|*.xlsx' ). TRY . \" \u83b7\u53d6\u6587\u4ef6\u5185\u5bb9 DATA ( l_buffer ) = cl_openxml_helper => load_local_file ( l_file ). \" \u89e3\u6790\u6587\u4ef6 DATA ( lo_xlsx ) = cl_ehfnd_xlsx => get_instance ( ). DATA ( lo_doc ) = lo_xlsx -> load_doc ( l_buffer ). DATA ( lt_sheet_info ) = lo_doc -> get_sheets ( ). DATA ( lo_sheet ) = lo_doc -> get_sheet_by_id ( lt_sheet_info [ 1 ] - sheet_id ). CATCH cx_openxml_format cx_openxml_not_found cx_openxml_not_allowed . RETURN . ENDTRY . \" \u83b7\u53d6\u4e0a\u4f20\u884c\u6570 DATA l_row TYPE i . DATA l_row_last TYPE i . l_row_last = lo_sheet -> get_last_row_number ( ). l_row = 1 . \" \u8df3\u8fc7\u62ac\u5934\u884c \" \u9010\u884c\u5904\u7406 WHILE l_row < l_row_last . l_row = l_row + 1 . CLEAR ls_data . ls_data - field1 = lo_sheet -> get_cell_content ( iv_row = l_row iv_column = 1 ). ls_data - field2 = lo_sheet -> get_cell_content ( iv_row = l_row iv_column = 2 ). INSERT ls_data INTO TABLE lt_data . ENDWHILE . \u5c01\u88c5\u7b80\u5316 \u00b6 CL_EHFND_XLSX\u4f7f\u7528\u4e0a\u6bd4\u5176\u4ed6\u65b9\u6cd5\u90fd\u663e\u5f97\u7e41\u7410\uff0c\u4e0d\u59a8\u5199\u4e9b\u5de5\u5177\u4ee3\u7801\u6765\u7b80\u5316\u3002 ZCL_XLSX_IO CLASS zcl_xlsx_io DEFINITION PUBLIC FINAL CREATE PUBLIC . PUBLIC SECTION . DATA mo_xlsx TYPE REF TO cl_ehfnd_xlsx . DATA mo_doc TYPE REF TO if_ehfnd_xlsx_doc . DATA mo_sheet TYPE REF TO if_ehfnd_xlsx_sheet . CLASS-METHODS download_smw0_templete IMPORTING ! i_objid TYPE w3objid ! i_name TYPE string OPTIONAL . CLASS-METHODS get_smw0_templete IMPORTING ! i_objid TYPE w3objid RETURNING VALUE ( r_buffer ) TYPE xstring . CLASS-METHODS replace_sharedstrings IMPORTING ! it_replace TYPE ANY TABLE CHANGING ! c_doc TYPE xstring . CLASS-METHODS get_local_file IMPORTING ! i_filename TYPE string OPTIONAL RETURNING VALUE ( r_buffer ) TYPE xstring . CLASS-METHODS import IMPORTING ! i_filename TYPE string OPTIONAL ! i_skip_row TYPE i DEFAULT 1 CHANGING ! ct_data TYPE ANY TABLE . CLASS-METHODS export IMPORTING ! i_filename TYPE string OPTIONAL ! it_data TYPE ANY TABLE . CLASS-METHODS get_instance IMPORTING ! i_buffer TYPE xstring OPTIONAL RETURNING VALUE ( ro_instance ) TYPE REF TO zcl_xlsx_io . CLASS-METHODS get_reader IMPORTING ! i_filename TYPE string OPTIONAL RETURNING VALUE ( ro_instance ) TYPE REF TO zcl_xlsx_io . CLASS-METHODS get_writer RETURNING VALUE ( ro_instance ) TYPE REF TO zcl_xlsx_io . CLASS-METHODS conv IMPORTING ! dataflow TYPE string ! convexit TYPE string OPTIONAL ! input TYPE data EXPORTING ! output TYPE data . METHODS start IMPORTING ! i_row TYPE i OPTIONAL ! i_column TYPE i OPTIONAL . METHODS stop . METHODS row_id RETURNING VALUE ( r_row ) TYPE i . METHODS column_id RETURNING VALUE ( r_column ) TYPE i . METHODS has_next_row RETURNING VALUE ( r_flag ) TYPE abap_bool . METHODS has_next_column RETURNING VALUE ( r_flag ) TYPE abap_bool . METHODS next_row IMPORTING ! i_row TYPE i DEFAULT 1 . METHODS next_column IMPORTING ! i_column TYPE i DEFAULT 1 . METHODS read_column IMPORTING ! i_column TYPE i EXPORTING ! e_value TYPE data RETURNING VALUE ( r_value ) TYPE string . METHODS read_next_column EXPORTING ! e_value TYPE data RETURNING VALUE ( r_value ) TYPE string . METHODS write_column IMPORTING ! i_value TYPE data ! i_conv TYPE xfeld DEFAULT abap_false ! i_column TYPE i . METHODS write_next_column IMPORTING ! i_value TYPE data ! i_conv TYPE xfeld DEFAULT abap_false . METHODS save IMPORTING ! i_filename TYPE string OPTIONAL . PROTECTED SECTION . PRIVATE SECTION . DATA m_row TYPE i . DATA m_column TYPE i . DATA m_row_last TYPE i . DATA m_column_last TYPE i . ENDCLASS . CLASS zcl_xlsx_io IMPLEMENTATION . METHOD column_id . r_column = m_column . ENDMETHOD . METHOD conv . DATA l_subrc TYPE subrc VALUE 4 . DATA l_value TYPE string . DATA l_convexit TYPE string . DATA l_fm_convexit TYPE rs38l_fnam . \" \u8f6c\u6362\u4f8b\u7a0b\u51fd\u6570 DESCRIBE FIELD output TYPE DATA ( l_type ) EDIT MASK DATA ( l_mask ). \" EDIT MASK\u53d6\u51fa\u6765\u7684\u503c\u5982\uff1a==ALPHA\u3001==MATN1 CLEAR l_convexit . IF convexit IS SUPPLIED . l_convexit = convexit . ELSEIF strlen ( l_mask ) > 2 . l_convexit = l_mask + 2 . ELSEIF l_type = 'N' . \" \u5982\u679c\u662fNUMC\u7c7b\u578b\uff0c\u9ed8\u8ba4ALPHA\u8f6c\u6362 l_convexit = 'ALPHA' . ENDIF . CASE l_type . WHEN 'D' OR 'T' . \" \u65e5\u671f\u65f6\u95f4\u683c\u5f0f l_value = input . REPLACE ALL OCCURRENCES OF REGEX '[^0-9]' IN l_value WITH '' . output = l_value . WHEN OTHERS . \" \u68c0\u67e5\u5b57\u6bb5\u662f\u5426\u6709\u8f93\u51fa\u8f6c\u6362 IF l_convexit IS INITIAL . output = input . ELSE . TRY . \" EDIT MASK\u4e0d\u652f\u6301STRING\uff0c\u8fd8\u662f\u8981\u7528CONVEXIT\u7684\u65b9\u6cd5 l_fm_convexit = | CONVERSION_EXIT_ { l_convexit } _ { dataflow }|. CALL FUNCTION l_fm_convexit EXPORTING input = input IMPORTING output = output EXCEPTIONS OTHERS = 99 . IF sy - subrc <> 0 . output = input . \" \u8f6c\u6362\u9519\u8bef\uff0c\u76f4\u63a5\u8f93\u5165 ENDIF . CATCH cx_root . output = input . ENDTRY . ENDIF . ENDCASE . \" CONDENSE\u5fc5\u987b\u662fCharacter-Like IF l_type = 'C' OR l_type = 'N' OR l_type = 'g' . CONDENSE output . \" \u53bb\u9664\u591a\u4f59\u7a7a\u683c ENDIF . ENDMETHOD . METHOD download_smw0_templete . DATA : ls_wwwdatatab TYPE wwwdatatab , l_rc TYPE sy - subrc , l_defaultfilename TYPE string , ls_wwwdata_tab TYPE wwwdatatab , l_object_name TYPE w3objid , l_filename TYPE string , l_default_file_name TYPE string , l_fullpath TYPE string , l_down_path TYPE localfile , ls_wwwdata TYPE wwwdata , l_path TYPE string . l_default_file_name = i_name . CALL METHOD cl_gui_frontend_services => file_save_dialog EXPORTING window_title = '\u9009\u62e9\u672c\u5730\u6587\u4ef6\u4fdd\u5b58\u8def\u5f84' default_file_name = l_default_file_name default_extension = '*.xlsx' file_filter = 'EXCEL FILES(*.xlsx)|*.xlsx' CHANGING filename = l_filename path = l_path fullpath = l_fullpath EXCEPTIONS cntl_error = 1 error_no_gui = 2 not_supported_by_gui = 3 OTHERS = 5 . IF sy - subrc <> 0 . RETURN . ENDIF . SELECT SINGLE * FROM wwwdata INNER JOIN tadir ON wwwdata~objid = tadir~obj_name INTO CORRESPONDING FIELDS OF ls_wwwdata_tab WHERE wwwdata~srtf2 = 0 AND wwwdata~relid = 'MI' AND tadir~pgmid = 'R3TR' AND tadir~object = 'W3MI' AND tadir~obj_name = i_objid . IF sy - subrc <> 0 . MESSAGE | \u6a21\u677f\u6587\u4ef6[ { i_objid } ]\u4e0d\u5b58\u5728 | TYPE 'S' DISPLAY LIKE 'E' . RETURN . ENDIF . l_down_path = l_fullpath . CALL FUNCTION 'DOWNLOAD_WEB_OBJECT' EXPORTING key = ls_wwwdata_tab destination = l_down_path IMPORTING rc = l_rc . IF sy - subrc = 0 . MESSAGE | \u6a21\u677f\u4e0b\u8f7d\u6210\u529f | TYPE 'S' . ELSE . MESSAGE | \u6a21\u677f\u4e0b\u8f7d\u5931\u8d25 | TYPE 'S' . ENDIF . ENDMETHOD . METHOD export . DATA lo_tabledescr TYPE REF TO cl_abap_tabledescr . DATA lo_structdescr TYPE REF TO cl_abap_structdescr . lo_tabledescr ?= cl_abap_typedescr => describe_by_data ( it_data ). lo_structdescr ?= lo_tabledescr -> get_table_line_type ( ). \" \u83b7\u53d6\u5185\u8868\u4fe1\u606f DATA ( lt_component ) = lo_structdescr -> get_components ( ). \" \u6df1\u5ea6\u7ed3\u6784\u5904\u7406\u592a\u9ebb\u70e6\uff0c\u4e0d\u8003\u8651\u4e86\uff0c\u6709\u9700\u8981\u53ef\u4ee5\u81ea\u5df1\u8c03\u6574 DELETE lt_component WHERE type IS NOT INSTANCE OF cl_abap_elemdescr . IF lt_component IS INITIAL . MESSAGE '\u5bfc\u51fa\u5931\u8d25' TYPE 'S' DISPLAY LIKE 'E' . RETURN . ENDIF . DATA ( lo_writer ) = zcl_xlsx_io => get_instance ( ). lo_writer -> start ( ). \" \u51c6\u5907\u5199\u5165 \" \u5199\u5165\u62ac\u5934\u6587\u672c\u884c lo_writer -> next_row ( ). LOOP AT lt_component INTO DATA ( ls_component ). lo_writer -> write_next_column ( ls_component - name ). ENDLOOP . \" \u5199\u5165\u6570\u636e\u884c LOOP AT it_data ASSIGNING FIELD - SYMBOL ( <ls_data> ). lo_writer -> next_row ( ). LOOP AT lt_component INTO ls_component . FIELD-SYMBOLS <fs_field> TYPE any . ASSIGN COMPONENT ls_component - name OF STRUCTURE <ls_data> TO <fs_field> . IF <fs_field> IS ASSIGNED . lo_writer -> write_next_column ( <fs_field> ). UNASSIGN <fs_field> . ELSE . lo_writer -> next_column ( ). ENDIF . ENDLOOP . ENDLOOP . \" \u5bfc\u51fa\u5230\u672c\u5730 lo_writer -> save ( i_filename = i_filename ). ENDMETHOD . METHOD get_instance . ro_instance = NEW # ( ). TRY . ro_instance -> mo_xlsx = cl_ehfnd_xlsx => get_instance ( ). IF i_buffer IS SUPPLIED . ro_instance -> mo_doc = ro_instance -> mo_xlsx -> load_doc ( iv_file_data = i_buffer ). ELSE . ro_instance -> mo_doc = ro_instance -> mo_xlsx -> create_doc ( ). ENDIF . DATA ( lt_sheet_info ) = ro_instance -> mo_doc -> get_sheets ( ). ro_instance -> mo_sheet = ro_instance -> mo_doc -> get_sheet_by_id ( lt_sheet_info [ 1 ] - sheet_id ). CATCH cx_openxml_format cx_openxml_not_found cx_openxml_not_allowed . CLEAR ro_instance . ENDTRY . ENDMETHOD . METHOD get_local_file . DATA l_filename TYPE string . IF i_filename IS NOT INITIAL . l_filename = i_filename . ELSE . l_filename = cl_openxml_helper => browse_local_file_open ( iv_title = 'Choose' iv_filename = 'Import.xlsx' iv_extpattern = '*.xlsx|*.xlsx' ). ENDIF . CHECK l_filename IS NOT INITIAL . TRY . r_buffer = cl_openxml_helper => load_local_file ( l_filename ). CATCH cx_openxml_not_found . CLEAR r_buffer . ENDTRY . ENDMETHOD . METHOD get_reader . DATA ( l_buffer ) = zcl_xlsx_io => get_local_file ( i_filename ). ro_instance = zcl_xlsx_io => get_instance ( i_buffer = l_buffer ). ENDMETHOD . METHOD get_smw0_templete . DATA : lt_mime TYPE STANDARD TABLE OF w3mime , ls_id TYPE wwwdataid , ls_key TYPE wwwdatatab . ls_key - relid = 'MI' . ls_key - objid = i_objid . CALL FUNCTION 'WWWDATA_IMPORT' EXPORTING key = ls_key TABLES mime = lt_mime EXCEPTIONS wrong_object_type = 1 import_error = 2 OTHERS = 3 . IF sy - subrc <> 0 . MESSAGE | \u6a21\u677f[ { i_objid } ]\u83b7\u53d6\u5931\u8d25 | TYPE 'S' DISPLAY LIKE 'E' . RETURN . ENDIF . SELECT SINGLE value FROM wwwparams WHERE relid = @ ls_key - relid AND objid = @ ls_key - objid AND name EQ 'filesize' INTO @ DATA ( l_param ). DATA l_length TYPE i . l_length = l_param . CALL FUNCTION 'SCMS_BINARY_TO_XSTRING' EXPORTING input_length = l_length IMPORTING buffer = r_buffer TABLES binary_tab = lt_mime EXCEPTIONS failed = 1 OTHERS = 2 . IF sy - subrc <> 0 . CLEAR r_buffer . ENDIF . ENDMETHOD . METHOD get_writer . ro_instance = get_instance ( ). ENDMETHOD . METHOD has_next_column . r_flag = xsdbool ( m_column_last > m_column ). ENDMETHOD . METHOD has_next_row . r_flag = xsdbool ( m_row_last > m_row ). ENDMETHOD . METHOD import . DATA lr_data TYPE REF TO data . FIELD-SYMBOLS <fs_data> TYPE any . FIELD-SYMBOLS <fs_field> TYPE any . \" \u6784\u9020\u5de5\u4f5c\u533a CREATE DATA lr_data LIKE LINE OF ct_data[] . ASSIGN lr_data->* TO <fs_data> . CHECK <fs_data> IS ASSIGNED . DATA ( l_buffer ) = get_local_file ( i_filename = i_filename ). CHECK l_buffer IS NOT INITIAL . DATA ( lo_reader ) = zcl_xlsx_io => get_instance ( i_buffer = l_buffer ). CHECK lo_reader IS NOT INITIAL . \" \u51c6\u5907\u8bfb\u53d6 lo_reader -> start ( ). \" \u8df3\u8fc7\u62ac\u5934\u884c DO i_skip_row TIMES . lo_reader -> next_row ( ). ENDDO . \" \u8bfb\u53d6\u6570\u636e\u884c WHILE lo_reader -> has_next_row ( ) = abap_true . lo_reader -> next_row ( ). CLEAR <fs_data> . DO . ASSIGN COMPONENT sy - index OF STRUCTURE <fs_data> TO <fs_field> . IF <fs_field> IS ASSIGNED . <fs_field> = lo_reader -> read_next_column ( ). UNASSIGN <fs_field> . ELSE . EXIT . ENDIF . ENDDO . INSERT <fs_data> INTO TABLE ct_data . ENDWHILE . ENDMETHOD . METHOD next_column . m_column = m_column + i_column . ENDMETHOD . METHOD next_row . m_row = m_row + i_row . CLEAR m_column . m_column_last = mo_sheet -> get_last_column_number_in_row ( m_row ). ENDMETHOD . METHOD read_column . r_value = mo_sheet -> get_cell_content ( iv_row = m_row iv_column = i_column ). IF e_value IS SUPPLIED . me -> conv ( EXPORTING dataflow = 'INPUT' input = r_value IMPORTING output = e_value ). ENDIF . ENDMETHOD . METHOD read_next_column . next_column ( ). r_value = read_column ( m_column ). IF e_value IS SUPPLIED . me -> conv ( EXPORTING dataflow = 'INPUT' input = r_value IMPORTING output = e_value ). ENDIF . ENDMETHOD . METHOD row_id . r_row = m_row . ENDMETHOD . METHOD save . DATA l_filename TYPE string . IF i_filename IS NOT INITIAL . l_filename = i_filename . ELSE . l_filename = cl_openxml_helper => browse_local_file_save ( iv_title = 'Save as' iv_filename = 'Export.xlsx' iv_extpattern = '*.xlsx|*.xlsx' ). ENDIF . CHECK l_filename IS NOT INITIAL . TRY . cl_openxml_helper => store_local_file ( im_file_name = l_filename im_data = mo_doc -> save ( ) ). CATCH cx_openxml_format cx_openxml_not_found cx_openxml_not_allowed cx_dynamic_check INTO DATA ( lx_openxml ). MESSAGE lx_openxml -> get_longtext ( ) TYPE 'S' DISPLAY LIKE 'E' . ENDTRY . ENDMETHOD . METHOD start . m_row_last = mo_sheet -> get_last_row_number ( ). m_row = i_row . m_column = i_column . ENDMETHOD . METHOD stop . m_row = m_row_last . IF m_row > 0 . m_column_last = mo_sheet -> get_last_column_number_in_row ( m_row ). m_column = m_column_last . ENDIF . ENDMETHOD . METHOD write_column . DATA l_value TYPE string . IF i_conv = abap_true . me -> conv ( EXPORTING dataflow = 'OUTPUT' input = i_value IMPORTING output = l_value ). ELSE . l_value = i_value . ENDIF . mo_sheet -> set_cell_content ( iv_row = m_row iv_column = i_column iv_value = l_value ). ENDMETHOD . METHOD write_next_column . next_column ( ). write_column ( i_column = m_column i_conv = i_conv i_value = i_value ). ENDMETHOD . METHOD replace_sharedstrings . \" \u7a0b\u5e8f\u8981\u6c42IT_REPLACE\u81f3\u5c11\u4e24\u5217\uff0c\u4ee3\u7801\u4f1a\u5c06\u5de6\u5217\u5185\u5bb9\u66ff\u6362\u4e3a\u53f3\u5217\u5185\u5bb9 CHECK it_replace IS NOT INITIAL . CHECK c_doc IS NOT INITIAL . FIELD-SYMBOLS <fs_replace_t> TYPE ANY TABLE . FIELD-SYMBOLS <fs_replace> TYPE any . FIELD-SYMBOLS <fs_from> TYPE any . FIELD-SYMBOLS <fs_to> TYPE any . TRY . DATA ( lo_doc ) = cl_xlsx_document => load_document ( c_doc ). DATA ( lo_workbook_part ) = lo_doc -> get_workbookpart ( ). DATA ( lo_sharedstrings_part ) = lo_workbook_part -> get_sharedstringspart ( ). DATA ( l_sharedstrings_xml ) = lo_sharedstrings_part -> get_data ( ). DATA ( l_sharedstrings_str ) = cl_openxml_helper => xstring_to_string ( l_sharedstrings_xml ). ASSIGN it_replace TO <fs_replace_t> . LOOP AT <fs_replace_t> ASSIGNING <fs_replace> . ASSIGN COMPONENT 1 OF STRUCTURE <fs_replace> TO <fs_from> . ASSIGN COMPONENT 2 OF STRUCTURE <fs_replace> TO <fs_to> . IF <fs_from> IS ASSIGNED AND <fs_to> IS ASSIGNED . IF <fs_from> IS NOT INITIAL . REPLACE ALL OCCURRENCES OF <fs_from> IN l_sharedstrings_str WITH <fs_to> IN CHARACTER MODE . ENDIF . ENDIF . UNASSIGN <fs_from> . UNASSIGN <fs_to> . ENDLOOP . l_sharedstrings_xml = cl_openxml_helper => string_to_xstring ( l_sharedstrings_str ). lo_sharedstrings_part -> feed_data ( l_sharedstrings_xml ). c_doc = lo_doc -> get_package_data ( ). CATCH cx_openxml_not_found cx_openxml_format cx_openxml_not_allowed INTO DATA ( lx_openxml ). MESSAGE lx_openxml -> get_text ( ) TYPE 'S' DISPLAY LIKE 'E' . CATCH cx_root INTO DATA ( lx_root ). MESSAGE lx_root -> get_text ( ) TYPE 'S' DISPLAY LIKE 'E' . ENDTRY . ENDMETHOD . ENDCLASS . \u793a\u4f8b\u4ee3\u7801 TYPES : BEGIN OF ty_data , field1 TYPE string , field2 TYPE string , END OF ty_data . DATA lt_data TYPE STANDARD TABLE OF ty_data . lt_data = VALUE # ( ( field1 = 'A1' field2 = 'B1' ) ( field1 = 'A2' field2 = 'B2' ) ). \" \u5bfc\u51fa zcl_xlsx_io => export ( lt_data ). \" \u5bfc\u5165 CLEAR lt_data . zcl_xlsx_io => import ( CHANGING ct_data = lt_data ). \u6587\u672c\u66ff\u6362 \u00b6 \u5bf9\u4e8e\u56fa\u5b9a\u6a21\u677f\u6587\u4ef6\uff0c\u4e0d\u59a8\u76f4\u63a5\u66ff\u6362\u91cc\u9762\u7684\u6587\u672c\u5185\u5bb9 \u793a\u4f8b\u4ee3\u7801 DATA ( l_buffer ) = zcl_xlsx_io => get_smw0_templete ( CONV # ( sy - tcode ) ). \" \u83b7\u53d6SMW0\u6a21\u677f\u6587\u4ef6 TRY . DATA ( lo_doc ) = cl_xlsx_document => load_document ( l_buffer ). DATA ( lo_workbook_part ) = lo_doc -> get_workbookpart ( ). DATA ( lo_sharedstrings_part ) = lo_workbook_part -> get_sharedstringspart ( ). \" \u76f4\u63a5\u66ff\u6362\u5373\u53ef \" \u4e5f\u8bd5\u8fc7\u89e3\u6790XML\u6587\u4ef6\uff0c\u4f46\u5bcc\u6587\u672c\u683c\u5f0f\u96be\u4ee5\u5904\u7406 DATA ( l_sharedstrings_xml ) = lo_sharedstrings_part -> get_data ( ). LOOP AT lt_replace INTO DATA ( ls_replace ). DATA ( l_from ) = cl_openxml_helper => string_to_xstring ( ls_replace - from ). IF l_from IS NOT INITIAL . DATA ( l_to ) = cl_openxml_helper => string_to_xstring ( ls_replace - to ). REPLACE ALL OCCURRENCES OF l_from IN l_sharedstrings_xml WITH l_to IN BYTE MODE . ENDIF . CLEAR l_from . CLEAR l_to . ENDLOOP . lo_sharedstrings_part -> feed_data ( l_sharedstrings_xml ). \" \u56de\u5199 l_buffer = lo_doc -> get_package_data ( ). \" \u83b7\u53d6\u66ff\u6362\u540e\u7684\u6587\u4ef6 CATCH cx_openxml_not_found cx_openxml_format cx_openxml_not_allowed INTO DATA ( lx_openxml ). MESSAGE lx_openxml -> get_text ( ) TYPE 'S' DISPLAY LIKE 'E' . ENDTRY . ABAP2XLSX \u00b6 \u7b2c\u4e09\u65b9\u5de5\u5177\uff0c\u901a\u8fc7\u89e3\u6790XLSX\u4e2d\u7684XML\u6587\u4ef6\uff0c\u5b9e\u73b0\u9ad8\u901f\u8bfb\u53d6\u6570\u636e\u3002\u76f8\u6bd4CL_EHFND_XLSX\uff0c\u63d0\u4f9b\u4e86\u66f4\u9f50\u5168\u7684\u6837\u5f0f\u8bbe\u7f6e\u3002 https://github.com/abap2xlsx/abap2xlsx/releases XLSX WORKBANCH \u00b6 \u7b2c\u4e09\u65b9\u5de5\u5177\uff0c\u7c7b\u4f3cSMARTFORMS\uff0c\u9884\u5148\u8bbe\u7f6e\u597dEXCEL\u6a21\u677f\u4e0e\u8f93\u5165\u53c2\u6570\uff0c\u968f\u540e\u53ef\u5728\u7a0b\u5e8f\u4e2d\u76f4\u63a5\u8c03\u7528\u83b7\u53d6\uff0c\u9002\u5408\u5bfc\u51fa\u7279\u5b9a\u683c\u5f0f\u7684\u9700\u6c42\u3002 TEXT_CONVERT_XLS_TO_SAP \u00b6 \u8be5\u65b9\u6cd5\u53ef\u5c06EXCEL\u5185\u5bb9\u76f4\u63a5\u6620\u5c04\u5230ABAP\u5185\u8868\u4e2d\u3002 \u793a\u4f8b\u4ee3\u7801 TYPES : BEGIN OF ty_data , field1 TYPE string , field2 TYPE string , END OF ty_data . TYPES tt_data TYPE STANDARD TABLE OF ty_data . DATA lt_data TYPE tt_data . DATA lt_raw TYPE truxs_t_text_data . CALL FUNCTION 'TEXT_CONVERT_XLS_TO_SAP' EXPORTING i_line_header = abap_false i_tab_raw_data = lt_raw i_filename = 'C:\\import.xls' TABLES i_tab_converted_data = lt_data EXCEPTIONS conversion_failed = 1 OTHERS = 2 . ALSM_EXCEL_TO_INTERNAL_TABLE \u00b6 \u8be5\u65b9\u6cd5\u53ef\u83b7\u53d6EXCEL\u5355\u5143\u683c\u5185\u5bb9\uff0c\u5904\u7406\u7075\u6d3b\u3002 \u793a\u4f8b\u4ee3\u7801 TYPES : BEGIN OF ty_data , field1 TYPE string , field2 TYPE string , END OF ty_data . TYPES tt_data TYPE STANDARD TABLE OF ty_data . DATA lt_data TYPE tt_data . DATA ls_data TYPE ty_data . DATA lt_intern TYPE STANDARD TABLE OF alsmex_tabline . DATA ls_intern TYPE alsmex_tabline . CALL FUNCTION 'ALSM_EXCEL_TO_INTERNAL_TABLE' EXPORTING filename = 'C:\\import.xls' i_begin_col = 1 i_begin_row = 2 \" \u8df3\u8fc7\u9996\u884c i_end_col = 2 i_end_row = 9999 TABLES intern = lt_intern EXCEPTIONS inconsistent_parameters = 1 upload_ole = 2 OTHERS = 3 . SORT lt_intern BY row col . LOOP AT lt_intern INTO ls_intern . AT NEW row . CLEAR ls_data . ENDAT . CASE ls_intern - col . WHEN '0001' . ls_data - field1 = ls_intern - value . WHEN '0002' . ls_data - field2 = ls_intern - value . WHEN OTHERS . ENDCASE . AT END OF row . INSERT ls_data INTO TABLE lt_data . ENDAT . ENDLOOP . OLE \u00b6 \u4e0a\u53e4\u5de5\u5177\uff0c\u5efa\u8bae\u653e\u5f03 DOI \u00b6 \u6ca1\u7528\u8fc7\uff0c\u4e0d\u61c2","title":"Excel\u4e0a\u4f20\u4e0b\u8f7d"},{"location":"others/xlsx_io/#excel","text":"\u6574\u7406\u4e0b\u5e38\u7528\u7684\u65b9\u6cd5\u3002","title":"EXCEL\u4e0a\u4f20\u4e0b\u8f7d"},{"location":"others/xlsx_io/#cl_ehfnd_xlsx","text":"SAP\u7684\u5185\u7f6e\u65b9\u6cd5\uff0c\u901a\u8fc7\u89e3\u6790XLSX\u4e2d\u7684XML\u6587\u4ef6\uff0c\u5b9e\u73b0\u9ad8\u901f\u8bfb\u53d6\u6570\u636e\uff0c\u9996\u63a8\u3002 \u793a\u4f8b\u4ee3\u7801 TYPES : BEGIN OF ty_data , field1 TYPE string , field2 TYPE string , END OF ty_data . DATA : lt_data TYPE STANDARD TABLE OF ty_data , ls_data TYPE ty_data . \" \u83b7\u53d6\u4e0a\u4f20\u6587\u4ef6\u8def\u5f84 DATA ( l_file ) = cl_openxml_helper => browse_local_file_open ( iv_title = 'Choose' iv_filename = 'Import.xlsx' iv_extpattern = '*.xlsx|*.xlsx' ). TRY . \" \u83b7\u53d6\u6587\u4ef6\u5185\u5bb9 DATA ( l_buffer ) = cl_openxml_helper => load_local_file ( l_file ). \" \u89e3\u6790\u6587\u4ef6 DATA ( lo_xlsx ) = cl_ehfnd_xlsx => get_instance ( ). DATA ( lo_doc ) = lo_xlsx -> load_doc ( l_buffer ). DATA ( lt_sheet_info ) = lo_doc -> get_sheets ( ). DATA ( lo_sheet ) = lo_doc -> get_sheet_by_id ( lt_sheet_info [ 1 ] - sheet_id ). CATCH cx_openxml_format cx_openxml_not_found cx_openxml_not_allowed . RETURN . ENDTRY . \" \u83b7\u53d6\u4e0a\u4f20\u884c\u6570 DATA l_row TYPE i . DATA l_row_last TYPE i . l_row_last = lo_sheet -> get_last_row_number ( ). l_row = 1 . \" \u8df3\u8fc7\u62ac\u5934\u884c \" \u9010\u884c\u5904\u7406 WHILE l_row < l_row_last . l_row = l_row + 1 . CLEAR ls_data . ls_data - field1 = lo_sheet -> get_cell_content ( iv_row = l_row iv_column = 1 ). ls_data - field2 = lo_sheet -> get_cell_content ( iv_row = l_row iv_column = 2 ). INSERT ls_data INTO TABLE lt_data . ENDWHILE .","title":"CL_EHFND_XLSX"},{"location":"others/xlsx_io/#_1","text":"CL_EHFND_XLSX\u4f7f\u7528\u4e0a\u6bd4\u5176\u4ed6\u65b9\u6cd5\u90fd\u663e\u5f97\u7e41\u7410\uff0c\u4e0d\u59a8\u5199\u4e9b\u5de5\u5177\u4ee3\u7801\u6765\u7b80\u5316\u3002 ZCL_XLSX_IO CLASS zcl_xlsx_io DEFINITION PUBLIC FINAL CREATE PUBLIC . PUBLIC SECTION . DATA mo_xlsx TYPE REF TO cl_ehfnd_xlsx . DATA mo_doc TYPE REF TO if_ehfnd_xlsx_doc . DATA mo_sheet TYPE REF TO if_ehfnd_xlsx_sheet . CLASS-METHODS download_smw0_templete IMPORTING ! i_objid TYPE w3objid ! i_name TYPE string OPTIONAL . CLASS-METHODS get_smw0_templete IMPORTING ! i_objid TYPE w3objid RETURNING VALUE ( r_buffer ) TYPE xstring . CLASS-METHODS replace_sharedstrings IMPORTING ! it_replace TYPE ANY TABLE CHANGING ! c_doc TYPE xstring . CLASS-METHODS get_local_file IMPORTING ! i_filename TYPE string OPTIONAL RETURNING VALUE ( r_buffer ) TYPE xstring . CLASS-METHODS import IMPORTING ! i_filename TYPE string OPTIONAL ! i_skip_row TYPE i DEFAULT 1 CHANGING ! ct_data TYPE ANY TABLE . CLASS-METHODS export IMPORTING ! i_filename TYPE string OPTIONAL ! it_data TYPE ANY TABLE . CLASS-METHODS get_instance IMPORTING ! i_buffer TYPE xstring OPTIONAL RETURNING VALUE ( ro_instance ) TYPE REF TO zcl_xlsx_io . CLASS-METHODS get_reader IMPORTING ! i_filename TYPE string OPTIONAL RETURNING VALUE ( ro_instance ) TYPE REF TO zcl_xlsx_io . CLASS-METHODS get_writer RETURNING VALUE ( ro_instance ) TYPE REF TO zcl_xlsx_io . CLASS-METHODS conv IMPORTING ! dataflow TYPE string ! convexit TYPE string OPTIONAL ! input TYPE data EXPORTING ! output TYPE data . METHODS start IMPORTING ! i_row TYPE i OPTIONAL ! i_column TYPE i OPTIONAL . METHODS stop . METHODS row_id RETURNING VALUE ( r_row ) TYPE i . METHODS column_id RETURNING VALUE ( r_column ) TYPE i . METHODS has_next_row RETURNING VALUE ( r_flag ) TYPE abap_bool . METHODS has_next_column RETURNING VALUE ( r_flag ) TYPE abap_bool . METHODS next_row IMPORTING ! i_row TYPE i DEFAULT 1 . METHODS next_column IMPORTING ! i_column TYPE i DEFAULT 1 . METHODS read_column IMPORTING ! i_column TYPE i EXPORTING ! e_value TYPE data RETURNING VALUE ( r_value ) TYPE string . METHODS read_next_column EXPORTING ! e_value TYPE data RETURNING VALUE ( r_value ) TYPE string . METHODS write_column IMPORTING ! i_value TYPE data ! i_conv TYPE xfeld DEFAULT abap_false ! i_column TYPE i . METHODS write_next_column IMPORTING ! i_value TYPE data ! i_conv TYPE xfeld DEFAULT abap_false . METHODS save IMPORTING ! i_filename TYPE string OPTIONAL . PROTECTED SECTION . PRIVATE SECTION . DATA m_row TYPE i . DATA m_column TYPE i . DATA m_row_last TYPE i . DATA m_column_last TYPE i . ENDCLASS . CLASS zcl_xlsx_io IMPLEMENTATION . METHOD column_id . r_column = m_column . ENDMETHOD . METHOD conv . DATA l_subrc TYPE subrc VALUE 4 . DATA l_value TYPE string . DATA l_convexit TYPE string . DATA l_fm_convexit TYPE rs38l_fnam . \" \u8f6c\u6362\u4f8b\u7a0b\u51fd\u6570 DESCRIBE FIELD output TYPE DATA ( l_type ) EDIT MASK DATA ( l_mask ). \" EDIT MASK\u53d6\u51fa\u6765\u7684\u503c\u5982\uff1a==ALPHA\u3001==MATN1 CLEAR l_convexit . IF convexit IS SUPPLIED . l_convexit = convexit . ELSEIF strlen ( l_mask ) > 2 . l_convexit = l_mask + 2 . ELSEIF l_type = 'N' . \" \u5982\u679c\u662fNUMC\u7c7b\u578b\uff0c\u9ed8\u8ba4ALPHA\u8f6c\u6362 l_convexit = 'ALPHA' . ENDIF . CASE l_type . WHEN 'D' OR 'T' . \" \u65e5\u671f\u65f6\u95f4\u683c\u5f0f l_value = input . REPLACE ALL OCCURRENCES OF REGEX '[^0-9]' IN l_value WITH '' . output = l_value . WHEN OTHERS . \" \u68c0\u67e5\u5b57\u6bb5\u662f\u5426\u6709\u8f93\u51fa\u8f6c\u6362 IF l_convexit IS INITIAL . output = input . ELSE . TRY . \" EDIT MASK\u4e0d\u652f\u6301STRING\uff0c\u8fd8\u662f\u8981\u7528CONVEXIT\u7684\u65b9\u6cd5 l_fm_convexit = | CONVERSION_EXIT_ { l_convexit } _ { dataflow }|. CALL FUNCTION l_fm_convexit EXPORTING input = input IMPORTING output = output EXCEPTIONS OTHERS = 99 . IF sy - subrc <> 0 . output = input . \" \u8f6c\u6362\u9519\u8bef\uff0c\u76f4\u63a5\u8f93\u5165 ENDIF . CATCH cx_root . output = input . ENDTRY . ENDIF . ENDCASE . \" CONDENSE\u5fc5\u987b\u662fCharacter-Like IF l_type = 'C' OR l_type = 'N' OR l_type = 'g' . CONDENSE output . \" \u53bb\u9664\u591a\u4f59\u7a7a\u683c ENDIF . ENDMETHOD . METHOD download_smw0_templete . DATA : ls_wwwdatatab TYPE wwwdatatab , l_rc TYPE sy - subrc , l_defaultfilename TYPE string , ls_wwwdata_tab TYPE wwwdatatab , l_object_name TYPE w3objid , l_filename TYPE string , l_default_file_name TYPE string , l_fullpath TYPE string , l_down_path TYPE localfile , ls_wwwdata TYPE wwwdata , l_path TYPE string . l_default_file_name = i_name . CALL METHOD cl_gui_frontend_services => file_save_dialog EXPORTING window_title = '\u9009\u62e9\u672c\u5730\u6587\u4ef6\u4fdd\u5b58\u8def\u5f84' default_file_name = l_default_file_name default_extension = '*.xlsx' file_filter = 'EXCEL FILES(*.xlsx)|*.xlsx' CHANGING filename = l_filename path = l_path fullpath = l_fullpath EXCEPTIONS cntl_error = 1 error_no_gui = 2 not_supported_by_gui = 3 OTHERS = 5 . IF sy - subrc <> 0 . RETURN . ENDIF . SELECT SINGLE * FROM wwwdata INNER JOIN tadir ON wwwdata~objid = tadir~obj_name INTO CORRESPONDING FIELDS OF ls_wwwdata_tab WHERE wwwdata~srtf2 = 0 AND wwwdata~relid = 'MI' AND tadir~pgmid = 'R3TR' AND tadir~object = 'W3MI' AND tadir~obj_name = i_objid . IF sy - subrc <> 0 . MESSAGE | \u6a21\u677f\u6587\u4ef6[ { i_objid } ]\u4e0d\u5b58\u5728 | TYPE 'S' DISPLAY LIKE 'E' . RETURN . ENDIF . l_down_path = l_fullpath . CALL FUNCTION 'DOWNLOAD_WEB_OBJECT' EXPORTING key = ls_wwwdata_tab destination = l_down_path IMPORTING rc = l_rc . IF sy - subrc = 0 . MESSAGE | \u6a21\u677f\u4e0b\u8f7d\u6210\u529f | TYPE 'S' . ELSE . MESSAGE | \u6a21\u677f\u4e0b\u8f7d\u5931\u8d25 | TYPE 'S' . ENDIF . ENDMETHOD . METHOD export . DATA lo_tabledescr TYPE REF TO cl_abap_tabledescr . DATA lo_structdescr TYPE REF TO cl_abap_structdescr . lo_tabledescr ?= cl_abap_typedescr => describe_by_data ( it_data ). lo_structdescr ?= lo_tabledescr -> get_table_line_type ( ). \" \u83b7\u53d6\u5185\u8868\u4fe1\u606f DATA ( lt_component ) = lo_structdescr -> get_components ( ). \" \u6df1\u5ea6\u7ed3\u6784\u5904\u7406\u592a\u9ebb\u70e6\uff0c\u4e0d\u8003\u8651\u4e86\uff0c\u6709\u9700\u8981\u53ef\u4ee5\u81ea\u5df1\u8c03\u6574 DELETE lt_component WHERE type IS NOT INSTANCE OF cl_abap_elemdescr . IF lt_component IS INITIAL . MESSAGE '\u5bfc\u51fa\u5931\u8d25' TYPE 'S' DISPLAY LIKE 'E' . RETURN . ENDIF . DATA ( lo_writer ) = zcl_xlsx_io => get_instance ( ). lo_writer -> start ( ). \" \u51c6\u5907\u5199\u5165 \" \u5199\u5165\u62ac\u5934\u6587\u672c\u884c lo_writer -> next_row ( ). LOOP AT lt_component INTO DATA ( ls_component ). lo_writer -> write_next_column ( ls_component - name ). ENDLOOP . \" \u5199\u5165\u6570\u636e\u884c LOOP AT it_data ASSIGNING FIELD - SYMBOL ( <ls_data> ). lo_writer -> next_row ( ). LOOP AT lt_component INTO ls_component . FIELD-SYMBOLS <fs_field> TYPE any . ASSIGN COMPONENT ls_component - name OF STRUCTURE <ls_data> TO <fs_field> . IF <fs_field> IS ASSIGNED . lo_writer -> write_next_column ( <fs_field> ). UNASSIGN <fs_field> . ELSE . lo_writer -> next_column ( ). ENDIF . ENDLOOP . ENDLOOP . \" \u5bfc\u51fa\u5230\u672c\u5730 lo_writer -> save ( i_filename = i_filename ). ENDMETHOD . METHOD get_instance . ro_instance = NEW # ( ). TRY . ro_instance -> mo_xlsx = cl_ehfnd_xlsx => get_instance ( ). IF i_buffer IS SUPPLIED . ro_instance -> mo_doc = ro_instance -> mo_xlsx -> load_doc ( iv_file_data = i_buffer ). ELSE . ro_instance -> mo_doc = ro_instance -> mo_xlsx -> create_doc ( ). ENDIF . DATA ( lt_sheet_info ) = ro_instance -> mo_doc -> get_sheets ( ). ro_instance -> mo_sheet = ro_instance -> mo_doc -> get_sheet_by_id ( lt_sheet_info [ 1 ] - sheet_id ). CATCH cx_openxml_format cx_openxml_not_found cx_openxml_not_allowed . CLEAR ro_instance . ENDTRY . ENDMETHOD . METHOD get_local_file . DATA l_filename TYPE string . IF i_filename IS NOT INITIAL . l_filename = i_filename . ELSE . l_filename = cl_openxml_helper => browse_local_file_open ( iv_title = 'Choose' iv_filename = 'Import.xlsx' iv_extpattern = '*.xlsx|*.xlsx' ). ENDIF . CHECK l_filename IS NOT INITIAL . TRY . r_buffer = cl_openxml_helper => load_local_file ( l_filename ). CATCH cx_openxml_not_found . CLEAR r_buffer . ENDTRY . ENDMETHOD . METHOD get_reader . DATA ( l_buffer ) = zcl_xlsx_io => get_local_file ( i_filename ). ro_instance = zcl_xlsx_io => get_instance ( i_buffer = l_buffer ). ENDMETHOD . METHOD get_smw0_templete . DATA : lt_mime TYPE STANDARD TABLE OF w3mime , ls_id TYPE wwwdataid , ls_key TYPE wwwdatatab . ls_key - relid = 'MI' . ls_key - objid = i_objid . CALL FUNCTION 'WWWDATA_IMPORT' EXPORTING key = ls_key TABLES mime = lt_mime EXCEPTIONS wrong_object_type = 1 import_error = 2 OTHERS = 3 . IF sy - subrc <> 0 . MESSAGE | \u6a21\u677f[ { i_objid } ]\u83b7\u53d6\u5931\u8d25 | TYPE 'S' DISPLAY LIKE 'E' . RETURN . ENDIF . SELECT SINGLE value FROM wwwparams WHERE relid = @ ls_key - relid AND objid = @ ls_key - objid AND name EQ 'filesize' INTO @ DATA ( l_param ). DATA l_length TYPE i . l_length = l_param . CALL FUNCTION 'SCMS_BINARY_TO_XSTRING' EXPORTING input_length = l_length IMPORTING buffer = r_buffer TABLES binary_tab = lt_mime EXCEPTIONS failed = 1 OTHERS = 2 . IF sy - subrc <> 0 . CLEAR r_buffer . ENDIF . ENDMETHOD . METHOD get_writer . ro_instance = get_instance ( ). ENDMETHOD . METHOD has_next_column . r_flag = xsdbool ( m_column_last > m_column ). ENDMETHOD . METHOD has_next_row . r_flag = xsdbool ( m_row_last > m_row ). ENDMETHOD . METHOD import . DATA lr_data TYPE REF TO data . FIELD-SYMBOLS <fs_data> TYPE any . FIELD-SYMBOLS <fs_field> TYPE any . \" \u6784\u9020\u5de5\u4f5c\u533a CREATE DATA lr_data LIKE LINE OF ct_data[] . ASSIGN lr_data->* TO <fs_data> . CHECK <fs_data> IS ASSIGNED . DATA ( l_buffer ) = get_local_file ( i_filename = i_filename ). CHECK l_buffer IS NOT INITIAL . DATA ( lo_reader ) = zcl_xlsx_io => get_instance ( i_buffer = l_buffer ). CHECK lo_reader IS NOT INITIAL . \" \u51c6\u5907\u8bfb\u53d6 lo_reader -> start ( ). \" \u8df3\u8fc7\u62ac\u5934\u884c DO i_skip_row TIMES . lo_reader -> next_row ( ). ENDDO . \" \u8bfb\u53d6\u6570\u636e\u884c WHILE lo_reader -> has_next_row ( ) = abap_true . lo_reader -> next_row ( ). CLEAR <fs_data> . DO . ASSIGN COMPONENT sy - index OF STRUCTURE <fs_data> TO <fs_field> . IF <fs_field> IS ASSIGNED . <fs_field> = lo_reader -> read_next_column ( ). UNASSIGN <fs_field> . ELSE . EXIT . ENDIF . ENDDO . INSERT <fs_data> INTO TABLE ct_data . ENDWHILE . ENDMETHOD . METHOD next_column . m_column = m_column + i_column . ENDMETHOD . METHOD next_row . m_row = m_row + i_row . CLEAR m_column . m_column_last = mo_sheet -> get_last_column_number_in_row ( m_row ). ENDMETHOD . METHOD read_column . r_value = mo_sheet -> get_cell_content ( iv_row = m_row iv_column = i_column ). IF e_value IS SUPPLIED . me -> conv ( EXPORTING dataflow = 'INPUT' input = r_value IMPORTING output = e_value ). ENDIF . ENDMETHOD . METHOD read_next_column . next_column ( ). r_value = read_column ( m_column ). IF e_value IS SUPPLIED . me -> conv ( EXPORTING dataflow = 'INPUT' input = r_value IMPORTING output = e_value ). ENDIF . ENDMETHOD . METHOD row_id . r_row = m_row . ENDMETHOD . METHOD save . DATA l_filename TYPE string . IF i_filename IS NOT INITIAL . l_filename = i_filename . ELSE . l_filename = cl_openxml_helper => browse_local_file_save ( iv_title = 'Save as' iv_filename = 'Export.xlsx' iv_extpattern = '*.xlsx|*.xlsx' ). ENDIF . CHECK l_filename IS NOT INITIAL . TRY . cl_openxml_helper => store_local_file ( im_file_name = l_filename im_data = mo_doc -> save ( ) ). CATCH cx_openxml_format cx_openxml_not_found cx_openxml_not_allowed cx_dynamic_check INTO DATA ( lx_openxml ). MESSAGE lx_openxml -> get_longtext ( ) TYPE 'S' DISPLAY LIKE 'E' . ENDTRY . ENDMETHOD . METHOD start . m_row_last = mo_sheet -> get_last_row_number ( ). m_row = i_row . m_column = i_column . ENDMETHOD . METHOD stop . m_row = m_row_last . IF m_row > 0 . m_column_last = mo_sheet -> get_last_column_number_in_row ( m_row ). m_column = m_column_last . ENDIF . ENDMETHOD . METHOD write_column . DATA l_value TYPE string . IF i_conv = abap_true . me -> conv ( EXPORTING dataflow = 'OUTPUT' input = i_value IMPORTING output = l_value ). ELSE . l_value = i_value . ENDIF . mo_sheet -> set_cell_content ( iv_row = m_row iv_column = i_column iv_value = l_value ). ENDMETHOD . METHOD write_next_column . next_column ( ). write_column ( i_column = m_column i_conv = i_conv i_value = i_value ). ENDMETHOD . METHOD replace_sharedstrings . \" \u7a0b\u5e8f\u8981\u6c42IT_REPLACE\u81f3\u5c11\u4e24\u5217\uff0c\u4ee3\u7801\u4f1a\u5c06\u5de6\u5217\u5185\u5bb9\u66ff\u6362\u4e3a\u53f3\u5217\u5185\u5bb9 CHECK it_replace IS NOT INITIAL . CHECK c_doc IS NOT INITIAL . FIELD-SYMBOLS <fs_replace_t> TYPE ANY TABLE . FIELD-SYMBOLS <fs_replace> TYPE any . FIELD-SYMBOLS <fs_from> TYPE any . FIELD-SYMBOLS <fs_to> TYPE any . TRY . DATA ( lo_doc ) = cl_xlsx_document => load_document ( c_doc ). DATA ( lo_workbook_part ) = lo_doc -> get_workbookpart ( ). DATA ( lo_sharedstrings_part ) = lo_workbook_part -> get_sharedstringspart ( ). DATA ( l_sharedstrings_xml ) = lo_sharedstrings_part -> get_data ( ). DATA ( l_sharedstrings_str ) = cl_openxml_helper => xstring_to_string ( l_sharedstrings_xml ). ASSIGN it_replace TO <fs_replace_t> . LOOP AT <fs_replace_t> ASSIGNING <fs_replace> . ASSIGN COMPONENT 1 OF STRUCTURE <fs_replace> TO <fs_from> . ASSIGN COMPONENT 2 OF STRUCTURE <fs_replace> TO <fs_to> . IF <fs_from> IS ASSIGNED AND <fs_to> IS ASSIGNED . IF <fs_from> IS NOT INITIAL . REPLACE ALL OCCURRENCES OF <fs_from> IN l_sharedstrings_str WITH <fs_to> IN CHARACTER MODE . ENDIF . ENDIF . UNASSIGN <fs_from> . UNASSIGN <fs_to> . ENDLOOP . l_sharedstrings_xml = cl_openxml_helper => string_to_xstring ( l_sharedstrings_str ). lo_sharedstrings_part -> feed_data ( l_sharedstrings_xml ). c_doc = lo_doc -> get_package_data ( ). CATCH cx_openxml_not_found cx_openxml_format cx_openxml_not_allowed INTO DATA ( lx_openxml ). MESSAGE lx_openxml -> get_text ( ) TYPE 'S' DISPLAY LIKE 'E' . CATCH cx_root INTO DATA ( lx_root ). MESSAGE lx_root -> get_text ( ) TYPE 'S' DISPLAY LIKE 'E' . ENDTRY . ENDMETHOD . ENDCLASS . \u793a\u4f8b\u4ee3\u7801 TYPES : BEGIN OF ty_data , field1 TYPE string , field2 TYPE string , END OF ty_data . DATA lt_data TYPE STANDARD TABLE OF ty_data . lt_data = VALUE # ( ( field1 = 'A1' field2 = 'B1' ) ( field1 = 'A2' field2 = 'B2' ) ). \" \u5bfc\u51fa zcl_xlsx_io => export ( lt_data ). \" \u5bfc\u5165 CLEAR lt_data . zcl_xlsx_io => import ( CHANGING ct_data = lt_data ).","title":"\u5c01\u88c5\u7b80\u5316"},{"location":"others/xlsx_io/#_2","text":"\u5bf9\u4e8e\u56fa\u5b9a\u6a21\u677f\u6587\u4ef6\uff0c\u4e0d\u59a8\u76f4\u63a5\u66ff\u6362\u91cc\u9762\u7684\u6587\u672c\u5185\u5bb9 \u793a\u4f8b\u4ee3\u7801 DATA ( l_buffer ) = zcl_xlsx_io => get_smw0_templete ( CONV # ( sy - tcode ) ). \" \u83b7\u53d6SMW0\u6a21\u677f\u6587\u4ef6 TRY . DATA ( lo_doc ) = cl_xlsx_document => load_document ( l_buffer ). DATA ( lo_workbook_part ) = lo_doc -> get_workbookpart ( ). DATA ( lo_sharedstrings_part ) = lo_workbook_part -> get_sharedstringspart ( ). \" \u76f4\u63a5\u66ff\u6362\u5373\u53ef \" \u4e5f\u8bd5\u8fc7\u89e3\u6790XML\u6587\u4ef6\uff0c\u4f46\u5bcc\u6587\u672c\u683c\u5f0f\u96be\u4ee5\u5904\u7406 DATA ( l_sharedstrings_xml ) = lo_sharedstrings_part -> get_data ( ). LOOP AT lt_replace INTO DATA ( ls_replace ). DATA ( l_from ) = cl_openxml_helper => string_to_xstring ( ls_replace - from ). IF l_from IS NOT INITIAL . DATA ( l_to ) = cl_openxml_helper => string_to_xstring ( ls_replace - to ). REPLACE ALL OCCURRENCES OF l_from IN l_sharedstrings_xml WITH l_to IN BYTE MODE . ENDIF . CLEAR l_from . CLEAR l_to . ENDLOOP . lo_sharedstrings_part -> feed_data ( l_sharedstrings_xml ). \" \u56de\u5199 l_buffer = lo_doc -> get_package_data ( ). \" \u83b7\u53d6\u66ff\u6362\u540e\u7684\u6587\u4ef6 CATCH cx_openxml_not_found cx_openxml_format cx_openxml_not_allowed INTO DATA ( lx_openxml ). MESSAGE lx_openxml -> get_text ( ) TYPE 'S' DISPLAY LIKE 'E' . ENDTRY .","title":"\u6587\u672c\u66ff\u6362"},{"location":"others/xlsx_io/#abap2xlsx","text":"\u7b2c\u4e09\u65b9\u5de5\u5177\uff0c\u901a\u8fc7\u89e3\u6790XLSX\u4e2d\u7684XML\u6587\u4ef6\uff0c\u5b9e\u73b0\u9ad8\u901f\u8bfb\u53d6\u6570\u636e\u3002\u76f8\u6bd4CL_EHFND_XLSX\uff0c\u63d0\u4f9b\u4e86\u66f4\u9f50\u5168\u7684\u6837\u5f0f\u8bbe\u7f6e\u3002 https://github.com/abap2xlsx/abap2xlsx/releases","title":"ABAP2XLSX"},{"location":"others/xlsx_io/#xlsx-workbanch","text":"\u7b2c\u4e09\u65b9\u5de5\u5177\uff0c\u7c7b\u4f3cSMARTFORMS\uff0c\u9884\u5148\u8bbe\u7f6e\u597dEXCEL\u6a21\u677f\u4e0e\u8f93\u5165\u53c2\u6570\uff0c\u968f\u540e\u53ef\u5728\u7a0b\u5e8f\u4e2d\u76f4\u63a5\u8c03\u7528\u83b7\u53d6\uff0c\u9002\u5408\u5bfc\u51fa\u7279\u5b9a\u683c\u5f0f\u7684\u9700\u6c42\u3002","title":"XLSX WORKBANCH"},{"location":"others/xlsx_io/#text_convert_xls_to_sap","text":"\u8be5\u65b9\u6cd5\u53ef\u5c06EXCEL\u5185\u5bb9\u76f4\u63a5\u6620\u5c04\u5230ABAP\u5185\u8868\u4e2d\u3002 \u793a\u4f8b\u4ee3\u7801 TYPES : BEGIN OF ty_data , field1 TYPE string , field2 TYPE string , END OF ty_data . TYPES tt_data TYPE STANDARD TABLE OF ty_data . DATA lt_data TYPE tt_data . DATA lt_raw TYPE truxs_t_text_data . CALL FUNCTION 'TEXT_CONVERT_XLS_TO_SAP' EXPORTING i_line_header = abap_false i_tab_raw_data = lt_raw i_filename = 'C:\\import.xls' TABLES i_tab_converted_data = lt_data EXCEPTIONS conversion_failed = 1 OTHERS = 2 .","title":"TEXT_CONVERT_XLS_TO_SAP"},{"location":"others/xlsx_io/#alsm_excel_to_internal_table","text":"\u8be5\u65b9\u6cd5\u53ef\u83b7\u53d6EXCEL\u5355\u5143\u683c\u5185\u5bb9\uff0c\u5904\u7406\u7075\u6d3b\u3002 \u793a\u4f8b\u4ee3\u7801 TYPES : BEGIN OF ty_data , field1 TYPE string , field2 TYPE string , END OF ty_data . TYPES tt_data TYPE STANDARD TABLE OF ty_data . DATA lt_data TYPE tt_data . DATA ls_data TYPE ty_data . DATA lt_intern TYPE STANDARD TABLE OF alsmex_tabline . DATA ls_intern TYPE alsmex_tabline . CALL FUNCTION 'ALSM_EXCEL_TO_INTERNAL_TABLE' EXPORTING filename = 'C:\\import.xls' i_begin_col = 1 i_begin_row = 2 \" \u8df3\u8fc7\u9996\u884c i_end_col = 2 i_end_row = 9999 TABLES intern = lt_intern EXCEPTIONS inconsistent_parameters = 1 upload_ole = 2 OTHERS = 3 . SORT lt_intern BY row col . LOOP AT lt_intern INTO ls_intern . AT NEW row . CLEAR ls_data . ENDAT . CASE ls_intern - col . WHEN '0001' . ls_data - field1 = ls_intern - value . WHEN '0002' . ls_data - field2 = ls_intern - value . WHEN OTHERS . ENDCASE . AT END OF row . INSERT ls_data INTO TABLE lt_data . ENDAT . ENDLOOP .","title":"ALSM_EXCEL_TO_INTERNAL_TABLE"},{"location":"others/xlsx_io/#ole","text":"\u4e0a\u53e4\u5de5\u5177\uff0c\u5efa\u8bae\u653e\u5f03","title":"OLE"},{"location":"others/xlsx_io/#doi","text":"\u6ca1\u7528\u8fc7\uff0c\u4e0d\u61c2","title":"DOI"},{"location":"others/zcl_text/","text":"\u6587\u672c\u53d6\u503c\u5de5\u5177 \u00b6 \u62a5\u8868\u90e8\u5206\u5b57\u6bb5\u9700\u8981\u53d6\u6587\u672c\uff0c\u8fd9\u91cc\u5c06\u9891\u7387\u8f83\u9ad8\u7684\u5b57\u6bb5\u6574\u7406\u51fa\u6765\uff0c\u4ee5\u540e\u5c31\u4e0d\u7528\u91cd\u590d\u5199SQL\u67e5\u8868\u4e86\u3002 ECC\u914c\u60c5\u4f7f\u7528\uff0c\u7a0b\u5e8f\u6bcf\u6b21\u53d6\u503c\u5c31\u901a\u8fc7[SELECT SINGLE]\u8bbf\u95ee\u6570\u636e\u5e93\uff0c\u6027\u80fd\u8fdc\u4e0d\u5982\u76f4\u63a5\u6279\u91cf\u67e5\u8be2\u3002 HANA\u6027\u80fd\u6709\u5de8\u5927\u63d0\u5347\uff0c\u53ef\u4ee5\u5ffd\u7565\u8fd9\u90e8\u5206\u635f\u5931 ZCL_TEXT \"! <p class=\"shorttext synchronized\">\u6587\u672c\u53d6\u503c\u5de5\u5177</p> class ZCL_TEXT definition public final create private . public section . \"! <p class=\"shorttext synchronized\">\u6587\u672c\u5de5\u5177\u7c7b</p> constants MC_CLASS_NAME type SEOCLSNAME value 'ZCL_TEXT' ##NO_TEXT . \"! <p class=\"shorttext synchronized\">\u7a7a\u503c</p> constants MC_NONE type STRING value SPACE ##NO_TEXT . \"! <p class=\"shorttext synchronized\">\u81ea\u5b9a\u4e49\u65b9\u6cd5\u524d\u7f00</p> constants MC_CUSTOM_METHOD_PREFIX type STRING value '_' ##NO_TEXT . \"! <p class=\"shorttext synchronized\">\u52a8\u6001SQL\u67e5\u8be2\u65b9\u6cd5\u540d</p> constants MC_METHOD_DYNAMIC_QUERY type ABAP_METHNAME value 'DYNAMIC_QUERY' ##NO_TEXT . \"! <p class=\"shorttext synchronized\">\u6709\u6548\u7684\u7a7a\u5bf9\u8c61\uff0c\u9632\u6b62\u7a0b\u5e8f\u8fd0\u884c\u9519\u8bef</p> class-data NOT_FOUND type ref to ZCL_TEXT read - only . class-methods CLASS_CONSTRUCTOR . \"! <p class=\"shorttext synchronized\">\u8bbe\u7f6e\u53d6\u6587\u672c\u65f6\u6240\u7528\u8bed\u8a00</p> class-methods SET_LANGUAGE importing ! I_LANGU type SY - LANGU . \"! <p class=\"shorttext synchronized\">\u521b\u5efa\u81ea\u5b9a\u4e49\u5bf9\u8c61</p> class-methods CREATE_CUSTOM importing ! I_NAME type STRING returning value ( RO_TEXT ) type ref to ZCL_TEXT . \"! <p class=\"shorttext synchronized\">\u521b\u5efa\u52a8\u6001SQL\u5bf9\u8c61</p> class-methods CREATE_QUERY importing ! I_NAME type STRING ! I_TABNAME type TABNAME optional ! I_SPRAS type FIELDNAME optional ! I_KEY type FIELDNAME optional ! I_TEXT type FIELDNAME optional returning value ( RO_TEXT ) type ref to ZCL_TEXT . \"! <p class=\"shorttext synchronized\">\u521b\u5efa\u57df\u503c\u5bf9\u8c61</p> class-methods CREATE_DOMAIN importing ! I_DOMNAME type STRING returning value ( RO_TEXT ) type ref to ZCL_TEXT . \"! <p class=\"shorttext synchronized\">\u521b\u5efa\u7279\u5f81\u503c\u5bf9\u8c61</p> class-methods CREATE_OBJCL importing ! I_OBJECTKEY type BAPI1003_KEY - OBJECT ! I_OBJECTTABLE type BAPI1003_KEY - OBJECTTABLE optional ! I_CLASSNUM type BAPI1003_KEY - CLASSNUM optional ! I_CLASSTYPE type BAPI1003_KEY - CLASSTYPE optional ! I_AUTO_COMPLETE type XFELD default ABAP_TRUE returning value ( RO_TEXT ) type ref to ZCL_TEXT . \"! <p class=\"shorttext synchronized\">\u957f\u6587\u672c\u8bfb\u53d6</p> class-methods LONG_TEXT importing ! I_ID type THEAD - TDID ! I_LANGUAGE type THEAD - TDSPRAS default SY - LANGU ! I_NAME type THEAD - TDNAME ! I_OBJECT type THEAD - TDOBJECT exporting ! ET_TLINE type TLINETAB ! E_VALUE type STRING returning value ( R_VALUE ) type STRING . \"! <p class=\"shorttext synchronized\">\u6839\u636e\u4f20\u5165\u503c\u81ea\u52a8\u83b7\u53d6\u6587\u672c\uff08\u8981\u6c42\u5b57\u6bb5\u5b58\u5728\u503c\u8868\u548c\u6587\u672c\u8868\uff0c\u5426\u5219\u4f1a\u5931\u8d25\uff09</p> class-methods AUTO importing ! I_KEY type DATA returning value ( R_VALUE ) type STRING . \"! <p class=\"shorttext synchronized\">\u83b7\u53d6\u6587\u672c</p> methods GET importing ! I_KEY type DATA returning value ( R_VALUE ) type STRING . PROTECTED SECTION . private section . types : BEGIN OF ty_text , key TYPE string , value TYPE string , END OF ty_text . types : tt_text TYPE SORTED TABLE OF ty_text WITH NON-UNIQUE KEY key . types : BEGIN OF ty_instance , name TYPE string , o_text TYPE REF TO ZCL_TEXT , END OF ty_instance . types : tt_instance TYPE SORTED TABLE OF ty_instance WITH NON-UNIQUE KEY name . types : BEGIN OF ty_objcl_instance , objectkey TYPE bapi1003_key - object_long , objecttable TYPE bapi1003_key - objecttable , classnum TYPE bapi1003_key - classnum , classtype TYPE bapi1003_key - classtype , o_text TYPE REF TO ZCL_TEXT , END OF ty_objcl_instance . types : tt_objcl_instance TYPE SORTED TABLE OF ty_objcl_instance WITH NON-UNIQUE KEY objectkey objecttable classnum classtype . types : BEGIN OF ty_custom_query , name TYPE string , tabname TYPE tabname , spras TYPE fieldname , key TYPE fieldname , text TYPE fieldname , END OF ty_custom_query . types : tt_custom_query TYPE SORTED TABLE OF ty_custom_query WITH NON-UNIQUE KEY name . \"! <p class=\"shorttext synchronized\">AUTO\u5bf9\u8c61\u7f13\u5b58</p> class-data MT_AUTO type TT_INSTANCE . \"! <p class=\"shorttext synchronized\">\u81ea\u5b9a\u4e49\u5bf9\u8c61\u7f13\u5b58</p> class-data MT_CUSTOM type TT_INSTANCE . \"! <p class=\"shorttext synchronized\">\u57df\u503c\u5bf9\u8c61\u7f13\u5b58</p> class-data MT_DOMAIN type TT_INSTANCE . \"! <p class=\"shorttext synchronized\">\u52a8\u6001SQL\u5bf9\u8c61\u7f13\u5b58</p> class-data MT_QUERY type TT_INSTANCE . \"! <p class=\"shorttext synchronized\">\u7279\u5f81\u503c\u5bf9\u8c61\u7f13\u5b58</p> class-data MT_OBJCL type TT_OBJCL_INSTANCE . \"! <p class=\"shorttext synchronized\">\u81ea\u5b9a\u4e49\u52a8\u6001\u67e5\u8be2\u53c2\u6570</p> class-data MT_CUSTOM_QUERY type TT_CUSTOM_QUERY . \"! <p class=\"shorttext synchronized\">\u6587\u672c\u5de5\u5177\u7c7b\u63cf\u8ff0\u5bf9\u8c61</p> class-data MO_OBJECTDESCR type ref to CL_ABAP_OBJECTDESCR . \"! <p class=\"shorttext synchronized\">\u5bf9\u8c61\u540d\u79f0</p> data M_NAME type STRING . \"! <p class=\"shorttext synchronized\">\u53d6\u503c\u7f13\u5b58\u6e05\u5355</p> data MT_TEXT type TT_TEXT . \"! <p class=\"shorttext synchronized\">\u81ea\u5b9a\u4e49\u5904\u7406\u65b9\u6cd5</p> data M_CUSTOM_METHOD type ABAP_METHNAME . data : \"! <p class=\"shorttext synchronized\">\u52a8\u6001SQL\u53c2\u6570</p> BEGIN OF ms_param , table TYPE tabname , spras TYPE fieldname , key TYPE fieldname , text TYPE fieldname , END OF ms_param . \"! <p class=\"shorttext synchronized\">\u81ea\u5b9a\u4e49\u52a8\u6001\u67e5\u8be2\u53c2\u6570</p> class-methods CREATE_CUSTOM_QUERY . \"! <p class=\"shorttext synchronized\">CONSTRUCTOR</p> methods CONSTRUCTOR importing ! I_NAME type STRING . \"! <p class=\"shorttext synchronized\">\u52a8\u6001SQL\u67e5\u8be2</p> methods DYNAMIC_QUERY importing ! I_KEY type DATA returning value ( R_VALUE ) type STRING . \"! <p class=\"shorttext synchronized\">\u83b7\u53d6\u7528\u6237\u540d\u79f0</p> methods _SYST_UNAME importing ! I_KEY type DATA returning value ( R_VALUE ) type STRING . ENDCLASS . CLASS ZCL_TEXT IMPLEMENTATION . METHOD auto . \" \u83b7\u53d6\u5b57\u6bb5\u63cf\u8ff0 DATA ( lo_typedescr ) = cl_abap_typedescr => describe_by_data ( i_key ). IF lo_typedescr -> kind <> cl_abap_typedescr => kind_elem . \" \u53ea\u5bf9\u6570\u636e\u5143\u7d20\u8fdb\u884c\u5904\u7406 RETURN . ENDIF . \" \u83b7\u53d6\u5b57\u6bb5\u7c7b\u578b\u540d\u79f0 DATA l_rollname TYPE string . l_rollname = CAST cl_abap_elemdescr ( lo_typedescr ) -> get_ddic_field ( ) - rollname . IF l_rollname IS INITIAL . RETURN . ENDIF . \" \u7f13\u5b58\u68c0\u67e5 READ TABLE mt_auto REFERENCE INTO DATA ( lr_auto ) WITH KEY name = l_rollname BINARY SEARCH . IF sy - subrc = 0 . r_value = lr_auto -> o_text -> get ( i_key ). RETURN . ELSE . INSERT VALUE # ( name = l_rollname o_text = not_found ) INTO TABLE mt_auto REFERENCE INTO lr_auto . ENDIF . \" \u68c0\u67e5\u662f\u5426\u5b58\u5728\u81ea\u5b9a\u4e49\u5904\u7406\u65b9\u6cd5 lr_auto -> o_text = create_custom ( l_rollname ). IF lr_auto -> o_text <> not_found . r_value = lr_auto -> o_text -> get ( i_key ). RETURN . ENDIF . \" \u83b7\u53d6\u6570\u636e\u5143\u7d20\u5bf9\u5e94\u57df\u548c\u503c\u8868 SELECT SINGLE rollname , domname , entitytab FROM dd04l WHERE rollname = @ l_rollname INTO @ DATA ( ls_dd04l ). IF sy - subrc <> 0 . RETURN . ENDIF . \" \u68c0\u67e5\u662f\u5426\u5b58\u5728\u57df\u503c lr_auto -> o_text = create_domain ( CONV # ( ls_dd04l - domname ) ). IF lr_auto -> o_text <> not_found . r_value = lr_auto -> o_text -> get ( i_key ). RETURN . ENDIF . \" \u68c0\u67e5\u662f\u5426\u5b58\u5728\u503c\u8868 IF ls_dd04l - entitytab IS INITIAL . RETURN . ENDIF . \" \u83b7\u53d6\u503c\u8868\u5bf9\u5e94\u6587\u672c\u8868 SELECT SINGLE tabname FROM dd08l WHERE checktable = @ ls_dd04l - entitytab AND frkart = 'TEXT' INTO @ DATA ( l_texttab ). IF sy - subrc <> 0 . RETURN . ENDIF . \" \u83b7\u53d6\u503c\u8868\u7ed3\u6784 SELECT position , fieldname , keyflag , rollname FROM dd03l WHERE tabname = @ l_texttab INTO TABLE @ DATA ( lt_field ). IF sy - subrc <> 0 . RETURN . ENDIF . \" \u83b7\u53d6\u52a8\u6001SQL\u67e5\u8be2\u6240\u9700\u53c2\u6570 DATA l_field_spras TYPE fieldname . DATA l_field_key TYPE fieldname . DATA l_field_text TYPE fieldname . SORT lt_field BY position . LOOP AT lt_field INTO DATA ( ls_field ). IF ls_field - keyflag = 'X' . \" \u83b7\u53d6\u5173\u952e\u5b57\u6bb5\u4e2d\u7684\u952e\u503c\u5b57\u6bb5 IF ls_field - rollname = l_rollname . l_field_key = ls_field - fieldname . ENDIF . \" \u83b7\u53d6\u5173\u952e\u5b57\u6bb5\u4e2d\u7684\u8bed\u8a00\u5b57\u6bb5 IF ls_field - rollname = 'SPRAS' . l_field_spras = ls_field - fieldname . ENDIF . ELSE . \" \u83b7\u53d6\u975e\u952e\u503c\u7684\u7b2c\u4e00\u4e2a\u5b57\u6bb5\u4f5c\u4e3a\u6587\u672c\u5b57\u6bb5 l_field_text = ls_field - fieldname . ENDIF . ENDLOOP . IF l_field_key IS INITIAL OR l_field_text IS INITIAL . RETURN . ENDIF . \" \u521b\u5efa\u52a8\u6001\u67e5\u8be2 lr_auto -> o_text = create_query ( i_name = l_rollname i_tabname = l_texttab i_spras = l_field_spras i_key = l_field_key i_text = l_field_text ). r_value = lr_auto -> o_text -> get ( i_key ). \" \u8fd4\u56de\u67e5\u8be2\u7ed3\u679c ENDMETHOD . METHOD class_constructor . \" \u5206\u6790\u81ea\u8eab\uff0c\u83b7\u53d6\u53ef\u4ee5\u63d0\u4f9b\u7684\u7279\u6b8a\u6587\u672c\u5904\u7406\u65b9\u6cd5 mo_objectdescr ?= cl_abap_typedescr => describe_by_name ( mc_class_name ). \" \u521b\u5efa\u6709\u6548\u7684\u7a7a\u503c\u5bf9\u8c61\uff0c\u9632\u6b62\u7a0b\u5e8f\u8fd0\u884c\u9519\u8bef not_found = NEW # ( mc_none ). ENDMETHOD . METHOD constructor . m_name = i_name . ENDMETHOD . METHOD create_custom . READ TABLE mt_custom REFERENCE INTO DATA ( lr_custom ) WITH KEY name = i_name BINARY SEARCH . IF sy - subrc <> 0 . INSERT VALUE # ( name = i_name ) INTO TABLE mt_custom REFERENCE INTO lr_custom . \" \u7ea6\u5b9a\u81ea\u5b9a\u4e49\u5904\u7406\u65b9\u6cd5\u4e3a\u3010\u524d\u7f00+\u540d\u79f0\u3011\uff0c\u5916\u90e8\u8c03\u7528\u65f6\uff0c\u4f20\u5165\u540d\u79f0\u5373\u53ef DATA l_method TYPE abap_methname . l_method = |{ mc_custom_method_prefix }{ i_name CASE = UPPER }|. READ TABLE mo_objectdescr -> methods TRANSPORTING NO FIELDS WITH KEY name = l_method BINARY SEARCH . IF sy - subrc = 0 . lr_custom -> o_text = NEW # ( i_name ). lr_custom -> o_text -> m_custom_method = l_method . ELSE . \" \u7b2c\u4e00\u6b21\u8c03\u7528\u5148\u83b7\u53d6\u914d\u7f6e\u6570\u636e IF mt_custom_query IS INITIAL . create_custom_query ( ). ENDIF . \" \u68c0\u67e5\u914d\u7f6e\u662f\u5426\u6709\u5b9a\u4e49\u67e5\u8be2 READ TABLE mt_custom_query REFERENCE INTO DATA ( lr_custom_query ) WITH KEY name = i_name BINARY SEARCH . IF sy - subrc = 0 . lr_custom -> o_text = create_query ( i_name = lr_custom_query -> name i_tabname = lr_custom_query -> tabname i_spras = lr_custom_query -> spras i_key = lr_custom_query -> key i_text = lr_custom_query -> text ). ELSE . \" \u90fd\u6ca1\u6709\uff0c\u8fd4\u56de\u67e5\u8be2\u5931\u8d25 lr_custom -> o_text = not_found . ENDIF . ENDIF . ENDIF . ro_text = lr_custom -> o_text . ENDMETHOD . METHOD create_custom_query . \" \u53ef\u4ee5\u5f04\u914d\u7f6e\u8868\uff0c\u6211\u8fd9\u8fb9\u4e3a\u4e86\u65b9\u4fbf\u8fc1\u79fb\uff0c\u76f4\u63a5\u5199\u6b7b mt_custom_query = VALUE # ( ( name = 'BUKRS' tabname = 'T001' key = 'BUKRS' text = 'BUTXT' ) \" \u516c\u53f8 ( name = 'MATNR' tabname = 'MAKT' key = 'MATNR' text = 'MAKTX' spras = 'SPRAS' ) \" \u7269\u6599 ( name = 'MATKL' tabname = 'T023T' key = 'MATKL' text = 'WGBEZ' spras = 'SPRAS' ) \" \u7269\u6599\u7ec4 ( name = 'PARTNER' tabname = 'BUT000' key = 'PARTNER' text = 'CONCAT( NAME_ORG1, NAME_ORG2 )' ) \" \u4e1a\u52a1\u4f19\u4f34 ( name = 'KUNNR' tabname = 'KNA1' key = 'KUNNR' text = 'CONCAT( NAME1, NAME2 )' ) \" \u4e1a\u52a1\u4f19\u4f34 ( name = 'LIFNR' tabname = 'LFA1' key = 'LIFNR' text = 'CONCAT( NAME1, NAME2 )' ) \" \u4f9b\u5e94\u5546 ( name = 'WERKS' tabname = 'T001W' key = 'WERKS' text = 'NAME1' ) \" \u5de5\u5382 ( name = 'LGORT' tabname = 'T001L' key = 'LGORT' text = 'LGOBE' ) \" \u5e93\u4f4d ( name = 'PRCTR' tabname = 'CEPCT' key = 'PRCTR' text = 'LTEXT' spras = 'SPRAS' ) \" \u5229\u6da6\u4e2d\u5fc3 ( name = 'WAERS' tabname = 'TCURT' key = 'WAERS' text = 'LTEXT' spras = 'SPRAS' ) \" \u8d27\u5e01 ). ENDMETHOD . METHOD create_domain . READ TABLE mt_domain REFERENCE INTO DATA ( lr_domain ) WITH KEY name = i_domname BINARY SEARCH . IF sy - subrc <> 0 . INSERT VALUE # ( name = i_domname ) INTO TABLE mt_domain REFERENCE INTO lr_domain . DATA lt_text TYPE tt_text . SELECT domvalue_l AS key , ddtext AS value FROM dd07t WHERE domname = @ i_domname AND ddlanguage = @ sy - langu AND as4local = 'A' INTO TABLE @ lt_text . IF sy - subrc = 0 . lr_domain -> o_text = NEW # ( i_domname ). lr_domain -> o_text -> mt_text = lt_text . ELSE . lr_domain -> o_text = not_found . ENDIF . ENDIF . ro_text = lr_domain -> o_text . ENDMETHOD . METHOD create_objcl . READ TABLE mt_objcl REFERENCE INTO DATA ( lr_objcl ) WITH KEY objectkey = i_objectkey objecttable = i_objecttable classnum = i_classnum classtype = i_classtype BINARY SEARCH . IF sy - subrc <> 0 . INSERT VALUE # ( objectkey = i_objectkey objecttable = i_objecttable classnum = i_classnum classtype = i_classtype o_text = NEW # ( CONV # ( i_objectkey ) ) ) INTO TABLE mt_objcl REFERENCE INTO lr_objcl . DATA ls_objcl_key TYPE bapi1003_key . ls_objcl_key - object_long = lr_objcl -> objectkey . ls_objcl_key - objecttable = lr_objcl -> objecttable . ls_objcl_key - classnum = lr_objcl -> classnum . ls_objcl_key - classtype = lr_objcl -> classtype . \" \u5b58\u5728\u952e\u503c\u91cd\u590d\u7684\u60c5\u51b5\uff0c\u65e0\u6cd5\u5bf9\u5168\u90e8\u60c5\u51b5\u8fdb\u884c\u63a8\u5bfc \" \u4e00\u4e2a\u952e\u503c\u53ef\u80fd\u5bf9\u5e94\u4e0d\u540c\u4e1a\u52a1\uff0c\u5f3a\u884c\u63a8\u5bfc\u4f1a\u8ba9\u95ee\u9898\u6392\u67e5\u53d8\u5f97\u56f0\u96be \" \u5982\u679c\u89c9\u5f97\u65e0\u6240\u8c13\uff0c\u5012\u662f\u53ef\u4ee5\u542f\u7528\u8fd9\u6bb5\u63a8\u5bfc\u903b\u8f91 IF i_auto_complete = abap_true . \" \u7279\u5f81\u53d6\u503c\u76f8\u5173\u8868\uff1a \" AUSP\uff0c\u7279\u5f81\u503c\u8868 \" KSSK\uff0cKSSK-OBJEK = AUSP-OBJEK\uff0c\u7b80\u5355\u7406\u89e3\u4e3a\u5355\u5bf9\u8c61\u5206\u7c7b\uff0c\u6839\u636e\u5bf9\u8c61\u53f7\u5173\u8054\u7279\u5f81 \" INOB\uff0cINOB-CUOBJ = AUSP-OBJEK\uff0c\u591a\u5bf9\u8c61\u5206\u7c7b\uff0c\u6839\u636e\u5185\u90e8\u5bf9\u8c61\u53f7\u5173\u8054\u7279\u5f81 IF ls_objcl_key - objecttable IS INITIAL OR ls_objcl_key - classnum IS INITIAL OR ls_objcl_key - classtype IS INITIAL . \" \u5148\u6839\u636e\u5bf9\u8c61\u53f7\u63a8\u5bfc SELECT SINGLE tcla~obtab AS objecttable , klah~class AS classnum , kssk~klart AS classtype FROM kssk JOIN tcla ON kssk~klart = tcla~klart JOIN klah ON kssk~clint = klah~clint WHERE kssk~objek = @ ls_objcl_key - object_long INTO @ DATA ( ls_object_key ). IF sy - subrc <> 0 . \" \u518d\u6839\u636e\u5185\u90e8\u5bf9\u8c61\u53f7\u63a8\u5bfc SELECT SINGLE inob~obtab AS objecttable , klah~class AS classnum , inob~klart AS classtype FROM inob JOIN kssk ON inob~cuobj = kssk~objek JOIN klah ON kssk~clint = klah~clint WHERE inob~objek = @ ls_objcl_key - object_long INTO @ ls_object_key . ENDIF . IF ls_objcl_key - objecttable IS INITIAL . ls_objcl_key - objecttable = ls_object_key - objecttable . ENDIF . IF ls_objcl_key - classnum IS INITIAL . ls_objcl_key - classnum = ls_object_key - classnum . ENDIF . IF ls_objcl_key - classtype IS INITIAL . ls_objcl_key - classtype = ls_object_key - classtype . ENDIF . ENDIF . ENDIF . DATA : lt_allocvaluesnum TYPE STANDARD TABLE OF bapi1003_alloc_values_num , lt_allocvalueschar TYPE STANDARD TABLE OF bapi1003_alloc_values_char , lt_allocvaluescurr TYPE STANDARD TABLE OF bapi1003_alloc_values_curr , lt_return TYPE STANDARD TABLE OF bapiret2 . CALL FUNCTION 'BAPI_OBJCL_GETDETAIL' EXPORTING objectkey_long = ls_objcl_key - object_long objecttable = ls_objcl_key - objecttable classnum = ls_objcl_key - classnum classtype = ls_objcl_key - classtype TABLES allocvaluesnum = lt_allocvaluesnum allocvalueschar = lt_allocvalueschar allocvaluescurr = lt_allocvaluescurr return = lt_return . \" NUM(\u6570\u5b57)\uff0cDATE(\u65e5\u671f)\uff0cTIME(\u65f6\u95f4) LOOP AT lt_allocvaluesnum INTO DATA ( ls_allocvaluesnum ). \" \u83b7\u53d6\u51fa\u6765\u7684\u662fFLOAT\u683c\u5f0f\u6570\u636e\uff0c\u9700\u8981\u989d\u5916\u8fdb\u884c\u8f6c\u6362 INSERT VALUE # ( key = ls_allocvaluesnum - charact value = |{ ls_allocvaluesnum - value_from NUMBER = RAW }| ) INTO TABLE lr_objcl -> o_text -> mt_text . ENDLOOP . \" CHAR(\u5b57\u7b26) LOOP AT lt_allocvalueschar INTO DATA ( ls_allocvalueschar ). INSERT VALUE # ( key = ls_allocvalueschar - charact value = ls_allocvalueschar - value_char_long ) INTO TABLE lr_objcl -> o_text -> mt_text . ENDLOOP . \" CURR(\u91d1\u989d) LOOP AT lt_allocvaluescurr INTO DATA ( ls_allocvaluescurr ). \" \u83b7\u53d6\u51fa\u6765\u7684\u662fFLOAT\u683c\u5f0f\u6570\u636e\uff0c\u9700\u8981\u989d\u5916\u8fdb\u884c\u8f6c\u6362 \" \u6ca1\u9047\u8fc7\u8fd9\u79cd\u683c\u5f0f\u7684\u6570\u636e\uff0c\u4e0d\u77e5\u9053\u8981\u4e0d\u8981\u53c2\u8003\u8d27\u5e01 INSERT VALUE # ( key = ls_allocvaluescurr - charact value = |{ ls_allocvaluesnum - value_from NUMBER = RAW }| ) INTO TABLE lr_objcl -> o_text -> mt_text . ENDLOOP . ENDIF . ro_text = lr_objcl -> o_text . ENDMETHOD . METHOD create_query . READ TABLE mt_query REFERENCE INTO DATA ( lr_query ) WITH KEY name = i_name BINARY SEARCH . IF sy - subrc <> 0 . INSERT VALUE # ( name = i_name o_text = NEW # ( i_name ) ) INTO TABLE mt_query REFERENCE INTO lr_query . lr_query -> o_text -> m_custom_method = mc_method_dynamic_query . lr_query -> o_text -> ms_param - table = i_tabname . lr_query -> o_text -> ms_param - spras = i_spras . lr_query -> o_text -> ms_param - key = i_key . lr_query -> o_text -> ms_param - text = i_text . ENDIF . ro_text = lr_query -> o_text . ENDMETHOD . METHOD dynamic_query . CHECK ms_param IS NOT INITIAL . DATA l_where TYPE string . l_where = |{ ms_param - key } = @I_KEY |. \" \u62fc\u63a5\u67e5\u8be2\u6761\u4ef6 IF ms_param - spras IS NOT INITIAL . \" \u5982\u679c\u6709\u8bed\u8a00\u6761\u4ef6\u4e5f\u52a0\u4e0a l_where = |{ ms_param - spras } = @SY-LANGU AND { l_where }|. ENDIF . TRY . SELECT SINGLE ( ms_param - text ) FROM ( ms_param - table ) WHERE ( l_where ) INTO @ r_value . CATCH cx_root . CLEAR ms_param . \" \u67e5\u8be2\u5931\u8d25\uff0c\u4e0d\u5141\u8bb8\u7ee7\u7eed\u67e5\u8be2 ENDTRY . ENDMETHOD . METHOD get . CHECK i_key IS NOT INITIAL . \" \u7f13\u5b58\u68c0\u67e5 READ TABLE mt_text REFERENCE INTO DATA ( lr_text ) WITH KEY key = i_key . IF sy - subrc = 0 . r_value = lr_text -> value . RETURN . ENDIF . \" \u68c0\u67e5\u5e76\u8c03\u7528\u7279\u6b8a\u5904\u7406\u65b9\u6cd5 IF m_custom_method IS NOT INITIAL . TRY . CALL METHOD me -> ( m_custom_method ) EXPORTING i_key = i_key RECEIVING r_value = r_value . CATCH cx_root . m_custom_method = mc_none . \" \u62a5\u9519\u540e\u4e0d\u5141\u8bb8\u7ee7\u7eed\u4f7f\u7528 RETURN . ENDTRY . INSERT VALUE # ( \" \u7f13\u5b58\u8bb0\u5f55 key = i_key value = r_value ) INTO TABLE mt_text . ENDIF . ENDMETHOD . METHOD long_text . \" \u60f3\u4e86\u4e0b\uff0c\u8fd8\u662f\u4e0d\u7f13\u5b58\u4e86 CALL FUNCTION 'READ_TEXT' EXPORTING id = i_id language = i_language name = i_name object = i_object TABLES lines = et_tline EXCEPTIONS id = 1 language = 2 name = 3 not_found = 4 object = 5 reference_check = 6 wrong_access_to_archive = 7 . IF sy - subrc = 0 . CALL FUNCTION 'IDMX_DI_TLINE_INTO_STRING' EXPORTING it_tline = et_tline IMPORTING ev_text_string = r_value . IF e_value IS SUPPLIED . e_value = r_value . ENDIF . ENDIF . ENDMETHOD . METHOD set_language . TRY . SET LOCALE LANGUAGE i_langu . CATCH cx_sy_localization_error INTO DATA ( lx_sy_localization_error ). MESSAGE lx_sy_localization_error -> get_text ( ) TYPE 'S' DISPLAY LIKE 'E' . ENDTRY . ENDMETHOD . METHOD _syst_uname . SELECT SINGLE concat ( adrp~name_first , adrp~name_last ) FROM usr21 JOIN adrp ON usr21~persnumber = adrp~persnumber WHERE usr21~bname = @ i_key INTO @ r_value . IF r_value IS INITIAL . r_value = i_key . ENDIF . ENDMETHOD . ENDCLASS . \u6d4b\u8bd5\u7528\u4f8b \" \u6839\u636e\u4f20\u5165\u503c\u63a8\u7406 DATA ( l_text ) = ycl_text => auto ( abap_true ). \" \u57fa\u7840\u7c7b\u578b\uff0c\u63a8\u5bfc\u5931\u8d25\uff0c\u8fd4\u56de\u7a7a\u503c DATA ( l_text1 ) = ycl_text => auto ( CONV xfeld ( 'X' ) ). \" \u57df\u503c DATA ( l_text2 ) = ycl_text => auto ( CONV blart ( 'RV' ) ). \" \u6570\u636e\u5143\u7d20-\u503c\u8868-\u6587\u672c\u8868 DATA ( l_text3 ) = ycl_text => auto ( sy - uname ). \" \u81ea\u5b9a\u4e49\u67e5\u8be21 DATA ( l_text4 ) = ycl_text => auto ( CONV bukrs ( '0001' ) ). \" \u81ea\u5b9a\u4e49\u67e5\u8be22 \" \u5982\u679c\u4f20\u5165\u57fa\u7840\u7c7b\u578b\u6570\u636e\uff0c\u6216\u8005\u4f20\u5165\u503c\u6ca1\u6709\u57df\u503c\u3001\u503c\u8868\u3001\u6587\u672c\u8868\u3001\u81ea\u5b9a\u4e49\u67e5\u8be2\u7b49 \" AUTO\u4e0d\u80fd\u751f\u6548\uff0c\u6b64\u65f6\u53ef\u4ee5\u76f4\u63a5\u6307\u5b9a\u67e5\u8be2 DATA ( l_text5 ) = ycl_text => create_domain ( 'XFELD' ) -> get ( 'X' ). \" \u57df\u503c DATA ( l_text6 ) = ycl_text => create_query ( \" \u81ea\u5b9a\u4e49\u67e5\u8be23 i_name = 'DEMO_QUERY' i_tabname = 'T001' i_key = 'BUKRS' i_text = 'BUTXT' ) -> get ( '0001' ). DATA ( l_text7 ) = ycl_text => create_custom ( 'BUKRS' ) -> get ( '0001' ). \" \u81ea\u5b9a\u4e49\u67e5\u8be24","title":"\u6587\u672c\u53d6\u503c\u5de5\u5177"},{"location":"others/zcl_text/#_1","text":"\u62a5\u8868\u90e8\u5206\u5b57\u6bb5\u9700\u8981\u53d6\u6587\u672c\uff0c\u8fd9\u91cc\u5c06\u9891\u7387\u8f83\u9ad8\u7684\u5b57\u6bb5\u6574\u7406\u51fa\u6765\uff0c\u4ee5\u540e\u5c31\u4e0d\u7528\u91cd\u590d\u5199SQL\u67e5\u8868\u4e86\u3002 ECC\u914c\u60c5\u4f7f\u7528\uff0c\u7a0b\u5e8f\u6bcf\u6b21\u53d6\u503c\u5c31\u901a\u8fc7[SELECT SINGLE]\u8bbf\u95ee\u6570\u636e\u5e93\uff0c\u6027\u80fd\u8fdc\u4e0d\u5982\u76f4\u63a5\u6279\u91cf\u67e5\u8be2\u3002 HANA\u6027\u80fd\u6709\u5de8\u5927\u63d0\u5347\uff0c\u53ef\u4ee5\u5ffd\u7565\u8fd9\u90e8\u5206\u635f\u5931 ZCL_TEXT \"! <p class=\"shorttext synchronized\">\u6587\u672c\u53d6\u503c\u5de5\u5177</p> class ZCL_TEXT definition public final create private . public section . \"! <p class=\"shorttext synchronized\">\u6587\u672c\u5de5\u5177\u7c7b</p> constants MC_CLASS_NAME type SEOCLSNAME value 'ZCL_TEXT' ##NO_TEXT . \"! <p class=\"shorttext synchronized\">\u7a7a\u503c</p> constants MC_NONE type STRING value SPACE ##NO_TEXT . \"! <p class=\"shorttext synchronized\">\u81ea\u5b9a\u4e49\u65b9\u6cd5\u524d\u7f00</p> constants MC_CUSTOM_METHOD_PREFIX type STRING value '_' ##NO_TEXT . \"! <p class=\"shorttext synchronized\">\u52a8\u6001SQL\u67e5\u8be2\u65b9\u6cd5\u540d</p> constants MC_METHOD_DYNAMIC_QUERY type ABAP_METHNAME value 'DYNAMIC_QUERY' ##NO_TEXT . \"! <p class=\"shorttext synchronized\">\u6709\u6548\u7684\u7a7a\u5bf9\u8c61\uff0c\u9632\u6b62\u7a0b\u5e8f\u8fd0\u884c\u9519\u8bef</p> class-data NOT_FOUND type ref to ZCL_TEXT read - only . class-methods CLASS_CONSTRUCTOR . \"! <p class=\"shorttext synchronized\">\u8bbe\u7f6e\u53d6\u6587\u672c\u65f6\u6240\u7528\u8bed\u8a00</p> class-methods SET_LANGUAGE importing ! I_LANGU type SY - LANGU . \"! <p class=\"shorttext synchronized\">\u521b\u5efa\u81ea\u5b9a\u4e49\u5bf9\u8c61</p> class-methods CREATE_CUSTOM importing ! I_NAME type STRING returning value ( RO_TEXT ) type ref to ZCL_TEXT . \"! <p class=\"shorttext synchronized\">\u521b\u5efa\u52a8\u6001SQL\u5bf9\u8c61</p> class-methods CREATE_QUERY importing ! I_NAME type STRING ! I_TABNAME type TABNAME optional ! I_SPRAS type FIELDNAME optional ! I_KEY type FIELDNAME optional ! I_TEXT type FIELDNAME optional returning value ( RO_TEXT ) type ref to ZCL_TEXT . \"! <p class=\"shorttext synchronized\">\u521b\u5efa\u57df\u503c\u5bf9\u8c61</p> class-methods CREATE_DOMAIN importing ! I_DOMNAME type STRING returning value ( RO_TEXT ) type ref to ZCL_TEXT . \"! <p class=\"shorttext synchronized\">\u521b\u5efa\u7279\u5f81\u503c\u5bf9\u8c61</p> class-methods CREATE_OBJCL importing ! I_OBJECTKEY type BAPI1003_KEY - OBJECT ! I_OBJECTTABLE type BAPI1003_KEY - OBJECTTABLE optional ! I_CLASSNUM type BAPI1003_KEY - CLASSNUM optional ! I_CLASSTYPE type BAPI1003_KEY - CLASSTYPE optional ! I_AUTO_COMPLETE type XFELD default ABAP_TRUE returning value ( RO_TEXT ) type ref to ZCL_TEXT . \"! <p class=\"shorttext synchronized\">\u957f\u6587\u672c\u8bfb\u53d6</p> class-methods LONG_TEXT importing ! I_ID type THEAD - TDID ! I_LANGUAGE type THEAD - TDSPRAS default SY - LANGU ! I_NAME type THEAD - TDNAME ! I_OBJECT type THEAD - TDOBJECT exporting ! ET_TLINE type TLINETAB ! E_VALUE type STRING returning value ( R_VALUE ) type STRING . \"! <p class=\"shorttext synchronized\">\u6839\u636e\u4f20\u5165\u503c\u81ea\u52a8\u83b7\u53d6\u6587\u672c\uff08\u8981\u6c42\u5b57\u6bb5\u5b58\u5728\u503c\u8868\u548c\u6587\u672c\u8868\uff0c\u5426\u5219\u4f1a\u5931\u8d25\uff09</p> class-methods AUTO importing ! I_KEY type DATA returning value ( R_VALUE ) type STRING . \"! <p class=\"shorttext synchronized\">\u83b7\u53d6\u6587\u672c</p> methods GET importing ! I_KEY type DATA returning value ( R_VALUE ) type STRING . PROTECTED SECTION . private section . types : BEGIN OF ty_text , key TYPE string , value TYPE string , END OF ty_text . types : tt_text TYPE SORTED TABLE OF ty_text WITH NON-UNIQUE KEY key . types : BEGIN OF ty_instance , name TYPE string , o_text TYPE REF TO ZCL_TEXT , END OF ty_instance . types : tt_instance TYPE SORTED TABLE OF ty_instance WITH NON-UNIQUE KEY name . types : BEGIN OF ty_objcl_instance , objectkey TYPE bapi1003_key - object_long , objecttable TYPE bapi1003_key - objecttable , classnum TYPE bapi1003_key - classnum , classtype TYPE bapi1003_key - classtype , o_text TYPE REF TO ZCL_TEXT , END OF ty_objcl_instance . types : tt_objcl_instance TYPE SORTED TABLE OF ty_objcl_instance WITH NON-UNIQUE KEY objectkey objecttable classnum classtype . types : BEGIN OF ty_custom_query , name TYPE string , tabname TYPE tabname , spras TYPE fieldname , key TYPE fieldname , text TYPE fieldname , END OF ty_custom_query . types : tt_custom_query TYPE SORTED TABLE OF ty_custom_query WITH NON-UNIQUE KEY name . \"! <p class=\"shorttext synchronized\">AUTO\u5bf9\u8c61\u7f13\u5b58</p> class-data MT_AUTO type TT_INSTANCE . \"! <p class=\"shorttext synchronized\">\u81ea\u5b9a\u4e49\u5bf9\u8c61\u7f13\u5b58</p> class-data MT_CUSTOM type TT_INSTANCE . \"! <p class=\"shorttext synchronized\">\u57df\u503c\u5bf9\u8c61\u7f13\u5b58</p> class-data MT_DOMAIN type TT_INSTANCE . \"! <p class=\"shorttext synchronized\">\u52a8\u6001SQL\u5bf9\u8c61\u7f13\u5b58</p> class-data MT_QUERY type TT_INSTANCE . \"! <p class=\"shorttext synchronized\">\u7279\u5f81\u503c\u5bf9\u8c61\u7f13\u5b58</p> class-data MT_OBJCL type TT_OBJCL_INSTANCE . \"! <p class=\"shorttext synchronized\">\u81ea\u5b9a\u4e49\u52a8\u6001\u67e5\u8be2\u53c2\u6570</p> class-data MT_CUSTOM_QUERY type TT_CUSTOM_QUERY . \"! <p class=\"shorttext synchronized\">\u6587\u672c\u5de5\u5177\u7c7b\u63cf\u8ff0\u5bf9\u8c61</p> class-data MO_OBJECTDESCR type ref to CL_ABAP_OBJECTDESCR . \"! <p class=\"shorttext synchronized\">\u5bf9\u8c61\u540d\u79f0</p> data M_NAME type STRING . \"! <p class=\"shorttext synchronized\">\u53d6\u503c\u7f13\u5b58\u6e05\u5355</p> data MT_TEXT type TT_TEXT . \"! <p class=\"shorttext synchronized\">\u81ea\u5b9a\u4e49\u5904\u7406\u65b9\u6cd5</p> data M_CUSTOM_METHOD type ABAP_METHNAME . data : \"! <p class=\"shorttext synchronized\">\u52a8\u6001SQL\u53c2\u6570</p> BEGIN OF ms_param , table TYPE tabname , spras TYPE fieldname , key TYPE fieldname , text TYPE fieldname , END OF ms_param . \"! <p class=\"shorttext synchronized\">\u81ea\u5b9a\u4e49\u52a8\u6001\u67e5\u8be2\u53c2\u6570</p> class-methods CREATE_CUSTOM_QUERY . \"! <p class=\"shorttext synchronized\">CONSTRUCTOR</p> methods CONSTRUCTOR importing ! I_NAME type STRING . \"! <p class=\"shorttext synchronized\">\u52a8\u6001SQL\u67e5\u8be2</p> methods DYNAMIC_QUERY importing ! I_KEY type DATA returning value ( R_VALUE ) type STRING . \"! <p class=\"shorttext synchronized\">\u83b7\u53d6\u7528\u6237\u540d\u79f0</p> methods _SYST_UNAME importing ! I_KEY type DATA returning value ( R_VALUE ) type STRING . ENDCLASS . CLASS ZCL_TEXT IMPLEMENTATION . METHOD auto . \" \u83b7\u53d6\u5b57\u6bb5\u63cf\u8ff0 DATA ( lo_typedescr ) = cl_abap_typedescr => describe_by_data ( i_key ). IF lo_typedescr -> kind <> cl_abap_typedescr => kind_elem . \" \u53ea\u5bf9\u6570\u636e\u5143\u7d20\u8fdb\u884c\u5904\u7406 RETURN . ENDIF . \" \u83b7\u53d6\u5b57\u6bb5\u7c7b\u578b\u540d\u79f0 DATA l_rollname TYPE string . l_rollname = CAST cl_abap_elemdescr ( lo_typedescr ) -> get_ddic_field ( ) - rollname . IF l_rollname IS INITIAL . RETURN . ENDIF . \" \u7f13\u5b58\u68c0\u67e5 READ TABLE mt_auto REFERENCE INTO DATA ( lr_auto ) WITH KEY name = l_rollname BINARY SEARCH . IF sy - subrc = 0 . r_value = lr_auto -> o_text -> get ( i_key ). RETURN . ELSE . INSERT VALUE # ( name = l_rollname o_text = not_found ) INTO TABLE mt_auto REFERENCE INTO lr_auto . ENDIF . \" \u68c0\u67e5\u662f\u5426\u5b58\u5728\u81ea\u5b9a\u4e49\u5904\u7406\u65b9\u6cd5 lr_auto -> o_text = create_custom ( l_rollname ). IF lr_auto -> o_text <> not_found . r_value = lr_auto -> o_text -> get ( i_key ). RETURN . ENDIF . \" \u83b7\u53d6\u6570\u636e\u5143\u7d20\u5bf9\u5e94\u57df\u548c\u503c\u8868 SELECT SINGLE rollname , domname , entitytab FROM dd04l WHERE rollname = @ l_rollname INTO @ DATA ( ls_dd04l ). IF sy - subrc <> 0 . RETURN . ENDIF . \" \u68c0\u67e5\u662f\u5426\u5b58\u5728\u57df\u503c lr_auto -> o_text = create_domain ( CONV # ( ls_dd04l - domname ) ). IF lr_auto -> o_text <> not_found . r_value = lr_auto -> o_text -> get ( i_key ). RETURN . ENDIF . \" \u68c0\u67e5\u662f\u5426\u5b58\u5728\u503c\u8868 IF ls_dd04l - entitytab IS INITIAL . RETURN . ENDIF . \" \u83b7\u53d6\u503c\u8868\u5bf9\u5e94\u6587\u672c\u8868 SELECT SINGLE tabname FROM dd08l WHERE checktable = @ ls_dd04l - entitytab AND frkart = 'TEXT' INTO @ DATA ( l_texttab ). IF sy - subrc <> 0 . RETURN . ENDIF . \" \u83b7\u53d6\u503c\u8868\u7ed3\u6784 SELECT position , fieldname , keyflag , rollname FROM dd03l WHERE tabname = @ l_texttab INTO TABLE @ DATA ( lt_field ). IF sy - subrc <> 0 . RETURN . ENDIF . \" \u83b7\u53d6\u52a8\u6001SQL\u67e5\u8be2\u6240\u9700\u53c2\u6570 DATA l_field_spras TYPE fieldname . DATA l_field_key TYPE fieldname . DATA l_field_text TYPE fieldname . SORT lt_field BY position . LOOP AT lt_field INTO DATA ( ls_field ). IF ls_field - keyflag = 'X' . \" \u83b7\u53d6\u5173\u952e\u5b57\u6bb5\u4e2d\u7684\u952e\u503c\u5b57\u6bb5 IF ls_field - rollname = l_rollname . l_field_key = ls_field - fieldname . ENDIF . \" \u83b7\u53d6\u5173\u952e\u5b57\u6bb5\u4e2d\u7684\u8bed\u8a00\u5b57\u6bb5 IF ls_field - rollname = 'SPRAS' . l_field_spras = ls_field - fieldname . ENDIF . ELSE . \" \u83b7\u53d6\u975e\u952e\u503c\u7684\u7b2c\u4e00\u4e2a\u5b57\u6bb5\u4f5c\u4e3a\u6587\u672c\u5b57\u6bb5 l_field_text = ls_field - fieldname . ENDIF . ENDLOOP . IF l_field_key IS INITIAL OR l_field_text IS INITIAL . RETURN . ENDIF . \" \u521b\u5efa\u52a8\u6001\u67e5\u8be2 lr_auto -> o_text = create_query ( i_name = l_rollname i_tabname = l_texttab i_spras = l_field_spras i_key = l_field_key i_text = l_field_text ). r_value = lr_auto -> o_text -> get ( i_key ). \" \u8fd4\u56de\u67e5\u8be2\u7ed3\u679c ENDMETHOD . METHOD class_constructor . \" \u5206\u6790\u81ea\u8eab\uff0c\u83b7\u53d6\u53ef\u4ee5\u63d0\u4f9b\u7684\u7279\u6b8a\u6587\u672c\u5904\u7406\u65b9\u6cd5 mo_objectdescr ?= cl_abap_typedescr => describe_by_name ( mc_class_name ). \" \u521b\u5efa\u6709\u6548\u7684\u7a7a\u503c\u5bf9\u8c61\uff0c\u9632\u6b62\u7a0b\u5e8f\u8fd0\u884c\u9519\u8bef not_found = NEW # ( mc_none ). ENDMETHOD . METHOD constructor . m_name = i_name . ENDMETHOD . METHOD create_custom . READ TABLE mt_custom REFERENCE INTO DATA ( lr_custom ) WITH KEY name = i_name BINARY SEARCH . IF sy - subrc <> 0 . INSERT VALUE # ( name = i_name ) INTO TABLE mt_custom REFERENCE INTO lr_custom . \" \u7ea6\u5b9a\u81ea\u5b9a\u4e49\u5904\u7406\u65b9\u6cd5\u4e3a\u3010\u524d\u7f00+\u540d\u79f0\u3011\uff0c\u5916\u90e8\u8c03\u7528\u65f6\uff0c\u4f20\u5165\u540d\u79f0\u5373\u53ef DATA l_method TYPE abap_methname . l_method = |{ mc_custom_method_prefix }{ i_name CASE = UPPER }|. READ TABLE mo_objectdescr -> methods TRANSPORTING NO FIELDS WITH KEY name = l_method BINARY SEARCH . IF sy - subrc = 0 . lr_custom -> o_text = NEW # ( i_name ). lr_custom -> o_text -> m_custom_method = l_method . ELSE . \" \u7b2c\u4e00\u6b21\u8c03\u7528\u5148\u83b7\u53d6\u914d\u7f6e\u6570\u636e IF mt_custom_query IS INITIAL . create_custom_query ( ). ENDIF . \" \u68c0\u67e5\u914d\u7f6e\u662f\u5426\u6709\u5b9a\u4e49\u67e5\u8be2 READ TABLE mt_custom_query REFERENCE INTO DATA ( lr_custom_query ) WITH KEY name = i_name BINARY SEARCH . IF sy - subrc = 0 . lr_custom -> o_text = create_query ( i_name = lr_custom_query -> name i_tabname = lr_custom_query -> tabname i_spras = lr_custom_query -> spras i_key = lr_custom_query -> key i_text = lr_custom_query -> text ). ELSE . \" \u90fd\u6ca1\u6709\uff0c\u8fd4\u56de\u67e5\u8be2\u5931\u8d25 lr_custom -> o_text = not_found . ENDIF . ENDIF . ENDIF . ro_text = lr_custom -> o_text . ENDMETHOD . METHOD create_custom_query . \" \u53ef\u4ee5\u5f04\u914d\u7f6e\u8868\uff0c\u6211\u8fd9\u8fb9\u4e3a\u4e86\u65b9\u4fbf\u8fc1\u79fb\uff0c\u76f4\u63a5\u5199\u6b7b mt_custom_query = VALUE # ( ( name = 'BUKRS' tabname = 'T001' key = 'BUKRS' text = 'BUTXT' ) \" \u516c\u53f8 ( name = 'MATNR' tabname = 'MAKT' key = 'MATNR' text = 'MAKTX' spras = 'SPRAS' ) \" \u7269\u6599 ( name = 'MATKL' tabname = 'T023T' key = 'MATKL' text = 'WGBEZ' spras = 'SPRAS' ) \" \u7269\u6599\u7ec4 ( name = 'PARTNER' tabname = 'BUT000' key = 'PARTNER' text = 'CONCAT( NAME_ORG1, NAME_ORG2 )' ) \" \u4e1a\u52a1\u4f19\u4f34 ( name = 'KUNNR' tabname = 'KNA1' key = 'KUNNR' text = 'CONCAT( NAME1, NAME2 )' ) \" \u4e1a\u52a1\u4f19\u4f34 ( name = 'LIFNR' tabname = 'LFA1' key = 'LIFNR' text = 'CONCAT( NAME1, NAME2 )' ) \" \u4f9b\u5e94\u5546 ( name = 'WERKS' tabname = 'T001W' key = 'WERKS' text = 'NAME1' ) \" \u5de5\u5382 ( name = 'LGORT' tabname = 'T001L' key = 'LGORT' text = 'LGOBE' ) \" \u5e93\u4f4d ( name = 'PRCTR' tabname = 'CEPCT' key = 'PRCTR' text = 'LTEXT' spras = 'SPRAS' ) \" \u5229\u6da6\u4e2d\u5fc3 ( name = 'WAERS' tabname = 'TCURT' key = 'WAERS' text = 'LTEXT' spras = 'SPRAS' ) \" \u8d27\u5e01 ). ENDMETHOD . METHOD create_domain . READ TABLE mt_domain REFERENCE INTO DATA ( lr_domain ) WITH KEY name = i_domname BINARY SEARCH . IF sy - subrc <> 0 . INSERT VALUE # ( name = i_domname ) INTO TABLE mt_domain REFERENCE INTO lr_domain . DATA lt_text TYPE tt_text . SELECT domvalue_l AS key , ddtext AS value FROM dd07t WHERE domname = @ i_domname AND ddlanguage = @ sy - langu AND as4local = 'A' INTO TABLE @ lt_text . IF sy - subrc = 0 . lr_domain -> o_text = NEW # ( i_domname ). lr_domain -> o_text -> mt_text = lt_text . ELSE . lr_domain -> o_text = not_found . ENDIF . ENDIF . ro_text = lr_domain -> o_text . ENDMETHOD . METHOD create_objcl . READ TABLE mt_objcl REFERENCE INTO DATA ( lr_objcl ) WITH KEY objectkey = i_objectkey objecttable = i_objecttable classnum = i_classnum classtype = i_classtype BINARY SEARCH . IF sy - subrc <> 0 . INSERT VALUE # ( objectkey = i_objectkey objecttable = i_objecttable classnum = i_classnum classtype = i_classtype o_text = NEW # ( CONV # ( i_objectkey ) ) ) INTO TABLE mt_objcl REFERENCE INTO lr_objcl . DATA ls_objcl_key TYPE bapi1003_key . ls_objcl_key - object_long = lr_objcl -> objectkey . ls_objcl_key - objecttable = lr_objcl -> objecttable . ls_objcl_key - classnum = lr_objcl -> classnum . ls_objcl_key - classtype = lr_objcl -> classtype . \" \u5b58\u5728\u952e\u503c\u91cd\u590d\u7684\u60c5\u51b5\uff0c\u65e0\u6cd5\u5bf9\u5168\u90e8\u60c5\u51b5\u8fdb\u884c\u63a8\u5bfc \" \u4e00\u4e2a\u952e\u503c\u53ef\u80fd\u5bf9\u5e94\u4e0d\u540c\u4e1a\u52a1\uff0c\u5f3a\u884c\u63a8\u5bfc\u4f1a\u8ba9\u95ee\u9898\u6392\u67e5\u53d8\u5f97\u56f0\u96be \" \u5982\u679c\u89c9\u5f97\u65e0\u6240\u8c13\uff0c\u5012\u662f\u53ef\u4ee5\u542f\u7528\u8fd9\u6bb5\u63a8\u5bfc\u903b\u8f91 IF i_auto_complete = abap_true . \" \u7279\u5f81\u53d6\u503c\u76f8\u5173\u8868\uff1a \" AUSP\uff0c\u7279\u5f81\u503c\u8868 \" KSSK\uff0cKSSK-OBJEK = AUSP-OBJEK\uff0c\u7b80\u5355\u7406\u89e3\u4e3a\u5355\u5bf9\u8c61\u5206\u7c7b\uff0c\u6839\u636e\u5bf9\u8c61\u53f7\u5173\u8054\u7279\u5f81 \" INOB\uff0cINOB-CUOBJ = AUSP-OBJEK\uff0c\u591a\u5bf9\u8c61\u5206\u7c7b\uff0c\u6839\u636e\u5185\u90e8\u5bf9\u8c61\u53f7\u5173\u8054\u7279\u5f81 IF ls_objcl_key - objecttable IS INITIAL OR ls_objcl_key - classnum IS INITIAL OR ls_objcl_key - classtype IS INITIAL . \" \u5148\u6839\u636e\u5bf9\u8c61\u53f7\u63a8\u5bfc SELECT SINGLE tcla~obtab AS objecttable , klah~class AS classnum , kssk~klart AS classtype FROM kssk JOIN tcla ON kssk~klart = tcla~klart JOIN klah ON kssk~clint = klah~clint WHERE kssk~objek = @ ls_objcl_key - object_long INTO @ DATA ( ls_object_key ). IF sy - subrc <> 0 . \" \u518d\u6839\u636e\u5185\u90e8\u5bf9\u8c61\u53f7\u63a8\u5bfc SELECT SINGLE inob~obtab AS objecttable , klah~class AS classnum , inob~klart AS classtype FROM inob JOIN kssk ON inob~cuobj = kssk~objek JOIN klah ON kssk~clint = klah~clint WHERE inob~objek = @ ls_objcl_key - object_long INTO @ ls_object_key . ENDIF . IF ls_objcl_key - objecttable IS INITIAL . ls_objcl_key - objecttable = ls_object_key - objecttable . ENDIF . IF ls_objcl_key - classnum IS INITIAL . ls_objcl_key - classnum = ls_object_key - classnum . ENDIF . IF ls_objcl_key - classtype IS INITIAL . ls_objcl_key - classtype = ls_object_key - classtype . ENDIF . ENDIF . ENDIF . DATA : lt_allocvaluesnum TYPE STANDARD TABLE OF bapi1003_alloc_values_num , lt_allocvalueschar TYPE STANDARD TABLE OF bapi1003_alloc_values_char , lt_allocvaluescurr TYPE STANDARD TABLE OF bapi1003_alloc_values_curr , lt_return TYPE STANDARD TABLE OF bapiret2 . CALL FUNCTION 'BAPI_OBJCL_GETDETAIL' EXPORTING objectkey_long = ls_objcl_key - object_long objecttable = ls_objcl_key - objecttable classnum = ls_objcl_key - classnum classtype = ls_objcl_key - classtype TABLES allocvaluesnum = lt_allocvaluesnum allocvalueschar = lt_allocvalueschar allocvaluescurr = lt_allocvaluescurr return = lt_return . \" NUM(\u6570\u5b57)\uff0cDATE(\u65e5\u671f)\uff0cTIME(\u65f6\u95f4) LOOP AT lt_allocvaluesnum INTO DATA ( ls_allocvaluesnum ). \" \u83b7\u53d6\u51fa\u6765\u7684\u662fFLOAT\u683c\u5f0f\u6570\u636e\uff0c\u9700\u8981\u989d\u5916\u8fdb\u884c\u8f6c\u6362 INSERT VALUE # ( key = ls_allocvaluesnum - charact value = |{ ls_allocvaluesnum - value_from NUMBER = RAW }| ) INTO TABLE lr_objcl -> o_text -> mt_text . ENDLOOP . \" CHAR(\u5b57\u7b26) LOOP AT lt_allocvalueschar INTO DATA ( ls_allocvalueschar ). INSERT VALUE # ( key = ls_allocvalueschar - charact value = ls_allocvalueschar - value_char_long ) INTO TABLE lr_objcl -> o_text -> mt_text . ENDLOOP . \" CURR(\u91d1\u989d) LOOP AT lt_allocvaluescurr INTO DATA ( ls_allocvaluescurr ). \" \u83b7\u53d6\u51fa\u6765\u7684\u662fFLOAT\u683c\u5f0f\u6570\u636e\uff0c\u9700\u8981\u989d\u5916\u8fdb\u884c\u8f6c\u6362 \" \u6ca1\u9047\u8fc7\u8fd9\u79cd\u683c\u5f0f\u7684\u6570\u636e\uff0c\u4e0d\u77e5\u9053\u8981\u4e0d\u8981\u53c2\u8003\u8d27\u5e01 INSERT VALUE # ( key = ls_allocvaluescurr - charact value = |{ ls_allocvaluesnum - value_from NUMBER = RAW }| ) INTO TABLE lr_objcl -> o_text -> mt_text . ENDLOOP . ENDIF . ro_text = lr_objcl -> o_text . ENDMETHOD . METHOD create_query . READ TABLE mt_query REFERENCE INTO DATA ( lr_query ) WITH KEY name = i_name BINARY SEARCH . IF sy - subrc <> 0 . INSERT VALUE # ( name = i_name o_text = NEW # ( i_name ) ) INTO TABLE mt_query REFERENCE INTO lr_query . lr_query -> o_text -> m_custom_method = mc_method_dynamic_query . lr_query -> o_text -> ms_param - table = i_tabname . lr_query -> o_text -> ms_param - spras = i_spras . lr_query -> o_text -> ms_param - key = i_key . lr_query -> o_text -> ms_param - text = i_text . ENDIF . ro_text = lr_query -> o_text . ENDMETHOD . METHOD dynamic_query . CHECK ms_param IS NOT INITIAL . DATA l_where TYPE string . l_where = |{ ms_param - key } = @I_KEY |. \" \u62fc\u63a5\u67e5\u8be2\u6761\u4ef6 IF ms_param - spras IS NOT INITIAL . \" \u5982\u679c\u6709\u8bed\u8a00\u6761\u4ef6\u4e5f\u52a0\u4e0a l_where = |{ ms_param - spras } = @SY-LANGU AND { l_where }|. ENDIF . TRY . SELECT SINGLE ( ms_param - text ) FROM ( ms_param - table ) WHERE ( l_where ) INTO @ r_value . CATCH cx_root . CLEAR ms_param . \" \u67e5\u8be2\u5931\u8d25\uff0c\u4e0d\u5141\u8bb8\u7ee7\u7eed\u67e5\u8be2 ENDTRY . ENDMETHOD . METHOD get . CHECK i_key IS NOT INITIAL . \" \u7f13\u5b58\u68c0\u67e5 READ TABLE mt_text REFERENCE INTO DATA ( lr_text ) WITH KEY key = i_key . IF sy - subrc = 0 . r_value = lr_text -> value . RETURN . ENDIF . \" \u68c0\u67e5\u5e76\u8c03\u7528\u7279\u6b8a\u5904\u7406\u65b9\u6cd5 IF m_custom_method IS NOT INITIAL . TRY . CALL METHOD me -> ( m_custom_method ) EXPORTING i_key = i_key RECEIVING r_value = r_value . CATCH cx_root . m_custom_method = mc_none . \" \u62a5\u9519\u540e\u4e0d\u5141\u8bb8\u7ee7\u7eed\u4f7f\u7528 RETURN . ENDTRY . INSERT VALUE # ( \" \u7f13\u5b58\u8bb0\u5f55 key = i_key value = r_value ) INTO TABLE mt_text . ENDIF . ENDMETHOD . METHOD long_text . \" \u60f3\u4e86\u4e0b\uff0c\u8fd8\u662f\u4e0d\u7f13\u5b58\u4e86 CALL FUNCTION 'READ_TEXT' EXPORTING id = i_id language = i_language name = i_name object = i_object TABLES lines = et_tline EXCEPTIONS id = 1 language = 2 name = 3 not_found = 4 object = 5 reference_check = 6 wrong_access_to_archive = 7 . IF sy - subrc = 0 . CALL FUNCTION 'IDMX_DI_TLINE_INTO_STRING' EXPORTING it_tline = et_tline IMPORTING ev_text_string = r_value . IF e_value IS SUPPLIED . e_value = r_value . ENDIF . ENDIF . ENDMETHOD . METHOD set_language . TRY . SET LOCALE LANGUAGE i_langu . CATCH cx_sy_localization_error INTO DATA ( lx_sy_localization_error ). MESSAGE lx_sy_localization_error -> get_text ( ) TYPE 'S' DISPLAY LIKE 'E' . ENDTRY . ENDMETHOD . METHOD _syst_uname . SELECT SINGLE concat ( adrp~name_first , adrp~name_last ) FROM usr21 JOIN adrp ON usr21~persnumber = adrp~persnumber WHERE usr21~bname = @ i_key INTO @ r_value . IF r_value IS INITIAL . r_value = i_key . ENDIF . ENDMETHOD . ENDCLASS . \u6d4b\u8bd5\u7528\u4f8b \" \u6839\u636e\u4f20\u5165\u503c\u63a8\u7406 DATA ( l_text ) = ycl_text => auto ( abap_true ). \" \u57fa\u7840\u7c7b\u578b\uff0c\u63a8\u5bfc\u5931\u8d25\uff0c\u8fd4\u56de\u7a7a\u503c DATA ( l_text1 ) = ycl_text => auto ( CONV xfeld ( 'X' ) ). \" \u57df\u503c DATA ( l_text2 ) = ycl_text => auto ( CONV blart ( 'RV' ) ). \" \u6570\u636e\u5143\u7d20-\u503c\u8868-\u6587\u672c\u8868 DATA ( l_text3 ) = ycl_text => auto ( sy - uname ). \" \u81ea\u5b9a\u4e49\u67e5\u8be21 DATA ( l_text4 ) = ycl_text => auto ( CONV bukrs ( '0001' ) ). \" \u81ea\u5b9a\u4e49\u67e5\u8be22 \" \u5982\u679c\u4f20\u5165\u57fa\u7840\u7c7b\u578b\u6570\u636e\uff0c\u6216\u8005\u4f20\u5165\u503c\u6ca1\u6709\u57df\u503c\u3001\u503c\u8868\u3001\u6587\u672c\u8868\u3001\u81ea\u5b9a\u4e49\u67e5\u8be2\u7b49 \" AUTO\u4e0d\u80fd\u751f\u6548\uff0c\u6b64\u65f6\u53ef\u4ee5\u76f4\u63a5\u6307\u5b9a\u67e5\u8be2 DATA ( l_text5 ) = ycl_text => create_domain ( 'XFELD' ) -> get ( 'X' ). \" \u57df\u503c DATA ( l_text6 ) = ycl_text => create_query ( \" \u81ea\u5b9a\u4e49\u67e5\u8be23 i_name = 'DEMO_QUERY' i_tabname = 'T001' i_key = 'BUKRS' i_text = 'BUTXT' ) -> get ( '0001' ). DATA ( l_text7 ) = ycl_text => create_custom ( 'BUKRS' ) -> get ( '0001' ). \" \u81ea\u5b9a\u4e49\u67e5\u8be24","title":"\u6587\u672c\u53d6\u503c\u5de5\u5177"},{"location":"others/zdataimport/","text":"\u5bfc\u8868\u7a0b\u5e8f \u00b6 \u5c0f\u5fc3\u522b\u628a\u6807\u51c6\u8868\u7684\u6570\u636e\u8986\u76d6\u4e86 \u8fd8\u6709\u4e2a\u9009\u62e9\u5bfc\u5165\u5217\u7684\u529f\u80fd\uff0c\u540e\u9762\u6709\u7a7a\u518d\u8865\u5145 \u793a\u4f8b\u4ee3\u7801 *&---------------------------------------------------------------------* *& Report ZDATAIMPORT *&---------------------------------------------------------------------* *& 1 2022\u5e749\u670816\u65e5 \u521d\u59cb *&---------------------------------------------------------------------* REPORT zdataimport . *&---------------------------------------------------------------------* *& \u7c7b\u578b\u5b9a\u4e49 *&---------------------------------------------------------------------* \" \u7528\u4e8e\u9009\u53d6\u66f4\u65b0\u5217 TYPES : BEGIN OF ty_field , zname TYPE lvc_s_fcat - fieldname , ztext TYPE lvc_s_fcat - scrtext_l , zkey TYPE xfeld , zsel TYPE xfeld , END OF ty_field . TYPES tt_field TYPE STANDARD TABLE OF ty_field . *&---------------------------------------------------------------------* *& \u672c\u5730\u7c7b\u58f0\u660e *&---------------------------------------------------------------------* CLASS lcl_event_handler DEFINITION DEFERRED . *&---------------------------------------------------------------------* *& \u672c\u5730\u7c7b\u5b9a\u4e49 *&---------------------------------------------------------------------* CLASS lcl_event_handler DEFINITION . PUBLIC SECTION . METHODS on_dialogbox_close FOR EVENT close OF cl_gui_dialogbox_container IMPORTING sender . METHODS on_toolbar FOR EVENT toolbar OF cl_gui_alv_grid IMPORTING e_object e_interactive . METHODS on_user_command FOR EVENT user_command OF cl_gui_alv_grid IMPORTING e_ucomm . ENDCLASS . *&---------------------------------------------------------------------* *& \u672c\u5730\u7c7b\u5b9a\u4e49 *&---------------------------------------------------------------------* CLASS lcl_event_handler IMPLEMENTATION . *&---------------------------------------------------------------------* *& on_dialogbox_close *&---------------------------------------------------------------------* METHOD on_dialogbox_close . \" \u9690\u85cf\u5373\u53ef\uff0c\u91cd\u590d\u521b\u5efa\u6ca1\u5fc5\u8981 IF sender IS NOT INITIAL . sender -> set_visible ( cl_gui_dialogbox_container => visible_false ). ENDIF . ENDMETHOD . *&---------------------------------------------------------------------* *& on_toolbar *&---------------------------------------------------------------------* METHOD on_toolbar . \" \u79fb\u9664\u7f16\u8f91\u76f8\u5173\u7684\u6309\u94ae DELETE e_object -> mt_toolbar WHERE function CS '&LOCAL&' . \" \u65b0\u589e\u6309\u94ae DATA ls_button LIKE LINE OF e_object -> mt_toolbar . CLEAR ls_button . ls_button - function = 'Z10' . ls_button - icon = icon_execute_object . ls_button - quickinfo = ls_button - text = '\u786e\u8ba4\u5bfc\u5165' . INSERT ls_button INTO TABLE e_object -> mt_toolbar . ENDMETHOD . *&---------------------------------------------------------------------* *& on_user_command *&---------------------------------------------------------------------* METHOD on_user_command . IF e_ucomm = 'Z10' . PERFORM frm_import . ENDIF . ENDMETHOD . ENDCLASS . *&---------------------------------------------------------------------* *& TOP *&---------------------------------------------------------------------* DATA gr_data_tab TYPE REF TO data . DATA gt_fieldcat TYPE lvc_t_fcat . DATA gt_rows TYPE lvc_t_row . \" \u9009\u53d6\u884c\u9879\u76ee \" \u5f39\u7a97\u9009\u62e9\u9700\u8981\u66f4\u65b0\u7684\u5217 DATA go_con_fields TYPE REF TO cl_gui_dialogbox_container . DATA go_grid_fields TYPE REF TO cl_gui_alv_grid . *DATA gt_fieldcat TYPE lvc_t_fcat. \" \u91cd\u540d\uff0c\u60f3\u4e86\u60f3\uff0c\u8bbe\u7f6e\u4e3a\u5c40\u90e8\u53c2\u6570\u4f20\u503c\u5373\u53ef DATA gt_field TYPE tt_field . \" \u4e8b\u4ef6\u7c7b DATA go_event_handler TYPE REF TO lcl_event_handler . *&---------------------------------------------------------------------* *& \u9009\u62e9\u5c4f\u5e55 *&---------------------------------------------------------------------* PARAMETERS : rb1 RADIOBUTTON GROUP rg1 USER - COMMAND rg1 DEFAULT 'X' , \" \u4e0a\u4f20\u6570\u636e rb2 RADIOBUTTON GROUP rg1 . \" \u4e0b\u8f7d\u6a21\u677f PARAMETERS p_tabnam TYPE tabname16 . PARAMETERS p_file TYPE rlgrap - filename MODIF ID m1 . PARAMETERS p_dbdata TYPE xfeld MODIF ID m2 . \" \u5305\u62ec\u8868\u6570\u636e SELECTION-SCREEN ULINE . SELECTION-SCREEN COMMENT / 2 ( 70 ) comm1 . *&---------------------------------------------------------------------* *& INITIALIZATION *&---------------------------------------------------------------------* INITIALIZATION . PERFORM frm_initialization . *&---------------------------------------------------------------------* *& AT SELECTION-SCREEN *&---------------------------------------------------------------------* AT SELECTION-SCREEN OUTPUT . PERFORM frm_set_screen . *&---------------------------------------------------------------------* *& AT SELECTION-SCREEN *&---------------------------------------------------------------------* AT SELECTION-SCREEN ON VALUE-REQUEST FOR p_file . PERFORM frm_f4_file CHANGING p_file . *&---------------------------------------------------------------------* *& Form frm_set_screen *&---------------------------------------------------------------------* *& \u9009\u62e9\u5c4f\u5e55\u63a7\u5236 *&---------------------------------------------------------------------* FORM frm_set_screen . LOOP AT SCREEN . CASE screen - group1 . WHEN 'M1' . IF rb2 = 'X' . screen - active = '0' . screen - invisible = '1' . ELSE . screen - active = '1' . screen - invisible = '0' . ENDIF . MODIFY SCREEN . WHEN 'M2' . IF rb1 = 'X' . screen - active = '0' . screen - invisible = '1' . ELSE . screen - active = '1' . screen - invisible = '0' . ENDIF . MODIFY SCREEN . ENDCASE . ENDLOOP . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_f4_file *&---------------------------------------------------------------------* *& \u6587\u4ef6\u641c\u7d22\u5e2e\u52a9 *&---------------------------------------------------------------------* FORM frm_f4_file CHANGING c_file TYPE rlgrap - filename . c_file = cl_openxml_helper => browse_local_file_open ( EXPORTING iv_title = 'Open' iv_filename = 'import.xlsx' iv_extpattern = '*.xlsx' ). ENDFORM . *&---------------------------------------------------------------------* *& Form frm_initialization *&---------------------------------------------------------------------* *& \u7a0b\u5e8f\u521d\u59cb\u5316 *&---------------------------------------------------------------------* FORM frm_initialization . GET PARAMETER ID 'DTB' FIELD p_tabnam . GET PARAMETER ID 'ZF' FIELD p_file . % _rb1_ % _app_ % - text = '\u6279\u91cf\u5bfc\u5165' . % _rb2_ % _app_ % - text = '\u4e0b\u8f7d\u6279\u5bfc\u6a21\u677f' . % _p_tabnam_ % _app_ % - text = '\u8868\u540d' . % _p_file_ % _app_ % - text = '\u6587\u4ef6\u8def\u5f84' . % _p_dbdata_ % _app_ % - text = '\u5305\u62ec\u6570\u636e\u5e93\u8868\u6570\u636e' . comm1 = '\u5907\u6ce8\uff1a\u7b2c\u4e00\u884c\u4e3a\u5b57\u6bb5\u540d\u79f0\uff0c\u7b2c\u4e8c\u884c\u4e3a\u62ac\u5934\u6587\u672c\uff0c\u7b2c\u4e09\u884c\u53ca\u540e\u7eed\u4e3a\u6570\u636e\u884c' . ENDFORM . *&---------------------------------------------------------------------* *& Form FRM_MAIN *&---------------------------------------------------------------------* *& \u7a0b\u5e8f\u5165\u53e3 *&---------------------------------------------------------------------* FORM frm_main . CHECK sy - tcode <> 'ZDATAIMPORT' . SET PARAMETER ID 'DTB' FIELD p_tabnam . SET PARAMETER ID 'ZF' FIELD p_file . PERFORM frm_create_dynamic_table . \" \u521b\u5efa\u52a8\u6001\u8868\u683c CASE 'X' . WHEN rb1 . PERFORM frm_upload_data . PERFORM frm_display . WHEN rb2 . PERFORM frm_download_template . ENDCASE . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_create_dynamic_table *&---------------------------------------------------------------------* *& \u521b\u5efa\u8868\u683c\u6570\u636e\u8868\u683c *&---------------------------------------------------------------------* FORM frm_create_dynamic_table . PERFORM frm_check_input . TRY . CREATE DATA gr_data_tab TYPE STANDARD TABLE OF ( p_tabnam ). CATCH cx_root INTO DATA ( lx_root ). MESSAGE lx_root -> get_text ( ) TYPE 'E' . ENDTRY . DATA l_name TYPE dd02l - tabname . l_name = p_tabnam . CALL FUNCTION 'LVC_FIELDCATALOG_MERGE' EXPORTING i_structure_name = l_name i_bypassing_buffer = 'X' CHANGING ct_fieldcat = gt_fieldcat EXCEPTIONS inconsistent_interface = 1 program_error = 2 OTHERS = 3 . IF sy - subrc <> 0 . * MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno * WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4. ENDIF . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_check_input *&---------------------------------------------------------------------* *& \u8f93\u5165\u6821\u9a8c *&---------------------------------------------------------------------* FORM frm_check_input . IF p_tabnam IS INITIAL . MESSAGE | \u8bf7\u8f93\u5165\u8868\u540d | TYPE 'S' DISPLAY LIKE 'E' . LEAVE LIST - PROCESSING . ENDIF . IF p_tabnam ( 1 ) = 'Z' OR p_tabnam ( 1 ) = 'Y' . ELSE . MESSAGE | \u8868 { p_tabnam } \u975e\u81ea\u5efa\u8868\uff0c\u4e0d\u5141\u8bb8\u4fee\u6539 | TYPE 'S' DISPLAY LIKE 'E' . LEAVE LIST - PROCESSING . ENDIF . SELECT SINGLE COUNT ( * ) FROM dd02l WHERE tabname = @ p_tabnam . IF sy - subrc <> 0 . MESSAGE | \u8868 { p_tabnam } \u4e0d\u5b58\u5728 | TYPE 'S' DISPLAY LIKE 'E' . LEAVE LIST - PROCESSING . ENDIF . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_upload_data *&---------------------------------------------------------------------* *& \u4e0a\u4f20\u6587\u4ef6 *&---------------------------------------------------------------------* FORM frm_upload_data . TRY . DATA ( l_buffer ) = cl_openxml_helper => load_local_file ( CONV # ( p_file ) ). DATA ( lo_xlsx ) = cl_ehfnd_xlsx => get_instance ( ). DATA ( lo_doc ) = lo_xlsx -> load_doc ( l_buffer ). DATA ( lt_sheet_info ) = lo_doc -> get_sheets ( ). DATA ( lo_sheet ) = lo_doc -> get_sheet_by_id ( lt_sheet_info [ 1 ] - sheet_id ). CATCH cx_openxml_format cx_openxml_not_found cx_openxml_not_allowed INTO DATA ( lx_root ). MESSAGE lx_root -> get_text ( ) TYPE 'S' DISPLAY LIKE 'E' . LEAVE LIST - PROCESSING . ENDTRY . FIELD-SYMBOLS <fs_data_tab> TYPE STANDARD TABLE . FIELD-SYMBOLS <fs_data> TYPE any . FIELD-SYMBOLS <fs_field> TYPE any . ASSIGN gr_data_tab->* TO <fs_data_tab> . \" \u52a8\u6001\u5904\u7406 DATA l_row TYPE i VALUE 2 . \" \u8df3\u8fc7\u62ac\u5934\u5217\u548c\u62ac\u5934\u6587\u672c\u5217 DATA ( l_row_last ) = lo_sheet -> get_last_row_number ( ). DATA l_column TYPE i . DATA l_value TYPE string . WHILE l_row < l_row_last . l_row = l_row + 1 . INSERT INITIAL LINE INTO TABLE <fs_data_tab> ASSIGNING <fs_data> . CLEAR l_column . LOOP AT gt_fieldcat INTO DATA ( ls_fieldcat ). l_column = l_column + 1 . UNASSIGN <fs_field> . ASSIGN COMPONENT ls_fieldcat - fieldname OF STRUCTURE <fs_data> TO <fs_field> . IF <fs_field> IS ASSIGNED . l_value = lo_sheet -> get_cell_content ( iv_row = l_row iv_column = l_column ). PERFORM conv USING 'INPUT' l_value CHANGING <fs_field> . ENDIF . ENDLOOP . ENDWHILE . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_download_template *&---------------------------------------------------------------------* *& \u4e0b\u8f7d\u5bfc\u5165\u6a21\u677f *&---------------------------------------------------------------------* FORM frm_download_template . TRY . DATA ( lo_xlsx ) = cl_ehfnd_xlsx => get_instance ( ). DATA ( lo_doc ) = lo_xlsx -> create_doc ( ). DATA ( lt_sheet_info ) = lo_doc -> get_sheets ( ). DATA ( lo_sheet ) = lo_doc -> get_sheet_by_id ( lt_sheet_info [ 1 ] - sheet_id ). CATCH cx_openxml_format cx_openxml_not_found cx_openxml_not_allowed INTO DATA ( lx_root ). MESSAGE lx_root -> get_text ( ) TYPE 'S' DISPLAY LIKE 'E' . LEAVE LIST - PROCESSING . ENDTRY . DATA l_row TYPE i . DATA l_column TYPE i . LOOP AT gt_fieldcat ASSIGNING FIELD - SYMBOL ( <fs_fieldcat> ). l_column = sy - tabix . lo_sheet -> set_cell_content ( \" \u5b57\u6bb5\u540d EXPORTING iv_row = 1 iv_column = l_column iv_value = <fs_fieldcat> - fieldname ). lo_sheet -> set_cell_content ( \" \u62ac\u5934\u6587\u672c EXPORTING iv_row = 2 iv_column = l_column iv_value = <fs_fieldcat> - scrtext_l ). ENDLOOP . IF p_dbdata = abap_true . FIELD-SYMBOLS <fs_table> TYPE STANDARD TABLE . FIELD-SYMBOLS <fs_structure> TYPE any . FIELD-SYMBOLS <fs_field> TYPE any . ASSIGN gr_data_tab->* TO <fs_table> . SELECT * FROM ( p_tabnam ) INTO TABLE @ <fs_table> . l_row = 2 . \" \u4ece\u7b2c\u4e09\u884c\u5f00\u59cb\u586b\u5145\u6570\u636e LOOP AT <fs_table> ASSIGNING <fs_structure> . l_row = l_row + 1 . CLEAR l_column . LOOP AT gt_fieldcat ASSIGNING <fs_fieldcat> . l_column = l_column + 1 . UNASSIGN <fs_field> . ASSIGN COMPONENT <fs_fieldcat> - fieldname OF STRUCTURE <fs_structure> TO <fs_field> . IF <fs_field> IS ASSIGNED . lo_sheet -> set_cell_content ( EXPORTING iv_row = l_row iv_column = l_column iv_value = <fs_field> ). ENDIF . ENDLOOP . ENDLOOP . ENDIF . \" \u83b7\u53d6\u4e0b\u8f7d\u76ee\u6807 DATA ( l_filename ) = cl_openxml_helper => browse_local_file_save ( iv_title = 'Save as' iv_filename = |{ p_tabnam } .xlsx | iv_extpattern = '*.xlsx|*.xlsx' ). CHECK l_filename IS NOT INITIAL . p_file = l_filename . \" \u987a\u4fbf\u66f4\u65b0\u4e0b\u9009\u62e9\u5c4f\u5e55 TRY . cl_openxml_helper => store_local_file ( im_file_name = l_filename im_data = lo_doc -> save ( ) ). CATCH cx_openxml_format cx_openxml_not_found cx_openxml_not_allowed cx_dynamic_check INTO DATA ( lx_openxml ). MESSAGE lx_openxml -> get_longtext ( ) TYPE 'S' DISPLAY LIKE 'E' . LEAVE LIST - PROCESSING . ENDTRY . ENDFORM . *&---------------------------------------------------------------------* *& Form conv *&---------------------------------------------------------------------* *& \u6570\u636e\u8f6c\u6362 *&---------------------------------------------------------------------* FORM conv USING dataflow input CHANGING output . DATA l_subrc TYPE subrc VALUE 4 . DATA l_value TYPE string . DATA l_convexit TYPE string . DATA l_fm_convexit TYPE rs38l_fnam . \" \u8f6c\u6362\u4f8b\u7a0b\u51fd\u6570 DESCRIBE FIELD output TYPE DATA ( l_type ) EDIT MASK DATA ( l_mask ). \" EDIT MASK\u53d6\u51fa\u6765\u7684\u503c\u5982\uff1a==ALPHA\u3001==MATN1 CLEAR l_convexit . IF strlen ( l_mask ) > 2 . l_convexit = l_mask + 2 . ELSEIF l_type = 'N' . \" \u5982\u679c\u662fNUMC\u7c7b\u578b\uff0c\u9ed8\u8ba4ALPHA\u8f6c\u6362 l_convexit = 'ALPHA' . ENDIF . CASE l_type . WHEN 'D' OR 'T' . \" \u65e5\u671f\u65f6\u95f4\u683c\u5f0f l_value = input . REPLACE ALL OCCURRENCES OF REGEX '[^0-9]' IN l_value WITH '' . output = l_value . WHEN OTHERS . \" \u68c0\u67e5\u5b57\u6bb5\u662f\u5426\u6709\u8f93\u51fa\u8f6c\u6362 IF l_convexit IS INITIAL . output = input . ELSE . TRY . \" EDIT MASK\u4e0d\u652f\u6301STRING\uff0c\u8fd8\u662f\u8981\u7528CONVEXIT\u7684\u65b9\u6cd5 l_fm_convexit = | CONVERSION_EXIT_ { l_convexit } _ { dataflow }|. CALL FUNCTION l_fm_convexit EXPORTING input = input IMPORTING output = output EXCEPTIONS OTHERS = 99 . IF sy - subrc <> 0 . output = input . \" \u8f6c\u6362\u9519\u8bef\uff0c\u76f4\u63a5\u8f93\u5165 ENDIF . CATCH cx_root . output = input . ENDTRY . ENDIF . ENDCASE . \" CONDENSE\u5fc5\u987b\u662fCharacter-Like IF l_type = 'C' OR l_type = 'N' OR l_type = 'g' . CONDENSE output . \" \u53bb\u9664\u591a\u4f59\u7a7a\u683c ENDIF . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_import *&---------------------------------------------------------------------* *& \u4fdd\u5b58 *&---------------------------------------------------------------------* FORM frm_import . * READ TABLE gt_field TRANSPORTING NO FIELDS WITH KEY zsel = 'X'. * IF sy-subrc <> 0. * MESSAGE '\u8bf7\u9009\u62e9\u9700\u8981\u66f4\u65b0\u7684\u5217' TYPE 'S' DISPLAY LIKE 'E'. * RETURN. * ENDIF. * * DATA l_answer. * CALL FUNCTION 'POPUP_TO_CONFIRM' * EXPORTING * text_question = '\u8be5\u8be5\u64cd\u4f5c\u4e0d\u53ef\u56de\u6eda\uff0c\u662f\u5426\u6267\u884c\uff1f' * IMPORTING * answer = l_answer * EXCEPTIONS * text_not_found = 1 * OTHERS = 2. * IF l_answer <> '1'. * RETURN. * ENDIF. FIELD-SYMBOLS <gt_data> TYPE STANDARD TABLE . ASSIGN gr_data_tab->* TO <gt_data> . \" \u590d\u5236\u5c40\u90e8\u53c2\u6570 FIELD-SYMBOLS <lt_data> TYPE STANDARD TABLE . DATA lr_data_tab TYPE REF TO data . CREATE DATA lr_data_tab LIKE <gt_data> . ASSIGN lr_data_tab->* TO <lt_data> . \" \u4ec5\u5bfc\u5165\u9009\u53d6\u884c LOOP AT gt_rows INTO DATA ( ls_rows ). READ TABLE <gt_data> ASSIGNING FIELD - SYMBOL ( <ls_data> ) INDEX ls_rows . IF sy - subrc = 0 . INSERT <ls_data> INTO TABLE <lt_data> . ENDIF . ENDLOOP . READ TABLE gt_fieldcat TRANSPORTING NO FIELDS WITH KEY key = '' . IF sy - subrc = 0 . \" \u5305\u62ec\u666e\u901a\u4e3b\u952e\uff0c\u53ef\u4ee5\u76f4\u63a5MODIFY MODIFY ( p_tabnam ) FROM TABLE <lt_data> []. ELSE . \" \u5168\u4e3b\u952e\uff0c\u9700\u8981\u5220\u9664\u518d\u63d2\u5165 DELETE ( p_tabnam ) FROM TABLE <lt_data> []. IF sy - subrc = 0 . INSERT ( p_tabnam ) FROM TABLE <lt_data> []. ENDIF . ENDIF . IF sy - subrc = 0 . COMMIT WORK AND WAIT . DATA ( l_msg ) = | \u5df2\u5904\u7406\uff0c\u5171[ { lines ( <lt_data> ) } ]\u884c |. MESSAGE l_msg TYPE 'S' . ELSE . ROLLBACK WORK . l_msg = | \u5904\u7406\u5931\u8d25 |. MESSAGE l_msg TYPE 'S' DISPLAY LIKE 'E' . ENDIF . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_display *&---------------------------------------------------------------------* *& \u6570\u636e\u5c55\u793a *&---------------------------------------------------------------------* FORM frm_display . DATA ls_layout TYPE lvc_s_layo . DATA lt_fieldcat TYPE lvc_t_fcat . PERFORM frm_set_layout CHANGING ls_layout . PERFORM frm_set_fieldcat TABLES lt_fieldcat . lt_fieldcat = gt_fieldcat . FIELD-SYMBOLS <fs_data_tab> TYPE STANDARD TABLE . ASSIGN gr_data_tab->* TO <fs_data_tab> . CALL FUNCTION 'REUSE_ALV_GRID_DISPLAY_LVC' EXPORTING i_callback_program = sy - repid i_callback_pf_status_set = 'FRM_PF_STATUS' i_callback_user_command = 'FRM_USER_COMMAND' is_layout_lvc = ls_layout it_fieldcat_lvc = lt_fieldcat i_default = abap_true i_save = 'A' TABLES t_outtab = <fs_data_tab> [] EXCEPTIONS program_error = 1 OTHERS = 2 . IF sy - subrc <> 0 . MESSAGE ID sy - msgid TYPE sy - msgty NUMBER sy - msgno WITH sy - msgv1 sy - msgv2 sy - msgv3 sy - msgv4 . ENDIF . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_set_layout *&---------------------------------------------------------------------* *& \u9ed8\u8ba4\u5e03\u5c40 *&---------------------------------------------------------------------* FORM frm_set_layout CHANGING cs_layout TYPE lvc_s_layo . CLEAR cs_layout . cs_layout - zebra = abap_true . \" \u6591\u9a6c\u7ebf cs_layout - cwidth_opt = abap_true . \" \u81ea\u52a8\u8c03\u6574ALVL\u5217\u5bbd cs_layout - sel_mode = 'A' . \" \u9009\u62e9\u6a21\u5f0f ENDFORM . *&---------------------------------------------------------------------* *& Form frm_set_fieldcat *&---------------------------------------------------------------------* *& \u5b57\u6bb5\u76ee\u5f55 *&---------------------------------------------------------------------* FORM frm_set_fieldcat TABLES ct_fieldcat TYPE lvc_t_fcat . ct_fieldcat[] = gt_fieldcat . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_set_fieldcat_fields *&---------------------------------------------------------------------* *& \u66f4\u65b0\u5b57\u6bb5ALV\u7684\u5b57\u6bb5\u76ee\u5f55 *&---------------------------------------------------------------------* FORM frm_set_fieldcat_fields TABLES ct_fieldcat TYPE lvc_t_fcat . DATA ls_fieldcat TYPE lvc_s_fcat . DEFINE _init_fieldcat . CLEAR ls_fieldcat . ls_fieldcat - fieldname = &1 . ls_fieldcat - tooltip = ls_fieldcat - coltext = ls_fieldcat - seltext = ls_fieldcat - scrtext_l = ls_fieldcat - scrtext_m = ls_fieldcat - scrtext_s = &2 . ls_fieldcat - ref_table = &3 . ls_fieldcat - ref_field = &4 . INSERT ls_fieldcat INTO TABLE ct_fieldcat . END-OF-DEFINITION . _init_fieldcat 'ZSEL' '\u66f4\u65b0\u9879' '' '' . _init_fieldcat 'ZNAME' '\u5b57\u6bb5\u540d' '' '' . _init_fieldcat 'ZTEXT' '\u5b57\u6bb5\u63cf\u8ff0' '' '' . _init_fieldcat 'ZKEY' '\u4e3b\u952e' '' '' . LOOP AT ct_fieldcat REFERENCE INTO DATA ( lr_fieldcat ). IF lr_fieldcat -> fieldname = 'ZSEL' OR lr_fieldcat -> fieldname = 'ZKEY' . lr_fieldcat -> checkbox = abap_true . ENDIF . IF lr_fieldcat -> fieldname = 'ZSEL' . lr_fieldcat -> edit = abap_true . ENDIF . ENDLOOP . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_pf_status *&---------------------------------------------------------------------* *& \u8bbe\u7f6eGUI\u72b6\u6001 *&---------------------------------------------------------------------* FORM frm_pf_status USING ct_extab TYPE slis_t_extab . SET PF-STATUS 'STATUS' . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_user_command *&---------------------------------------------------------------------* *& \u529f\u80fd\u54cd\u5e94 *&---------------------------------------------------------------------* FORM frm_user_command USING cv_ucomm LIKE sy - ucomm cs_selfield TYPE slis_selfield . \" \u5237\u65b0\u5c4f\u5e55\u6570\u636e\u5230\u5185\u8868 DATA : lo_grid TYPE REF TO cl_gui_alv_grid . CALL FUNCTION 'GET_GLOBALS_FROM_SLVC_FULLSCR' IMPORTING e_grid = lo_grid . CALL METHOD lo_grid -> check_changed_data . \" \u83b7\u53d6ALV\u9009\u53d6\u884c CLEAR gt_rows . CALL METHOD lo_grid -> get_selected_rows IMPORTING et_index_rows = gt_rows . \" \u6309\u94ae\u529f\u80fd\u5b9e\u73b0 CASE cv_ucomm . WHEN 'IMPORT' . * PERFORM frm_display_fields. PERFORM frm_import . WHEN OTHERS . ENDCASE . \" \u5237\u65b0ALV \u663e\u793a\u503c cs_selfield - refresh = abap_true . cs_selfield - row_stable = abap_true . cs_selfield - col_stable = abap_true . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_display_fields *&---------------------------------------------------------------------* *& \u5f39\u7a97\u5c55\u793a\u9009\u53d6\u66f4\u65b0\u5217ALV *&---------------------------------------------------------------------* FORM frm_display_fields . CLEAR gt_field . DATA ls_field TYPE ty_field . LOOP AT gt_fieldcat INTO DATA ( ls_fieldcat ). CLEAR ls_field . ls_field - zname = ls_fieldcat - fieldname . ls_field - ztext = ls_fieldcat - scrtext_l . ls_field - zkey = ls_fieldcat - key . IF ls_field - zkey IS NOT INITIAL . ls_field - zsel = abap_true . ENDIF . INSERT ls_field INTO TABLE gt_field . ENDLOOP . \" \u4e8b\u4ef6 IF go_event_handler IS NOT BOUND . go_event_handler = NEW # ( ). ENDIF . \" \u5f39\u7a97\u5bb9\u5668 IF go_con_fields IS NOT BOUND . go_con_fields = NEW cl_gui_dialogbox_container ( width = 480 height = 320 top = 5 left = 240 ). SET HANDLER go_event_handler -> on_dialogbox_close FOR go_con_fields . ENDIF . \" ALV GRID IF go_grid_fields IS NOT BOUND . DATA ls_layout TYPE lvc_s_layo . DATA lt_fieldcat TYPE STANDARD TABLE OF lvc_s_fcat . PERFORM frm_set_layout CHANGING ls_layout . PERFORM frm_set_fieldcat_fields TABLES lt_fieldcat . go_grid_fields = NEW # ( go_con_fields ). CALL METHOD go_grid_fields -> set_table_for_first_display EXPORTING is_layout = ls_layout CHANGING it_outtab = gt_field it_fieldcatalog = lt_fieldcat EXCEPTIONS invalid_parameter_combination = 1 program_error = 2 too_many_lines = 3 OTHERS = 4 . SET HANDLER go_event_handler -> on_toolbar FOR go_grid_fields . SET HANDLER go_event_handler -> on_user_command FOR go_grid_fields . ELSE . go_grid_fields -> refresh_table_display ( is_stable = CONV # ( 'XX' ) ). ENDIF . go_con_fields -> set_visible ( cl_gui_dialogbox_container => visible_true ). ENDFORM . *&---------------------------------------------------------------------* *& *&---------------------------------------------------------------------* START-OF-SELECTION . PERFORM frm_main .","title":"\u5bfc\u8868\u7a0b\u5e8f"},{"location":"others/zdataimport/#_1","text":"\u5c0f\u5fc3\u522b\u628a\u6807\u51c6\u8868\u7684\u6570\u636e\u8986\u76d6\u4e86 \u8fd8\u6709\u4e2a\u9009\u62e9\u5bfc\u5165\u5217\u7684\u529f\u80fd\uff0c\u540e\u9762\u6709\u7a7a\u518d\u8865\u5145 \u793a\u4f8b\u4ee3\u7801 *&---------------------------------------------------------------------* *& Report ZDATAIMPORT *&---------------------------------------------------------------------* *& 1 2022\u5e749\u670816\u65e5 \u521d\u59cb *&---------------------------------------------------------------------* REPORT zdataimport . *&---------------------------------------------------------------------* *& \u7c7b\u578b\u5b9a\u4e49 *&---------------------------------------------------------------------* \" \u7528\u4e8e\u9009\u53d6\u66f4\u65b0\u5217 TYPES : BEGIN OF ty_field , zname TYPE lvc_s_fcat - fieldname , ztext TYPE lvc_s_fcat - scrtext_l , zkey TYPE xfeld , zsel TYPE xfeld , END OF ty_field . TYPES tt_field TYPE STANDARD TABLE OF ty_field . *&---------------------------------------------------------------------* *& \u672c\u5730\u7c7b\u58f0\u660e *&---------------------------------------------------------------------* CLASS lcl_event_handler DEFINITION DEFERRED . *&---------------------------------------------------------------------* *& \u672c\u5730\u7c7b\u5b9a\u4e49 *&---------------------------------------------------------------------* CLASS lcl_event_handler DEFINITION . PUBLIC SECTION . METHODS on_dialogbox_close FOR EVENT close OF cl_gui_dialogbox_container IMPORTING sender . METHODS on_toolbar FOR EVENT toolbar OF cl_gui_alv_grid IMPORTING e_object e_interactive . METHODS on_user_command FOR EVENT user_command OF cl_gui_alv_grid IMPORTING e_ucomm . ENDCLASS . *&---------------------------------------------------------------------* *& \u672c\u5730\u7c7b\u5b9a\u4e49 *&---------------------------------------------------------------------* CLASS lcl_event_handler IMPLEMENTATION . *&---------------------------------------------------------------------* *& on_dialogbox_close *&---------------------------------------------------------------------* METHOD on_dialogbox_close . \" \u9690\u85cf\u5373\u53ef\uff0c\u91cd\u590d\u521b\u5efa\u6ca1\u5fc5\u8981 IF sender IS NOT INITIAL . sender -> set_visible ( cl_gui_dialogbox_container => visible_false ). ENDIF . ENDMETHOD . *&---------------------------------------------------------------------* *& on_toolbar *&---------------------------------------------------------------------* METHOD on_toolbar . \" \u79fb\u9664\u7f16\u8f91\u76f8\u5173\u7684\u6309\u94ae DELETE e_object -> mt_toolbar WHERE function CS '&LOCAL&' . \" \u65b0\u589e\u6309\u94ae DATA ls_button LIKE LINE OF e_object -> mt_toolbar . CLEAR ls_button . ls_button - function = 'Z10' . ls_button - icon = icon_execute_object . ls_button - quickinfo = ls_button - text = '\u786e\u8ba4\u5bfc\u5165' . INSERT ls_button INTO TABLE e_object -> mt_toolbar . ENDMETHOD . *&---------------------------------------------------------------------* *& on_user_command *&---------------------------------------------------------------------* METHOD on_user_command . IF e_ucomm = 'Z10' . PERFORM frm_import . ENDIF . ENDMETHOD . ENDCLASS . *&---------------------------------------------------------------------* *& TOP *&---------------------------------------------------------------------* DATA gr_data_tab TYPE REF TO data . DATA gt_fieldcat TYPE lvc_t_fcat . DATA gt_rows TYPE lvc_t_row . \" \u9009\u53d6\u884c\u9879\u76ee \" \u5f39\u7a97\u9009\u62e9\u9700\u8981\u66f4\u65b0\u7684\u5217 DATA go_con_fields TYPE REF TO cl_gui_dialogbox_container . DATA go_grid_fields TYPE REF TO cl_gui_alv_grid . *DATA gt_fieldcat TYPE lvc_t_fcat. \" \u91cd\u540d\uff0c\u60f3\u4e86\u60f3\uff0c\u8bbe\u7f6e\u4e3a\u5c40\u90e8\u53c2\u6570\u4f20\u503c\u5373\u53ef DATA gt_field TYPE tt_field . \" \u4e8b\u4ef6\u7c7b DATA go_event_handler TYPE REF TO lcl_event_handler . *&---------------------------------------------------------------------* *& \u9009\u62e9\u5c4f\u5e55 *&---------------------------------------------------------------------* PARAMETERS : rb1 RADIOBUTTON GROUP rg1 USER - COMMAND rg1 DEFAULT 'X' , \" \u4e0a\u4f20\u6570\u636e rb2 RADIOBUTTON GROUP rg1 . \" \u4e0b\u8f7d\u6a21\u677f PARAMETERS p_tabnam TYPE tabname16 . PARAMETERS p_file TYPE rlgrap - filename MODIF ID m1 . PARAMETERS p_dbdata TYPE xfeld MODIF ID m2 . \" \u5305\u62ec\u8868\u6570\u636e SELECTION-SCREEN ULINE . SELECTION-SCREEN COMMENT / 2 ( 70 ) comm1 . *&---------------------------------------------------------------------* *& INITIALIZATION *&---------------------------------------------------------------------* INITIALIZATION . PERFORM frm_initialization . *&---------------------------------------------------------------------* *& AT SELECTION-SCREEN *&---------------------------------------------------------------------* AT SELECTION-SCREEN OUTPUT . PERFORM frm_set_screen . *&---------------------------------------------------------------------* *& AT SELECTION-SCREEN *&---------------------------------------------------------------------* AT SELECTION-SCREEN ON VALUE-REQUEST FOR p_file . PERFORM frm_f4_file CHANGING p_file . *&---------------------------------------------------------------------* *& Form frm_set_screen *&---------------------------------------------------------------------* *& \u9009\u62e9\u5c4f\u5e55\u63a7\u5236 *&---------------------------------------------------------------------* FORM frm_set_screen . LOOP AT SCREEN . CASE screen - group1 . WHEN 'M1' . IF rb2 = 'X' . screen - active = '0' . screen - invisible = '1' . ELSE . screen - active = '1' . screen - invisible = '0' . ENDIF . MODIFY SCREEN . WHEN 'M2' . IF rb1 = 'X' . screen - active = '0' . screen - invisible = '1' . ELSE . screen - active = '1' . screen - invisible = '0' . ENDIF . MODIFY SCREEN . ENDCASE . ENDLOOP . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_f4_file *&---------------------------------------------------------------------* *& \u6587\u4ef6\u641c\u7d22\u5e2e\u52a9 *&---------------------------------------------------------------------* FORM frm_f4_file CHANGING c_file TYPE rlgrap - filename . c_file = cl_openxml_helper => browse_local_file_open ( EXPORTING iv_title = 'Open' iv_filename = 'import.xlsx' iv_extpattern = '*.xlsx' ). ENDFORM . *&---------------------------------------------------------------------* *& Form frm_initialization *&---------------------------------------------------------------------* *& \u7a0b\u5e8f\u521d\u59cb\u5316 *&---------------------------------------------------------------------* FORM frm_initialization . GET PARAMETER ID 'DTB' FIELD p_tabnam . GET PARAMETER ID 'ZF' FIELD p_file . % _rb1_ % _app_ % - text = '\u6279\u91cf\u5bfc\u5165' . % _rb2_ % _app_ % - text = '\u4e0b\u8f7d\u6279\u5bfc\u6a21\u677f' . % _p_tabnam_ % _app_ % - text = '\u8868\u540d' . % _p_file_ % _app_ % - text = '\u6587\u4ef6\u8def\u5f84' . % _p_dbdata_ % _app_ % - text = '\u5305\u62ec\u6570\u636e\u5e93\u8868\u6570\u636e' . comm1 = '\u5907\u6ce8\uff1a\u7b2c\u4e00\u884c\u4e3a\u5b57\u6bb5\u540d\u79f0\uff0c\u7b2c\u4e8c\u884c\u4e3a\u62ac\u5934\u6587\u672c\uff0c\u7b2c\u4e09\u884c\u53ca\u540e\u7eed\u4e3a\u6570\u636e\u884c' . ENDFORM . *&---------------------------------------------------------------------* *& Form FRM_MAIN *&---------------------------------------------------------------------* *& \u7a0b\u5e8f\u5165\u53e3 *&---------------------------------------------------------------------* FORM frm_main . CHECK sy - tcode <> 'ZDATAIMPORT' . SET PARAMETER ID 'DTB' FIELD p_tabnam . SET PARAMETER ID 'ZF' FIELD p_file . PERFORM frm_create_dynamic_table . \" \u521b\u5efa\u52a8\u6001\u8868\u683c CASE 'X' . WHEN rb1 . PERFORM frm_upload_data . PERFORM frm_display . WHEN rb2 . PERFORM frm_download_template . ENDCASE . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_create_dynamic_table *&---------------------------------------------------------------------* *& \u521b\u5efa\u8868\u683c\u6570\u636e\u8868\u683c *&---------------------------------------------------------------------* FORM frm_create_dynamic_table . PERFORM frm_check_input . TRY . CREATE DATA gr_data_tab TYPE STANDARD TABLE OF ( p_tabnam ). CATCH cx_root INTO DATA ( lx_root ). MESSAGE lx_root -> get_text ( ) TYPE 'E' . ENDTRY . DATA l_name TYPE dd02l - tabname . l_name = p_tabnam . CALL FUNCTION 'LVC_FIELDCATALOG_MERGE' EXPORTING i_structure_name = l_name i_bypassing_buffer = 'X' CHANGING ct_fieldcat = gt_fieldcat EXCEPTIONS inconsistent_interface = 1 program_error = 2 OTHERS = 3 . IF sy - subrc <> 0 . * MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno * WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4. ENDIF . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_check_input *&---------------------------------------------------------------------* *& \u8f93\u5165\u6821\u9a8c *&---------------------------------------------------------------------* FORM frm_check_input . IF p_tabnam IS INITIAL . MESSAGE | \u8bf7\u8f93\u5165\u8868\u540d | TYPE 'S' DISPLAY LIKE 'E' . LEAVE LIST - PROCESSING . ENDIF . IF p_tabnam ( 1 ) = 'Z' OR p_tabnam ( 1 ) = 'Y' . ELSE . MESSAGE | \u8868 { p_tabnam } \u975e\u81ea\u5efa\u8868\uff0c\u4e0d\u5141\u8bb8\u4fee\u6539 | TYPE 'S' DISPLAY LIKE 'E' . LEAVE LIST - PROCESSING . ENDIF . SELECT SINGLE COUNT ( * ) FROM dd02l WHERE tabname = @ p_tabnam . IF sy - subrc <> 0 . MESSAGE | \u8868 { p_tabnam } \u4e0d\u5b58\u5728 | TYPE 'S' DISPLAY LIKE 'E' . LEAVE LIST - PROCESSING . ENDIF . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_upload_data *&---------------------------------------------------------------------* *& \u4e0a\u4f20\u6587\u4ef6 *&---------------------------------------------------------------------* FORM frm_upload_data . TRY . DATA ( l_buffer ) = cl_openxml_helper => load_local_file ( CONV # ( p_file ) ). DATA ( lo_xlsx ) = cl_ehfnd_xlsx => get_instance ( ). DATA ( lo_doc ) = lo_xlsx -> load_doc ( l_buffer ). DATA ( lt_sheet_info ) = lo_doc -> get_sheets ( ). DATA ( lo_sheet ) = lo_doc -> get_sheet_by_id ( lt_sheet_info [ 1 ] - sheet_id ). CATCH cx_openxml_format cx_openxml_not_found cx_openxml_not_allowed INTO DATA ( lx_root ). MESSAGE lx_root -> get_text ( ) TYPE 'S' DISPLAY LIKE 'E' . LEAVE LIST - PROCESSING . ENDTRY . FIELD-SYMBOLS <fs_data_tab> TYPE STANDARD TABLE . FIELD-SYMBOLS <fs_data> TYPE any . FIELD-SYMBOLS <fs_field> TYPE any . ASSIGN gr_data_tab->* TO <fs_data_tab> . \" \u52a8\u6001\u5904\u7406 DATA l_row TYPE i VALUE 2 . \" \u8df3\u8fc7\u62ac\u5934\u5217\u548c\u62ac\u5934\u6587\u672c\u5217 DATA ( l_row_last ) = lo_sheet -> get_last_row_number ( ). DATA l_column TYPE i . DATA l_value TYPE string . WHILE l_row < l_row_last . l_row = l_row + 1 . INSERT INITIAL LINE INTO TABLE <fs_data_tab> ASSIGNING <fs_data> . CLEAR l_column . LOOP AT gt_fieldcat INTO DATA ( ls_fieldcat ). l_column = l_column + 1 . UNASSIGN <fs_field> . ASSIGN COMPONENT ls_fieldcat - fieldname OF STRUCTURE <fs_data> TO <fs_field> . IF <fs_field> IS ASSIGNED . l_value = lo_sheet -> get_cell_content ( iv_row = l_row iv_column = l_column ). PERFORM conv USING 'INPUT' l_value CHANGING <fs_field> . ENDIF . ENDLOOP . ENDWHILE . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_download_template *&---------------------------------------------------------------------* *& \u4e0b\u8f7d\u5bfc\u5165\u6a21\u677f *&---------------------------------------------------------------------* FORM frm_download_template . TRY . DATA ( lo_xlsx ) = cl_ehfnd_xlsx => get_instance ( ). DATA ( lo_doc ) = lo_xlsx -> create_doc ( ). DATA ( lt_sheet_info ) = lo_doc -> get_sheets ( ). DATA ( lo_sheet ) = lo_doc -> get_sheet_by_id ( lt_sheet_info [ 1 ] - sheet_id ). CATCH cx_openxml_format cx_openxml_not_found cx_openxml_not_allowed INTO DATA ( lx_root ). MESSAGE lx_root -> get_text ( ) TYPE 'S' DISPLAY LIKE 'E' . LEAVE LIST - PROCESSING . ENDTRY . DATA l_row TYPE i . DATA l_column TYPE i . LOOP AT gt_fieldcat ASSIGNING FIELD - SYMBOL ( <fs_fieldcat> ). l_column = sy - tabix . lo_sheet -> set_cell_content ( \" \u5b57\u6bb5\u540d EXPORTING iv_row = 1 iv_column = l_column iv_value = <fs_fieldcat> - fieldname ). lo_sheet -> set_cell_content ( \" \u62ac\u5934\u6587\u672c EXPORTING iv_row = 2 iv_column = l_column iv_value = <fs_fieldcat> - scrtext_l ). ENDLOOP . IF p_dbdata = abap_true . FIELD-SYMBOLS <fs_table> TYPE STANDARD TABLE . FIELD-SYMBOLS <fs_structure> TYPE any . FIELD-SYMBOLS <fs_field> TYPE any . ASSIGN gr_data_tab->* TO <fs_table> . SELECT * FROM ( p_tabnam ) INTO TABLE @ <fs_table> . l_row = 2 . \" \u4ece\u7b2c\u4e09\u884c\u5f00\u59cb\u586b\u5145\u6570\u636e LOOP AT <fs_table> ASSIGNING <fs_structure> . l_row = l_row + 1 . CLEAR l_column . LOOP AT gt_fieldcat ASSIGNING <fs_fieldcat> . l_column = l_column + 1 . UNASSIGN <fs_field> . ASSIGN COMPONENT <fs_fieldcat> - fieldname OF STRUCTURE <fs_structure> TO <fs_field> . IF <fs_field> IS ASSIGNED . lo_sheet -> set_cell_content ( EXPORTING iv_row = l_row iv_column = l_column iv_value = <fs_field> ). ENDIF . ENDLOOP . ENDLOOP . ENDIF . \" \u83b7\u53d6\u4e0b\u8f7d\u76ee\u6807 DATA ( l_filename ) = cl_openxml_helper => browse_local_file_save ( iv_title = 'Save as' iv_filename = |{ p_tabnam } .xlsx | iv_extpattern = '*.xlsx|*.xlsx' ). CHECK l_filename IS NOT INITIAL . p_file = l_filename . \" \u987a\u4fbf\u66f4\u65b0\u4e0b\u9009\u62e9\u5c4f\u5e55 TRY . cl_openxml_helper => store_local_file ( im_file_name = l_filename im_data = lo_doc -> save ( ) ). CATCH cx_openxml_format cx_openxml_not_found cx_openxml_not_allowed cx_dynamic_check INTO DATA ( lx_openxml ). MESSAGE lx_openxml -> get_longtext ( ) TYPE 'S' DISPLAY LIKE 'E' . LEAVE LIST - PROCESSING . ENDTRY . ENDFORM . *&---------------------------------------------------------------------* *& Form conv *&---------------------------------------------------------------------* *& \u6570\u636e\u8f6c\u6362 *&---------------------------------------------------------------------* FORM conv USING dataflow input CHANGING output . DATA l_subrc TYPE subrc VALUE 4 . DATA l_value TYPE string . DATA l_convexit TYPE string . DATA l_fm_convexit TYPE rs38l_fnam . \" \u8f6c\u6362\u4f8b\u7a0b\u51fd\u6570 DESCRIBE FIELD output TYPE DATA ( l_type ) EDIT MASK DATA ( l_mask ). \" EDIT MASK\u53d6\u51fa\u6765\u7684\u503c\u5982\uff1a==ALPHA\u3001==MATN1 CLEAR l_convexit . IF strlen ( l_mask ) > 2 . l_convexit = l_mask + 2 . ELSEIF l_type = 'N' . \" \u5982\u679c\u662fNUMC\u7c7b\u578b\uff0c\u9ed8\u8ba4ALPHA\u8f6c\u6362 l_convexit = 'ALPHA' . ENDIF . CASE l_type . WHEN 'D' OR 'T' . \" \u65e5\u671f\u65f6\u95f4\u683c\u5f0f l_value = input . REPLACE ALL OCCURRENCES OF REGEX '[^0-9]' IN l_value WITH '' . output = l_value . WHEN OTHERS . \" \u68c0\u67e5\u5b57\u6bb5\u662f\u5426\u6709\u8f93\u51fa\u8f6c\u6362 IF l_convexit IS INITIAL . output = input . ELSE . TRY . \" EDIT MASK\u4e0d\u652f\u6301STRING\uff0c\u8fd8\u662f\u8981\u7528CONVEXIT\u7684\u65b9\u6cd5 l_fm_convexit = | CONVERSION_EXIT_ { l_convexit } _ { dataflow }|. CALL FUNCTION l_fm_convexit EXPORTING input = input IMPORTING output = output EXCEPTIONS OTHERS = 99 . IF sy - subrc <> 0 . output = input . \" \u8f6c\u6362\u9519\u8bef\uff0c\u76f4\u63a5\u8f93\u5165 ENDIF . CATCH cx_root . output = input . ENDTRY . ENDIF . ENDCASE . \" CONDENSE\u5fc5\u987b\u662fCharacter-Like IF l_type = 'C' OR l_type = 'N' OR l_type = 'g' . CONDENSE output . \" \u53bb\u9664\u591a\u4f59\u7a7a\u683c ENDIF . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_import *&---------------------------------------------------------------------* *& \u4fdd\u5b58 *&---------------------------------------------------------------------* FORM frm_import . * READ TABLE gt_field TRANSPORTING NO FIELDS WITH KEY zsel = 'X'. * IF sy-subrc <> 0. * MESSAGE '\u8bf7\u9009\u62e9\u9700\u8981\u66f4\u65b0\u7684\u5217' TYPE 'S' DISPLAY LIKE 'E'. * RETURN. * ENDIF. * * DATA l_answer. * CALL FUNCTION 'POPUP_TO_CONFIRM' * EXPORTING * text_question = '\u8be5\u8be5\u64cd\u4f5c\u4e0d\u53ef\u56de\u6eda\uff0c\u662f\u5426\u6267\u884c\uff1f' * IMPORTING * answer = l_answer * EXCEPTIONS * text_not_found = 1 * OTHERS = 2. * IF l_answer <> '1'. * RETURN. * ENDIF. FIELD-SYMBOLS <gt_data> TYPE STANDARD TABLE . ASSIGN gr_data_tab->* TO <gt_data> . \" \u590d\u5236\u5c40\u90e8\u53c2\u6570 FIELD-SYMBOLS <lt_data> TYPE STANDARD TABLE . DATA lr_data_tab TYPE REF TO data . CREATE DATA lr_data_tab LIKE <gt_data> . ASSIGN lr_data_tab->* TO <lt_data> . \" \u4ec5\u5bfc\u5165\u9009\u53d6\u884c LOOP AT gt_rows INTO DATA ( ls_rows ). READ TABLE <gt_data> ASSIGNING FIELD - SYMBOL ( <ls_data> ) INDEX ls_rows . IF sy - subrc = 0 . INSERT <ls_data> INTO TABLE <lt_data> . ENDIF . ENDLOOP . READ TABLE gt_fieldcat TRANSPORTING NO FIELDS WITH KEY key = '' . IF sy - subrc = 0 . \" \u5305\u62ec\u666e\u901a\u4e3b\u952e\uff0c\u53ef\u4ee5\u76f4\u63a5MODIFY MODIFY ( p_tabnam ) FROM TABLE <lt_data> []. ELSE . \" \u5168\u4e3b\u952e\uff0c\u9700\u8981\u5220\u9664\u518d\u63d2\u5165 DELETE ( p_tabnam ) FROM TABLE <lt_data> []. IF sy - subrc = 0 . INSERT ( p_tabnam ) FROM TABLE <lt_data> []. ENDIF . ENDIF . IF sy - subrc = 0 . COMMIT WORK AND WAIT . DATA ( l_msg ) = | \u5df2\u5904\u7406\uff0c\u5171[ { lines ( <lt_data> ) } ]\u884c |. MESSAGE l_msg TYPE 'S' . ELSE . ROLLBACK WORK . l_msg = | \u5904\u7406\u5931\u8d25 |. MESSAGE l_msg TYPE 'S' DISPLAY LIKE 'E' . ENDIF . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_display *&---------------------------------------------------------------------* *& \u6570\u636e\u5c55\u793a *&---------------------------------------------------------------------* FORM frm_display . DATA ls_layout TYPE lvc_s_layo . DATA lt_fieldcat TYPE lvc_t_fcat . PERFORM frm_set_layout CHANGING ls_layout . PERFORM frm_set_fieldcat TABLES lt_fieldcat . lt_fieldcat = gt_fieldcat . FIELD-SYMBOLS <fs_data_tab> TYPE STANDARD TABLE . ASSIGN gr_data_tab->* TO <fs_data_tab> . CALL FUNCTION 'REUSE_ALV_GRID_DISPLAY_LVC' EXPORTING i_callback_program = sy - repid i_callback_pf_status_set = 'FRM_PF_STATUS' i_callback_user_command = 'FRM_USER_COMMAND' is_layout_lvc = ls_layout it_fieldcat_lvc = lt_fieldcat i_default = abap_true i_save = 'A' TABLES t_outtab = <fs_data_tab> [] EXCEPTIONS program_error = 1 OTHERS = 2 . IF sy - subrc <> 0 . MESSAGE ID sy - msgid TYPE sy - msgty NUMBER sy - msgno WITH sy - msgv1 sy - msgv2 sy - msgv3 sy - msgv4 . ENDIF . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_set_layout *&---------------------------------------------------------------------* *& \u9ed8\u8ba4\u5e03\u5c40 *&---------------------------------------------------------------------* FORM frm_set_layout CHANGING cs_layout TYPE lvc_s_layo . CLEAR cs_layout . cs_layout - zebra = abap_true . \" \u6591\u9a6c\u7ebf cs_layout - cwidth_opt = abap_true . \" \u81ea\u52a8\u8c03\u6574ALVL\u5217\u5bbd cs_layout - sel_mode = 'A' . \" \u9009\u62e9\u6a21\u5f0f ENDFORM . *&---------------------------------------------------------------------* *& Form frm_set_fieldcat *&---------------------------------------------------------------------* *& \u5b57\u6bb5\u76ee\u5f55 *&---------------------------------------------------------------------* FORM frm_set_fieldcat TABLES ct_fieldcat TYPE lvc_t_fcat . ct_fieldcat[] = gt_fieldcat . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_set_fieldcat_fields *&---------------------------------------------------------------------* *& \u66f4\u65b0\u5b57\u6bb5ALV\u7684\u5b57\u6bb5\u76ee\u5f55 *&---------------------------------------------------------------------* FORM frm_set_fieldcat_fields TABLES ct_fieldcat TYPE lvc_t_fcat . DATA ls_fieldcat TYPE lvc_s_fcat . DEFINE _init_fieldcat . CLEAR ls_fieldcat . ls_fieldcat - fieldname = &1 . ls_fieldcat - tooltip = ls_fieldcat - coltext = ls_fieldcat - seltext = ls_fieldcat - scrtext_l = ls_fieldcat - scrtext_m = ls_fieldcat - scrtext_s = &2 . ls_fieldcat - ref_table = &3 . ls_fieldcat - ref_field = &4 . INSERT ls_fieldcat INTO TABLE ct_fieldcat . END-OF-DEFINITION . _init_fieldcat 'ZSEL' '\u66f4\u65b0\u9879' '' '' . _init_fieldcat 'ZNAME' '\u5b57\u6bb5\u540d' '' '' . _init_fieldcat 'ZTEXT' '\u5b57\u6bb5\u63cf\u8ff0' '' '' . _init_fieldcat 'ZKEY' '\u4e3b\u952e' '' '' . LOOP AT ct_fieldcat REFERENCE INTO DATA ( lr_fieldcat ). IF lr_fieldcat -> fieldname = 'ZSEL' OR lr_fieldcat -> fieldname = 'ZKEY' . lr_fieldcat -> checkbox = abap_true . ENDIF . IF lr_fieldcat -> fieldname = 'ZSEL' . lr_fieldcat -> edit = abap_true . ENDIF . ENDLOOP . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_pf_status *&---------------------------------------------------------------------* *& \u8bbe\u7f6eGUI\u72b6\u6001 *&---------------------------------------------------------------------* FORM frm_pf_status USING ct_extab TYPE slis_t_extab . SET PF-STATUS 'STATUS' . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_user_command *&---------------------------------------------------------------------* *& \u529f\u80fd\u54cd\u5e94 *&---------------------------------------------------------------------* FORM frm_user_command USING cv_ucomm LIKE sy - ucomm cs_selfield TYPE slis_selfield . \" \u5237\u65b0\u5c4f\u5e55\u6570\u636e\u5230\u5185\u8868 DATA : lo_grid TYPE REF TO cl_gui_alv_grid . CALL FUNCTION 'GET_GLOBALS_FROM_SLVC_FULLSCR' IMPORTING e_grid = lo_grid . CALL METHOD lo_grid -> check_changed_data . \" \u83b7\u53d6ALV\u9009\u53d6\u884c CLEAR gt_rows . CALL METHOD lo_grid -> get_selected_rows IMPORTING et_index_rows = gt_rows . \" \u6309\u94ae\u529f\u80fd\u5b9e\u73b0 CASE cv_ucomm . WHEN 'IMPORT' . * PERFORM frm_display_fields. PERFORM frm_import . WHEN OTHERS . ENDCASE . \" \u5237\u65b0ALV \u663e\u793a\u503c cs_selfield - refresh = abap_true . cs_selfield - row_stable = abap_true . cs_selfield - col_stable = abap_true . ENDFORM . *&---------------------------------------------------------------------* *& Form frm_display_fields *&---------------------------------------------------------------------* *& \u5f39\u7a97\u5c55\u793a\u9009\u53d6\u66f4\u65b0\u5217ALV *&---------------------------------------------------------------------* FORM frm_display_fields . CLEAR gt_field . DATA ls_field TYPE ty_field . LOOP AT gt_fieldcat INTO DATA ( ls_fieldcat ). CLEAR ls_field . ls_field - zname = ls_fieldcat - fieldname . ls_field - ztext = ls_fieldcat - scrtext_l . ls_field - zkey = ls_fieldcat - key . IF ls_field - zkey IS NOT INITIAL . ls_field - zsel = abap_true . ENDIF . INSERT ls_field INTO TABLE gt_field . ENDLOOP . \" \u4e8b\u4ef6 IF go_event_handler IS NOT BOUND . go_event_handler = NEW # ( ). ENDIF . \" \u5f39\u7a97\u5bb9\u5668 IF go_con_fields IS NOT BOUND . go_con_fields = NEW cl_gui_dialogbox_container ( width = 480 height = 320 top = 5 left = 240 ). SET HANDLER go_event_handler -> on_dialogbox_close FOR go_con_fields . ENDIF . \" ALV GRID IF go_grid_fields IS NOT BOUND . DATA ls_layout TYPE lvc_s_layo . DATA lt_fieldcat TYPE STANDARD TABLE OF lvc_s_fcat . PERFORM frm_set_layout CHANGING ls_layout . PERFORM frm_set_fieldcat_fields TABLES lt_fieldcat . go_grid_fields = NEW # ( go_con_fields ). CALL METHOD go_grid_fields -> set_table_for_first_display EXPORTING is_layout = ls_layout CHANGING it_outtab = gt_field it_fieldcatalog = lt_fieldcat EXCEPTIONS invalid_parameter_combination = 1 program_error = 2 too_many_lines = 3 OTHERS = 4 . SET HANDLER go_event_handler -> on_toolbar FOR go_grid_fields . SET HANDLER go_event_handler -> on_user_command FOR go_grid_fields . ELSE . go_grid_fields -> refresh_table_display ( is_stable = CONV # ( 'XX' ) ). ENDIF . go_con_fields -> set_visible ( cl_gui_dialogbox_container => visible_true ). ENDFORM . *&---------------------------------------------------------------------* *& *&---------------------------------------------------------------------* START-OF-SELECTION . PERFORM frm_main .","title":"\u5bfc\u8868\u7a0b\u5e8f"},{"location":"pp/","text":"\u751f\u4ea7\u6a21\u5757\u6982\u8ff0 \u00b6","title":"PP\u6a21\u5757\u6982\u8ff0"},{"location":"pp/#_1","text":"","title":"\u751f\u4ea7\u6a21\u5757\u6982\u8ff0"},{"location":"pp/mrp/","text":"\u7269\u6599\u9700\u6c42\u8ba1\u5212\uff08MRP\uff09 \u00b6","title":"MRP"},{"location":"pp/mrp/#mrp","text":"","title":"\u7269\u6599\u9700\u6c42\u8ba1\u5212\uff08MRP\uff09"},{"location":"pp/pir/","text":"\u8ba1\u5212\u72ec\u7acb\u9700\u6c42\uff08PIR\uff09 \u00b6 PIR\u5220\u9664 \u00b6 \u793a\u4f8b\u4ee3\u7801 *&---------------------------------------------------------------------* *& Form FRM_PIR_DELETE *&---------------------------------------------------------------------* * text *----------------------------------------------------------------------* * -->P_<FS_HEAD>_MATNR text * -->P_P_WERKS text * -->P_P_VERSB text *----------------------------------------------------------------------* FORM frm_pir_delete USING p_matnr TYPE pbim - matnr p_werks TYPE pbim - werks p_versb TYPE pbim - versb . DATA lt_bdcdata TYPE STANDARD TABLE OF bdcdata WITH EMPTY KEY . DEFINE _bdc_dynpro . APPEND VALUE # ( program = &1 dynpro = &2 dynbegin = 'X' ) TO lt_bdcdata . END-OF-DEFINITION . DEFINE _bdc_field . APPEND VALUE # ( fnam = &1 fval = &2 ) TO lt_bdcdata . END-OF-DEFINITION . \" MD62\u7b5b\u9009\u9875\u9762 _bdc_dynpro 'SAPMM60X' '0106' . _bdc_field : 'BDC_OKCODE' '/00' , 'AM60X-MATAW' 'X' , 'AM60X-MATNR' p_matnr , 'AM60X-PRGRP' '' , 'AM60X-PBDNR' '' , 'RM60X-BEDAE' '' , 'AM60X-WERKS' p_werks , 'AM60X-VERAW' 'X' , 'RM60X-VERSB' p_versb . \" \u5168\u9009 _bdc_dynpro 'SAPLM60E' '0200' . _bdc_field : 'BDC_OKCODE' '=ALMK' . \" \u70b9\u51fb\u5220\u9664\u6309\u94ae _bdc_dynpro 'SAPLM60E' '0200' . _bdc_field : 'BDC_OKCODE' '=POLO' . \" \u70b9\u51fb\u786e\u8ba4 _bdc_dynpro 'SAPLSPO1' '0500' . _bdc_field : 'BDC_OKCODE' '=OPT1' . \" \u4fdd\u5b58 _bdc_dynpro 'SAPLM60E' '0200' . _bdc_field : 'BDC_OKCODE' '=SICH' . DATA ls_option TYPE ctu_params . ls_option - dismode = 'N' . \" \u540e\u53f0 ls_option - updmode = 'L' . \" \u672c\u5730 ls_option - nobinpt = 'X' . \" \u6709\u5f39\u7a97\uff0c\u9700\u8981\u542f\u7528\u8fd9\u4e2a\u6807\u8bc6 DATA lt_message TYPE STANDARD TABLE OF bdcmsgcoll WITH EMPTY KEY . CALL TRANSACTION 'MD62' USING lt_bdcdata OPTIONS FROM ls_option MESSAGES INTO lt_message . \" \u4e0d\u7ba1\u5982\u4f55\uff0cBDC\u90fd\u56de\u6eda\u4e0d\u4e86\uff0c\u76f4\u63a5\u63d0\u4ea4\u4e86\u4e8b COMMIT WORK AND WAIT . ENDFORM . \" FRM_PIR_DELETE PIR\u7ef4\u62a4 \u00b6 \u793a\u4f8b\u4ee3\u7801 FORM frm_import_pir . \" \u5bfc\u5165\u6570\u636e\u6821\u9a8c FIELD-SYMBOLS <fs_data_tab> TYPE STANDARD TABLE . ASSIGN gr_data_tab->* TO <fs_data_tab> . CHECK <fs_data_tab> IS NOT INITIAL . \" \u7248\u672c\u4e0b\u5168\u90e8\u8ba1\u5212\u72ec\u7acb\u9700\u6c42 TYPES : BEGIN OF ty_pbim , matnr TYPE pbim - matnr , werks TYPE pbim - werks , bedae TYPE pbim - bedae , versb TYPE pbim - versb , pbdnr TYPE pbim - pbdnr , vervs TYPE pbim - vervs , loevr TYPE pbim - loevr , END OF ty_pbim . TYPES tt_pbim TYPE STANDARD TABLE OF ty_pbim WITH EMPTY KEY . DATA lt_pbim TYPE tt_pbim . \" \u4f30\u8ba1\u662f\u6307\u4ee3\u7269\u6599\uff1f DATA l_bedae TYPE pbim - bedae VALUE 'VSF' . DATA l_pbdnr TYPE pbim - pbdnr VALUE '' . DATA l_vervs TYPE pbim - vervs VALUE 'X' . \" \u67e5\u8be2\u7248\u672c\u4e0b\uff0c\u6240\u6709\u9884\u6d4b\u6570\u636e SELECT matnr werks bedae versb pbdnr vervs loevr FROM pbim INTO TABLE lt_pbim WHERE werks = p_werks AND bedae = l_bedae AND versb = p_versb AND pbdnr = l_pbdnr . SORT lt_pbim BY matnr werks bedae versb pbdnr . \" \u521b\u5efa/\u4fee\u6539 DATA ls_pir_item TYPE bapisitemr . DATA lt_pir_schedule_in TYPE TABLE OF bapisshdin . DATA lt_return TYPE TABLE OF bapireturn1 . \" \u6574\u4f53\u7684\u4e00\u4e2a\u72b6\u6001 DATA l_err TYPE xflag . \" \u9010\u884c\u6267\u884c LOOP AT <fs_data_tab> ASSIGNING <fs_data> . ASSIGN COMPONENT gc_suffix - head OF STRUCTURE <fs_data> TO <fs_head> . ASSIGN COMPONENT gc_suffix - forecast OF STRUCTURE <fs_data> TO FIELD - SYMBOL ( <fs_forecast> ). CLEAR ls_pir_item . ls_pir_item - material = <fs_head> - matnr . \" \u7269\u6599 ls_pir_item - plant = p_werks . \" \u5de5\u5382 ls_pir_item - requ_type = l_bedae . \" \u9700\u6c42\u7c7b\u578b ls_pir_item - version = p_versb . \" \u7248\u672c ls_pir_item - req_number = l_pbdnr . \" \u9700\u6c42\u8ba1\u5212 ls_pir_item - vers_activ = l_vervs . \" \u6fc0\u6d3b CLEAR lt_pir_schedule_in . LOOP AT gt_date_list REFERENCE INTO DATA ( lr_date ). ASSIGN COMPONENT lr_date -> fieldname OF STRUCTURE <fs_forecast> TO FIELD - SYMBOL ( <fs_nump> ). \" \u6709\u4e2a\u7591\u95ee\uff0c\u5bfc\u5165\u4e3a0\u662f\u4e0d\u662f\u5c31\u4e0d\u7528\u5bfc\u5165\u4e86\uff1f IF <fs_nump> IS NOT INITIAL . APPEND VALUE # ( req_date = lr_date -> date req_qty = <fs_nump> date_type = '1' \" \u8868\u793a\uff1a\u5929 prod_ves = <fs_head> - verid ) TO lt_pir_schedule_in REFERENCE INTO DATA ( lr_pir_schedule_in ). ENDIF . ENDLOOP . \" \u68c0\u67e5\u7248\u672c\u4e0b\u7684\u7269\u6599\u662f\u5426\u5b58\u5728 READ TABLE lt_pbim TRANSPORTING NO FIELDS WITH KEY matnr = ls_pir_item - material werks = ls_pir_item - plant bedae = ls_pir_item - requ_type versb = ls_pir_item - version pbdnr = ls_pir_item - req_number BINARY SEARCH . IF sy - subrc = 0 . \" \u5220\u9664\u9700\u8981\u5bfc\u5165\u7684\u884c DELETE lt_pbim INDEX sy - tabix . \" \u4fee\u6539 CALL FUNCTION 'BAPI_REQUIREMENTS_CHANGE' EXPORTING material = ls_pir_item - material plant = ls_pir_item - plant requirementstype = ls_pir_item - requ_type version = ls_pir_item - version reqmtsplannumber = ls_pir_item - req_number vers_activ = ls_pir_item - vers_activ do_commit = ' ' delete_old = 'X' TABLES requirements_schedule_in = lt_pir_schedule_in return = lt_return . ELSE . CLEAR lt_return . CALL FUNCTION 'BAPI_REQUIREMENTS_CREATE' EXPORTING requirements_item = ls_pir_item do_commit = ' ' \" \u6700\u540e\u7edf\u4e00\u63d0\u4ea4\u7edf\u4e00\u56de\u6eda TABLES requirements_schedule_in = lt_pir_schedule_in return = lt_return . ENDIF . \" \u9519\u8bef\u6d88\u606f LOOP AT lt_return REFERENCE INTO DATA ( lr_return ) WHERE type CA 'AXE' . <fs_head> - status = 'E' . <fs_head> - icon = icon_red_light . MESSAGE ID lr_return -> id TYPE lr_return -> type NUMBER lr_return -> number WITH lr_return -> message_v1 lr_return -> message_v2 lr_return -> message_v3 lr_return -> message_v4 INTO DATA ( l_msg ). <fs_head> - message = |{ <fs_head> - message }{ l_msg } ; |. ENDLOOP . IF <fs_head> - status = 'E' . l_err = 'X' . ENDIF . ENDLOOP . \" \u56de\u6eda IF l_err = 'X' . CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK' . RETURN . ENDIF . \" \u4e0d\u51fa\u9519\u7684\u60c5\u51b5\uff0c\u5168\u90e8\u63d0\u4ea4 CHECK l_err = '' . CALL FUNCTION 'BAPI_TRANSACTION_COMMIT' EXPORTING wait = 'X' . \" \u5bfc\u5165\u6210\u529f\u540e\uff0c\u901a\u8fc7BDC\u5220\u9664\u5176\u4ed6\u7248\u672c\u53f7 \" \u4e0d\u5728\u5bfc\u5165\u524d\u5220\u9664\u7684\u539f\u56e0\uff0c\u662f\u4e3a\u4e86\u4fdd\u6301\u6570\u636e\u4e00\u81f4\u6027 \" \uff08BDC\u65e0\u6cd5\u56de\u6eda\uff0c\u5982\u679cBDC\u5220\u9664\u6210\u529f\uff0c\u540e\u9762\u5bfc\u5165\u5931\u8d25\uff0c\u5c06\u65e0\u6cd5\u56de\u9000\u5230\u521d\u59cb\u72b6\u6001\uff09 \" \u5220\u9664\u7684\u9879\u76ee\u65e0\u6cd5\u518d\u6b21\u5220\u9664\uff0c\u6240\u4ee5\u4e5f\u8981\u6392\u9664 DELETE lt_pbim WHERE loevr <> '' . \" \u901a\u8fc7BDC\u5220\u9664\u5176\u4f59\u6ca1\u6709\u5bfc\u5165\u7684\u7269\u6599\u6570\u636e LOOP AT lt_pbim REFERENCE INTO DATA ( lr_pbim ). PERFORM frm_pir_delete USING lr_pbim -> matnr lr_pbim -> werks lr_pbim -> versb . ENDLOOP . ENDFORM . \" frm_import_pir","title":"PIR"},{"location":"pp/pir/#pir","text":"","title":"\u8ba1\u5212\u72ec\u7acb\u9700\u6c42\uff08PIR\uff09"},{"location":"pp/pir/#pir_1","text":"\u793a\u4f8b\u4ee3\u7801 *&---------------------------------------------------------------------* *& Form FRM_PIR_DELETE *&---------------------------------------------------------------------* * text *----------------------------------------------------------------------* * -->P_<FS_HEAD>_MATNR text * -->P_P_WERKS text * -->P_P_VERSB text *----------------------------------------------------------------------* FORM frm_pir_delete USING p_matnr TYPE pbim - matnr p_werks TYPE pbim - werks p_versb TYPE pbim - versb . DATA lt_bdcdata TYPE STANDARD TABLE OF bdcdata WITH EMPTY KEY . DEFINE _bdc_dynpro . APPEND VALUE # ( program = &1 dynpro = &2 dynbegin = 'X' ) TO lt_bdcdata . END-OF-DEFINITION . DEFINE _bdc_field . APPEND VALUE # ( fnam = &1 fval = &2 ) TO lt_bdcdata . END-OF-DEFINITION . \" MD62\u7b5b\u9009\u9875\u9762 _bdc_dynpro 'SAPMM60X' '0106' . _bdc_field : 'BDC_OKCODE' '/00' , 'AM60X-MATAW' 'X' , 'AM60X-MATNR' p_matnr , 'AM60X-PRGRP' '' , 'AM60X-PBDNR' '' , 'RM60X-BEDAE' '' , 'AM60X-WERKS' p_werks , 'AM60X-VERAW' 'X' , 'RM60X-VERSB' p_versb . \" \u5168\u9009 _bdc_dynpro 'SAPLM60E' '0200' . _bdc_field : 'BDC_OKCODE' '=ALMK' . \" \u70b9\u51fb\u5220\u9664\u6309\u94ae _bdc_dynpro 'SAPLM60E' '0200' . _bdc_field : 'BDC_OKCODE' '=POLO' . \" \u70b9\u51fb\u786e\u8ba4 _bdc_dynpro 'SAPLSPO1' '0500' . _bdc_field : 'BDC_OKCODE' '=OPT1' . \" \u4fdd\u5b58 _bdc_dynpro 'SAPLM60E' '0200' . _bdc_field : 'BDC_OKCODE' '=SICH' . DATA ls_option TYPE ctu_params . ls_option - dismode = 'N' . \" \u540e\u53f0 ls_option - updmode = 'L' . \" \u672c\u5730 ls_option - nobinpt = 'X' . \" \u6709\u5f39\u7a97\uff0c\u9700\u8981\u542f\u7528\u8fd9\u4e2a\u6807\u8bc6 DATA lt_message TYPE STANDARD TABLE OF bdcmsgcoll WITH EMPTY KEY . CALL TRANSACTION 'MD62' USING lt_bdcdata OPTIONS FROM ls_option MESSAGES INTO lt_message . \" \u4e0d\u7ba1\u5982\u4f55\uff0cBDC\u90fd\u56de\u6eda\u4e0d\u4e86\uff0c\u76f4\u63a5\u63d0\u4ea4\u4e86\u4e8b COMMIT WORK AND WAIT . ENDFORM . \" FRM_PIR_DELETE","title":"PIR\u5220\u9664"},{"location":"pp/pir/#pir_2","text":"\u793a\u4f8b\u4ee3\u7801 FORM frm_import_pir . \" \u5bfc\u5165\u6570\u636e\u6821\u9a8c FIELD-SYMBOLS <fs_data_tab> TYPE STANDARD TABLE . ASSIGN gr_data_tab->* TO <fs_data_tab> . CHECK <fs_data_tab> IS NOT INITIAL . \" \u7248\u672c\u4e0b\u5168\u90e8\u8ba1\u5212\u72ec\u7acb\u9700\u6c42 TYPES : BEGIN OF ty_pbim , matnr TYPE pbim - matnr , werks TYPE pbim - werks , bedae TYPE pbim - bedae , versb TYPE pbim - versb , pbdnr TYPE pbim - pbdnr , vervs TYPE pbim - vervs , loevr TYPE pbim - loevr , END OF ty_pbim . TYPES tt_pbim TYPE STANDARD TABLE OF ty_pbim WITH EMPTY KEY . DATA lt_pbim TYPE tt_pbim . \" \u4f30\u8ba1\u662f\u6307\u4ee3\u7269\u6599\uff1f DATA l_bedae TYPE pbim - bedae VALUE 'VSF' . DATA l_pbdnr TYPE pbim - pbdnr VALUE '' . DATA l_vervs TYPE pbim - vervs VALUE 'X' . \" \u67e5\u8be2\u7248\u672c\u4e0b\uff0c\u6240\u6709\u9884\u6d4b\u6570\u636e SELECT matnr werks bedae versb pbdnr vervs loevr FROM pbim INTO TABLE lt_pbim WHERE werks = p_werks AND bedae = l_bedae AND versb = p_versb AND pbdnr = l_pbdnr . SORT lt_pbim BY matnr werks bedae versb pbdnr . \" \u521b\u5efa/\u4fee\u6539 DATA ls_pir_item TYPE bapisitemr . DATA lt_pir_schedule_in TYPE TABLE OF bapisshdin . DATA lt_return TYPE TABLE OF bapireturn1 . \" \u6574\u4f53\u7684\u4e00\u4e2a\u72b6\u6001 DATA l_err TYPE xflag . \" \u9010\u884c\u6267\u884c LOOP AT <fs_data_tab> ASSIGNING <fs_data> . ASSIGN COMPONENT gc_suffix - head OF STRUCTURE <fs_data> TO <fs_head> . ASSIGN COMPONENT gc_suffix - forecast OF STRUCTURE <fs_data> TO FIELD - SYMBOL ( <fs_forecast> ). CLEAR ls_pir_item . ls_pir_item - material = <fs_head> - matnr . \" \u7269\u6599 ls_pir_item - plant = p_werks . \" \u5de5\u5382 ls_pir_item - requ_type = l_bedae . \" \u9700\u6c42\u7c7b\u578b ls_pir_item - version = p_versb . \" \u7248\u672c ls_pir_item - req_number = l_pbdnr . \" \u9700\u6c42\u8ba1\u5212 ls_pir_item - vers_activ = l_vervs . \" \u6fc0\u6d3b CLEAR lt_pir_schedule_in . LOOP AT gt_date_list REFERENCE INTO DATA ( lr_date ). ASSIGN COMPONENT lr_date -> fieldname OF STRUCTURE <fs_forecast> TO FIELD - SYMBOL ( <fs_nump> ). \" \u6709\u4e2a\u7591\u95ee\uff0c\u5bfc\u5165\u4e3a0\u662f\u4e0d\u662f\u5c31\u4e0d\u7528\u5bfc\u5165\u4e86\uff1f IF <fs_nump> IS NOT INITIAL . APPEND VALUE # ( req_date = lr_date -> date req_qty = <fs_nump> date_type = '1' \" \u8868\u793a\uff1a\u5929 prod_ves = <fs_head> - verid ) TO lt_pir_schedule_in REFERENCE INTO DATA ( lr_pir_schedule_in ). ENDIF . ENDLOOP . \" \u68c0\u67e5\u7248\u672c\u4e0b\u7684\u7269\u6599\u662f\u5426\u5b58\u5728 READ TABLE lt_pbim TRANSPORTING NO FIELDS WITH KEY matnr = ls_pir_item - material werks = ls_pir_item - plant bedae = ls_pir_item - requ_type versb = ls_pir_item - version pbdnr = ls_pir_item - req_number BINARY SEARCH . IF sy - subrc = 0 . \" \u5220\u9664\u9700\u8981\u5bfc\u5165\u7684\u884c DELETE lt_pbim INDEX sy - tabix . \" \u4fee\u6539 CALL FUNCTION 'BAPI_REQUIREMENTS_CHANGE' EXPORTING material = ls_pir_item - material plant = ls_pir_item - plant requirementstype = ls_pir_item - requ_type version = ls_pir_item - version reqmtsplannumber = ls_pir_item - req_number vers_activ = ls_pir_item - vers_activ do_commit = ' ' delete_old = 'X' TABLES requirements_schedule_in = lt_pir_schedule_in return = lt_return . ELSE . CLEAR lt_return . CALL FUNCTION 'BAPI_REQUIREMENTS_CREATE' EXPORTING requirements_item = ls_pir_item do_commit = ' ' \" \u6700\u540e\u7edf\u4e00\u63d0\u4ea4\u7edf\u4e00\u56de\u6eda TABLES requirements_schedule_in = lt_pir_schedule_in return = lt_return . ENDIF . \" \u9519\u8bef\u6d88\u606f LOOP AT lt_return REFERENCE INTO DATA ( lr_return ) WHERE type CA 'AXE' . <fs_head> - status = 'E' . <fs_head> - icon = icon_red_light . MESSAGE ID lr_return -> id TYPE lr_return -> type NUMBER lr_return -> number WITH lr_return -> message_v1 lr_return -> message_v2 lr_return -> message_v3 lr_return -> message_v4 INTO DATA ( l_msg ). <fs_head> - message = |{ <fs_head> - message }{ l_msg } ; |. ENDLOOP . IF <fs_head> - status = 'E' . l_err = 'X' . ENDIF . ENDLOOP . \" \u56de\u6eda IF l_err = 'X' . CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK' . RETURN . ENDIF . \" \u4e0d\u51fa\u9519\u7684\u60c5\u51b5\uff0c\u5168\u90e8\u63d0\u4ea4 CHECK l_err = '' . CALL FUNCTION 'BAPI_TRANSACTION_COMMIT' EXPORTING wait = 'X' . \" \u5bfc\u5165\u6210\u529f\u540e\uff0c\u901a\u8fc7BDC\u5220\u9664\u5176\u4ed6\u7248\u672c\u53f7 \" \u4e0d\u5728\u5bfc\u5165\u524d\u5220\u9664\u7684\u539f\u56e0\uff0c\u662f\u4e3a\u4e86\u4fdd\u6301\u6570\u636e\u4e00\u81f4\u6027 \" \uff08BDC\u65e0\u6cd5\u56de\u6eda\uff0c\u5982\u679cBDC\u5220\u9664\u6210\u529f\uff0c\u540e\u9762\u5bfc\u5165\u5931\u8d25\uff0c\u5c06\u65e0\u6cd5\u56de\u9000\u5230\u521d\u59cb\u72b6\u6001\uff09 \" \u5220\u9664\u7684\u9879\u76ee\u65e0\u6cd5\u518d\u6b21\u5220\u9664\uff0c\u6240\u4ee5\u4e5f\u8981\u6392\u9664 DELETE lt_pbim WHERE loevr <> '' . \" \u901a\u8fc7BDC\u5220\u9664\u5176\u4f59\u6ca1\u6709\u5bfc\u5165\u7684\u7269\u6599\u6570\u636e LOOP AT lt_pbim REFERENCE INTO DATA ( lr_pbim ). PERFORM frm_pir_delete USING lr_pbim -> matnr lr_pbim -> werks lr_pbim -> versb . ENDLOOP . ENDFORM . \" frm_import_pir","title":"PIR\u7ef4\u62a4"},{"location":"pp/pp_confirmation/","text":"\u751f\u4ea7\u62a5\u5de5 \u00b6 \u793a\u4f8b\u4ee3\u7801 \u00b6 BAPI_PRODORDCONF_GET_TT_PROP \uff1a\u67e5\u8be2\u5de5\u5355\u4fe1\u606f BAPI_PRODORDCONF_CREATE_TT \uff1a\u521b\u5efa\u6216\u7ef4\u62a4\u62a5\u5de5 \u793a\u4f8b\u4ee3\u7801\uff1a\u521b\u5efa \" \u5904\u7406\u72b6\u6001 DATA l_mtype TYPE bapi_mtype . DATA l_msg TYPE bapi_msg . DATA : lt_timetickets TYPE STANDARD TABLE OF bapi_pp_timeticket , ls_timetickets TYPE bapi_pp_timeticket , ls_bapiret1 TYPE bapiret1 . CLEAR lt_timetickets . LOOP AT lt_input INTO ls_input . CLEAR ls_timetickets . ls_timetickets - orderid = ls_input - aufnr . \" \u751f\u4ea7\u8ba2\u5355\u53f7 ls_timetickets - operation = ls_input - posnr . \" \u5de5\u5e8f ls_timetickets - postg_date = ls_input - budat . \" \u65e5\u671f ls_timetickets - yield = ls_input - gmnga . \" \u751f\u4ea7\u6570\u91cf APPEND ls_timetickets TO lt_timetickets . ENDLOOP . \" \u62a5\u5de5 CLEAR ls_bapiret1 . CALL FUNCTION 'BAPI_PRODORDCONF_CREATE_TT' IMPORTING return = ls_bapiret1 TABLES timetickets = lt_timetickets . IF ls_bapiret1 - type CA 'AEX' . l_mtype = 'E' . MESSAGE ID ls_bapiret1 - id TYPE ls_bapiret1 - type NUMBER ls_bapiret1 - number WITH ls_bapiret1 - message_v1 ls_bapiret1 - message_v2 ls_bapiret1 - message_v3 ls_bapiret1 - message_v4 INTO l_msg . CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK' . ELSE . l_mtype = 'S' . l_msg = | \u62a5\u5de5\u5df2\u5904\u7406 |. CALL FUNCTION 'BAPI_TRANSACTION_COMMIT' EXPORTING wait = 'X' . ENDIF . \u793a\u4f8b\u4ee3\u7801\uff1a\u7ef4\u62a4","title":"\u62a5\u5de5\u786e\u8ba4"},{"location":"pp/pp_confirmation/#_1","text":"","title":"\u751f\u4ea7\u62a5\u5de5"},{"location":"pp/pp_confirmation/#_2","text":"BAPI_PRODORDCONF_GET_TT_PROP \uff1a\u67e5\u8be2\u5de5\u5355\u4fe1\u606f BAPI_PRODORDCONF_CREATE_TT \uff1a\u521b\u5efa\u6216\u7ef4\u62a4\u62a5\u5de5 \u793a\u4f8b\u4ee3\u7801\uff1a\u521b\u5efa \" \u5904\u7406\u72b6\u6001 DATA l_mtype TYPE bapi_mtype . DATA l_msg TYPE bapi_msg . DATA : lt_timetickets TYPE STANDARD TABLE OF bapi_pp_timeticket , ls_timetickets TYPE bapi_pp_timeticket , ls_bapiret1 TYPE bapiret1 . CLEAR lt_timetickets . LOOP AT lt_input INTO ls_input . CLEAR ls_timetickets . ls_timetickets - orderid = ls_input - aufnr . \" \u751f\u4ea7\u8ba2\u5355\u53f7 ls_timetickets - operation = ls_input - posnr . \" \u5de5\u5e8f ls_timetickets - postg_date = ls_input - budat . \" \u65e5\u671f ls_timetickets - yield = ls_input - gmnga . \" \u751f\u4ea7\u6570\u91cf APPEND ls_timetickets TO lt_timetickets . ENDLOOP . \" \u62a5\u5de5 CLEAR ls_bapiret1 . CALL FUNCTION 'BAPI_PRODORDCONF_CREATE_TT' IMPORTING return = ls_bapiret1 TABLES timetickets = lt_timetickets . IF ls_bapiret1 - type CA 'AEX' . l_mtype = 'E' . MESSAGE ID ls_bapiret1 - id TYPE ls_bapiret1 - type NUMBER ls_bapiret1 - number WITH ls_bapiret1 - message_v1 ls_bapiret1 - message_v2 ls_bapiret1 - message_v3 ls_bapiret1 - message_v4 INTO l_msg . CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK' . ELSE . l_mtype = 'S' . l_msg = | \u62a5\u5de5\u5df2\u5904\u7406 |. CALL FUNCTION 'BAPI_TRANSACTION_COMMIT' EXPORTING wait = 'X' . ENDIF . \u793a\u4f8b\u4ee3\u7801\uff1a\u7ef4\u62a4","title":"\u793a\u4f8b\u4ee3\u7801"},{"location":"pp/pp_gi/","text":"\u751f\u4ea7\u6295\u6599 \u00b6 \u53c2\u8003MIGO\u53d1\u8d27","title":"\u9886\u9000\u6599"},{"location":"pp/pp_gi/#_1","text":"\u53c2\u8003MIGO\u53d1\u8d27","title":"\u751f\u4ea7\u6295\u6599"},{"location":"pp/pp_gr/","text":"\u751f\u4ea7\u8ba2\u5355\u6536\u8d27 \u00b6 \u53c2\u8003MIGO\u751f\u4ea7\u6536\u8d27","title":"\u751f\u4ea7\u8ba2\u5355\u6536\u8d27"},{"location":"pp/pp_gr/#_1","text":"\u53c2\u8003MIGO\u751f\u4ea7\u6536\u8d27","title":"\u751f\u4ea7\u8ba2\u5355\u6536\u8d27"},{"location":"pp/pp_order/","text":"\u751f\u4ea7\u8ba2\u5355 \u00b6","title":"\u751f\u4ea7\u5de5\u5355"},{"location":"pp/pp_order/#_1","text":"","title":"\u751f\u4ea7\u8ba2\u5355"},{"location":"pp/pp_order_close/","text":"\u5de5\u5355\u5173\u95ed \u00b6 \u6280\u672f\u6027\u5b8c\u6210\uff08TECO\uff09\u751f\u4ea7\u8ba2\u5355 \u00b6 \u793a\u4f8b\u4ee3\u7801 DATA : lt_orders TYPE STANDARD TABLE OF bapi_order_key , lt_detail_return TYPE STANDARD TABLE OF bapi_order_return , ls_return TYPE bapiret2 . CLEAR lt_orders . CLEAR lt_detail_return . CLEAR ls_return . INSERT VALUE # ( order_number = ls_input - aufnr ) INTO TABLE lt_orders . \" \u6280\u672f\u6027\u5b8c\u6210\u751f\u4ea7\u8ba2\u5355 CALL FUNCTION 'BAPI_PRODORD_COMPLETE_TECH' IMPORTING return = ls_return TABLES orders = lt_orders detail_return = lt_detail_return . IF ls_return - type = 'E' . l_mtype = 'E' . MESSAGE ID ls_return - id TYPE ls_return - type NUMBER ls_return - number WITH ls_return - message_v1 ls_return - message_v2 ls_return - message_v3 ls_return - message_v4 INTO l_msg . CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK' . ELSE . l_mtype = 'S' . l_msg = | \u5df2\u5904\u7406 |. CALL FUNCTION 'BAPI_TRANSACTION_COMMIT' EXPORTING wait = 'X' . ENDIF . \u64a4\u9500TECO \u00b6 \u7528\u65b9\u6cd5STATUS_CHANGE_INTERN\u64a4\u9500TECO\uff0c\u4f46\u662f\u65e0\u6cd5\u6e05\u9664AUFK-IDAT2\u6280\u672f\u5b8c\u6210\u65e5\u671f\uff0c\u6216\u8bb8\u53ef\u4ee5\u76f4\u63a5\u6539\u8868\u6765\u53bb\u9664\u8fd9\u4e2a\u5b57\u6bb5\u4fe1\u606f? \u793a\u4f8b\u4ee3\u7801 DATA lt_jstat TYPE STANDARD TABLE OF jstat WITH EMPTY KEY . CLEAR lt_jstat . CALL FUNCTION 'STATUS_READ' EXPORTING objnr = i_objnr TABLES status = lt_jstat EXCEPTIONS object_not_found = 1 OTHERS = 2 . IF sy - subrc = 0 . * Implement suitable error handling here LOOP AT lt_jstat REFERENCE INTO DATA ( lr_jstat ). CASE lr_jstat -> stat . WHEN 'I0002' . \" REL lr_jstat -> inact = '' . WHEN 'I0045' . \" TECO lr_jstat -> inact = 'X' . WHEN OTHERS . ENDCASE . ENDLOOP . CALL FUNCTION 'STATUS_CHANGE_INTERN' EXPORTING objnr = i_objnr TABLES status = lt_jstat EXCEPTIONS object_not_found = 1 status_inconsistent = 2 status_not_allowed = 3 OTHERS = 4 . IF sy - subrc <> 0 . * Implement suitable error handling here ENDIF . ENDIF . \u64a4\u9500TECO\uff08BDC\u5b9e\u73b0\uff09 \u00b6 \u793a\u4f8b\u4ee3\u7801 FORM frm_bdc_status_change USING i_aufnr TYPE aufk - aufnr i_teco TYPE xflag CHANGING c_subrc TYPE sy - subrc . DATA lt_bdcdata TYPE STANDARD TABLE OF bdcdata WITH EMPTY KEY . DEFINE _bdc_dynpro . append value # ( program = &1 dynpro = &2 dynbegin = 'X' ) to lt_bdcdata . END-OF-DEFINITION . DEFINE _bdc_field . append value # ( fnam = &1 fval = &2 ) to lt_bdcdata . END-OF-DEFINITION . \" CO02\u9996\u9875\uff0c\u9009\u62e9\u603b\u89c8\uff0c\u8f93\u5165\u8ba2\u5355\u53f7\uff0cENTER\u8fdb\u5165 _bdc_dynpro 'SAPLCOKO1' '0110' . _bdc_field : 'BDC_OKCODE' '/00' , 'R62CLORD-FLG_OVIEW' 'X' , 'CAUFVD-AUFNR' i_aufnr . \" =TABS: TECO \u6280\u672f\u6027\u5173\u95ed \" =TABR: undo TECO \u53d6\u6d88\u6280\u672f\u6027\u5173\u95ed _bdc_dynpro 'SAPLCOKO1' '0115' . IF i_teco = 'X' . _bdc_field 'BDC_OKCODE' '=TABS' . ELSE . _bdc_field 'BDC_OKCODE' '=TABR' . ENDIF . \" \u4fdd\u5b58 _bdc_dynpro 'SAPLCOKO1' '0115' . _bdc_field 'BDC_OKCODE' '=BU' . \" \u4fdd\u5b58\u65f6\u5f39\u7a97\u9009\u62e9\u201c\u662f\u201d _bdc_dynpro 'SAPLSPO1' '0300' . _bdc_field 'BDC_OKCODE' '=YES' . DATA ls_option TYPE ctu_params . ls_option - dismode = 'N' . \" \u540e\u53f0 ls_option - updmode = 'L' . \" \u672c\u5730 ls_option - nobinpt = 'X' . \" \u6709\u5f39\u7a97\uff0c\u9700\u8981\u542f\u7528\u8fd9\u4e2a\u6807\u8bc6 DATA lt_message TYPE STANDARD TABLE OF bdcmsgcoll WITH EMPTY KEY . CALL TRANSACTION 'CO02' USING lt_bdcdata OPTIONS FROM ls_option MESSAGES INTO lt_message . \" \u4e0d\u7ba1\u5982\u4f55\uff0cBDC\u90fd\u56de\u6eda\u4e0d\u4e86\uff0c\u76f4\u63a5\u63d0\u4ea4\u4e86\u4e8b COMMIT WORK AND WAIT . ENDFORM . \" frm_bdc_status_change","title":"\u5de5\u5355\u5173\u95ed"},{"location":"pp/pp_order_close/#_1","text":"","title":"\u5de5\u5355\u5173\u95ed"},{"location":"pp/pp_order_close/#teco","text":"\u793a\u4f8b\u4ee3\u7801 DATA : lt_orders TYPE STANDARD TABLE OF bapi_order_key , lt_detail_return TYPE STANDARD TABLE OF bapi_order_return , ls_return TYPE bapiret2 . CLEAR lt_orders . CLEAR lt_detail_return . CLEAR ls_return . INSERT VALUE # ( order_number = ls_input - aufnr ) INTO TABLE lt_orders . \" \u6280\u672f\u6027\u5b8c\u6210\u751f\u4ea7\u8ba2\u5355 CALL FUNCTION 'BAPI_PRODORD_COMPLETE_TECH' IMPORTING return = ls_return TABLES orders = lt_orders detail_return = lt_detail_return . IF ls_return - type = 'E' . l_mtype = 'E' . MESSAGE ID ls_return - id TYPE ls_return - type NUMBER ls_return - number WITH ls_return - message_v1 ls_return - message_v2 ls_return - message_v3 ls_return - message_v4 INTO l_msg . CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK' . ELSE . l_mtype = 'S' . l_msg = | \u5df2\u5904\u7406 |. CALL FUNCTION 'BAPI_TRANSACTION_COMMIT' EXPORTING wait = 'X' . ENDIF .","title":"\u6280\u672f\u6027\u5b8c\u6210\uff08TECO\uff09\u751f\u4ea7\u8ba2\u5355"},{"location":"pp/pp_order_close/#teco_1","text":"\u7528\u65b9\u6cd5STATUS_CHANGE_INTERN\u64a4\u9500TECO\uff0c\u4f46\u662f\u65e0\u6cd5\u6e05\u9664AUFK-IDAT2\u6280\u672f\u5b8c\u6210\u65e5\u671f\uff0c\u6216\u8bb8\u53ef\u4ee5\u76f4\u63a5\u6539\u8868\u6765\u53bb\u9664\u8fd9\u4e2a\u5b57\u6bb5\u4fe1\u606f? \u793a\u4f8b\u4ee3\u7801 DATA lt_jstat TYPE STANDARD TABLE OF jstat WITH EMPTY KEY . CLEAR lt_jstat . CALL FUNCTION 'STATUS_READ' EXPORTING objnr = i_objnr TABLES status = lt_jstat EXCEPTIONS object_not_found = 1 OTHERS = 2 . IF sy - subrc = 0 . * Implement suitable error handling here LOOP AT lt_jstat REFERENCE INTO DATA ( lr_jstat ). CASE lr_jstat -> stat . WHEN 'I0002' . \" REL lr_jstat -> inact = '' . WHEN 'I0045' . \" TECO lr_jstat -> inact = 'X' . WHEN OTHERS . ENDCASE . ENDLOOP . CALL FUNCTION 'STATUS_CHANGE_INTERN' EXPORTING objnr = i_objnr TABLES status = lt_jstat EXCEPTIONS object_not_found = 1 status_inconsistent = 2 status_not_allowed = 3 OTHERS = 4 . IF sy - subrc <> 0 . * Implement suitable error handling here ENDIF . ENDIF .","title":"\u64a4\u9500TECO"},{"location":"pp/pp_order_close/#tecobdc","text":"\u793a\u4f8b\u4ee3\u7801 FORM frm_bdc_status_change USING i_aufnr TYPE aufk - aufnr i_teco TYPE xflag CHANGING c_subrc TYPE sy - subrc . DATA lt_bdcdata TYPE STANDARD TABLE OF bdcdata WITH EMPTY KEY . DEFINE _bdc_dynpro . append value # ( program = &1 dynpro = &2 dynbegin = 'X' ) to lt_bdcdata . END-OF-DEFINITION . DEFINE _bdc_field . append value # ( fnam = &1 fval = &2 ) to lt_bdcdata . END-OF-DEFINITION . \" CO02\u9996\u9875\uff0c\u9009\u62e9\u603b\u89c8\uff0c\u8f93\u5165\u8ba2\u5355\u53f7\uff0cENTER\u8fdb\u5165 _bdc_dynpro 'SAPLCOKO1' '0110' . _bdc_field : 'BDC_OKCODE' '/00' , 'R62CLORD-FLG_OVIEW' 'X' , 'CAUFVD-AUFNR' i_aufnr . \" =TABS: TECO \u6280\u672f\u6027\u5173\u95ed \" =TABR: undo TECO \u53d6\u6d88\u6280\u672f\u6027\u5173\u95ed _bdc_dynpro 'SAPLCOKO1' '0115' . IF i_teco = 'X' . _bdc_field 'BDC_OKCODE' '=TABS' . ELSE . _bdc_field 'BDC_OKCODE' '=TABR' . ENDIF . \" \u4fdd\u5b58 _bdc_dynpro 'SAPLCOKO1' '0115' . _bdc_field 'BDC_OKCODE' '=BU' . \" \u4fdd\u5b58\u65f6\u5f39\u7a97\u9009\u62e9\u201c\u662f\u201d _bdc_dynpro 'SAPLSPO1' '0300' . _bdc_field 'BDC_OKCODE' '=YES' . DATA ls_option TYPE ctu_params . ls_option - dismode = 'N' . \" \u540e\u53f0 ls_option - updmode = 'L' . \" \u672c\u5730 ls_option - nobinpt = 'X' . \" \u6709\u5f39\u7a97\uff0c\u9700\u8981\u542f\u7528\u8fd9\u4e2a\u6807\u8bc6 DATA lt_message TYPE STANDARD TABLE OF bdcmsgcoll WITH EMPTY KEY . CALL TRANSACTION 'CO02' USING lt_bdcdata OPTIONS FROM ls_option MESSAGES INTO lt_message . \" \u4e0d\u7ba1\u5982\u4f55\uff0cBDC\u90fd\u56de\u6eda\u4e0d\u4e86\uff0c\u76f4\u63a5\u63d0\u4ea4\u4e86\u4e8b COMMIT WORK AND WAIT . ENDFORM . \" frm_bdc_status_change","title":"\u64a4\u9500TECO\uff08BDC\u5b9e\u73b0\uff09"},{"location":"pp/pp_planning/","text":"\u751f\u4ea7\u8ba1\u5212 \u00b6","title":"\u751f\u4ea7\u8ba1\u5212"},{"location":"pp/pp_planning/#_1","text":"","title":"\u751f\u4ea7\u8ba1\u5212"},{"location":"pp/pp_routing/","text":"\u5de5\u827a\u8def\u7ebf \u00b6 \u793a\u4f8b\u4ee3\u7801 *----------------------------------------------------------------------* ***INCLUDE LZGRP_PP_021D01. *----------------------------------------------------------------------* *&---------------------------------------------------------------------* *& Class lcl_bapi_proxy *&---------------------------------------------------------------------* * Text *----------------------------------------------------------------------* CLASS lcl_routing_create_proxy DEFINITION . PUBLIC SECTION . METHODS : \"! \u521d\u59cb\u5316\u53c2\u6570 init , \"! \u6309\u63a5\u53e3\u53c2\u6570\u7c7b\u578b\u586b\u5145\u6570\u636e \"! @parameter head | \"! @parameter items | fill_data_by_type1 IMPORTING head TYPE zspp_0029_head items TYPE zttpp_0029_item , \"! \u6d4b\u8bd5\u8fd0\u884c \"! @parameter result | testrun RETURNING VALUE ( result ) TYPE xflag , \"! \u521b\u5efa\u5de5\u827a\u8def\u7ebf execute , \"! \u83b7\u53d6\u68c0\u67e5/\u521b\u5efa/\u5176\u4ed6\u5904\u7406\u6d88\u606f \"! @parameter type | \"! @parameter message | get_message EXPORTING type TYPE bapi_mtype message TYPE bapi_msg , \"! \u4f7f\u7528BAPI_ROUTING_EXISTENCE_CHECK\u68c0\u67e5\u5de5\u827a\u8def\u7ebf\u662f\u5426\u5b58\u5728 \"! @parameter group | \"! @parameter groupcounter | \"! @parameter validfrom | \"! @parameter validtodate | \"! @parameter result | check_exists IMPORTING group TYPE bapi1012_tsk_c - task_list_group groupcounter TYPE bapi1012_tsk_c - group_counter validfrom TYPE bapi1012_tsk_c - valid_from validtodate TYPE bapi1012_tsk_c - valid_to_date OPTIONAL RETURNING VALUE ( result ) TYPE xflag , \"! \u6839\u636e\u5de5\u5382/\u7269\u6599/\u4ea7\u7ebf\u68c0\u67e5\u5de5\u827a\u8def\u7ebf\u662f\u5426\u5b58\u5728 \"! @parameter werks | \"! @parameter matnr | \"! @parameter plnnr_alt | \"! @parameter result | check_exist_by_mapl IMPORTING werks TYPE werks_d matnr TYPE matnr plnnr_alt TYPE cp_plnnr_a RETURNING VALUE ( result ) TYPE xflag , \"! \u91cd\u590d\u7269\u6599\u4e0e\u5de5\u5382\u7684\u5de5\u827a\u8def\u7ebf\u4e0b\u6700\u65b0\u7684\u8ba1\u6570 \"! @parameter matnr | \"! @parameter werks | \"! @parameter countor | next_counter IMPORTING werks TYPE werks_d matnr TYPE matnr EXPORTING group TYPE bapi1012_tsk_c - task_list_group counter TYPE bapi1012_tsk_c - group_counter . PRIVATE SECTION . DATA ms_group TYPE bapi1012_tsk_c . DATA mt_task TYPE STANDARD TABLE OF bapi1012_tsk_c WITH EMPTY KEY . DATA mt_mat_task TYPE STANDARD TABLE OF bapi1012_mtk_c WITH EMPTY KEY . DATA mt_operation TYPE STANDARD TABLE OF bapi1012_opr_c WITH EMPTY KEY . DATA mt_return TYPE STANDARD TABLE OF bapiret2 WITH EMPTY KEY . ENDCLASS . \"lcl_bapi_proxy *&---------------------------------------------------------------------* *& Class lcl_bapi_proxy *&---------------------------------------------------------------------* CLASS lcl_routing_create_proxy IMPLEMENTATION . \" \u6d4b\u8bd5\u8fd0\u884c METHOD testrun . DATA l_testrun TYPE bapiflag . l_testrun - bapiflag = 'X' . CALL FUNCTION 'BAPI_ROUTING_CREATE' EXPORTING testrun = l_testrun IMPORTING group = ms_group - task_list_group groupcounter = ms_group - group_counter TABLES task = mt_task materialtaskallocation = mt_mat_task operation = mt_operation return = mt_return . READ TABLE mt_return TRANSPORTING NO FIELDS WITH KEY type = 'E' . IF sy - subrc = 0 . CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK' . RETURN . ENDIF . result = 'X' . ENDMETHOD . \" \u8fd0\u884c METHOD execute . \" \u521b\u5efa\u5de5\u827a\u8def\u7ebf CLEAR mt_return . CALL FUNCTION 'BAPI_ROUTING_CREATE' IMPORTING group = ms_group - task_list_group groupcounter = ms_group - group_counter TABLES task = mt_task materialtaskallocation = mt_mat_task operation = mt_operation return = mt_return . READ TABLE mt_return TRANSPORTING NO FIELDS WITH KEY type = 'E' . IF sy - subrc = 0 . CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK' . RETURN . ENDIF . CALL FUNCTION 'BAPI_TRANSACTION_COMMIT' EXPORTING wait = 'X' . ENDMETHOD . \" \u83b7\u53d6\u6d88\u606f METHOD get_message . READ TABLE mt_return TRANSPORTING NO FIELDS WITH KEY type = 'E' . IF sy - subrc = 0 . type = 'E' . LOOP AT mt_return REFERENCE INTO DATA ( lr_return ). MESSAGE ID lr_return -> id TYPE lr_return -> type NUMBER lr_return -> number WITH lr_return -> message_v1 lr_return -> message_v2 lr_return -> message_v3 lr_return -> message_v4 INTO DATA ( l_message ). message = |{ message }{ l_message } ; |. ENDLOOP . ELSE . type = 'S' . message = | \u5de5\u827a\u8def\u7ebf\u88ab\u4fdd\u5b58\u4e8e\u7ec4 { ms_group - task_list_group }|. ENDIF . ENDMETHOD . \" \u6839\u636e\u63a5\u53e3\u53c2\u6570\u586b\u5145\u6570\u636e METHOD fill_data_by_type1 . \" \u62ac\u5934 APPEND INITIAL LINE TO mt_task REFERENCE INTO DATA ( lr_task ). lr_task -> plant = head - werks . \" \u5de5\u5382 \" \u5bf9\u4e8e\u91cd\u590d\u7269\u6599\u548c\u5de5\u5382\uff0c\u4e0d\u662f\u65b0\u5efa\u4e00\u6761\u5de5\u827a\u8def\u7ebf\uff0c\u800c\u662f\u5728\u539f\u6709\u7ec4\u4e0b\u65b0\u589e\u8ba1\u6570 next_counter ( EXPORTING matnr = head - matnr werks = head - werks IMPORTING group = lr_task -> task_list_group counter = lr_task -> group_counter ). lr_task -> old_number_of_task_list = head - plnnr_alt . \" \u4ea7\u7ebf lr_task -> description = head - ktext . \" \u5de5\u827a\u8def\u7ebf\u63cf\u8ff0 lr_task -> task_list_usage = '1' . \" \u7528\u9014\uff0c\u9ed8\u8ba4\u503c lr_task -> task_list_status = '4' . \" \u72b6\u6001\uff0c\u9ed8\u8ba4\u503c lr_task -> task_measure_unit = 'PCS' . lr_task -> task_measure_unit_iso = 'PCS' . lr_task -> lot_size_from = head - losvn . \" \u6279\u91cf\u4e0b\u9650 lr_task -> lot_size_to = head - losbs . \" \u6279\u91cf\u4e0a\u9650 lr_task -> valid_from = head - datuv . \" \u6709\u6548\u8d77\u59cb\u65e5\u671f lr_task -> valid_to_date = '99991231' . \" \u6709\u6548\u7ed3\u675f\u65e5\u671f \" \u7269\u6599\u6307\u6d3e APPEND INITIAL LINE TO mt_mat_task REFERENCE INTO DATA ( lr_mat_task ). lr_mat_task -> material = head - matnr . \" \u6210\u54c1\u7f16\u7801 lr_mat_task -> plant = head - werks . \" \u5de5\u5382 lr_mat_task -> valid_from = head - datuv . \" \u6709\u6548\u8d77\u59cb\u65e5\u671f lr_mat_task -> valid_to_date = '99991231' . \" \u6709\u6548\u7ed3\u675f\u65e5\u671f \" \u5de5\u5e8f LOOP AT items REFERENCE INTO DATA ( lr_item ). APPEND INITIAL LINE TO mt_operation REFERENCE INTO DATA ( lr_operation ). lr_operation -> activity = lr_item -> vornr . \" \u5de5\u5e8f\u7f16\u53f7 lr_operation -> description = lr_item -> ltxa1 . \" \u5de5\u5e8f\u77ed\u6587\u672c lr_operation -> standard_text_key = lr_item -> vlsch . \" \u6807\u51c6\u6587\u672c\u7801 lr_operation -> plant = head - werks . lr_operation -> work_cntr = lr_item -> arbpl . \" \u5de5\u4f5c\u4e2d\u5fc3 lr_operation -> control_key = lr_item -> steus . \" \u63a7\u5236\u7801 lr_operation -> base_quantity = lr_item -> bmsch . \" \u5de5\u5e8f\u57fa\u672c\u6570\u91cf lr_operation -> valid_from = head - datuv . \" \u6709\u6548\u8d77\u59cb\u65e5\u671f lr_operation -> valid_to_date = '99991231' . \" \u6709\u6548\u7ed3\u675f\u65e5\u671f lr_operation -> denominator = '1' . lr_operation -> nominator = '1' . \" \u8ba1\u91cf\u5355\u4f4d lr_operation -> operation_measure_unit = lr_item -> meinh . CALL FUNCTION 'CONVERSION_EXIT_CUNIT_INPUT' EXPORTING input = lr_operation -> operation_measure_unit IMPORTING output = lr_operation -> operation_measure_unit . \" \u8ba1\u91cf\u5355\u4f4d lr_operation -> operation_measure_unit_iso = lr_item -> meinh . CALL FUNCTION 'CONVERSION_EXIT_CUNIT_INPUT' EXPORTING input = lr_operation -> operation_measure_unit_iso IMPORTING output = lr_operation -> operation_measure_unit_iso . lr_operation -> no_of_employee = lr_item -> anzma . \" \u96c7\u5458\u6570\u91cf lr_operation -> valid_from = head - datuv . \" \u6709\u6548\u8d77\u59cb\u65e5\u671f lr_operation -> valid_to_date = '99991231' . \" \u6709\u6548\u7ed3\u675f\u65e5\u671f \" \u91cd\u590d\u4ee3\u7801 DEFINE _set_acti . lr_operation -> std_unit_0 &1 = lr_item -> vge0 &1 . lr_operation -> std_unit_0 &1 _iso = lr_item -> vge0 &1 . lr_operation -> std_value_0 &1 = lr_item -> vgw0 &1 . END-OF-DEFINITION . _set_acti 1 . \" \u6298\u65e7\u644a\u9500 _set_acti 2 . \" \u76f4\u63a5\u4eba\u5de5 _set_acti 3 . \" \u95f4\u63a5\u4eba\u5de5 _set_acti 4 . \" \u52a8\u529b\u8d39 _set_acti 5 . \" \u751f\u4ea7\u8017\u6750 _set_acti 6 . \" \u7ef4\u4fee\u4fdd\u517b ENDLOOP . ENDMETHOD . \" \u521d\u59cb\u5316\u53c2\u6570 METHOD init . CLEAR ms_group . CLEAR mt_task . CLEAR mt_mat_task . CLEAR mt_operation . CLEAR mt_return . ENDMETHOD . \" \u68c0\u67e5\u5de5\u5e8f\u662f\u5426\u5df2\u7ecf\u5b58\u5728 METHOD check_exists . DATA lt_return TYPE STANDARD TABLE OF bapiret2 . CALL FUNCTION 'BAPI_ROUTING_EXISTENCE_CHECK' EXPORTING group = group groupcounter = groupcounter validfrom = validfrom validtodate = validtodate TABLES return = lt_return . READ TABLE lt_return TRANSPORTING NO FIELDS WITH KEY type = 'E' . IF sy - subrc = 0 . result = 'X' . ENDIF . ENDMETHOD . \" \u68c0\u67e5\u5de5\u827a\u8def\u7ebf\u662f\u5426\u5b58\u5728 METHOD check_exist_by_mapl . DATA l_plnnr_alt TYPE plko - plnnr_alt . SELECT SINGLE plnnr_alt INTO @ l_plnnr_alt FROM mapl LEFT JOIN plko ON plko~plnty = mapl~plnty AND plko~plnnr = mapl~plnnr AND plko~plnal = mapl~plnal AND plko~zaehl = mapl~zaehl WHERE mapl~werks = @ werks AND mapl~matnr = @ matnr AND plko~plnnr_alt = @ plnnr_alt . IF sy - subrc = 0 . result = 'X' . ENDIF . ENDMETHOD . \" \u91cd\u590d\u7269\u6599\u4e0e\u5de5\u5382\u4e0b\u6700\u65b0\u7684\u8ba1\u6570 METHOD next_counter . SELECT SINGLE plnnr INTO @ group FROM mapl WHERE matnr = @ matnr AND werks = @ werks AND plnty = 'N' . IF sy - subrc = 0 . SELECT SINGLE MAX ( plnal ) INTO @ counter FROM plko WHERE plko~plnty = 'N' AND plko~plnnr = @ group . counter = counter + 1 . ENDIF . ENDMETHOD . ENDCLASS . *&---------------------------------------------------------------------* *& Class lcl_routing_change_proxy *&---------------------------------------------------------------------* CLASS lcl_routing_change_proxy DEFINITION . PUBLIC SECTION . METHODS : init , fill_data_by_type1 IMPORTING head TYPE zspp_0029_head items TYPE zttpp_0029_item , execute , get_message EXPORTING type TYPE bapi_mtype message TYPE bapi_msg . PRIVATE SECTION . DATA ms_maint_hdr TYPE cps_task_list_maint_hdr . DATA ms_task TYPE cps_task_list_maint_tsk . DATA ms_taskx TYPE cps_task_list_maint_tsk_x . DATA mt_mat_task TYPE STANDARD TABLE OF cps_task_list_maint_mtk . DATA mt_mat_taskx TYPE STANDARD TABLE OF cps_task_list_maint_mtk_x . DATA mt_operation TYPE STANDARD TABLE OF cps_task_list_maint_opr . DATA mt_operationx TYPE STANDARD TABLE OF cps_task_list_maint_opr_x . DATA mt_return TYPE bapiret2_t . ENDCLASS . \"lcl_bapi_proxy *&---------------------------------------------------------------------* *& Class lcl_routing_change_proxy *&---------------------------------------------------------------------* CLASS lcl_routing_change_proxy IMPLEMENTATION . \" \u8fd0\u884c METHOD execute . \" \u4fee\u6539\u5de5\u827a\u8def\u7ebf CALL FUNCTION 'CPCC_S_TASK_LIST_MAINTAIN' EXPORTING change_no = ms_maint_hdr - change_no key_date = ms_maint_hdr - key_date task_list_type = ms_maint_hdr - task_list_type task_list_group = ms_maint_hdr - task_list_group group_counter = ms_maint_hdr - group_counter material = ms_maint_hdr - material plant = ms_maint_hdr - plant task_maintain_mode = 'M' task = ms_task task_x = ms_taskx TABLES operations = mt_operation operations_x = mt_operationx return = mt_return . READ TABLE mt_return TRANSPORTING NO FIELDS WITH KEY type = 'E' . IF sy - subrc = 0 . CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK' . RETURN . ENDIF . CALL FUNCTION 'BAPI_TRANSACTION_COMMIT' EXPORTING wait = 'X' . ENDMETHOD . \" \u83b7\u53d6\u6d88\u606f METHOD get_message . READ TABLE mt_return TRANSPORTING NO FIELDS WITH KEY type = 'E' . IF sy - subrc = 0 . type = 'E' . LOOP AT mt_return REFERENCE INTO DATA ( lr_return ). MESSAGE ID lr_return -> id TYPE lr_return -> type NUMBER lr_return -> number WITH lr_return -> message_v1 lr_return -> message_v2 lr_return -> message_v3 lr_return -> message_v4 INTO DATA ( l_message ). message = |{ message }{ l_message } ; |. ENDLOOP . ELSE . type = 'S' . message = '\u4fee\u6539\u5de5\u827a\u8def\u7ebf\u6210\u529f' . ENDIF . ENDMETHOD . \" \u6839\u636e\u63a5\u53e3\u53c2\u6570\u586b\u5145\u6570\u636e METHOD fill_data_by_type1 . \" \u7528\u4e8e\u67e5\u8be2\u5de5\u827a\u8def\u7ebf\uff0c\u4ee5\u786e\u5b9a\u5de5\u827a\u8def\u7ebf\u884c\u9879\u76ee\u662f\u4fee\u6539\u8fd8\u662f\u65b0\u589e DATA lt_query_input TYPE zttpp_0027_input . DATA lt_query_output TYPE zttpp_0027_output . APPEND VALUE # ( zsqlx = '\u4fee\u6539' werks = head - werks matnr = head - matnr plnnr_alt = head - plnnr_alt ) TO lt_query_input . \" \u5de5\u827a\u8def\u7ebf\u67e5\u8be2 CALL FUNCTION 'ZPP_OA_ROUTING_QUERY_ESB' EXPORTING it_input = lt_query_input IMPORTING et_output = lt_query_output . SORT lt_query_output BY vornr . \" \u62ac\u5934 ms_maint_hdr - key_date = sy - datum . ms_maint_hdr - task_list_type = 'N' . ms_maint_hdr - task_list_group = head - plnnr . \" \u5de5\u827a\u8def\u7ebf\u7ec4 ms_maint_hdr - group_counter = head - plnal . \" \u7ec4\u8ba1\u6570\u5668 ms_maint_hdr - material = head - matnr . \" \u7269\u6599 ms_maint_hdr - plant = head - werks . \" \u5de5\u5382 DEFINE _set_task_field . ms_task - &1 = &2 . ms_taskx - &1 = 'X' . END-OF-DEFINITION . _set_task_field plant head - werks . \" \u5de5\u5382 _set_task_field old_number_of_task_list head - plnnr_alt . \" \u4ea7\u7ebf _set_task_field description head - ktext . \" \u5de5\u827a\u8def\u7ebf\u63cf\u8ff0 _set_task_field task_list_usage '1' . \" \u7528\u9014\uff0c\u9ed8\u8ba4\u503c _set_task_field task_list_status '4' . \" \u72b6\u6001\uff0c\u9ed8\u8ba4\u503c _set_task_field lot_size_from head - losvn . \" \u6279\u91cf\u4e0b\u9650 _set_task_field lot_size_to head - losbs . \" \u4ea7\u7ebf\u6279\u91cf\u4e0a\u9650 _set_task_field task_measure_unit 'PCS' . \" \u5355\u4f4d LOOP AT items REFERENCE INTO DATA ( lr_item ). \" \u5de5\u5e8f APPEND INITIAL LINE TO mt_operation REFERENCE INTO DATA ( lr_operation ). APPEND INITIAL LINE TO mt_operationx REFERENCE INTO DATA ( lr_operationx ). \" \u68c0\u67e5\u5de5\u5e8f\u662f\u5426\u5b58\u5728\uff0c\u5b58\u5728\u4fee\u6539\uff0c\u4e0d\u5b58\u5728\u65b0\u589e READ TABLE lt_query_output REFERENCE INTO DATA ( lr_query_output ) WITH KEY vornr = lr_item -> vornr BINARY SEARCH . IF sy - subrc = 0 . lr_operation -> maintain_mode = 'M' . ELSE . lr_operation -> maintain_mode = 'C' . ENDIF . \" \u5de5\u5e8f\u7f16\u53f7 lr_operation -> activity = lr_item -> vornr . lr_operationx -> activity = 'X' . lr_operation -> activity_old = lr_item -> vornr . lr_operation -> flag_bar_pointer = '1' . DEFINE _set_operation_filed . lr_operation -> &1 = &2 . lr_operationx -> &1 = 'X' . END-OF-DEFINITION . _set_operation_filed plant head - werks . \" \u5de5\u5382 _set_operation_filed description lr_item -> ltxa1 . \" \u5de5\u5e8f\u77ed\u6587\u672c _set_operation_filed standard_text_key lr_item -> vlsch . \" \u6807\u51c6\u6587\u672c\u7801 _set_operation_filed work_cntr lr_item -> arbpl . \" \u5de5\u4f5c\u4e2d\u5fc3 _set_operation_filed control_key lr_item -> steus . \" \u63a7\u5236\u7801 _set_operation_filed base_quantity lr_item -> bmsch . \" \u5de5\u5e8f\u57fa\u672c\u6570\u91cf _set_operation_filed operation_measure_unit lr_item -> meinh . \" \u8ba1\u91cf\u5355\u4f4d _set_operation_filed no_of_employee lr_item -> anzma . \" \u96c7\u5458\u6570\u91cf _set_operation_filed denominator '1' . _set_operation_filed nominator '1' . \" \u91cd\u590d\u4ee3\u7801 DEFINE _set_acti . _set_operation_filed std_unit_0 &1 lr_item -> vge0 &1 . * _set_operation_filed std_unit_0&1_iso lr_item->vge0&1. _set_operation_filed std_value_0 &1 lr_item -> vgw0 &1 . END-OF-DEFINITION . _set_acti 1 . \" \u6298\u65e7\u644a\u9500 _set_acti 2 . \" \u76f4\u63a5\u4eba\u5de5 _set_acti 3 . \" \u95f4\u63a5\u4eba\u5de5 _set_acti 4 . \" \u52a8\u529b\u8d39 _set_acti 5 . \" \u751f\u4ea7\u8017\u6750 _set_acti 6 . \" \u7ef4\u4fee\u4fdd\u517b ENDLOOP . ENDMETHOD . \" \u521d\u59cb\u5316\u53c2\u6570 METHOD init . CLEAR ms_maint_hdr . CLEAR ms_task . CLEAR ms_taskx . CLEAR mt_mat_task . CLEAR mt_mat_taskx . CLEAR mt_operation . CLEAR mt_operationx . CLEAR mt_return . ENDMETHOD . ENDCLASS .","title":"\u5de5\u827a\u8def\u7ebf"},{"location":"pp/pp_routing/#_1","text":"\u793a\u4f8b\u4ee3\u7801 *----------------------------------------------------------------------* ***INCLUDE LZGRP_PP_021D01. *----------------------------------------------------------------------* *&---------------------------------------------------------------------* *& Class lcl_bapi_proxy *&---------------------------------------------------------------------* * Text *----------------------------------------------------------------------* CLASS lcl_routing_create_proxy DEFINITION . PUBLIC SECTION . METHODS : \"! \u521d\u59cb\u5316\u53c2\u6570 init , \"! \u6309\u63a5\u53e3\u53c2\u6570\u7c7b\u578b\u586b\u5145\u6570\u636e \"! @parameter head | \"! @parameter items | fill_data_by_type1 IMPORTING head TYPE zspp_0029_head items TYPE zttpp_0029_item , \"! \u6d4b\u8bd5\u8fd0\u884c \"! @parameter result | testrun RETURNING VALUE ( result ) TYPE xflag , \"! \u521b\u5efa\u5de5\u827a\u8def\u7ebf execute , \"! \u83b7\u53d6\u68c0\u67e5/\u521b\u5efa/\u5176\u4ed6\u5904\u7406\u6d88\u606f \"! @parameter type | \"! @parameter message | get_message EXPORTING type TYPE bapi_mtype message TYPE bapi_msg , \"! \u4f7f\u7528BAPI_ROUTING_EXISTENCE_CHECK\u68c0\u67e5\u5de5\u827a\u8def\u7ebf\u662f\u5426\u5b58\u5728 \"! @parameter group | \"! @parameter groupcounter | \"! @parameter validfrom | \"! @parameter validtodate | \"! @parameter result | check_exists IMPORTING group TYPE bapi1012_tsk_c - task_list_group groupcounter TYPE bapi1012_tsk_c - group_counter validfrom TYPE bapi1012_tsk_c - valid_from validtodate TYPE bapi1012_tsk_c - valid_to_date OPTIONAL RETURNING VALUE ( result ) TYPE xflag , \"! \u6839\u636e\u5de5\u5382/\u7269\u6599/\u4ea7\u7ebf\u68c0\u67e5\u5de5\u827a\u8def\u7ebf\u662f\u5426\u5b58\u5728 \"! @parameter werks | \"! @parameter matnr | \"! @parameter plnnr_alt | \"! @parameter result | check_exist_by_mapl IMPORTING werks TYPE werks_d matnr TYPE matnr plnnr_alt TYPE cp_plnnr_a RETURNING VALUE ( result ) TYPE xflag , \"! \u91cd\u590d\u7269\u6599\u4e0e\u5de5\u5382\u7684\u5de5\u827a\u8def\u7ebf\u4e0b\u6700\u65b0\u7684\u8ba1\u6570 \"! @parameter matnr | \"! @parameter werks | \"! @parameter countor | next_counter IMPORTING werks TYPE werks_d matnr TYPE matnr EXPORTING group TYPE bapi1012_tsk_c - task_list_group counter TYPE bapi1012_tsk_c - group_counter . PRIVATE SECTION . DATA ms_group TYPE bapi1012_tsk_c . DATA mt_task TYPE STANDARD TABLE OF bapi1012_tsk_c WITH EMPTY KEY . DATA mt_mat_task TYPE STANDARD TABLE OF bapi1012_mtk_c WITH EMPTY KEY . DATA mt_operation TYPE STANDARD TABLE OF bapi1012_opr_c WITH EMPTY KEY . DATA mt_return TYPE STANDARD TABLE OF bapiret2 WITH EMPTY KEY . ENDCLASS . \"lcl_bapi_proxy *&---------------------------------------------------------------------* *& Class lcl_bapi_proxy *&---------------------------------------------------------------------* CLASS lcl_routing_create_proxy IMPLEMENTATION . \" \u6d4b\u8bd5\u8fd0\u884c METHOD testrun . DATA l_testrun TYPE bapiflag . l_testrun - bapiflag = 'X' . CALL FUNCTION 'BAPI_ROUTING_CREATE' EXPORTING testrun = l_testrun IMPORTING group = ms_group - task_list_group groupcounter = ms_group - group_counter TABLES task = mt_task materialtaskallocation = mt_mat_task operation = mt_operation return = mt_return . READ TABLE mt_return TRANSPORTING NO FIELDS WITH KEY type = 'E' . IF sy - subrc = 0 . CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK' . RETURN . ENDIF . result = 'X' . ENDMETHOD . \" \u8fd0\u884c METHOD execute . \" \u521b\u5efa\u5de5\u827a\u8def\u7ebf CLEAR mt_return . CALL FUNCTION 'BAPI_ROUTING_CREATE' IMPORTING group = ms_group - task_list_group groupcounter = ms_group - group_counter TABLES task = mt_task materialtaskallocation = mt_mat_task operation = mt_operation return = mt_return . READ TABLE mt_return TRANSPORTING NO FIELDS WITH KEY type = 'E' . IF sy - subrc = 0 . CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK' . RETURN . ENDIF . CALL FUNCTION 'BAPI_TRANSACTION_COMMIT' EXPORTING wait = 'X' . ENDMETHOD . \" \u83b7\u53d6\u6d88\u606f METHOD get_message . READ TABLE mt_return TRANSPORTING NO FIELDS WITH KEY type = 'E' . IF sy - subrc = 0 . type = 'E' . LOOP AT mt_return REFERENCE INTO DATA ( lr_return ). MESSAGE ID lr_return -> id TYPE lr_return -> type NUMBER lr_return -> number WITH lr_return -> message_v1 lr_return -> message_v2 lr_return -> message_v3 lr_return -> message_v4 INTO DATA ( l_message ). message = |{ message }{ l_message } ; |. ENDLOOP . ELSE . type = 'S' . message = | \u5de5\u827a\u8def\u7ebf\u88ab\u4fdd\u5b58\u4e8e\u7ec4 { ms_group - task_list_group }|. ENDIF . ENDMETHOD . \" \u6839\u636e\u63a5\u53e3\u53c2\u6570\u586b\u5145\u6570\u636e METHOD fill_data_by_type1 . \" \u62ac\u5934 APPEND INITIAL LINE TO mt_task REFERENCE INTO DATA ( lr_task ). lr_task -> plant = head - werks . \" \u5de5\u5382 \" \u5bf9\u4e8e\u91cd\u590d\u7269\u6599\u548c\u5de5\u5382\uff0c\u4e0d\u662f\u65b0\u5efa\u4e00\u6761\u5de5\u827a\u8def\u7ebf\uff0c\u800c\u662f\u5728\u539f\u6709\u7ec4\u4e0b\u65b0\u589e\u8ba1\u6570 next_counter ( EXPORTING matnr = head - matnr werks = head - werks IMPORTING group = lr_task -> task_list_group counter = lr_task -> group_counter ). lr_task -> old_number_of_task_list = head - plnnr_alt . \" \u4ea7\u7ebf lr_task -> description = head - ktext . \" \u5de5\u827a\u8def\u7ebf\u63cf\u8ff0 lr_task -> task_list_usage = '1' . \" \u7528\u9014\uff0c\u9ed8\u8ba4\u503c lr_task -> task_list_status = '4' . \" \u72b6\u6001\uff0c\u9ed8\u8ba4\u503c lr_task -> task_measure_unit = 'PCS' . lr_task -> task_measure_unit_iso = 'PCS' . lr_task -> lot_size_from = head - losvn . \" \u6279\u91cf\u4e0b\u9650 lr_task -> lot_size_to = head - losbs . \" \u6279\u91cf\u4e0a\u9650 lr_task -> valid_from = head - datuv . \" \u6709\u6548\u8d77\u59cb\u65e5\u671f lr_task -> valid_to_date = '99991231' . \" \u6709\u6548\u7ed3\u675f\u65e5\u671f \" \u7269\u6599\u6307\u6d3e APPEND INITIAL LINE TO mt_mat_task REFERENCE INTO DATA ( lr_mat_task ). lr_mat_task -> material = head - matnr . \" \u6210\u54c1\u7f16\u7801 lr_mat_task -> plant = head - werks . \" \u5de5\u5382 lr_mat_task -> valid_from = head - datuv . \" \u6709\u6548\u8d77\u59cb\u65e5\u671f lr_mat_task -> valid_to_date = '99991231' . \" \u6709\u6548\u7ed3\u675f\u65e5\u671f \" \u5de5\u5e8f LOOP AT items REFERENCE INTO DATA ( lr_item ). APPEND INITIAL LINE TO mt_operation REFERENCE INTO DATA ( lr_operation ). lr_operation -> activity = lr_item -> vornr . \" \u5de5\u5e8f\u7f16\u53f7 lr_operation -> description = lr_item -> ltxa1 . \" \u5de5\u5e8f\u77ed\u6587\u672c lr_operation -> standard_text_key = lr_item -> vlsch . \" \u6807\u51c6\u6587\u672c\u7801 lr_operation -> plant = head - werks . lr_operation -> work_cntr = lr_item -> arbpl . \" \u5de5\u4f5c\u4e2d\u5fc3 lr_operation -> control_key = lr_item -> steus . \" \u63a7\u5236\u7801 lr_operation -> base_quantity = lr_item -> bmsch . \" \u5de5\u5e8f\u57fa\u672c\u6570\u91cf lr_operation -> valid_from = head - datuv . \" \u6709\u6548\u8d77\u59cb\u65e5\u671f lr_operation -> valid_to_date = '99991231' . \" \u6709\u6548\u7ed3\u675f\u65e5\u671f lr_operation -> denominator = '1' . lr_operation -> nominator = '1' . \" \u8ba1\u91cf\u5355\u4f4d lr_operation -> operation_measure_unit = lr_item -> meinh . CALL FUNCTION 'CONVERSION_EXIT_CUNIT_INPUT' EXPORTING input = lr_operation -> operation_measure_unit IMPORTING output = lr_operation -> operation_measure_unit . \" \u8ba1\u91cf\u5355\u4f4d lr_operation -> operation_measure_unit_iso = lr_item -> meinh . CALL FUNCTION 'CONVERSION_EXIT_CUNIT_INPUT' EXPORTING input = lr_operation -> operation_measure_unit_iso IMPORTING output = lr_operation -> operation_measure_unit_iso . lr_operation -> no_of_employee = lr_item -> anzma . \" \u96c7\u5458\u6570\u91cf lr_operation -> valid_from = head - datuv . \" \u6709\u6548\u8d77\u59cb\u65e5\u671f lr_operation -> valid_to_date = '99991231' . \" \u6709\u6548\u7ed3\u675f\u65e5\u671f \" \u91cd\u590d\u4ee3\u7801 DEFINE _set_acti . lr_operation -> std_unit_0 &1 = lr_item -> vge0 &1 . lr_operation -> std_unit_0 &1 _iso = lr_item -> vge0 &1 . lr_operation -> std_value_0 &1 = lr_item -> vgw0 &1 . END-OF-DEFINITION . _set_acti 1 . \" \u6298\u65e7\u644a\u9500 _set_acti 2 . \" \u76f4\u63a5\u4eba\u5de5 _set_acti 3 . \" \u95f4\u63a5\u4eba\u5de5 _set_acti 4 . \" \u52a8\u529b\u8d39 _set_acti 5 . \" \u751f\u4ea7\u8017\u6750 _set_acti 6 . \" \u7ef4\u4fee\u4fdd\u517b ENDLOOP . ENDMETHOD . \" \u521d\u59cb\u5316\u53c2\u6570 METHOD init . CLEAR ms_group . CLEAR mt_task . CLEAR mt_mat_task . CLEAR mt_operation . CLEAR mt_return . ENDMETHOD . \" \u68c0\u67e5\u5de5\u5e8f\u662f\u5426\u5df2\u7ecf\u5b58\u5728 METHOD check_exists . DATA lt_return TYPE STANDARD TABLE OF bapiret2 . CALL FUNCTION 'BAPI_ROUTING_EXISTENCE_CHECK' EXPORTING group = group groupcounter = groupcounter validfrom = validfrom validtodate = validtodate TABLES return = lt_return . READ TABLE lt_return TRANSPORTING NO FIELDS WITH KEY type = 'E' . IF sy - subrc = 0 . result = 'X' . ENDIF . ENDMETHOD . \" \u68c0\u67e5\u5de5\u827a\u8def\u7ebf\u662f\u5426\u5b58\u5728 METHOD check_exist_by_mapl . DATA l_plnnr_alt TYPE plko - plnnr_alt . SELECT SINGLE plnnr_alt INTO @ l_plnnr_alt FROM mapl LEFT JOIN plko ON plko~plnty = mapl~plnty AND plko~plnnr = mapl~plnnr AND plko~plnal = mapl~plnal AND plko~zaehl = mapl~zaehl WHERE mapl~werks = @ werks AND mapl~matnr = @ matnr AND plko~plnnr_alt = @ plnnr_alt . IF sy - subrc = 0 . result = 'X' . ENDIF . ENDMETHOD . \" \u91cd\u590d\u7269\u6599\u4e0e\u5de5\u5382\u4e0b\u6700\u65b0\u7684\u8ba1\u6570 METHOD next_counter . SELECT SINGLE plnnr INTO @ group FROM mapl WHERE matnr = @ matnr AND werks = @ werks AND plnty = 'N' . IF sy - subrc = 0 . SELECT SINGLE MAX ( plnal ) INTO @ counter FROM plko WHERE plko~plnty = 'N' AND plko~plnnr = @ group . counter = counter + 1 . ENDIF . ENDMETHOD . ENDCLASS . *&---------------------------------------------------------------------* *& Class lcl_routing_change_proxy *&---------------------------------------------------------------------* CLASS lcl_routing_change_proxy DEFINITION . PUBLIC SECTION . METHODS : init , fill_data_by_type1 IMPORTING head TYPE zspp_0029_head items TYPE zttpp_0029_item , execute , get_message EXPORTING type TYPE bapi_mtype message TYPE bapi_msg . PRIVATE SECTION . DATA ms_maint_hdr TYPE cps_task_list_maint_hdr . DATA ms_task TYPE cps_task_list_maint_tsk . DATA ms_taskx TYPE cps_task_list_maint_tsk_x . DATA mt_mat_task TYPE STANDARD TABLE OF cps_task_list_maint_mtk . DATA mt_mat_taskx TYPE STANDARD TABLE OF cps_task_list_maint_mtk_x . DATA mt_operation TYPE STANDARD TABLE OF cps_task_list_maint_opr . DATA mt_operationx TYPE STANDARD TABLE OF cps_task_list_maint_opr_x . DATA mt_return TYPE bapiret2_t . ENDCLASS . \"lcl_bapi_proxy *&---------------------------------------------------------------------* *& Class lcl_routing_change_proxy *&---------------------------------------------------------------------* CLASS lcl_routing_change_proxy IMPLEMENTATION . \" \u8fd0\u884c METHOD execute . \" \u4fee\u6539\u5de5\u827a\u8def\u7ebf CALL FUNCTION 'CPCC_S_TASK_LIST_MAINTAIN' EXPORTING change_no = ms_maint_hdr - change_no key_date = ms_maint_hdr - key_date task_list_type = ms_maint_hdr - task_list_type task_list_group = ms_maint_hdr - task_list_group group_counter = ms_maint_hdr - group_counter material = ms_maint_hdr - material plant = ms_maint_hdr - plant task_maintain_mode = 'M' task = ms_task task_x = ms_taskx TABLES operations = mt_operation operations_x = mt_operationx return = mt_return . READ TABLE mt_return TRANSPORTING NO FIELDS WITH KEY type = 'E' . IF sy - subrc = 0 . CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK' . RETURN . ENDIF . CALL FUNCTION 'BAPI_TRANSACTION_COMMIT' EXPORTING wait = 'X' . ENDMETHOD . \" \u83b7\u53d6\u6d88\u606f METHOD get_message . READ TABLE mt_return TRANSPORTING NO FIELDS WITH KEY type = 'E' . IF sy - subrc = 0 . type = 'E' . LOOP AT mt_return REFERENCE INTO DATA ( lr_return ). MESSAGE ID lr_return -> id TYPE lr_return -> type NUMBER lr_return -> number WITH lr_return -> message_v1 lr_return -> message_v2 lr_return -> message_v3 lr_return -> message_v4 INTO DATA ( l_message ). message = |{ message }{ l_message } ; |. ENDLOOP . ELSE . type = 'S' . message = '\u4fee\u6539\u5de5\u827a\u8def\u7ebf\u6210\u529f' . ENDIF . ENDMETHOD . \" \u6839\u636e\u63a5\u53e3\u53c2\u6570\u586b\u5145\u6570\u636e METHOD fill_data_by_type1 . \" \u7528\u4e8e\u67e5\u8be2\u5de5\u827a\u8def\u7ebf\uff0c\u4ee5\u786e\u5b9a\u5de5\u827a\u8def\u7ebf\u884c\u9879\u76ee\u662f\u4fee\u6539\u8fd8\u662f\u65b0\u589e DATA lt_query_input TYPE zttpp_0027_input . DATA lt_query_output TYPE zttpp_0027_output . APPEND VALUE # ( zsqlx = '\u4fee\u6539' werks = head - werks matnr = head - matnr plnnr_alt = head - plnnr_alt ) TO lt_query_input . \" \u5de5\u827a\u8def\u7ebf\u67e5\u8be2 CALL FUNCTION 'ZPP_OA_ROUTING_QUERY_ESB' EXPORTING it_input = lt_query_input IMPORTING et_output = lt_query_output . SORT lt_query_output BY vornr . \" \u62ac\u5934 ms_maint_hdr - key_date = sy - datum . ms_maint_hdr - task_list_type = 'N' . ms_maint_hdr - task_list_group = head - plnnr . \" \u5de5\u827a\u8def\u7ebf\u7ec4 ms_maint_hdr - group_counter = head - plnal . \" \u7ec4\u8ba1\u6570\u5668 ms_maint_hdr - material = head - matnr . \" \u7269\u6599 ms_maint_hdr - plant = head - werks . \" \u5de5\u5382 DEFINE _set_task_field . ms_task - &1 = &2 . ms_taskx - &1 = 'X' . END-OF-DEFINITION . _set_task_field plant head - werks . \" \u5de5\u5382 _set_task_field old_number_of_task_list head - plnnr_alt . \" \u4ea7\u7ebf _set_task_field description head - ktext . \" \u5de5\u827a\u8def\u7ebf\u63cf\u8ff0 _set_task_field task_list_usage '1' . \" \u7528\u9014\uff0c\u9ed8\u8ba4\u503c _set_task_field task_list_status '4' . \" \u72b6\u6001\uff0c\u9ed8\u8ba4\u503c _set_task_field lot_size_from head - losvn . \" \u6279\u91cf\u4e0b\u9650 _set_task_field lot_size_to head - losbs . \" \u4ea7\u7ebf\u6279\u91cf\u4e0a\u9650 _set_task_field task_measure_unit 'PCS' . \" \u5355\u4f4d LOOP AT items REFERENCE INTO DATA ( lr_item ). \" \u5de5\u5e8f APPEND INITIAL LINE TO mt_operation REFERENCE INTO DATA ( lr_operation ). APPEND INITIAL LINE TO mt_operationx REFERENCE INTO DATA ( lr_operationx ). \" \u68c0\u67e5\u5de5\u5e8f\u662f\u5426\u5b58\u5728\uff0c\u5b58\u5728\u4fee\u6539\uff0c\u4e0d\u5b58\u5728\u65b0\u589e READ TABLE lt_query_output REFERENCE INTO DATA ( lr_query_output ) WITH KEY vornr = lr_item -> vornr BINARY SEARCH . IF sy - subrc = 0 . lr_operation -> maintain_mode = 'M' . ELSE . lr_operation -> maintain_mode = 'C' . ENDIF . \" \u5de5\u5e8f\u7f16\u53f7 lr_operation -> activity = lr_item -> vornr . lr_operationx -> activity = 'X' . lr_operation -> activity_old = lr_item -> vornr . lr_operation -> flag_bar_pointer = '1' . DEFINE _set_operation_filed . lr_operation -> &1 = &2 . lr_operationx -> &1 = 'X' . END-OF-DEFINITION . _set_operation_filed plant head - werks . \" \u5de5\u5382 _set_operation_filed description lr_item -> ltxa1 . \" \u5de5\u5e8f\u77ed\u6587\u672c _set_operation_filed standard_text_key lr_item -> vlsch . \" \u6807\u51c6\u6587\u672c\u7801 _set_operation_filed work_cntr lr_item -> arbpl . \" \u5de5\u4f5c\u4e2d\u5fc3 _set_operation_filed control_key lr_item -> steus . \" \u63a7\u5236\u7801 _set_operation_filed base_quantity lr_item -> bmsch . \" \u5de5\u5e8f\u57fa\u672c\u6570\u91cf _set_operation_filed operation_measure_unit lr_item -> meinh . \" \u8ba1\u91cf\u5355\u4f4d _set_operation_filed no_of_employee lr_item -> anzma . \" \u96c7\u5458\u6570\u91cf _set_operation_filed denominator '1' . _set_operation_filed nominator '1' . \" \u91cd\u590d\u4ee3\u7801 DEFINE _set_acti . _set_operation_filed std_unit_0 &1 lr_item -> vge0 &1 . * _set_operation_filed std_unit_0&1_iso lr_item->vge0&1. _set_operation_filed std_value_0 &1 lr_item -> vgw0 &1 . END-OF-DEFINITION . _set_acti 1 . \" \u6298\u65e7\u644a\u9500 _set_acti 2 . \" \u76f4\u63a5\u4eba\u5de5 _set_acti 3 . \" \u95f4\u63a5\u4eba\u5de5 _set_acti 4 . \" \u52a8\u529b\u8d39 _set_acti 5 . \" \u751f\u4ea7\u8017\u6750 _set_acti 6 . \" \u7ef4\u4fee\u4fdd\u517b ENDLOOP . ENDMETHOD . \" \u521d\u59cb\u5316\u53c2\u6570 METHOD init . CLEAR ms_maint_hdr . CLEAR ms_task . CLEAR ms_taskx . CLEAR mt_mat_task . CLEAR mt_mat_taskx . CLEAR mt_operation . CLEAR mt_operationx . CLEAR mt_return . ENDMETHOD . ENDCLASS .","title":"\u5de5\u827a\u8def\u7ebf"},{"location":"pp/pp_version/","text":"\u751f\u4ea7\u62a5\u5de5 \u00b6","title":"\u751f\u4ea7\u7248\u672c"},{"location":"pp/pp_version/#_1","text":"","title":"\u751f\u4ea7\u62a5\u5de5"},{"location":"report/","text":"\u5e38\u7528\u62a5\u8868 \u00b6 \u62a5\u8868\u8981\u600e\u4e48\u5c55\u793a\uff0c\u5177\u4f53\u8fd8\u662f\u770b\u9879\u76ee\u5b9e\u9645\u9700\u6c42\uff0c\u6211\u8fd9\u8fb9\u53ea\u80fd\u7ed9\u51fa\u5927\u81f4\u601d\u8def\u3002 \u8d22\u52a1\u4e09\u5927\u62a5\u8868\u57fa\u672c\u53ef\u4ee5\u7167\u642c\uff0c\u4e00\u822c\u4e5f\u5c31\u914d\u7f6e\u7684\u79d1\u76ee\u7a0d\u6709\u5dee\u5f02","title":"\u62a5\u8868\u6982\u8ff0"},{"location":"report/#_1","text":"\u62a5\u8868\u8981\u600e\u4e48\u5c55\u793a\uff0c\u5177\u4f53\u8fd8\u662f\u770b\u9879\u76ee\u5b9e\u9645\u9700\u6c42\uff0c\u6211\u8fd9\u8fb9\u53ea\u80fd\u7ed9\u51fa\u5927\u81f4\u601d\u8def\u3002 \u8d22\u52a1\u4e09\u5927\u62a5\u8868\u57fa\u672c\u53ef\u4ee5\u7167\u642c\uff0c\u4e00\u822c\u4e5f\u5c31\u914d\u7f6e\u7684\u79d1\u76ee\u7a0d\u6709\u5dee\u5f02","title":"\u5e38\u7528\u62a5\u8868"},{"location":"report/stock/","text":"\u5e93\u5b58\u62a5\u8868 \u00b6 \u5efa\u8bae\u4f7f\u7528\u6807\u51c6\u62a5\u8868J3RFLVMOBVEDH\u4f5c\u4e3a\u53d6\u6570\u4f9d\u636e\uff0c\u57fa\u672c\u80fd\u6ee1\u8db3\u6b63\u5e38\u7684\u60c5\u51b5\uff0c\u518d\u8865\u5145\u4e00\u4e9b\u7279\u6b8a\u7684\u53d6\u503c\u903b\u8f91\uff0c\u4e00\u4e2a\u5e93\u5b58\u62a5\u8868\u5c31\u5b8c\u6210\u4e86\u3002 \u793a\u4f8b\u4ee3\u7801","title":"\u5e93\u5b58\u62a5\u8868"},{"location":"report/stock/#_1","text":"\u5efa\u8bae\u4f7f\u7528\u6807\u51c6\u62a5\u8868J3RFLVMOBVEDH\u4f5c\u4e3a\u53d6\u6570\u4f9d\u636e\uff0c\u57fa\u672c\u80fd\u6ee1\u8db3\u6b63\u5e38\u7684\u60c5\u51b5\uff0c\u518d\u8865\u5145\u4e00\u4e9b\u7279\u6b8a\u7684\u53d6\u503c\u903b\u8f91\uff0c\u4e00\u4e2a\u5e93\u5b58\u62a5\u8868\u5c31\u5b8c\u6210\u4e86\u3002 \u793a\u4f8b\u4ee3\u7801","title":"\u5e93\u5b58\u62a5\u8868"},{"location":"report/zlogreport/","text":"\u65e5\u5fd7\u67e5\u8be2\u7a0b\u5e8f \u00b6 \u8be5\u7a0b\u5e8f\u7528\u4e8e\u67e5\u8be2\u63a5\u53e3\u65e5\u5fd7\uff0c\u5e76\u5df2\u52a0\u5165PO\u65e5\u5fd7\u67e5\u8be2\uff08\u4ec5\u9650\u7cfb\u7edf\u5185\u5b58\u50a8\u7684\u65e5\u5fd7\u6570\u636e\uff09\uff0c\u5982\u6709\u81ea\u5b9a\u4e49\u65e5\u5fd7\u6570\u636e\u60f3\u8981\u5c55\u793a\uff0c\u9700\u8981\u7ee7\u627f\u672c\u5730\u63a5\u53e3LIF_LOG\uff0c\u5e76\u5b9e\u65bd\u63a5\u53e3\u65b9\u6cd5\u3002 \u62a5\u8868\u6267\u884c\u65f6\u4f1a\u68c0\u7d22\u5b9e\u4f8b\u7c7b\uff0c\u56e0\u6b64\u65e0\u9700\u624b\u5de5\u521b\u5efa\u65b0\u7684\u65e5\u5fd7\u5b9e\u4f8b\uff08CREATE OBJECT\uff0cNEW #()\u7b49\uff09\u3002 \u793a\u4f8b\u4ee3\u7801 *&---------------------------------------------------------------------* *& REPORT ZLOGREPORT *&---------------------------------------------------------------------* *& V2 - XIAOFENG - 2022-09-26 14:11:17 *& \u4e0a\u4e2a\u9879\u76ee\u7684\u90a3\u7248\u5199\u5f97\u592a\u590d\u6742\uff0c\u65e0\u6cd5\u6269\u5c55\uff0c\u8fd9\u6b21\u4e58\u673a\u7b80\u5316\u4e0b\u4ee3\u7801 *& \u4f7f\u7528\u6b65\u9aa4\uff1a *& 1 \u4ee3\u7801\u590d\u5236\u7c98\u8d34 *& 2 \u521b\u5efa9000\u5c4f\u5e55\uff0c\u6dfb\u52a0\u4e00\u4e2a\u5bb9\u5668\uff08\u5c5e\u6027\u6539\u81ea\u9002\u5e94\uff09\uff0c\u547d\u540dCON_9000 *& 3 \u521b\u5efa\u72b6\u6001\u680fSTATUS *& 3.1 \u6dfb\u52a0\u4e09\u4e2a\u9000\u51fa\u6309\u94ae\uff08&F03\\&F15\\&F12\uff09 *& 3.2 \u6dfb\u52a0REDO\u6309\u94ae\uff0c\u7528\u4e8e\u9519\u8bef\u6570\u636e\u91cd\u5904\u7406\uff0c\u6ca1\u6709\u7684\u8bdd\u5ffd\u7565\u5373\u53ef *& 4 \u65b0\u5efa\u5b9e\u65bd\u7c7b\uff0c\u7ee7\u627f\u63a5\u53e3LIF_LOG\uff0c\u628a\u63a5\u53e3\u65b9\u6cd5\u5b9e\u65bd\u5373\u53ef *& 4.1 GET_LOG_KIND\uff0c\u4e3a\u6bcf\u79cd\u65e5\u5fd7\u8bbe\u5b9a\u552f\u4e00\u540d\u79f0 *& 4.2 GET_DATA\uff0c\u67e5\u8be2\u65e5\u5fd7\u6570\u636e\uff0c\u5199\u5165\u5230GT_LOG\u548cGT_LOG_RAWDATA\u4e2d\uff08\u5f39\u7a97\u7528\uff09 *& 4.3 REDO\uff0c\u9519\u8bef\u91cd\u5904\u7406 *&---------------------------------------------------------------------* REPORT ZLOGREPORT *&---------------------------------------------------------------------* *& \u672c\u5730\u7c7b\u58f0\u660e *&---------------------------------------------------------------------* CLASS lcl_progress DEFINITION DEFERRED . \" \u8fdb\u5ea6\u6761 \" \u6570\u636e\u5904\u7406\u76f8\u5173 INTERFACE lif_unit_parser DEFERRED . CLASS lcl_data_unit_parser DEFINITION DEFERRED . CLASS lcl_json_unit_parser DEFINITION DEFERRED . CLASS lcl_xml_unit_parser DEFINITION DEFERRED . CLASS lcl_unit_helper DEFINITION DEFERRED . \" ALV\u76f8\u5173 INTERFACE lif_alv DEFERRED . CLASS lcl_alv_logh DEFINITION DEFERRED . \" \u65e5\u5fd7\u62ac\u5934\u6570\u636e\u5c55\u793a CLASS lcl_alv_unit DEFINITION DEFERRED . \" \u5355\u5143\u6570\u636e\u5c55\u793a CLASS lcl_alv_flat DEFINITION DEFERRED . \" \u6241\u5e73\u7ed3\u6784\u5c55\u793a \" \u65e5\u5fd7\u5904\u7406\u76f8\u5173 INTERFACE lif_log DEFERRED . CLASS lcl_log_po DEFINITION DEFERRED . \" PO\u65e5\u5fd7 CLASS lcl_log_custom DEFINITION DEFERRED . \" \u81ea\u5b9a\u4e49\u65e5\u5fd7 *&---------------------------------------------------------------------* *& \u7c7b\u578b\u5b9a\u4e49 *&---------------------------------------------------------------------* \" \u6570\u636e\u5355\u5143\uff0c\u7b80\u5355\u6765\u8bf4\uff0c\u4e00\u4e2a\u503c\u5c31\u662f\u4e00\u4e2a\u5355\u5143 TYPES : BEGIN OF ty_unit , path TYPE string , \" \u8def\u5f84 key TYPE string , \" \u952e value TYPE string , \" \u503c END OF ty_unit . TYPES tt_unit TYPE STANDARD TABLE OF ty_unit WITH EMPTY KEY . \" \u6241\u5e73\u7ed3\u6784\u4fe1\u606f TYPES : BEGIN OF ty_flatdt , struct TYPE string , \" \u7ed3\u6784 field TYPE string , \" \u5b57\u6bb5 position TYPE i , \" \u4f4d\u7f6e END OF ty_flatdt . TYPES tt_flatdt TYPE STANDARD TABLE OF ty_flatdt WITH EMPTY KEY . \" \u6570\u636e\u5355\u5143\u6269\u5c55 TYPES : BEGIN OF ty_unitex , \" \u521b\u5efa\u6241\u5e73\u7ed3\u6784\u7528\u5230 struct TYPE string , \" \u7ed3\u6784 path TYPE string , \" \u8def\u5f84 key TYPE string , \" \u952e value TYPE string , \" \u503c END OF ty_unitex . TYPES tt_unitex TYPE STANDARD TABLE OF ty_unitex WITH EMPTY KEY . \" \u65e5\u5fd7\u62ac\u5934\u4fe1\u606f TYPES : BEGIN OF ty_log_head , uuid TYPE sysuuid_c32 , \" \u65e5\u5fd7ID zitem TYPE i , \" \u5e8f\u53f7 log_kind TYPE c LENGTH 20 , \" \u65e5\u5fd7\u79cd\u7c7b\uff0c\u5982PI\u65e5\u5fd7\uff0c\u65e5\u5fd7\u7b49\u591a\u79cd intf_id TYPE c LENGTH 30 , \" \u63a5\u53e3\u6807\u8bc6 func_name TYPE rs38l_fnam , \" \u51fd\u6570\u540d func_text TYPE c LENGTH 40 , \" \u51fd\u6570\u63cf\u8ff0 ztext TYPE c LENGTH 255 , \" \u9644\u52a0\u4fe1\u606f\uff0c\u6709\u4e9b\u63a5\u53e3\u4f1a\u5728\u8bb0\u5f55\u7684\u65f6\u5019\u9644\u52a0\u4e00\u4e9b\u63cf\u8ff0\u8bf4\u660e io_flag TYPE c LENGTH 10 , \" \u5165\u53c2\u6216\u51fa\u53c2 zconut TYPE i , \" \u6761\u76ee\u7edf\u8ba1 zsender TYPE c LENGTH 20 , \" \u53d1\u9001\u65b9 zreceiver TYPE c LENGTH 20 , \" \u63a5\u53d7\u65b9 zraw_icon TYPE icon_d , \" \u53cc\u51fb\u5c55\u793a\u539f\u59cb\u6570\u636e zdate TYPE datum , \" \u65e5\u671f ztime TYPE uzeit , \" \u65f6\u95f4 zuser TYPE uname , \" \u7528\u6237 mtype TYPE bapi_mtype , \" \u72b6\u6001 msg TYPE bapi_msg , \" \u6d88\u606f\u6587\u672c rcol TYPE c LENGTH 4 , \" \u884c\u989c\u8272 t_scol TYPE lvc_t_scol , \" \u5355\u5143\u683c\u989c\u8272 t_styl TYPE lvc_t_styl , \" \u5355\u5143\u683c\u6837\u5f0f END OF ty_log_head . \" \u65e5\u5fd7\u6570\u636e TYPES : BEGIN OF ty_log_data , * r_data TYPE REF TO data, \" \u65e5\u5fd7\u6570\u636e t_unit TYPE tt_unit , \" \u6570\u636e\u5355\u5143 r_flatdata TYPE REF TO data , \" \u6241\u5e73\u7ed3\u6784\u6570\u636e t_flatdt TYPE tt_flatdt , \" \u6241\u5e73\u7ed3\u6784 END OF ty_log_data . TYPES : BEGIN OF ty_log . INCLUDE TYPE ty_log_head . INCLUDE TYPE ty_log_data . TYPES : END OF ty_log . TYPES tt_log TYPE STANDARD TABLE OF ty_log . \" \u65e5\u5fd7\u539f\u59cb\u6570\u636e TYPES : BEGIN OF ty_log_rawdata , uuid TYPE sysuuid_c32 , \" \u65e5\u5fd7ID zitem TYPE i , \" \u5e8f\u53f7 zformat TYPE c LENGTH 10 , \" \u539f\u59cb\u6570\u636e\u683c\u5f0f zraw TYPE string , \" \u539f\u59cb\u6570\u636e zrawx TYPE xstring , \" \u539f\u59cb\u6570\u636e END OF ty_log_rawdata . TYPES tt_log_rawdata TYPE STANDARD TABLE OF ty_log_rawdata . TYPES tt_uuid TYPE STANDARD TABLE OF ty_log_head - uuid . TYPES tt_uuid_opt TYPE RANGE OF ty_log_head - uuid . *&---------------------------------------------------------------------* *& \u6570\u636e\u58f0\u660e *&---------------------------------------------------------------------* DATA gt_log TYPE tt_log . \" \u65e5\u5fd7\u6570\u636e DATA gt_log_rawdata TYPE tt_log_rawdata . \" \u65e5\u5fd7\u6570\u636e DATA gt_log_impl TYPE STANDARD TABLE OF REF TO lif_log . DATA go_alv TYPE REF TO lif_alv . \" ALV\u5bf9\u8c61 DATA go_container TYPE REF TO cl_gui_container . DATA go_grid TYPE REF TO cl_gui_alv_grid . DATA : BEGIN OF gs_fieldname , fdlk TYPE string VALUE 'FDLK' , \" FLAT_DATA_LINE_KIND path TYPE string VALUE 'PATH' , field TYPE string VALUE '__FIELD' , END OF gs_fieldname . DATA : BEGIN OF gs_fdlk , header TYPE string VALUE 'HEADER' , data TYPE string VALUE 'DATA' , END OF gs_fdlk . DATA : BEGIN OF gs_color , blue TYPE lvc_s_colo , yellow TYPE lvc_s_colo , green TYPE lvc_s_colo , red TYPE lvc_s_colo , dept_blue TYPE lvc_s_colo , dept_yellow TYPE lvc_s_colo , dept_green TYPE lvc_s_colo , dept_red TYPE lvc_s_colo , END OF gs_color . *&---------------------------------------------------------------------* *& \u9009\u62e9\u5c4f\u5e55 *&---------------------------------------------------------------------* TABLES sxmspmast . \" PO\u76f8\u5173 TABLES sxmspemas . \" PO\u76f8\u5173 \" \u9009\u62e9\u6761\u4ef6 DATA : BEGIN OF gs_selection . INCLUDE TYPE ty_log_head . DATA : intfid TYPE char30 , \" \u81ea\u5b9a\u4e49\u65e5\u5fd7\u63a5\u53e3\u6807\u8bc6 * INCLUDE TYPE ty_unit. field TYPE char30 , \" TY_UNIT-FIELD\uff0cSTRING\u7c7b\u578b\u7684\uff0c\u4e0d\u80fd\u4f7f\u7528 value TYPE char30 . \" TY_UNIT-VALUE\uff0cSTRING\u7c7b\u578b\u7684\uff0c\u4e0d\u80fd\u4f7f\u7528 DATA : END OF gs_selection . \" \u81ea\u5b9a\u4e49\u9009\u62e9\u6761\u4ef6 SELECTION-SCREEN BEGIN OF BLOCK b900 WITH FRAME TITLE b900 . PARAMETERS p_custom TYPE xflag AS CHECKBOX DEFAULT 'X' . SELECT-OPTIONS s_intfid FOR gs_selection - intfid . SELECTION-SCREEN END OF BLOCK b900 . \" \u901a\u7528\u9009\u62e9\u6761\u4ef6 SELECTION-SCREEN BEGIN OF BLOCK b100 WITH FRAME TITLE b100 . SELECT-OPTIONS s_uuid FOR gs_selection - uuid . SELECT-OPTIONS s_func FOR gs_selection - func_name MATCHCODE OBJECT sfunc_modules . SELECT-OPTIONS s_snd FOR gs_selection - zsender . SELECT-OPTIONS s_rcv FOR gs_selection - zreceiver . SELECT-OPTIONS s_user FOR gs_selection - zuser MATCHCODE OBJECT user_comp . SELECT-OPTIONS s_date FOR gs_selection - zdate NO-EXTENSION OBLIGATORY DEFAULT sy - datum . SELECT-OPTIONS s_time FOR gs_selection - ztime NO-EXTENSION . SELECT-OPTIONS s_mtype FOR gs_selection - mtype . \" PO\u9009\u62e9\u6761\u4ef6 SELECTION-SCREEN BEGIN OF BLOCK b102 WITH FRAME TITLE b102 . PARAMETERS p_po TYPE xflag AS CHECKBOX DEFAULT 'X' . SELECT-OPTIONS s_siname FOR sxmspemas - ob_name . SELECTION-SCREEN END OF BLOCK b102 . \" \u6269\u5c55\u9009\u62e9\u6761\u4ef6 SELECTION-SCREEN BEGIN OF BLOCK b101 WITH FRAME TITLE b101 . SELECT-OPTIONS s_field FOR gs_selection - field . SELECT-OPTIONS s_value FOR gs_selection - value . SELECTION-SCREEN END OF BLOCK b101 . SELECTION-SCREEN END OF BLOCK b100 . \" \u5c55\u793a\u65b9\u5f0f SELECTION-SCREEN BEGIN OF BLOCK b200 WITH FRAME TITLE b200 . PARAMETERS p_logh RADIOBUTTON GROUP rg1 TYPE xflag DEFAULT 'X' . PARAMETERS p_flat RADIOBUTTON GROUP rg1 TYPE xflag . PARAMETERS p_unit RADIOBUTTON GROUP rg1 TYPE xflag . SELECTION-SCREEN BEGIN OF BLOCK b201 WITH FRAME TITLE b201 . PARAMETERS p_ctl1 TYPE xflag AS CHECKBOX . \" \u7d27\u51d1\u8868\u793a PARAMETERS p_ctl2 TYPE xflag AS CHECKBOX DEFAULT 'X' . PARAMETERS p_ctl3 TYPE xflag AS CHECKBOX DEFAULT 'X' . PARAMETERS p_ctl4 TYPE xflag AS CHECKBOX DEFAULT 'X' . PARAMETERS p_ctl5 TYPE i DEFAULT 1 . SELECTION-SCREEN END OF BLOCK b201 . SELECTION-SCREEN END OF BLOCK b200 . *&---------------------------------------------------------------------* *& \u672c\u5730\u7c7b\u5b9a\u4e49 *&---------------------------------------------------------------------* *&---------------------------------------------------------------------* *& CLASS LCL_PROGRESS *&---------------------------------------------------------------------* CLASS lcl_progress DEFINITION FINAL . PUBLIC SECTION . DATA m_total TYPE i . DATA m_current TYPE i . DATA m_time_start TYPE timestampl . DATA m_time TYPE timestampl . DATA m_interval TYPE i . DATA m_name TYPE string . METHODS start \" \u521d\u59cb\u5316 IMPORTING total TYPE i OPTIONAL RETURNING VALUE ( result ) TYPE REF TO lcl_progress . METHODS next \" \u589e\u52a0\u4e00\u70b9\u8fdb\u5ea6 IMPORTING delta TYPE i DEFAULT 1 RETURNING VALUE ( result ) TYPE REF TO lcl_progress . METHODS finish \" \u7ed3\u675f RETURNING VALUE ( result ) TYPE REF TO lcl_progress . METHODS show \" \u5de6\u4e0b\u89d2\u6d88\u606f IMPORTING text TYPE string OPTIONAL . METHODS percentage \" \u5f53\u524d\u8fdb\u5ea6 RETURNING VALUE ( result ) TYPE f . METHODS duration \" \u8fd0\u884c\u65f6\u95f4 RETURNING VALUE ( result ) TYPE f . CLASS-METHODS step \" \u5c55\u793a\u5355\u4e2a\u6761\u76ee IMPORTING text TYPE string OPTIONAL . ENDCLASS . *&---------------------------------------------------------------------* *& CLASS (IMPLEMENTATION) LCL_PROGRESS *&---------------------------------------------------------------------* CLASS lcl_progress IMPLEMENTATION . *&---------------------------------------------------------------------* *& START *&---------------------------------------------------------------------* METHOD start . result = me . m_total = total . IF m_interval = 0 . m_interval = 1 . \" \u4e0d\u52a0\u9650\u5236\u53cd\u800c\u5f71\u54cd\u6027\u80fd ENDIF . m_current = 0 . GET TIME STAMP FIELD m_time_start . m_time = m_time_start . ENDMETHOD . *&---------------------------------------------------------------------* *& NEXT *&---------------------------------------------------------------------* METHOD next . result = me . m_current = m_current + delta . DATA l_time TYPE timestampl . GET TIME STAMP FIELD l_time . IF m_current = m_total . m_time = l_time . ENDIF . IF m_time <= l_time . show ( ). IF m_interval > 0 . m_time = cl_abap_tstmp => add ( tstmp = l_time secs = m_interval ). ELSE . m_time = l_time . ENDIF . ENDIF . ENDMETHOD . *&---------------------------------------------------------------------* *& FINISH *&---------------------------------------------------------------------* METHOD finish . result = me . GET TIME STAMP FIELD m_time . show ( ). ENDMETHOD . *&---------------------------------------------------------------------* *& SHOW *&---------------------------------------------------------------------* METHOD show . DATA ( l_text ) = text . IF l_text IS INITIAL . l_text = |{ percentage ( ) DECIMALS = 0 } % [ { m_current NUMBER = USER } / { m_total NUMBER = USER } ] { duration ( ) DECIMALS = 0 } S |. IF m_name IS NOT INITIAL . l_text = |{ m_name } : { l_text }|. ENDIF . ENDIF . IF sy - batch = '' . CALL FUNCTION 'SAPGUI_PROGRESS_INDICATOR' EXPORTING text = l_text . ELSE . MESSAGE l_text TYPE 'S' . ENDIF . ENDMETHOD . *&---------------------------------------------------------------------* *& PERCENTAGE *&---------------------------------------------------------------------* METHOD percentage . IF m_total <> 0 . result = m_current / m_total * 100 . ENDIF . ENDMETHOD . *&---------------------------------------------------------------------* *& DURATION *&---------------------------------------------------------------------* METHOD duration . result = cl_abap_tstmp => subtract ( tstmp1 = m_time tstmp2 = m_time_start ). ENDMETHOD . *&---------------------------------------------------------------------* *& STEP *&---------------------------------------------------------------------* METHOD step . CALL FUNCTION 'SAPGUI_PROGRESS_INDICATOR' EXPORTING text = text . ENDMETHOD . ENDCLASS . *&---------------------------------------------------------------------* *& LIF_UNIT_PARSER DEFINITION *&---------------------------------------------------------------------* INTERFACE lif_unit_parser . METHODS parse RETURNING VALUE ( rt_result ) TYPE tt_unit . ENDINTERFACE . *&---------------------------------------------------------------------* *& LCL_DATA_UNIT_PARSER DEFINITION *&---------------------------------------------------------------------* CLASS lcl_data_unit_parser DEFINITION . PUBLIC SECTION . INTERFACES lif_unit_parser . METHODS constructor IMPORTING ir_data TYPE REF TO data . PRIVATE SECTION . DATA mr_data TYPE REF TO data . DATA mt_unit TYPE tt_unit . METHODS _parse IMPORTING ir_data TYPE REF TO data i_path TYPE string DEFAULT '$' i_name TYPE string OPTIONAL io_typedescr TYPE REF TO cl_abap_typedescr OPTIONAL . ENDCLASS . *&---------------------------------------------------------------------* *& LCL_JSON_UNIT_PARSER DEFINITION *&---------------------------------------------------------------------* CLASS lcl_json_unit_parser DEFINITION . PUBLIC SECTION . INTERFACES lif_unit_parser . METHODS constructor IMPORTING i_json TYPE string . PRIVATE SECTION . DATA m_json TYPE string . ENDCLASS . *&---------------------------------------------------------------------* *& LCL_XML_UNIT_PARSER DEFINITION *&---------------------------------------------------------------------* CLASS lcl_xml_unit_parser DEFINITION . PUBLIC SECTION . INTERFACES lif_unit_parser . METHODS constructor IMPORTING i_xml TYPE xstring . PRIVATE SECTION . DATA m_xml TYPE xstring . DATA mt_unit TYPE tt_unit . ENDCLASS . *&---------------------------------------------------------------------* *& LCL_UNIT_HELPER DEFINITION *&---------------------------------------------------------------------* CLASS lcl_unit_helper DEFINITION . PUBLIC SECTION . CLASS-METHODS parse_data IMPORTING ir_data TYPE REF TO data RETURNING VALUE ( rt_result ) TYPE tt_unit . CLASS-METHODS parse_json IMPORTING i_json TYPE string RETURNING VALUE ( rt_result ) TYPE tt_unit . CLASS-METHODS parse_xml IMPORTING i_xml TYPE xstring RETURNING VALUE ( rt_result ) TYPE tt_unit . CLASS-METHODS generate_flatdata IMPORTING it_unit TYPE tt_unit i_compact TYPE xfeld OPTIONAL EXPORTING et_flatdt TYPE tt_flatdt RETURNING VALUE ( rr_data ) TYPE REF TO data . ENDCLASS . *&---------------------------------------------------------------------* *& LCL_DATA_UNIT_PARSER IMPLEMENTATION *&---------------------------------------------------------------------* CLASS lcl_data_unit_parser IMPLEMENTATION . *&---------------------------------------------------------------------* *& METHOD CONSTRUCTOR *&---------------------------------------------------------------------* METHOD constructor . mr_data = ir_data . ENDMETHOD . *&---------------------------------------------------------------------* *& METHOD LIF_UNIT_PARSER~PARSE *&---------------------------------------------------------------------* METHOD lif_unit_parser~parse . _parse ( mr_data ). rt_result = mt_unit . ENDMETHOD . *&---------------------------------------------------------------------* *& METHOD _PARSE *&---------------------------------------------------------------------* METHOD _parse . \" \u7b80\u5355\u6765\u8bf4\uff0c\u5c31\u662f\u83b7\u53d6\u6570\u636e\u7684\u6bcf\u4e2a\u5b57\u6bb5\u503c\uff0c\u5e76\u8bb0\u5f55\u5bf9\u5e94\u8def\u5f84 \" \u6570\u636e\u89e3\u6790\u76f8\u5173\u53c2\u6570 DATA lo_typedescr TYPE REF TO cl_abap_typedescr . DATA lo_tabledescr TYPE REF TO cl_abap_tabledescr . DATA lo_structdescr TYPE REF TO cl_abap_structdescr . DATA lt_component TYPE cl_abap_structdescr => component_table . DATA lr_component TYPE REF TO cl_abap_structdescr => component . \" \u52a8\u6001\u53c2\u6570 FIELD-SYMBOLS <fs_table> TYPE STANDARD TABLE . FIELD-SYMBOLS <fs_structure> TYPE any . FIELD-SYMBOLS <fs_field> TYPE any . \" \u52a8\u6001\u5f15\u7528\u53c2\u6570 FIELD-SYMBOLS <fs_ref> TYPE REF TO data . \" \u6570\u636e\u6821\u9a8c CHECK ir_data IS BOUND . IF io_typedescr IS BOUND . lo_typedescr = io_typedescr . ELSE . lo_typedescr = cl_abap_typedescr => describe_by_data_ref ( ir_data ). ENDIF . \" \u8def\u5f84\u5904\u7406 DATA l_pathname TYPE string . IF i_name IS INITIAL . l_pathname = i_path . ELSE . l_pathname = |{ i_path } . { i_name }|. ENDIF . \" \u4e3b\u8981\u5904\u7406\u8868\u3001\u7ed3\u6784\u3001\u6570\u636e\u5143\u7d20\u3001\u5f15\u7528\u56db\u79cd\u7c7b\u578b \" \u7c7b\u548c\u63a5\u53e3\u65e0\u9700\u5904\u7406 CASE lo_typedescr -> kind . WHEN cl_abap_typedescr => kind_table . \" \u8868\u683c\u7c7b\u578b ASSIGN ir_data->* TO <fs_table> . lo_tabledescr ?= lo_typedescr . lo_typedescr = lo_tabledescr -> get_table_line_type ( ). \" \u8868\u884c\u7c7b\u578b DATA l_tabix TYPE sy - tabix . \" \u6240\u5728\u884c IF lo_typedescr -> kind = cl_abap_typedescr => kind_ref . LOOP AT <fs_table> ASSIGNING <fs_ref> . l_tabix = sy - tabix . _parse ( \" \u5f15\u7528\u7c7b\u578b\u76f4\u63a5\u8fed\u4ee3 ir_data = <fs_ref> i_path = |{ l_pathname } [ { l_tabix } ] | ). ENDLOOP . ELSE . \" \u975e\u5f15\u7528\u7c7b\u578b\u7ee7\u7eed\u5206\u6790\u8868\u884c\u7c7b\u578b lo_structdescr ?= lo_typedescr . lt_component = lo_structdescr -> get_components ( ). LOOP AT <fs_table> ASSIGNING <fs_structure> . l_tabix = sy - tabix . LOOP AT lt_component REFERENCE INTO lr_component . ASSIGN COMPONENT lr_component -> name OF STRUCTURE <fs_structure> TO <fs_field> . IF lr_component -> type IS BOUND . _parse ( \" \u5982\u679c\u884c\u7ed3\u6784\u5b57\u6bb5\u4e5f\u662f\u5f15\u7528\u7c7b\u578b\uff0c\u7ee7\u7eed\u8fed\u4ee3 ir_data = REF # ( <fs_field> ) i_path = |{ l_pathname } [ { l_tabix } ] | i_name = lr_component -> name io_typedescr = lr_component -> type ). ELSEIF <fs_field> IS ASSIGNED . INSERT VALUE # ( path = |{ l_pathname } [ { l_tabix } ] | key = lr_component -> name value = <fs_field> ) INTO TABLE mt_unit . ENDIF . ENDLOOP . ENDLOOP . ENDIF . WHEN cl_abap_typedescr => kind_struct . \" \u7ed3\u6784\u7c7b\u578b ASSIGN ir_data->* TO <fs_structure> . lo_structdescr ?= lo_typedescr . lt_component = lo_structdescr -> get_components ( ). LOOP AT lt_component REFERENCE INTO lr_component . IF lr_component -> type IS BOUND . \" \u975e\u6570\u636e\u5143\u7d20\u7c7b\u578b\uff0c\u7ee7\u7eed\u8fed\u4ee3 IF lr_component -> type -> kind = cl_abap_typedescr => kind_ref . \" \u5f15\u7528\u7c7b\u578b\u5904\u7406 ASSIGN COMPONENT lr_component -> name OF STRUCTURE <fs_structure> TO <fs_ref> . _parse ( ir_data = <fs_ref> i_path = l_pathname i_name = lr_component -> name ). ELSE . \" \u975e\u5f15\u7528\u7c7b\u578b\u6570\u636e ASSIGN COMPONENT lr_component -> name OF STRUCTURE <fs_structure> TO <fs_field> . _parse ( ir_data = REF # ( <fs_field> ) i_path = l_pathname i_name = lr_component -> name ). ENDIF . ELSE . ASSIGN COMPONENT lr_component -> name OF STRUCTURE <fs_structure> TO <fs_field> . INSERT VALUE # ( path = l_pathname key = lr_component -> name value = <fs_field> ) INTO TABLE mt_unit . ENDIF . ENDLOOP . WHEN cl_abap_typedescr => kind_elem . \" \u6570\u636e\u5143\u7d20\u7c7b\u578b ASSIGN ir_data->* TO <fs_field> . INSERT VALUE # ( path = i_path key = i_name value = <fs_field> ) INTO TABLE mt_unit . WHEN cl_abap_typedescr => kind_ref . \" \u5f15\u7528\u7c7b\u578b\uff0c\u7ee7\u7eed\u8fed\u4ee3 ASSIGN ir_data->* TO <fs_ref> . _parse ( ir_data = <fs_ref> i_path = i_path i_name = i_name ). ENDCASE . ENDMETHOD . ENDCLASS . *&---------------------------------------------------------------------* *& LCL_JSON_UNIT_PARSER IMPLEMENTATION *&---------------------------------------------------------------------* CLASS lcl_json_unit_parser IMPLEMENTATION . *&---------------------------------------------------------------------* *& METHOD CONSTRUCTOR *&---------------------------------------------------------------------* METHOD constructor . m_json = i_json . ENDMETHOD . *&---------------------------------------------------------------------* *& METHOD LIF_UNIT_PARSER~PARSE *&---------------------------------------------------------------------* METHOD lif_unit_parser~parse . DATA lo_parser TYPE REF TO lif_unit_parser . lo_parser ?= NEW lcl_data_unit_parser ( / ui2 / cl_json => generate ( m_json ) ). rt_result = lo_parser -> parse ( ). ENDMETHOD . ENDCLASS . *&---------------------------------------------------------------------* *& LCL_XML_UNIT_PARSER IMPLEMENTATION *&---------------------------------------------------------------------* CLASS lcl_xml_unit_parser IMPLEMENTATION . *&---------------------------------------------------------------------* *& METHOD CONSTRUCTOR *&---------------------------------------------------------------------* METHOD constructor . m_xml = i_xml . ENDMETHOD . *&---------------------------------------------------------------------* *& METHOD LIF_UNIT_PARSER~PARSE *&---------------------------------------------------------------------* METHOD lif_unit_parser~parse . DATA lt_path TYPE STANDARD TABLE OF string . DATA l_name TYPE string . DATA ( lo_reader ) = cl_sxml_string_reader => create ( m_xml ). DATA ( lo_node ) = lo_reader -> read_next_node ( ). WHILE lo_reader -> node_type <> if_sxml_node => co_nt_final . CASE lo_reader -> node_type . WHEN if_sxml_node => co_nt_element_open . IF l_name IS NOT INITIAL . INSERT l_name INTO TABLE lt_path . ENDIF . l_name = CAST if_sxml_open_element ( lo_node ) -> qname - name . WHEN if_sxml_node => co_nt_element_close . CLEAR l_name . IF lt_path IS NOT INITIAL . DATA ( l_tabix ) = lines ( lt_path ). l_name = lt_path [ l_tabix ]. DELETE lt_path INDEX l_tabix . ENDIF . WHEN if_sxml_node => co_nt_value . DATA ls_unit TYPE ty_unit . CLEAR ls_unit . CONCATENATE LINES OF lt_path INTO ls_unit - path SEPARATED BY '.' . ls_unit - key = l_name . ls_unit - value = CAST if_sxml_value ( lo_node ) -> get_value ( ). INSERT ls_unit INTO TABLE mt_unit . ENDCASE . lo_node = lo_reader -> read_next_node ( ). ENDWHILE . rt_result = mt_unit . ENDMETHOD . ENDCLASS . *&---------------------------------------------------------------------* *& LCL_UNIT_HELPER IMPLEMENTATION *&---------------------------------------------------------------------* CLASS lcl_unit_helper IMPLEMENTATION . *&---------------------------------------------------------------------* *& METHOD PARSE_DATA *&---------------------------------------------------------------------* METHOD parse_data . DATA lo_parser TYPE REF TO lif_unit_parser . lo_parser ?= NEW lcl_data_unit_parser ( ir_data ). rt_result = lo_parser -> parse ( ). ENDMETHOD . *&---------------------------------------------------------------------* *& METHOD PARSE_JSON *&---------------------------------------------------------------------* METHOD parse_json . DATA lo_parser TYPE REF TO lif_unit_parser . lo_parser ?= NEW lcl_json_unit_parser ( i_json ). rt_result = lo_parser -> parse ( ). ENDMETHOD . *&---------------------------------------------------------------------* *& METHOD PARSE_XML *&---------------------------------------------------------------------* METHOD parse_xml . DATA lo_parser TYPE REF TO lif_unit_parser . lo_parser ?= NEW lcl_xml_unit_parser ( i_xml ). rt_result = lo_parser -> parse ( ). ENDMETHOD . *&---------------------------------------------------------------------* *& METHOD GENERATE_FLATDATA *& \u5c06\u5c42\u7ea7\u6570\u636e\u5206\u6790\u5e76\u751f\u6210\u5e73\u9762\u6570\u636e *&---------------------------------------------------------------------* METHOD generate_flatdata . CHECK it_unit IS NOT INITIAL . \" \u63d0\u53d6\u7ed3\u6784 DATA lt_flatdt TYPE tt_flatdt . DATA ls_flatdt TYPE ty_flatdt . DATA lt_unitex TYPE tt_unitex . DATA ls_unitex TYPE ty_unitex . LOOP AT it_unit REFERENCE INTO DATA ( lr_unit ). CLEAR ls_flatdt . ls_flatdt - struct = lr_unit -> path . ls_flatdt - field = lr_unit -> key . REPLACE ALL OCCURRENCES OF REGEX '\\[[0-9]*\\]' IN ls_flatdt - struct WITH '' . \" \u53bb\u9664\u8868\u683c\u7d22\u5f15 INSERT ls_flatdt INTO TABLE lt_flatdt . CLEAR ls_unitex . ls_unitex - struct = ls_flatdt - struct . ls_unitex - path = lr_unit -> path . ls_unitex - key = lr_unit -> key . ls_unitex - value = lr_unit -> value . INSERT ls_unitex INTO TABLE lt_unitex . ENDLOOP . SORT lt_flatdt BY struct field . DELETE ADJACENT DUPLICATES FROM lt_flatdt COMPARING struct field . \" \u8ba1\u7b97\u6bcf\u7ec4\u7ed3\u6784\u6700\u5927\u5b57\u6bb5\u6570\uff0c\u5e76\u8bbe\u5b9a\u5b57\u6bb5\u6240\u5728\u4f4d\u7f6e DATA l_count TYPE i . DATA l_count_max TYPE i . LOOP AT lt_flatdt REFERENCE INTO DATA ( lr_flatdt ). l_count = l_count + 1 . lr_flatdt -> position = l_count . AT END OF struct . IF l_count_max < l_count . l_count_max = l_count . ENDIF . CLEAR l_count . ENDAT . ENDLOOP . \" \u52a8\u6001\u6570\u636e\u53c2\u6570 DATA lo_tabledescr TYPE REF TO cl_abap_tabledescr . DATA lo_structdescr TYPE REF TO cl_abap_structdescr . DATA lt_component TYPE cl_abap_structdescr => component_table . DATA ls_component TYPE cl_abap_structdescr => component . FIELD-SYMBOLS <fs_table> TYPE STANDARD TABLE . FIELD-SYMBOLS <fs_structure> TYPE any . FIELD-SYMBOLS <fs_field> TYPE any . FIELD-SYMBOLS <fs_fldk> TYPE any . \" \u7528\u4e8e\u67d3\u8272 CLEAR ls_component . ls_component - name = gs_fieldname - fdlk . ls_component - type = cl_abap_elemdescr => get_string ( ). INSERT ls_component INTO TABLE lt_component . CLEAR ls_component . ls_component - name = gs_fieldname - path . ls_component - type = cl_abap_elemdescr => get_string ( ). INSERT ls_component INTO TABLE lt_component . DATA l_index TYPE i . DO l_count_max TIMES . l_index = l_index + 1 . CLEAR ls_component . ls_component - name = |{ gs_fieldname - field }{ l_index }|. ls_component - type = cl_abap_elemdescr => get_string ( ). \" \u90fd\u521b\u5efa\u4e3aSTRING\u5373\u53ef INSERT ls_component INTO TABLE lt_component . ENDDO . lo_structdescr = cl_abap_structdescr => create ( lt_component ). lo_tabledescr = cl_abap_tabledescr => create ( lo_structdescr ). CREATE DATA rr_data TYPE HANDLE lo_tabledescr . ASSIGN rr_data->* TO <fs_table> . \" \u7d27\u51d1\u8868\u793a\u4e0e\u5426 IF i_compact = abap_true . \" \u7d27\u51d1\u8868\u793a\u6309\u7ed3\u6784\u8fdb\u884c\u5c55\u793a SORT lt_unitex BY struct path key . ELSE . \" \u975e\u7d27\u51d1\u8868\u793a\u6309\u6570\u636e\u987a\u5e8f\u8fdb\u884c\u5c55\u793a SORT lt_unitex BY path key . ENDIF . LOOP AT lt_unitex REFERENCE INTO DATA ( lr_unitex ). AT NEW struct . \" \u65b0\u7684\u7ed3\u6784 INSERT INITIAL LINE INTO TABLE <fs_table> ASSIGNING <fs_structure> . UNASSIGN <fs_fldk> . ASSIGN COMPONENT gs_fieldname - fdlk OF STRUCTURE <fs_structure> TO <fs_fldk> . IF <fs_fldk> IS ASSIGNED . <fs_fldk> = gs_fdlk - header . ENDIF . UNASSIGN <fs_field> . ASSIGN COMPONENT gs_fieldname - path OF STRUCTURE <fs_structure> TO <fs_field> . IF <fs_field> IS ASSIGNED . <fs_field> = lr_unitex -> struct . ENDIF . READ TABLE lt_flatdt TRANSPORTING NO FIELDS WITH KEY struct = lr_unitex -> struct BINARY SEARCH . IF sy - subrc = 0 . LOOP AT lt_flatdt REFERENCE INTO lr_flatdt FROM sy - tabix . IF lr_flatdt -> struct <> lr_unitex -> struct . EXIT . ENDIF . UNASSIGN <fs_field> . ASSIGN COMPONENT |{ gs_fieldname - field }{ lr_flatdt -> position }| OF STRUCTURE <fs_structure> TO <fs_field> . IF <fs_field> IS ASSIGNED . <fs_field> = lr_flatdt -> field . ENDIF . ENDLOOP . ENDIF . ENDAT . AT NEW path . \" \u65b0\u7684\u6570\u636e\u884c INSERT INITIAL LINE INTO TABLE <fs_table> ASSIGNING <fs_structure> . UNASSIGN <fs_fldk> . ASSIGN COMPONENT gs_fieldname - fdlk OF STRUCTURE <fs_structure> TO <fs_fldk> . IF <fs_fldk> IS ASSIGNED . <fs_fldk> = gs_fdlk - data . ENDIF . ASSIGN COMPONENT gs_fieldname - path OF STRUCTURE <fs_structure> TO <fs_field> . IF <fs_field> IS ASSIGNED . <fs_field> = lr_unitex -> path . ENDIF . CLEAR l_index . ENDAT . \" \u586b\u5145\u6570\u636e READ TABLE lt_flatdt REFERENCE INTO lr_flatdt WITH KEY struct = lr_unitex -> struct field = lr_unitex -> key BINARY SEARCH . IF sy - subrc = 0 . UNASSIGN <fs_field> . ASSIGN COMPONENT |{ gs_fieldname - field }{ lr_flatdt -> position }| OF STRUCTURE <fs_structure> TO <fs_field> . IF <fs_field> IS ASSIGNED . <fs_field> = lr_unitex -> value . ENDIF . ENDIF . ENDLOOP . IF et_flatdt IS SUPPLIED . et_flatdt = lt_flatdt . ENDIF . ENDMETHOD . ENDCLASS . *&---------------------------------------------------------------------* *& LIF_ALV *&---------------------------------------------------------------------* INTERFACE lif_alv . METHODS pai . METHODS pbo . METHODS get_selected_uuid EXPORTING et_uuid TYPE tt_uuid et_uuid_opt TYPE tt_uuid_opt . \" \u83b7\u53d6\u9009\u62e9\u884c\u7684\u65e5\u5fd7ID ENDINTERFACE . *&---------------------------------------------------------------------* *& LCL_ALV_LOGH *&---------------------------------------------------------------------* CLASS lcl_alv_logh DEFINITION . PUBLIC SECTION . INTERFACES lif_alv . DATA ms_layout TYPE lvc_s_layo . DATA mt_fieldcat TYPE lvc_t_fcat . DATA mt_sort TYPE lvc_t_sort . METHODS set_layout . CLASS-METHODS set_fieldcat CHANGING ct_fieldcat TYPE lvc_t_fcat . METHODS set_sort . METHODS set_event . METHODS set_color . METHODS on_double_click FOR EVENT double_click OF cl_gui_alv_grid IMPORTING e_row e_column es_row_no . CLASS-METHODS display_rawdata IMPORTING i_uuid TYPE ty_log_rawdata - uuid i_zitem TYPE ty_log_rawdata - zitem . CLASS-METHODS nav_se37 IMPORTING i_funcname TYPE ty_log_head - func_name . ENDCLASS . *&---------------------------------------------------------------------* *& LCL_ALV_UNIT *&---------------------------------------------------------------------* CLASS lcl_alv_logh IMPLEMENTATION . *&---------------------------------------------------------------------* *& LIF_ALV~PBO *&---------------------------------------------------------------------* METHOD lif_alv~pbo . IF go_container IS NOT BOUND . go_container = NEW cl_gui_custom_container ( 'CON_9000' ). ENDIF . IF go_grid IS NOT BOUND . go_grid = NEW cl_gui_alv_grid ( go_container ). set_layout ( ). set_fieldcat ( CHANGING ct_fieldcat = mt_fieldcat ). set_sort ( ). set_event ( ). set_color ( ). DATA ls_variant TYPE disvariant . ls_variant = VALUE # ( report = sy - repid handle = 1 ). CALL METHOD go_grid -> set_table_for_first_display EXPORTING is_layout = ms_layout is_variant = ls_variant i_save = 'X' CHANGING it_outtab = gt_log it_fieldcatalog = mt_fieldcat it_sort = mt_sort EXCEPTIONS invalid_parameter_combination = 1 program_error = 2 too_many_lines = 3 OTHERS = 4 . ELSE . CALL METHOD go_grid -> refresh_table_display EXPORTING is_stable = CONV # ( 'XX' ) i_soft_refresh = abap_true EXCEPTIONS finished = 1 OTHERS = 2 . ENDIF . ENDMETHOD . *&---------------------------------------------------------------------* *& LIF_ALV~PAI *&---------------------------------------------------------------------* METHOD lif_alv~pai . ENDMETHOD . *&---------------------------------------------------------------------* *& SET_LAYOUT *&---------------------------------------------------------------------* METHOD set_layout . CLEAR ms_layout . ms_layout - zebra = abap_true . \" \u6591\u9a6c\u7ebf ms_layout - cwidth_opt = abap_true . \" \u81ea\u52a8\u8c03\u6574ALVL\u5217\u5bbd ms_layout - sel_mode = 'A' . \" \u9009\u62e9\u6a21\u5f0f ms_layout - ctab_fname = 'T_SCOL' . \" \u5355\u5143\u683c\u989c\u8272\u8bbe\u7f6e * MS_LAYOUT-STYLEFNAME = 'T_STYL'. \" \u5355\u5143\u683c\u63a7\u5236 ENDMETHOD . *&---------------------------------------------------------------------* *& SET_FIELDCAT *&---------------------------------------------------------------------* METHOD set_fieldcat . DATA ls_fieldcat TYPE lvc_s_fcat . DEFINE _init_fieldcat . CLEAR ls_fieldcat . ls_fieldcat - fieldname = &1 . ls_fieldcat - tooltip = ls_fieldcat - coltext = ls_fieldcat - seltext = ls_fieldcat - scrtext_l = ls_fieldcat - scrtext_m = ls_fieldcat - scrtext_s = &2 . ls_fieldcat - ref_table = &3 . ls_fieldcat - ref_field = &4 . INSERT ls_fieldcat INTO TABLE ct_fieldcat . END-OF-DEFINITION . _init_fieldcat 'UUID ' '\u65e5\u5fd7ID' '' '' . * _INIT_FIELDCAT 'ZITEM ' '\u5e8f\u53f7' '' ''. _init_fieldcat 'LOG_KIND ' '\u65e5\u5fd7\u5206\u7c7b' '' '' . _init_fieldcat 'INTF_ID ' '\u63a5\u53e3\u6807\u8bc6' '' '' . _init_fieldcat 'FUNC_NAME' '\u51fd\u6570\u540d' '' '' . _init_fieldcat 'FUNC_TEXT' '\u51fd\u6570\u63cf\u8ff0' '' '' . * _INIT_FIELDCAT 'ZTEXT ' '\u9644\u52a0\u4fe1\u606f' '' ''. \" \u8be5\u9879\u76ee\u6ca1\u6709 _init_fieldcat 'IO_FLAG ' '\u63a5\u53e3\u65b9\u5411' '' '' . _init_fieldcat 'ZSENDER ' '\u53d1\u9001\u65b9' '' '' . _init_fieldcat 'ZRECEIVER' '\u63a5\u6536\u65b9' '' '' . _init_fieldcat 'ZDATE ' '\u65e5\u671f' '' '' . _init_fieldcat 'ZTIME ' '\u65f6\u95f4' '' '' . _init_fieldcat 'ZUSER ' '\u7528\u6237' '' '' . _init_fieldcat 'MTYPE ' '\u72b6\u6001' '' '' . * _INIT_FIELDCAT 'MSG ' '\u6d88\u606f\u6587\u672c' '' ''. \" \u8be5\u9879\u76ee\u6ca1\u6709 _init_fieldcat 'ZCONUT ' '\u6761\u76ee\u7edf\u8ba1' '' '' . _init_fieldcat 'ZRAW_ICON' '\u539f\u59cb\u6570\u636e' '' '' . ENDMETHOD . *&---------------------------------------------------------------------* *& SET_SORT *&---------------------------------------------------------------------* METHOD set_sort . DATA ls_sort TYPE lvc_s_sort . DATA l_spos TYPE lvc_s_sort - spos . CLEAR ls_sort . l_spos = l_spos + 1 . ls_sort - spos = l_spos . ls_sort - fieldname = 'ZDATE' . ls_sort - down = abap_true . INSERT ls_sort INTO TABLE mt_sort . CLEAR ls_sort . l_spos = l_spos + 1 . ls_sort - spos = l_spos . ls_sort - fieldname = 'ZTIME' . ls_sort - down = abap_true . INSERT ls_sort INTO TABLE mt_sort . CLEAR ls_sort . l_spos = l_spos + 1 . ls_sort - spos = l_spos . ls_sort - fieldname = 'UUID' . ls_sort - up = abap_true . INSERT ls_sort INTO TABLE mt_sort . CLEAR ls_sort . l_spos = l_spos + 1 . ls_sort - spos = l_spos . ls_sort - fieldname = 'IO_FLAG' . ls_sort - up = abap_true . INSERT ls_sort INTO TABLE mt_sort . ENDMETHOD . *&---------------------------------------------------------------------* *& SET_EVENT *&---------------------------------------------------------------------* METHOD set_event . SET HANDLER on_double_click FOR go_grid . ENDMETHOD . *&---------------------------------------------------------------------* *& SET_COLOR *&---------------------------------------------------------------------* METHOD set_color . DATA ls_scol TYPE lvc_s_scol . LOOP AT gt_log REFERENCE INTO DATA ( lr_log ). CLEAR lr_log -> t_scol . IF lr_log -> mtype = 'S' . lr_log -> t_scol = VALUE # ( BASE lr_log -> t_scol color = gs_color - green ( fname = 'MTYPE' ) ( fname = 'MSG' ) ). ELSE . lr_log -> t_scol = VALUE # ( BASE lr_log -> t_scol color = gs_color - red ( fname = 'MTYPE' ) ( fname = 'MSG' ) ). ENDIF . ENDLOOP . ENDMETHOD . *&---------------------------------------------------------------------* *& ON_DOUBLE_CLICK *&---------------------------------------------------------------------* METHOD on_double_click . READ TABLE gt_log REFERENCE INTO DATA ( lr_log ) INDEX e_row - index . CHECK sy - subrc = 0 . CASE e_column . WHEN 'UUID' . DATA lt_uuid_opt LIKE RANGE OF gs_selection - uuid . lt_uuid_opt = VALUE # ( sign = 'I' option = 'EQ' ( low = lr_log -> uuid ) ). SUBMIT ( sy - repid ) WITH s_uuid IN lt_uuid_opt \" \u63a5\u53e3ID WITH s_date IN s_date \" \u65e5\u671f\u4f1a\u9ed8\u8ba4\u5f53\u5929\uff0c\u624b\u5de5\u4f20\u503c WITH s_time IN s_time \" \u65e5\u671f\u4f1a\u9ed8\u8ba4\u5f53\u5929\uff0c\u624b\u5de5\u4f20\u503c WITH p_logh = '' WITH p_unit = '' WITH p_flat = 'X' AND RETURN . WHEN 'ZRAW_ICON' . display_rawdata ( i_uuid = lr_log -> uuid i_zitem = lr_log -> zitem ). WHEN 'FUNC_NAME' . nav_se37 ( lr_log -> func_name ). ENDCASE . ENDMETHOD . *&---------------------------------------------------------------------* *& DISPLAY_RAWDATA *&---------------------------------------------------------------------* METHOD display_rawdata . DATA l_html TYPE xstring . READ TABLE gt_log_rawdata REFERENCE INTO DATA ( lr_log_rawdata ) WITH KEY uuid = i_uuid zitem = i_zitem BINARY SEARCH . IF sy - subrc = 0 . CASE lr_log_rawdata -> zformat . WHEN 'JSON' . \" cl_demo_output=>display_json( lr_log_rawdata->zraw ). CALL TRANSFORMATION sjson2html SOURCE XML lr_log_rawdata -> zraw RESULT XML l_html . cl_abap_browser => show_html ( html_string = cl_abap_codepage => convert_from ( l_html ) ). WHEN 'XML' . * cl_demo_output=>display_xml( lr_log_rawdata->zrawx ). cl_abap_browser => show_xml ( xml_xstring = lr_log_rawdata -> zrawx ). WHEN OTHERS . cl_demo_output => display ( lr_log_rawdata -> zraw ). ENDCASE . ENDIF . ENDMETHOD . *&---------------------------------------------------------------------* *& NAV_SE37 *&---------------------------------------------------------------------* METHOD nav_se37 . DATA ls_tfdir TYPE tfdir . \" \u83b7\u53d6\u51fd\u6570\u5bf9\u5e94\u7a0b\u5e8f SELECT SINGLE pname include INTO CORRESPONDING FIELDS OF ls_tfdir FROM tfdir WHERE funcname = i_funcname . \" \u8bbe\u7f6e\u51fd\u6570\u5168\u5c40\u4fe1\u606f DATA ls_rs38l TYPE rs38l . CALL FUNCTION 'FUNCTION_INCLUDE_SPLIT' EXPORTING program = ls_tfdir - pname IMPORTING group = ls_rs38l - area namespace = ls_rs38l - namespace EXCEPTIONS include_not_exists = 1 group_not_exists = 2 no_selections = 3 no_function_include = 4 no_function_pool = 5 delimiter_wrong_position = 6 no_customer_function_group = 7 no_customer_function_include = 8 reserved_name_customer = 9 namespace_too_long = 10 area_length_error = 11 OTHERS = 12 . CONCATENATE 'L' ls_rs38l - area 'U' ls_tfdir - include INTO ls_tfdir - pname . CALL FUNCTION 'EDITOR_PROGRAM' EXPORTING display = 'X' program = ls_tfdir - pname EXCEPTIONS OTHERS = 1 . ENDMETHOD . *&---------------------------------------------------------------------* *& LIF_ALV~GET_SELECTED_UUID *&---------------------------------------------------------------------* METHOD lif_alv~get_selected_uuid . \" \u83b7\u53d6ALV\u9009\u53d6\u884c DATA lt_rows TYPE lvc_t_row . CALL METHOD go_grid -> get_selected_rows IMPORTING et_index_rows = lt_rows . LOOP AT lt_rows INTO DATA ( ls_row ). READ TABLE gt_log REFERENCE INTO DATA ( lr_log ) INDEX ls_row - index . CHECK sy - subrc = 0 . IF et_uuid IS SUPPLIED . APPEND lr_log -> uuid TO et_uuid . ENDIF . IF et_uuid_opt IS SUPPLIED . INSERT VALUE # ( sign = 'I' option = 'EQ' low = lr_log -> uuid ) INTO TABLE et_uuid_opt . ENDIF . ENDLOOP . SORT et_uuid BY table_line . DELETE ADJACENT DUPLICATES FROM et_uuid COMPARING table_line . DELETE et_uuid WHERE table_line IS INITIAL . SORT et_uuid_opt BY low . DELETE ADJACENT DUPLICATES FROM et_uuid_opt COMPARING low . DELETE et_uuid_opt WHERE low IS INITIAL . ENDMETHOD . ENDCLASS . *&---------------------------------------------------------------------* *& LCL_ALV_UNIT *&---------------------------------------------------------------------* CLASS lcl_alv_unit DEFINITION . PUBLIC SECTION . INTERFACES lif_alv . TYPES : BEGIN OF ty_data . INCLUDE TYPE ty_log_head . INCLUDE TYPE ty_unit . TYPES : END OF ty_data . DATA mt_data TYPE STANDARD TABLE OF ty_data WITH EMPTY KEY . DATA ms_layout TYPE lvc_s_layo . DATA mt_fieldcat TYPE STANDARD TABLE OF lvc_s_fcat . METHODS constructor . METHODS process_data . METHODS set_layout . METHODS set_fieldcat . METHODS set_event . METHODS set_color . METHODS on_double_click FOR EVENT double_click OF cl_gui_alv_grid IMPORTING e_row e_column es_row_no . ENDCLASS . *&---------------------------------------------------------------------* *& LCL_ALV_UNIT *&---------------------------------------------------------------------* CLASS lcl_alv_unit IMPLEMENTATION . *&---------------------------------------------------------------------* *& CONSTRUCTOR *&---------------------------------------------------------------------* METHOD constructor . process_data ( ). ENDMETHOD . *&---------------------------------------------------------------------* *& PROCESS_DATA *&---------------------------------------------------------------------* METHOD process_data . DATA ls_data TYPE ty_data . DATA ( lo_progress ) = NEW lcl_progress ( ). lo_progress -> m_name = '\u8f6c\u5316\u5355\u5143\u6570\u636e' . lo_progress -> start ( lines ( gt_log ) ). LOOP AT gt_log REFERENCE INTO DATA ( lr_log ). lo_progress -> next ( ). CLEAR ls_data . ls_data = CORRESPONDING # ( lr_log->* ). LOOP AT lr_log -> t_unit REFERENCE INTO DATA ( lr_unit ). DATA ( ls_data_tmp ) = ls_data . ls_data_tmp - path = lr_unit -> path . ls_data_tmp - key = lr_unit -> key . ls_data_tmp - value = lr_unit -> value . INSERT ls_data_tmp INTO TABLE mt_data . ENDLOOP . ENDLOOP . lo_progress -> finish ( ). ENDMETHOD . *&---------------------------------------------------------------------* *& LIF_ALV~PBO *&---------------------------------------------------------------------* METHOD lif_alv~pbo . IF go_container IS NOT BOUND . go_container = NEW cl_gui_custom_container ( 'CON_9000' ). ENDIF . IF go_grid IS NOT BOUND . go_grid = NEW cl_gui_alv_grid ( go_container ). set_layout ( ). set_fieldcat ( ). set_event ( ). set_color ( ). DATA ls_variant TYPE disvariant . ls_variant = VALUE # ( report = sy - repid handle = 2 ). CALL METHOD go_grid -> set_table_for_first_display EXPORTING is_layout = ms_layout is_variant = ls_variant i_save = 'X' CHANGING it_outtab = mt_data it_fieldcatalog = mt_fieldcat EXCEPTIONS invalid_parameter_combination = 1 program_error = 2 too_many_lines = 3 OTHERS = 4 . ELSE . CALL METHOD go_grid -> refresh_table_display EXPORTING is_stable = CONV # ( 'XX' ) i_soft_refresh = abap_true EXCEPTIONS finished = 1 OTHERS = 2 . ENDIF . ENDMETHOD . *&---------------------------------------------------------------------* *& LIF_ALV~PAI *&---------------------------------------------------------------------* METHOD lif_alv~pai . ENDMETHOD . *&---------------------------------------------------------------------* *& SET_LAYOUT *&---------------------------------------------------------------------* METHOD set_layout . CLEAR ms_layout . ms_layout - zebra = abap_true . \" \u6591\u9a6c\u7ebf ms_layout - cwidth_opt = abap_true . \" \u81ea\u52a8\u8c03\u6574ALVL\u5217\u5bbd ms_layout - sel_mode = 'A' . \" \u9009\u62e9\u6a21\u5f0f * MS_LAYOUT-CTAB_FNAME = 'T_SCOL'. \" \u5355\u5143\u683c\u989c\u8272\u8bbe\u7f6e * MS_LAYOUT-STYLEFNAME = 'T_STYL'. \" \u5355\u5143\u683c\u63a7\u5236 ENDMETHOD . *&---------------------------------------------------------------------* *& SET_FIELDCAT *&---------------------------------------------------------------------* METHOD set_fieldcat . DATA ls_fieldcat TYPE lvc_s_fcat . DEFINE _init_fieldcat . CLEAR ls_fieldcat . ls_fieldcat - fieldname = &1 . ls_fieldcat - tooltip = ls_fieldcat - coltext = ls_fieldcat - seltext = ls_fieldcat - scrtext_l = ls_fieldcat - scrtext_m = ls_fieldcat - scrtext_s = &2 . ls_fieldcat - ref_table = &3 . ls_fieldcat - ref_field = &4 . INSERT ls_fieldcat INTO TABLE mt_fieldcat . END-OF-DEFINITION . lcl_alv_logh => set_fieldcat ( CHANGING ct_fieldcat = mt_fieldcat ). _init_fieldcat 'PATH' '\u8def\u5f84' '' '' . _init_fieldcat 'KEY' '\u5b57\u6bb5\u540d' '' '' . _init_fieldcat 'VALUE' '\u5b57\u6bb5\u503c' '' '' . ENDMETHOD . *&---------------------------------------------------------------------* *& SET_EVENT *&---------------------------------------------------------------------* METHOD set_event . SET HANDLER on_double_click FOR go_grid . ENDMETHOD . *&---------------------------------------------------------------------* *& SET_COLOR *&---------------------------------------------------------------------* METHOD set_color . DATA ls_scol TYPE lvc_s_scol . LOOP AT mt_data REFERENCE INTO DATA ( lr_data ). CLEAR lr_data -> t_scol . IF lr_data -> mtype = 'S' . lr_data -> t_scol = VALUE # ( BASE lr_data -> t_scol color = gs_color - green ( fname = 'MTYPE' ) ( fname = 'MSG' ) ). ELSE . lr_data -> t_scol = VALUE # ( BASE lr_data -> t_scol color = gs_color - red ( fname = 'MTYPE' ) ( fname = 'MSG' ) ). ENDIF . ENDLOOP . ENDMETHOD . *&---------------------------------------------------------------------* *& ON_DOUBLE_CLICK *&---------------------------------------------------------------------* METHOD on_double_click . READ TABLE mt_data REFERENCE INTO DATA ( lr_data ) INDEX e_row - index . CHECK sy - subrc = 0 . CASE e_column . WHEN 'ZRAW_ICON' . lcl_alv_logh => display_rawdata ( i_uuid = lr_data -> uuid i_zitem = lr_data -> zitem ). WHEN 'FUNC_NAME' . lcl_alv_logh => nav_se37 ( lr_data -> func_name ). ENDCASE . ENDMETHOD . *&---------------------------------------------------------------------* *& LIF_ALV~GET_SELECTED_UUID *&---------------------------------------------------------------------* METHOD lif_alv~get_selected_uuid . \" \u83b7\u53d6ALV\u9009\u53d6\u884c DATA lt_rows TYPE lvc_t_row . CALL METHOD go_grid -> get_selected_rows IMPORTING et_index_rows = lt_rows . LOOP AT lt_rows INTO DATA ( ls_row ). READ TABLE mt_data REFERENCE INTO DATA ( lr_unit ) INDEX ls_row - index . CHECK sy - subrc = 0 . IF et_uuid IS SUPPLIED . APPEND lr_unit -> uuid TO et_uuid . ENDIF . IF et_uuid_opt IS SUPPLIED . INSERT VALUE # ( sign = 'I' option = 'EQ' low = lr_unit -> uuid ) INTO TABLE et_uuid_opt . ENDIF . ENDLOOP . SORT et_uuid BY table_line . DELETE ADJACENT DUPLICATES FROM et_uuid COMPARING table_line . DELETE et_uuid WHERE table_line IS INITIAL . SORT et_uuid_opt BY low . DELETE ADJACENT DUPLICATES FROM et_uuid_opt COMPARING low . DELETE et_uuid_opt WHERE low IS INITIAL . ENDMETHOD . ENDCLASS . *&---------------------------------------------------------------------* *& LCL_ALV_FLAT *&---------------------------------------------------------------------* CLASS lcl_alv_flat DEFINITION . PUBLIC SECTION . INTERFACES lif_alv . DATA mt_component_flat TYPE cl_abap_structdescr => component_table . DATA mr_data TYPE REF TO data . DATA ms_layout TYPE lvc_s_layo . DATA mt_fieldcat TYPE STANDARD TABLE OF lvc_s_fcat . METHODS constructor . METHODS process_data . METHODS set_layout . METHODS set_fieldcat . METHODS set_event . METHODS set_color . METHODS on_double_click FOR EVENT double_click OF cl_gui_alv_grid IMPORTING e_row e_column es_row_no . ENDCLASS . *&---------------------------------------------------------------------* *& LCL_ALV_FLAT *&---------------------------------------------------------------------* CLASS lcl_alv_flat IMPLEMENTATION . *&---------------------------------------------------------------------* *& CONSTRUCTOR *&---------------------------------------------------------------------* METHOD constructor . process_data ( ). ENDMETHOD . *&---------------------------------------------------------------------* *& PROCESS_DATA *&---------------------------------------------------------------------* METHOD process_data . \" \u8ba1\u7b97\u6700\u5927\u5b57\u6bb5\u6570\u91cf DATA l_count_max TYPE i . LOOP AT gt_log REFERENCE INTO DATA ( lr_log ). LOOP AT lr_log -> t_flatdt REFERENCE INTO DATA ( lr_flatdt ). IF l_count_max < lr_flatdt -> position . l_count_max = lr_flatdt -> position . ENDIF . ENDLOOP . ENDLOOP . \" \u62ac\u5934\u90e8\u5206\u56fa\u5b9a DATA lo_tabledescr TYPE REF TO cl_abap_tabledescr . DATA lo_structdescr TYPE REF TO cl_abap_structdescr . DATA lt_component TYPE cl_abap_structdescr => component_table . DATA ls_component TYPE cl_abap_structdescr => component . lo_structdescr ?= cl_abap_typedescr => describe_by_data ( VALUE ty_log_head ( ) ). lt_component = lo_structdescr -> get_components ( ). \" \u6241\u5e73\u90e8\u5206 CLEAR ls_component . ls_component - name = gs_fieldname - fdlk . ls_component - type = cl_abap_elemdescr => get_string ( ). INSERT ls_component INTO TABLE mt_component_flat . CLEAR ls_component . ls_component - name = gs_fieldname - path . ls_component - type = cl_abap_elemdescr => get_string ( ). INSERT ls_component INTO TABLE mt_component_flat . DATA l_index TYPE i . DO l_count_max TIMES . l_index = l_index + 1 . CLEAR ls_component . ls_component - name = |{ gs_fieldname - field }{ l_index }|. ls_component - type = cl_abap_elemdescr => get_string ( ). \" \u90fd\u521b\u5efa\u4e3aSTRING\u5373\u53ef INSERT ls_component INTO TABLE mt_component_flat . ENDDO . INSERT LINES OF mt_component_flat INTO TABLE lt_component . \" \u521b\u5efa\u62a5\u8868\u5c55\u793a\u7ed3\u6784 lo_structdescr = cl_abap_structdescr => create ( lt_component ). lo_tabledescr = cl_abap_tabledescr => create ( lo_structdescr ). CREATE DATA mr_data TYPE HANDLE lo_tabledescr . FIELD-SYMBOLS <fs_table> TYPE STANDARD TABLE . FIELD-SYMBOLS <fs_structure> TYPE any . FIELD-SYMBOLS <fs_field> TYPE any . ASSIGN mr_data->* TO <fs_table> . DATA ( lo_progress ) = NEW lcl_progress ( ). lo_progress -> m_name = '\u8f6c\u5316\u6241\u5e73\u7ed3\u6784' . lo_progress -> start ( lines ( gt_log ) ). LOOP AT gt_log REFERENCE INTO lr_log . lo_progress -> next ( ). IF <fs_table> IS NOT INITIAL . DO p_ctl5 TIMES . \" \u95f4\u9694\u884c\uff0c\u4e0d\u7136\u592a\u7d27\u51d1\u4e0d\u597d\u770b\u6570\u636e INSERT INITIAL LINE INTO TABLE <fs_table> . ENDDO . ENDIF . IF lr_log -> r_flatdata IS NOT BOUND . INSERT INITIAL LINE INTO TABLE <fs_table> ASSIGNING <fs_structure> . <fs_structure> = CORRESPONDING # ( lr_log->* ). \" \u65e5\u5fd7\u62ac\u5934\u90e8\u5206 CONTINUE . ENDIF . FIELD-SYMBOLS <fs_flatdata_table> TYPE STANDARD TABLE . FIELD-SYMBOLS <fs_flatdata_structure> TYPE any . FIELD-SYMBOLS <fs_flatdata_field> TYPE any . UNASSIGN <fs_flatdata_table> . UNASSIGN <fs_flatdata_structure> . ASSIGN lr_log -> r_flatdata->* TO <fs_flatdata_table> . LOOP AT <fs_flatdata_table> ASSIGNING <fs_flatdata_structure> . IF p_ctl2 <> abap_true . \" \u5c55\u793a\u62ac\u5934 ASSIGN COMPONENT gs_fieldname - fdlk OF STRUCTURE <fs_flatdata_structure> TO FIELD - SYMBOL ( <fs_fdlk> ). IF <fs_fdlk> IS ASSIGNED . CHECK <fs_fdlk> <> gs_fdlk - header . ENDIF . ENDIF . INSERT INITIAL LINE INTO TABLE <fs_table> ASSIGNING <fs_structure> . <fs_structure> = CORRESPONDING # ( lr_log->* ). \" \u65e5\u5fd7\u62ac\u5934\u90e8\u5206 LOOP AT mt_component_flat INTO ls_component . UNASSIGN <fs_flatdata_field> . UNASSIGN <fs_field> . ASSIGN COMPONENT ls_component - name OF STRUCTURE <fs_flatdata_structure> TO <fs_flatdata_field> . ASSIGN COMPONENT ls_component - name OF STRUCTURE <fs_structure> TO <fs_field> . IF <fs_flatdata_field> IS ASSIGNED AND <fs_field> IS ASSIGNED . <fs_field> = <fs_flatdata_field> . ENDIF . ENDLOOP . ENDLOOP . ENDLOOP . lo_progress -> finish ( ). ENDMETHOD . *&---------------------------------------------------------------------* *& LIF_ALV~PBO *&---------------------------------------------------------------------* METHOD lif_alv~pbo . IF go_container IS NOT BOUND . go_container = NEW cl_gui_custom_container ( 'CON_9000' ). ENDIF . IF go_grid IS NOT BOUND . go_grid = NEW cl_gui_alv_grid ( go_container ). set_layout ( ). set_fieldcat ( ). set_event ( ). set_color ( ). FIELD-SYMBOLS <fs_table> TYPE STANDARD TABLE . ASSIGN mr_data->* TO <fs_table> . DATA ls_variant TYPE disvariant . ls_variant = VALUE # ( report = sy - repid handle = 3 ). CALL METHOD go_grid -> set_table_for_first_display EXPORTING is_layout = ms_layout is_variant = ls_variant i_save = 'X' CHANGING it_outtab = <fs_table> it_fieldcatalog = mt_fieldcat EXCEPTIONS invalid_parameter_combination = 1 program_error = 2 too_many_lines = 3 OTHERS = 4 . ELSE . CALL METHOD go_grid -> refresh_table_display EXPORTING is_stable = CONV # ( 'XX' ) i_soft_refresh = abap_true EXCEPTIONS finished = 1 OTHERS = 2 . ENDIF . ENDMETHOD . *&---------------------------------------------------------------------* *& LIF_ALV~PAI *&---------------------------------------------------------------------* METHOD lif_alv~pai . ENDMETHOD . *&---------------------------------------------------------------------* *& SET_LAYOUT *&---------------------------------------------------------------------* METHOD set_layout . CLEAR ms_layout . * MS_LAYOUT-ZEBRA = ABAP_TRUE. \" \u6591\u9a6c\u7ebf ms_layout - cwidth_opt = p_ctl4 . \" ABAP_TRUE. \" \u81ea\u52a8\u8c03\u6574ALVL\u5217\u5bbd ms_layout - sel_mode = 'A' . \" \u9009\u62e9\u6a21\u5f0f ms_layout - info_fname = 'RCOL' . \" \u5355\u5143\u683c\u989c\u8272\u8bbe\u7f6e ms_layout - ctab_fname = 'T_SCOL' . \" \u5355\u5143\u683c\u989c\u8272\u8bbe\u7f6e * MS_LAYOUT-STYLEFNAME = 'T_STYL'. \" \u5355\u5143\u683c\u63a7\u5236 ENDMETHOD . *&---------------------------------------------------------------------* *& SET_FIELDCAT *&---------------------------------------------------------------------* METHOD set_fieldcat . DATA ls_fieldcat TYPE lvc_s_fcat . DEFINE _init_fieldcat . CLEAR ls_fieldcat . ls_fieldcat - fieldname = &1 . ls_fieldcat - tooltip = ls_fieldcat - coltext = ls_fieldcat - seltext = ls_fieldcat - scrtext_l = ls_fieldcat - scrtext_m = ls_fieldcat - scrtext_s = &2 . ls_fieldcat - ref_table = &3 . ls_fieldcat - ref_field = &4 . INSERT ls_fieldcat INTO TABLE mt_fieldcat . END-OF-DEFINITION . lcl_alv_logh => set_fieldcat ( CHANGING ct_fieldcat = mt_fieldcat ). _init_fieldcat gs_fieldname - path '\u8def\u5f84' '' '' . LOOP AT mt_component_flat INTO DATA ( ls_component_flat ). IF ls_component_flat - name CS gs_fieldname - field . _init_fieldcat ls_component_flat - name '-' '' '' . ENDIF . ENDLOOP . ENDMETHOD . *&---------------------------------------------------------------------* *& SET_EVENT *&---------------------------------------------------------------------* METHOD set_event . SET HANDLER on_double_click FOR go_grid . ENDMETHOD . *&---------------------------------------------------------------------* *& SET_COLOR *&---------------------------------------------------------------------* METHOD set_color . DATA ls_scol TYPE lvc_s_scol . DATA ls_log_head TYPE ty_log_head . FIELD-SYMBOLS <fs_table> TYPE STANDARD TABLE . FIELD-SYMBOLS <fs_structure> TYPE any . FIELD-SYMBOLS <fs_field> TYPE any . FIELD-SYMBOLS <fs_t_scol> TYPE lvc_t_scol . ASSIGN mr_data->* TO <fs_table> . LOOP AT <fs_table> ASSIGNING <fs_structure> . IF <fs_structure> IS INITIAL . ASSIGN COMPONENT 'RCOL' OF STRUCTURE <fs_structure> TO FIELD - SYMBOL ( <fs_rcol> ). IF <fs_rcol> IS ASSIGNED . <fs_rcol> = 'C300' . ENDIF . CONTINUE . ENDIF . ASSIGN COMPONENT 'T_SCOL' OF STRUCTURE <fs_structure> TO <fs_t_scol> . CLEAR <fs_t_scol> . CLEAR ls_log_head . ls_log_head = CORRESPONDING # ( <fs_structure> ). IF ls_log_head - mtype = 'S' . <fs_t_scol> = VALUE # ( BASE <fs_t_scol> color = gs_color - green ( fname = 'MTYPE' ) ( fname = 'MSG' ) ). ELSE . <fs_t_scol> = VALUE # ( BASE <fs_t_scol> color = gs_color - red ( fname = 'MTYPE' ) ( fname = 'MSG' ) ). ENDIF . CHECK p_ctl3 = abap_true . \" \u5355\u5143\u683c\u7740\u8272 UNASSIGN <fs_field> . ASSIGN COMPONENT gs_fieldname - fdlk OF STRUCTURE <fs_structure> TO <fs_field> . CHECK <fs_field> IS ASSIGNED . DATA ls_color LIKE gs_color - red . CLEAR ls_color . CASE <fs_field> . WHEN gs_fdlk - header . ls_color = gs_color - dept_blue . WHEN gs_fdlk - data . * LS_COLOR = GS_COLOR-BLUE. WHEN OTHERS . ls_color = gs_color - yellow . ENDCASE . LOOP AT mt_component_flat INTO DATA ( ls_component ). CLEAR ls_scol . ls_scol - fname = ls_component - name . ls_scol - color = ls_color . INSERT ls_scol INTO TABLE <fs_t_scol> . ENDLOOP . ENDLOOP . ENDMETHOD . *&---------------------------------------------------------------------* *& ON_DOUBLE_CLICK *&---------------------------------------------------------------------* METHOD on_double_click . FIELD-SYMBOLS <fs_table> TYPE STANDARD TABLE . FIELD-SYMBOLS <fs_structure> TYPE any . ASSIGN mr_data->* TO <fs_table> . READ TABLE <fs_table> ASSIGNING <fs_structure> INDEX e_row - index . CHECK sy - subrc = 0 . DATA ls_log_head TYPE ty_log_head . ls_log_head = CORRESPONDING # ( <fs_structure> ). CASE e_column . WHEN 'ZRAW_ICON' . lcl_alv_logh => display_rawdata ( i_uuid = ls_log_head - uuid i_zitem = ls_log_head - zitem ). WHEN 'FUNC_NAME' . lcl_alv_logh => nav_se37 ( ls_log_head - func_name ). ENDCASE . ENDMETHOD . *&---------------------------------------------------------------------* *& LIF_ALV~GET_SELECTED_UUID *&---------------------------------------------------------------------* METHOD lif_alv~get_selected_uuid . FIELD-SYMBOLS <fs_table> TYPE STANDARD TABLE . FIELD-SYMBOLS <fs_structure> TYPE any . ASSIGN mr_data->* TO <fs_table> . \" \u83b7\u53d6ALV\u9009\u53d6\u884c DATA lt_rows TYPE lvc_t_row . CALL METHOD go_grid -> get_selected_rows IMPORTING et_index_rows = lt_rows . LOOP AT lt_rows INTO DATA ( ls_row ). READ TABLE <fs_table> ASSIGNING <fs_structure> INDEX ls_row - index . CHECK sy - subrc = 0 . ASSIGN COMPONENT 'UUID' OF STRUCTURE <fs_structure> TO FIELD - SYMBOL ( <fs_uuid> ). IF et_uuid IS SUPPLIED . APPEND <fs_uuid> TO et_uuid . ENDIF . IF et_uuid_opt IS SUPPLIED . INSERT VALUE # ( sign = 'I' option = 'EQ' low = <fs_uuid> ) INTO TABLE et_uuid_opt . ENDIF . ENDLOOP . SORT et_uuid BY table_line . DELETE ADJACENT DUPLICATES FROM et_uuid COMPARING table_line . DELETE et_uuid WHERE table_line IS INITIAL . SORT et_uuid_opt BY low . DELETE ADJACENT DUPLICATES FROM et_uuid_opt COMPARING low . DELETE et_uuid_opt WHERE low IS INITIAL . ENDMETHOD . ENDCLASS . *&---------------------------------------------------------------------* *& LIF_LOG *&---------------------------------------------------------------------* INTERFACE lif_log . METHODS check_active RETURNING VALUE ( r_result ) TYPE xfeld . METHODS get_log_kind RETURNING VALUE ( r_log_kind ) TYPE ty_log_head - log_kind . METHODS get_data . METHODS redo IMPORTING it_uuid TYPE tt_uuid . ENDINTERFACE . *&---------------------------------------------------------------------* *& LCL_LOG_PO *&---------------------------------------------------------------------* CLASS lcl_log_po DEFINITION . PUBLIC SECTION . INTERFACES lif_log . ENDCLASS . *&---------------------------------------------------------------------* *& LCL_LOG_PO *&---------------------------------------------------------------------* CLASS lcl_log_po IMPLEMENTATION . *&---------------------------------------------------------------------* *& lif_log~get_log_kind *&---------------------------------------------------------------------* METHOD lif_log~get_log_kind . r_log_kind = 'PO' . ENDMETHOD . *&---------------------------------------------------------------------* *& LIF_LOG~GET_DATA *&---------------------------------------------------------------------* METHOD lif_log~get_data . DATA ls_log TYPE ty_log . DATA ls_log_rawdata TYPE ty_log_rawdata . DATA : ls_clustkey TYPE sxmsclustkey , ls_clur TYPE sxmsclur , lt_res TYPE sxmsrest , lt_xres TYPE sxmsxrest , lt_ns TYPE sxmsnst . DATA l_from TYPE sxmspmast - sendtimest . DATA l_to TYPE sxmspmast - sendtimest . IF s_time[] IS NOT INITIAL . CONVERT DATE s_date [ 1 ] - low TIME s_time [ 1 ] - low INTO TIME STAMP l_from TIME ZONE sy - zonlo . CONVERT DATE s_date [ 1 ] - high TIME s_time [ 1 ] - high INTO TIME STAMP l_to TIME ZONE sy - zonlo . ELSE . CONVERT DATE s_date [ 1 ] - low TIME '000000' INTO TIME STAMP l_from TIME ZONE sy - zonlo . CONVERT DATE s_date [ 1 ] - high TIME '235959' INTO TIME STAMP l_to TIME ZONE sy - zonlo . ENDIF . \" SXMSPEMAS\uff0c\u6846\u67b6\u4fe1\u606f\uff0c\u53d1\u9001SI\uff0c\u63a5\u6536SI\uff0c\u547d\u540d\u7a7a\u95f4\uff0c\u7cfb\u7edf\u7b49 \" SXMSPMAST\uff0c\u4e3b\u8981\u4fe1\u606f\uff0c\u7528\u6237\uff0c\u5f00\u59cb\u7ed3\u675f\u65f6\u95f4\u7b49 \" SXMSCLUR\uff0c\u6d88\u606f\u62a5\u6587 SELECT a~msgguid , a~pid , b~ob_system , b~ob_name , b~ib_system , b~ib_name , a~adminuser , a~sendtimest , a~msgtype FROM sxmspmast AS a JOIN sxmspemas AS b ON a~msgguid = b~msgguid AND a~pid = b~pid WHERE a~msgguid IN @ s_uuid AND a~sendtimest BETWEEN @ l_from AND @ l_to AND ( b~ob_name IN @ s_siname OR b~ib_name IN @ s_siname ) AND a~adminuser IN @ s_user AND a~msgtype IN @ s_mtype INTO TABLE @ DATA ( lt_pilog ). LOOP AT lt_pilog INTO DATA ( ls_pilog ). \" \u8bfb\u53d6PO\u62a5\u6587 CLEAR ls_clustkey . CLEAR ls_clur . CLEAR lt_res . CLEAR lt_xres . CLEAR lt_ns . ls_clustkey - msgguid = ls_pilog - msgguid . ls_clustkey - pid = ls_pilog - pid . IMPORT lt_res TO lt_res lt_xres TO lt_xres lt_ns TO lt_ns FROM DATABASE sxmsclur ( is ) TO ls_clur ID ls_clustkey . CLEAR ls_log . ls_log - uuid = ls_pilog - msgguid . \" \u63a5\u53e3ID IF ls_pilog - ob_name IS NOT INITIAL . ls_log - intf_id = ls_pilog - ob_name . ELSE . ls_log - intf_id = ls_pilog - ib_name . ENDIF . ls_log - io_flag = ls_pilog - pid . \" \u63a5\u53e3\u65b9\u5411 ls_log - zsender = ls_pilog - ob_system . \" \u53d1\u9001\u65b9 ls_log - zreceiver = ls_pilog - ib_system . \" \u63a5\u53d7\u65b9 CONVERT TIME STAMP ls_pilog - sendtimest TIME ZONE sy - zonlo INTO DATE ls_log - zdate TIME ls_log - ztime . ls_log - zuser = ls_pilog - adminuser . ls_log - mtype = ls_pilog - msgtype . INSERT ls_log INTO TABLE gt_log . READ TABLE lt_xres REFERENCE INTO DATA ( lr_xres ) INDEX 1 . IF sy - subrc = 0 AND lr_xres -> rescontent IS NOT INITIAL . CLEAR ls_log_rawdata . ls_log_rawdata - uuid = ls_pilog - msgguid . ls_log_rawdata - zformat = 'XML' . ls_log_rawdata - zrawx = lr_xres -> rescontent . \" \u539f\u59cb\u6570\u636e INSERT ls_log_rawdata INTO TABLE gt_log_rawdata . ENDIF . ENDLOOP . ENDMETHOD . *&---------------------------------------------------------------------* *& LIF_LOG~REDO *&---------------------------------------------------------------------* METHOD lif_log~redo . ENDMETHOD . *&---------------------------------------------------------------------* *& lif_log~check_active *&---------------------------------------------------------------------* METHOD lif_log~check_active . r_result = p_po . ENDMETHOD . ENDCLASS . *&---------------------------------------------------------------------* *& LCL_LOG_CUSTOM *&---------------------------------------------------------------------* CLASS lcl_log_custom DEFINITION . PUBLIC SECTION . INTERFACES lif_log . ENDCLASS . *&---------------------------------------------------------------------* *& LCL_LOG_CUSTOM *&---------------------------------------------------------------------* CLASS lcl_log_custom IMPLEMENTATION . *&---------------------------------------------------------------------* *& lif_log~get_log_kind *&---------------------------------------------------------------------* METHOD lif_log~get_log_kind . r_log_kind = 'CUSTOM' . ENDMETHOD . *&---------------------------------------------------------------------* *& LIF_LOG~GET_DATA *&---------------------------------------------------------------------* METHOD lif_log~get_data . \" DATA ls_log TYPE ty_log. \" DATA ls_log_rawdata TYPE ty_log_rawdata. \" DATA l_zitem TYPE ty_log-zitem. \" SELECT \" ztintf~sysid, \" ztintf~funcname, \" tftit~stext \" FROM ztintf \" JOIN tftit ON ztintf~funcname = tftit~funcname \" AND tftit~spras = '1' \" INTO TABLE @DATA(lt_ztintf). \" SORT lt_ztintf BY sysid. \" SELECT * FROM ztlog \" WHERE zguid IN @s_uuid \" AND intfid IN @s_intfid \" AND zsender IN @s_snd \" AND zreceiver IN @s_rcv \" AND datum IN @s_date \" AND uzeit IN @s_time \" AND zstatus IN @s_mtype \" AND funcname IN @s_func \" INTO TABLE @DATA(lt_ztlog). \" SORT lt_ztlog BY zguid. \" LOOP AT lt_ztlog INTO DATA(ls_ztlog). \" AT NEW zguid. \" CLEAR l_zitem. \" ENDAT. \" l_zitem = l_zitem + 1. \" CLEAR ls_log. \" ls_log-uuid = ls_ztlog-zguid. \" ls_log-zitem = l_zitem. \" ls_log-intf_id = ls_ztlog-intfid. \" \u63a5\u53e3ID \" READ TABLE lt_ztintf REFERENCE INTO DATA(lr_ztintf) \" WITH KEY sysid = ls_ztlog-intfid BINARY SEARCH. \" IF sy-subrc = 0. \" ls_log-func_name = lr_ztintf->funcname. \" ls_log-func_text = lr_ztintf->stext. \" ENDIF. \" ls_log-io_flag = ls_ztlog-zzio. \" \u63a5\u53e3\u65b9\u5411 \" ls_log-zsender = ls_ztlog-zsender. \" \u53d1\u9001\u65b9 \" ls_log-zreceiver = ls_ztlog-zreceiver. \" \u63a5\u53d7\u65b9 \" ls_log-zdate = ls_ztlog-datum. \" ls_log-ztime = ls_ztlog-uzeit. \" ls_log-zuser = ls_ztlog-uname. \" ls_log-mtype = ls_ztlog-zstatus. \" ls_log-zconut = ls_ztlog-zcount. \" \u6761\u76ee\u7edf\u8ba1 \" INSERT ls_log INTO TABLE gt_log. \" IF ls_ztlog-zjson IS NOT INITIAL. \" CLEAR ls_log_rawdata. \" ls_log_rawdata-uuid = ls_ztlog-zguid. \" ls_log_rawdata-zitem = l_zitem. \" ls_log_rawdata-zformat = 'JSON'. \" ls_log_rawdata-zraw = ls_ztlog-zjson. \" \u539f\u59cb\u6570\u636e \" INSERT ls_log_rawdata INTO TABLE gt_log_rawdata. \" ENDIF. \" ENDLOOP. ENDMETHOD . *&---------------------------------------------------------------------* *& LIF_LOG~REDO *&---------------------------------------------------------------------* METHOD lif_log~redo . \" DATA l_fsyid TYPE string. \" DATA l_fname TYPE string. \" DATA l_sdata TYPE string. \" DATA l_infud TYPE string. \" DATA l_ftname TYPE string. \" DATA(lo_proxy) = NEW zcl_intf_proxy( ). \" LOOP AT it_uuid INTO DATA(l_uuid). \" READ TABLE gt_log INTO DATA(ls_log) WITH KEY \" uuid = l_uuid \" io_flag = '2'. \" IF ls_log-mtype = 'S'. \" lcl_progress=>step( |{ l_uuid }\u4e0d\u9700\u8981\u91cd\u5904\u7406| ). \" CONTINUE. \" ELSE. \" READ TABLE gt_log INTO ls_log WITH KEY \" uuid = l_uuid \" io_flag = '1'. \" IF sy-subrc = 0. \" READ TABLE gt_log_rawdata INTO DATA(ls_log_rawdata) WITH KEY \" uuid = ls_log-uuid \" zitem = ls_log-zitem \" BINARY SEARCH. \" IF sy-subrc = 0. \" l_fsyid = ls_log-zsender. \" \u5916\u90e8\u7cfb\u7edf \" l_fname = ls_log-intf_id. \" \u63a5\u53e3ID \" l_sdata = ls_log_rawdata-zraw. \" \u8bf7\u6c42\u62a5\u6587 \" l_infud = ls_log-uuid. \" \u62a5\u6587ID \" l_ftname = ls_log-func_name. \" \u5bf9\u5e94\u51fd\u6570\u540d \" CASE ls_log-zsender. \" WHEN 'SAP'. \" CALL METHOD lo_proxy->sap_data_to_out \" EXPORTING \" iv_fname = l_fname \" iv_sdata = l_sdata \" iv_infud = l_infud \" iv_ftname = l_ftname. \" WHEN OTHERS. \" CALL METHOD lo_proxy->out_data_to_sap \" EXPORTING \" iv_fsyid = l_fsyid \" iv_fname = l_fname \" iv_sdata = l_sdata \" iv_infud = l_infud. \" ENDCASE. \" lcl_progress=>step( |{ l_uuid }\u5df2\u63d0\u4ea4\u91cd\u5904\u7406| ). \" ENDIF. \" ENDIF. \" ENDIF. \" ENDLOOP. ENDMETHOD . *&---------------------------------------------------------------------* *& lif_log~check_active *&---------------------------------------------------------------------* METHOD lif_log~check_active . r_result = p_custom . ENDMETHOD . ENDCLASS . *&---------------------------------------------------------------------* *& FRM_INIT *&---------------------------------------------------------------------* FORM frm_init . GET PARAMETER ID 'LIB' FIELD s_func - low . \" \u66f4\u65b0\u53c2\u6570\u76f8\u5173 b900 = '\u81ea\u5b9a\u4e49\u9009\u62e9\u6761\u4ef6' . % _p_custom_ % _app_ % - text = '\u67e5\u8be2\u81ea\u5b9a\u4e49\u65e5\u5fd7' . % _s_intfid_ % _app_ % - text = '\u63a5\u53e3\u7f16\u53f7' . b100 = '\u901a\u7528\u9009\u62e9\u6761\u4ef6' . % _s_uuid_ % _app_ % - text = 'UUID' . % _s_func_ % _app_ % - text = '\u51fd\u6570\u540d' . % _s_snd_ % _app_ % - text = '\u53d1\u9001\u65b9' . % _s_rcv_ % _app_ % - text = '\u63a5\u6536\u65b9' . % _s_date_ % _app_ % - text = '\u5904\u7406\u65e5\u671f' . % _s_time_ % _app_ % - text = '\u5904\u7406\u65f6\u95f4' . % _s_user_ % _app_ % - text = '\u5904\u7406\u4eba' . % _s_mtype_ % _app_ % - text = '\u72b6\u6001' . b101 = '\u6269\u5c55\u9009\u62e9\u6761\u4ef6' . % _s_field_ % _app_ % - text = '\u5b57\u6bb5\u540d' . % _s_value_ % _app_ % - text = '\u5b57\u6bb5\u503c' . b102 = 'PO\u9009\u62e9\u6761\u4ef6' . % _p_po_ % _app_ % - text = '\u67e5\u8be2PO' . % _s_siname_ % _app_ % - text = '\u63a5\u53e3\u540d\u79f0' . b200 = '\u62a5\u8868\u6837\u5f0f' . % _p_logh_ % _app_ % - text = '\u65e5\u5fd7\u62ac\u5934\u6570\u636e\u5c55\u793a' . % _p_unit_ % _app_ % - text = '\u5355\u5143\u6570\u636e\u5c55\u793a' . % _p_flat_ % _app_ % - text = '\u6241\u5e73\u7ed3\u6784\u5c55\u793a' . b201 = '\u5176\u4ed6\u9009\u9879' . % _p_ctl1_ % _app_ % - text = '\u7d27\u51d1\u5c55\u793a' . % _p_ctl2_ % _app_ % - text = '\u5c55\u793a\u7ed3\u6784\u62ac\u5934' . % _p_ctl3_ % _app_ % - text = '\u5355\u5143\u683c\u7740\u8272' . % _p_ctl4_ % _app_ % - text = '\u5217\u5bbd\u81ea\u9002\u5e94' . % _p_ctl5_ % _app_ % - text = '\u65e5\u5fd7\u8bb0\u5f55\u76f8\u9694\u7a7a\u884c' . gs_color - blue = VALUE # ( col = 4 ). gs_color - yellow = VALUE # ( col = 3 ). gs_color - green = VALUE # ( col = 5 ). gs_color - red = VALUE # ( col = 6 ). gs_color - dept_blue = VALUE # ( col = 4 int = 1 ). gs_color - dept_yellow = VALUE # ( col = 3 int = 1 ). gs_color - dept_green = VALUE # ( col = 5 int = 1 ). gs_color - dept_red = VALUE # ( col = 6 int = 1 ). PERFORM frm_find_log_impl . \" \u67e5\u627e\u5e76\u521b\u5efa\u65e5\u5fd7\u5b9e\u4f8b ENDFORM . *&---------------------------------------------------------------------* *& FRM_FIND_LOG_IMPL *&---------------------------------------------------------------------* FORM frm_find_log_impl . DATA lt_classname TYPE STANDARD TABLE OF seoclsname . DATA lo_classdescr TYPE REF TO cl_abap_classdescr . DATA lo_log TYPE REF TO lif_log . DATA ( lo_scan ) = NEW cl_ci_scan ( cl_ci_source_include => create ( p_name = sy - repid ) ). LOOP AT lo_scan -> tokens INTO DATA ( ls_token ) WHERE str = 'CLASS' . READ TABLE lo_scan -> tokens INTO ls_token INDEX sy - tabix + 1 . INSERT CONV # ( ls_token - str ) INTO TABLE lt_classname . ENDLOOP . SORT lt_classname BY table_line . DELETE ADJACENT DUPLICATES FROM lt_classname COMPARING table_line . LOOP AT lt_classname INTO DATA ( l_classname ). lo_classdescr ?= cl_abap_classdescr => describe_by_name ( l_classname ). READ TABLE lo_classdescr -> interfaces TRANSPORTING NO FIELDS WITH KEY name = 'LIF_LOG' . IF sy - subrc = 0 . TRY . CREATE OBJECT lo_log TYPE ( lo_classdescr -> absolute_name ). INSERT lo_log INTO TABLE gt_log_impl . CATCH cx_root . ENDTRY . ENDIF . ENDLOOP . ENDFORM . *&---------------------------------------------------------------------* *& FRM_MAIN *&---------------------------------------------------------------------* FORM frm_main . \" \u4e3a\u4e86\u65b9\u4fbf\u8bfb\u53d6\u65f6\u95f4+\u65e5\u671f\u8303\u56f4\uff0c\u7a0d\u5fae\u8c03\u6574\u4e0b\u65e5\u671f\u683c\u5f0f LOOP AT s_date REFERENCE INTO DATA ( lr_date_opt ). IF lr_date_opt -> high IS INITIAL . lr_date_opt -> option = 'BT' . lr_date_opt -> high = lr_date_opt -> low . ENDIF . ENDLOOP . LOOP AT s_time REFERENCE INTO DATA ( lr_time_opt ). IF lr_time_opt -> high IS INITIAL . lr_time_opt -> option = 'BT' . lr_time_opt -> high = lr_time_opt -> low . ENDIF . ENDLOOP . lcl_progress => step ( '\u67e5\u8be2\u65e5\u5fd7\u6570\u636e' ). PERFORM frm_get_data . lcl_progress => step ( '\u65e5\u5fd7\u6570\u636e\u5904\u7406' ). PERFORM frm_process_data . PERFORM frm_display . \" ALV\u5c55\u793a ENDFORM . *&---------------------------------------------------------------------* *& FRM_GET_DATA *&---------------------------------------------------------------------* FORM frm_get_data . DATA lt_log TYPE tt_log . LOOP AT gt_log_impl INTO DATA ( lo_log ). CHECK lo_log -> check_active ( ) = abap_true . CLEAR gt_log . lo_log -> get_data ( ). \" \u53d6\u6570 LOOP AT gt_log REFERENCE INTO DATA ( lr_log ). lr_log -> log_kind = lo_log -> get_log_kind ( ). lr_log -> zraw_icon = icon_detail . ENDLOOP . INSERT LINES OF gt_log INTO TABLE lt_log . ENDLOOP . gt_log = lt_log . ENDFORM . *&---------------------------------------------------------------------* *& FRM_PROCESS_DATA *&---------------------------------------------------------------------* FORM frm_process_data . \" \u65e5\u671f\u65f6\u95f4\u5012\u5e8f SORT gt_log BY zdate DESCENDING ztime DESCENDING uuid zitem DESCENDING . SORT gt_log_rawdata BY uuid zitem . \" \u7528\u4e8e\u5f39\u7a97\u5c55\u793a\u539f\u59cb\u6570\u636e \" \u4e0d\u9700\u8981\u5c55\u793a\u52a0\u5de5\u6570\u636e\u7684\u8bdd\uff0c\u6ca1\u5fc5\u8981\u7ee7\u7eed\u6267\u884c\u6d6a\u8d39\u65f6\u95f4 IF p_logh = abap_true AND s_value[] IS INITIAL . RETURN . ENDIF . * \" \u6a21\u7cca\u67e5\u8be2 * LOOP AT s_value[] REFERENCE INTO DATA(lr_value_opt). * IF lr_value_opt->option = 'EQ'. * lr_value_opt->option = 'CP'. * lr_value_opt->low = |*{ lr_value_opt->low }*|. * ENDIF. * ENDLOOP. DATA ( lo_progress ) = NEW lcl_progress ( ). lo_progress -> m_name = '\u63a5\u53e3\u6570\u636e\u5904\u7406' . lo_progress -> start ( lines ( gt_log ) ). LOOP AT gt_log REFERENCE INTO DATA ( lr_log ). lo_progress -> next ( ). \" \u8fdb\u5ea6\u5c55\u793a \" \u8f6c\u5316\u4e3a\u6570\u636e\u5355\u5143 READ TABLE gt_log_rawdata REFERENCE INTO DATA ( lr_log_rawdata ) WITH KEY uuid = lr_log -> uuid zitem = lr_log -> zitem BINARY SEARCH . IF sy - subrc = 0 . CASE lr_log_rawdata -> zformat . WHEN 'JSON' . lr_log -> t_unit = lcl_unit_helper => parse_json ( lr_log_rawdata -> zraw ). WHEN 'XML' . lr_log -> t_unit = lcl_unit_helper => parse_xml ( lr_log_rawdata -> zrawx ). ENDCASE . ENDIF . CHECK lr_log -> t_unit IS NOT INITIAL . \" \u6269\u5c55\u67e5\u8be2 IF s_value[] IS NOT INITIAL . IF s_field[] IS NOT INITIAL . LOOP AT lr_log -> t_unit TRANSPORTING NO FIELDS WHERE key IN s_field[] AND value IN s_value[] . EXIT . ENDLOOP . ELSE . LOOP AT lr_log -> t_unit TRANSPORTING NO FIELDS WHERE value IN s_value[] . EXIT . ENDLOOP . ENDIF . \" \u8fc7\u6ee4\u4e0d\u7b26\u5408\u6761\u4ef6\u7684\u6570\u636e IF sy - subrc <> 0 . DELETE gt_log . CONTINUE . ENDIF . ENDIF . CALL METHOD lcl_unit_helper => generate_flatdata EXPORTING it_unit = lr_log -> t_unit i_compact = p_ctl1 IMPORTING et_flatdt = lr_log -> t_flatdt RECEIVING rr_data = lr_log -> r_flatdata . ENDLOOP . lo_progress -> finish ( ). ENDFORM . *&---------------------------------------------------------------------* *& FRM_DISPLAY *&---------------------------------------------------------------------* FORM frm_display . CASE 'X' . WHEN p_logh . \" \u65e5\u5fd7\u62ac\u5934\u6570\u636e\u5c55\u793a go_alv ?= NEW lcl_alv_logh ( ). WHEN p_unit . \" \u5355\u5143\u6570\u636e\u5c55\u793a go_alv ?= NEW lcl_alv_unit ( ). WHEN p_flat . \" \u6241\u5e73\u7ed3\u6784\u5c55\u793a go_alv ?= NEW lcl_alv_flat ( ). WHEN OTHERS . MESSAGE '\u65e0\u6548\u7684\u5c55\u793a\u65b9\u5f0f' TYPE 'S' DISPLAY LIKE 'E' . RETURN . ENDCASE . CALL SCREEN '9000' . ENDFORM . *&---------------------------------------------------------------------* *& FRM_REDO *&---------------------------------------------------------------------* FORM frm_redo . go_alv -> get_selected_uuid ( IMPORTING et_uuid = DATA ( lt_uuid ) ). CHECK lt_uuid IS NOT INITIAL . LOOP AT gt_log_impl INTO DATA ( lo_log ). CHECK lo_log -> check_active ( ) = abap_true . DATA ( l_log_kind ) = lo_log -> get_log_kind ( ). DATA lt_uuid_tmp TYPE tt_uuid . CLEAR lt_uuid_tmp . LOOP AT gt_log REFERENCE INTO DATA ( lr_log ) WHERE log_kind = l_log_kind . READ TABLE lt_uuid INTO DATA ( l_uuid ) WITH KEY table_line = lr_log -> uuid BINARY SEARCH . IF sy - subrc = 0 . INSERT l_uuid INTO TABLE lt_uuid_tmp . ENDIF . ENDLOOP . IF lt_uuid_tmp IS NOT INITIAL . lo_log -> redo ( lt_uuid_tmp ). ENDIF . ENDLOOP . ENDFORM . *&---------------------------------------------------------------------* *& FRM_F4_INTFID *&---------------------------------------------------------------------* FORM frm_f4_intfid . \" SELECT \" ztintf~sysnm, \" ztintf~sysid, \" ztintf~funcname, \" tftit~stext \" FROM ztintf \" JOIN tftit ON spras = '1' \" AND ztintf~funcname = tftit~funcname \" INTO TABLE @DATA(lt_ztintf). \" \" DATA l_dynprofield TYPE dynfnam. \" GET CURSOR FIELD l_dynprofield. \" \" CALL FUNCTION 'F4IF_INT_TABLE_VALUE_REQUEST' \" EXPORTING \" retfield = 'SYSID' \" value_org = 'S' \" dynprofield = l_dynprofield \" dynpprog = sy-repid \" dynpnr = sy-dynnr \" TABLES \" value_tab = lt_ztintf \" EXCEPTIONS \" parameter_error = 1 \" no_values_found = 2 \" OTHERS = 3. \" IF sy-subrc <> 0. \" MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno \" WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4. \" ENDIF. ENDFORM . *&---------------------------------------------------------------------* *& \u521d\u59cb\u5316 *&---------------------------------------------------------------------* INITIALIZATION . PERFORM frm_init . **&---------------------------------------------------------------------* **& \u81ea\u5b9a\u4e49\u65e5\u5fd7\u8868\u63a5\u53e3ID\u641c\u7d22\u5e2e\u52a9 **&---------------------------------------------------------------------* *AT SELECTION-SCREEN ON VALUE-REQUEST FOR s_intfid-low. * PERFORM frm_f4_intfid. * *AT SELECTION-SCREEN ON VALUE-REQUEST FOR s_intfid-high. * PERFORM frm_f4_intfid. *&---------------------------------------------------------------------* *& START-OF-SELECTION *&---------------------------------------------------------------------* START-OF-SELECTION . PERFORM frm_main . *&---------------------------------------------------------------------* *& MODULE STATUS_9000 OUTPUT *&---------------------------------------------------------------------* MODULE status_9000 OUTPUT . go_alv -> pbo ( ). SET PF-STATUS 'STATUS' . ENDMODULE . *&---------------------------------------------------------------------* *& MODULE USER_COMMAND_9000 INPUT *&---------------------------------------------------------------------* MODULE user_command_9000 INPUT . CASE sy - ucomm . WHEN 'REDO' . \" \u9519\u8bef\u91cd\u5904\u7406 PERFORM frm_redo . WHEN '&F03' OR '&F15' OR '&F12' . LEAVE TO SCREEN 0 . WHEN OTHERS . go_alv -> pai ( ). ENDCASE . ENDMODULE . LIF_LOG\u5b9e\u4f8b\u53c2\u8003\u4ee3\u7801 *&---------------------------------------------------------------------* *& LCL_LOG_CUSTOM *&---------------------------------------------------------------------* CLASS lcl_log_custom DEFINITION . PUBLIC SECTION . INTERFACES lif_log . ENDCLASS . *&---------------------------------------------------------------------* *& LCL_LOG_CUSTOM *&---------------------------------------------------------------------* CLASS lcl_log_custom IMPLEMENTATION . *&---------------------------------------------------------------------* *& lif_log~get_log_kind *&---------------------------------------------------------------------* METHOD lif_log~get_log_kind . r_log_kind = 'CUSTOM' . ENDMETHOD . *&---------------------------------------------------------------------* *& LIF_LOG~GET_DATA *&---------------------------------------------------------------------* METHOD lif_log~get_data . DATA ls_log TYPE ty_log . DATA ls_log_rawdata TYPE ty_log_rawdata . DATA l_zitem TYPE ty_log - zitem . SELECT ztintf~sysid , ztintf~funcname , tftit~stext FROM ztintf JOIN tftit ON ztintf~funcname = tftit~funcname AND tftit~spras = '1' INTO TABLE @ DATA ( lt_ztintf ). SORT lt_ztintf BY sysid . SELECT * FROM ztlog WHERE zguid IN @ s_uuid AND intfid IN @ s_intfid AND zsender IN @ s_snd AND zreceiver IN @ s_rcv AND datum IN @ s_date AND uzeit IN @ s_time AND zstatus IN @ s_mtype AND funcname IN @ s_func INTO TABLE @ DATA ( lt_ztlog ). SORT lt_ztlog BY zguid . LOOP AT lt_ztlog INTO DATA ( ls_ztlog ). AT NEW zguid . CLEAR l_zitem . ENDAT . l_zitem = l_zitem + 1 . CLEAR ls_log . ls_log - uuid = ls_ztlog - zguid . ls_log - zitem = l_zitem . ls_log - intf_id = ls_ztlog - intfid . \" \u63a5\u53e3ID READ TABLE lt_ztintf REFERENCE INTO DATA ( lr_ztintf ) WITH KEY sysid = ls_ztlog - intfid BINARY SEARCH . IF sy - subrc = 0 . ls_log - func_name = lr_ztintf -> funcname . ls_log - func_text = lr_ztintf -> stext . ENDIF . ls_log - io_flag = ls_ztlog - zzio . \" \u63a5\u53e3\u65b9\u5411 ls_log - zsender = ls_ztlog - zsender . \" \u53d1\u9001\u65b9 ls_log - zreceiver = ls_ztlog - zreceiver . \" \u63a5\u53d7\u65b9 ls_log - zdate = ls_ztlog - datum . ls_log - ztime = ls_ztlog - uzeit . ls_log - zuser = ls_ztlog - uname . ls_log - mtype = ls_ztlog - zstatus . ls_log - zconut = ls_ztlog - zcount . \" \u6761\u76ee\u7edf\u8ba1 INSERT ls_log INTO TABLE gt_log . IF ls_ztlog - zjson IS NOT INITIAL . CLEAR ls_log_rawdata . ls_log_rawdata - uuid = ls_ztlog - zguid . ls_log_rawdata - zitem = l_zitem . ls_log_rawdata - zformat = 'JSON' . ls_log_rawdata - zraw = ls_ztlog - zjson . \" \u539f\u59cb\u6570\u636e INSERT ls_log_rawdata INTO TABLE gt_log_rawdata . ENDIF . ENDLOOP . ENDMETHOD . *&---------------------------------------------------------------------* *& LIF_LOG~REDO *&---------------------------------------------------------------------* METHOD lif_log~redo . DATA l_fsyid TYPE string . DATA l_fname TYPE string . DATA l_sdata TYPE string . DATA l_infud TYPE string . DATA l_ftname TYPE string . DATA ( lo_proxy ) = NEW zcl_intf_proxy ( ). LOOP AT it_uuid INTO DATA ( l_uuid ). READ TABLE gt_log INTO DATA ( ls_log ) WITH KEY uuid = l_uuid io_flag = '2' . IF ls_log - mtype = 'S' . lcl_progress => step ( |{ l_uuid } \u4e0d\u9700\u8981\u91cd\u5904\u7406 | ). CONTINUE . ELSE . READ TABLE gt_log INTO ls_log WITH KEY uuid = l_uuid io_flag = '1' . IF sy - subrc = 0 . READ TABLE gt_log_rawdata INTO DATA ( ls_log_rawdata ) WITH KEY uuid = ls_log - uuid zitem = ls_log - zitem BINARY SEARCH . IF sy - subrc = 0 . l_fsyid = ls_log - zsender . \" \u5916\u90e8\u7cfb\u7edf l_fname = ls_log - intf_id . \" \u63a5\u53e3ID l_sdata = ls_log_rawdata - zraw . \" \u8bf7\u6c42\u62a5\u6587 l_infud = ls_log - uuid . \" \u62a5\u6587ID l_ftname = ls_log - func_name . \" \u5bf9\u5e94\u51fd\u6570\u540d CASE ls_log - zsender . WHEN 'SAP' . CALL METHOD lo_proxy -> sap_data_to_out EXPORTING iv_fname = l_fname iv_sdata = l_sdata iv_infud = l_infud iv_ftname = l_ftname . WHEN OTHERS . CALL METHOD lo_proxy -> out_data_to_sap EXPORTING iv_fsyid = l_fsyid iv_fname = l_fname iv_sdata = l_sdata iv_infud = l_infud . ENDCASE . lcl_progress => step ( |{ l_uuid } \u5df2\u63d0\u4ea4\u91cd\u5904\u7406 | ). ENDIF . ENDIF . ENDIF . ENDLOOP . ENDMETHOD . *&---------------------------------------------------------------------* *& lif_log~check_active *&---------------------------------------------------------------------* METHOD lif_log~check_active . r_result = p_custom . ENDMETHOD . ENDCLASS .","title":"\u65e5\u5fd7\u67e5\u8be2\u62a5\u8868"},{"location":"report/zlogreport/#_1","text":"\u8be5\u7a0b\u5e8f\u7528\u4e8e\u67e5\u8be2\u63a5\u53e3\u65e5\u5fd7\uff0c\u5e76\u5df2\u52a0\u5165PO\u65e5\u5fd7\u67e5\u8be2\uff08\u4ec5\u9650\u7cfb\u7edf\u5185\u5b58\u50a8\u7684\u65e5\u5fd7\u6570\u636e\uff09\uff0c\u5982\u6709\u81ea\u5b9a\u4e49\u65e5\u5fd7\u6570\u636e\u60f3\u8981\u5c55\u793a\uff0c\u9700\u8981\u7ee7\u627f\u672c\u5730\u63a5\u53e3LIF_LOG\uff0c\u5e76\u5b9e\u65bd\u63a5\u53e3\u65b9\u6cd5\u3002 \u62a5\u8868\u6267\u884c\u65f6\u4f1a\u68c0\u7d22\u5b9e\u4f8b\u7c7b\uff0c\u56e0\u6b64\u65e0\u9700\u624b\u5de5\u521b\u5efa\u65b0\u7684\u65e5\u5fd7\u5b9e\u4f8b\uff08CREATE OBJECT\uff0cNEW #()\u7b49\uff09\u3002 \u793a\u4f8b\u4ee3\u7801 *&---------------------------------------------------------------------* *& REPORT ZLOGREPORT *&---------------------------------------------------------------------* *& V2 - XIAOFENG - 2022-09-26 14:11:17 *& \u4e0a\u4e2a\u9879\u76ee\u7684\u90a3\u7248\u5199\u5f97\u592a\u590d\u6742\uff0c\u65e0\u6cd5\u6269\u5c55\uff0c\u8fd9\u6b21\u4e58\u673a\u7b80\u5316\u4e0b\u4ee3\u7801 *& \u4f7f\u7528\u6b65\u9aa4\uff1a *& 1 \u4ee3\u7801\u590d\u5236\u7c98\u8d34 *& 2 \u521b\u5efa9000\u5c4f\u5e55\uff0c\u6dfb\u52a0\u4e00\u4e2a\u5bb9\u5668\uff08\u5c5e\u6027\u6539\u81ea\u9002\u5e94\uff09\uff0c\u547d\u540dCON_9000 *& 3 \u521b\u5efa\u72b6\u6001\u680fSTATUS *& 3.1 \u6dfb\u52a0\u4e09\u4e2a\u9000\u51fa\u6309\u94ae\uff08&F03\\&F15\\&F12\uff09 *& 3.2 \u6dfb\u52a0REDO\u6309\u94ae\uff0c\u7528\u4e8e\u9519\u8bef\u6570\u636e\u91cd\u5904\u7406\uff0c\u6ca1\u6709\u7684\u8bdd\u5ffd\u7565\u5373\u53ef *& 4 \u65b0\u5efa\u5b9e\u65bd\u7c7b\uff0c\u7ee7\u627f\u63a5\u53e3LIF_LOG\uff0c\u628a\u63a5\u53e3\u65b9\u6cd5\u5b9e\u65bd\u5373\u53ef *& 4.1 GET_LOG_KIND\uff0c\u4e3a\u6bcf\u79cd\u65e5\u5fd7\u8bbe\u5b9a\u552f\u4e00\u540d\u79f0 *& 4.2 GET_DATA\uff0c\u67e5\u8be2\u65e5\u5fd7\u6570\u636e\uff0c\u5199\u5165\u5230GT_LOG\u548cGT_LOG_RAWDATA\u4e2d\uff08\u5f39\u7a97\u7528\uff09 *& 4.3 REDO\uff0c\u9519\u8bef\u91cd\u5904\u7406 *&---------------------------------------------------------------------* REPORT ZLOGREPORT *&---------------------------------------------------------------------* *& \u672c\u5730\u7c7b\u58f0\u660e *&---------------------------------------------------------------------* CLASS lcl_progress DEFINITION DEFERRED . \" \u8fdb\u5ea6\u6761 \" \u6570\u636e\u5904\u7406\u76f8\u5173 INTERFACE lif_unit_parser DEFERRED . CLASS lcl_data_unit_parser DEFINITION DEFERRED . CLASS lcl_json_unit_parser DEFINITION DEFERRED . CLASS lcl_xml_unit_parser DEFINITION DEFERRED . CLASS lcl_unit_helper DEFINITION DEFERRED . \" ALV\u76f8\u5173 INTERFACE lif_alv DEFERRED . CLASS lcl_alv_logh DEFINITION DEFERRED . \" \u65e5\u5fd7\u62ac\u5934\u6570\u636e\u5c55\u793a CLASS lcl_alv_unit DEFINITION DEFERRED . \" \u5355\u5143\u6570\u636e\u5c55\u793a CLASS lcl_alv_flat DEFINITION DEFERRED . \" \u6241\u5e73\u7ed3\u6784\u5c55\u793a \" \u65e5\u5fd7\u5904\u7406\u76f8\u5173 INTERFACE lif_log DEFERRED . CLASS lcl_log_po DEFINITION DEFERRED . \" PO\u65e5\u5fd7 CLASS lcl_log_custom DEFINITION DEFERRED . \" \u81ea\u5b9a\u4e49\u65e5\u5fd7 *&---------------------------------------------------------------------* *& \u7c7b\u578b\u5b9a\u4e49 *&---------------------------------------------------------------------* \" \u6570\u636e\u5355\u5143\uff0c\u7b80\u5355\u6765\u8bf4\uff0c\u4e00\u4e2a\u503c\u5c31\u662f\u4e00\u4e2a\u5355\u5143 TYPES : BEGIN OF ty_unit , path TYPE string , \" \u8def\u5f84 key TYPE string , \" \u952e value TYPE string , \" \u503c END OF ty_unit . TYPES tt_unit TYPE STANDARD TABLE OF ty_unit WITH EMPTY KEY . \" \u6241\u5e73\u7ed3\u6784\u4fe1\u606f TYPES : BEGIN OF ty_flatdt , struct TYPE string , \" \u7ed3\u6784 field TYPE string , \" \u5b57\u6bb5 position TYPE i , \" \u4f4d\u7f6e END OF ty_flatdt . TYPES tt_flatdt TYPE STANDARD TABLE OF ty_flatdt WITH EMPTY KEY . \" \u6570\u636e\u5355\u5143\u6269\u5c55 TYPES : BEGIN OF ty_unitex , \" \u521b\u5efa\u6241\u5e73\u7ed3\u6784\u7528\u5230 struct TYPE string , \" \u7ed3\u6784 path TYPE string , \" \u8def\u5f84 key TYPE string , \" \u952e value TYPE string , \" \u503c END OF ty_unitex . TYPES tt_unitex TYPE STANDARD TABLE OF ty_unitex WITH EMPTY KEY . \" \u65e5\u5fd7\u62ac\u5934\u4fe1\u606f TYPES : BEGIN OF ty_log_head , uuid TYPE sysuuid_c32 , \" \u65e5\u5fd7ID zitem TYPE i , \" \u5e8f\u53f7 log_kind TYPE c LENGTH 20 , \" \u65e5\u5fd7\u79cd\u7c7b\uff0c\u5982PI\u65e5\u5fd7\uff0c\u65e5\u5fd7\u7b49\u591a\u79cd intf_id TYPE c LENGTH 30 , \" \u63a5\u53e3\u6807\u8bc6 func_name TYPE rs38l_fnam , \" \u51fd\u6570\u540d func_text TYPE c LENGTH 40 , \" \u51fd\u6570\u63cf\u8ff0 ztext TYPE c LENGTH 255 , \" \u9644\u52a0\u4fe1\u606f\uff0c\u6709\u4e9b\u63a5\u53e3\u4f1a\u5728\u8bb0\u5f55\u7684\u65f6\u5019\u9644\u52a0\u4e00\u4e9b\u63cf\u8ff0\u8bf4\u660e io_flag TYPE c LENGTH 10 , \" \u5165\u53c2\u6216\u51fa\u53c2 zconut TYPE i , \" \u6761\u76ee\u7edf\u8ba1 zsender TYPE c LENGTH 20 , \" \u53d1\u9001\u65b9 zreceiver TYPE c LENGTH 20 , \" \u63a5\u53d7\u65b9 zraw_icon TYPE icon_d , \" \u53cc\u51fb\u5c55\u793a\u539f\u59cb\u6570\u636e zdate TYPE datum , \" \u65e5\u671f ztime TYPE uzeit , \" \u65f6\u95f4 zuser TYPE uname , \" \u7528\u6237 mtype TYPE bapi_mtype , \" \u72b6\u6001 msg TYPE bapi_msg , \" \u6d88\u606f\u6587\u672c rcol TYPE c LENGTH 4 , \" \u884c\u989c\u8272 t_scol TYPE lvc_t_scol , \" \u5355\u5143\u683c\u989c\u8272 t_styl TYPE lvc_t_styl , \" \u5355\u5143\u683c\u6837\u5f0f END OF ty_log_head . \" \u65e5\u5fd7\u6570\u636e TYPES : BEGIN OF ty_log_data , * r_data TYPE REF TO data, \" \u65e5\u5fd7\u6570\u636e t_unit TYPE tt_unit , \" \u6570\u636e\u5355\u5143 r_flatdata TYPE REF TO data , \" \u6241\u5e73\u7ed3\u6784\u6570\u636e t_flatdt TYPE tt_flatdt , \" \u6241\u5e73\u7ed3\u6784 END OF ty_log_data . TYPES : BEGIN OF ty_log . INCLUDE TYPE ty_log_head . INCLUDE TYPE ty_log_data . TYPES : END OF ty_log . TYPES tt_log TYPE STANDARD TABLE OF ty_log . \" \u65e5\u5fd7\u539f\u59cb\u6570\u636e TYPES : BEGIN OF ty_log_rawdata , uuid TYPE sysuuid_c32 , \" \u65e5\u5fd7ID zitem TYPE i , \" \u5e8f\u53f7 zformat TYPE c LENGTH 10 , \" \u539f\u59cb\u6570\u636e\u683c\u5f0f zraw TYPE string , \" \u539f\u59cb\u6570\u636e zrawx TYPE xstring , \" \u539f\u59cb\u6570\u636e END OF ty_log_rawdata . TYPES tt_log_rawdata TYPE STANDARD TABLE OF ty_log_rawdata . TYPES tt_uuid TYPE STANDARD TABLE OF ty_log_head - uuid . TYPES tt_uuid_opt TYPE RANGE OF ty_log_head - uuid . *&---------------------------------------------------------------------* *& \u6570\u636e\u58f0\u660e *&---------------------------------------------------------------------* DATA gt_log TYPE tt_log . \" \u65e5\u5fd7\u6570\u636e DATA gt_log_rawdata TYPE tt_log_rawdata . \" \u65e5\u5fd7\u6570\u636e DATA gt_log_impl TYPE STANDARD TABLE OF REF TO lif_log . DATA go_alv TYPE REF TO lif_alv . \" ALV\u5bf9\u8c61 DATA go_container TYPE REF TO cl_gui_container . DATA go_grid TYPE REF TO cl_gui_alv_grid . DATA : BEGIN OF gs_fieldname , fdlk TYPE string VALUE 'FDLK' , \" FLAT_DATA_LINE_KIND path TYPE string VALUE 'PATH' , field TYPE string VALUE '__FIELD' , END OF gs_fieldname . DATA : BEGIN OF gs_fdlk , header TYPE string VALUE 'HEADER' , data TYPE string VALUE 'DATA' , END OF gs_fdlk . DATA : BEGIN OF gs_color , blue TYPE lvc_s_colo , yellow TYPE lvc_s_colo , green TYPE lvc_s_colo , red TYPE lvc_s_colo , dept_blue TYPE lvc_s_colo , dept_yellow TYPE lvc_s_colo , dept_green TYPE lvc_s_colo , dept_red TYPE lvc_s_colo , END OF gs_color . *&---------------------------------------------------------------------* *& \u9009\u62e9\u5c4f\u5e55 *&---------------------------------------------------------------------* TABLES sxmspmast . \" PO\u76f8\u5173 TABLES sxmspemas . \" PO\u76f8\u5173 \" \u9009\u62e9\u6761\u4ef6 DATA : BEGIN OF gs_selection . INCLUDE TYPE ty_log_head . DATA : intfid TYPE char30 , \" \u81ea\u5b9a\u4e49\u65e5\u5fd7\u63a5\u53e3\u6807\u8bc6 * INCLUDE TYPE ty_unit. field TYPE char30 , \" TY_UNIT-FIELD\uff0cSTRING\u7c7b\u578b\u7684\uff0c\u4e0d\u80fd\u4f7f\u7528 value TYPE char30 . \" TY_UNIT-VALUE\uff0cSTRING\u7c7b\u578b\u7684\uff0c\u4e0d\u80fd\u4f7f\u7528 DATA : END OF gs_selection . \" \u81ea\u5b9a\u4e49\u9009\u62e9\u6761\u4ef6 SELECTION-SCREEN BEGIN OF BLOCK b900 WITH FRAME TITLE b900 . PARAMETERS p_custom TYPE xflag AS CHECKBOX DEFAULT 'X' . SELECT-OPTIONS s_intfid FOR gs_selection - intfid . SELECTION-SCREEN END OF BLOCK b900 . \" \u901a\u7528\u9009\u62e9\u6761\u4ef6 SELECTION-SCREEN BEGIN OF BLOCK b100 WITH FRAME TITLE b100 . SELECT-OPTIONS s_uuid FOR gs_selection - uuid . SELECT-OPTIONS s_func FOR gs_selection - func_name MATCHCODE OBJECT sfunc_modules . SELECT-OPTIONS s_snd FOR gs_selection - zsender . SELECT-OPTIONS s_rcv FOR gs_selection - zreceiver . SELECT-OPTIONS s_user FOR gs_selection - zuser MATCHCODE OBJECT user_comp . SELECT-OPTIONS s_date FOR gs_selection - zdate NO-EXTENSION OBLIGATORY DEFAULT sy - datum . SELECT-OPTIONS s_time FOR gs_selection - ztime NO-EXTENSION . SELECT-OPTIONS s_mtype FOR gs_selection - mtype . \" PO\u9009\u62e9\u6761\u4ef6 SELECTION-SCREEN BEGIN OF BLOCK b102 WITH FRAME TITLE b102 . PARAMETERS p_po TYPE xflag AS CHECKBOX DEFAULT 'X' . SELECT-OPTIONS s_siname FOR sxmspemas - ob_name . SELECTION-SCREEN END OF BLOCK b102 . \" \u6269\u5c55\u9009\u62e9\u6761\u4ef6 SELECTION-SCREEN BEGIN OF BLOCK b101 WITH FRAME TITLE b101 . SELECT-OPTIONS s_field FOR gs_selection - field . SELECT-OPTIONS s_value FOR gs_selection - value . SELECTION-SCREEN END OF BLOCK b101 . SELECTION-SCREEN END OF BLOCK b100 . \" \u5c55\u793a\u65b9\u5f0f SELECTION-SCREEN BEGIN OF BLOCK b200 WITH FRAME TITLE b200 . PARAMETERS p_logh RADIOBUTTON GROUP rg1 TYPE xflag DEFAULT 'X' . PARAMETERS p_flat RADIOBUTTON GROUP rg1 TYPE xflag . PARAMETERS p_unit RADIOBUTTON GROUP rg1 TYPE xflag . SELECTION-SCREEN BEGIN OF BLOCK b201 WITH FRAME TITLE b201 . PARAMETERS p_ctl1 TYPE xflag AS CHECKBOX . \" \u7d27\u51d1\u8868\u793a PARAMETERS p_ctl2 TYPE xflag AS CHECKBOX DEFAULT 'X' . PARAMETERS p_ctl3 TYPE xflag AS CHECKBOX DEFAULT 'X' . PARAMETERS p_ctl4 TYPE xflag AS CHECKBOX DEFAULT 'X' . PARAMETERS p_ctl5 TYPE i DEFAULT 1 . SELECTION-SCREEN END OF BLOCK b201 . SELECTION-SCREEN END OF BLOCK b200 . *&---------------------------------------------------------------------* *& \u672c\u5730\u7c7b\u5b9a\u4e49 *&---------------------------------------------------------------------* *&---------------------------------------------------------------------* *& CLASS LCL_PROGRESS *&---------------------------------------------------------------------* CLASS lcl_progress DEFINITION FINAL . PUBLIC SECTION . DATA m_total TYPE i . DATA m_current TYPE i . DATA m_time_start TYPE timestampl . DATA m_time TYPE timestampl . DATA m_interval TYPE i . DATA m_name TYPE string . METHODS start \" \u521d\u59cb\u5316 IMPORTING total TYPE i OPTIONAL RETURNING VALUE ( result ) TYPE REF TO lcl_progress . METHODS next \" \u589e\u52a0\u4e00\u70b9\u8fdb\u5ea6 IMPORTING delta TYPE i DEFAULT 1 RETURNING VALUE ( result ) TYPE REF TO lcl_progress . METHODS finish \" \u7ed3\u675f RETURNING VALUE ( result ) TYPE REF TO lcl_progress . METHODS show \" \u5de6\u4e0b\u89d2\u6d88\u606f IMPORTING text TYPE string OPTIONAL . METHODS percentage \" \u5f53\u524d\u8fdb\u5ea6 RETURNING VALUE ( result ) TYPE f . METHODS duration \" \u8fd0\u884c\u65f6\u95f4 RETURNING VALUE ( result ) TYPE f . CLASS-METHODS step \" \u5c55\u793a\u5355\u4e2a\u6761\u76ee IMPORTING text TYPE string OPTIONAL . ENDCLASS . *&---------------------------------------------------------------------* *& CLASS (IMPLEMENTATION) LCL_PROGRESS *&---------------------------------------------------------------------* CLASS lcl_progress IMPLEMENTATION . *&---------------------------------------------------------------------* *& START *&---------------------------------------------------------------------* METHOD start . result = me . m_total = total . IF m_interval = 0 . m_interval = 1 . \" \u4e0d\u52a0\u9650\u5236\u53cd\u800c\u5f71\u54cd\u6027\u80fd ENDIF . m_current = 0 . GET TIME STAMP FIELD m_time_start . m_time = m_time_start . ENDMETHOD . *&---------------------------------------------------------------------* *& NEXT *&---------------------------------------------------------------------* METHOD next . result = me . m_current = m_current + delta . DATA l_time TYPE timestampl . GET TIME STAMP FIELD l_time . IF m_current = m_total . m_time = l_time . ENDIF . IF m_time <= l_time . show ( ). IF m_interval > 0 . m_time = cl_abap_tstmp => add ( tstmp = l_time secs = m_interval ). ELSE . m_time = l_time . ENDIF . ENDIF . ENDMETHOD . *&---------------------------------------------------------------------* *& FINISH *&---------------------------------------------------------------------* METHOD finish . result = me . GET TIME STAMP FIELD m_time . show ( ). ENDMETHOD . *&---------------------------------------------------------------------* *& SHOW *&---------------------------------------------------------------------* METHOD show . DATA ( l_text ) = text . IF l_text IS INITIAL . l_text = |{ percentage ( ) DECIMALS = 0 } % [ { m_current NUMBER = USER } / { m_total NUMBER = USER } ] { duration ( ) DECIMALS = 0 } S |. IF m_name IS NOT INITIAL . l_text = |{ m_name } : { l_text }|. ENDIF . ENDIF . IF sy - batch = '' . CALL FUNCTION 'SAPGUI_PROGRESS_INDICATOR' EXPORTING text = l_text . ELSE . MESSAGE l_text TYPE 'S' . ENDIF . ENDMETHOD . *&---------------------------------------------------------------------* *& PERCENTAGE *&---------------------------------------------------------------------* METHOD percentage . IF m_total <> 0 . result = m_current / m_total * 100 . ENDIF . ENDMETHOD . *&---------------------------------------------------------------------* *& DURATION *&---------------------------------------------------------------------* METHOD duration . result = cl_abap_tstmp => subtract ( tstmp1 = m_time tstmp2 = m_time_start ). ENDMETHOD . *&---------------------------------------------------------------------* *& STEP *&---------------------------------------------------------------------* METHOD step . CALL FUNCTION 'SAPGUI_PROGRESS_INDICATOR' EXPORTING text = text . ENDMETHOD . ENDCLASS . *&---------------------------------------------------------------------* *& LIF_UNIT_PARSER DEFINITION *&---------------------------------------------------------------------* INTERFACE lif_unit_parser . METHODS parse RETURNING VALUE ( rt_result ) TYPE tt_unit . ENDINTERFACE . *&---------------------------------------------------------------------* *& LCL_DATA_UNIT_PARSER DEFINITION *&---------------------------------------------------------------------* CLASS lcl_data_unit_parser DEFINITION . PUBLIC SECTION . INTERFACES lif_unit_parser . METHODS constructor IMPORTING ir_data TYPE REF TO data . PRIVATE SECTION . DATA mr_data TYPE REF TO data . DATA mt_unit TYPE tt_unit . METHODS _parse IMPORTING ir_data TYPE REF TO data i_path TYPE string DEFAULT '$' i_name TYPE string OPTIONAL io_typedescr TYPE REF TO cl_abap_typedescr OPTIONAL . ENDCLASS . *&---------------------------------------------------------------------* *& LCL_JSON_UNIT_PARSER DEFINITION *&---------------------------------------------------------------------* CLASS lcl_json_unit_parser DEFINITION . PUBLIC SECTION . INTERFACES lif_unit_parser . METHODS constructor IMPORTING i_json TYPE string . PRIVATE SECTION . DATA m_json TYPE string . ENDCLASS . *&---------------------------------------------------------------------* *& LCL_XML_UNIT_PARSER DEFINITION *&---------------------------------------------------------------------* CLASS lcl_xml_unit_parser DEFINITION . PUBLIC SECTION . INTERFACES lif_unit_parser . METHODS constructor IMPORTING i_xml TYPE xstring . PRIVATE SECTION . DATA m_xml TYPE xstring . DATA mt_unit TYPE tt_unit . ENDCLASS . *&---------------------------------------------------------------------* *& LCL_UNIT_HELPER DEFINITION *&---------------------------------------------------------------------* CLASS lcl_unit_helper DEFINITION . PUBLIC SECTION . CLASS-METHODS parse_data IMPORTING ir_data TYPE REF TO data RETURNING VALUE ( rt_result ) TYPE tt_unit . CLASS-METHODS parse_json IMPORTING i_json TYPE string RETURNING VALUE ( rt_result ) TYPE tt_unit . CLASS-METHODS parse_xml IMPORTING i_xml TYPE xstring RETURNING VALUE ( rt_result ) TYPE tt_unit . CLASS-METHODS generate_flatdata IMPORTING it_unit TYPE tt_unit i_compact TYPE xfeld OPTIONAL EXPORTING et_flatdt TYPE tt_flatdt RETURNING VALUE ( rr_data ) TYPE REF TO data . ENDCLASS . *&---------------------------------------------------------------------* *& LCL_DATA_UNIT_PARSER IMPLEMENTATION *&---------------------------------------------------------------------* CLASS lcl_data_unit_parser IMPLEMENTATION . *&---------------------------------------------------------------------* *& METHOD CONSTRUCTOR *&---------------------------------------------------------------------* METHOD constructor . mr_data = ir_data . ENDMETHOD . *&---------------------------------------------------------------------* *& METHOD LIF_UNIT_PARSER~PARSE *&---------------------------------------------------------------------* METHOD lif_unit_parser~parse . _parse ( mr_data ). rt_result = mt_unit . ENDMETHOD . *&---------------------------------------------------------------------* *& METHOD _PARSE *&---------------------------------------------------------------------* METHOD _parse . \" \u7b80\u5355\u6765\u8bf4\uff0c\u5c31\u662f\u83b7\u53d6\u6570\u636e\u7684\u6bcf\u4e2a\u5b57\u6bb5\u503c\uff0c\u5e76\u8bb0\u5f55\u5bf9\u5e94\u8def\u5f84 \" \u6570\u636e\u89e3\u6790\u76f8\u5173\u53c2\u6570 DATA lo_typedescr TYPE REF TO cl_abap_typedescr . DATA lo_tabledescr TYPE REF TO cl_abap_tabledescr . DATA lo_structdescr TYPE REF TO cl_abap_structdescr . DATA lt_component TYPE cl_abap_structdescr => component_table . DATA lr_component TYPE REF TO cl_abap_structdescr => component . \" \u52a8\u6001\u53c2\u6570 FIELD-SYMBOLS <fs_table> TYPE STANDARD TABLE . FIELD-SYMBOLS <fs_structure> TYPE any . FIELD-SYMBOLS <fs_field> TYPE any . \" \u52a8\u6001\u5f15\u7528\u53c2\u6570 FIELD-SYMBOLS <fs_ref> TYPE REF TO data . \" \u6570\u636e\u6821\u9a8c CHECK ir_data IS BOUND . IF io_typedescr IS BOUND . lo_typedescr = io_typedescr . ELSE . lo_typedescr = cl_abap_typedescr => describe_by_data_ref ( ir_data ). ENDIF . \" \u8def\u5f84\u5904\u7406 DATA l_pathname TYPE string . IF i_name IS INITIAL . l_pathname = i_path . ELSE . l_pathname = |{ i_path } . { i_name }|. ENDIF . \" \u4e3b\u8981\u5904\u7406\u8868\u3001\u7ed3\u6784\u3001\u6570\u636e\u5143\u7d20\u3001\u5f15\u7528\u56db\u79cd\u7c7b\u578b \" \u7c7b\u548c\u63a5\u53e3\u65e0\u9700\u5904\u7406 CASE lo_typedescr -> kind . WHEN cl_abap_typedescr => kind_table . \" \u8868\u683c\u7c7b\u578b ASSIGN ir_data->* TO <fs_table> . lo_tabledescr ?= lo_typedescr . lo_typedescr = lo_tabledescr -> get_table_line_type ( ). \" \u8868\u884c\u7c7b\u578b DATA l_tabix TYPE sy - tabix . \" \u6240\u5728\u884c IF lo_typedescr -> kind = cl_abap_typedescr => kind_ref . LOOP AT <fs_table> ASSIGNING <fs_ref> . l_tabix = sy - tabix . _parse ( \" \u5f15\u7528\u7c7b\u578b\u76f4\u63a5\u8fed\u4ee3 ir_data = <fs_ref> i_path = |{ l_pathname } [ { l_tabix } ] | ). ENDLOOP . ELSE . \" \u975e\u5f15\u7528\u7c7b\u578b\u7ee7\u7eed\u5206\u6790\u8868\u884c\u7c7b\u578b lo_structdescr ?= lo_typedescr . lt_component = lo_structdescr -> get_components ( ). LOOP AT <fs_table> ASSIGNING <fs_structure> . l_tabix = sy - tabix . LOOP AT lt_component REFERENCE INTO lr_component . ASSIGN COMPONENT lr_component -> name OF STRUCTURE <fs_structure> TO <fs_field> . IF lr_component -> type IS BOUND . _parse ( \" \u5982\u679c\u884c\u7ed3\u6784\u5b57\u6bb5\u4e5f\u662f\u5f15\u7528\u7c7b\u578b\uff0c\u7ee7\u7eed\u8fed\u4ee3 ir_data = REF # ( <fs_field> ) i_path = |{ l_pathname } [ { l_tabix } ] | i_name = lr_component -> name io_typedescr = lr_component -> type ). ELSEIF <fs_field> IS ASSIGNED . INSERT VALUE # ( path = |{ l_pathname } [ { l_tabix } ] | key = lr_component -> name value = <fs_field> ) INTO TABLE mt_unit . ENDIF . ENDLOOP . ENDLOOP . ENDIF . WHEN cl_abap_typedescr => kind_struct . \" \u7ed3\u6784\u7c7b\u578b ASSIGN ir_data->* TO <fs_structure> . lo_structdescr ?= lo_typedescr . lt_component = lo_structdescr -> get_components ( ). LOOP AT lt_component REFERENCE INTO lr_component . IF lr_component -> type IS BOUND . \" \u975e\u6570\u636e\u5143\u7d20\u7c7b\u578b\uff0c\u7ee7\u7eed\u8fed\u4ee3 IF lr_component -> type -> kind = cl_abap_typedescr => kind_ref . \" \u5f15\u7528\u7c7b\u578b\u5904\u7406 ASSIGN COMPONENT lr_component -> name OF STRUCTURE <fs_structure> TO <fs_ref> . _parse ( ir_data = <fs_ref> i_path = l_pathname i_name = lr_component -> name ). ELSE . \" \u975e\u5f15\u7528\u7c7b\u578b\u6570\u636e ASSIGN COMPONENT lr_component -> name OF STRUCTURE <fs_structure> TO <fs_field> . _parse ( ir_data = REF # ( <fs_field> ) i_path = l_pathname i_name = lr_component -> name ). ENDIF . ELSE . ASSIGN COMPONENT lr_component -> name OF STRUCTURE <fs_structure> TO <fs_field> . INSERT VALUE # ( path = l_pathname key = lr_component -> name value = <fs_field> ) INTO TABLE mt_unit . ENDIF . ENDLOOP . WHEN cl_abap_typedescr => kind_elem . \" \u6570\u636e\u5143\u7d20\u7c7b\u578b ASSIGN ir_data->* TO <fs_field> . INSERT VALUE # ( path = i_path key = i_name value = <fs_field> ) INTO TABLE mt_unit . WHEN cl_abap_typedescr => kind_ref . \" \u5f15\u7528\u7c7b\u578b\uff0c\u7ee7\u7eed\u8fed\u4ee3 ASSIGN ir_data->* TO <fs_ref> . _parse ( ir_data = <fs_ref> i_path = i_path i_name = i_name ). ENDCASE . ENDMETHOD . ENDCLASS . *&---------------------------------------------------------------------* *& LCL_JSON_UNIT_PARSER IMPLEMENTATION *&---------------------------------------------------------------------* CLASS lcl_json_unit_parser IMPLEMENTATION . *&---------------------------------------------------------------------* *& METHOD CONSTRUCTOR *&---------------------------------------------------------------------* METHOD constructor . m_json = i_json . ENDMETHOD . *&---------------------------------------------------------------------* *& METHOD LIF_UNIT_PARSER~PARSE *&---------------------------------------------------------------------* METHOD lif_unit_parser~parse . DATA lo_parser TYPE REF TO lif_unit_parser . lo_parser ?= NEW lcl_data_unit_parser ( / ui2 / cl_json => generate ( m_json ) ). rt_result = lo_parser -> parse ( ). ENDMETHOD . ENDCLASS . *&---------------------------------------------------------------------* *& LCL_XML_UNIT_PARSER IMPLEMENTATION *&---------------------------------------------------------------------* CLASS lcl_xml_unit_parser IMPLEMENTATION . *&---------------------------------------------------------------------* *& METHOD CONSTRUCTOR *&---------------------------------------------------------------------* METHOD constructor . m_xml = i_xml . ENDMETHOD . *&---------------------------------------------------------------------* *& METHOD LIF_UNIT_PARSER~PARSE *&---------------------------------------------------------------------* METHOD lif_unit_parser~parse . DATA lt_path TYPE STANDARD TABLE OF string . DATA l_name TYPE string . DATA ( lo_reader ) = cl_sxml_string_reader => create ( m_xml ). DATA ( lo_node ) = lo_reader -> read_next_node ( ). WHILE lo_reader -> node_type <> if_sxml_node => co_nt_final . CASE lo_reader -> node_type . WHEN if_sxml_node => co_nt_element_open . IF l_name IS NOT INITIAL . INSERT l_name INTO TABLE lt_path . ENDIF . l_name = CAST if_sxml_open_element ( lo_node ) -> qname - name . WHEN if_sxml_node => co_nt_element_close . CLEAR l_name . IF lt_path IS NOT INITIAL . DATA ( l_tabix ) = lines ( lt_path ). l_name = lt_path [ l_tabix ]. DELETE lt_path INDEX l_tabix . ENDIF . WHEN if_sxml_node => co_nt_value . DATA ls_unit TYPE ty_unit . CLEAR ls_unit . CONCATENATE LINES OF lt_path INTO ls_unit - path SEPARATED BY '.' . ls_unit - key = l_name . ls_unit - value = CAST if_sxml_value ( lo_node ) -> get_value ( ). INSERT ls_unit INTO TABLE mt_unit . ENDCASE . lo_node = lo_reader -> read_next_node ( ). ENDWHILE . rt_result = mt_unit . ENDMETHOD . ENDCLASS . *&---------------------------------------------------------------------* *& LCL_UNIT_HELPER IMPLEMENTATION *&---------------------------------------------------------------------* CLASS lcl_unit_helper IMPLEMENTATION . *&---------------------------------------------------------------------* *& METHOD PARSE_DATA *&---------------------------------------------------------------------* METHOD parse_data . DATA lo_parser TYPE REF TO lif_unit_parser . lo_parser ?= NEW lcl_data_unit_parser ( ir_data ). rt_result = lo_parser -> parse ( ). ENDMETHOD . *&---------------------------------------------------------------------* *& METHOD PARSE_JSON *&---------------------------------------------------------------------* METHOD parse_json . DATA lo_parser TYPE REF TO lif_unit_parser . lo_parser ?= NEW lcl_json_unit_parser ( i_json ). rt_result = lo_parser -> parse ( ). ENDMETHOD . *&---------------------------------------------------------------------* *& METHOD PARSE_XML *&---------------------------------------------------------------------* METHOD parse_xml . DATA lo_parser TYPE REF TO lif_unit_parser . lo_parser ?= NEW lcl_xml_unit_parser ( i_xml ). rt_result = lo_parser -> parse ( ). ENDMETHOD . *&---------------------------------------------------------------------* *& METHOD GENERATE_FLATDATA *& \u5c06\u5c42\u7ea7\u6570\u636e\u5206\u6790\u5e76\u751f\u6210\u5e73\u9762\u6570\u636e *&---------------------------------------------------------------------* METHOD generate_flatdata . CHECK it_unit IS NOT INITIAL . \" \u63d0\u53d6\u7ed3\u6784 DATA lt_flatdt TYPE tt_flatdt . DATA ls_flatdt TYPE ty_flatdt . DATA lt_unitex TYPE tt_unitex . DATA ls_unitex TYPE ty_unitex . LOOP AT it_unit REFERENCE INTO DATA ( lr_unit ). CLEAR ls_flatdt . ls_flatdt - struct = lr_unit -> path . ls_flatdt - field = lr_unit -> key . REPLACE ALL OCCURRENCES OF REGEX '\\[[0-9]*\\]' IN ls_flatdt - struct WITH '' . \" \u53bb\u9664\u8868\u683c\u7d22\u5f15 INSERT ls_flatdt INTO TABLE lt_flatdt . CLEAR ls_unitex . ls_unitex - struct = ls_flatdt - struct . ls_unitex - path = lr_unit -> path . ls_unitex - key = lr_unit -> key . ls_unitex - value = lr_unit -> value . INSERT ls_unitex INTO TABLE lt_unitex . ENDLOOP . SORT lt_flatdt BY struct field . DELETE ADJACENT DUPLICATES FROM lt_flatdt COMPARING struct field . \" \u8ba1\u7b97\u6bcf\u7ec4\u7ed3\u6784\u6700\u5927\u5b57\u6bb5\u6570\uff0c\u5e76\u8bbe\u5b9a\u5b57\u6bb5\u6240\u5728\u4f4d\u7f6e DATA l_count TYPE i . DATA l_count_max TYPE i . LOOP AT lt_flatdt REFERENCE INTO DATA ( lr_flatdt ). l_count = l_count + 1 . lr_flatdt -> position = l_count . AT END OF struct . IF l_count_max < l_count . l_count_max = l_count . ENDIF . CLEAR l_count . ENDAT . ENDLOOP . \" \u52a8\u6001\u6570\u636e\u53c2\u6570 DATA lo_tabledescr TYPE REF TO cl_abap_tabledescr . DATA lo_structdescr TYPE REF TO cl_abap_structdescr . DATA lt_component TYPE cl_abap_structdescr => component_table . DATA ls_component TYPE cl_abap_structdescr => component . FIELD-SYMBOLS <fs_table> TYPE STANDARD TABLE . FIELD-SYMBOLS <fs_structure> TYPE any . FIELD-SYMBOLS <fs_field> TYPE any . FIELD-SYMBOLS <fs_fldk> TYPE any . \" \u7528\u4e8e\u67d3\u8272 CLEAR ls_component . ls_component - name = gs_fieldname - fdlk . ls_component - type = cl_abap_elemdescr => get_string ( ). INSERT ls_component INTO TABLE lt_component . CLEAR ls_component . ls_component - name = gs_fieldname - path . ls_component - type = cl_abap_elemdescr => get_string ( ). INSERT ls_component INTO TABLE lt_component . DATA l_index TYPE i . DO l_count_max TIMES . l_index = l_index + 1 . CLEAR ls_component . ls_component - name = |{ gs_fieldname - field }{ l_index }|. ls_component - type = cl_abap_elemdescr => get_string ( ). \" \u90fd\u521b\u5efa\u4e3aSTRING\u5373\u53ef INSERT ls_component INTO TABLE lt_component . ENDDO . lo_structdescr = cl_abap_structdescr => create ( lt_component ). lo_tabledescr = cl_abap_tabledescr => create ( lo_structdescr ). CREATE DATA rr_data TYPE HANDLE lo_tabledescr . ASSIGN rr_data->* TO <fs_table> . \" \u7d27\u51d1\u8868\u793a\u4e0e\u5426 IF i_compact = abap_true . \" \u7d27\u51d1\u8868\u793a\u6309\u7ed3\u6784\u8fdb\u884c\u5c55\u793a SORT lt_unitex BY struct path key . ELSE . \" \u975e\u7d27\u51d1\u8868\u793a\u6309\u6570\u636e\u987a\u5e8f\u8fdb\u884c\u5c55\u793a SORT lt_unitex BY path key . ENDIF . LOOP AT lt_unitex REFERENCE INTO DATA ( lr_unitex ). AT NEW struct . \" \u65b0\u7684\u7ed3\u6784 INSERT INITIAL LINE INTO TABLE <fs_table> ASSIGNING <fs_structure> . UNASSIGN <fs_fldk> . ASSIGN COMPONENT gs_fieldname - fdlk OF STRUCTURE <fs_structure> TO <fs_fldk> . IF <fs_fldk> IS ASSIGNED . <fs_fldk> = gs_fdlk - header . ENDIF . UNASSIGN <fs_field> . ASSIGN COMPONENT gs_fieldname - path OF STRUCTURE <fs_structure> TO <fs_field> . IF <fs_field> IS ASSIGNED . <fs_field> = lr_unitex -> struct . ENDIF . READ TABLE lt_flatdt TRANSPORTING NO FIELDS WITH KEY struct = lr_unitex -> struct BINARY SEARCH . IF sy - subrc = 0 . LOOP AT lt_flatdt REFERENCE INTO lr_flatdt FROM sy - tabix . IF lr_flatdt -> struct <> lr_unitex -> struct . EXIT . ENDIF . UNASSIGN <fs_field> . ASSIGN COMPONENT |{ gs_fieldname - field }{ lr_flatdt -> position }| OF STRUCTURE <fs_structure> TO <fs_field> . IF <fs_field> IS ASSIGNED . <fs_field> = lr_flatdt -> field . ENDIF . ENDLOOP . ENDIF . ENDAT . AT NEW path . \" \u65b0\u7684\u6570\u636e\u884c INSERT INITIAL LINE INTO TABLE <fs_table> ASSIGNING <fs_structure> . UNASSIGN <fs_fldk> . ASSIGN COMPONENT gs_fieldname - fdlk OF STRUCTURE <fs_structure> TO <fs_fldk> . IF <fs_fldk> IS ASSIGNED . <fs_fldk> = gs_fdlk - data . ENDIF . ASSIGN COMPONENT gs_fieldname - path OF STRUCTURE <fs_structure> TO <fs_field> . IF <fs_field> IS ASSIGNED . <fs_field> = lr_unitex -> path . ENDIF . CLEAR l_index . ENDAT . \" \u586b\u5145\u6570\u636e READ TABLE lt_flatdt REFERENCE INTO lr_flatdt WITH KEY struct = lr_unitex -> struct field = lr_unitex -> key BINARY SEARCH . IF sy - subrc = 0 . UNASSIGN <fs_field> . ASSIGN COMPONENT |{ gs_fieldname - field }{ lr_flatdt -> position }| OF STRUCTURE <fs_structure> TO <fs_field> . IF <fs_field> IS ASSIGNED . <fs_field> = lr_unitex -> value . ENDIF . ENDIF . ENDLOOP . IF et_flatdt IS SUPPLIED . et_flatdt = lt_flatdt . ENDIF . ENDMETHOD . ENDCLASS . *&---------------------------------------------------------------------* *& LIF_ALV *&---------------------------------------------------------------------* INTERFACE lif_alv . METHODS pai . METHODS pbo . METHODS get_selected_uuid EXPORTING et_uuid TYPE tt_uuid et_uuid_opt TYPE tt_uuid_opt . \" \u83b7\u53d6\u9009\u62e9\u884c\u7684\u65e5\u5fd7ID ENDINTERFACE . *&---------------------------------------------------------------------* *& LCL_ALV_LOGH *&---------------------------------------------------------------------* CLASS lcl_alv_logh DEFINITION . PUBLIC SECTION . INTERFACES lif_alv . DATA ms_layout TYPE lvc_s_layo . DATA mt_fieldcat TYPE lvc_t_fcat . DATA mt_sort TYPE lvc_t_sort . METHODS set_layout . CLASS-METHODS set_fieldcat CHANGING ct_fieldcat TYPE lvc_t_fcat . METHODS set_sort . METHODS set_event . METHODS set_color . METHODS on_double_click FOR EVENT double_click OF cl_gui_alv_grid IMPORTING e_row e_column es_row_no . CLASS-METHODS display_rawdata IMPORTING i_uuid TYPE ty_log_rawdata - uuid i_zitem TYPE ty_log_rawdata - zitem . CLASS-METHODS nav_se37 IMPORTING i_funcname TYPE ty_log_head - func_name . ENDCLASS . *&---------------------------------------------------------------------* *& LCL_ALV_UNIT *&---------------------------------------------------------------------* CLASS lcl_alv_logh IMPLEMENTATION . *&---------------------------------------------------------------------* *& LIF_ALV~PBO *&---------------------------------------------------------------------* METHOD lif_alv~pbo . IF go_container IS NOT BOUND . go_container = NEW cl_gui_custom_container ( 'CON_9000' ). ENDIF . IF go_grid IS NOT BOUND . go_grid = NEW cl_gui_alv_grid ( go_container ). set_layout ( ). set_fieldcat ( CHANGING ct_fieldcat = mt_fieldcat ). set_sort ( ). set_event ( ). set_color ( ). DATA ls_variant TYPE disvariant . ls_variant = VALUE # ( report = sy - repid handle = 1 ). CALL METHOD go_grid -> set_table_for_first_display EXPORTING is_layout = ms_layout is_variant = ls_variant i_save = 'X' CHANGING it_outtab = gt_log it_fieldcatalog = mt_fieldcat it_sort = mt_sort EXCEPTIONS invalid_parameter_combination = 1 program_error = 2 too_many_lines = 3 OTHERS = 4 . ELSE . CALL METHOD go_grid -> refresh_table_display EXPORTING is_stable = CONV # ( 'XX' ) i_soft_refresh = abap_true EXCEPTIONS finished = 1 OTHERS = 2 . ENDIF . ENDMETHOD . *&---------------------------------------------------------------------* *& LIF_ALV~PAI *&---------------------------------------------------------------------* METHOD lif_alv~pai . ENDMETHOD . *&---------------------------------------------------------------------* *& SET_LAYOUT *&---------------------------------------------------------------------* METHOD set_layout . CLEAR ms_layout . ms_layout - zebra = abap_true . \" \u6591\u9a6c\u7ebf ms_layout - cwidth_opt = abap_true . \" \u81ea\u52a8\u8c03\u6574ALVL\u5217\u5bbd ms_layout - sel_mode = 'A' . \" \u9009\u62e9\u6a21\u5f0f ms_layout - ctab_fname = 'T_SCOL' . \" \u5355\u5143\u683c\u989c\u8272\u8bbe\u7f6e * MS_LAYOUT-STYLEFNAME = 'T_STYL'. \" \u5355\u5143\u683c\u63a7\u5236 ENDMETHOD . *&---------------------------------------------------------------------* *& SET_FIELDCAT *&---------------------------------------------------------------------* METHOD set_fieldcat . DATA ls_fieldcat TYPE lvc_s_fcat . DEFINE _init_fieldcat . CLEAR ls_fieldcat . ls_fieldcat - fieldname = &1 . ls_fieldcat - tooltip = ls_fieldcat - coltext = ls_fieldcat - seltext = ls_fieldcat - scrtext_l = ls_fieldcat - scrtext_m = ls_fieldcat - scrtext_s = &2 . ls_fieldcat - ref_table = &3 . ls_fieldcat - ref_field = &4 . INSERT ls_fieldcat INTO TABLE ct_fieldcat . END-OF-DEFINITION . _init_fieldcat 'UUID ' '\u65e5\u5fd7ID' '' '' . * _INIT_FIELDCAT 'ZITEM ' '\u5e8f\u53f7' '' ''. _init_fieldcat 'LOG_KIND ' '\u65e5\u5fd7\u5206\u7c7b' '' '' . _init_fieldcat 'INTF_ID ' '\u63a5\u53e3\u6807\u8bc6' '' '' . _init_fieldcat 'FUNC_NAME' '\u51fd\u6570\u540d' '' '' . _init_fieldcat 'FUNC_TEXT' '\u51fd\u6570\u63cf\u8ff0' '' '' . * _INIT_FIELDCAT 'ZTEXT ' '\u9644\u52a0\u4fe1\u606f' '' ''. \" \u8be5\u9879\u76ee\u6ca1\u6709 _init_fieldcat 'IO_FLAG ' '\u63a5\u53e3\u65b9\u5411' '' '' . _init_fieldcat 'ZSENDER ' '\u53d1\u9001\u65b9' '' '' . _init_fieldcat 'ZRECEIVER' '\u63a5\u6536\u65b9' '' '' . _init_fieldcat 'ZDATE ' '\u65e5\u671f' '' '' . _init_fieldcat 'ZTIME ' '\u65f6\u95f4' '' '' . _init_fieldcat 'ZUSER ' '\u7528\u6237' '' '' . _init_fieldcat 'MTYPE ' '\u72b6\u6001' '' '' . * _INIT_FIELDCAT 'MSG ' '\u6d88\u606f\u6587\u672c' '' ''. \" \u8be5\u9879\u76ee\u6ca1\u6709 _init_fieldcat 'ZCONUT ' '\u6761\u76ee\u7edf\u8ba1' '' '' . _init_fieldcat 'ZRAW_ICON' '\u539f\u59cb\u6570\u636e' '' '' . ENDMETHOD . *&---------------------------------------------------------------------* *& SET_SORT *&---------------------------------------------------------------------* METHOD set_sort . DATA ls_sort TYPE lvc_s_sort . DATA l_spos TYPE lvc_s_sort - spos . CLEAR ls_sort . l_spos = l_spos + 1 . ls_sort - spos = l_spos . ls_sort - fieldname = 'ZDATE' . ls_sort - down = abap_true . INSERT ls_sort INTO TABLE mt_sort . CLEAR ls_sort . l_spos = l_spos + 1 . ls_sort - spos = l_spos . ls_sort - fieldname = 'ZTIME' . ls_sort - down = abap_true . INSERT ls_sort INTO TABLE mt_sort . CLEAR ls_sort . l_spos = l_spos + 1 . ls_sort - spos = l_spos . ls_sort - fieldname = 'UUID' . ls_sort - up = abap_true . INSERT ls_sort INTO TABLE mt_sort . CLEAR ls_sort . l_spos = l_spos + 1 . ls_sort - spos = l_spos . ls_sort - fieldname = 'IO_FLAG' . ls_sort - up = abap_true . INSERT ls_sort INTO TABLE mt_sort . ENDMETHOD . *&---------------------------------------------------------------------* *& SET_EVENT *&---------------------------------------------------------------------* METHOD set_event . SET HANDLER on_double_click FOR go_grid . ENDMETHOD . *&---------------------------------------------------------------------* *& SET_COLOR *&---------------------------------------------------------------------* METHOD set_color . DATA ls_scol TYPE lvc_s_scol . LOOP AT gt_log REFERENCE INTO DATA ( lr_log ). CLEAR lr_log -> t_scol . IF lr_log -> mtype = 'S' . lr_log -> t_scol = VALUE # ( BASE lr_log -> t_scol color = gs_color - green ( fname = 'MTYPE' ) ( fname = 'MSG' ) ). ELSE . lr_log -> t_scol = VALUE # ( BASE lr_log -> t_scol color = gs_color - red ( fname = 'MTYPE' ) ( fname = 'MSG' ) ). ENDIF . ENDLOOP . ENDMETHOD . *&---------------------------------------------------------------------* *& ON_DOUBLE_CLICK *&---------------------------------------------------------------------* METHOD on_double_click . READ TABLE gt_log REFERENCE INTO DATA ( lr_log ) INDEX e_row - index . CHECK sy - subrc = 0 . CASE e_column . WHEN 'UUID' . DATA lt_uuid_opt LIKE RANGE OF gs_selection - uuid . lt_uuid_opt = VALUE # ( sign = 'I' option = 'EQ' ( low = lr_log -> uuid ) ). SUBMIT ( sy - repid ) WITH s_uuid IN lt_uuid_opt \" \u63a5\u53e3ID WITH s_date IN s_date \" \u65e5\u671f\u4f1a\u9ed8\u8ba4\u5f53\u5929\uff0c\u624b\u5de5\u4f20\u503c WITH s_time IN s_time \" \u65e5\u671f\u4f1a\u9ed8\u8ba4\u5f53\u5929\uff0c\u624b\u5de5\u4f20\u503c WITH p_logh = '' WITH p_unit = '' WITH p_flat = 'X' AND RETURN . WHEN 'ZRAW_ICON' . display_rawdata ( i_uuid = lr_log -> uuid i_zitem = lr_log -> zitem ). WHEN 'FUNC_NAME' . nav_se37 ( lr_log -> func_name ). ENDCASE . ENDMETHOD . *&---------------------------------------------------------------------* *& DISPLAY_RAWDATA *&---------------------------------------------------------------------* METHOD display_rawdata . DATA l_html TYPE xstring . READ TABLE gt_log_rawdata REFERENCE INTO DATA ( lr_log_rawdata ) WITH KEY uuid = i_uuid zitem = i_zitem BINARY SEARCH . IF sy - subrc = 0 . CASE lr_log_rawdata -> zformat . WHEN 'JSON' . \" cl_demo_output=>display_json( lr_log_rawdata->zraw ). CALL TRANSFORMATION sjson2html SOURCE XML lr_log_rawdata -> zraw RESULT XML l_html . cl_abap_browser => show_html ( html_string = cl_abap_codepage => convert_from ( l_html ) ). WHEN 'XML' . * cl_demo_output=>display_xml( lr_log_rawdata->zrawx ). cl_abap_browser => show_xml ( xml_xstring = lr_log_rawdata -> zrawx ). WHEN OTHERS . cl_demo_output => display ( lr_log_rawdata -> zraw ). ENDCASE . ENDIF . ENDMETHOD . *&---------------------------------------------------------------------* *& NAV_SE37 *&---------------------------------------------------------------------* METHOD nav_se37 . DATA ls_tfdir TYPE tfdir . \" \u83b7\u53d6\u51fd\u6570\u5bf9\u5e94\u7a0b\u5e8f SELECT SINGLE pname include INTO CORRESPONDING FIELDS OF ls_tfdir FROM tfdir WHERE funcname = i_funcname . \" \u8bbe\u7f6e\u51fd\u6570\u5168\u5c40\u4fe1\u606f DATA ls_rs38l TYPE rs38l . CALL FUNCTION 'FUNCTION_INCLUDE_SPLIT' EXPORTING program = ls_tfdir - pname IMPORTING group = ls_rs38l - area namespace = ls_rs38l - namespace EXCEPTIONS include_not_exists = 1 group_not_exists = 2 no_selections = 3 no_function_include = 4 no_function_pool = 5 delimiter_wrong_position = 6 no_customer_function_group = 7 no_customer_function_include = 8 reserved_name_customer = 9 namespace_too_long = 10 area_length_error = 11 OTHERS = 12 . CONCATENATE 'L' ls_rs38l - area 'U' ls_tfdir - include INTO ls_tfdir - pname . CALL FUNCTION 'EDITOR_PROGRAM' EXPORTING display = 'X' program = ls_tfdir - pname EXCEPTIONS OTHERS = 1 . ENDMETHOD . *&---------------------------------------------------------------------* *& LIF_ALV~GET_SELECTED_UUID *&---------------------------------------------------------------------* METHOD lif_alv~get_selected_uuid . \" \u83b7\u53d6ALV\u9009\u53d6\u884c DATA lt_rows TYPE lvc_t_row . CALL METHOD go_grid -> get_selected_rows IMPORTING et_index_rows = lt_rows . LOOP AT lt_rows INTO DATA ( ls_row ). READ TABLE gt_log REFERENCE INTO DATA ( lr_log ) INDEX ls_row - index . CHECK sy - subrc = 0 . IF et_uuid IS SUPPLIED . APPEND lr_log -> uuid TO et_uuid . ENDIF . IF et_uuid_opt IS SUPPLIED . INSERT VALUE # ( sign = 'I' option = 'EQ' low = lr_log -> uuid ) INTO TABLE et_uuid_opt . ENDIF . ENDLOOP . SORT et_uuid BY table_line . DELETE ADJACENT DUPLICATES FROM et_uuid COMPARING table_line . DELETE et_uuid WHERE table_line IS INITIAL . SORT et_uuid_opt BY low . DELETE ADJACENT DUPLICATES FROM et_uuid_opt COMPARING low . DELETE et_uuid_opt WHERE low IS INITIAL . ENDMETHOD . ENDCLASS . *&---------------------------------------------------------------------* *& LCL_ALV_UNIT *&---------------------------------------------------------------------* CLASS lcl_alv_unit DEFINITION . PUBLIC SECTION . INTERFACES lif_alv . TYPES : BEGIN OF ty_data . INCLUDE TYPE ty_log_head . INCLUDE TYPE ty_unit . TYPES : END OF ty_data . DATA mt_data TYPE STANDARD TABLE OF ty_data WITH EMPTY KEY . DATA ms_layout TYPE lvc_s_layo . DATA mt_fieldcat TYPE STANDARD TABLE OF lvc_s_fcat . METHODS constructor . METHODS process_data . METHODS set_layout . METHODS set_fieldcat . METHODS set_event . METHODS set_color . METHODS on_double_click FOR EVENT double_click OF cl_gui_alv_grid IMPORTING e_row e_column es_row_no . ENDCLASS . *&---------------------------------------------------------------------* *& LCL_ALV_UNIT *&---------------------------------------------------------------------* CLASS lcl_alv_unit IMPLEMENTATION . *&---------------------------------------------------------------------* *& CONSTRUCTOR *&---------------------------------------------------------------------* METHOD constructor . process_data ( ). ENDMETHOD . *&---------------------------------------------------------------------* *& PROCESS_DATA *&---------------------------------------------------------------------* METHOD process_data . DATA ls_data TYPE ty_data . DATA ( lo_progress ) = NEW lcl_progress ( ). lo_progress -> m_name = '\u8f6c\u5316\u5355\u5143\u6570\u636e' . lo_progress -> start ( lines ( gt_log ) ). LOOP AT gt_log REFERENCE INTO DATA ( lr_log ). lo_progress -> next ( ). CLEAR ls_data . ls_data = CORRESPONDING # ( lr_log->* ). LOOP AT lr_log -> t_unit REFERENCE INTO DATA ( lr_unit ). DATA ( ls_data_tmp ) = ls_data . ls_data_tmp - path = lr_unit -> path . ls_data_tmp - key = lr_unit -> key . ls_data_tmp - value = lr_unit -> value . INSERT ls_data_tmp INTO TABLE mt_data . ENDLOOP . ENDLOOP . lo_progress -> finish ( ). ENDMETHOD . *&---------------------------------------------------------------------* *& LIF_ALV~PBO *&---------------------------------------------------------------------* METHOD lif_alv~pbo . IF go_container IS NOT BOUND . go_container = NEW cl_gui_custom_container ( 'CON_9000' ). ENDIF . IF go_grid IS NOT BOUND . go_grid = NEW cl_gui_alv_grid ( go_container ). set_layout ( ). set_fieldcat ( ). set_event ( ). set_color ( ). DATA ls_variant TYPE disvariant . ls_variant = VALUE # ( report = sy - repid handle = 2 ). CALL METHOD go_grid -> set_table_for_first_display EXPORTING is_layout = ms_layout is_variant = ls_variant i_save = 'X' CHANGING it_outtab = mt_data it_fieldcatalog = mt_fieldcat EXCEPTIONS invalid_parameter_combination = 1 program_error = 2 too_many_lines = 3 OTHERS = 4 . ELSE . CALL METHOD go_grid -> refresh_table_display EXPORTING is_stable = CONV # ( 'XX' ) i_soft_refresh = abap_true EXCEPTIONS finished = 1 OTHERS = 2 . ENDIF . ENDMETHOD . *&---------------------------------------------------------------------* *& LIF_ALV~PAI *&---------------------------------------------------------------------* METHOD lif_alv~pai . ENDMETHOD . *&---------------------------------------------------------------------* *& SET_LAYOUT *&---------------------------------------------------------------------* METHOD set_layout . CLEAR ms_layout . ms_layout - zebra = abap_true . \" \u6591\u9a6c\u7ebf ms_layout - cwidth_opt = abap_true . \" \u81ea\u52a8\u8c03\u6574ALVL\u5217\u5bbd ms_layout - sel_mode = 'A' . \" \u9009\u62e9\u6a21\u5f0f * MS_LAYOUT-CTAB_FNAME = 'T_SCOL'. \" \u5355\u5143\u683c\u989c\u8272\u8bbe\u7f6e * MS_LAYOUT-STYLEFNAME = 'T_STYL'. \" \u5355\u5143\u683c\u63a7\u5236 ENDMETHOD . *&---------------------------------------------------------------------* *& SET_FIELDCAT *&---------------------------------------------------------------------* METHOD set_fieldcat . DATA ls_fieldcat TYPE lvc_s_fcat . DEFINE _init_fieldcat . CLEAR ls_fieldcat . ls_fieldcat - fieldname = &1 . ls_fieldcat - tooltip = ls_fieldcat - coltext = ls_fieldcat - seltext = ls_fieldcat - scrtext_l = ls_fieldcat - scrtext_m = ls_fieldcat - scrtext_s = &2 . ls_fieldcat - ref_table = &3 . ls_fieldcat - ref_field = &4 . INSERT ls_fieldcat INTO TABLE mt_fieldcat . END-OF-DEFINITION . lcl_alv_logh => set_fieldcat ( CHANGING ct_fieldcat = mt_fieldcat ). _init_fieldcat 'PATH' '\u8def\u5f84' '' '' . _init_fieldcat 'KEY' '\u5b57\u6bb5\u540d' '' '' . _init_fieldcat 'VALUE' '\u5b57\u6bb5\u503c' '' '' . ENDMETHOD . *&---------------------------------------------------------------------* *& SET_EVENT *&---------------------------------------------------------------------* METHOD set_event . SET HANDLER on_double_click FOR go_grid . ENDMETHOD . *&---------------------------------------------------------------------* *& SET_COLOR *&---------------------------------------------------------------------* METHOD set_color . DATA ls_scol TYPE lvc_s_scol . LOOP AT mt_data REFERENCE INTO DATA ( lr_data ). CLEAR lr_data -> t_scol . IF lr_data -> mtype = 'S' . lr_data -> t_scol = VALUE # ( BASE lr_data -> t_scol color = gs_color - green ( fname = 'MTYPE' ) ( fname = 'MSG' ) ). ELSE . lr_data -> t_scol = VALUE # ( BASE lr_data -> t_scol color = gs_color - red ( fname = 'MTYPE' ) ( fname = 'MSG' ) ). ENDIF . ENDLOOP . ENDMETHOD . *&---------------------------------------------------------------------* *& ON_DOUBLE_CLICK *&---------------------------------------------------------------------* METHOD on_double_click . READ TABLE mt_data REFERENCE INTO DATA ( lr_data ) INDEX e_row - index . CHECK sy - subrc = 0 . CASE e_column . WHEN 'ZRAW_ICON' . lcl_alv_logh => display_rawdata ( i_uuid = lr_data -> uuid i_zitem = lr_data -> zitem ). WHEN 'FUNC_NAME' . lcl_alv_logh => nav_se37 ( lr_data -> func_name ). ENDCASE . ENDMETHOD . *&---------------------------------------------------------------------* *& LIF_ALV~GET_SELECTED_UUID *&---------------------------------------------------------------------* METHOD lif_alv~get_selected_uuid . \" \u83b7\u53d6ALV\u9009\u53d6\u884c DATA lt_rows TYPE lvc_t_row . CALL METHOD go_grid -> get_selected_rows IMPORTING et_index_rows = lt_rows . LOOP AT lt_rows INTO DATA ( ls_row ). READ TABLE mt_data REFERENCE INTO DATA ( lr_unit ) INDEX ls_row - index . CHECK sy - subrc = 0 . IF et_uuid IS SUPPLIED . APPEND lr_unit -> uuid TO et_uuid . ENDIF . IF et_uuid_opt IS SUPPLIED . INSERT VALUE # ( sign = 'I' option = 'EQ' low = lr_unit -> uuid ) INTO TABLE et_uuid_opt . ENDIF . ENDLOOP . SORT et_uuid BY table_line . DELETE ADJACENT DUPLICATES FROM et_uuid COMPARING table_line . DELETE et_uuid WHERE table_line IS INITIAL . SORT et_uuid_opt BY low . DELETE ADJACENT DUPLICATES FROM et_uuid_opt COMPARING low . DELETE et_uuid_opt WHERE low IS INITIAL . ENDMETHOD . ENDCLASS . *&---------------------------------------------------------------------* *& LCL_ALV_FLAT *&---------------------------------------------------------------------* CLASS lcl_alv_flat DEFINITION . PUBLIC SECTION . INTERFACES lif_alv . DATA mt_component_flat TYPE cl_abap_structdescr => component_table . DATA mr_data TYPE REF TO data . DATA ms_layout TYPE lvc_s_layo . DATA mt_fieldcat TYPE STANDARD TABLE OF lvc_s_fcat . METHODS constructor . METHODS process_data . METHODS set_layout . METHODS set_fieldcat . METHODS set_event . METHODS set_color . METHODS on_double_click FOR EVENT double_click OF cl_gui_alv_grid IMPORTING e_row e_column es_row_no . ENDCLASS . *&---------------------------------------------------------------------* *& LCL_ALV_FLAT *&---------------------------------------------------------------------* CLASS lcl_alv_flat IMPLEMENTATION . *&---------------------------------------------------------------------* *& CONSTRUCTOR *&---------------------------------------------------------------------* METHOD constructor . process_data ( ). ENDMETHOD . *&---------------------------------------------------------------------* *& PROCESS_DATA *&---------------------------------------------------------------------* METHOD process_data . \" \u8ba1\u7b97\u6700\u5927\u5b57\u6bb5\u6570\u91cf DATA l_count_max TYPE i . LOOP AT gt_log REFERENCE INTO DATA ( lr_log ). LOOP AT lr_log -> t_flatdt REFERENCE INTO DATA ( lr_flatdt ). IF l_count_max < lr_flatdt -> position . l_count_max = lr_flatdt -> position . ENDIF . ENDLOOP . ENDLOOP . \" \u62ac\u5934\u90e8\u5206\u56fa\u5b9a DATA lo_tabledescr TYPE REF TO cl_abap_tabledescr . DATA lo_structdescr TYPE REF TO cl_abap_structdescr . DATA lt_component TYPE cl_abap_structdescr => component_table . DATA ls_component TYPE cl_abap_structdescr => component . lo_structdescr ?= cl_abap_typedescr => describe_by_data ( VALUE ty_log_head ( ) ). lt_component = lo_structdescr -> get_components ( ). \" \u6241\u5e73\u90e8\u5206 CLEAR ls_component . ls_component - name = gs_fieldname - fdlk . ls_component - type = cl_abap_elemdescr => get_string ( ). INSERT ls_component INTO TABLE mt_component_flat . CLEAR ls_component . ls_component - name = gs_fieldname - path . ls_component - type = cl_abap_elemdescr => get_string ( ). INSERT ls_component INTO TABLE mt_component_flat . DATA l_index TYPE i . DO l_count_max TIMES . l_index = l_index + 1 . CLEAR ls_component . ls_component - name = |{ gs_fieldname - field }{ l_index }|. ls_component - type = cl_abap_elemdescr => get_string ( ). \" \u90fd\u521b\u5efa\u4e3aSTRING\u5373\u53ef INSERT ls_component INTO TABLE mt_component_flat . ENDDO . INSERT LINES OF mt_component_flat INTO TABLE lt_component . \" \u521b\u5efa\u62a5\u8868\u5c55\u793a\u7ed3\u6784 lo_structdescr = cl_abap_structdescr => create ( lt_component ). lo_tabledescr = cl_abap_tabledescr => create ( lo_structdescr ). CREATE DATA mr_data TYPE HANDLE lo_tabledescr . FIELD-SYMBOLS <fs_table> TYPE STANDARD TABLE . FIELD-SYMBOLS <fs_structure> TYPE any . FIELD-SYMBOLS <fs_field> TYPE any . ASSIGN mr_data->* TO <fs_table> . DATA ( lo_progress ) = NEW lcl_progress ( ). lo_progress -> m_name = '\u8f6c\u5316\u6241\u5e73\u7ed3\u6784' . lo_progress -> start ( lines ( gt_log ) ). LOOP AT gt_log REFERENCE INTO lr_log . lo_progress -> next ( ). IF <fs_table> IS NOT INITIAL . DO p_ctl5 TIMES . \" \u95f4\u9694\u884c\uff0c\u4e0d\u7136\u592a\u7d27\u51d1\u4e0d\u597d\u770b\u6570\u636e INSERT INITIAL LINE INTO TABLE <fs_table> . ENDDO . ENDIF . IF lr_log -> r_flatdata IS NOT BOUND . INSERT INITIAL LINE INTO TABLE <fs_table> ASSIGNING <fs_structure> . <fs_structure> = CORRESPONDING # ( lr_log->* ). \" \u65e5\u5fd7\u62ac\u5934\u90e8\u5206 CONTINUE . ENDIF . FIELD-SYMBOLS <fs_flatdata_table> TYPE STANDARD TABLE . FIELD-SYMBOLS <fs_flatdata_structure> TYPE any . FIELD-SYMBOLS <fs_flatdata_field> TYPE any . UNASSIGN <fs_flatdata_table> . UNASSIGN <fs_flatdata_structure> . ASSIGN lr_log -> r_flatdata->* TO <fs_flatdata_table> . LOOP AT <fs_flatdata_table> ASSIGNING <fs_flatdata_structure> . IF p_ctl2 <> abap_true . \" \u5c55\u793a\u62ac\u5934 ASSIGN COMPONENT gs_fieldname - fdlk OF STRUCTURE <fs_flatdata_structure> TO FIELD - SYMBOL ( <fs_fdlk> ). IF <fs_fdlk> IS ASSIGNED . CHECK <fs_fdlk> <> gs_fdlk - header . ENDIF . ENDIF . INSERT INITIAL LINE INTO TABLE <fs_table> ASSIGNING <fs_structure> . <fs_structure> = CORRESPONDING # ( lr_log->* ). \" \u65e5\u5fd7\u62ac\u5934\u90e8\u5206 LOOP AT mt_component_flat INTO ls_component . UNASSIGN <fs_flatdata_field> . UNASSIGN <fs_field> . ASSIGN COMPONENT ls_component - name OF STRUCTURE <fs_flatdata_structure> TO <fs_flatdata_field> . ASSIGN COMPONENT ls_component - name OF STRUCTURE <fs_structure> TO <fs_field> . IF <fs_flatdata_field> IS ASSIGNED AND <fs_field> IS ASSIGNED . <fs_field> = <fs_flatdata_field> . ENDIF . ENDLOOP . ENDLOOP . ENDLOOP . lo_progress -> finish ( ). ENDMETHOD . *&---------------------------------------------------------------------* *& LIF_ALV~PBO *&---------------------------------------------------------------------* METHOD lif_alv~pbo . IF go_container IS NOT BOUND . go_container = NEW cl_gui_custom_container ( 'CON_9000' ). ENDIF . IF go_grid IS NOT BOUND . go_grid = NEW cl_gui_alv_grid ( go_container ). set_layout ( ). set_fieldcat ( ). set_event ( ). set_color ( ). FIELD-SYMBOLS <fs_table> TYPE STANDARD TABLE . ASSIGN mr_data->* TO <fs_table> . DATA ls_variant TYPE disvariant . ls_variant = VALUE # ( report = sy - repid handle = 3 ). CALL METHOD go_grid -> set_table_for_first_display EXPORTING is_layout = ms_layout is_variant = ls_variant i_save = 'X' CHANGING it_outtab = <fs_table> it_fieldcatalog = mt_fieldcat EXCEPTIONS invalid_parameter_combination = 1 program_error = 2 too_many_lines = 3 OTHERS = 4 . ELSE . CALL METHOD go_grid -> refresh_table_display EXPORTING is_stable = CONV # ( 'XX' ) i_soft_refresh = abap_true EXCEPTIONS finished = 1 OTHERS = 2 . ENDIF . ENDMETHOD . *&---------------------------------------------------------------------* *& LIF_ALV~PAI *&---------------------------------------------------------------------* METHOD lif_alv~pai . ENDMETHOD . *&---------------------------------------------------------------------* *& SET_LAYOUT *&---------------------------------------------------------------------* METHOD set_layout . CLEAR ms_layout . * MS_LAYOUT-ZEBRA = ABAP_TRUE. \" \u6591\u9a6c\u7ebf ms_layout - cwidth_opt = p_ctl4 . \" ABAP_TRUE. \" \u81ea\u52a8\u8c03\u6574ALVL\u5217\u5bbd ms_layout - sel_mode = 'A' . \" \u9009\u62e9\u6a21\u5f0f ms_layout - info_fname = 'RCOL' . \" \u5355\u5143\u683c\u989c\u8272\u8bbe\u7f6e ms_layout - ctab_fname = 'T_SCOL' . \" \u5355\u5143\u683c\u989c\u8272\u8bbe\u7f6e * MS_LAYOUT-STYLEFNAME = 'T_STYL'. \" \u5355\u5143\u683c\u63a7\u5236 ENDMETHOD . *&---------------------------------------------------------------------* *& SET_FIELDCAT *&---------------------------------------------------------------------* METHOD set_fieldcat . DATA ls_fieldcat TYPE lvc_s_fcat . DEFINE _init_fieldcat . CLEAR ls_fieldcat . ls_fieldcat - fieldname = &1 . ls_fieldcat - tooltip = ls_fieldcat - coltext = ls_fieldcat - seltext = ls_fieldcat - scrtext_l = ls_fieldcat - scrtext_m = ls_fieldcat - scrtext_s = &2 . ls_fieldcat - ref_table = &3 . ls_fieldcat - ref_field = &4 . INSERT ls_fieldcat INTO TABLE mt_fieldcat . END-OF-DEFINITION . lcl_alv_logh => set_fieldcat ( CHANGING ct_fieldcat = mt_fieldcat ). _init_fieldcat gs_fieldname - path '\u8def\u5f84' '' '' . LOOP AT mt_component_flat INTO DATA ( ls_component_flat ). IF ls_component_flat - name CS gs_fieldname - field . _init_fieldcat ls_component_flat - name '-' '' '' . ENDIF . ENDLOOP . ENDMETHOD . *&---------------------------------------------------------------------* *& SET_EVENT *&---------------------------------------------------------------------* METHOD set_event . SET HANDLER on_double_click FOR go_grid . ENDMETHOD . *&---------------------------------------------------------------------* *& SET_COLOR *&---------------------------------------------------------------------* METHOD set_color . DATA ls_scol TYPE lvc_s_scol . DATA ls_log_head TYPE ty_log_head . FIELD-SYMBOLS <fs_table> TYPE STANDARD TABLE . FIELD-SYMBOLS <fs_structure> TYPE any . FIELD-SYMBOLS <fs_field> TYPE any . FIELD-SYMBOLS <fs_t_scol> TYPE lvc_t_scol . ASSIGN mr_data->* TO <fs_table> . LOOP AT <fs_table> ASSIGNING <fs_structure> . IF <fs_structure> IS INITIAL . ASSIGN COMPONENT 'RCOL' OF STRUCTURE <fs_structure> TO FIELD - SYMBOL ( <fs_rcol> ). IF <fs_rcol> IS ASSIGNED . <fs_rcol> = 'C300' . ENDIF . CONTINUE . ENDIF . ASSIGN COMPONENT 'T_SCOL' OF STRUCTURE <fs_structure> TO <fs_t_scol> . CLEAR <fs_t_scol> . CLEAR ls_log_head . ls_log_head = CORRESPONDING # ( <fs_structure> ). IF ls_log_head - mtype = 'S' . <fs_t_scol> = VALUE # ( BASE <fs_t_scol> color = gs_color - green ( fname = 'MTYPE' ) ( fname = 'MSG' ) ). ELSE . <fs_t_scol> = VALUE # ( BASE <fs_t_scol> color = gs_color - red ( fname = 'MTYPE' ) ( fname = 'MSG' ) ). ENDIF . CHECK p_ctl3 = abap_true . \" \u5355\u5143\u683c\u7740\u8272 UNASSIGN <fs_field> . ASSIGN COMPONENT gs_fieldname - fdlk OF STRUCTURE <fs_structure> TO <fs_field> . CHECK <fs_field> IS ASSIGNED . DATA ls_color LIKE gs_color - red . CLEAR ls_color . CASE <fs_field> . WHEN gs_fdlk - header . ls_color = gs_color - dept_blue . WHEN gs_fdlk - data . * LS_COLOR = GS_COLOR-BLUE. WHEN OTHERS . ls_color = gs_color - yellow . ENDCASE . LOOP AT mt_component_flat INTO DATA ( ls_component ). CLEAR ls_scol . ls_scol - fname = ls_component - name . ls_scol - color = ls_color . INSERT ls_scol INTO TABLE <fs_t_scol> . ENDLOOP . ENDLOOP . ENDMETHOD . *&---------------------------------------------------------------------* *& ON_DOUBLE_CLICK *&---------------------------------------------------------------------* METHOD on_double_click . FIELD-SYMBOLS <fs_table> TYPE STANDARD TABLE . FIELD-SYMBOLS <fs_structure> TYPE any . ASSIGN mr_data->* TO <fs_table> . READ TABLE <fs_table> ASSIGNING <fs_structure> INDEX e_row - index . CHECK sy - subrc = 0 . DATA ls_log_head TYPE ty_log_head . ls_log_head = CORRESPONDING # ( <fs_structure> ). CASE e_column . WHEN 'ZRAW_ICON' . lcl_alv_logh => display_rawdata ( i_uuid = ls_log_head - uuid i_zitem = ls_log_head - zitem ). WHEN 'FUNC_NAME' . lcl_alv_logh => nav_se37 ( ls_log_head - func_name ). ENDCASE . ENDMETHOD . *&---------------------------------------------------------------------* *& LIF_ALV~GET_SELECTED_UUID *&---------------------------------------------------------------------* METHOD lif_alv~get_selected_uuid . FIELD-SYMBOLS <fs_table> TYPE STANDARD TABLE . FIELD-SYMBOLS <fs_structure> TYPE any . ASSIGN mr_data->* TO <fs_table> . \" \u83b7\u53d6ALV\u9009\u53d6\u884c DATA lt_rows TYPE lvc_t_row . CALL METHOD go_grid -> get_selected_rows IMPORTING et_index_rows = lt_rows . LOOP AT lt_rows INTO DATA ( ls_row ). READ TABLE <fs_table> ASSIGNING <fs_structure> INDEX ls_row - index . CHECK sy - subrc = 0 . ASSIGN COMPONENT 'UUID' OF STRUCTURE <fs_structure> TO FIELD - SYMBOL ( <fs_uuid> ). IF et_uuid IS SUPPLIED . APPEND <fs_uuid> TO et_uuid . ENDIF . IF et_uuid_opt IS SUPPLIED . INSERT VALUE # ( sign = 'I' option = 'EQ' low = <fs_uuid> ) INTO TABLE et_uuid_opt . ENDIF . ENDLOOP . SORT et_uuid BY table_line . DELETE ADJACENT DUPLICATES FROM et_uuid COMPARING table_line . DELETE et_uuid WHERE table_line IS INITIAL . SORT et_uuid_opt BY low . DELETE ADJACENT DUPLICATES FROM et_uuid_opt COMPARING low . DELETE et_uuid_opt WHERE low IS INITIAL . ENDMETHOD . ENDCLASS . *&---------------------------------------------------------------------* *& LIF_LOG *&---------------------------------------------------------------------* INTERFACE lif_log . METHODS check_active RETURNING VALUE ( r_result ) TYPE xfeld . METHODS get_log_kind RETURNING VALUE ( r_log_kind ) TYPE ty_log_head - log_kind . METHODS get_data . METHODS redo IMPORTING it_uuid TYPE tt_uuid . ENDINTERFACE . *&---------------------------------------------------------------------* *& LCL_LOG_PO *&---------------------------------------------------------------------* CLASS lcl_log_po DEFINITION . PUBLIC SECTION . INTERFACES lif_log . ENDCLASS . *&---------------------------------------------------------------------* *& LCL_LOG_PO *&---------------------------------------------------------------------* CLASS lcl_log_po IMPLEMENTATION . *&---------------------------------------------------------------------* *& lif_log~get_log_kind *&---------------------------------------------------------------------* METHOD lif_log~get_log_kind . r_log_kind = 'PO' . ENDMETHOD . *&---------------------------------------------------------------------* *& LIF_LOG~GET_DATA *&---------------------------------------------------------------------* METHOD lif_log~get_data . DATA ls_log TYPE ty_log . DATA ls_log_rawdata TYPE ty_log_rawdata . DATA : ls_clustkey TYPE sxmsclustkey , ls_clur TYPE sxmsclur , lt_res TYPE sxmsrest , lt_xres TYPE sxmsxrest , lt_ns TYPE sxmsnst . DATA l_from TYPE sxmspmast - sendtimest . DATA l_to TYPE sxmspmast - sendtimest . IF s_time[] IS NOT INITIAL . CONVERT DATE s_date [ 1 ] - low TIME s_time [ 1 ] - low INTO TIME STAMP l_from TIME ZONE sy - zonlo . CONVERT DATE s_date [ 1 ] - high TIME s_time [ 1 ] - high INTO TIME STAMP l_to TIME ZONE sy - zonlo . ELSE . CONVERT DATE s_date [ 1 ] - low TIME '000000' INTO TIME STAMP l_from TIME ZONE sy - zonlo . CONVERT DATE s_date [ 1 ] - high TIME '235959' INTO TIME STAMP l_to TIME ZONE sy - zonlo . ENDIF . \" SXMSPEMAS\uff0c\u6846\u67b6\u4fe1\u606f\uff0c\u53d1\u9001SI\uff0c\u63a5\u6536SI\uff0c\u547d\u540d\u7a7a\u95f4\uff0c\u7cfb\u7edf\u7b49 \" SXMSPMAST\uff0c\u4e3b\u8981\u4fe1\u606f\uff0c\u7528\u6237\uff0c\u5f00\u59cb\u7ed3\u675f\u65f6\u95f4\u7b49 \" SXMSCLUR\uff0c\u6d88\u606f\u62a5\u6587 SELECT a~msgguid , a~pid , b~ob_system , b~ob_name , b~ib_system , b~ib_name , a~adminuser , a~sendtimest , a~msgtype FROM sxmspmast AS a JOIN sxmspemas AS b ON a~msgguid = b~msgguid AND a~pid = b~pid WHERE a~msgguid IN @ s_uuid AND a~sendtimest BETWEEN @ l_from AND @ l_to AND ( b~ob_name IN @ s_siname OR b~ib_name IN @ s_siname ) AND a~adminuser IN @ s_user AND a~msgtype IN @ s_mtype INTO TABLE @ DATA ( lt_pilog ). LOOP AT lt_pilog INTO DATA ( ls_pilog ). \" \u8bfb\u53d6PO\u62a5\u6587 CLEAR ls_clustkey . CLEAR ls_clur . CLEAR lt_res . CLEAR lt_xres . CLEAR lt_ns . ls_clustkey - msgguid = ls_pilog - msgguid . ls_clustkey - pid = ls_pilog - pid . IMPORT lt_res TO lt_res lt_xres TO lt_xres lt_ns TO lt_ns FROM DATABASE sxmsclur ( is ) TO ls_clur ID ls_clustkey . CLEAR ls_log . ls_log - uuid = ls_pilog - msgguid . \" \u63a5\u53e3ID IF ls_pilog - ob_name IS NOT INITIAL . ls_log - intf_id = ls_pilog - ob_name . ELSE . ls_log - intf_id = ls_pilog - ib_name . ENDIF . ls_log - io_flag = ls_pilog - pid . \" \u63a5\u53e3\u65b9\u5411 ls_log - zsender = ls_pilog - ob_system . \" \u53d1\u9001\u65b9 ls_log - zreceiver = ls_pilog - ib_system . \" \u63a5\u53d7\u65b9 CONVERT TIME STAMP ls_pilog - sendtimest TIME ZONE sy - zonlo INTO DATE ls_log - zdate TIME ls_log - ztime . ls_log - zuser = ls_pilog - adminuser . ls_log - mtype = ls_pilog - msgtype . INSERT ls_log INTO TABLE gt_log . READ TABLE lt_xres REFERENCE INTO DATA ( lr_xres ) INDEX 1 . IF sy - subrc = 0 AND lr_xres -> rescontent IS NOT INITIAL . CLEAR ls_log_rawdata . ls_log_rawdata - uuid = ls_pilog - msgguid . ls_log_rawdata - zformat = 'XML' . ls_log_rawdata - zrawx = lr_xres -> rescontent . \" \u539f\u59cb\u6570\u636e INSERT ls_log_rawdata INTO TABLE gt_log_rawdata . ENDIF . ENDLOOP . ENDMETHOD . *&---------------------------------------------------------------------* *& LIF_LOG~REDO *&---------------------------------------------------------------------* METHOD lif_log~redo . ENDMETHOD . *&---------------------------------------------------------------------* *& lif_log~check_active *&---------------------------------------------------------------------* METHOD lif_log~check_active . r_result = p_po . ENDMETHOD . ENDCLASS . *&---------------------------------------------------------------------* *& LCL_LOG_CUSTOM *&---------------------------------------------------------------------* CLASS lcl_log_custom DEFINITION . PUBLIC SECTION . INTERFACES lif_log . ENDCLASS . *&---------------------------------------------------------------------* *& LCL_LOG_CUSTOM *&---------------------------------------------------------------------* CLASS lcl_log_custom IMPLEMENTATION . *&---------------------------------------------------------------------* *& lif_log~get_log_kind *&---------------------------------------------------------------------* METHOD lif_log~get_log_kind . r_log_kind = 'CUSTOM' . ENDMETHOD . *&---------------------------------------------------------------------* *& LIF_LOG~GET_DATA *&---------------------------------------------------------------------* METHOD lif_log~get_data . \" DATA ls_log TYPE ty_log. \" DATA ls_log_rawdata TYPE ty_log_rawdata. \" DATA l_zitem TYPE ty_log-zitem. \" SELECT \" ztintf~sysid, \" ztintf~funcname, \" tftit~stext \" FROM ztintf \" JOIN tftit ON ztintf~funcname = tftit~funcname \" AND tftit~spras = '1' \" INTO TABLE @DATA(lt_ztintf). \" SORT lt_ztintf BY sysid. \" SELECT * FROM ztlog \" WHERE zguid IN @s_uuid \" AND intfid IN @s_intfid \" AND zsender IN @s_snd \" AND zreceiver IN @s_rcv \" AND datum IN @s_date \" AND uzeit IN @s_time \" AND zstatus IN @s_mtype \" AND funcname IN @s_func \" INTO TABLE @DATA(lt_ztlog). \" SORT lt_ztlog BY zguid. \" LOOP AT lt_ztlog INTO DATA(ls_ztlog). \" AT NEW zguid. \" CLEAR l_zitem. \" ENDAT. \" l_zitem = l_zitem + 1. \" CLEAR ls_log. \" ls_log-uuid = ls_ztlog-zguid. \" ls_log-zitem = l_zitem. \" ls_log-intf_id = ls_ztlog-intfid. \" \u63a5\u53e3ID \" READ TABLE lt_ztintf REFERENCE INTO DATA(lr_ztintf) \" WITH KEY sysid = ls_ztlog-intfid BINARY SEARCH. \" IF sy-subrc = 0. \" ls_log-func_name = lr_ztintf->funcname. \" ls_log-func_text = lr_ztintf->stext. \" ENDIF. \" ls_log-io_flag = ls_ztlog-zzio. \" \u63a5\u53e3\u65b9\u5411 \" ls_log-zsender = ls_ztlog-zsender. \" \u53d1\u9001\u65b9 \" ls_log-zreceiver = ls_ztlog-zreceiver. \" \u63a5\u53d7\u65b9 \" ls_log-zdate = ls_ztlog-datum. \" ls_log-ztime = ls_ztlog-uzeit. \" ls_log-zuser = ls_ztlog-uname. \" ls_log-mtype = ls_ztlog-zstatus. \" ls_log-zconut = ls_ztlog-zcount. \" \u6761\u76ee\u7edf\u8ba1 \" INSERT ls_log INTO TABLE gt_log. \" IF ls_ztlog-zjson IS NOT INITIAL. \" CLEAR ls_log_rawdata. \" ls_log_rawdata-uuid = ls_ztlog-zguid. \" ls_log_rawdata-zitem = l_zitem. \" ls_log_rawdata-zformat = 'JSON'. \" ls_log_rawdata-zraw = ls_ztlog-zjson. \" \u539f\u59cb\u6570\u636e \" INSERT ls_log_rawdata INTO TABLE gt_log_rawdata. \" ENDIF. \" ENDLOOP. ENDMETHOD . *&---------------------------------------------------------------------* *& LIF_LOG~REDO *&---------------------------------------------------------------------* METHOD lif_log~redo . \" DATA l_fsyid TYPE string. \" DATA l_fname TYPE string. \" DATA l_sdata TYPE string. \" DATA l_infud TYPE string. \" DATA l_ftname TYPE string. \" DATA(lo_proxy) = NEW zcl_intf_proxy( ). \" LOOP AT it_uuid INTO DATA(l_uuid). \" READ TABLE gt_log INTO DATA(ls_log) WITH KEY \" uuid = l_uuid \" io_flag = '2'. \" IF ls_log-mtype = 'S'. \" lcl_progress=>step( |{ l_uuid }\u4e0d\u9700\u8981\u91cd\u5904\u7406| ). \" CONTINUE. \" ELSE. \" READ TABLE gt_log INTO ls_log WITH KEY \" uuid = l_uuid \" io_flag = '1'. \" IF sy-subrc = 0. \" READ TABLE gt_log_rawdata INTO DATA(ls_log_rawdata) WITH KEY \" uuid = ls_log-uuid \" zitem = ls_log-zitem \" BINARY SEARCH. \" IF sy-subrc = 0. \" l_fsyid = ls_log-zsender. \" \u5916\u90e8\u7cfb\u7edf \" l_fname = ls_log-intf_id. \" \u63a5\u53e3ID \" l_sdata = ls_log_rawdata-zraw. \" \u8bf7\u6c42\u62a5\u6587 \" l_infud = ls_log-uuid. \" \u62a5\u6587ID \" l_ftname = ls_log-func_name. \" \u5bf9\u5e94\u51fd\u6570\u540d \" CASE ls_log-zsender. \" WHEN 'SAP'. \" CALL METHOD lo_proxy->sap_data_to_out \" EXPORTING \" iv_fname = l_fname \" iv_sdata = l_sdata \" iv_infud = l_infud \" iv_ftname = l_ftname. \" WHEN OTHERS. \" CALL METHOD lo_proxy->out_data_to_sap \" EXPORTING \" iv_fsyid = l_fsyid \" iv_fname = l_fname \" iv_sdata = l_sdata \" iv_infud = l_infud. \" ENDCASE. \" lcl_progress=>step( |{ l_uuid }\u5df2\u63d0\u4ea4\u91cd\u5904\u7406| ). \" ENDIF. \" ENDIF. \" ENDIF. \" ENDLOOP. ENDMETHOD . *&---------------------------------------------------------------------* *& lif_log~check_active *&---------------------------------------------------------------------* METHOD lif_log~check_active . r_result = p_custom . ENDMETHOD . ENDCLASS . *&---------------------------------------------------------------------* *& FRM_INIT *&---------------------------------------------------------------------* FORM frm_init . GET PARAMETER ID 'LIB' FIELD s_func - low . \" \u66f4\u65b0\u53c2\u6570\u76f8\u5173 b900 = '\u81ea\u5b9a\u4e49\u9009\u62e9\u6761\u4ef6' . % _p_custom_ % _app_ % - text = '\u67e5\u8be2\u81ea\u5b9a\u4e49\u65e5\u5fd7' . % _s_intfid_ % _app_ % - text = '\u63a5\u53e3\u7f16\u53f7' . b100 = '\u901a\u7528\u9009\u62e9\u6761\u4ef6' . % _s_uuid_ % _app_ % - text = 'UUID' . % _s_func_ % _app_ % - text = '\u51fd\u6570\u540d' . % _s_snd_ % _app_ % - text = '\u53d1\u9001\u65b9' . % _s_rcv_ % _app_ % - text = '\u63a5\u6536\u65b9' . % _s_date_ % _app_ % - text = '\u5904\u7406\u65e5\u671f' . % _s_time_ % _app_ % - text = '\u5904\u7406\u65f6\u95f4' . % _s_user_ % _app_ % - text = '\u5904\u7406\u4eba' . % _s_mtype_ % _app_ % - text = '\u72b6\u6001' . b101 = '\u6269\u5c55\u9009\u62e9\u6761\u4ef6' . % _s_field_ % _app_ % - text = '\u5b57\u6bb5\u540d' . % _s_value_ % _app_ % - text = '\u5b57\u6bb5\u503c' . b102 = 'PO\u9009\u62e9\u6761\u4ef6' . % _p_po_ % _app_ % - text = '\u67e5\u8be2PO' . % _s_siname_ % _app_ % - text = '\u63a5\u53e3\u540d\u79f0' . b200 = '\u62a5\u8868\u6837\u5f0f' . % _p_logh_ % _app_ % - text = '\u65e5\u5fd7\u62ac\u5934\u6570\u636e\u5c55\u793a' . % _p_unit_ % _app_ % - text = '\u5355\u5143\u6570\u636e\u5c55\u793a' . % _p_flat_ % _app_ % - text = '\u6241\u5e73\u7ed3\u6784\u5c55\u793a' . b201 = '\u5176\u4ed6\u9009\u9879' . % _p_ctl1_ % _app_ % - text = '\u7d27\u51d1\u5c55\u793a' . % _p_ctl2_ % _app_ % - text = '\u5c55\u793a\u7ed3\u6784\u62ac\u5934' . % _p_ctl3_ % _app_ % - text = '\u5355\u5143\u683c\u7740\u8272' . % _p_ctl4_ % _app_ % - text = '\u5217\u5bbd\u81ea\u9002\u5e94' . % _p_ctl5_ % _app_ % - text = '\u65e5\u5fd7\u8bb0\u5f55\u76f8\u9694\u7a7a\u884c' . gs_color - blue = VALUE # ( col = 4 ). gs_color - yellow = VALUE # ( col = 3 ). gs_color - green = VALUE # ( col = 5 ). gs_color - red = VALUE # ( col = 6 ). gs_color - dept_blue = VALUE # ( col = 4 int = 1 ). gs_color - dept_yellow = VALUE # ( col = 3 int = 1 ). gs_color - dept_green = VALUE # ( col = 5 int = 1 ). gs_color - dept_red = VALUE # ( col = 6 int = 1 ). PERFORM frm_find_log_impl . \" \u67e5\u627e\u5e76\u521b\u5efa\u65e5\u5fd7\u5b9e\u4f8b ENDFORM . *&---------------------------------------------------------------------* *& FRM_FIND_LOG_IMPL *&---------------------------------------------------------------------* FORM frm_find_log_impl . DATA lt_classname TYPE STANDARD TABLE OF seoclsname . DATA lo_classdescr TYPE REF TO cl_abap_classdescr . DATA lo_log TYPE REF TO lif_log . DATA ( lo_scan ) = NEW cl_ci_scan ( cl_ci_source_include => create ( p_name = sy - repid ) ). LOOP AT lo_scan -> tokens INTO DATA ( ls_token ) WHERE str = 'CLASS' . READ TABLE lo_scan -> tokens INTO ls_token INDEX sy - tabix + 1 . INSERT CONV # ( ls_token - str ) INTO TABLE lt_classname . ENDLOOP . SORT lt_classname BY table_line . DELETE ADJACENT DUPLICATES FROM lt_classname COMPARING table_line . LOOP AT lt_classname INTO DATA ( l_classname ). lo_classdescr ?= cl_abap_classdescr => describe_by_name ( l_classname ). READ TABLE lo_classdescr -> interfaces TRANSPORTING NO FIELDS WITH KEY name = 'LIF_LOG' . IF sy - subrc = 0 . TRY . CREATE OBJECT lo_log TYPE ( lo_classdescr -> absolute_name ). INSERT lo_log INTO TABLE gt_log_impl . CATCH cx_root . ENDTRY . ENDIF . ENDLOOP . ENDFORM . *&---------------------------------------------------------------------* *& FRM_MAIN *&---------------------------------------------------------------------* FORM frm_main . \" \u4e3a\u4e86\u65b9\u4fbf\u8bfb\u53d6\u65f6\u95f4+\u65e5\u671f\u8303\u56f4\uff0c\u7a0d\u5fae\u8c03\u6574\u4e0b\u65e5\u671f\u683c\u5f0f LOOP AT s_date REFERENCE INTO DATA ( lr_date_opt ). IF lr_date_opt -> high IS INITIAL . lr_date_opt -> option = 'BT' . lr_date_opt -> high = lr_date_opt -> low . ENDIF . ENDLOOP . LOOP AT s_time REFERENCE INTO DATA ( lr_time_opt ). IF lr_time_opt -> high IS INITIAL . lr_time_opt -> option = 'BT' . lr_time_opt -> high = lr_time_opt -> low . ENDIF . ENDLOOP . lcl_progress => step ( '\u67e5\u8be2\u65e5\u5fd7\u6570\u636e' ). PERFORM frm_get_data . lcl_progress => step ( '\u65e5\u5fd7\u6570\u636e\u5904\u7406' ). PERFORM frm_process_data . PERFORM frm_display . \" ALV\u5c55\u793a ENDFORM . *&---------------------------------------------------------------------* *& FRM_GET_DATA *&---------------------------------------------------------------------* FORM frm_get_data . DATA lt_log TYPE tt_log . LOOP AT gt_log_impl INTO DATA ( lo_log ). CHECK lo_log -> check_active ( ) = abap_true . CLEAR gt_log . lo_log -> get_data ( ). \" \u53d6\u6570 LOOP AT gt_log REFERENCE INTO DATA ( lr_log ). lr_log -> log_kind = lo_log -> get_log_kind ( ). lr_log -> zraw_icon = icon_detail . ENDLOOP . INSERT LINES OF gt_log INTO TABLE lt_log . ENDLOOP . gt_log = lt_log . ENDFORM . *&---------------------------------------------------------------------* *& FRM_PROCESS_DATA *&---------------------------------------------------------------------* FORM frm_process_data . \" \u65e5\u671f\u65f6\u95f4\u5012\u5e8f SORT gt_log BY zdate DESCENDING ztime DESCENDING uuid zitem DESCENDING . SORT gt_log_rawdata BY uuid zitem . \" \u7528\u4e8e\u5f39\u7a97\u5c55\u793a\u539f\u59cb\u6570\u636e \" \u4e0d\u9700\u8981\u5c55\u793a\u52a0\u5de5\u6570\u636e\u7684\u8bdd\uff0c\u6ca1\u5fc5\u8981\u7ee7\u7eed\u6267\u884c\u6d6a\u8d39\u65f6\u95f4 IF p_logh = abap_true AND s_value[] IS INITIAL . RETURN . ENDIF . * \" \u6a21\u7cca\u67e5\u8be2 * LOOP AT s_value[] REFERENCE INTO DATA(lr_value_opt). * IF lr_value_opt->option = 'EQ'. * lr_value_opt->option = 'CP'. * lr_value_opt->low = |*{ lr_value_opt->low }*|. * ENDIF. * ENDLOOP. DATA ( lo_progress ) = NEW lcl_progress ( ). lo_progress -> m_name = '\u63a5\u53e3\u6570\u636e\u5904\u7406' . lo_progress -> start ( lines ( gt_log ) ). LOOP AT gt_log REFERENCE INTO DATA ( lr_log ). lo_progress -> next ( ). \" \u8fdb\u5ea6\u5c55\u793a \" \u8f6c\u5316\u4e3a\u6570\u636e\u5355\u5143 READ TABLE gt_log_rawdata REFERENCE INTO DATA ( lr_log_rawdata ) WITH KEY uuid = lr_log -> uuid zitem = lr_log -> zitem BINARY SEARCH . IF sy - subrc = 0 . CASE lr_log_rawdata -> zformat . WHEN 'JSON' . lr_log -> t_unit = lcl_unit_helper => parse_json ( lr_log_rawdata -> zraw ). WHEN 'XML' . lr_log -> t_unit = lcl_unit_helper => parse_xml ( lr_log_rawdata -> zrawx ). ENDCASE . ENDIF . CHECK lr_log -> t_unit IS NOT INITIAL . \" \u6269\u5c55\u67e5\u8be2 IF s_value[] IS NOT INITIAL . IF s_field[] IS NOT INITIAL . LOOP AT lr_log -> t_unit TRANSPORTING NO FIELDS WHERE key IN s_field[] AND value IN s_value[] . EXIT . ENDLOOP . ELSE . LOOP AT lr_log -> t_unit TRANSPORTING NO FIELDS WHERE value IN s_value[] . EXIT . ENDLOOP . ENDIF . \" \u8fc7\u6ee4\u4e0d\u7b26\u5408\u6761\u4ef6\u7684\u6570\u636e IF sy - subrc <> 0 . DELETE gt_log . CONTINUE . ENDIF . ENDIF . CALL METHOD lcl_unit_helper => generate_flatdata EXPORTING it_unit = lr_log -> t_unit i_compact = p_ctl1 IMPORTING et_flatdt = lr_log -> t_flatdt RECEIVING rr_data = lr_log -> r_flatdata . ENDLOOP . lo_progress -> finish ( ). ENDFORM . *&---------------------------------------------------------------------* *& FRM_DISPLAY *&---------------------------------------------------------------------* FORM frm_display . CASE 'X' . WHEN p_logh . \" \u65e5\u5fd7\u62ac\u5934\u6570\u636e\u5c55\u793a go_alv ?= NEW lcl_alv_logh ( ). WHEN p_unit . \" \u5355\u5143\u6570\u636e\u5c55\u793a go_alv ?= NEW lcl_alv_unit ( ). WHEN p_flat . \" \u6241\u5e73\u7ed3\u6784\u5c55\u793a go_alv ?= NEW lcl_alv_flat ( ). WHEN OTHERS . MESSAGE '\u65e0\u6548\u7684\u5c55\u793a\u65b9\u5f0f' TYPE 'S' DISPLAY LIKE 'E' . RETURN . ENDCASE . CALL SCREEN '9000' . ENDFORM . *&---------------------------------------------------------------------* *& FRM_REDO *&---------------------------------------------------------------------* FORM frm_redo . go_alv -> get_selected_uuid ( IMPORTING et_uuid = DATA ( lt_uuid ) ). CHECK lt_uuid IS NOT INITIAL . LOOP AT gt_log_impl INTO DATA ( lo_log ). CHECK lo_log -> check_active ( ) = abap_true . DATA ( l_log_kind ) = lo_log -> get_log_kind ( ). DATA lt_uuid_tmp TYPE tt_uuid . CLEAR lt_uuid_tmp . LOOP AT gt_log REFERENCE INTO DATA ( lr_log ) WHERE log_kind = l_log_kind . READ TABLE lt_uuid INTO DATA ( l_uuid ) WITH KEY table_line = lr_log -> uuid BINARY SEARCH . IF sy - subrc = 0 . INSERT l_uuid INTO TABLE lt_uuid_tmp . ENDIF . ENDLOOP . IF lt_uuid_tmp IS NOT INITIAL . lo_log -> redo ( lt_uuid_tmp ). ENDIF . ENDLOOP . ENDFORM . *&---------------------------------------------------------------------* *& FRM_F4_INTFID *&---------------------------------------------------------------------* FORM frm_f4_intfid . \" SELECT \" ztintf~sysnm, \" ztintf~sysid, \" ztintf~funcname, \" tftit~stext \" FROM ztintf \" JOIN tftit ON spras = '1' \" AND ztintf~funcname = tftit~funcname \" INTO TABLE @DATA(lt_ztintf). \" \" DATA l_dynprofield TYPE dynfnam. \" GET CURSOR FIELD l_dynprofield. \" \" CALL FUNCTION 'F4IF_INT_TABLE_VALUE_REQUEST' \" EXPORTING \" retfield = 'SYSID' \" value_org = 'S' \" dynprofield = l_dynprofield \" dynpprog = sy-repid \" dynpnr = sy-dynnr \" TABLES \" value_tab = lt_ztintf \" EXCEPTIONS \" parameter_error = 1 \" no_values_found = 2 \" OTHERS = 3. \" IF sy-subrc <> 0. \" MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno \" WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4. \" ENDIF. ENDFORM . *&---------------------------------------------------------------------* *& \u521d\u59cb\u5316 *&---------------------------------------------------------------------* INITIALIZATION . PERFORM frm_init . **&---------------------------------------------------------------------* **& \u81ea\u5b9a\u4e49\u65e5\u5fd7\u8868\u63a5\u53e3ID\u641c\u7d22\u5e2e\u52a9 **&---------------------------------------------------------------------* *AT SELECTION-SCREEN ON VALUE-REQUEST FOR s_intfid-low. * PERFORM frm_f4_intfid. * *AT SELECTION-SCREEN ON VALUE-REQUEST FOR s_intfid-high. * PERFORM frm_f4_intfid. *&---------------------------------------------------------------------* *& START-OF-SELECTION *&---------------------------------------------------------------------* START-OF-SELECTION . PERFORM frm_main . *&---------------------------------------------------------------------* *& MODULE STATUS_9000 OUTPUT *&---------------------------------------------------------------------* MODULE status_9000 OUTPUT . go_alv -> pbo ( ). SET PF-STATUS 'STATUS' . ENDMODULE . *&---------------------------------------------------------------------* *& MODULE USER_COMMAND_9000 INPUT *&---------------------------------------------------------------------* MODULE user_command_9000 INPUT . CASE sy - ucomm . WHEN 'REDO' . \" \u9519\u8bef\u91cd\u5904\u7406 PERFORM frm_redo . WHEN '&F03' OR '&F15' OR '&F12' . LEAVE TO SCREEN 0 . WHEN OTHERS . go_alv -> pai ( ). ENDCASE . ENDMODULE . LIF_LOG\u5b9e\u4f8b\u53c2\u8003\u4ee3\u7801 *&---------------------------------------------------------------------* *& LCL_LOG_CUSTOM *&---------------------------------------------------------------------* CLASS lcl_log_custom DEFINITION . PUBLIC SECTION . INTERFACES lif_log . ENDCLASS . *&---------------------------------------------------------------------* *& LCL_LOG_CUSTOM *&---------------------------------------------------------------------* CLASS lcl_log_custom IMPLEMENTATION . *&---------------------------------------------------------------------* *& lif_log~get_log_kind *&---------------------------------------------------------------------* METHOD lif_log~get_log_kind . r_log_kind = 'CUSTOM' . ENDMETHOD . *&---------------------------------------------------------------------* *& LIF_LOG~GET_DATA *&---------------------------------------------------------------------* METHOD lif_log~get_data . DATA ls_log TYPE ty_log . DATA ls_log_rawdata TYPE ty_log_rawdata . DATA l_zitem TYPE ty_log - zitem . SELECT ztintf~sysid , ztintf~funcname , tftit~stext FROM ztintf JOIN tftit ON ztintf~funcname = tftit~funcname AND tftit~spras = '1' INTO TABLE @ DATA ( lt_ztintf ). SORT lt_ztintf BY sysid . SELECT * FROM ztlog WHERE zguid IN @ s_uuid AND intfid IN @ s_intfid AND zsender IN @ s_snd AND zreceiver IN @ s_rcv AND datum IN @ s_date AND uzeit IN @ s_time AND zstatus IN @ s_mtype AND funcname IN @ s_func INTO TABLE @ DATA ( lt_ztlog ). SORT lt_ztlog BY zguid . LOOP AT lt_ztlog INTO DATA ( ls_ztlog ). AT NEW zguid . CLEAR l_zitem . ENDAT . l_zitem = l_zitem + 1 . CLEAR ls_log . ls_log - uuid = ls_ztlog - zguid . ls_log - zitem = l_zitem . ls_log - intf_id = ls_ztlog - intfid . \" \u63a5\u53e3ID READ TABLE lt_ztintf REFERENCE INTO DATA ( lr_ztintf ) WITH KEY sysid = ls_ztlog - intfid BINARY SEARCH . IF sy - subrc = 0 . ls_log - func_name = lr_ztintf -> funcname . ls_log - func_text = lr_ztintf -> stext . ENDIF . ls_log - io_flag = ls_ztlog - zzio . \" \u63a5\u53e3\u65b9\u5411 ls_log - zsender = ls_ztlog - zsender . \" \u53d1\u9001\u65b9 ls_log - zreceiver = ls_ztlog - zreceiver . \" \u63a5\u53d7\u65b9 ls_log - zdate = ls_ztlog - datum . ls_log - ztime = ls_ztlog - uzeit . ls_log - zuser = ls_ztlog - uname . ls_log - mtype = ls_ztlog - zstatus . ls_log - zconut = ls_ztlog - zcount . \" \u6761\u76ee\u7edf\u8ba1 INSERT ls_log INTO TABLE gt_log . IF ls_ztlog - zjson IS NOT INITIAL . CLEAR ls_log_rawdata . ls_log_rawdata - uuid = ls_ztlog - zguid . ls_log_rawdata - zitem = l_zitem . ls_log_rawdata - zformat = 'JSON' . ls_log_rawdata - zraw = ls_ztlog - zjson . \" \u539f\u59cb\u6570\u636e INSERT ls_log_rawdata INTO TABLE gt_log_rawdata . ENDIF . ENDLOOP . ENDMETHOD . *&---------------------------------------------------------------------* *& LIF_LOG~REDO *&---------------------------------------------------------------------* METHOD lif_log~redo . DATA l_fsyid TYPE string . DATA l_fname TYPE string . DATA l_sdata TYPE string . DATA l_infud TYPE string . DATA l_ftname TYPE string . DATA ( lo_proxy ) = NEW zcl_intf_proxy ( ). LOOP AT it_uuid INTO DATA ( l_uuid ). READ TABLE gt_log INTO DATA ( ls_log ) WITH KEY uuid = l_uuid io_flag = '2' . IF ls_log - mtype = 'S' . lcl_progress => step ( |{ l_uuid } \u4e0d\u9700\u8981\u91cd\u5904\u7406 | ). CONTINUE . ELSE . READ TABLE gt_log INTO ls_log WITH KEY uuid = l_uuid io_flag = '1' . IF sy - subrc = 0 . READ TABLE gt_log_rawdata INTO DATA ( ls_log_rawdata ) WITH KEY uuid = ls_log - uuid zitem = ls_log - zitem BINARY SEARCH . IF sy - subrc = 0 . l_fsyid = ls_log - zsender . \" \u5916\u90e8\u7cfb\u7edf l_fname = ls_log - intf_id . \" \u63a5\u53e3ID l_sdata = ls_log_rawdata - zraw . \" \u8bf7\u6c42\u62a5\u6587 l_infud = ls_log - uuid . \" \u62a5\u6587ID l_ftname = ls_log - func_name . \" \u5bf9\u5e94\u51fd\u6570\u540d CASE ls_log - zsender . WHEN 'SAP' . CALL METHOD lo_proxy -> sap_data_to_out EXPORTING iv_fname = l_fname iv_sdata = l_sdata iv_infud = l_infud iv_ftname = l_ftname . WHEN OTHERS . CALL METHOD lo_proxy -> out_data_to_sap EXPORTING iv_fsyid = l_fsyid iv_fname = l_fname iv_sdata = l_sdata iv_infud = l_infud . ENDCASE . lcl_progress => step ( |{ l_uuid } \u5df2\u63d0\u4ea4\u91cd\u5904\u7406 | ). ENDIF . ENDIF . ENDIF . ENDLOOP . ENDMETHOD . *&---------------------------------------------------------------------* *& lif_log~check_active *&---------------------------------------------------------------------* METHOD lif_log~check_active . r_result = p_custom . ENDMETHOD . ENDCLASS .","title":"\u65e5\u5fd7\u67e5\u8be2\u7a0b\u5e8f"},{"location":"sd/","text":"SD\u6a21\u5757\u6982\u8ff0 \u00b6 \u6211\u7406\u89e3\u7684SD\uff08\uff09\uff0c\u9500\u552e\u548c\u5206\u9500\u6a21\u5757\uff0c\u5305\u62ec\u91c7\u8d2d\u6536\u8d27\uff0c\u9500\u552e\u5355\uff0c\u9500\u552e\u53d1\u8d27\uff0c\u6536\u8d27\u548c\u53d1\u8d27\u8fc7\u8d26\uff0cMIGO\u7b49\u3002","title":"SD\u6a21\u5757\u6982\u8ff0"},{"location":"sd/#sd","text":"\u6211\u7406\u89e3\u7684SD\uff08\uff09\uff0c\u9500\u552e\u548c\u5206\u9500\u6a21\u5757\uff0c\u5305\u62ec\u91c7\u8d2d\u6536\u8d27\uff0c\u9500\u552e\u5355\uff0c\u9500\u552e\u53d1\u8d27\uff0c\u6536\u8d27\u548c\u53d1\u8d27\u8fc7\u8d26\uff0cMIGO\u7b49\u3002","title":"SD\u6a21\u5757\u6982\u8ff0"},{"location":"sd/outbound_delivery/","text":"\u4ea4\u8d27\u5355 \u00b6","title":"\u5916\u5411\u4ea4\u8d27\u5355"},{"location":"sd/outbound_delivery/#_1","text":"","title":"\u4ea4\u8d27\u5355"},{"location":"sd/outbound_delivery_post/","text":"\u53d1\u8d27\u8fc7\u8d26 \u00b6 VL09N\u53d1\u8d27\u8fc7\u8d26 \u00b6 \u7531\u4e8e\u5168\u5c40\u53c2\u6570\u7f13\u5b58\uff0c\u4f1a\u5bfc\u81f4\u8fde\u7eed\u53d1\u8d27\u8fc7\u8d26\u5931\u8d25\uff0c\u5efa\u8bae\u65b0\u5efa\u7a0b\u5e8f\u8fdb\u884c\u5904\u7406\u3002 \u793a\u4f8b\u4ee3\u7801 *&---------------------------------------------------------------------* *& Report Z_GTM_RPT_0095_VL_VL09 *&---------------------------------------------------------------------* *& *&---------------------------------------------------------------------* REPORT z_gtm_rpt_0095_vl_vl09 . PARAMETERS p_vbeln TYPE likp - vbeln . PARAMETERS p_mid TYPE char20 NO-DISPLAY . AT SELECTION-SCREEN . PERFORM frm_vl09 . *&---------------------------------------------------------------------* *& Form frm_vl09 *&---------------------------------------------------------------------* *& text *&---------------------------------------------------------------------* *& --> p1 text *& <-- p2 text *&---------------------------------------------------------------------* FORM frm_vl09 . DATA es_emkpf TYPE emkpf . DATA t_mesg TYPE STANDARD TABLE OF mesg . SELECT SINGLE wadat_ist , vbtyp FROM likp WHERE vbeln = @ p_vbeln INTO @ DATA ( ls_likp ). SET PARAMETER ID 'BAPI_TCODE' FIELD 'VL09' . \" \u8fd9BUG\u6709\u70b9\u96be\u53d7\uff0c\u5982\u679c\u8fde\u7eed\u51b2\u9500\u4ea4\u8d27\u5355\uff0c\u4f1a\u5bfc\u81f4\u7b2c\u4e8c\u6b21\u64cd\u4f5c\u5931\u8d25 \" \u56e0\u6b64\u901a\u8fc7\u5207\u6362\u7a0b\u5e8f\u6765\u91cd\u7f6e\u8fd9\u4e2a\u8fc7\u7a0b CALL FUNCTION 'WS_REVERSE_GOODS_ISSUE' EXPORTING i_vbeln = p_vbeln i_budat = sy - datum i_tcode = 'VL09' i_vbtyp = ls_likp - vbtyp IMPORTING es_emkpf = es_emkpf TABLES t_mesg = t_mesg EXCEPTIONS error_reverse_goods_issue = 1 OTHERS = 2 . IF sy - subrc <> 0 . * Implement suitable error handling here ENDIF . SET PARAMETER ID 'BAPI_TCODE' FIELD '' . IF es_emkpf - mblnr IS NOT INITIAL . CALL FUNCTION 'BAPI_TRANSACTION_COMMIT' EXPORTING wait = abap_true . ELSE . CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK' . ENDIF . \" \u8fd4\u56de\u6267\u884c\u7ed3\u679c IF p_mid IS NOT INITIAL . EXPORT es_emkpf = es_emkpf t_mesg = t_mesg TO MEMORY ID p_mid . ENDIF . ENDFORM .","title":"\u53d1\u8d27\u8fc7\u8d26"},{"location":"sd/outbound_delivery_post/#_1","text":"","title":"\u53d1\u8d27\u8fc7\u8d26"},{"location":"sd/outbound_delivery_post/#vl09n","text":"\u7531\u4e8e\u5168\u5c40\u53c2\u6570\u7f13\u5b58\uff0c\u4f1a\u5bfc\u81f4\u8fde\u7eed\u53d1\u8d27\u8fc7\u8d26\u5931\u8d25\uff0c\u5efa\u8bae\u65b0\u5efa\u7a0b\u5e8f\u8fdb\u884c\u5904\u7406\u3002 \u793a\u4f8b\u4ee3\u7801 *&---------------------------------------------------------------------* *& Report Z_GTM_RPT_0095_VL_VL09 *&---------------------------------------------------------------------* *& *&---------------------------------------------------------------------* REPORT z_gtm_rpt_0095_vl_vl09 . PARAMETERS p_vbeln TYPE likp - vbeln . PARAMETERS p_mid TYPE char20 NO-DISPLAY . AT SELECTION-SCREEN . PERFORM frm_vl09 . *&---------------------------------------------------------------------* *& Form frm_vl09 *&---------------------------------------------------------------------* *& text *&---------------------------------------------------------------------* *& --> p1 text *& <-- p2 text *&---------------------------------------------------------------------* FORM frm_vl09 . DATA es_emkpf TYPE emkpf . DATA t_mesg TYPE STANDARD TABLE OF mesg . SELECT SINGLE wadat_ist , vbtyp FROM likp WHERE vbeln = @ p_vbeln INTO @ DATA ( ls_likp ). SET PARAMETER ID 'BAPI_TCODE' FIELD 'VL09' . \" \u8fd9BUG\u6709\u70b9\u96be\u53d7\uff0c\u5982\u679c\u8fde\u7eed\u51b2\u9500\u4ea4\u8d27\u5355\uff0c\u4f1a\u5bfc\u81f4\u7b2c\u4e8c\u6b21\u64cd\u4f5c\u5931\u8d25 \" \u56e0\u6b64\u901a\u8fc7\u5207\u6362\u7a0b\u5e8f\u6765\u91cd\u7f6e\u8fd9\u4e2a\u8fc7\u7a0b CALL FUNCTION 'WS_REVERSE_GOODS_ISSUE' EXPORTING i_vbeln = p_vbeln i_budat = sy - datum i_tcode = 'VL09' i_vbtyp = ls_likp - vbtyp IMPORTING es_emkpf = es_emkpf TABLES t_mesg = t_mesg EXCEPTIONS error_reverse_goods_issue = 1 OTHERS = 2 . IF sy - subrc <> 0 . * Implement suitable error handling here ENDIF . SET PARAMETER ID 'BAPI_TCODE' FIELD '' . IF es_emkpf - mblnr IS NOT INITIAL . CALL FUNCTION 'BAPI_TRANSACTION_COMMIT' EXPORTING wait = abap_true . ELSE . CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK' . ENDIF . \" \u8fd4\u56de\u6267\u884c\u7ed3\u679c IF p_mid IS NOT INITIAL . EXPORT es_emkpf = es_emkpf t_mesg = t_mesg TO MEMORY ID p_mid . ENDIF . ENDFORM .","title":"VL09N\u53d1\u8d27\u8fc7\u8d26"},{"location":"sd/sale_doc_screen_enhancement/","text":"\u9500\u552e\u5c4f\u5e55\u589e\u5f3a \u00b6 \u5c4f\u5e55\u51fa\u53e3\u6709\u4e24\u79cd\uff0c\u6807\u51c6\u51fa\u53e3\uff0c\u548cBADI\u589e\u5f3a\uff0c\u63a8\u8350\u540e\u8005\uff0c\u66f4\u4e3a\u7075\u6d3b \u6807\u51c6\u5c4f\u5e55\u51fa\u53e3 \u00b6 SAPMV45A\u7a0b\u5e8f\uff0c\u5c4f\u5e558309\uff08\u62ac\u5934\uff09\u30018459\uff08\u884c\u9879\u76ee\uff09\u662f\u6807\u51c6\u9884\u7559\u7684\u51fa\u53e3\u5c4f\u5e55\uff0c\u5728\u5176\u4e2d\u52a0\u5165PAI\u3001PBO\u903b\u8f91\u5373\u53ef\u3002 BADI\u589e\u5f3a \u00b6 SE18\u8fdb\u5165\u589e\u5f3a\u70b9 BADI_SD_SALES_BASIC \u5b9e\u65bd BADI_SLS_HEAD_SCR_CUS \u00b6 IF_EX_SLS_HEAD_SCR_CUS~ACTIVATE_TAB_PAGE \u6fc0\u6d3b\u62ac\u5934\u9875\u7b7e DATA ls_tab LIKE LINE OF ct_cus_head_tab . IF sy - tcode CP 'VA++' or sy - tcode CP 'MD++' . CLEAR ls_tab . ls_tab - head_caption = '\u9500\u552e\u9644\u52a0\u6570\u636e' . \" \u9875\u7b7e\u540d\u79f0 ls_tab - head_program = 'SAPLZFG_SD_SCREEN ' . \" \u81ea\u5b9a\u4e49\u7684\u7a0b\u5e8f\uff0c\u63a8\u8350\u4f7f\u7528\u51fd\u6570\u7ec4\uff0c\u65b9\u4fbf\u540e\u7eed\u53c2\u6570\u5904\u7406 ls_tab - head_dynpro = '9001' . \" \u5c4f\u5e55 APPEND ls_tab TO ct_cus_head_tab . ENDIF . IF_EX_SLS_HEAD_SCR_CUS~TRANSFER_DATA_TO_SUBSCREEN \u62ac\u5934\u6570\u636e\u4f20\u5165 \" \u6309\u9879\u76ee\u9700\u6c42\uff0c\u5c06\u9700\u8981\u7684\u53c2\u6570\u4f20\u5230\u5c4f\u5e55\u4e2d\u4f7f\u7528 \" \u53e6\u5916\u53d1\u73b0\u5f88\u591a\u4eba\u4f1a\u5ffd\u7565T180\uff0c\u8be5\u53c2\u6570\u5b9e\u9645\u53ef\u7528\u4e8e\u5c4f\u5e55\u63a7\u5236\uff08T180-TRTYP\uff09\uff0c\u53ef\u7528\u8be5\u53c2\u6570\u66ff\u4ee3\u8bb8\u591a\u4e8b\u52a1\u4ee3\u7801\u7684IF IF_EX_SLS_HEAD_SCR_CUS~TRANSFER_DATA_FROM_SUBSCREEN \u62ac\u5934\u6570\u636e\u4f20\u51fa \" \u4e0e\u4f20\u5165\u76f8\u53cd\u7684\u64cd\u4f5c\uff0c\u5c06\u589e\u5f3a\u5b57\u6bb5\u7684\u503c\u56de\u5199\u6807\u51c6\u8868\u4e2d \u5b9e\u65bd BADI_SLS_ITEM_SCR_CUS \u00b6 IF_EX_SLS_ITEM_SCR_CUS~ACTIVATE_TAB_PAGE \u6fc0\u6d3b\u884c\u9879\u76ee\u9875\u7b7e DATA ls_tab LIKE LINE OF ct_cus_item_tab . IF sy - tcode CP 'VA++' or sy - tcode CP 'MD++' . CLEAR ls_tab . ls_tab - item_caption = '\u9500\u552e\u9644\u52a0\u6570\u636e' . \" \u9875\u7b7e\u540d\u79f0 ls_tab - item_program = 'SAPLZFG_SD_SCREEN ' . \" \u81ea\u5b9a\u4e49\u7684\u7a0b\u5e8f\uff0c\u63a8\u8350\u4f7f\u7528\u51fd\u6570\u7ec4\uff0c\u65b9\u4fbf\u540e\u7eed\u53c2\u6570\u5904\u7406 ls_tab - item_dynpro = '9002' . \" \u5c4f\u5e55 APPEND ls_tab TO ct_cus_item_tab . ENDIF . IF_EX_SLS_ITEM_SCR_CUS~TRANSFER_DATA_TO_SUBSCREEN \u884c\u9879\u76ee\u6570\u636e\u4f20\u5165 \" \u6309\u9879\u76ee\u9700\u6c42\uff0c\u5c06\u9700\u8981\u7684\u53c2\u6570\u4f20\u5230\u5c4f\u5e55\u4e2d\u4f7f\u7528 \" \u53e6\u5916\u53d1\u73b0\u5f88\u591a\u4eba\u4f1a\u5ffd\u7565T180\uff0c\u8be5\u53c2\u6570\u5b9e\u9645\u53ef\u7528\u4e8e\u5c4f\u5e55\u63a7\u5236\uff08T180-TRTYP\uff09\uff0c\u53ef\u7528\u8be5\u53c2\u6570\u66ff\u4ee3\u8bb8\u591a\u4e8b\u52a1\u4ee3\u7801\u7684IF IF_EX_SLS_HEAD_SCR_CUS~TRANSFER_DATA_FROM_SUBSCREEN \u884c\u9879\u76ee\u6570\u636e\u4f20\u51fa \" \u4e0e\u4f20\u5165\u76f8\u53cd\u7684\u64cd\u4f5c\uff0c\u5c06\u589e\u5f3a\u5b57\u6bb5\u7684\u503c\u56de\u5199\u6807\u51c6\u8868\u4e2d \" \u9700\u8981\u6ce8\u610f\uff0c\u6807\u51c6\u65e0\u6cd5\u5904\u7406\u5ba2\u5236\u5c4f\u5e55\u4e0a\u7684\u547d\u4ee4\uff08\u6bd4\u5982\u6309\u94ae\uff09 \" \u53ea\u9700\u8981\u5c06CV_FCODE\u4fee\u6539\u4e3a\u6807\u51c6\u547d\u4ee4\u5373\u53ef\uff0c\u5982ENT1","title":"\u9500\u552e\u5c4f\u5e55\u589e\u5f3a"},{"location":"sd/sale_doc_screen_enhancement/#_1","text":"\u5c4f\u5e55\u51fa\u53e3\u6709\u4e24\u79cd\uff0c\u6807\u51c6\u51fa\u53e3\uff0c\u548cBADI\u589e\u5f3a\uff0c\u63a8\u8350\u540e\u8005\uff0c\u66f4\u4e3a\u7075\u6d3b","title":"\u9500\u552e\u5c4f\u5e55\u589e\u5f3a"},{"location":"sd/sale_doc_screen_enhancement/#_2","text":"SAPMV45A\u7a0b\u5e8f\uff0c\u5c4f\u5e558309\uff08\u62ac\u5934\uff09\u30018459\uff08\u884c\u9879\u76ee\uff09\u662f\u6807\u51c6\u9884\u7559\u7684\u51fa\u53e3\u5c4f\u5e55\uff0c\u5728\u5176\u4e2d\u52a0\u5165PAI\u3001PBO\u903b\u8f91\u5373\u53ef\u3002","title":"\u6807\u51c6\u5c4f\u5e55\u51fa\u53e3"},{"location":"sd/sale_doc_screen_enhancement/#badi","text":"SE18\u8fdb\u5165\u589e\u5f3a\u70b9 BADI_SD_SALES_BASIC","title":"BADI\u589e\u5f3a"},{"location":"sd/sale_doc_screen_enhancement/#badi_sls_head_scr_cus","text":"IF_EX_SLS_HEAD_SCR_CUS~ACTIVATE_TAB_PAGE \u6fc0\u6d3b\u62ac\u5934\u9875\u7b7e DATA ls_tab LIKE LINE OF ct_cus_head_tab . IF sy - tcode CP 'VA++' or sy - tcode CP 'MD++' . CLEAR ls_tab . ls_tab - head_caption = '\u9500\u552e\u9644\u52a0\u6570\u636e' . \" \u9875\u7b7e\u540d\u79f0 ls_tab - head_program = 'SAPLZFG_SD_SCREEN ' . \" \u81ea\u5b9a\u4e49\u7684\u7a0b\u5e8f\uff0c\u63a8\u8350\u4f7f\u7528\u51fd\u6570\u7ec4\uff0c\u65b9\u4fbf\u540e\u7eed\u53c2\u6570\u5904\u7406 ls_tab - head_dynpro = '9001' . \" \u5c4f\u5e55 APPEND ls_tab TO ct_cus_head_tab . ENDIF . IF_EX_SLS_HEAD_SCR_CUS~TRANSFER_DATA_TO_SUBSCREEN \u62ac\u5934\u6570\u636e\u4f20\u5165 \" \u6309\u9879\u76ee\u9700\u6c42\uff0c\u5c06\u9700\u8981\u7684\u53c2\u6570\u4f20\u5230\u5c4f\u5e55\u4e2d\u4f7f\u7528 \" \u53e6\u5916\u53d1\u73b0\u5f88\u591a\u4eba\u4f1a\u5ffd\u7565T180\uff0c\u8be5\u53c2\u6570\u5b9e\u9645\u53ef\u7528\u4e8e\u5c4f\u5e55\u63a7\u5236\uff08T180-TRTYP\uff09\uff0c\u53ef\u7528\u8be5\u53c2\u6570\u66ff\u4ee3\u8bb8\u591a\u4e8b\u52a1\u4ee3\u7801\u7684IF IF_EX_SLS_HEAD_SCR_CUS~TRANSFER_DATA_FROM_SUBSCREEN \u62ac\u5934\u6570\u636e\u4f20\u51fa \" \u4e0e\u4f20\u5165\u76f8\u53cd\u7684\u64cd\u4f5c\uff0c\u5c06\u589e\u5f3a\u5b57\u6bb5\u7684\u503c\u56de\u5199\u6807\u51c6\u8868\u4e2d","title":"\u5b9e\u65bd BADI_SLS_HEAD_SCR_CUS"},{"location":"sd/sale_doc_screen_enhancement/#badi_sls_item_scr_cus","text":"IF_EX_SLS_ITEM_SCR_CUS~ACTIVATE_TAB_PAGE \u6fc0\u6d3b\u884c\u9879\u76ee\u9875\u7b7e DATA ls_tab LIKE LINE OF ct_cus_item_tab . IF sy - tcode CP 'VA++' or sy - tcode CP 'MD++' . CLEAR ls_tab . ls_tab - item_caption = '\u9500\u552e\u9644\u52a0\u6570\u636e' . \" \u9875\u7b7e\u540d\u79f0 ls_tab - item_program = 'SAPLZFG_SD_SCREEN ' . \" \u81ea\u5b9a\u4e49\u7684\u7a0b\u5e8f\uff0c\u63a8\u8350\u4f7f\u7528\u51fd\u6570\u7ec4\uff0c\u65b9\u4fbf\u540e\u7eed\u53c2\u6570\u5904\u7406 ls_tab - item_dynpro = '9002' . \" \u5c4f\u5e55 APPEND ls_tab TO ct_cus_item_tab . ENDIF . IF_EX_SLS_ITEM_SCR_CUS~TRANSFER_DATA_TO_SUBSCREEN \u884c\u9879\u76ee\u6570\u636e\u4f20\u5165 \" \u6309\u9879\u76ee\u9700\u6c42\uff0c\u5c06\u9700\u8981\u7684\u53c2\u6570\u4f20\u5230\u5c4f\u5e55\u4e2d\u4f7f\u7528 \" \u53e6\u5916\u53d1\u73b0\u5f88\u591a\u4eba\u4f1a\u5ffd\u7565T180\uff0c\u8be5\u53c2\u6570\u5b9e\u9645\u53ef\u7528\u4e8e\u5c4f\u5e55\u63a7\u5236\uff08T180-TRTYP\uff09\uff0c\u53ef\u7528\u8be5\u53c2\u6570\u66ff\u4ee3\u8bb8\u591a\u4e8b\u52a1\u4ee3\u7801\u7684IF IF_EX_SLS_HEAD_SCR_CUS~TRANSFER_DATA_FROM_SUBSCREEN \u884c\u9879\u76ee\u6570\u636e\u4f20\u51fa \" \u4e0e\u4f20\u5165\u76f8\u53cd\u7684\u64cd\u4f5c\uff0c\u5c06\u589e\u5f3a\u5b57\u6bb5\u7684\u503c\u56de\u5199\u6807\u51c6\u8868\u4e2d \" \u9700\u8981\u6ce8\u610f\uff0c\u6807\u51c6\u65e0\u6cd5\u5904\u7406\u5ba2\u5236\u5c4f\u5e55\u4e0a\u7684\u547d\u4ee4\uff08\u6bd4\u5982\u6309\u94ae\uff09 \" \u53ea\u9700\u8981\u5c06CV_FCODE\u4fee\u6539\u4e3a\u6807\u51c6\u547d\u4ee4\u5373\u53ef\uff0c\u5982ENT1","title":"\u5b9e\u65bd BADI_SLS_ITEM_SCR_CUS"},{"location":"sd/sale_document/","text":"\u9500\u552e\u8ba2\u5355 \u00b6","title":"\u9500\u552e\u8ba2\u5355"},{"location":"sd/sale_document/#_1","text":"","title":"\u9500\u552e\u8ba2\u5355"}]}